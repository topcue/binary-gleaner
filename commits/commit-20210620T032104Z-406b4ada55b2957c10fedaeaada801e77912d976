{
  "sha": "406b4ada55b2957c10fedaeaada801e77912d976",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NDA2YjRhZGE1NWIyOTU3YzEwZmVkYWVhYWRhODAxZTc3OTEyZDk3Ng==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2021-06-20T03:20:52Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2021-06-20T03:21:04Z"
    },
    "message": "x86: Count PLT for GOTOFF relocation against IFUNC symbol\n\nSince GOTOFF relocations against IFUNC symbols must go through PLT,\nset PLT reference count to 1 for GOTOFF relocation.\n\nbfd/\n\n\tPR ld/27998\n\t* elfxx-x86.c (elf_x86_allocate_dynrelocs): Count PLT for GOTOFF\n\trelocation against IFUNC symbols.\n\t(_bfd_x86_elf_adjust_dynamic_symbol): Likewise.\n\nld/\n\n\tPR ld/27998\n\t* testsuite/ld-i386/i386.exp: Run PR ld/27998 tests.\n\t* testsuite/ld-i386/pr27998a.d: New file.\n\t* testsuite/ld-i386/pr27998a.s: Likewise.\n\t* testsuite/ld-i386/pr27998b.d: Likewise.\n\t* testsuite/ld-i386/pr27998b.s: Likewise.",
    "tree": {
      "sha": "e53f5b5356ec93296df94c593b8d6617681c1e49",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e53f5b5356ec93296df94c593b8d6617681c1e49"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/406b4ada55b2957c10fedaeaada801e77912d976",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/406b4ada55b2957c10fedaeaada801e77912d976",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/406b4ada55b2957c10fedaeaada801e77912d976",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/406b4ada55b2957c10fedaeaada801e77912d976/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7e3941ac0619431d51a9643e20cb0e0720502101",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7e3941ac0619431d51a9643e20cb0e0720502101",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/7e3941ac0619431d51a9643e20cb0e0720502101"
    }
  ],
  "stats": {
    "total": 86,
    "additions": 84,
    "deletions": 2
  },
  "files": [
    {
      "sha": "212fe332e2def21c7e3222708954d9879b9c5ad0",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -1,3 +1,10 @@\n+2021-06-19  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR ld/27998\n+\t* elfxx-x86.c (elf_x86_allocate_dynrelocs): Count PLT for GOTOFF\n+\trelocation against IFUNC symbols.\n+\t(_bfd_x86_elf_adjust_dynamic_symbol): Likewise.\n+\n 2021-06-19  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* elflink.c (bfd_elf_final_link): Correct DT_TEXTREL warning in"
    },
    {
      "sha": "088f6e5c5366495e77ee5e80a881b67d551765ab",
      "filename": "bfd/elfxx-x86.c",
      "status": "modified",
      "additions": 10,
      "deletions": 2,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/bfd/elfxx-x86.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/bfd/elfxx-x86.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfxx-x86.c?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -131,6 +131,10 @@ elf_x86_allocate_dynrelocs (struct elf_link_hash_entry *h, void *inf)\n   if (h->type == STT_GNU_IFUNC\n       && h->def_regular)\n     {\n+      /* GOTOFF relocation needs PLT.  */\n+      if (eh->gotoff_ref)\n+\th->plt.refcount = 1;\n+\n       if (_bfd_elf_allocate_ifunc_dyn_relocs (info, h, &h->dyn_relocs,\n \t\t\t\t\t      plt_entry_size,\n \t\t\t\t\t      (htab->plt.has_plt0\n@@ -1818,6 +1822,8 @@ _bfd_x86_elf_adjust_dynamic_symbol (struct bfd_link_info *info,\n   const struct elf_backend_data *bed\n     = get_elf_backend_data (info->output_bfd);\n \n+  eh = (struct elf_x86_link_hash_entry *) h;\n+\n   /* STT_GNU_IFUNC symbol must go through PLT. */\n   if (h->type == STT_GNU_IFUNC)\n     {\n@@ -1856,6 +1862,10 @@ _bfd_x86_elf_adjust_dynamic_symbol (struct bfd_link_info *info,\n \t\t    h->plt.refcount += 1;\n \t\t}\n \t    }\n+\n+\t  /* GOTOFF relocation needs PLT.  */\n+\t  if (eh->gotoff_ref)\n+\t    h->plt.refcount = 1;\n \t}\n \n       if (h->plt.refcount <= 0)\n@@ -1896,8 +1906,6 @@ _bfd_x86_elf_adjust_dynamic_symbol (struct bfd_link_info *info,\n        the link may change h->type.  So fix it now.  */\n     h->plt.offset = (bfd_vma) -1;\n \n-  eh = (struct elf_x86_link_hash_entry *) h;\n-\n   /* If this is a weak symbol, and there is a real definition, the\n      processor independent code will have arranged for us to see the\n      real definition first, and we can just use the same value.  */"
    },
    {
      "sha": "dc08ec9f0a00f8a5e976ac638e42624cb818901e",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -1,3 +1,12 @@\n+2021-06-19  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR ld/27998\n+\t* testsuite/ld-i386/i386.exp: Run PR ld/27998 tests.\n+\t* testsuite/ld-i386/pr27998a.d: New file.\n+\t* testsuite/ld-i386/pr27998a.s: Likewise.\n+\t* testsuite/ld-i386/pr27998b.d: Likewise.\n+\t* testsuite/ld-i386/pr27998b.s: Likewise.\n+\n 2021-06-19  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* testsuite/ld-x86-64/textrel-1.err: New file."
    },
    {
      "sha": "ceb60002d130f4f025f2a0161754f1f8faa4a884",
      "filename": "ld/testsuite/ld-i386/i386.exp",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/i386.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/i386.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-i386/i386.exp?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -519,6 +519,8 @@ run_dump_test \"pr19939a\"\n run_dump_test \"pr19939b\"\n run_dump_test \"tlsdesc2\"\n run_dump_test \"report-reloc-1\"\n+run_dump_test \"pr27998a\"\n+run_dump_test \"pr27998b\"\n \n proc undefined_weak {cflags ldflags} {\n     set testname \"Undefined weak symbol\""
    },
    {
      "sha": "ca3c9205fa6120bac31c7e373ca91f91bd27237a",
      "filename": "ld/testsuite/ld-i386/pr27998a.d",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998a.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998a.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-i386/pr27998a.d?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -0,0 +1,7 @@\n+#as: --32\n+#ld: -shared -melf_i386\n+#readelf: -r --wide\n+\n+Relocation section '.rel.plt' at offset 0x[0-9a-f]+ contains 1 entry:\n+ Offset     Info    Type                Sym. Value  Symbol's Name\n+[0-9a-f]+ +[0-9a-f]+ +R_386_IRELATIVE +"
    },
    {
      "sha": "ec55cd6948a6f27a14d3e19b0ab5cfbde4fdacc8",
      "filename": "ld/testsuite/ld-i386/pr27998a.s",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998a.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998a.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-i386/pr27998a.s?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -0,0 +1,22 @@\n+\t.text\n+\t.p2align 4\n+\t.type\tmy_foo, @function\n+my_foo:\n+\tret\n+\t.size\tmy_foo, .-my_foo\n+\t.p2align 4\n+\t.type\tresolve_foo, @function\n+resolve_foo:\n+\tleal\tmy_foo@GOTOFF(%eax), %eax\n+\tret\n+\t.size\tresolve_foo, .-resolve_foo\n+\t.globl\tfoo\n+\t.hidden\tfoo\n+\t.type\tfoo, @gnu_indirect_function\n+\t.set\tfoo,resolve_foo\n+\t.p2align 4\n+\t.globl\tbar\n+\t.type\tbar, @function\n+bar:\n+\tleal\tfoo@GOTOFF(%eax), %eax\n+\tret"
    },
    {
      "sha": "ca3c9205fa6120bac31c7e373ca91f91bd27237a",
      "filename": "ld/testsuite/ld-i386/pr27998b.d",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998b.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998b.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-i386/pr27998b.d?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -0,0 +1,7 @@\n+#as: --32\n+#ld: -shared -melf_i386\n+#readelf: -r --wide\n+\n+Relocation section '.rel.plt' at offset 0x[0-9a-f]+ contains 1 entry:\n+ Offset     Info    Type                Sym. Value  Symbol's Name\n+[0-9a-f]+ +[0-9a-f]+ +R_386_IRELATIVE +"
    },
    {
      "sha": "8b023e9b12dca3033b755a4996b1446eaec149b2",
      "filename": "ld/testsuite/ld-i386/pr27998b.s",
      "status": "added",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998b.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/406b4ada55b2957c10fedaeaada801e77912d976/ld/testsuite/ld-i386/pr27998b.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-i386/pr27998b.s?ref=406b4ada55b2957c10fedaeaada801e77912d976",
      "patch": "@@ -0,0 +1,20 @@\n+\t.text\n+\t.p2align 4\n+\t.type\tmy_foo, @function\n+my_foo:\n+\tret\n+\t.size\tmy_foo, .-my_foo\n+\t.p2align 4\n+\t.type\tresolve_foo, @function\n+resolve_foo:\n+\tleal\tmy_foo@GOTOFF(%eax), %eax\n+\tret\n+\t.size\tresolve_foo, .-resolve_foo\n+\t.type\tfoo, @gnu_indirect_function\n+\t.set\tfoo,resolve_foo\n+\t.p2align 4\n+\t.globl\tbar\n+\t.type\tbar, @function\n+bar:\n+\tleal\tfoo@GOTOFF(%eax), %eax\n+\tret"
    }
  ]
}