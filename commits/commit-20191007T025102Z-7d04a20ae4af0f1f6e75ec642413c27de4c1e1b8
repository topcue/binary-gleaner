{
  "sha": "7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6N2QwNGEyMGFlNGFmMGYxZjZlNzVlYzY0MjQxM2MyN2RlNGMxZTFiOA==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-10-07T02:51:02Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-10-07T02:51:02Z"
    },
    "message": "PowerPC TLS miscounting PLT for __tls_get_addr\n\nppc*_elf_tls_optimize decrements the PLT refcount for __tls_get_addr\nwhen a GD or LD sequence can be optimized.  Without tls marker relocs\nthis must be done when processing the argument setup relocations.\nWith marker relocs it's better done when processing the marker reloc.\nBut don't count them both ways.\n\nSeen as \"unresolvable R_PPC_REL24 relocation against symbol\n`__tls_get_addr_opt'\" (and other branch relocs).\n\n\t* elf32-ppc.c (ppc_elf_tls_optimize): Don't process R_PPC_TLSLD\n\twith non-local symbol.  Don't double count __tls_get_addr calls\n\twith marker relocs.\n\t* elf64-ppc.c (ppc64_elf_tls_optimize): Likewise.",
    "tree": {
      "sha": "f17459048cae52e21ecff5f83390ce9971b901ae",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/f17459048cae52e21ecff5f83390ce9971b901ae"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "9737e8af48e257f24e860fbf36af8c314e73076a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/9737e8af48e257f24e860fbf36af8c314e73076a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/9737e8af48e257f24e860fbf36af8c314e73076a"
    }
  ],
  "stats": {
    "total": 26,
    "additions": 19,
    "deletions": 7
  },
  "files": [
    {
      "sha": "b691d585712c5e0bf3c26c5a1fe4ea7846f36677",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
      "patch": "@@ -1,3 +1,10 @@\n+2019-10-07  Alan Modra  <amodra@gmail.com>\n+\n+\t* elf32-ppc.c (ppc_elf_tls_optimize): Don't process R_PPC_TLSLD\n+\twith non-local symbol.  Don't double count __tls_get_addr calls\n+\twith marker relocs.\n+\t* elf64-ppc.c (ppc64_elf_tls_optimize): Likewise.\n+\n 2019-10-07  Alan Modra  <amodra@gmail.com>\n \n \t* elf32-ppc.c (nomark_tls_get_addr): Rename from has_tls_get_addr_call"
    },
    {
      "sha": "cb6cd114af345de227eb42cf7932942a3a119656",
      "filename": "bfd/elf32-ppc.c",
      "status": "modified",
      "additions": 7,
      "deletions": 5,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/elf32-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/elf32-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf32-ppc.c?ref=7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
      "patch": "@@ -4530,8 +4530,11 @@ ppc_elf_tls_optimize (bfd *obfd ATTRIBUTE_UNUSED,\n \t\t      else\n \t\t\tcontinue;\n \n-\t\t    case R_PPC_TLSGD:\n \t\t    case R_PPC_TLSLD:\n+\t\t      if (!is_local)\n+\t\t\tcontinue;\n+\t\t      /* Fall through.  */\n+\t\t    case R_PPC_TLSGD:\n \t\t      if (rel + 1 < relend\n \t\t\t  && is_plt_seq_reloc (ELF32_R_TYPE (rel[1].r_info)))\n \t\t\t{\n@@ -4633,7 +4636,7 @@ ppc_elf_tls_optimize (bfd *obfd ATTRIBUTE_UNUSED,\n \t\t\t  != (TLS_TLS | TLS_MARK)))\n \t\t    continue;\n \n-\t\t  if (expecting_tls_get_addr)\n+\t\t  if (expecting_tls_get_addr == 1 + !sec->nomark_tls_get_addr)\n \t\t    {\n \t\t      struct plt_entry *ent;\n \t\t      bfd_vma addend = 0;\n@@ -4646,10 +4649,9 @@ ppc_elf_tls_optimize (bfd *obfd ATTRIBUTE_UNUSED,\n \t\t\t\t\t  got2, addend);\n \t\t      if (ent != NULL && ent->plt.refcount > 0)\n \t\t\tent->plt.refcount -= 1;\n-\n-\t\t      if (expecting_tls_get_addr == 2)\n-\t\t\tcontinue;\n \t\t    }\n+\t\t  if (tls_clear == 0)\n+\t\t    continue;\n \n \t\t  if (tls_set == 0)\n \t\t    {"
    },
    {
      "sha": "842fc40f1447b768a2db98a9664d9d7fdf55e8f8",
      "filename": "bfd/elf64-ppc.c",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/elf64-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8/bfd/elf64-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf64-ppc.c?ref=7d04a20ae4af0f1f6e75ec642413c27de4c1e1b8",
      "patch": "@@ -7906,8 +7906,11 @@ ppc64_elf_tls_optimize (struct bfd_link_info *info)\n \t\t\t}\n \t\t      continue;\n \n-\t\t    case R_PPC64_TLSGD:\n \t\t    case R_PPC64_TLSLD:\n+\t\t      if (!is_local)\n+\t\t\tcontinue;\n+\t\t      /* Fall through.  */\n+\t\t    case R_PPC64_TLSGD:\n \t\t      if (rel + 1 < relend\n \t\t\t  && is_plt_seq_reloc (ELF64_R_TYPE (rel[1].r_info)))\n \t\t\t{\n@@ -8092,7 +8095,7 @@ ppc64_elf_tls_optimize (struct bfd_link_info *info)\n \t\t\t  != (TLS_TLS | TLS_MARK)))\n \t\t    continue;\n \n-\t\t  if (expecting_tls_get_addr)\n+\t\t  if (expecting_tls_get_addr == 1 + !sec->nomark_tls_get_addr)\n \t\t    {\n \t\t      struct plt_entry *ent = NULL;\n "
    }
  ]
}