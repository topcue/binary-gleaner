{
  "sha": "b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YjE2N2U1M2YwNWNiZGRmYzIyYTBlNmEzNjJhMGFhMTRhNDYwYjMxZA==",
  "commit": {
    "author": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2020-09-20T14:58:26Z"
    },
    "committer": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2020-09-20T15:02:24Z"
    },
    "message": "Fix mi_gdb_exit with secondary MI channels\n\nTests that use a secondary MI channel (i.e., either tests that call\nmi_gdb_start with separate-mi-tty, or all tests when\nFORCE_SEPARATE_MI_TTY=1 is specified on the make check command line),\ndon't close GDB correctly.\n\nE.g., if you run gdb.mi/mi-exec-run.exp in a loop:\n\n  while true; do make check TESTS=\"gdb.mi/mi-exec-run.exp\"; done\n\nyou can see more than one gdb running at the same time:\n\n  $ ps -ef | grep -v grep | grep \"gdb/gdb\"\n  pedro      40507       1  7 15:47 ?        00:00:00 /home/pedro/gdb/build/gdb/testsuite/../../gdb/gdb -nw -nx -data-directory /home/pedro/gdb/build/gdb/testsuite/../data-directory\n  pedro      40562       1  0 15:47 ?        00:00:00 /home/pedro/gdb/build/gdb/testsuite/../../gdb/gdb -nw -nx -data-directory /home/pedro/gdb/build/gdb/testsuite/../data-directory\n  pedro      40727       1  0 15:47 ?        00:00:00 /home/pedro/gdb/build/gdb/testsuite/../../gdb/gdb -nw -nx -data-directory /home/pedro/gdb/build/gdb/testsuite/../data-directory\n  pedro      40786       1  0 15:47 ?        00:00:00 /home/pedro/gdb/build/gdb/testsuite/../../gdb/gdb -nw -nx -data-directory /home/pedro/gdb/build/gdb/testsuite/../data-directory\n\nThis commit fixes it.\n\ngdb/testsuite/ChangeLog:\n\n\t* lib/mi-support.exp (mi_uncatched_gdb_exit) Switch to the main\n\tspawn_id before calling remote_close.  Close secondary MI channel.",
    "tree": {
      "sha": "b671103e2e84cc6472017cdb28f25bef2032bfa5",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b671103e2e84cc6472017cdb28f25bef2032bfa5"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b167e53f05cbddfc22a0e6a362a0aa14a460b31d/comments",
  "author": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "dbc49e9ffa4c95413f38e31dae652329fd22dda2",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/dbc49e9ffa4c95413f38e31dae652329fd22dda2",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/dbc49e9ffa4c95413f38e31dae652329fd22dda2"
    }
  ],
  "stats": {
    "total": 17,
    "additions": 17,
    "deletions": 0
  },
  "files": [
    {
      "sha": "85bafbada4a60ca63c3b9d9a46175ddd5b6aeb0e",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b167e53f05cbddfc22a0e6a362a0aa14a460b31d/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b167e53f05cbddfc22a0e6a362a0aa14a460b31d/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
      "patch": "@@ -1,3 +1,8 @@\n+2020-09-20  Pedro Alves  <pedro@palves.net>\n+\n+\t* lib/mi-support.exp (mi_uncatched_gdb_exit) Switch to the main\n+\tspawn_id before calling remote_close.  Close secondary MI channel.\n+\n 2020-09-20  Pedro Alves  <pedro@palves.net>\n \n \t* gdb.base/testenv.exp (find_env): Bail out if printing 'envp[$i]'"
    },
    {
      "sha": "0e7524ed0f65a28e882eb528f5a1313b932b94e8",
      "filename": "gdb/testsuite/lib/mi-support.exp",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b167e53f05cbddfc22a0e6a362a0aa14a460b31d/gdb/testsuite/lib/mi-support.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b167e53f05cbddfc22a0e6a362a0aa14a460b31d/gdb/testsuite/lib/mi-support.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/mi-support.exp?ref=b167e53f05cbddfc22a0e6a362a0aa14a460b31d",
      "patch": "@@ -89,6 +89,18 @@ proc mi_uncatched_gdb_exit {} {\n \t}\n     }\n \n+    # Switch back to the main spawn id, so that remote_close below\n+    # closes it, and not a secondary channel.  Closing a secondary\n+    # channel does not make GDB exit.\n+    if {$gdb_spawn_id != $gdb_main_spawn_id} {\n+\tswitch_gdb_spawn_id $gdb_main_spawn_id\n+    }\n+\n+    # Close secondary MI channel, if there's one.\n+    if {$mi_spawn_id != $gdb_main_spawn_id} {\n+\tclose -i $mi_spawn_id\n+    }\n+\n     if ![is_remote host] {\n \tremote_close host\n     }"
    }
  ]
}