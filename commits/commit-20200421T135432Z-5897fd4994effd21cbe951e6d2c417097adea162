{
  "sha": "5897fd4994effd21cbe951e6d2c417097adea162",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NTg5N2ZkNDk5NGVmZmQyMWNiZTk1MWU2ZDJjNDE3MDk3YWRlYTE2Mg==",
  "commit": {
    "author": {
      "name": "Markus Metzger",
      "email": "markus.t.metzger@intel.com",
      "date": "2020-03-13T08:58:10Z"
    },
    "committer": {
      "name": "Markus Metzger",
      "email": "markus.t.metzger@intel.com",
      "date": "2020-04-21T13:54:32Z"
    },
    "message": "gdb, btrace: diagnose double and failed enable\n\nGDB silently ignores attempts to enable branch tracing on a thread that is\nalready recorded.  This shouldn't happen as recording is enabled exactly\nonce:\n\n  - when the btrace record target is opened for existing threads\n  - when a new thread is added while the btrace record target is pushed\n\nGDB also silently ignores if recording is disabled on threads that were not\nrecorded.  This shouldn't happen, either, since when stopping recording,\nwe only disable recording on threads that were recorded.\n\nGDB further silently ignores if recording was not enabled by the\ncorresponding target method.  Also this shouldn't happen since the target\nis supposed to already throw an error if recording cannot be enabled.\nThis new error in btrace_enable catches cases where the target silently\nfailed to enable recording.\n\nThrow an error in those cases.\n\nThis allows us to detect an actual issue more easily.  It will be\naddressed in the next patch.\n\ngdb/ChangeLog:\n\n2020-03-19  Markus Metzger  <markus.t.metzger@intel.com>\n\n\t* btrace.c (btrace_enable): Throw an error on double enables and\n\twhen enabling recording fails.\n\t(btrace_disable): Throw an error if the thread is not recorded.",
    "tree": {
      "sha": "b32e41dedc31f20b4dc4a849b2b7a13b85ec84cd",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b32e41dedc31f20b4dc4a849b2b7a13b85ec84cd"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/5897fd4994effd21cbe951e6d2c417097adea162",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5897fd4994effd21cbe951e6d2c417097adea162",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/5897fd4994effd21cbe951e6d2c417097adea162",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5897fd4994effd21cbe951e6d2c417097adea162/comments",
  "author": {
    "login": "markus-metzger",
    "id": 5424725,
    "node_id": "MDQ6VXNlcjU0MjQ3MjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5424725?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/markus-metzger",
    "html_url": "https://github.com/markus-metzger",
    "followers_url": "https://api.github.com/users/markus-metzger/followers",
    "following_url": "https://api.github.com/users/markus-metzger/following{/other_user}",
    "gists_url": "https://api.github.com/users/markus-metzger/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/markus-metzger/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/markus-metzger/subscriptions",
    "organizations_url": "https://api.github.com/users/markus-metzger/orgs",
    "repos_url": "https://api.github.com/users/markus-metzger/repos",
    "events_url": "https://api.github.com/users/markus-metzger/events{/privacy}",
    "received_events_url": "https://api.github.com/users/markus-metzger/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "markus-metzger",
    "id": 5424725,
    "node_id": "MDQ6VXNlcjU0MjQ3MjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5424725?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/markus-metzger",
    "html_url": "https://github.com/markus-metzger",
    "followers_url": "https://api.github.com/users/markus-metzger/followers",
    "following_url": "https://api.github.com/users/markus-metzger/following{/other_user}",
    "gists_url": "https://api.github.com/users/markus-metzger/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/markus-metzger/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/markus-metzger/subscriptions",
    "organizations_url": "https://api.github.com/users/markus-metzger/orgs",
    "repos_url": "https://api.github.com/users/markus-metzger/repos",
    "events_url": "https://api.github.com/users/markus-metzger/events{/privacy}",
    "received_events_url": "https://api.github.com/users/markus-metzger/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "1a476b6d68f338e6daa0345501c0cf0fe97dd8f3",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1a476b6d68f338e6daa0345501c0cf0fe97dd8f3",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/1a476b6d68f338e6daa0345501c0cf0fe97dd8f3"
    }
  ],
  "stats": {
    "total": 16,
    "additions": 12,
    "deletions": 4
  },
  "files": [
    {
      "sha": "05110002e785dcdfe407536a0ff07232c543f327",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5897fd4994effd21cbe951e6d2c417097adea162/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5897fd4994effd21cbe951e6d2c417097adea162/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=5897fd4994effd21cbe951e6d2c417097adea162",
      "patch": "@@ -1,3 +1,9 @@\n+2020-04-21  Markus Metzger  <markus.t.metzger@intel.com>\n+\n+\t* btrace.c (btrace_enable): Throw an error on double enables and\n+\twhen enabling recording fails.\n+\t(btrace_disable): Throw an error if the thread is not recorded.\n+\n 2020-04-21  Markus Metzger  <markus.t.metzger@intel.com>\n \n \t* record-btrace.c (record_btrace_target::fetch_registers): Forward"
    },
    {
      "sha": "d41e3c4f8f91ac102a76207437a80b1545590f1b",
      "filename": "gdb/btrace.c",
      "status": "modified",
      "additions": 6,
      "deletions": 4,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5897fd4994effd21cbe951e6d2c417097adea162/gdb/btrace.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5897fd4994effd21cbe951e6d2c417097adea162/gdb/btrace.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/btrace.c?ref=5897fd4994effd21cbe951e6d2c417097adea162",
      "patch": "@@ -1592,7 +1592,8 @@ void\n btrace_enable (struct thread_info *tp, const struct btrace_config *conf)\n {\n   if (tp->btrace.target != NULL)\n-    return;\n+    error (_(\"Recording already enabled on thread %s (%s).\"),\n+\t   print_thread_id (tp), target_pid_to_str (tp->ptid).c_str ());\n \n #if !defined (HAVE_LIBIPT)\n   if (conf->format == BTRACE_FORMAT_PT)\n@@ -1604,9 +1605,9 @@ btrace_enable (struct thread_info *tp, const struct btrace_config *conf)\n \n   tp->btrace.target = target_enable_btrace (tp->ptid, conf);\n \n-  /* We're done if we failed to enable tracing.  */\n   if (tp->btrace.target == NULL)\n-    return;\n+    error (_(\"Failed to enable recording on thread %s (%s).\"),\n+\t   print_thread_id (tp), target_pid_to_str (tp->ptid).c_str ());\n \n   /* We need to undo the enable in case of errors.  */\n   try\n@@ -1651,7 +1652,8 @@ btrace_disable (struct thread_info *tp)\n   struct btrace_thread_info *btp = &tp->btrace;\n \n   if (btp->target == NULL)\n-    return;\n+    error (_(\"Recording not enabled on thread %s (%s).\"),\n+\t   print_thread_id (tp), target_pid_to_str (tp->ptid).c_str ());\n \n   DEBUG (\"disable thread %s (%s)\", print_thread_id (tp),\n \t target_pid_to_str (tp->ptid).c_str ());"
    }
  ]
}