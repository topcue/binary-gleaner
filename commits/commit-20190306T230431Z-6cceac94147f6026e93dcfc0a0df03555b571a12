{
  "sha": "6cceac94147f6026e93dcfc0a0df03555b571a12",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NmNjZWFjOTQxNDdmNjAyNmU5M2RjZmMwYTBkZjAzNTU1YjU3MWExMg==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-01-24T13:43:45Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-03-06T23:04:31Z"
    },
    "message": "Remove last cleanup from linux-namespaces.c\n\nThis removes the last cleanup from linux-namespaces.c, replacing it\nwith a use of SCOPE_EXIT.\n\n2019-03-06  Tom Tromey  <tom@tromey.com>\n\n\t* nat/linux-namespaces.c (linux_mntns_access_fs): Use SCOPE_EXIT.\n\t* common/filestuff.h (make_cleanup_close): Don't declare.\n\t* common/filestuff.c (do_close_cleanup, make_cleanup_close):\n\tRemove.",
    "tree": {
      "sha": "ae45737eb987a1c699bc1d05ae7c4366b821c716",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/ae45737eb987a1c699bc1d05ae7c4366b821c716"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/6cceac94147f6026e93dcfc0a0df03555b571a12",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6cceac94147f6026e93dcfc0a0df03555b571a12",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/6cceac94147f6026e93dcfc0a0df03555b571a12",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6cceac94147f6026e93dcfc0a0df03555b571a12/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "724127627fef458ed330d027cf0b3d17580af615",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/724127627fef458ed330d027cf0b3d17580af615",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/724127627fef458ed330d027cf0b3d17580af615"
    }
  ],
  "stats": {
    "total": 73,
    "additions": 22,
    "deletions": 51
  },
  "files": [
    {
      "sha": "e4f7b86f7f87ecfc067f06aca35a33159b913d41",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=6cceac94147f6026e93dcfc0a0df03555b571a12",
      "patch": "@@ -1,3 +1,10 @@\n+2019-03-06  Tom Tromey  <tom@tromey.com>\n+\n+\t* nat/linux-namespaces.c (linux_mntns_access_fs): Use SCOPE_EXIT.\n+\t* common/filestuff.h (make_cleanup_close): Don't declare.\n+\t* common/filestuff.c (do_close_cleanup, make_cleanup_close):\n+\tRemove.\n+\n 2019-03-06  Tom Tromey  <tom@tromey.com>\n \n \t* solib-aix.c: Use make_scope_exit."
    },
    {
      "sha": "1ca62482a7e27a5c9da4a63bba463c0a59d2ba3d",
      "filename": "gdb/common/filestuff.c",
      "status": "modified",
      "additions": 0,
      "deletions": 21,
      "changes": 21,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/common/filestuff.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/common/filestuff.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/common/filestuff.c?ref=6cceac94147f6026e93dcfc0a0df03555b571a12",
      "patch": "@@ -426,27 +426,6 @@ gdb_pipe_cloexec (int filedes[2])\n   return result;\n }\n \n-/* Helper function which does the work for make_cleanup_close.  */\n-\n-static void\n-do_close_cleanup (void *arg)\n-{\n-  int *fd = (int *) arg;\n-\n-  close (*fd);\n-}\n-\n-/* See filestuff.h.  */\n-\n-struct cleanup *\n-make_cleanup_close (int fd)\n-{\n-  int *saved_fd = XNEW (int);\n-\n-  *saved_fd = fd;\n-  return make_cleanup_dtor (do_close_cleanup, saved_fd, xfree);\n-}\n-\n /* See common/filestuff.h.  */\n \n bool"
    },
    {
      "sha": "c50781da01c23c4d7711ee4db880232087ec70be",
      "filename": "gdb/common/filestuff.h",
      "status": "modified",
      "additions": 0,
      "deletions": 4,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/common/filestuff.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/common/filestuff.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/common/filestuff.h?ref=6cceac94147f6026e93dcfc0a0df03555b571a12",
      "patch": "@@ -112,10 +112,6 @@ extern int gdb_socket_cloexec (int domain, int style, int protocol);\n \n extern int gdb_pipe_cloexec (int filedes[2]);\n \n-/* Return a new cleanup that closes FD.  */\n-\n-extern struct cleanup *make_cleanup_close (int fd);\n-\n struct gdb_dir_deleter\n {\n   void operator() (DIR *dir) const"
    },
    {
      "sha": "c0f326b9a1eda321d53f0faace0e6f87309ba3e9",
      "filename": "gdb/nat/linux-namespaces.c",
      "status": "modified",
      "additions": 15,
      "deletions": 26,
      "changes": 41,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/nat/linux-namespaces.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6cceac94147f6026e93dcfc0a0df03555b571a12/gdb/nat/linux-namespaces.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/nat/linux-namespaces.c?ref=6cceac94147f6026e93dcfc0a0df03555b571a12",
      "patch": "@@ -28,6 +28,7 @@\n #include \"common/gdb_wait.h\"\n #include <signal.h>\n #include <sched.h>\n+#include \"common/scope-exit.h\"\n \n /* See nat/linux-namespaces.h.  */\n int debug_linux_namespaces;\n@@ -887,12 +888,11 @@ enum mnsh_fs_code\n static enum mnsh_fs_code\n linux_mntns_access_fs (pid_t pid)\n {\n-  struct cleanup *old_chain;\n   struct linux_ns *ns;\n   struct stat sb;\n   struct linux_mnsh *helper;\n   ssize_t size;\n-  int fd, saved_errno;\n+  int fd;\n \n   if (pid == getpid ())\n     return MNSH_FS_DIRECT;\n@@ -901,38 +901,37 @@ linux_mntns_access_fs (pid_t pid)\n   if (ns == NULL)\n     return MNSH_FS_DIRECT;\n \n-  old_chain = make_cleanup (null_cleanup, NULL);\n-\n   fd = gdb_open_cloexec (linux_ns_filename (ns, pid), O_RDONLY, 0);\n   if (fd < 0)\n-    goto error;\n+    return MNSH_FS_ERROR;\n \n-  make_cleanup_close (fd);\n+  SCOPE_EXIT\n+    {\n+      int save_errno = errno;\n+      close (fd);\n+      errno = save_errno;\n+    };\n \n   if (fstat (fd, &sb) != 0)\n-    goto error;\n+    return MNSH_FS_ERROR;\n \n   if (sb.st_ino == ns->id)\n-    {\n-      do_cleanups (old_chain);\n-\n-      return MNSH_FS_DIRECT;\n-    }\n+    return MNSH_FS_DIRECT;\n \n   helper = linux_mntns_get_helper ();\n   if (helper == NULL)\n-    goto error;\n+    return MNSH_FS_ERROR;\n \n   if (sb.st_ino != helper->nsid)\n     {\n       int result, error;\n \n       size = mnsh_send_setns (helper, fd, 0);\n       if (size < 0)\n-\tgoto error;\n+\treturn MNSH_FS_ERROR;\n \n       if (mnsh_recv_int (helper, &result, &error) != 0)\n-\tgoto error;\n+\treturn MNSH_FS_ERROR;\n \n       if (result != 0)\n \t{\n@@ -945,23 +944,13 @@ linux_mntns_access_fs (pid_t pid)\n \t    error = ENOTSUP;\n \n \t  errno = error;\n-\t  goto error;\n+\t  return MNSH_FS_ERROR;\n \t}\n \n       helper->nsid = sb.st_ino;\n     }\n \n-  do_cleanups (old_chain);\n-\n   return MNSH_FS_HELPER;\n-\n-error:\n-  saved_errno = errno;\n-\n-  do_cleanups (old_chain);\n-\n-  errno = saved_errno;\n-  return MNSH_FS_ERROR;\n }\n \n /* See nat/linux-namespaces.h.  */"
    }
  ]
}