{
  "sha": "752e419362eae28f7fcf6347b333347e472bc10f",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NzUyZTQxOTM2MmVhZTI4ZjdmY2Y2MzQ3YjMzMzM0N2U0NzJiYzEwZg==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-07-06T08:58:43Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-07-06T08:58:43Z"
    },
    "message": "[gdb/symtab] Fix skipping of import of C++ CU\n\nTom Tromey observed that when changing the language in\ngdb.dwarf2/imported-unit-bp.exp from c to c++, the test failed.\n\nThis is due to this code in process_imported_unit_die:\n...\n      /* We're importing a C++ compilation unit with tag DW_TAG_compile_unit\n         into another compilation unit, at root level.  Regard this as a hint,\n         and ignore it.  */\n      if (die->parent && die->parent->parent == NULL\n          && per_cu->unit_type == DW_UT_compile\n          && per_cu->lang == language_cplus)\n        return;\n...\nwhich should have a partial symtabs counterpart.\n\nAdd the missing counterpart in process_psymtab_comp_unit.\n\nTested on x86_64-linux (openSUSE Leap 15.2), no regressions for config:\n- using default gcc version 7.5.0\n  (with 5 unexpected FAILs)\n- gcc 10.3.0 and target board\n  unix/-flto/-O0/-flto-partition=none/-ffat-lto-objects\n  (with 1000 unexpected FAILs)\n\ngdb/ChangeLog:\n\n2021-07-06  Tom de Vries  <tdevries@suse.de>\n\n\t* dwarf2/read.c (scan_partial_symbols): Skip top-level imports of\n\tc++ CU.\n\t* testsuite/gdb.dwarf2/imported-unit-bp.exp: Moved to ...\n\t* testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl: ... here.\n\t* testsuite/gdb.dwarf2/imported-unit-bp-c++.exp: New test.\n\t* testsuite/gdb.dwarf2/imported-unit-bp-c.exp: New test.\n\t* testsuite/gdb.dwarf2/imported-unit.exp: Update.",
    "tree": {
      "sha": "5a21be53a93c82e0015d7df3254725645737d936",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/5a21be53a93c82e0015d7df3254725645737d936"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/752e419362eae28f7fcf6347b333347e472bc10f",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/752e419362eae28f7fcf6347b333347e472bc10f",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/752e419362eae28f7fcf6347b333347e472bc10f",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/752e419362eae28f7fcf6347b333347e472bc10f/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86"
    }
  ],
  "stats": {
    "total": 67,
    "additions": 60,
    "deletions": 7
  },
  "files": [
    {
      "sha": "f1071a71d2e09c79ce21ffaf2a5ffae9cd88803e",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -1,3 +1,13 @@\n+2021-07-06  Tom de Vries  <tdevries@suse.de>\n+\n+\t* dwarf2/read.c (scan_partial_symbols): Skip top-level imports of\n+\tc++ CU.\n+\t* testsuite/gdb.dwarf2/imported-unit-bp.exp: Moved to ...\n+\t* testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl: ... here.\n+\t* testsuite/gdb.dwarf2/imported-unit-bp-c++.exp: New test.\n+\t* testsuite/gdb.dwarf2/imported-unit-bp-c.exp: New test.\n+\t* testsuite/gdb.dwarf2/imported-unit.exp: Update.\n+\n 2021-07-03  Joel Brobecker  <brobecker@adacore.com>\n \n \t* NEWS: Create a new section for the next release branch."
    },
    {
      "sha": "a13a53ebc46f58b130a443a1164b5d2b2ceee411",
      "filename": "gdb/dwarf2/read.c",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/dwarf2/read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/dwarf2/read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/read.c?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -7639,6 +7639,13 @@ scan_partial_symbols (struct partial_die_info *first_die, CORE_ADDR *lowpc,\n \t\t  process_psymtab_comp_unit (per_cu, cu->per_objfile, true,\n \t\t\t\t\t     cu->per_cu->lang);\n \n+\t\tif (pdi->die_parent == nullptr\n+\t\t    && per_cu->unit_type == DW_UT_compile\n+\t\t    && per_cu->lang == language_cplus)\n+\t\t  /* Regard import as hint.  See corresponding code in\n+\t\t     process_imported_unit_die.  */\n+\t\t  break;\n+\n \t\tcu->per_cu->imported_symtabs_push (per_cu);\n \t      }\n \t      break;"
    },
    {
      "sha": "c376113d5e0555b7ce040285a57a437800ea887b",
      "filename": "gdb/testsuite/gdb.dwarf2/imported-unit-bp-c++.exp",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c++.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c++.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c++.exp?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -0,0 +1,18 @@\n+# Copyright 2021 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+set lang DW_LANG_C_plus_plus\n+\n+source $srcdir/$subdir/imported-unit-bp.exp.tcl"
    },
    {
      "sha": "6f9c3ad8f4164e883ef927bd44c81408f3c3dbb3",
      "filename": "gdb/testsuite/gdb.dwarf2/imported-unit-bp-c.exp",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/imported-unit-bp-c.exp?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -0,0 +1,18 @@\n+# Copyright 2021 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+set lang DW_LANG_C\n+\n+source $srcdir/$subdir/imported-unit-bp.exp.tcl"
    },
    {
      "sha": "83bca7d8e7a14806e19325d07df37665397dd44f",
      "filename": "gdb/testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl",
      "status": "renamed",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/imported-unit-bp.exp.tcl?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -38,13 +38,14 @@ set asm_file [standard_output_file $srcfile2]\n Dwarf::assemble $asm_file {\n     global srcdir subdir srcfile srcfile\n     global build_options\n+    global lang\n     declare_labels lines_label callee_subprog_label cu_label\n \n     get_func_info func \"$build_options additional_flags=-DWITHMAIN\"\n \n     cu {} {\n \tcompile_unit {\n-\t    {language @DW_LANG_C}\n+\t    {language @$lang}\n \t    {name \"<artificial>\"}\n \t} {\n \t    imported_unit {\n@@ -56,7 +57,7 @@ Dwarf::assemble $asm_file {\n     cu {} {\n \tcu_label: compile_unit {\n \t    {producer \"gcc\"}\n-\t    {language @DW_LANG_C}\n+\t    {language @$lang}\n \t    {name ${srcfile}}\n \t    {comp_dir \"/tmp\"}\n \t    {low_pc 0 addr}",
      "previous_filename": "gdb/testsuite/gdb.dwarf2/imported-unit-bp.exp"
    },
    {
      "sha": "efce3a03a2ea3867bddb2e04b9d31c4e88cee53f",
      "filename": "gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "status": "modified",
      "additions": 4,
      "deletions": 5,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/752e419362eae28f7fcf6347b333347e472bc10f/gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/imported-unit.exp?ref=752e419362eae28f7fcf6347b333347e472bc10f",
      "patch": "@@ -136,15 +136,14 @@ gdb_test_no_output \"set language c++\"\n \n set psymtabs_p [psymtabs_p]\n \n-# Verify that the partial symtab for the unit importing the partial unit does\n-# not contain the static partial symbol int, which is defined in the partial\n-# unit.  Test-case for PR25646.\n+# Verify that the partial symtab for CU \"<artificial>\" does\n+# not contain the static partial symbol int, which is defined in the\n+# CU \"imported_unit.c\".  Test-case for PR25646.\n set test \"no static partial symbols in importing unit\"\n if { $psymtabs_p } {\n     gdb_test \"main print psymbols\" \\\n \t[multi_line \\\n-\t     \"  Depends on 1 other partial symtabs\\.\" \\\n-\t     \"\\[^\\r\\n\\]*\" \\\n+\t \"  Depends on 0 other partial symtabs\\.\" \\\n \t     \"  Global partial symbols:\" \\\n \t     \"    `main', function, $hex\" \\\n \t     \"\" \\"
    }
  ]
}