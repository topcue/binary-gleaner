{
  "sha": "9d1447e09d4aa673826039321163b5a684e8e043",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6OWQxNDQ3ZTA5ZDRhYTY3MzgyNjAzOTMyMTE2M2I1YTY4NGU4ZTA0Mw==",
  "commit": {
    "author": {
      "name": "Sergio Durigan Junior",
      "email": "sergiodj@redhat.com",
      "date": "2019-03-29T21:34:54Z"
    },
    "committer": {
      "name": "Sergio Durigan Junior",
      "email": "sergiodj@redhat.com",
      "date": "2019-04-01T14:58:12Z"
    },
    "message": "Destroy allocated values when exiting GDB\n\nWhen the user exits GDB, we might still have some allocated values in\nthe chain, which, in specific scenarios, can cause problems when GDB\nattempts to destroy them in \"quit_force\".  For example, see the bug\nreported at:\n\n  https://bugzilla.redhat.com/show_bug.cgi?id=1690120\n\nAnd the thread starting at:\n\n  https://sourceware.org/ml/gdb-patches/2019-03/msg00475.html\n  Message-ID: <87r2azkhmq.fsf@redhat.com>\n\nIn order to avoid that, and to be more aware of our allocated\nresources, this commit implements a new function \"finalize_values\" and\ncalls it from inside \"quit_force\".\n\nTested by the BuildBot.\n\n2019-04-01  Sergio Durigan Junior  <sergiodj@redhat.com>\n\t    Pedro Alves  <palves@redhat.com>\n\n\t* top.c (quit_force): Call 'finalize_values'.\n\t* value.c (finalize_values): New function.\n\t* value.h (finalize_values): Declare.",
    "tree": {
      "sha": "e9af1807d26dcc67327847c369b9d032afccb102",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e9af1807d26dcc67327847c369b9d032afccb102"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/9d1447e09d4aa673826039321163b5a684e8e043",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/9d1447e09d4aa673826039321163b5a684e8e043",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/9d1447e09d4aa673826039321163b5a684e8e043",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/9d1447e09d4aa673826039321163b5a684e8e043/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "34ef62f46541d423b991850b2b7ba34d8749a6ba",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/34ef62f46541d423b991850b2b7ba34d8749a6ba",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/34ef62f46541d423b991850b2b7ba34d8749a6ba"
    }
  ],
  "stats": {
    "total": 25,
    "additions": 25,
    "deletions": 0
  },
  "files": [
    {
      "sha": "3de5992d87bd86456876b48c0b37e2e02a061e15",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9d1447e09d4aa673826039321163b5a684e8e043/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9d1447e09d4aa673826039321163b5a684e8e043/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=9d1447e09d4aa673826039321163b5a684e8e043",
      "patch": "@@ -1,3 +1,10 @@\n+2019-04-01  Sergio Durigan Junior  <sergiodj@redhat.com>\n+\t    Pedro Alves  <palves@redhat.com>\n+\n+\t* top.c (quit_force): Call 'finalize_values'.\n+\t* value.c (finalize_values): New function.\n+\t* value.h (finalize_values): Declare.\n+\n 2019-03-30  Eli Zaretskii  <eliz@gnu.org>\n \n \t* NEWS: Announce $_gdb_major and $_gdb_minor."
    },
    {
      "sha": "1fc259fe0f487a208bc4fcbba782f34847e94b64",
      "filename": "gdb/top.c",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9d1447e09d4aa673826039321163b5a684e8e043/gdb/top.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9d1447e09d4aa673826039321163b5a684e8e043/gdb/top.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/top.c?ref=9d1447e09d4aa673826039321163b5a684e8e043",
      "patch": "@@ -1673,6 +1673,12 @@ quit_force (int *exit_arg, int from_tty)\n     }\n   END_CATCH\n \n+  /* Destroy any values currently allocated now instead of leaving it\n+     to global destructors, because that may be too late.  For\n+     example, the destructors of xmethod values call into the Python\n+     runtime, which is finalized via a final cleanup.  */\n+  finalize_values ();\n+\n   /* Do any final cleanups before exiting.  */\n   TRY\n     {"
    },
    {
      "sha": "bcfc084e09092a187baa691856f7b3f940573073",
      "filename": "gdb/value.c",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9d1447e09d4aa673826039321163b5a684e8e043/gdb/value.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9d1447e09d4aa673826039321163b5a684e8e043/gdb/value.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/value.c?ref=9d1447e09d4aa673826039321163b5a684e8e043",
      "patch": "@@ -4132,3 +4132,11 @@ prevents future values, larger than this size, from being allocated.\"),\n \t\t\t    selftests::test_insert_into_bit_range_vector);\n #endif\n }\n+\n+/* See value.h.  */\n+\n+void\n+finalize_values ()\n+{\n+  all_values.clear ();\n+}"
    },
    {
      "sha": "0756d13b6d79f060e9ada774518092e49ec1a9d4",
      "filename": "gdb/value.h",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9d1447e09d4aa673826039321163b5a684e8e043/gdb/value.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9d1447e09d4aa673826039321163b5a684e8e043/gdb/value.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/value.h?ref=9d1447e09d4aa673826039321163b5a684e8e043",
      "patch": "@@ -1189,4 +1189,8 @@ extern struct value *call_xmethod (struct value *method,\n extern int value_union_variant (struct type *union_type,\n \t\t\t\tconst gdb_byte *contents);\n \n+/* Destroy the values currently allocated.  This is called when GDB is\n+   exiting (e.g., on quit_force).  */\n+extern void finalize_values ();\n+\n #endif /* !defined (VALUE_H) */"
    }
  ]
}