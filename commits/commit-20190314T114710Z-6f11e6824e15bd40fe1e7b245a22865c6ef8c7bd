{
  "sha": "6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NmYxMWU2ODI0ZTE1YmQ0MGZlMWU3YjI0NWEyMjg2NWM2ZWY4YzdiZA==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-03-08T20:41:55Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-03-14T11:47:10Z"
    },
    "message": "Make TUI react to \"set style enabled\"\n\nWhen the user toggles \"set style enabled\", the TUI should react by\nredrawing the source window, if necessary.  This patch implements this\nbehavior.\n\nNo test because the TUI is generally not tested.\n\nThis version of the patch incorporates Pedro's patch to provide a\nclean way to force the TUI to update the source window's contents.\n\ngdb/ChangeLog\n2019-03-14  Pedro Alves  <palves@redhat.com>\n\t    Tom Tromey  <tromey@adacore.com>\n\n\t* tui/tui-winsource.h (tui_refill_source_window): Declare.\n\t* tui/tui-winsource.c (tui_refill_source_window): New function,\n\tfrom...\n\t(tui_horizontal_source_scroll): ... here.  Move some logic.\n\t* cli/cli-style.c (set_style_enabled): Notify new observable.\n\t* tui/tui-hooks.c (tui_redisplay_source): New function.\n\t(tui_attach_detach_observers): Attach or detach\n\ttui_redisplay_source.\n\t* observable.h (source_styling_changed): New observable.\n\t* observable.c: Define source_styling_changed observable.",
    "tree": {
      "sha": "c4ba703384d8adcb73a5231d1d07563d44213957",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/c4ba703384d8adcb73a5231d1d07563d44213957"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a0148d8416f6c692b83acc77cf838b3e7929a249",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a0148d8416f6c692b83acc77cf838b3e7929a249",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/a0148d8416f6c692b83acc77cf838b3e7929a249"
    }
  ],
  "stats": {
    "total": 80,
    "additions": 61,
    "deletions": 19
  },
  "files": [
    {
      "sha": "2fcd6cdb388d9c0f05981dfb240d93a906424bfb",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -1,3 +1,17 @@\n+2019-03-14  Pedro Alves  <palves@redhat.com>\n+\t    Tom Tromey  <tromey@adacore.com>\n+\n+\t* tui/tui-winsource.h (tui_refill_source_window): Declare.\n+\t* tui/tui-winsource.c (tui_refill_source_window): New function,\n+\tfrom...\n+\t(tui_horizontal_source_scroll): ... here.  Move some logic.\n+\t* cli/cli-style.c (set_style_enabled): Notify new observable.\n+\t* tui/tui-hooks.c (tui_redisplay_source): New function.\n+\t(tui_attach_detach_observers): Attach or detach\n+\ttui_redisplay_source.\n+\t* observable.h (source_styling_changed): New observable.\n+\t* observable.c: Define source_styling_changed observable.\n+\n 2019-03-13  Tom Tromey  <tromey@adacore.com>\n \n \t* i386-gnu-nat.c (i386_gnu_nat_target::fetch_registers)"
    },
    {
      "sha": "fc91504d1f8f9b0e5e195e014d9084dc0ce164dd",
      "filename": "gdb/cli/cli-style.c",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/cli/cli-style.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/cli/cli-style.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/cli/cli-style.c?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -21,6 +21,7 @@\n #include \"cli/cli-cmds.h\"\n #include \"cli/cli-style.h\"\n #include \"source-cache.h\"\n+#include \"observable.h\"\n \n /* True if styling is enabled.  */\n \n@@ -216,6 +217,7 @@ static void\n set_style_enabled  (const char *args, int from_tty, struct cmd_list_element *c)\n {\n   g_source_cache.clear ();\n+  gdb::observers::source_styling_changed.notify ();\n }\n \n static void"
    },
    {
      "sha": "c077b025932664a0a381c71a1f2a6bffe988b750",
      "filename": "gdb/observable.c",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/observable.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/observable.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/observable.c?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -74,6 +74,7 @@ DEFINE_OBSERVABLE (inferior_call_pre);\n DEFINE_OBSERVABLE (inferior_call_post);\n DEFINE_OBSERVABLE (register_changed);\n DEFINE_OBSERVABLE (user_selected_context_changed);\n+DEFINE_OBSERVABLE (source_styling_changed);\n \n } /* namespace observers */\n } /* namespace gdb */"
    },
    {
      "sha": "edd1fffae0ac38223e01d5915f401bfd695f5be4",
      "filename": "gdb/observable.h",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/observable.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/observable.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/observable.h?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -228,6 +228,10 @@ extern observable<struct frame_info *, int> register_changed;\n    frame has changed.  */\n extern observable<user_selected_what> user_selected_context_changed;\n \n+/* This is notified when the source styling setting has changed and\n+   should be reconsulted.  */\n+extern observable<> source_styling_changed;\n+\n } /* namespace observers */\n \n } /* namespace gdb */"
    },
    {
      "sha": "4a1d79e0ad0b8aaf19b416665595a6565d320fb7",
      "filename": "gdb/tui/tui-hooks.c",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-hooks.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-hooks.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-hooks.c?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -204,6 +204,18 @@ tui_normal_stop (struct bpstats *bs, int print_frame)\n   tui_refresh_frame_and_register_information (/*registers_too_p=*/1);\n }\n \n+/* Observer for source_cache_cleared.  */\n+\n+static void\n+tui_redisplay_source ()\n+{\n+  if (tui_is_window_visible (SRC_WIN))\n+    {\n+      /* Force redisplay.  */\n+      tui_refill_source_window (tui_win_list[SRC_WIN]);\n+    }\n+}\n+\n /* Token associated with observers registered while TUI hooks are\n    installed.  */\n static const gdb::observers::token tui_observers_token {};\n@@ -239,6 +251,8 @@ tui_attach_detach_observers (bool attach)\n \t\t    tui_normal_stop, attach);\n   attach_or_detach (gdb::observers::register_changed,\n \t\t    tui_register_changed, attach);\n+  attach_or_detach (gdb::observers::source_styling_changed,\n+\t\t    tui_redisplay_source, attach);\n }\n \n /* Install the TUI specific hooks.  */"
    },
    {
      "sha": "7fd460bde3f1cf9d11a774c657514c71bc679d5d",
      "filename": "gdb/tui/tui-winsource.c",
      "status": "modified",
      "additions": 25,
      "deletions": 19,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-winsource.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-winsource.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-winsource.c?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -306,29 +306,40 @@ tui_show_source_content (struct tui_win_info *win_info)\n   win_info->generic.content_in_use = TRUE;\n }\n \n+/* Refill the source window's source cache and update it.  If WIN_INFO\n+   is a disassembly window, then just update it.  */\n+\n+void\n+tui_refill_source_window (struct tui_win_info *win_info)\n+{\n+  symtab *s = nullptr;\n+\n+  if (win_info->generic.type == SRC_WIN)\n+    {\n+      symtab_and_line cursal = get_current_source_symtab_and_line ();\n+      s = (cursal.symtab == NULL\n+\t   ? find_pc_line_symtab (get_frame_pc (get_selected_frame (NULL)))\n+\t   : cursal.symtab);\n+    }\n+\n+  tui_update_source_window_as_is (win_info,\n+\t\t\t\t  win_info->detail.source_info.gdbarch,\n+\t\t\t\t  s,\n+\t\t\t\t  win_info->generic.content[0]\n+\t\t\t\t    ->which_element.source.line_or_addr,\n+\t\t\t\t  FALSE);\n+}\n \n /* Scroll the source forward or backward horizontally.  */\n+\n void\n tui_horizontal_source_scroll (struct tui_win_info *win_info,\n \t\t\t      enum tui_scroll_direction direction,\n \t\t\t      int num_to_scroll)\n {\n   if (win_info->generic.content != NULL)\n     {\n-      struct gdbarch *gdbarch = win_info->detail.source_info.gdbarch;\n       int offset;\n-      struct symtab *s = NULL;\n-\n-      if (win_info->generic.type == SRC_WIN)\n-\t{\n-\t  struct symtab_and_line cursal\n-\t    = get_current_source_symtab_and_line ();\n-\n-\t  if (cursal.symtab == NULL)\n-\t    s = find_pc_line_symtab (get_frame_pc (get_selected_frame (NULL)));\n-\t  else\n-\t    s = cursal.symtab;\n-\t}\n \n       if (direction == LEFT_SCROLL)\n \toffset = win_info->detail.source_info.horizontal_offset\n@@ -341,13 +352,8 @@ tui_horizontal_source_scroll (struct tui_win_info *win_info,\n \t    offset = 0;\n \t}\n       win_info->detail.source_info.horizontal_offset = offset;\n-      tui_update_source_window_as_is (win_info, gdbarch, s,\n-\t\t\t\t      win_info->generic.content[0]\n-\t\t\t\t\t->which_element.source.line_or_addr,\n-\t\t\t\t      FALSE);\n+      tui_refill_source_window (win_info);\n     }\n-\n-  return;\n }\n \n "
    },
    {
      "sha": "920032b04eac31bf328ecb88e770f83b8535469e",
      "filename": "gdb/tui/tui-winsource.h",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-winsource.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd/gdb/tui/tui-winsource.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-winsource.h?ref=6f11e6824e15bd40fe1e7b245a22865c6ef8c7bd",
      "patch": "@@ -56,6 +56,7 @@ extern void tui_show_source_content (struct tui_win_info *);\n extern void tui_horizontal_source_scroll (struct tui_win_info *,\n \t\t\t\t\t  enum tui_scroll_direction, \n \t\t\t\t\t  int);\n+extern void tui_refill_source_window (struct tui_win_info *);\n extern enum tui_status tui_set_exec_info_content (struct tui_win_info *);\n extern void tui_show_exec_info_content (struct tui_win_info *);\n extern void tui_erase_exec_info_content (struct tui_win_info *);"
    }
  ]
}