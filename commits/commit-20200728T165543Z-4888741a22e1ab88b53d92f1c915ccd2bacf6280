{
  "sha": "4888741a22e1ab88b53d92f1c915ccd2bacf6280",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NDg4ODc0MWEyMmUxYWI4OGI1M2Q5MmYxYzkxNWNjZDJiYWNmNjI4MA==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-07-28T16:55:43Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-07-28T16:55:43Z"
    },
    "message": "Fix bug in DW_OP_GNU_variable_value evaluation\n\nA modified version of the gnat compiler (TBH I don't know if the\nmodifications are relevant to this bug or not, but I figured I'd\nmention it) can generate a DWARF location expression like:\n\n <1><1201>: Abbrev Number: 3 (DW_TAG_dwarf_procedure)\n    <1202>   DW_AT_location    : 32 byte block: 12 31 29 28 4 0 30 2f 12 0 14 30 2d 28 4 0 14 2f 1 0 30 34 1e 23 3 9 fc 1a 16 13 16 13 \t(DW_OP_dup; DW_OP_lit1; DW_OP_eq; DW_OP_bra: 4; DW_OP_lit0; DW_OP_skip: 18; DW_OP_over; DW_OP_lit0; DW_OP_lt; DW_OP_bra: 4; DW_OP_over; DW_OP_skip: 1; DW_OP_lit0; DW_OP_lit4; DW_OP_mul; DW_OP_plus_uconst: 3; DW_OP_const1s: -4; DW_OP_and; DW_OP_swap; DW_OP_drop; DW_OP_swap; DW_OP_drop)\n\n <2><1279>: Abbrev Number: 9 (DW_TAG_structure_type)\n    <127a>   DW_AT_name        : (indirect string, offset: 0x1a5a): p__logical_channel_t\n    <127e>   DW_AT_byte_size   : 18 byte block: fd 43 12 0 0 97 94 1 99 34 0 0 0 23 7 9 fc 1a \t(DW_OP_GNU_variable_value: <0x1243>; DW_OP_push_object_address; DW_OP_deref_size: 1; DW_OP_call4: <0x1201>; DW_OP_plus_uconst: 7; DW_OP_const1s: -4; DW_OP_and)\n\nWhen evaluated, this gives:\n\n    Incompatible types on DWARF stack\n\nIn Jakub's original message about DW_OP_GNU_variable_value:\n\n    https://gcc.gnu.org/legacy-ml/gcc-patches/2017-02/msg01499.html\n\n.. it says:\n\n    The intended behavior is that the debug info consumer computes the\n    value of that referenced variable at the current PC, and if it can\n    compute it and pushes the value as a generic type integer into the\n    DWARF stack\n\nInstead, gdb is using the variable's type -- but this fails with some\noperations, like DW_OP_and, which expect the types to match.\n\nI believe what was intended was for the value to be cast to the DWARF\n\"untyped\" type, which is what this patch implements.  This patch also\nupdates varval.exp to exhibit the bug.\n\ngdb/ChangeLog\n2020-07-28  Tom Tromey  <tromey@adacore.com>\n\n\t* dwarf2/expr.c (dwarf_expr_context::execute_stack_op)\n\t<DW_OP_GNU_variable_value>: Cast to address type.\n\ngdb/testsuite/ChangeLog\n2020-07-28  Tom Tromey  <tromey@adacore.com>\n\n\t* gdb.dwarf2/varval.exp (setup_exec): Add 'or' instruction to\n\t'varval' location.",
    "tree": {
      "sha": "3c87d2dd8673f338d2c3d2cb8b74fd49f0e33d99",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3c87d2dd8673f338d2c3d2cb8b74fd49f0e33d99"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/4888741a22e1ab88b53d92f1c915ccd2bacf6280",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4888741a22e1ab88b53d92f1c915ccd2bacf6280",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/4888741a22e1ab88b53d92f1c915ccd2bacf6280",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4888741a22e1ab88b53d92f1c915ccd2bacf6280/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4d46f40270b16070398412bc02a512143380814c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4d46f40270b16070398412bc02a512143380814c",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4d46f40270b16070398412bc02a512143380814c"
    }
  ],
  "stats": {
    "total": 15,
    "additions": 14,
    "deletions": 1
  },
  "files": [
    {
      "sha": "e10f89fc2d622d697c3621e50782d86a07799244",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=4888741a22e1ab88b53d92f1c915ccd2bacf6280",
      "patch": "@@ -1,3 +1,8 @@\n+2020-07-28  Tom Tromey  <tromey@adacore.com>\n+\n+\t* dwarf2/expr.c (dwarf_expr_context::execute_stack_op)\n+\t<DW_OP_GNU_variable_value>: Cast to address type.\n+\n 2020-07-28  Kamil Rytarowski  <n54@gmx.com>\n \n \t* nbsd-nat.h (nbsd_nat_target::xfer_partial): New declaration."
    },
    {
      "sha": "9bf74139d2da2b30aeb190031046d243abb9ac73",
      "filename": "gdb/dwarf2/expr.c",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/dwarf2/expr.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/dwarf2/expr.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/expr.c?ref=4888741a22e1ab88b53d92f1c915ccd2bacf6280",
      "patch": "@@ -1270,7 +1270,8 @@ dwarf_expr_context::execute_stack_op (const gdb_byte *op_ptr,\n \t                                                this->ref_addr_size,\n \t\t\t\t\t\t\tbyte_order);\n \t    op_ptr += this->ref_addr_size;\n-\t    result_val = this->dwarf_variable_value (sect_off);\n+\t    result_val = value_cast (address_type,\n+\t\t\t\t     this->dwarf_variable_value (sect_off));\n \t  }\n \t  break;\n \t"
    },
    {
      "sha": "40283fa532643e45b97996445bbc3e09fe950a8e",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=4888741a22e1ab88b53d92f1c915ccd2bacf6280",
      "patch": "@@ -1,3 +1,8 @@\n+2020-07-28  Tom Tromey  <tromey@adacore.com>\n+\n+\t* gdb.dwarf2/varval.exp (setup_exec): Add 'or' instruction to\n+\t'varval' location.\n+\n 2020-07-28  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* gdb.python/py-unwind.py: Update to make use of a register"
    },
    {
      "sha": "cb8836e2b24f468784e6202689cedb34042f6ca4",
      "filename": "gdb/testsuite/gdb.dwarf2/varval.exp",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/testsuite/gdb.dwarf2/varval.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4888741a22e1ab88b53d92f1c915ccd2bacf6280/gdb/testsuite/gdb.dwarf2/varval.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/varval.exp?ref=4888741a22e1ab88b53d92f1c915ccd2bacf6280",
      "patch": "@@ -207,6 +207,8 @@ proc setup_exec { arg_bad } {\n \t\t\t{DW_AT_type :${int_label}}\n \t\t\t{DW_AT_location {\n \t\t\t    DW_OP_GNU_variable_value ${var_a_label}\n+\t\t\t    DW_OP_const1s 0\n+\t\t\t    DW_OP_or\n \t\t\t    DW_OP_stack_value\n \t\t\t} SPECIAL_expr}\n \t\t    }"
    }
  ]
}