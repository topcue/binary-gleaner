{
  "sha": "16b0db75af6b4b4d434aa84c74d58b7290e04143",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MTZiMGRiNzVhZjZiNGI0ZDQzNGFhODRjNzRkNThiNzI5MGUwNDE0Mw==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-03-31T10:17:27Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-03-31T10:17:27Z"
    },
    "message": "[gdb/testsuite] Fix c-linkage-name.exp with -flto\n\nWhen running test-case gdb.base/c-linkage-name.exp with target board\nunix/-flto/-O0/-flto-partition=none/-ffat-lto-objects, I run into:\n...\nPASS: gdb.base/c-linkage-name.exp: maint info psymtab: c-linkage-name-2.c: no\nFAIL: gdb.base/c-linkage-name.exp: print symada__cS before partial symtab \\\n  expansion\n...\n\nThe test-case tries to print a symbol before and after symtab expansion.\n\nAnd it tries to ensure (since commit 13c3a74afb) that the symtab containing\nthe symbol is not yet expanded when doing the 'before' print, by placing the\nsymbol in a different CU (c-linkage-name-2.c) from the one containing main\n(c-linkage-name.c), such that when we load the exec and expand the symtab\ncontaining main, the symtab containing the symbol isn't.\n\nThe generated debug info for the test-case when using mentioned target board\nhowever is structured like this:\n...\n <0><d2>: Abbrev Number: 1 (DW_TAG_compile_unit)\n    <d8>   DW_AT_name        : <artificial>\n <1><f4>: Abbrev Number: 2 (DW_TAG_imported_unit)\n    <f5>   DW_AT_import      : <0x16b>  [Abbrev Number: 1]\n <1><f9>: Abbrev Number: 2 (DW_TAG_imported_unit)\n    <fa>   DW_AT_import      : <0x19c>  [Abbrev Number: 1]\n <1><fe>: Abbrev Number: 3 (DW_TAG_subprogram)\n    <ff>   DW_AT_abstract_origin: <0x17d>\n <1><115>: Abbrev Number: 4 (DW_TAG_variable)\n    <116>   DW_AT_abstract_origin: <0x1ce>\n <0><16b>: Abbrev Number: 1 (DW_TAG_compile_unit)\n    <171>   DW_AT_name        : c-linkage-name.c\n <1><17d>: Abbrev Number: 2 (DW_TAG_subprogram)\n    <17e>   DW_AT_name        : main\n <0><19c>: Abbrev Number: 1 (DW_TAG_compile_unit)\n    <1a2>   DW_AT_name        : c-linkage-name-2.c\n <1><1ce>: Abbrev Number: 5 (DW_TAG_variable)\n    <1cf>   DW_AT_name        : mundane\n    <1d6>   DW_AT_linkage_name: symada__cS\n...\n\nSo, the CU named <artificial> contains both the concrete main and the concrete\nsymbol, which explains the FAIL.\n\nThe first test should fail, but passes for two reasons.\n\nFirst of all, due to PR symtab/25700, we have two regular partial symtabs\nc-linkage-name-2.c instead of one, and one of them is expanded, the other one\nnot:\n...\n  { psymtab c-linkage-name-2.c ((struct partial_symtab *) 0x38d6f60)\n    readin yes\n  { psymtab c-linkage-name-2.c ((struct partial_symtab *) 0x38d6fe0)\n    readin no\n...\n\nAnd then there's the include symtab, which is also not expanded:\n...\n  { psymtab c-linkage-name-2.c ((struct partial_symtab *) 0x38143e0)\n    readin no\n...\n\nFix the FAIL by explicitly setting the language before load, changing the\nlanguage setting from auto/c to manual/c, such that the symtab containing main\nis no longer expanded.\n\nAnd make the symtab expansion testing more robust by using the output of\n\"maint info symtabs\" instead of \"maint info psymtabs\".\n\nTested on x86_64-linux, using native and target boards cc-with-gdb-index.exp,\ncc-with-debug-names.exp, readnow.exp and\nunix/-flto/-O0/-flto-partition=none/-ffat-lto-objects.\n\ngdb/testsuite/ChangeLog:\n\n2020-03-31  Tom de Vries  <tdevries@suse.de>\n\n\t* gdb.base/c-linkage-name.exp: Fix test-case comment.  Set language to\n\tc.  Use \"maint info symtabs\" to check symtab expansion.",
    "tree": {
      "sha": "bd982707c9f86e8686e64e7e5a19bc096462b559",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/bd982707c9f86e8686e64e7e5a19bc096462b559"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/16b0db75af6b4b4d434aa84c74d58b7290e04143",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/16b0db75af6b4b4d434aa84c74d58b7290e04143",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/16b0db75af6b4b4d434aa84c74d58b7290e04143",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/16b0db75af6b4b4d434aa84c74d58b7290e04143/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "89b599df37111317b9bc6fab541eb94c8b0bea35",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/89b599df37111317b9bc6fab541eb94c8b0bea35",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/89b599df37111317b9bc6fab541eb94c8b0bea35"
    }
  ],
  "stats": {
    "total": 25,
    "additions": 18,
    "deletions": 7
  },
  "files": [
    {
      "sha": "bb31bcdf3ac191e4583b27f3adb8380e74723e6f",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/16b0db75af6b4b4d434aa84c74d58b7290e04143/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/16b0db75af6b4b4d434aa84c74d58b7290e04143/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=16b0db75af6b4b4d434aa84c74d58b7290e04143",
      "patch": "@@ -1,3 +1,8 @@\n+2020-03-31  Tom de Vries  <tdevries@suse.de>\n+\n+\t* gdb.base/c-linkage-name.exp: Fix test-case comment.  Set language to\n+\tc.  Use \"maint info symtabs\" to check symtab expansion.\n+\n 2020-03-30  Tom de Vries  <tdevries@suse.de>\n \n \t* gdb.base/c-linkage-name.exp: Use readnow call to mark a test"
    },
    {
      "sha": "8afd8ce301ab4eafe894328881d5e6f31f2d40cc",
      "filename": "gdb/testsuite/gdb.base/c-linkage-name.exp",
      "status": "modified",
      "additions": 13,
      "deletions": 7,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/16b0db75af6b4b4d434aa84c74d58b7290e04143/gdb/testsuite/gdb.base/c-linkage-name.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/16b0db75af6b4b4d434aa84c74d58b7290e04143/gdb/testsuite/gdb.base/c-linkage-name.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/c-linkage-name.exp?ref=16b0db75af6b4b4d434aa84c74d58b7290e04143",
      "patch": "@@ -14,8 +14,8 @@\n # along with this program.  If not, see <http://www.gnu.org/licenses/>.\n \n # This file is part of the gdb testsuite.  It is intended to test that\n-# gdb can correctly print arrays with indexes for each element of the\n-# array.\n+# gdb can correctly print an ada symbol with linkage name before and after\n+# symtab expansion.\n \n standard_testfile c-linkage-name.c c-linkage-name-2.c\n \n@@ -25,13 +25,19 @@ if { [gdb_compile \"${sources}\" \"${binfile}\" executable {debug}] != \"\" } {\n     return -1\n }\n \n-clean_restart ${binfile}\n+clean_restart\n+gdb_test_no_output \"set language c\"\n+gdb_load ${binfile}\n set readnow [readnow]\n \n-# Verify that partial symtab expansion has not taken place for\n-# c-linkage-name-2.c.\n+set test \"verify no symtab expansion\"\n+if { $readnow } {\n+    unsupported $test\n+} else {\n+    # Verify that symtab expansion has not taken place.\n \n-verify_psymtab_expanded c-linkage-name-2.c no\n+    gdb_test_no_output \"maint info symtabs\" $test\n+}\n \n set test \"print symada__cS before partial symtab expansion\"\n if { $readnow } {\n@@ -54,7 +60,7 @@ gdb_test \"break do_something_other_cu\" \\\n # Verify that partial symtab expansion has taken place for\n # c-linkage-name-2.c.\n \n-verify_psymtab_expanded c-linkage-name-2.c yes\n+gdb_test \"maint info symtabs\" \"\\{ symtab \\[^\\r\\n\\]*c-linkage-name-2.c.*\"\n \n # Flush the symbol cache to prevent the lookup to return the same as before.\n "
    }
  ]
}