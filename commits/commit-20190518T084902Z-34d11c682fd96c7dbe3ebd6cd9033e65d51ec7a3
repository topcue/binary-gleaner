{
  "sha": "34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzRkMTFjNjgyZmQ5NmM3ZGJlM2ViZDZjZDkwMzNlNjVkNTFlYzdhMw==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-05-03T14:23:55Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-05-18T08:49:02Z"
    },
    "message": "gdb/fortran: Use floatformats_ia64_quad for fortran 16-byte floats\n\nPR gdb/18644 is caused by GDB using the wrong floating point format\nfor gfortran's 16-byte floating point type, including when the 16-byte\nfloat is used as the component of a 32-byte complex type.\n\nThis commit addresses the issue in two places, first in i386-tdep.c,\nthere is already some code to force the use of floatformats_ia64_quad\nfor specific named types, this is extended to include the type names\nthat gfortran uses for its 16-byte floats.\n\nSecond, the builtin 16-byte float type (in f-lang.c) is changed so it\nno longer uses gdbarch_long_double_format.  On i386 this type is not\n16-bytes, but is smaller, this is not what gfortran is expecting.\nInstead we now use gdbarch_floatformat_for_type and ask for a\n16-byte (128 bit) type using the common gfortran type name.  This is\nthen spotted in i386-tdep.c (thanks to the first change above) and we\nagain get floatformats_ia64_quad returned.\n\nThis patch was tested on X86-64/GNU-Linux using '--target_board=unix'\nand '--target_board=unix/-m32', and resolves all of the known failures\nassociated with PR gdb/18644.  I've also added the test case from the\noriginal bug report.\n\ngdb/ChangeLog:\n\n\tPR gdb/18644:\n\t* f-lang.c (build_fortran_types): Use floatformats_ia64_quad for\n\t16-byte floats.\n\t* i386-tdep.c (i386_floatformat_for_type): Use\n\tfloatformats_ia64_quad for the 16-byte floating point component\n\twithin a fortran 32-byte complex number.\n\ngdb/testsuite/ChangeLog:\n\n\tPR gdb/18644\n\t* gdb.fortran/complex.exp: Remove setup_kfail calls.\n\t* gdb.fortran/printing-types.exp: Add new test.\n\t* gdb.fortran/printing-types.f90: Add 16-byte real variable for\n\ttesting.\n\t* gdb.fortran/type-kinds.exp (test_cast_1_to_type_kind): Remove\n\tsetup_kfail call.",
    "tree": {
      "sha": "5a2e2cbf92b43bef00fd5658c88c43bd5aa9a627",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/5a2e2cbf92b43bef00fd5658c88c43bd5aa9a627"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "122cf0f2d93ae6f7a53e8dd643ebb068b79df9cf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/122cf0f2d93ae6f7a53e8dd643ebb068b79df9cf",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/122cf0f2d93ae6f7a53e8dd643ebb068b79df9cf"
    }
  ],
  "stats": {
    "total": 38,
    "additions": 27,
    "deletions": 11
  },
  "files": [
    {
      "sha": "51e946f70209b969578473ae4c4d418693e64b96",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -1,3 +1,12 @@\n+2019-05-18  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\tPR gdb/18644:\n+\t* f-lang.c (build_fortran_types): Use floatformats_ia64_quad for\n+\t16-byte floats.\n+\t* i386-tdep.c (i386_floatformat_for_type): Use\n+\tfloatformats_ia64_quad for the 16-byte floating point component\n+\twithin a fortran 32-byte complex number.\n+\n 2019-05-18  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* dwarf2read.c (struct cu_partial_die_info): Add constructor,"
    },
    {
      "sha": "5855c68b38c632d566bf42bd65c4002964223349",
      "filename": "gdb/f-lang.c",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/f-lang.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/f-lang.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/f-lang.c?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -727,9 +727,9 @@ build_fortran_types (struct gdbarch *gdbarch)\n   builtin_f_type->builtin_real_s8\n     = arch_float_type (gdbarch, gdbarch_double_bit (gdbarch),\n \t\t       \"real*8\", gdbarch_double_format (gdbarch));\n+  auto fmt = gdbarch_floatformat_for_type (gdbarch, \"real(kind=16)\", 128);\n   builtin_f_type->builtin_real_s16\n-    = arch_float_type (gdbarch, gdbarch_long_double_bit (gdbarch),\n-\t\t       \"real*16\", gdbarch_long_double_format (gdbarch));\n+    = arch_float_type (gdbarch, 128, \"real*16\", fmt);\n \n   builtin_f_type->builtin_complex_s8\n     = arch_complex_type (gdbarch, \"complex*8\","
    },
    {
      "sha": "c542edf28adbe65b364ed6b651ed57a4fbbb3b30",
      "filename": "gdb/i386-tdep.c",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/i386-tdep.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/i386-tdep.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/i386-tdep.c?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -8158,7 +8158,9 @@ i386_floatformat_for_type (struct gdbarch *gdbarch,\n   if (len == 128 && name)\n     if (strcmp (name, \"__float128\") == 0\n \t|| strcmp (name, \"_Float128\") == 0\n-\t|| strcmp (name, \"complex _Float128\") == 0)\n+\t|| strcmp (name, \"complex _Float128\") == 0\n+\t|| strcmp (name, \"complex(kind=16)\") == 0\n+\t|| strcmp (name, \"real(kind=16)\") == 0)\n       return floatformats_ia64_quad;\n \n   return default_floatformat_for_type (gdbarch, name, len);"
    },
    {
      "sha": "5cfad2754e6473aada84549c720975f245bb0217",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -1,3 +1,13 @@\n+2019-05-18  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\tPR gdb/18644\n+\t* gdb.fortran/complex.exp: Remove setup_kfail calls.\n+\t* gdb.fortran/printing-types.exp: Add new test.\n+\t* gdb.fortran/printing-types.f90: Add 16-byte real variable for\n+\ttesting.\n+\t* gdb.fortran/type-kinds.exp (test_cast_1_to_type_kind): Remove\n+\tsetup_kfail call.\n+\n 2019-05-17  Alan Hayward  <alan.hayward@arm.com>\n \n \t* README (Running the Testsuite): Change example."
    },
    {
      "sha": "94ac53afc70d1662f88860115436474a490be440",
      "filename": "gdb/testsuite/gdb.fortran/complex.exp",
      "status": "modified",
      "additions": 0,
      "deletions": 2,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/complex.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/complex.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.fortran/complex.exp?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -33,7 +33,6 @@ gdb_test \"print c4\" \" = \\\\(1000,-50\\\\)\"\n gdb_test \"print c8\" \" = \\\\(321,-22\\\\)\"\n gdb_test \"print dc\" \" = \\\\(321,-22\\\\)\"\n \n-setup_kfail gdb/18644 \"*-*-*\"\n gdb_test \"print c16\" \" = \\\\(-874,19\\\\)\"\n \n gdb_test \"whatis c\" \"type = complex\\\\(kind=4\\\\)\"\n@@ -53,7 +52,6 @@ gdb_test \"print \\$_creal (dc)\" \" = 321\"\n gdb_test \"whatis \\$\" \" = real\\\\*8\"\n \n gdb_test \"whatis c16\" \"type = complex\\\\(kind=16\\\\)\"\n-setup_kfail gdb/18644 \"*-*-*\"\n gdb_test \"print \\$_creal (c16)\" \" = -874\"\n gdb_test \"whatis \\$\" \" = real\\\\*16\"\n "
    },
    {
      "sha": "6394e45f4c3a967cb6703551eebd5820d1c6fe32",
      "filename": "gdb/testsuite/gdb.fortran/printing-types.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/printing-types.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/printing-types.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.fortran/printing-types.exp?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -33,3 +33,4 @@ gdb_test \"print oneByte\"\t\" = 1\"\n gdb_test \"print twobytes\"\t\" = 2\"\n gdb_test \"print chvalue\"\t\" = \\'a\\'\"\n gdb_test \"print logvalue\"\t\" = \\.TRUE\\.\"\n+gdb_test \"print rVal\"\t\t\" = 2000\""
    },
    {
      "sha": "36b63532c8e0c7846e8cc9e4f410600ee709c1c6",
      "filename": "gdb/testsuite/gdb.fortran/printing-types.f90",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/printing-types.f90",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/printing-types.f90",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.fortran/printing-types.f90?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -18,10 +18,12 @@ program prog\n   integer(2) :: twoBytes\n   character  :: chValue\n   logical(1) :: logValue\n+  real(kind=16) :: rVal\n \n   oneByte  = 1\n   twoBytes = 2\n   chValue  = 'a'\n   logValue = .true.\n+  rVal = 2000\n   write(*,*) s\n end"
    },
    {
      "sha": "9d19a9ceb39a1f57c142067f7fc25864b7689be2",
      "filename": "gdb/testsuite/gdb.fortran/type-kinds.exp",
      "status": "modified",
      "additions": 0,
      "deletions": 6,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/type-kinds.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3/gdb/testsuite/gdb.fortran/type-kinds.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.fortran/type-kinds.exp?ref=34d11c682fd96c7dbe3ebd6cd9033e65d51ec7a3",
      "patch": "@@ -27,12 +27,6 @@ if { [skip_fortran_tests] } { continue }\n proc test_cast_1_to_type_kind {base_type type_kind cast_result size_result} {\n     set type_string \"$base_type (kind=$type_kind)\"\n     gdb_test \"p (($type_string) 1)\" \" = $cast_result\"\n-\n-    if {($base_type == \"real\" || $base_type == \"complex\")\n-\t&& $type_kind == 16} {\n-\tsetup_kfail gdb/18644 \"*-*-*\"\n-    }\n-\n     gdb_test \"p sizeof (($type_string) 1)\" \" = $size_result\"\n }\n "
    }
  ]
}