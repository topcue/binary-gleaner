{
  "sha": "c6261a00c3e70dd8e508062ea43a1bcb6d547621",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YzYyNjFhMDBjM2U3MGRkOGU1MDgwNjJlYTQzYTFiY2I2ZDU0NzYyMQ==",
  "commit": {
    "author": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2019-11-12T23:50:48Z"
    },
    "committer": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2019-11-12T23:53:22Z"
    },
    "message": "RISC-V: Fix ld relax failure with calls and align directives.\n\nMake _bfd_riscv_relax_call handle section alignment padding same as\nthe _bfd_riscv_relax_lui and _bfd_riscv_relax_pc functions already\ndo.  Use the max section alignment if section boundaries are crossed,\notherwise the alignment of the containing section.\n\n\tbfd/\n\tPR 25181\n\t* elfnn-riscv.c (_bfd_riscv_relax_call): Always add max_alignment to\n\tfoff.  If sym_sec->output_section and sec->output_section are the same\n\tand not *ABS* then set max_alignment to that section's alignment.\n\n\tld/\n\tPR 25181\n\t* testsuite/ld-riscv-elf/call-relax-0.s: New file.\n\t* testsuite/ld-riscv-elf/call-relax-1.s: New file.\n\t* testsuite/ld-riscv-elf/call-relax-2.s: New file.\n\t* testsuite/ld-riscv-elf/call-relax-3.s: New file.\n\t* testsuite/ld-riscv-elf/call-relax.d: New test.\n\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp: Run call-relax test.\n\nChange-Id: Iaf65cee52345abf1955f36e8e72c4f6cc0db8d9a",
    "tree": {
      "sha": "b7267edb54f7535ff9913d2394ad867d14717b3b",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b7267edb54f7535ff9913d2394ad867d14717b3b"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/c6261a00c3e70dd8e508062ea43a1bcb6d547621",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c6261a00c3e70dd8e508062ea43a1bcb6d547621",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/c6261a00c3e70dd8e508062ea43a1bcb6d547621",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c6261a00c3e70dd8e508062ea43a1bcb6d547621/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "e06f3d6eba37df8451ecc2ce2ac76cba811e8b35",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e06f3d6eba37df8451ecc2ce2ac76cba811e8b35",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/e06f3d6eba37df8451ecc2ce2ac76cba811e8b35"
    }
  ],
  "stats": {
    "total": 71,
    "additions": 68,
    "deletions": 3
  },
  "files": [
    {
      "sha": "9370b7a8d04618d347b3ef2adb563fdcfde22f61",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -1,3 +1,10 @@\n+2019-11-12  Jim Wilson  <jimw@sifive.com>\n+\n+\tPR 25181\n+\t* elfnn-riscv.c (_bfd_riscv_relax_call): Always add max_alignment to\n+\tfoff.  If sym_sec->output_section and sec->output_section are the same\n+\tand not *ABS* then set max_alignment to that section's alignment.\n+\n 2019-11-07  Alan Modra  <amodra@gmail.com>\n \n \t* cpu-cr16c.c: Delete."
    },
    {
      "sha": "997f7866020ae5cdf5480bc964001312a71b3bd3",
      "filename": "bfd/elfnn-riscv.c",
      "status": "modified",
      "additions": 10,
      "deletions": 3,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/bfd/elfnn-riscv.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/bfd/elfnn-riscv.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfnn-riscv.c?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -3494,9 +3494,16 @@ _bfd_riscv_relax_call (bfd *abfd, asection *sec, asection *sym_sec,\n   int rd, r_type, len = 4, rvc = elf_elfheader (abfd)->e_flags & EF_RISCV_RVC;\n \n   /* If the call crosses section boundaries, an alignment directive could\n-     cause the PC-relative offset to later increase.  */\n-  if (VALID_UJTYPE_IMM (foff) && sym_sec->output_section != sec->output_section)\n-    foff += (foff < 0 ? -max_alignment : max_alignment);\n+     cause the PC-relative offset to later increase, so we need to add in the\n+     max alignment of any section inclusive from the call to the target.\n+     Otherwise, we only need to use the alignment of the current section.  */\n+  if (VALID_UJTYPE_IMM (foff))\n+    {\n+      if (sym_sec->output_section == sec->output_section\n+\t  && sym_sec->output_section != bfd_abs_section_ptr)\n+\tmax_alignment = (bfd_vma) 1 << sym_sec->output_section->alignment_power;\n+      foff += (foff < 0 ? -max_alignment : max_alignment);\n+    }\n \n   /* See if this function call can be shortened.  */\n   if (!VALID_UJTYPE_IMM (foff) && !(!bfd_link_pic (link_info) && near_zero))"
    },
    {
      "sha": "39646cb1dc8ebbd4ed51fa3d220c93afba8cff7b",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -1,3 +1,13 @@\n+2019-11-12  Jim Wilson  <jimw@sifive.com>\n+\n+\tPR 25181\n+\t* testsuite/ld-riscv-elf/call-relax-0.s: New file.\n+\t* testsuite/ld-riscv-elf/call-relax-1.s: New file.\n+\t* testsuite/ld-riscv-elf/call-relax-2.s: New file.\n+\t* testsuite/ld-riscv-elf/call-relax-3.s: New file.\n+\t* testsuite/ld-riscv-elf/call-relax.d: New test.\n+\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp: Run call-relax test.\n+\n 2019-11-08  Alan Modra  <amodra@gmail.com>\n \n \t* emulparams/aarch64elf.sh: Revert 2019-11-05 change."
    },
    {
      "sha": "4b18bf338d308857211507f1b213fb43a208166d",
      "filename": "ld/testsuite/ld-riscv-elf/call-relax-0.s",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-0.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-0.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/call-relax-0.s?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -0,0 +1,9 @@\n+.globl _start\n+\n+.section .text.hot\n+_start:\n+    call cc\n+\n+.text\n+ff:\n+    call dd"
    },
    {
      "sha": "270aaadd7faa0210bf024573ebf0a08f4ebbe043",
      "filename": "ld/testsuite/ld-riscv-elf/call-relax-1.s",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/call-relax-1.s?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -0,0 +1,6 @@\n+.globl align1\n+\n+.text\n+.balign 32\n+align1:\n+    csrr a0, sie"
    },
    {
      "sha": "2521d1c97e13bb1c49bdb14b80abf5b59f35abae",
      "filename": "ld/testsuite/ld-riscv-elf/call-relax-2.s",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/call-relax-2.s?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -0,0 +1,7 @@\n+.globl align2\n+\n+.text\n+.balign 4\n+align2:\n+    csrr a0, sie\n+.fill 0xfffb6"
    },
    {
      "sha": "3eb04d8b8f79c9b463e4572fb5354cd044f32009",
      "filename": "ld/testsuite/ld-riscv-elf/call-relax-3.s",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-3.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax-3.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/call-relax-3.s?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -0,0 +1,9 @@\n+.globl cc\n+.globl dd\n+\n+.text\n+cc:\n+    csrr a0, sie\n+    csrr a1, sie\n+dd:\n+    ret"
    },
    {
      "sha": "46d9c84f35f75a94ed54537c81eaa0a8f1768104",
      "filename": "ld/testsuite/ld-riscv-elf/call-relax.d",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/call-relax.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/call-relax.d?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -0,0 +1,9 @@\n+#name: call relaxation with alignment\n+#source: call-relax-0.s\n+#source: call-relax-1.s\n+#source: call-relax-2.s\n+#source: call-relax-3.s\n+#as: -march=rv32ic\n+#ld: -melf32lriscv\n+#objdump: -d\n+#pass"
    },
    {
      "sha": "7aabbdd641cc338eef4fb54669e135cec2408267",
      "filename": "ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c6261a00c3e70dd8e508062ea43a1bcb6d547621/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp?ref=c6261a00c3e70dd8e508062ea43a1bcb6d547621",
      "patch": "@@ -20,6 +20,7 @@\n #\n \n if [istarget \"riscv*-*-*\"] {\n+    run_dump_test \"call-relax\"\n     run_dump_test \"c-lui\"\n     run_dump_test \"c-lui-2\"\n     run_dump_test \"disas-jalr\""
    }
  ]
}