{
  "sha": "00386881a3d0f7ac89fcc5cc912da8cd69c04324",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MDAzODY4ODFhM2QwZjdhYzg5ZmNjNWNjOTEyZGE4Y2Q2OWMwNDMyNA==",
  "commit": {
    "author": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2020-03-30T15:30:02Z"
    },
    "committer": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2020-03-30T15:30:02Z"
    },
    "message": "Fix objcopy's --preserve-dates command line option so that it will work with PE format files.\n\n\tPR binutils/pr25662\nbfd\t* libcoff-in.h (struct pe_tdata): Rename the insert_timestamp\n\tfield to timestamp and make it an integer.\n\t* libcoff.h: Regenerate.\n\t* peXXigen.c (_bfd_XXi_only_swap_filehdr_out): Test the timestamp\n\tfield in the pe_data structure rather than the insert_timestamp\n\tfield.\n\nbinutils* objcopy.c (copy_object): When copying PE format files set the\n\ttimestamp field in the pe_data structure if the preserve_dates\n\tflag is set.\n\t* testsuite/binutils-all/objcopy.exp (objcopy_test) Use\n\t--preserve-dates in place of the -p option, in order to make its\n\teffect more obvious.\n\nld\t* emultempl/pe.em (after_open): Replace initialisation of the\n\tinsert_timestamp field in the pe_data structure with an\n\tinitialisation of the timestamp field.\n\t* emultemp/pep.em: Likewise.\n\t* pe-dll.c (fill_edata): Use the timestamp field in the pe_data\n\tstructure instead of the insert_timestamp field.",
    "tree": {
      "sha": "49d19d14cdb49b7bf0c6fb7f292be780eb385ca3",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/49d19d14cdb49b7bf0c6fb7f292be780eb385ca3"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/00386881a3d0f7ac89fcc5cc912da8cd69c04324",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/00386881a3d0f7ac89fcc5cc912da8cd69c04324",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/00386881a3d0f7ac89fcc5cc912da8cd69c04324",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/00386881a3d0f7ac89fcc5cc912da8cd69c04324/comments",
  "author": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "227c0bf4b3dd0cf65dceb58e729e9da81b38b5a7",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/227c0bf4b3dd0cf65dceb58e729e9da81b38b5a7",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/227c0bf4b3dd0cf65dceb58e729e9da81b38b5a7"
    }
  ],
  "stats": {
    "total": 63,
    "additions": 55,
    "deletions": 8
  },
  "files": [
    {
      "sha": "bd43b676ba15d9f1be9be5c95fd58fde084fd186",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1,3 +1,13 @@\n+2020-03-30  Nick Clifton  <nickc@redhat.com>\n+\n+\tPR binutils/pr25662\n+\t* libcoff-in.h (struct pe_tdata): Rename the insert_timestamp\n+\tfield to timestamp and make it an integer.\n+\t* libcoff.h: Regenerate.\n+\t* peXXigen.c (_bfd_XXi_only_swap_filehdr_out): Test the timestamp\n+\tfield in the pe_data structure rather than the insert_timestamp\n+\tfield.\n+\n 2020-03-30  Alan Modra  <amodra@gmail.com>\n \n \tPR 25745"
    },
    {
      "sha": "c86ffc99330088f57f14ce1a762634aa61a23d72",
      "filename": "bfd/libcoff-in.h",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/libcoff-in.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/libcoff-in.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/libcoff-in.h?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -128,7 +128,9 @@ typedef struct pe_tdata\n   int has_reloc_section;\n   int dont_strip_reloc;\n   int dos_message[16];\n-  bfd_boolean insert_timestamp;\n+  /* The timestamp to insert into the output file.\n+     If the timestamp is -1 then the current time is used.  */\n+  int timestamp;\n   bfd_boolean (*in_reloc_p) (bfd *, reloc_howto_type *);\n   flagword real_flags;\n "
    },
    {
      "sha": "eeb7b6b9954073412cff1ea07f9b7be40be31d29",
      "filename": "bfd/libcoff.h",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/libcoff.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/libcoff.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/libcoff.h?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -132,7 +132,9 @@ typedef struct pe_tdata\n   int has_reloc_section;\n   int dont_strip_reloc;\n   int dos_message[16];\n-  bfd_boolean insert_timestamp;\n+  /* The timestamp to insert into the output file.\n+     If the timestamp is -1 then the current time is used.  */\n+  int timestamp;\n   bfd_boolean (*in_reloc_p) (bfd *, reloc_howto_type *);\n   flagword real_flags;\n "
    },
    {
      "sha": "b9eeb775d9b1ba0c452e3b1fe541a2f27e412f8a",
      "filename": "bfd/peXXigen.c",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/peXXigen.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/bfd/peXXigen.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/peXXigen.c?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -876,10 +876,10 @@ _bfd_XXi_only_swap_filehdr_out (bfd * abfd, void * in, void * out)\n \n   /* Use a real timestamp by default, unless the no-insert-timestamp\n      option was chosen.  */\n-  if ((pe_data (abfd)->insert_timestamp))\n+  if ((pe_data (abfd)->timestamp) == -1)\n     H_PUT_32 (abfd, time (0), filehdr_out->f_timdat);\n   else\n-    H_PUT_32 (abfd, 0, filehdr_out->f_timdat);\n+    H_PUT_32 (abfd, pe_data (abfd)->timestamp, filehdr_out->f_timdat);\n \n   PUT_FILEHDR_SYMPTR (abfd, filehdr_in->f_symptr,\n \t\t      filehdr_out->f_symptr);"
    },
    {
      "sha": "a08be238790e8a0a1952631af80934e2b0bc47e9",
      "filename": "binutils/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/ChangeLog?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1,3 +1,13 @@\n+2020-03-30  Nick Clifton  <nickc@redhat.com>\n+\n+\tPR binutils/25662\n+\t* objcopy.c (copy_object): When copying PE format files set the\n+\ttimestamp field in the pe_data structure if the preserve_dates\n+\tflag is set.\n+\t* testsuite/binutils-all/objcopy.exp (objcopy_test) Use\n+\t--preserve-dates in place of the -p option, in order to make its\n+\teffect more obvious.\n+\n 2020-03-28  Alan Modra  <amodra@gmail.com>\n \n \t* testsuite/binutils-all/objcopy.exp (objcopy_test): Only"
    },
    {
      "sha": "738ef4c2c9135742d6c0518a3bac631574e8fa58",
      "filename": "binutils/objcopy.c",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/objcopy.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/objcopy.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/objcopy.c?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -2774,6 +2774,11 @@ copy_object (bfd *ibfd, bfd *obfd, const bfd_arch_info_type *input_arch)\n \n \t\t     file_alignment, section_alignment);\n \t}\n+\n+      if (preserve_dates\n+\t  && bfd_get_flavour (ibfd) == bfd_target_coff_flavour\n+\t  && bfd_pei_p (ibfd))\n+\tpe->timestamp = pe_data (ibfd)->coff.timestamp;\n     }\n \n   if (isympp)"
    },
    {
      "sha": "56a7db8199b7a375b9ca5a44657e893e9488d952",
      "filename": "binutils/testsuite/binutils-all/objcopy.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/testsuite/binutils-all/objcopy.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/binutils/testsuite/binutils-all/objcopy.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/testsuite/binutils-all/objcopy.exp?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -76,7 +76,7 @@ proc objcopy_test {testname srcfile type asflags ldflags} {\n \t    unresolved \"objcopy $type ($testname)\"\n \t    return\n \t}\n-\tset xflags \"-p\"\n+\tset xflags \"--preserve-dates\"\n     }\n \n     set got [binutils_run $OBJCOPY \"$OBJCOPYFLAGS $xflags $t_tempfile $t_copyfile\"]"
    },
    {
      "sha": "15d34bc5a3f134c5edfec930d53ff53de0f165e9",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1,3 +1,13 @@\n+2020-03-30  Nick Clifton  <nickc@redhat.com>\n+\n+\tPR binutils/25662\n+\t* emultempl/pe.em (after_open): Replace initialisation of the\n+\tinsert_timestamp field in the pe_data structure with an\n+\tinitialisation of the timestamp field.\n+\t* emultemp/pep.em: Likewise.\n+\t* pe-dll.c (fill_edata): Use the timestamp field in the pe_data\n+\tstructure instead of the insert_timestamp field.\n+\n 2020-03-28  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR 25732"
    },
    {
      "sha": "4fe195ec32abc4eab650121bc7198f1ce1f8bd75",
      "filename": "ld/emultempl/pe.em",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/emultempl/pe.em",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/emultempl/pe.em",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emultempl/pe.em?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1375,7 +1375,10 @@ gld_${EMULATION_NAME}_after_open (void)\n   pe_data (link_info.output_bfd)->pe_opthdr = pe;\n   pe_data (link_info.output_bfd)->dll = init[DLLOFF].value;\n   pe_data (link_info.output_bfd)->real_flags |= real_flags;\n-  pe_data (link_info.output_bfd)->insert_timestamp = insert_timestamp;\n+  if (insert_timestamp)\n+    pe_data (link_info.output_bfd)->timestamp = -1;\n+  else\n+    pe_data (link_info.output_bfd)->timestamp = 0;\n \n   /* At this point we must decide whether to use long section names\n      in the output or not.  If the user hasn't explicitly specified"
    },
    {
      "sha": "3e03eb3a6e0f40135f67abfc3355d5aadc1fabea",
      "filename": "ld/emultempl/pep.em",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/emultempl/pep.em",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/emultempl/pep.em",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emultempl/pep.em?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1364,7 +1364,10 @@ gld_${EMULATION_NAME}_after_open (void)\n   pe_data (link_info.output_bfd)->pe_opthdr = pep;\n   pe_data (link_info.output_bfd)->dll = init[DLLOFF].value;\n   pe_data (link_info.output_bfd)->real_flags |= real_flags;\n-  pe_data (link_info.output_bfd)->insert_timestamp = insert_timestamp;\n+  if (insert_timestamp)\n+    pe_data (link_info.output_bfd)->timestamp = -1;\n+  else\n+    pe_data (link_info.output_bfd)->timestamp = 0;\n \n   /* At this point we must decide whether to use long section names\n      in the output or not.  If the user hasn't explicitly specified"
    },
    {
      "sha": "0addde231863a50e7111e2ce23cd00699dcfb98c",
      "filename": "ld/pe-dll.c",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/pe-dll.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/00386881a3d0f7ac89fcc5cc912da8cd69c04324/ld/pe-dll.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/pe-dll.c?ref=00386881a3d0f7ac89fcc5cc912da8cd69c04324",
      "patch": "@@ -1211,8 +1211,10 @@ fill_edata (bfd *abfd, struct bfd_link_info *info ATTRIBUTE_UNUSED)\n \n   memset (edata_d, 0, edata_sz);\n \n-  if (pe_data (abfd)->insert_timestamp)\n+  if (pe_data (abfd)->timestamp == -1)\n     H_PUT_32 (abfd, time (0), edata_d + 4);\n+  else\n+    H_PUT_32 (abfd, pe_data (abfd)->timestamp, edata_d + 4);\n \n   if (pe_def_file->version_major != -1)\n     {"
    }
  ]
}