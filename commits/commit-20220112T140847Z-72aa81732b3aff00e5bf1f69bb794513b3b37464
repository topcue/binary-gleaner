{
  "sha": "72aa81732b3aff00e5bf1f69bb794513b3b37464",
  "node_id": "C_kwDOANOeidoAKDcyYWE4MTczMmIzYWZmMDBlNWJmMWY2OWJiNzk0NTEzYjNiMzc0NjQ",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2022-01-06T03:21:45Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2022-01-12T14:08:47Z"
    },
    "message": "ld: Add glibc dependency for DT_RELR\n\nWhen DT_RELR is enabled, to avoid random run-time crash with older glibc\nbinaries without DT_RELR support, add a GLIBC_ABI_DT_RELR symbol version,\nwhich is provided by glibc with DT_RELR support, dependency on the shared\nC library if it provides a GLIBC_2.XX symbol version.\n\nbfd/\n\n\t* elflink.c (elf_link_add_dt_relr_dependency): New function.\n\t(bfd_elf_size_dynamic_sections): Call\n\telf_link_add_dt_relr_dependency if DT_RELR is enabled.\n\nld/\n\n\t* ld.texi: Mention GLIBC_ABI_DT_RELR in -z pack-relative-relocs\n\tentry.\n\t* testsuite/ld-elf/dt-relr-glibc-1.c: New file.\n\t* testsuite/ld-elf/dt-relr-glibc-1a.rd: Likewise.\n\t* testsuite/ld-elf/dt-relr-glibc-1b.rd: Likewise.\n\t* testsuite/ld-elf/dt-relr.exp: Likewise.",
    "tree": {
      "sha": "13cdfb51891320c3ff5b56652c50b499e2617c3c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/13cdfb51891320c3ff5b56652c50b499e2617c3c"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/72aa81732b3aff00e5bf1f69bb794513b3b37464",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/72aa81732b3aff00e5bf1f69bb794513b3b37464",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/72aa81732b3aff00e5bf1f69bb794513b3b37464",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/72aa81732b3aff00e5bf1f69bb794513b3b37464/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4d9e2e53b9f93b0ae33ba948ae3d2825b3424441",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4d9e2e53b9f93b0ae33ba948ae3d2825b3424441",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4d9e2e53b9f93b0ae33ba948ae3d2825b3424441"
    }
  ],
  "stats": {
    "total": 156,
    "additions": 155,
    "deletions": 1
  },
  "files": [
    {
      "sha": "107480286f3508569d12ea6770d11896a0573233",
      "filename": "bfd/elflink.c",
      "status": "modified",
      "additions": 86,
      "deletions": 0,
      "changes": 86,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/bfd/elflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/bfd/elflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elflink.c?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -2213,6 +2213,85 @@ _bfd_elf_export_symbol (struct elf_link_hash_entry *h, void *data)\n   return true;\n }\n \f\n+/* Return true if GLIBC_ABI_DT_RELR is added to the list of version\n+   dependencies successfully.  GLIBC_ABI_DT_RELR will be put into the\n+   .gnu.version_r section.  */\n+\n+static bool\n+elf_link_add_dt_relr_dependency (struct elf_find_verdep_info *rinfo)\n+{\n+  bfd *glibc_bfd = NULL;\n+  Elf_Internal_Verneed *t;\n+  Elf_Internal_Vernaux *a;\n+  size_t amt;\n+  const char *relr = \"GLIBC_ABI_DT_RELR\";\n+\n+  /* See if we already know about GLIBC_PRIVATE_DT_RELR.  */\n+  for (t = elf_tdata (rinfo->info->output_bfd)->verref;\n+       t != NULL;\n+       t = t->vn_nextref)\n+    {\n+      const char *soname = bfd_elf_get_dt_soname (t->vn_bfd);\n+      /* Skip the shared library if it isn't libc.so.  */\n+      if (!soname || !startswith (soname, \"libc.so.\"))\n+\tcontinue;\n+\n+      for (a = t->vn_auxptr; a != NULL; a = a->vna_nextptr)\n+\t{\n+\t  /* Return if GLIBC_PRIVATE_DT_RELR dependency has been\n+\t     added.  */\n+\t  if (a->vna_nodename == relr\n+\t      || strcmp (a->vna_nodename, relr) == 0)\n+\t    return true;\n+\n+\t  /* Check if libc.so provides GLIBC_2.XX version.  */\n+\t  if (!glibc_bfd && startswith (a->vna_nodename, \"GLIBC_2.\"))\n+\t    glibc_bfd = t->vn_bfd;\n+\t}\n+\n+      break;\n+    }\n+\n+  /* Skip if it isn't linked against glibc.  */\n+  if (glibc_bfd == NULL)\n+    return true;\n+\n+  /* This is a new version.  Add it to tree we are building.  */\n+  if (t == NULL)\n+    {\n+      amt = sizeof *t;\n+      t = (Elf_Internal_Verneed *) bfd_zalloc (rinfo->info->output_bfd,\n+\t\t\t\t\t       amt);\n+      if (t == NULL)\n+\t{\n+\t  rinfo->failed = true;\n+\t  return false;\n+\t}\n+\n+      t->vn_bfd = glibc_bfd;\n+      t->vn_nextref = elf_tdata (rinfo->info->output_bfd)->verref;\n+      elf_tdata (rinfo->info->output_bfd)->verref = t;\n+    }\n+\n+  amt = sizeof *a;\n+  a = (Elf_Internal_Vernaux *) bfd_zalloc (rinfo->info->output_bfd, amt);\n+  if (a == NULL)\n+    {\n+      rinfo->failed = true;\n+      return false;\n+    }\n+\n+  a->vna_nodename = relr;\n+  a->vna_flags = 0;\n+  a->vna_nextptr = t->vn_auxptr;\n+  a->vna_other = rinfo->vers + 1;\n+  ++rinfo->vers;\n+\n+  t->vn_auxptr = a;\n+\n+  return true;\n+}\n+\n /* Look through the symbols which are defined in other shared\n    libraries and referenced here.  Update the list of version\n    dependencies.  This will be put into the .gnu.version_r section.\n@@ -6940,6 +7019,13 @@ bfd_elf_size_dynamic_sections (bfd *output_bfd,\n       if (sinfo.failed)\n \treturn false;\n \n+      if (info->enable_dt_relr)\n+\t{\n+\t  elf_link_add_dt_relr_dependency (&sinfo);\n+\t  if (sinfo.failed)\n+\t    return false;\n+\t}\n+\n       if (elf_tdata (output_bfd)->verref == NULL)\n \ts->flags |= SEC_EXCLUDE;\n       else"
    },
    {
      "sha": "fc75e9b36256d92ad530bc6f700f9e19c08463d5",
      "filename": "ld/ld.texi",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/ld.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/ld.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ld.texi?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -1437,7 +1437,9 @@ and shared library.  It adds @code{DT_RELR}, @code{DT_RELRSZ} and\n @code{DT_RELRENT} entries to the dynamic section.  It is ignored when\n building position-dependent executable and relocatable output.\n @option{nopack-relative-relocs} is the default, which disables compact\n-relative relocation.  Supported for i386 and x86-64.\n+relative relocation.  When linked against the GNU C Library, a\n+GLIBC_ABI_DT_RELR symbol version dependency on the shared C Library is\n+added to the output.  Supported for i386 and x86-64.\n \n @item relro\n @itemx norelro"
    },
    {
      "sha": "beacffe29e76342c77b9c5476aad7c4244724e16",
      "filename": "ld/testsuite/ld-elf/dt-relr-glibc-1.c",
      "status": "added",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/dt-relr-glibc-1.c?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -0,0 +1,11 @@\n+#define REL(n) \\\n+  static int data##n; \\\n+  void *p##n = &data##n;\n+\n+REL(1)\n+REL(2)\n+REL(3)\n+REL(4)\n+REL(5)\n+REL(6)\n+REL(7)"
    },
    {
      "sha": "51bda5d70a13592a79e9d4ccf130a2ad76f341be",
      "filename": "ld/testsuite/ld-elf/dt-relr-glibc-1a.rd",
      "status": "added",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1a.rd",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1a.rd",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/dt-relr-glibc-1a.rd?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -0,0 +1,4 @@\n+#failif\n+#...\n+  0x[a-f0-9]+:   Name: GLIBC_ABI_DT_RELR  Flags: none  Version: [0-9]+\n+#..."
    },
    {
      "sha": "6556a6d939e89a18c8d62e8a085cfba2922daba2",
      "filename": "ld/testsuite/ld-elf/dt-relr-glibc-1b.rd",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1b.rd",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr-glibc-1b.rd",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/dt-relr-glibc-1b.rd?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -0,0 +1,7 @@\n+#...\n+Version needs section '.gnu.version_r' contains 1 entry:\n+ Addr: 0x[0-9a-f]+ +Offset: 0x[0-9a-f]+ +Link: +[0-9]+ +\\(.dynstr\\)\n+ +0+: Version: 1 +File: libc\\.so\\.6(|\\.1) +Cnt: +[0-9]+\n+#...\n+  0x[a-f0-9]+:   Name: GLIBC_ABI_DT_RELR  Flags: none  Version: [0-9]+\n+#pass"
    },
    {
      "sha": "51d21e400ab48cde97fc9f267e224323c9fe3361",
      "filename": "ld/testsuite/ld-elf/dt-relr.exp",
      "status": "added",
      "additions": 44,
      "deletions": 0,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72aa81732b3aff00e5bf1f69bb794513b3b37464/ld/testsuite/ld-elf/dt-relr.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/dt-relr.exp?ref=72aa81732b3aff00e5bf1f69bb794513b3b37464",
      "patch": "@@ -0,0 +1,44 @@\n+# Expect script for DT_RELR.\n+#   Copyright (C) 2022 Free Software Foundation, Inc.\n+#\n+# This file is part of the GNU Binutils.\n+#\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program; if not, write to the Free Software\n+# Foundation, Inc., 51 Franklin Street - Fifth Floor, Boston,\n+# MA 02110-1301, USA.\n+#\n+\n+# Linux tests.\n+if { ![istarget \"*-*-linux*\"] } {\n+    return\n+}\n+\n+run_cc_link_tests [list \\\n+    [list \\\n+\t\"Build dt-relr-glibc-1a.so\" \\\n+\t\"-shared $NO_DT_RELR_CC_LDFLAGS\" \\\n+\t\"-fPIC\" \\\n+\t{ dt-relr-glibc-1.c } \\\n+\t{{readelf {--version-info} dt-relr-glibc-1a.rd}} \\\n+\t\"glibc-relr-1a.so\" \\\n+    ] \\\n+    [list \\\n+\t\"Build dt-relr-glibc-1b.so\" \\\n+\t\"-shared $DT_RELR_CC_LDFLAGS\" \\\n+\t\"-fPIC\" \\\n+\t{ dt-relr-glibc-1.c } \\\n+\t{{readelf {-W --version-info} dt-relr-glibc-1b.rd}} \\\n+\t\"dt-relr-glibc-1b.so\" \\\n+    ] \\\n+]"
    }
  ]
}