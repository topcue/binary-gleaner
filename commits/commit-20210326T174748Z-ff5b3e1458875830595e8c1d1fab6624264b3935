{
  "sha": "ff5b3e1458875830595e8c1d1fab6624264b3935",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZmY1YjNlMTQ1ODg3NTgzMDU5NWU4YzFkMWZhYjY2MjQyNjRiMzkzNQ==",
  "commit": {
    "author": {
      "name": "Keith Seitz",
      "email": "keiths@redhat.com",
      "date": "2021-03-25T17:31:48Z"
    },
    "committer": {
      "name": "Keith Seitz",
      "email": "keiths@redhat.com",
      "date": "2021-03-26T17:47:48Z"
    },
    "message": "Save/restore file offset while reading notes in core file\n\nA recent bug (RH BZ 1931344) has exposed a bug in the core file\nbuild-ID support that I introduced a while ago. It is pretty\neasy to demonstate the problem following a simplified procedure\noutlined in that bug:\n\n[shell1]\nshell1$ /usr/libexec/qemu-kvm\n\n[shell2]\nshell2$ pkill -SEGV -x qemu-kvm\n\n[shell1]\nSegmentation fault (core dumped)\n\nLoad this core file into GDB without specifying an executable\n(an unfortunate Fedora/RHEL-ism), and GDB will inform the user\nto install debuginfo for the \"missing\" executable:\n\n$ gdb -nx -q core.12345\n...\nMissing separate debuginfo for the main executable file\nTry: dnf --enablerepo='*debug*' install /usr/lib/debug/.build-id/e2/e9c66d3117fb2bbb5b2be122f04f2664e5df54\nCore was generated by `/usr/libexec/qemu-kvm'.\nProgram terminated with signal SIGSEGV, Segmentation fault.\n...\n\nThe suggested build-ID is actaully for gmp not qemu-kvm. The problem\nlies in _bfd_elf_core_find_build_id, where we loop over program headers\nlooking for note segments:\n\n  /* Read in program headers and parse notes.  */\n  for (i = 0; i < i_ehdr.e_phnum; ++i, ++i_phdr)\n    {\n      Elf_External_Phdr x_phdr;\n\n      if (bfd_bread (&x_phdr, sizeof (x_phdr), abfd) != sizeof (x_phdr))\n        goto fail;\n      elf_swap_phdr_in (abfd, &x_phdr, i_phdr);\n\n      if (i_phdr->p_type == PT_NOTE && i_phdr->p_filesz > 0)\n        {\n          elf_read_notes (abfd, offset + i_phdr->p_offset,\n                          i_phdr->p_filesz, i_phdr->p_align);\n\n          if (abfd->build_id != NULL)\n            return TRUE;\n        }\n\nelf_read_notes uses bfd_seek to forward the stream to the location of\nthe note segment. When control returns to _bfd_elf_core_fild_build_id,\nthe stream is no longer in the location looking at program headers, and\nall subsequent reads will read from the wrong file offset.\n\nTo fix this, this patch marks the stream location and ensures\nthat it is restored after elf_read_notes is called.\n\nbfd/ChangeLog\n2021-03-26  Keith Seitz  <keiths@redhat.com>\n\n\t* elfcore.h (_bfd_elf_core_find_build_id): Seek file\n\toffset of program headers after calling elf_read_notes.",
    "tree": {
      "sha": "e304ca791ac8d5e519f60d7b92eaa77384783c75",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e304ca791ac8d5e519f60d7b92eaa77384783c75"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ff5b3e1458875830595e8c1d1fab6624264b3935",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ff5b3e1458875830595e8c1d1fab6624264b3935",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ff5b3e1458875830595e8c1d1fab6624264b3935",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ff5b3e1458875830595e8c1d1fab6624264b3935/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "b1f3973b9c55a1406c13ade5cb14239d5b17a465",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b1f3973b9c55a1406c13ade5cb14239d5b17a465",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/b1f3973b9c55a1406c13ade5cb14239d5b17a465"
    }
  ],
  "stats": {
    "total": 12,
    "additions": 12,
    "deletions": 0
  },
  "files": [
    {
      "sha": "6f3fccc0a6a23a01694bf42b054fac94f1440f19",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ff5b3e1458875830595e8c1d1fab6624264b3935/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ff5b3e1458875830595e8c1d1fab6624264b3935/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=ff5b3e1458875830595e8c1d1fab6624264b3935",
      "patch": "@@ -1,3 +1,8 @@\n+2021-03-26  Keith Seitz  <keiths@redhat.com>\n+\n+\t* elfcore.h (_bfd_elf_core_find_build_id): Seek file\n+\toffset of program headers after calling elf_read_notes.\n+\n 2021-03-23  Jan Beulich  <jbeulich@suse.com>\n \n \t* dwarf2.c (read_indexed_string): Rename index to idx."
    },
    {
      "sha": "4e6383415f7df81b2afc4ec1489074bb7caee570",
      "filename": "bfd/elfcore.h",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ff5b3e1458875830595e8c1d1fab6624264b3935/bfd/elfcore.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ff5b3e1458875830595e8c1d1fab6624264b3935/bfd/elfcore.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfcore.h?ref=ff5b3e1458875830595e8c1d1fab6624264b3935",
      "patch": "@@ -410,6 +410,13 @@ NAME(_bfd_elf, core_find_build_id)\n \t{\n \t  elf_read_notes (abfd, offset + i_phdr->p_offset,\n \t\t\t  i_phdr->p_filesz, i_phdr->p_align);\n+\n+\t  /* Make sure ABFD returns to processing the program headers.  */\n+\t  if (bfd_seek (abfd, (file_ptr) (offset + i_ehdr.e_phoff\n+\t\t\t\t\t  + (i + 1) * sizeof (x_phdr)),\n+\t\t\tSEEK_SET) != 0)\n+\t    goto fail;\n+\n \t  if (abfd->build_id != NULL)\n \t    return TRUE;\n \t}"
    }
  ]
}