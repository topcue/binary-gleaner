{
  "sha": "4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NGQwNzU0YzVmNTcyYjAxY2YyZmU2YzhhYjI5MmFkYmE4MzMzMWNiYw==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2021-07-30T17:18:36Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2021-08-02T13:46:30Z"
    },
    "message": "Avoid crash in varobj deletion\n\nPR varobj/28131 points out a crash in the varobj deletion code.  It\ntook a while to reproduce this, but essentially what happens is that a\ntop-level varobj deletes its root object, then deletes the \"dynamic\"\nobject.  However, deletion of the dynamic object may cause\n~py_varobj_iter to run, which in turn uses gdbpy_enter_varobj:\n\ngdbpy_enter_varobj::gdbpy_enter_varobj (const struct varobj *var)\n: gdbpy_enter (var->root->exp->gdbarch, var->root->exp->language_defn)\n{\n}\n\nHowever, because var->root has already been destroyed, this is\ninvalid.\n\nI've added a new test case.  This doesn't reliably crash, but the\nproblem can easily be seen under valgrind (and, I presume, with ASAN,\nthough I did not try this).\n\nTested on x86-64 Fedora 32.  I also propose putting this on the GDB 11\nbranch, with a suitable ChangeLog entry of course.\n\nBug: https://sourceware.org/bugzilla/show_bug.cgi?id=28131",
    "tree": {
      "sha": "71adad0241d4be3751c09966b5f95dda68137c1c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/71adad0241d4be3751c09966b5f95dda68137c1c"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4d0754c5f572b01cf2fe6c8ab292adba83331cbc/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "c894449a790e00cf6fcc079a1efce88437472aaf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c894449a790e00cf6fcc079a1efce88437472aaf",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/c894449a790e00cf6fcc079a1efce88437472aaf"
    }
  ],
  "stats": {
    "total": 18,
    "additions": 16,
    "deletions": 2
  },
  "files": [
    {
      "sha": "4328c599321f01d81cf05d6b26ba74bdabd1f3fe",
      "filename": "gdb/testsuite/gdb.python/py-mi-var-info-path-expression.exp",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4d0754c5f572b01cf2fe6c8ab292adba83331cbc/gdb/testsuite/gdb.python/py-mi-var-info-path-expression.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4d0754c5f572b01cf2fe6c8ab292adba83331cbc/gdb/testsuite/gdb.python/py-mi-var-info-path-expression.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.python/py-mi-var-info-path-expression.exp?ref=4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
      "patch": "@@ -85,3 +85,15 @@ mi_gdb_test \"-var-list-children c1.car.atom\" \\\n mi_gdb_test \"-var-info-path-expression c1.car.atom.ival\" \\\n   \"\\\\^error,msg=\\\".*\\\"\" \\\n   \"-var-info-path-expression c1.car.atom.ival\"\n+\n+\n+# Regression test for a crasher that would occur when deleting a\n+# varobj that held an iterator that hadn't yet been completed.\n+# See PR varobj/28131.\n+mi_gdb_test \"-var-create c1_again * &c1\" \\\n+   \"\\\\^done.*\" \\\n+   \"-var-create c1_again * &c1\"\n+mi_gdb_test \"-var-list-children c1_again 0 1\" \\\n+  \"\\\\^done,numchild=\\\"1\\\",children=.child=\\{name=\\\"c1_again.car\\\".*\" \\\n+  \"-var-list-children c1_again\"\n+mi_delete_varobj c1_again \"delete c1_again\""
    },
    {
      "sha": "d0c857a69060644b225f3072b96c90a44b6d1548",
      "filename": "gdb/varobj.c",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4d0754c5f572b01cf2fe6c8ab292adba83331cbc/gdb/varobj.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4d0754c5f572b01cf2fe6c8ab292adba83331cbc/gdb/varobj.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/varobj.c?ref=4d0754c5f572b01cf2fe6c8ab292adba83331cbc",
      "patch": "@@ -1844,10 +1844,12 @@ varobj::~varobj ()\n     }\n #endif\n \n+  /* This must be deleted before the root object, because Python-based\n+     destructors need access to some components.  */\n+  delete var->dynamic;\n+\n   if (is_root_p (var))\n     delete var->root;\n-\n-  delete var->dynamic;\n }\n \n /* Return the type of the value that's stored in VAR,"
    }
  ]
}