{
  "sha": "3417bfca676ff0b440f070a09837813e99b2c731",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzQxN2JmY2E2NzZmZjBiNDQwZjA3MGEwOTgzNzgxM2U5OWIyYzczMQ==",
  "commit": {
    "author": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2021-08-09T16:23:22Z"
    },
    "committer": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2021-08-09T16:23:22Z"
    },
    "message": "GAS: DWARF-5: Ensure that the 0'th entry in the directory table contains the current working directory.\n\n\t* dwarf2dbg.c (get_directory_table_entry): Ensure that dir[0]\n\tcontains current working directory.\n\t(out_dir_and_file_list): Likewise.\n\t* testsuite/gas/elf/dwarf-5-dir0.s: New test source file.\n\t* testsuite/gas/elf/dwarf-5-dir0.d: New test driver.\n\t* testsuite/gas/elf/elf.exp: Run the new test.\n\t* testsuite/gas/elf/dwarf-5-file0.d: Adjust expected output.\n\t* testsuite/gas/i386/dwarf5-line-1.d: Likewise.\n\t* testsuite/gas/i386/dwarf5-line-2.d: Likewise.",
    "tree": {
      "sha": "29729580690004b3d2460b7b4635ece1028aba15",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/29729580690004b3d2460b7b4635ece1028aba15"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/3417bfca676ff0b440f070a09837813e99b2c731",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3417bfca676ff0b440f070a09837813e99b2c731",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/3417bfca676ff0b440f070a09837813e99b2c731",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3417bfca676ff0b440f070a09837813e99b2c731/comments",
  "author": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "b18bfc0946d2cfba76c0a56852bcf1c7a42f4868",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b18bfc0946d2cfba76c0a56852bcf1c7a42f4868",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/b18bfc0946d2cfba76c0a56852bcf1c7a42f4868"
    }
  ],
  "stats": {
    "total": 109,
    "additions": 91,
    "deletions": 18
  },
  "files": [
    {
      "sha": "4fcb5acaf3ae09bdaeca6776527da9f9b4cc6f93",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -1,3 +1,15 @@\n+2021-08-09  Nick Clifton  <nickc@redhat.com>\n+\n+\t* dwarf2dbg.c (get_directory_table_entry): Ensure that dir[0]\n+\tcontains current working directory.\n+\t(out_dir_and_file_list): Likewise.\n+\t* testsuite/gas/elf/dwarf-5-dir0.s: New test source file.\n+\t* testsuite/gas/elf/dwarf-5-dir0.d: New test driver.\n+\t* testsuite/gas/elf/elf.exp: Run the new test.\n+\t* testsuite/gas/elf/dwarf-5-file0.d: Adjust expected output.\n+\t* testsuite/gas/i386/dwarf5-line-1.d: Likewise.\n+\t* testsuite/gas/i386/dwarf5-line-2.d: Likewise.\n+\n 2021-07-14  Alan Modra  <amodra@gmail.com>\n \n \t* write.c (TC_VALIDATE_FIX_SUB): Default to 0."
    },
    {
      "sha": "8f5248534ad68019dee87d230a33589d5ce917eb",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 29,
      "deletions": 9,
      "changes": 38,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -620,16 +620,31 @@ get_directory_table_entry (const char *dirname,\n   if (can_use_zero)\n     {\n       if (dirs == NULL || dirs[0] == NULL)\n-\td = 0;\n+\t{\n+\t  const char * pwd = getpwd ();\n+\n+\t  if (dwarf_level >= 5 && strcmp (dirname, pwd) != 0)\n+\t    {\n+\t      /* In DWARF-5 the 0 entry in the directory table is expected to be\n+\t\t the same as the DW_AT_comp_dir (which is set to the current build\n+\t\t directory).  Since we are about to create a directory entry that\n+\t\t is not the same, allocate the current directory first.\n+\t\t FIXME: Alternatively we could generate an error message here.  */\n+\t      (void) get_directory_table_entry (pwd, strlen (pwd), true);\n+\t      d = 1;\n+\t    }\n+\t  else\n+\t    d = 0;\n+\t}\n     }\n   else if (d == 0)\n     d = 1;\n \n   if (d >= dirs_allocated)\n     {\n       unsigned int old = dirs_allocated;\n-\n-      dirs_allocated = d + 32;\n+#define DIR_TABLE_INCREMENT 32\n+      dirs_allocated = d + DIR_TABLE_INCREMENT;\n       dirs = XRESIZEVEC (char *, dirs, dirs_allocated);\n       memset (dirs + old, 0, (dirs_allocated - old) * sizeof (char *));\n     }\n@@ -779,7 +794,7 @@ allocate_filename_to_slot (const char *dirname,\n \t    {\n \t      if (dirs == NULL)\n \t\t{\n-\t\t  dirs_allocated = files[num].dir + 32;\n+\t\t  dirs_allocated = files[num].dir + DIR_TABLE_INCREMENT;\n \t\t  dirs = XCNEWVEC (char *, dirs_allocated);\n \t\t}\n \t      \n@@ -807,7 +822,7 @@ allocate_filename_to_slot (const char *dirname,\n \t\t{\n \t\t  if (dirs == NULL)\n \t\t    {\n-\t\t      dirs_allocated = files[num].dir + 32;\n+\t\t      dirs_allocated = files[num].dir + DIR_TABLE_INCREMENT;\n \t\t      dirs = XCNEWVEC (char *, dirs_allocated);\n \t\t    }\n \n@@ -840,7 +855,7 @@ allocate_filename_to_slot (const char *dirname,\n       dirlen = strlen (dirname);\n       file = filename;\n     }\n-  \n+\n   d = get_directory_table_entry (dirname, dirlen, num == 0);\n   i = num;\n \n@@ -2082,7 +2097,12 @@ out_dir_and_file_list (segT line_seg, int sizeof_offset)\n \t Otherwise use pwd as main file directory.  */\n       if (dirs_in_use > 0 && dirs != NULL && dirs[0] != NULL)\n \tdir = remap_debug_filename (dirs[0]);\n-      else if (dirs_in_use > 1 && dirs != NULL && dirs[1] != NULL)\n+      else if (dirs_in_use > 1\n+\t       && dirs != NULL\n+\t       && dirs[1] != NULL\n+\t       /* DWARF-5 directory tables expect dir[0] to be the same as\n+\t\t  DW_AT_comp_dir, which is the same as pwd.  */\n+\t       && dwarf_level < 5)\n \tdir = remap_debug_filename (dirs[1]);\n       else\n \tdir = remap_debug_filename (getpwd ());\n@@ -2185,8 +2205,8 @@ out_dir_and_file_list (segT line_seg, int sizeof_offset)\n \t     uses slot zero, but that is only set explicitly using a\n \t     .file 0 directive.  If that isn't used, but file 1 is,\n \t     then use that as main file name.  */\n-\t  if (DWARF2_LINE_VERSION >= 5 && i == 0 && files_in_use >= 1)\n-\t      files[0].filename = files[1].filename;\n+\t  if (DWARF2_LINE_VERSION >= 5 && i == 0 && files_in_use >= 1 && files[0].filename == NULL)\n+\t    files[0].filename = files[1].filename;\n \t  else\n \t    files[i].filename = \"\";\n \t  if (DWARF2_LINE_VERSION < 5 || i != 0)"
    },
    {
      "sha": "7a8361ea5d2a279189e4fef3cc1eb43349a9b093",
      "filename": "gas/testsuite/gas/elf/dwarf-5-dir0.d",
      "status": "added",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-dir0.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-dir0.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-dir0.d?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -0,0 +1,20 @@\n+#as: --gdwarf-5\n+#name: DWARF5 dir[0]\n+#readelf: -wl\n+\n+#...\n+ The Directory Table \\(offset 0x.*, lines 4, columns 1\\):\n+  Entry\tName\n+  0\t\\(indirect line string, offset: 0x0\\): .*/gas/testsuite\n+  1\t\\(indirect line string, offset: 0x.*\\): ../not-the-build-directory\n+  2\t\\(indirect line string, offset: 0x.*\\): secondary directory\n+  3\t\\(indirect line string, offset: 0x.*\\): /tmp\n+\n+ The File Name Table \\(offset 0x.*, lines 3, columns 3\\):\n+  Entry\tDir\tMD5\t\t\t\tName\n+  0\t1 0x0\t\\(indirect line string, offset: 0x.*\\): master-source-file.c\n+  1\t2 0x0\t\\(indirect line string, offset: 0x.*\\): secondary source file\n+  2\t3 0x95828e8bc4f7404dbf7526fb7bd0f192\t\\(indirect line string, offset: 0x.*\\): foo.c\n+#pass\n+\n+"
    },
    {
      "sha": "50f522f32a522f993c4759b14a70a906a71f1e70",
      "filename": "gas/testsuite/gas/elf/dwarf-5-dir0.s",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-dir0.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-dir0.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-dir0.s?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -0,0 +1,19 @@\n+\t.section\t.debug_info,\"\",%progbits\n+\t.4byte\t0x8a\n+\t.2byte  0x2\n+\t.4byte\t.Ldebug_abbrev0\n+\t.byte\t0x4\n+\t.uleb128 0x1\n+\n+\t.file 0 \"../not-the-build-directory/master-source-file.c\"\n+\t.line 1\n+\t.text\n+\t.octa 0x12345678901234567890123456789012\n+\n+\t.file 1 \"secondary directory/secondary source file\"\n+\t.line 2\n+\t.word 2\n+\n+\t.file 2 \"/tmp\" \"foo.c\" md5 0x95828e8bc4f7404dbf7526fb7bd0f192\n+\t.line 5\n+\t.word 6"
    },
    {
      "sha": "f60411c803485c4788fe099ceda8d581427b53ec",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0.d",
      "status": "modified",
      "additions": 8,
      "deletions": 7,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0.d?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -3,17 +3,18 @@\n #readelf: -wl\n \n #...\n- The Directory Table \\(offset 0x.*, lines 3, columns 1\\):\n+ The Directory Table \\(offset 0x.*, lines 4, columns 1\\):\n   Entry\tName\n-  0\t\\(indirect line string, offset: 0x.*\\): master directory\n-  1\t\\(indirect line string, offset: 0x.*\\): secondary directory\n-  2\t\\(indirect line string, offset: 0x.*\\): /tmp\n+#...\n+  1\t\\(indirect line string, offset: 0x.*\\): master directory\n+  2\t\\(indirect line string, offset: 0x.*\\): secondary directory\n+  3\t\\(indirect line string, offset: 0x.*\\): /tmp\n \n  The File Name Table \\(offset 0x.*, lines 3, columns 3\\):\n   Entry\tDir\tMD5\t\t\t\tName\n-  0\t0 0x0\t\\(indirect line string, offset: 0x.*\\): master source file\n-  1\t1 0x0\t\\(indirect line string, offset: 0x.*\\): secondary source file\n-  2\t2 0x95828e8bc4f7404dbf7526fb7bd0f192\t\\(indirect line string, offset: 0x.*\\): foo.c\n+  0\t1 0x0\t\\(indirect line string, offset: 0x.*\\): master source file\n+  1\t2 0x0\t\\(indirect line string, offset: 0x.*\\): secondary source file\n+  2\t3 0x95828e8bc4f7404dbf7526fb7bd0f192\t\\(indirect line string, offset: 0x.*\\): foo.c\n #pass\n \n "
    },
    {
      "sha": "18bc1db8c703a76031aa4028765b613b5f3414fe",
      "filename": "gas/testsuite/gas/elf/elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/elf/elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/elf.exp?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -297,6 +297,7 @@ if { [is_elf_format] } then {\n     run_dump_test \"dwarf2-19\" $dump_opts\n     run_dump_test \"dwarf2-20\" $dump_opts\n     run_dump_test \"dwarf-5-file0\" $dump_opts\n+    run_dump_test \"dwarf-5-dir0\" $dump_opts\n     run_dump_test \"dwarf-4-cu\" $dump_opts\n     run_dump_test \"dwarf-5-cu\" $dump_opts\n     run_dump_test \"dwarf-5-nop-for-line-table\" $dump_opts"
    },
    {
      "sha": "f57fc47d26901c2dc2628b3f17f4c80fd6202211",
      "filename": "gas/testsuite/gas/i386/dwarf5-line-1.d",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/i386/dwarf5-line-1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/i386/dwarf5-line-1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf5-line-1.d?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -33,7 +33,7 @@ Raw dump of debug contents of section \\.z?debug_line:\n \n  The Directory Table \\(offset 0x.*, lines 2, columns 1\\):\n   Entry\tName\n-  0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n+  0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite\n   1\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n \n  The File Name Table \\(offset 0x.*, lines 2, columns 3\\):"
    },
    {
      "sha": "2f96df510d04a2ee733f0e990af8bc82119ae76e",
      "filename": "gas/testsuite/gas/i386/dwarf5-line-2.d",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/i386/dwarf5-line-2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3417bfca676ff0b440f070a09837813e99b2c731/gas/testsuite/gas/i386/dwarf5-line-2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf5-line-2.d?ref=3417bfca676ff0b440f070a09837813e99b2c731",
      "patch": "@@ -33,7 +33,7 @@ Raw dump of debug contents of section \\.z?debug_line:\n \n  The Directory Table \\(offset 0x.*, lines 2, columns 1\\):\n   Entry\tName\n-  0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n+  0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite\n   1\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n \n  The File Name Table \\(offset 0x.*, lines 1, columns 3\\):"
    }
  ]
}