{
  "sha": "b4e3cd0440109d0a5552d3313ccbd35c8103335b",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YjRlM2NkMDQ0MDEwOWQwYTU1NTJkMzMxM2NjYmQzNWM4MTAzMzM1Yg==",
  "commit": {
    "author": {
      "name": "Anton Kolesov",
      "email": "Anton.Kolesov@synopsys.com",
      "date": "2016-08-22T16:39:46Z"
    },
    "committer": {
      "name": "Shahab Vahedi",
      "email": "shahab@synopsys.com",
      "date": "2020-12-22T11:04:31Z"
    },
    "message": "arc: Add support for signal handlers\n\nThis patch adds the necessary infrastructure to handle signal frames for\nARC architecture.  It is fairly similar to what any other architecture\nwould have.  Linux specific parts will be in a separate patch.\n\nv2 [1]:\n- Make the logic of \"arc_sigtramp_frame_sniffer ()\" simpler.\n\n[1] Tom's remark for the first version\nhttps://sourceware.org/pipermail/gdb-patches/2020-November/173221.html\n\ngdb/ChangeLog:\n\n\t* arc-tdep.c (arc_make_sigtramp_frame_cache): New function.\n\t(arc_sigtramp_frame_this_id): Likewise.\n\t(arc_sigtramp_frame_prev_register): Likewise.\n\t(arc_sigtramp_frame_sniffer): Likewise.\n\t(arc_siftramp_frame_unwind): New global variable.\n\t(arc_gdbarch_init): Use sigtramp capabilities.\n\t(arc_dump_tdep): Print sigtramp fields.\n\t* arc-tdep.h (gdbarch_tdep): Add sigtramp fields.",
    "tree": {
      "sha": "3db267f0f65f031b5912f6814bc7741758056024",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3db267f0f65f031b5912f6814bc7741758056024"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b4e3cd0440109d0a5552d3313ccbd35c8103335b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b4e3cd0440109d0a5552d3313ccbd35c8103335b",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b4e3cd0440109d0a5552d3313ccbd35c8103335b",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b4e3cd0440109d0a5552d3313ccbd35c8103335b/comments",
  "author": {
    "login": "anthony-kolesov",
    "id": 602123,
    "node_id": "MDQ6VXNlcjYwMjEyMw==",
    "avatar_url": "https://avatars.githubusercontent.com/u/602123?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/anthony-kolesov",
    "html_url": "https://github.com/anthony-kolesov",
    "followers_url": "https://api.github.com/users/anthony-kolesov/followers",
    "following_url": "https://api.github.com/users/anthony-kolesov/following{/other_user}",
    "gists_url": "https://api.github.com/users/anthony-kolesov/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/anthony-kolesov/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/anthony-kolesov/subscriptions",
    "organizations_url": "https://api.github.com/users/anthony-kolesov/orgs",
    "repos_url": "https://api.github.com/users/anthony-kolesov/repos",
    "events_url": "https://api.github.com/users/anthony-kolesov/events{/privacy}",
    "received_events_url": "https://api.github.com/users/anthony-kolesov/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": null,
  "parents": [
    {
      "sha": "6bf6909bf4987cb8b44e3c27e377c377294f0f19",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6bf6909bf4987cb8b44e3c27e377c377294f0f19",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/6bf6909bf4987cb8b44e3c27e377c377294f0f19"
    }
  ],
  "stats": {
    "total": 147,
    "additions": 147,
    "deletions": 0
  },
  "files": [
    {
      "sha": "ba574d7fd8b1d1ffd99749cca804cc71c65fd353",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=b4e3cd0440109d0a5552d3313ccbd35c8103335b",
      "patch": "@@ -1,3 +1,14 @@\n+2020-12-22  Anton Kolesov  <anton.kolesov@synopsys.com>\n+\n+\t* arc-tdep.c (arc_make_sigtramp_frame_cache): New function.\n+\t(arc_sigtramp_frame_this_id): Likewise.\n+\t(arc_sigtramp_frame_prev_register): Likewise.\n+\t(arc_sigtramp_frame_sniffer): Likewise.\n+\t(arc_siftramp_frame_unwind): New global variable.\n+\t(arc_gdbarch_init): Use sigtramp capabilities.\n+\t(arc_dump_tdep): Print sigtramp fields.\n+\t* arc-tdep.h (gdbarch_tdep): Add sigtramp fields.\n+\n 2020-12-21  Tom Tromey  <tom@tromey.com>\n \n \t* expression.h (enum noside): Move earlier."
    },
    {
      "sha": "846cc80541641ec73a6aa2ea8b5e0572e2c60ba0",
      "filename": "gdb/arc-tdep.c",
      "status": "modified",
      "additions": 123,
      "deletions": 0,
      "changes": 123,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/arc-tdep.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/arc-tdep.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/arc-tdep.c?ref=b4e3cd0440109d0a5552d3313ccbd35c8103335b",
      "patch": "@@ -1844,6 +1844,104 @@ arc_dwarf2_frame_init_reg (struct gdbarch *gdbarch, int regnum,\n     reg->how = DWARF2_FRAME_REG_CFA;\n }\n \n+/*  Signal trampoline frame unwinder.  Allows frame unwinding to happen\n+    from within signal handlers.  */\n+\n+static struct arc_frame_cache *\n+arc_make_sigtramp_frame_cache (struct frame_info *this_frame)\n+{\n+  if (arc_debug)\n+    debug_printf (\"arc: sigtramp_frame_cache\\n\");\n+\n+  struct gdbarch_tdep *tdep = gdbarch_tdep (get_frame_arch (this_frame));\n+\n+  /* Allocate new frame cache instance and space for saved register info.  */\n+  struct arc_frame_cache *cache = FRAME_OBSTACK_ZALLOC (struct arc_frame_cache);\n+  cache->saved_regs = trad_frame_alloc_saved_regs (this_frame);\n+\n+  /* Get the stack pointer and use it as the frame base.  */\n+  cache->prev_sp = arc_frame_base_address (this_frame, NULL);\n+\n+  /* If the ARC-private target-dependent info doesn't have a table of\n+     offsets of saved register contents within an OS signal context\n+     structure, then there is nothing to analyze.  */\n+  if (tdep->sc_reg_offset == NULL)\n+    return cache;\n+\n+  /* Find the address of the sigcontext structure.  */\n+  CORE_ADDR addr = tdep->sigcontext_addr (this_frame);\n+\n+  /* For each register, if its contents have been saved within the\n+     sigcontext structure, determine the address of those contents.  */\n+  gdb_assert (tdep->sc_num_regs <= (ARC_LAST_REGNUM + 1));\n+  for (int i = 0; i < tdep->sc_num_regs; i++)\n+    {\n+      if (tdep->sc_reg_offset[i] != ARC_OFFSET_NO_REGISTER)\n+\tcache->saved_regs[i].addr = addr + tdep->sc_reg_offset[i];\n+    }\n+\n+  return cache;\n+}\n+\n+/* Implement the \"this_id\" frame_unwind method for signal trampoline\n+   frames.  */\n+\n+static void\n+arc_sigtramp_frame_this_id (struct frame_info *this_frame,\n+\t\t\t    void **this_cache, struct frame_id *this_id)\n+{\n+  if (arc_debug)\n+    debug_printf (\"arc: sigtramp_frame_this_id\\n\");\n+\n+  if (*this_cache == NULL)\n+    *this_cache = arc_make_sigtramp_frame_cache (this_frame);\n+\n+  struct gdbarch *gdbarch = get_frame_arch (this_frame);\n+  struct arc_frame_cache *cache = (struct arc_frame_cache *) *this_cache;\n+  CORE_ADDR stack_addr = cache->prev_sp;\n+  CORE_ADDR code_addr\n+    = get_frame_register_unsigned (this_frame, gdbarch_pc_regnum (gdbarch));\n+  *this_id = frame_id_build (stack_addr, code_addr);\n+}\n+\n+/* Get a register from a signal handler frame.  */\n+\n+static struct value *\n+arc_sigtramp_frame_prev_register (struct frame_info *this_frame,\n+\t\t\t\t  void **this_cache, int regnum)\n+{\n+  if (arc_debug)\n+    debug_printf (\"arc: sigtramp_frame_prev_register (regnum = %d)\\n\", regnum);\n+\n+  /* Make sure we've initialized the cache.  */\n+  if (*this_cache == NULL)\n+    *this_cache = arc_make_sigtramp_frame_cache (this_frame);\n+\n+  struct arc_frame_cache *cache = (struct arc_frame_cache *) *this_cache;\n+  return trad_frame_get_prev_register (this_frame, cache->saved_regs, regnum);\n+}\n+\n+/* Frame sniffer for signal handler frame.  Only recognize a frame if we\n+   have a sigcontext_addr handler in the target dependency.  */\n+\n+static int\n+arc_sigtramp_frame_sniffer (const struct frame_unwind *self,\n+\t\t\t    struct frame_info *this_frame,\n+\t\t\t    void **this_cache)\n+{\n+  struct gdbarch_tdep *tdep;\n+\n+  if (arc_debug)\n+    debug_printf (\"arc: sigtramp_frame_sniffer\\n\");\n+\n+  tdep = gdbarch_tdep (get_frame_arch (this_frame));\n+\n+  /* If we have a sigcontext_addr handler, then just return 1 (same as the\n+     \"default_frame_sniffer ()\").  */\n+  return (tdep->sigcontext_addr != NULL && tdep->is_sigtramp != NULL\n+\t  && tdep->is_sigtramp (this_frame));\n+}\n+\n /* Structure defining the ARC ordinary frame unwind functions.  Since we are\n    the fallback unwinder, we use the default frame sniffer, which always\n    accepts the frame.  */\n@@ -1859,6 +1957,21 @@ static const struct frame_unwind arc_frame_unwind = {\n   NULL\n };\n \n+/* Structure defining the ARC signal frame unwind functions.  Custom\n+   sniffer is used, because this frame must be accepted only in the right\n+   context.  */\n+\n+static const struct frame_unwind arc_sigtramp_frame_unwind = {\n+  SIGTRAMP_FRAME,\n+  default_frame_unwind_stop_reason,\n+  arc_sigtramp_frame_this_id,\n+  arc_sigtramp_frame_prev_register,\n+  NULL,\n+  arc_sigtramp_frame_sniffer,\n+  NULL,\n+  NULL\n+};\n+\n \n static const struct frame_base arc_normal_base = {\n   &arc_frame_unwind,\n@@ -2272,6 +2385,7 @@ arc_gdbarch_init (struct gdbarch_info info, struct gdbarch_list *arches)\n   /* Frame unwinders and sniffers.  */\n   dwarf2_frame_set_init_reg (gdbarch, arc_dwarf2_frame_init_reg);\n   dwarf2_append_unwinders (gdbarch);\n+  frame_unwind_append_unwinder (gdbarch, &arc_sigtramp_frame_unwind);\n   frame_unwind_append_unwinder (gdbarch, &arc_frame_unwind);\n   frame_base_set_default (gdbarch, &arc_normal_base);\n \n@@ -2350,6 +2464,15 @@ arc_dump_tdep (struct gdbarch *gdbarch, struct ui_file *file)\n   struct gdbarch_tdep *tdep = gdbarch_tdep (gdbarch);\n \n   fprintf_unfiltered (file, \"arc_dump_tdep: jb_pc = %i\\n\", tdep->jb_pc);\n+\n+  fprintf_unfiltered (file, \"arc_dump_tdep: is_sigtramp = <%s>\\n\",\n+\t\t      host_address_to_string (tdep->is_sigtramp));\n+  fprintf_unfiltered (file, \"arc_dump_tdep: sigcontext_addr = <%s>\\n\",\n+\t\t      host_address_to_string (tdep->sigcontext_addr));\n+  fprintf_unfiltered (file, \"arc_dump_tdep: sc_reg_offset = <%s>\\n\",\n+\t\t      host_address_to_string (tdep->sc_reg_offset));\n+  fprintf_unfiltered (file, \"arc_dump_tdep: sc_num_regs = %d\\n\",\n+\t\t      tdep->sc_num_regs);\n }\n \n /* This command accepts single argument - address of instruction to"
    },
    {
      "sha": "5ee5cf85c6cd1c74d3a1cc27c86ee06fececbfd6",
      "filename": "gdb/arc-tdep.h",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/arc-tdep.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b4e3cd0440109d0a5552d3313ccbd35c8103335b/gdb/arc-tdep.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/arc-tdep.h?ref=b4e3cd0440109d0a5552d3313ccbd35c8103335b",
      "patch": "@@ -124,6 +124,19 @@ struct gdbarch_tdep\n \n   /* Whether target has hardware (aka zero-delay) loops.  */\n   bool has_hw_loops;\n+\n+  /* Detect sigtramp.  */\n+  bool (*is_sigtramp) (struct frame_info *);\n+\n+  /* Get address of sigcontext for sigtramp.  */\n+  CORE_ADDR (*sigcontext_addr) (struct frame_info *);\n+\n+  /* Offset of registers in `struct sigcontext'.  */\n+  const int *sc_reg_offset;\n+\n+  /* Number of registers in sc_reg_offsets.  Most likely a ARC_LAST_REGNUM,\n+     but in theory it could be less, so it is kept separate.  */\n+  int sc_num_regs;\n };\n \n /* Utility functions used by other ARC-specific modules.  */"
    }
  ]
}