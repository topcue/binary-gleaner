{
  "sha": "e3319240732bc9543af8ced9d80ec89d0b629b2e",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZTMzMTkyNDA3MzJiYzk1NDNhZjhjZWQ5ZDgwZWM4OWQwYjYyOWIyZQ==",
  "commit": {
    "author": {
      "name": "Philippe Waroquiers",
      "email": "philippe.waroquiers@skynet.be",
      "date": "2019-01-01T19:54:52Z"
    },
    "committer": {
      "name": "Philippe Waroquiers",
      "email": "philippe.waroquiers@skynet.be",
      "date": "2019-01-02T21:10:39Z"
    },
    "message": "Fix leak of struct call_thread_fsm in call_function_by_hand_dummy.\n\nWhen the call does not complete, the call_thread_fsm allocated\nby new_call_thread_fsm is not cleaned up and deleted, which causes\nthe following leak e.g. in gdb.base/callfuncs.exp:\n\n==29263== 560 bytes in 7 blocks are definitely lost in loss record 2,833 of 3,341\n==29263==    at 0x4C2E0BC: calloc (vg_replace_malloc.c:762)\n==29263==    by 0x405110: xcalloc (common-utils.c:84)\n==29263==    by 0x4E67EB: xcnew<call_thread_fsm> (poison.h:122)\n==29263==    by 0x4E67EB: new_call_thread_fsm (infcall.c:516)\n==29263==    by 0x4E67EB: call_function_by_hand_dummy(value*, type*, gdb::array_view<value*>, void (*)(void*, int), void*) (infcall.c:1154)\n==29263==    by 0x4E784E: call_function_by_hand(value*, type*, gdb::array_view<value*>) (infcall.c:693)\n==29263==    by 0x496111: eval_call(expression*, noside, int, value**, char const*, type*) [clone .isra.5] (eval.c:835)\n\nFix the leak by similarly doing cleanup/destroy when restoring\nprevious state machine.\n\nTested on debian/amd64, natively and under valgrind.\n\n2019-01-02  Philippe Waroquiers  <philippe.waroquiers@skynet.be>\n\n\t* infcall.c (call_function_by_hand_dummy): cleanup/destroy sm\n\t in case of call that did not complete.",
    "tree": {
      "sha": "32a5d194bf7a25ee10727823865140809a46c03a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/32a5d194bf7a25ee10727823865140809a46c03a"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/e3319240732bc9543af8ced9d80ec89d0b629b2e",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e3319240732bc9543af8ced9d80ec89d0b629b2e",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/e3319240732bc9543af8ced9d80ec89d0b629b2e",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e3319240732bc9543af8ced9d80ec89d0b629b2e/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "5d36dfb949751663bcb814b3cc780ed8f47442b4",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5d36dfb949751663bcb814b3cc780ed8f47442b4",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/5d36dfb949751663bcb814b3cc780ed8f47442b4"
    }
  ],
  "stats": {
    "total": 11,
    "additions": 9,
    "deletions": 2
  },
  "files": [
    {
      "sha": "41889ba92ec038606f142aef0b6f5d3e849c4687",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3319240732bc9543af8ced9d80ec89d0b629b2e/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3319240732bc9543af8ced9d80ec89d0b629b2e/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=e3319240732bc9543af8ced9d80ec89d0b629b2e",
      "patch": "@@ -1,3 +1,8 @@\n+2019-01-02  Philippe Waroquiers  <philippe.waroquiers@skynet.be>\n+\n+\t* infcall.c (call_function_by_hand_dummy): cleanup/destroy sm\n+\t in case of call that did not complete.\n+\n 2019-01-02  Andrey Utkin  <autkin@undo.io>\n \n \t* symfile.c (find_separate_debug_file): Fix search of debug files for"
    },
    {
      "sha": "14b0cbc716907ac790fd9c4fee89172fa2a33020",
      "filename": "gdb/infcall.c",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3319240732bc9543af8ced9d80ec89d0b629b2e/gdb/infcall.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3319240732bc9543af8ced9d80ec89d0b629b2e/gdb/infcall.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/infcall.c?ref=e3319240732bc9543af8ced9d80ec89d0b629b2e",
      "patch": "@@ -1189,8 +1189,10 @@ call_function_by_hand_dummy (struct value *function,\n \t    return retval;\n \t  }\n \n-\t/* Didn't complete.  Restore previous state machine, and\n-\t   handle the error.  */\n+\t/* Didn't complete.  Clean up / destroy the call FSM, and restore the\n+\t   previous state machine, and handle the error.  */\n+\tthread_fsm_clean_up (call_thread->thread_fsm, call_thread.get ());\n+\tthread_fsm_delete (call_thread->thread_fsm);\n \tcall_thread->thread_fsm = saved_sm;\n       }\n   }"
    }
  ]
}