{
  "sha": "3be966f69d6967d2857baa3efb0bc043081e0a00",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6M2JlOTY2ZjY5ZDY5NjdkMjg1N2JhYTNlZmIwYmMwNDMwODFlMGEwMA==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2020-01-09T22:38:22Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2020-01-09T22:55:05Z"
    },
    "message": "gdb/testsuite: Fix race condition in gdb.base/skip.exp\n\nIn this commit:\n\n  commit 5024637fac653914d471808288dc3221bc7ec089\n  Date:   Sun Dec 15 11:05:47 2019 +0100\n\n      Fix skip.exp test failure observed with gcc-9.2.0\n\nA race condition was introduced into the gdb.base/skip.exp test when\nthis line:\n\n    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\"\n\nWas changed to this:\n\n    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \"main \\\\(\\\\) at .*\" \"step\"\n\nBefore the above change we expected GDB to behave like this:\n\n  (gdb) step\n  foo () at /path/to/gdb/testsuite/gdb.base/skip.c:42\n  42        return 0;\n  (gdb)\n\nHowever, when the test is compiled with GCC 9.2.0 we get a different\nbehaviour, and so we need a second 'step', like this:\n\n  (gdb) step\n  main () at /path/to/gdb.base/skip.c:32\n  32        x = baz ((bar (), foo ()));\n  (gdb) step\n  foo () at /path/to/gdb/testsuite/gdb.base/skip.c:42\n  42        return 0;\n  (gdb)\n\nNow the change to the test matches against 'main () at .*', however if\nGDB or expect is being slow then we might only get to see output like\nthis:\n\n  (gdb) step\n  main () at /path/to/g\n\nThis will happily match the question pattern, so we send 'step' to GDB\nagain.  Now GDB continues to produce output which expect accepts, we\nnow see this:\n\n  b.base/skip.c:32\n  32        x = baz ((bar (), foo ()));\n  (gdb)\n\nThis has carried on from where the previous block of output left off.\nThis doesn't match the final pattern 'foo \\\\(\\\\) at.*', but it does\nmatch the prompt pattern that gdb_test_multiple adds, and so we report\nthe test as failing.\n\nThe solution is to simply ensure that the question consumes everything\nup to, and including the prompt.  This ensures that the prompt can't\nthen match the failure case.  The new test line becomes:\n\n    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \\\n       \"main \\\\(\\\\) at .*\\r\\n$gdb_prompt \" \"step\"\n\ngdb/testsuite/ChangeLog:\n\n\t* gdb.base/skip.exp: Fix race condition in test.\n\nChange-Id: I9f0b0b52ef1b4f980bfaa8fe405ff06d520f3482",
    "tree": {
      "sha": "bcdfe9823448a3dcdcb0ce6a3bb7c808b9dc6bbb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/bcdfe9823448a3dcdcb0ce6a3bb7c808b9dc6bbb"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/3be966f69d6967d2857baa3efb0bc043081e0a00",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3be966f69d6967d2857baa3efb0bc043081e0a00",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/3be966f69d6967d2857baa3efb0bc043081e0a00",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3be966f69d6967d2857baa3efb0bc043081e0a00/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "5f23a08201ed01570b34f5cff99a95fc7b9e2fdb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5f23a08201ed01570b34f5cff99a95fc7b9e2fdb",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/5f23a08201ed01570b34f5cff99a95fc7b9e2fdb"
    }
  ],
  "stats": {
    "total": 13,
    "additions": 10,
    "deletions": 3
  },
  "files": [
    {
      "sha": "cecd384d5da7e666cb212f987da96aa94e652377",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3be966f69d6967d2857baa3efb0bc043081e0a00/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3be966f69d6967d2857baa3efb0bc043081e0a00/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=3be966f69d6967d2857baa3efb0bc043081e0a00",
      "patch": "@@ -1,3 +1,7 @@\n+2020-01-09  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* gdb.base/skip.exp: Fix race condition in test.\n+\n 2020-01-06  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* gdb.base/backtrace.c: New file."
    },
    {
      "sha": "513c9fcc82eabca70f621c8449c2acfa0b798dc8",
      "filename": "gdb/testsuite/gdb.base/skip.exp",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3be966f69d6967d2857baa3efb0bc043081e0a00/gdb/testsuite/gdb.base/skip.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3be966f69d6967d2857baa3efb0bc043081e0a00/gdb/testsuite/gdb.base/skip.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/skip.exp?ref=3be966f69d6967d2857baa3efb0bc043081e0a00",
      "patch": "@@ -144,7 +144,8 @@ with_test_prefix \"step after disabling 3\" {\n     gdb_test \"step\" \".*\" \"step 2\"; # Return from bar()\n     # With gcc 9.2.0 we jump once back to main before entering foo here.\n     # If that happens try to step a second time.\n-    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \"main \\\\(\\\\) at .*\" \"step\"\n+    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \\\n+\t\"main \\\\(\\\\) at .*\\r\\n$gdb_prompt \" \"step\"\n     gdb_test \"step\" \".*\" \"step 4\"; # Return from foo()\n     gdb_test \"step\" \"main \\\\(\\\\) at.*\" \"step 5\"\n }\n@@ -265,7 +266,8 @@ with_test_prefix \"step using -fu for baz\" {\n     gdb_test \"step\" \".*\" \"step 2\"; # Return from bar()\n     # With gcc 9.2.0 we jump once back to main before entering foo here.\n     # If that happens try to step a second time.\n-    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \"main \\\\(\\\\) at.*\" \"step\"\n+    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \\\n+\t\"main \\\\(\\\\) at .*\\r\\n$gdb_prompt \" \"step\"\n     gdb_test \"step\" \".*\" \"step 4\"; # Return from foo()\n     gdb_test \"step\" \"main \\\\(\\\\) at.*\" \"step 5\"\n }\n@@ -282,7 +284,8 @@ with_test_prefix \"step using -rfu for baz\" {\n     gdb_test \"step\" \".*\" \"step 2\"; # Return from bar()\n     # With gcc 9.2.0 we jump once back to main before entering foo here.\n     # If that happens try to step a second time.\n-    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \"main \\\\(\\\\) at.*\" \"step\"\n+    gdb_test \"step\" \"foo \\\\(\\\\) at.*\" \"step 3\" \\\n+\t\"main \\\\(\\\\) at .*\\r\\n$gdb_prompt \" \"step\"\n     gdb_test \"step\" \".*\" \"step 4\"; # Return from foo()\n     gdb_test \"step\" \"main \\\\(\\\\) at.*\" \"step 5\"\n }"
    }
  ]
}