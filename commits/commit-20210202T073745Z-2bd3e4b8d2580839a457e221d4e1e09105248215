{
  "sha": "2bd3e4b8d2580839a457e221d4e1e09105248215",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MmJkM2U0YjhkMjU4MDgzOWE0NTdlMjIxZDRlMWUwOTEwNTI0ODIxNQ==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-02-02T07:37:45Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-02-02T07:37:45Z"
    },
    "message": "[gdb/symtab] Fix assert in write_one_signatured_type\n\nWhen running test-case gdb.dwarf2/fission-reread.exp with target board\ncc-with-gdb-index, we run into an abort during the generation of the gdb-index\nby cc-with-tweaks.sh:\n...\nbuild/gdb/testsuite/cache/gdb.sh: line 1: 27275 Aborted  (core dumped)\n...\n\nThis can be reproduced on the command line like this:\n...\n$ gdb -batch ./outputs/gdb.dwarf2/fission-reread/fission-reread \\\n  -ex 'save gdb-index  ./outputs/gdb.dwarf2/fission-reread'\nwarning: Could not find DWO TU fission-reread.dwo(0x9022f1ceac7e8b19) \\\n  referenced by TU at offset 0x0 [in module fission-reread]\nwarning: Could not find DWO CU fission-reread.dwo(0x807060504030201) \\\n  referenced by CU at offset 0x561 [in module fission-reread]\nAborted (core dumped)\n...\n\nThe abort is a segfault due to a using a nullptr psymtab in\nwrite_one_signatured_type.\n\nThe problem is that we're trying to write index entries for the type unit\nwith signature:\n...\n(gdb) p /x entry->signature\n$2 = 0x9022f1ceac7e8b19\n...\nwhich is a skeleton type unit:\n...\nContents of the .debug_types section:\n\n  Compilation Unit @ offset 0x0:\n   Length:        0x4a (32-bit)\n   Version:       4\n   Abbrev Offset: 0x165\n   Pointer Size:  4\n   Signature:     0x9022f1ceac7e8b19\n   Type Offset:   0x0\n <0><17>: Abbrev Number: 2 (DW_TAG_type_unit)\n    <18>   DW_AT_comp_dir    : /tmp/src/gdb/testsuite\n    <2f>   DW_AT_GNU_dwo_name: fission-reread.dwo\n    <42>   DW_AT_GNU_pubnames: 0x0\n    <46>   DW_AT_GNU_pubtypes: 0x0\n    <4a>   DW_AT_GNU_addr_base: 0x0\n...\nreferring to a .dwo file, but as the warnings show, the .dwo file is not\nfound.\n\nFix this by skipping the type unit in write_one_signatured_type if\npsymtab == nullptr.\n\nTested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2021-02-02  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/24620\n\t* dwarf2/index-write.c (write_one_signatured_type): Skip if\n\tpsymtab == nullptr.\n\ngdb/testsuite/ChangeLog:\n\n2021-02-02  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/24620\n\t* gdb.dwarf2/fission-reread.exp: Add test-case.",
    "tree": {
      "sha": "274eddeabac3e6421b89e998d822f08df0f7df07",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/274eddeabac3e6421b89e998d822f08df0f7df07"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/2bd3e4b8d2580839a457e221d4e1e09105248215",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2bd3e4b8d2580839a457e221d4e1e09105248215",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/2bd3e4b8d2580839a457e221d4e1e09105248215",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2bd3e4b8d2580839a457e221d4e1e09105248215/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "82e3e87da453adaf94f693d77362852e9dcc9b02",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/82e3e87da453adaf94f693d77362852e9dcc9b02",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/82e3e87da453adaf94f693d77362852e9dcc9b02"
    }
  ],
  "stats": {
    "total": 34,
    "additions": 34,
    "deletions": 0
  },
  "files": [
    {
      "sha": "0592c8643d6e88257d37b342f6a79a034cea0381",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=2bd3e4b8d2580839a457e221d4e1e09105248215",
      "patch": "@@ -1,3 +1,9 @@\n+2021-02-02  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/24620\n+\t* dwarf2/index-write.c (write_one_signatured_type): Skip if\n+\tpsymtab == nullptr.\n+\n 2021-02-01  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* Makefile.in (HFILES_NO_SRCDIR): Add corefile.h."
    },
    {
      "sha": "a7b9ae66cae26212a6f564c3659b70fa4ad37f84",
      "filename": "gdb/dwarf2/index-write.c",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/dwarf2/index-write.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/dwarf2/index-write.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/index-write.c?ref=2bd3e4b8d2580839a457e221d4e1e09105248215",
      "patch": "@@ -616,6 +616,14 @@ write_one_signatured_type (void **slot, void *d)\n   struct signatured_type *entry = (struct signatured_type *) *slot;\n   partial_symtab *psymtab = entry->per_cu.v.psymtab;\n \n+  if (psymtab == nullptr)\n+    {\n+      /* We can end up here when processing a skeleton CU referring to a\n+\t .dwo file that hasn't been found.  There's not much we can do in\n+\t such a case, so skip this CU.  */\n+      return 1;\n+    }\n+\n   write_psymbols (info->symtab, info->psyms_seen,\n \t\t  psymtab->global_psymbols, info->cu_index,\n \t\t  0);"
    },
    {
      "sha": "0f3f445b8f25ef9321a9e528bba2ed4513e6734b",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=2bd3e4b8d2580839a457e221d4e1e09105248215",
      "patch": "@@ -1,3 +1,8 @@\n+2021-02-02  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/24620\n+\t* gdb.dwarf2/fission-reread.exp: Add test-case.\n+\n 2021-02-01  Tom de Vries  <tdevries@suse.de>\n \n \t* gdb.dwarf2/fission-base.S: Pass -DDWO=$dwo."
    },
    {
      "sha": "58132794ee7a98a8bf5be16ac43126602e1f4afa",
      "filename": "gdb/testsuite/gdb.dwarf2/fission-reread.exp",
      "status": "modified",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/testsuite/gdb.dwarf2/fission-reread.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2bd3e4b8d2580839a457e221d4e1e09105248215/gdb/testsuite/gdb.dwarf2/fission-reread.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/fission-reread.exp?ref=2bd3e4b8d2580839a457e221d4e1e09105248215",
      "patch": "@@ -56,3 +56,18 @@ pass $testfile\n gdb_unload\n # If we get this far gdb didn't crash, nor did an error occur.\n pass \"$testfile - unload\"\n+\n+# Test-case for PR24620: Delete the .dwo file and verify that\n+# save gdb-index doesn't crash.\n+remote_file target delete $dwo\n+clean_restart $binfile\n+set output_dir [standard_output_file \"\"]\n+set cmd \"save gdb-index\"\n+gdb_test_multiple \"$cmd $output_dir\" $cmd {\n+    -re -wrap \"Cannot use an index to create the index.*\" {\n+\tunsupported $gdb_test_name\n+    }\n+    -re \"^$cmd \\[^\\r\\n\\]*\\r\\n$gdb_prompt $\" {\n+\tpass $gdb_test_name\n+    }\n+}"
    }
  ]
}