{
  "sha": "6f69abb0498286297936a178ba81c7e445aa4437",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NmY2OWFiYjA0OTgyODYyOTc5MzZhMTc4YmE4MWM3ZTQ0NWFhNDQzNw==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-10-26T08:08:26Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-10-26T09:49:28Z"
    },
    "message": "Optimise away eh_frame advance_loc 0\n\nThese can be generated when multiple cfi directives are emitted for an\ninstruction and the insn frag is closed off between directives, as\nhappens when listings are enabled.  No doubt the advance_loc of zero\ncould be avoided by backtracking over frags in dw2gencfi.c before\ncalling cfi_add_advance_loc, but that seems like more work than\ncleaning up afterwards as this patch does.\n\nNoticed when looking at the testcase in PR25125.\n\n\tPR 25125\n\t* dw2gencfi.c (output_cfi_insn): Don't output DW_CFA_advance_loc+0.\n\t* ehopt.c (eh_frame_estimate_size_before_relax): Return -1 for\n\tan advance_loc of zero.\n\t(eh_frame_relax_frag): Translate fr_subtype of 7 to size -1.\n\t(eh_frame_convert_frag): Handle fr_subtype of 7.  Abort on\n\tunexpected fr_subtype.",
    "tree": {
      "sha": "7a5d73d08dad01d2423566cffb48b48cda5971a1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/7a5d73d08dad01d2423566cffb48b48cda5971a1"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/6f69abb0498286297936a178ba81c7e445aa4437",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6f69abb0498286297936a178ba81c7e445aa4437",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/6f69abb0498286297936a178ba81c7e445aa4437",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/6f69abb0498286297936a178ba81c7e445aa4437/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "30baf67b6505d903bf678f9a0ba3645eb337ce49",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/30baf67b6505d903bf678f9a0ba3645eb337ce49",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/30baf67b6505d903bf678f9a0ba3645eb337ce49"
    }
  ],
  "stats": {
    "total": 32,
    "additions": 28,
    "deletions": 4
  },
  "files": [
    {
      "sha": "f900c26af450900e6c5d8361084f6064927c40d1",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f69abb0498286297936a178ba81c7e445aa4437/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f69abb0498286297936a178ba81c7e445aa4437/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=6f69abb0498286297936a178ba81c7e445aa4437",
      "patch": "@@ -1,3 +1,13 @@\n+2019-10-26  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 25125\n+\t* dw2gencfi.c (output_cfi_insn): Don't output DW_CFA_advance_loc+0.\n+\t* ehopt.c (eh_frame_estimate_size_before_relax): Return -1 for\n+\tan advance_loc of zero.\n+\t(eh_frame_relax_frag): Translate fr_subtype of 7 to size -1.\n+\t(eh_frame_convert_frag): Handle fr_subtype of 7.  Abort on\n+\tunexpected fr_subtype.\n+\n 2019-10-25  Alan Modra  <amodra@gmail.com>\n \n \tPR gas/25125"
    },
    {
      "sha": "b01e4c4a9eda2e09008bd1683c851408258c21df",
      "filename": "gas/dw2gencfi.c",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f69abb0498286297936a178ba81c7e445aa4437/gas/dw2gencfi.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f69abb0498286297936a178ba81c7e445aa4437/gas/dw2gencfi.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dw2gencfi.c?ref=6f69abb0498286297936a178ba81c7e445aa4437",
      "patch": "@@ -1598,7 +1598,9 @@ output_cfi_insn (struct cfi_insn_data *insn)\n \t    addressT delta = S_GET_VALUE (to) - S_GET_VALUE (from);\n \t    addressT scaled = delta / DWARF2_LINE_MIN_INSN_LENGTH;\n \n-\t    if (scaled <= 0x3F)\n+\t    if (scaled == 0)\n+\t      ;\n+\t    else if (scaled <= 0x3F)\n \t      out_one (DW_CFA_advance_loc + scaled);\n \t    else if (scaled <= 0xFF)\n \t      {"
    },
    {
      "sha": "bf65602f533558f070d772e5e4364da6431787b8",
      "filename": "gas/ehopt.c",
      "status": "modified",
      "additions": 15,
      "deletions": 3,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/6f69abb0498286297936a178ba81c7e445aa4437/gas/ehopt.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/6f69abb0498286297936a178ba81c7e445aa4437/gas/ehopt.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ehopt.c?ref=6f69abb0498286297936a178ba81c7e445aa4437",
      "patch": "@@ -482,7 +482,9 @@ eh_frame_estimate_size_before_relax (fragS *frag)\n \n   gas_assert (ca > 0);\n   diff /= ca;\n-  if (diff < 0x40)\n+  if (diff == 0)\n+    ret = -1;\n+  else if (diff < 0x40)\n     ret = 0;\n   else if (diff < 0x100)\n     ret = 1;\n@@ -491,7 +493,7 @@ eh_frame_estimate_size_before_relax (fragS *frag)\n   else\n     ret = 4;\n \n-  frag->fr_subtype = (frag->fr_subtype & ~7) | ret;\n+  frag->fr_subtype = (frag->fr_subtype & ~7) | (ret & 7);\n \n   return ret;\n }\n@@ -506,6 +508,8 @@ eh_frame_relax_frag (fragS *frag)\n   int oldsize, newsize;\n \n   oldsize = frag->fr_subtype & 7;\n+  if (oldsize == 7)\n+    oldsize = -1;\n   newsize = eh_frame_estimate_size_before_relax (frag);\n   return newsize - oldsize;\n }\n@@ -548,9 +552,17 @@ eh_frame_convert_frag (fragS *frag)\n       md_number_to_chars (frag->fr_literal + frag->fr_fix, diff, 2);\n       break;\n \n-    default:\n+    case 4:\n       md_number_to_chars (frag->fr_literal + frag->fr_fix, diff, 4);\n       break;\n+\n+    case 7:\n+      gas_assert (diff == 0);\n+      frag->fr_fix -= 8;\n+      break;\n+\n+    default:\n+      abort ();\n     }\n \n   frag->fr_fix += frag->fr_subtype & 7;"
    }
  ]
}