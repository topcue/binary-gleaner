{
  "sha": "d3e52e120b68bf19552743fbc078e0a759f48cb7",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZDNlNTJlMTIwYjY4YmYxOTU1Mjc0M2ZiYzA3OGUwYTc1OWY0OGNiNw==",
  "commit": {
    "author": {
      "name": "Tamar Christina",
      "email": "tamar.christina@arm.com",
      "date": "2021-05-25T15:04:04Z"
    },
    "committer": {
      "name": "Tamar Christina",
      "email": "tamar.christina@arm.com",
      "date": "2021-05-25T15:04:52Z"
    },
    "message": "Arm: Fix forward thumb references [PR gas/25235]\n\nWhen assembling a forward reference the symbol will be unknown and so during\ndo_t_adr we cannot set the thumb bit.  The bit it set so early to prevent\nrelaxations that are invalid. i.e. relaxing a Thumb2 to Thumb1 insn when the\nsymbol is Thumb.\n\nBut because it's done so early we miss the case for forward references.\nThis patch changes it so that we additionally check the thumb bit during the\ninternal relocation processing.\n\nIn principle we should be able to only set the bit during reloc processing but\nthat would require changes to the other relocations that the instruction could\nbe relaxed to.\n\nThis approach still allows early relaxations (which means that we have less\niteration of internal reloc processing) while still fixing the forward reference\ncase.\n\ngas/ChangeLog:\n\n2021-05-24  Tamar Christina  <tamar.christina@arm.com>\n\n\tPR gas/25235\n\t* config/tc-arm.c (md_convert_frag): Set LSB when Thumb symbol.\n\t(relax_adr): Thumb symbols 4 bytes.\n\t* testsuite/gas/arm/pr25235.d: New test.\n\t* testsuite/gas/arm/pr25235.s: New test.",
    "tree": {
      "sha": "eaf641175d369046e8213b1eefd887d899202950",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/eaf641175d369046e8213b1eefd887d899202950"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/d3e52e120b68bf19552743fbc078e0a759f48cb7",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d3e52e120b68bf19552743fbc078e0a759f48cb7",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/d3e52e120b68bf19552743fbc078e0a759f48cb7",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d3e52e120b68bf19552743fbc078e0a759f48cb7/comments",
  "author": {
    "login": "TamarChristinaArm",
    "id": 48126768,
    "node_id": "MDQ6VXNlcjQ4MTI2NzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/48126768?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TamarChristinaArm",
    "html_url": "https://github.com/TamarChristinaArm",
    "followers_url": "https://api.github.com/users/TamarChristinaArm/followers",
    "following_url": "https://api.github.com/users/TamarChristinaArm/following{/other_user}",
    "gists_url": "https://api.github.com/users/TamarChristinaArm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TamarChristinaArm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TamarChristinaArm/subscriptions",
    "organizations_url": "https://api.github.com/users/TamarChristinaArm/orgs",
    "repos_url": "https://api.github.com/users/TamarChristinaArm/repos",
    "events_url": "https://api.github.com/users/TamarChristinaArm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TamarChristinaArm/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "TamarChristinaArm",
    "id": 48126768,
    "node_id": "MDQ6VXNlcjQ4MTI2NzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/48126768?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TamarChristinaArm",
    "html_url": "https://github.com/TamarChristinaArm",
    "followers_url": "https://api.github.com/users/TamarChristinaArm/followers",
    "following_url": "https://api.github.com/users/TamarChristinaArm/following{/other_user}",
    "gists_url": "https://api.github.com/users/TamarChristinaArm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TamarChristinaArm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TamarChristinaArm/subscriptions",
    "organizations_url": "https://api.github.com/users/TamarChristinaArm/orgs",
    "repos_url": "https://api.github.com/users/TamarChristinaArm/repos",
    "events_url": "https://api.github.com/users/TamarChristinaArm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TamarChristinaArm/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "74fd118fb91f49377b63931d092b6d42dd8b3b3c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/74fd118fb91f49377b63931d092b6d42dd8b3b3c",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/74fd118fb91f49377b63931d092b6d42dd8b3b3c"
    }
  ],
  "stats": {
    "total": 73,
    "additions": 72,
    "deletions": 1
  },
  "files": [
    {
      "sha": "45cce1b99d046532f11871442c3143899080ba1b",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=d3e52e120b68bf19552743fbc078e0a759f48cb7",
      "patch": "@@ -1,3 +1,11 @@\n+2021-05-25  Tamar Christina  <tamar.christina@arm.com>\n+\n+\tPR gas/25235\n+\t* config/tc-arm.c (md_convert_frag): Set LSB when Thumb symbol.\n+\t(relax_adr): Thumb symbols 4 bytes.\n+\t* testsuite/gas/arm/pr25235.d: New test.\n+\t* testsuite/gas/arm/pr25235.s: New test.\n+\n 2021-05-24  Nelson Chu  <nelson.chu@sifive.com>\n \n \tPR 25212"
    },
    {
      "sha": "1e2ac65d422cb7829cde5c9f03bcc57ef297e2c5",
      "filename": "gas/config/tc-arm.c",
      "status": "modified",
      "additions": 10,
      "deletions": 1,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/config/tc-arm.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/config/tc-arm.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-arm.c?ref=d3e52e120b68bf19552743fbc078e0a759f48cb7",
      "patch": "@@ -26827,6 +26827,14 @@ md_convert_frag (bfd *abfd, segT asec ATTRIBUTE_UNUSED, fragS *fragp)\n       pc_rel = (opcode == T_MNEM_ldr_pc2);\n       break;\n     case T_MNEM_adr:\n+      /* Thumb bits should be set in the frag handling so we process them\n+\t after all symbols have been seen.  PR gas/25235.  */\n+      if (exp.X_op == O_symbol\n+\t  && exp.X_add_symbol != NULL\n+\t  && S_IS_DEFINED (exp.X_add_symbol)\n+\t  && THUMB_IS_FUNC (exp.X_add_symbol))\n+\texp.X_add_number |= 1;\n+\n       if (fragp->fr_var == 4)\n \t{\n \t  insn = THUMB_OP32 (opcode);\n@@ -27024,7 +27032,8 @@ relax_adr (fragS *fragp, asection *sec, long stretch)\n   if (fragp->fr_symbol == NULL\n       || !S_IS_DEFINED (fragp->fr_symbol)\n       || sec != S_GET_SEGMENT (fragp->fr_symbol)\n-      || S_IS_WEAK (fragp->fr_symbol))\n+      || S_IS_WEAK (fragp->fr_symbol)\n+      || THUMB_IS_FUNC (fragp->fr_symbol))\n     return 4;\n \n   val = relaxed_symbol_addr (fragp, stretch);"
    },
    {
      "sha": "126950387014335afaf4a60b6292ab64cdd303f6",
      "filename": "gas/testsuite/gas/arm/pr25235.d",
      "status": "added",
      "additions": 24,
      "deletions": 0,
      "changes": 24,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/testsuite/gas/arm/pr25235.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/testsuite/gas/arm/pr25235.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/arm/pr25235.d?ref=d3e52e120b68bf19552743fbc078e0a759f48cb7",
      "patch": "@@ -0,0 +1,24 @@\n+#skip: *-*-pe *-*-wince *-*-vxworks\n+#objdump: -dr\n+#name: PR25235: Thumb forward references error\n+\n+.*: +file format .*arm.*\n+\n+Disassembly of section .text:\n+\n+00000000 <f1>:\n+   0:\t46c0      \tnop\t\t\t; \\(mov r8, r8\\)\n+   2:\t46c0      \tnop\t\t\t; \\(mov r8, r8\\)\n+\n+00000004 <f2>:\n+   4:\tf2af 0107 \tsubw\tr1, pc, #7\n+   8:\tf20f 0305 \taddw\tr3, pc, #5\n+   c:\ta401      \tadd\tr4, pc, #4\t; \\(adr r4, 14 <f4>\\)\n+   e:\t46c0      \tnop\t\t\t; \\(mov r8, r8\\)\n+\n+00000010 <f3>:\n+  10:\t46c0      \tnop\t\t\t; \\(mov r8, r8\\)\n+  12:\t46c0      \tnop\t\t\t; \\(mov r8, r8\\)\n+\n+00000014 <f4>:\n+  14:\te1a00000 \tnop\t\t\t; \\(mov r0, r0\\)"
    },
    {
      "sha": "77637392f1c1b95e85ff2aeaf4a68507d4e466a9",
      "filename": "gas/testsuite/gas/arm/pr25235.s",
      "status": "added",
      "additions": 30,
      "deletions": 0,
      "changes": 30,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/testsuite/gas/arm/pr25235.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d3e52e120b68bf19552743fbc078e0a759f48cb7/gas/testsuite/gas/arm/pr25235.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/arm/pr25235.s?ref=d3e52e120b68bf19552743fbc078e0a759f48cb7",
      "patch": "@@ -0,0 +1,30 @@\n+    .syntax unified\n+    .thumb\n+\n+    .align 2\n+    .type f1, %function\n+    .thumb_func\n+    f1:\n+        nop\n+\n+    .align 2\n+    .type f2, %function\n+    .thumb_func\n+    f2:\n+        adr r1, f1\n+        adr r3, f3\n+        adr r4, f4\n+\n+\n+    .align 2\n+    .type f3, %function\n+    .thumb_func\n+    f3:\n+        nop\n+\n+    .align 2\n+    .type f3, %function\n+    .arm\n+    f4:\n+        nop\n+"
    }
  ]
}