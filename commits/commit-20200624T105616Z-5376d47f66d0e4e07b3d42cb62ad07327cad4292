{
  "sha": "5376d47f66d0e4e07b3d42cb62ad07327cad4292",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NTM3NmQ0N2Y2NmQwZTRlMDdiM2Q0MmNiNjJhZDA3MzI3Y2FkNDI5Mg==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-06-24T10:56:05Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-06-24T10:56:16Z"
    },
    "message": "ld: Set non_ir_ref_regular on source for assignment\n\nWe need to set non_ir_ref_regular on the source for assignment to get\nthe correct LTO resolution:\n\n190 a27be7f4ad90c5ce PREVAILING_DEF real_g\n\ninstead of\n\n190 30c3b2d8f967f5ea PREVAILING_DEF_IRONLY real_g\n\n\tPR ld/26163\n\t* ldexp.c (exp_fold_tree_1): Set non_ir_ref_regular on the source\n\tfor assignment.\n\t* testsuite/ld-plugin/lto.exp: Run ld/26163 test.\n\t* testsuite/ld-plugin/pr26163a.c: New file.\n\t* testsuite/ld-plugin/pr26163b.c: Likewise.",
    "tree": {
      "sha": "a2f4ab98b98a0cf98f62d014e7b6e7d6060fa4b6",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/a2f4ab98b98a0cf98f62d014e7b6e7d6060fa4b6"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/5376d47f66d0e4e07b3d42cb62ad07327cad4292",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5376d47f66d0e4e07b3d42cb62ad07327cad4292",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/5376d47f66d0e4e07b3d42cb62ad07327cad4292",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5376d47f66d0e4e07b3d42cb62ad07327cad4292/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a5aae5087ca50f14e361cffe155ad3886afb56cb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a5aae5087ca50f14e361cffe155ad3886afb56cb",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/a5aae5087ca50f14e361cffe155ad3886afb56cb"
    }
  ],
  "stats": {
    "total": 55,
    "additions": 52,
    "deletions": 3
  },
  "files": [
    {
      "sha": "fd0b98950e1c7193a215ebbfe0f30bd42e8092f6",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=5376d47f66d0e4e07b3d42cb62ad07327cad4292",
      "patch": "@@ -1,3 +1,12 @@\n+2020-06-24  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR ld/26163\n+\t* ldexp.c (exp_fold_tree_1): Set non_ir_ref_regular on the source\n+\tfor assignment.\n+\t* testsuite/ld-plugin/lto.exp: Run ld/26163 test.\n+\t* testsuite/ld-plugin/pr26163a.c: New file.\n+\t* testsuite/ld-plugin/pr26163b.c: Likewise.\n+\n 2020-06-24  Alan Modra  <amodra@gmail.com>\n \n \t* lexsup.c (elf_shlib_list_options): Properly format help message."
    },
    {
      "sha": "b4e7c41209dd48c82bc2476f1ffc83c3f3235586",
      "filename": "ld/ldexp.c",
      "status": "modified",
      "additions": 7,
      "deletions": 3,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/ldexp.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/ldexp.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldexp.c?ref=5376d47f66d0e4e07b3d42cb62ad07327cad4292",
      "patch": "@@ -1217,15 +1217,19 @@ exp_fold_tree_1 (etree_type *tree)\n \t\t\tbfd_link_hide_symbol (link_info.output_bfd,\n \t\t\t\t\t      &link_info, h);\n \n-\t\t      /* Copy the symbol type if this is an expression only\n+\t\t      /* Copy the symbol type and set non_ir_ref_regular\n+\t\t\t on the source if this is an expression only\n \t\t\t referencing a single symbol.  (If the expression\n \t\t\t contains ternary conditions, ignoring symbols on\n \t\t\t false branches.)  */\n \t\t      if (expld.assign_src != NULL\n \t\t\t  && (expld.assign_src\n \t\t\t      != (struct bfd_link_hash_entry *) -1))\n-\t\t\tbfd_copy_link_hash_symbol_type (link_info.output_bfd,\n-\t\t\t\t\t\t\th, expld.assign_src);\n+\t\t\t{\n+\t\t\t  bfd_copy_link_hash_symbol_type (link_info.output_bfd,\n+\t\t\t\t\t\t\t  h, expld.assign_src);\n+\t\t\t  expld.assign_src->non_ir_ref_regular = TRUE;\n+\t\t\t}\n \t\t    }\n \t\t}\n \t    }"
    },
    {
      "sha": "5a6ba7ad83733a1aceb753d0f1aafa337ae66d35",
      "filename": "ld/testsuite/ld-plugin/lto.exp",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/lto.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/lto.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto.exp?ref=5376d47f66d0e4e07b3d42cb62ad07327cad4292",
      "patch": "@@ -207,6 +207,9 @@ set lto_link_tests [list \\\n   [list \"Build pr24406-2b.o\" \\\n    \"\" \"-O2 -fno-lto\" \\\n    {pr24406-2b.c}] \\\n+  [list \"Build pr26163a.o\" \\\n+   \"\" \"-O2 -fno-lto\" \\\n+   {pr26163a.c}] \\\n ]\n \n if { [at_least_gcc_version 10 0] } {\n@@ -502,6 +505,11 @@ set lto_run_tests [list \\\n    {pr24406-2a.c} \"pr24406-2\" \"pass.out\" \\\n    \"-flto -O2\" \"c\" \"\" \\\n    \"tmpdir/pr24406-2b.o -Wl,--wrap=cook\"] \\\n+  [list \"Run pr26163\" \\\n+   \"-O2 -flto\" \"\" \\\n+   {pr26163b.c} \"pr24406-2\" \"pass.out\" \\\n+   \"-flto -O2\" \"c\" \"\" \\\n+   \"tmpdir/pr26163a.o -Wl,--defsym,g=real_g\"] \\\n ]\n \n if { [at_least_gcc_version 4 7] } {"
    },
    {
      "sha": "4c9979b85066b9369cc6eab82f2798fd8e7182de",
      "filename": "ld/testsuite/ld-plugin/pr26163a.c",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/pr26163a.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/pr26163a.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr26163a.c?ref=5376d47f66d0e4e07b3d42cb62ad07327cad4292",
      "patch": "@@ -0,0 +1,9 @@\n+extern int counter;\n+\n+extern void g(void);\n+\n+void f(void)\n+{\n+  g();\n+  counter++;\n+}"
    },
    {
      "sha": "5524b4e3d9767a52fe70f3d3bede2e41dbf689b1",
      "filename": "ld/testsuite/ld-plugin/pr26163b.c",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/pr26163b.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5376d47f66d0e4e07b3d42cb62ad07327cad4292/ld/testsuite/ld-plugin/pr26163b.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr26163b.c?ref=5376d47f66d0e4e07b3d42cb62ad07327cad4292",
      "patch": "@@ -0,0 +1,19 @@\n+#include <stdio.h>\n+\n+int counter;\n+extern void f(void);\n+\n+void\n+real_g(void)\n+{\n+  counter++;\n+}\n+\n+int main()\n+{\n+  real_g();\n+  f();\n+  if (counter == 3)\n+    printf (\"PASS\\n\");\n+  return 0;\n+}"
    }
  ]
}