{
  "sha": "080a488354d63fec9791a26fadd15e0c5246983d",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MDgwYTQ4ODM1NGQ2M2ZlYzk3OTFhMjZmYWRkMTVlMGM1MjQ2OTgzZA==",
  "commit": {
    "author": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2019-08-15T19:01:13Z"
    },
    "committer": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2019-08-15T19:01:13Z"
    },
    "message": "RISC-V: Fix lui relaxation issue with code at address 0.\n\nThis fixes a problem originally reported at\n    https://github.com/riscv/riscv-binutils-gdb/issues/173\n\nIf you have code linked at address zero, you can have a lui instruction\nloading a value 0x800 which gets relaxed to a c.lui which is valid (c.lui 0x1\nfollowed by addi -0x800).  Relaxation can reduce the value below 0x800 at which\npoint the c.lui 0x0 is no longer valid.  We can fix this by converting the\nc.lui to a c.li which can load 0.\n\n\tbfd/\n\t* elfnn-riscv.c (perform_relocation) <R_RISCV_RVC_LUI>: If\n\tRISCV_CONST_HIGH_PART (value) is zero, then convert c.lui instruction\n\tto c.li instruction, and use ENCODE_RVC_IMM to set value.\n\n\tld/\n\t* testsuite/ld-riscv-elf/c-lui-2.d: New.\n\t* testsuite/ld-riscv-elf/c-lui-2.ld: New.\n\t* testsuite/ld-riscv-elf/c-lui-2.s: New.\n\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp: Run the c-lui-2 test.",
    "tree": {
      "sha": "9aa728d8b99659e38b8f1eb05a128c8e60e74cb9",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/9aa728d8b99659e38b8f1eb05a128c8e60e74cb9"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/080a488354d63fec9791a26fadd15e0c5246983d",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/080a488354d63fec9791a26fadd15e0c5246983d",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/080a488354d63fec9791a26fadd15e0c5246983d",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/080a488354d63fec9791a26fadd15e0c5246983d/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "db502012fc46b4dd068461aaeafeaa421489c562",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/db502012fc46b4dd068461aaeafeaa421489c562",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/db502012fc46b4dd068461aaeafeaa421489c562"
    }
  ],
  "stats": {
    "total": 67,
    "additions": 65,
    "deletions": 2
  },
  "files": [
    {
      "sha": "8e63c9b8f9d077aae4ac8ea2c84ea7e6780d92d6",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -1,3 +1,9 @@\n+2019-08-15  Jim Wilson  <jimw@sifive.com>\n+\n+\t* elfnn-riscv.c (perform_relocation) <R_RISCV_RVC_LUI>: If\n+\tRISCV_CONST_HIGH_PART (value) is zero, then convert c.lui instruction\n+\tto c.li instruction, and use ENCODE_RVC_IMM to set value.\n+\n 2019-08-15  Tom Tromey  <tromey@adacore.com>\n \n \t* dwarf2.c (scan_unit_for_symbols): Check for end of CU, not end"
    },
    {
      "sha": "d14c29e83315456356ebc83dc3a7f87749e9840a",
      "filename": "bfd/elfnn-riscv.c",
      "status": "modified",
      "additions": 14,
      "deletions": 2,
      "changes": 16,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/bfd/elfnn-riscv.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/bfd/elfnn-riscv.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfnn-riscv.c?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -1482,9 +1482,21 @@ perform_relocation (const reloc_howto_type *howto,\n       break;\n \n     case R_RISCV_RVC_LUI:\n-      if (!VALID_RVC_LUI_IMM (RISCV_CONST_HIGH_PART (value)))\n+      if (RISCV_CONST_HIGH_PART (value) == 0)\n+\t{\n+\t  /* Linker relaxation can convert an address equal to or greater than\n+\t     0x800 to slightly below 0x800.  C.LUI does not accept zero as a\n+\t     valid immediate.  We can fix this by converting it to a C.LI.  */\n+\t  bfd_vma insn = bfd_get (howto->bitsize, input_bfd,\n+\t\t\t\t  contents + rel->r_offset);\n+\t  insn = (insn & ~MATCH_C_LUI) | MATCH_C_LI;\n+\t  bfd_put (howto->bitsize, input_bfd, insn, contents + rel->r_offset);\n+\t  value = ENCODE_RVC_IMM (0);\n+\t}\n+      else if (!VALID_RVC_LUI_IMM (RISCV_CONST_HIGH_PART (value)))\n \treturn bfd_reloc_overflow;\n-      value = ENCODE_RVC_LUI_IMM (RISCV_CONST_HIGH_PART (value));\n+      else\n+\tvalue = ENCODE_RVC_LUI_IMM (RISCV_CONST_HIGH_PART (value));\n       break;\n \n     case R_RISCV_32:"
    },
    {
      "sha": "0366b833b7fbfbce95970a904f222b284f607b7b",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -1,3 +1,10 @@\n+2019-08-15  Jim Wilson  <jimw@sifive.com>\n+\n+\t* testsuite/ld-riscv-elf/c-lui-2.d: New.\n+\t* testsuite/ld-riscv-elf/c-lui-2.ld: New.\n+\t* testsuite/ld-riscv-elf/c-lui-2.s: New.\n+\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp: Run the c-lui-2 test.\n+\n 2019-08-10  Alan Modra  <amodra@gmail.com>\n \n \t* ldlang.h (enum statement_enum): Sort."
    },
    {
      "sha": "622c0f7a31db5ac73fc25dfa2cacc0550fac0f55",
      "filename": "ld/testsuite/ld-riscv-elf/c-lui-2.d",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/c-lui-2.d?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -0,0 +1,19 @@\n+#name: c.lui to c.li relaxation\n+#source: c-lui-2.s\n+#as: -march=rv32ic\n+#ld: -melf32lriscv -Tc-lui-2.ld\n+#objdump: -d -M no-aliases,numeric\n+\n+.*:     file format .*\n+\n+\n+Disassembly of section \\.text:\n+\n+.* <_start>:\n+.*:\t4501                \tc.li\tx10,0\n+.*:\t7fe00513          \taddi\tx10,x0,2046\n+\t...\n+\n+.* <foo>:\n+.*:\t8082                \tc.jr\tx1\n+#pass"
    },
    {
      "sha": "1a0596dad9a06d5cd1f071c33d01e8307f9963b7",
      "filename": "ld/testsuite/ld-riscv-elf/c-lui-2.ld",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.ld",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.ld",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/c-lui-2.ld?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -0,0 +1,6 @@\n+ENTRY(_start)\n+SECTIONS {\n+\t.text 0x00000000 : {\n+\t\t*(.text*)\n+\t}\n+}"
    },
    {
      "sha": "7aa258606a4c099c6236a51be08584f43ac5a0a5",
      "filename": "ld/testsuite/ld-riscv-elf/c-lui-2.s",
      "status": "added",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/c-lui-2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/c-lui-2.s?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -0,0 +1,12 @@\n+\t.option nopic\n+\t.text\n+\t.align 1\n+\t.globl _start\n+\t.type _start, @function\n+_start:\n+\tlui a0,%hi(foo)\n+\taddi a0,a0,%lo(foo)\n+\t.skip 0x7f8\n+foo:\n+\tret\n+\t.size _start, .-_start"
    },
    {
      "sha": "c994a57c48ac2f2122b697001351aab96330a60a",
      "filename": "ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/080a488354d63fec9791a26fadd15e0c5246983d/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp?ref=080a488354d63fec9791a26fadd15e0c5246983d",
      "patch": "@@ -21,6 +21,7 @@\n \n if [istarget \"riscv*-*-*\"] {\n     run_dump_test \"c-lui\"\n+    run_dump_test \"c-lui-2\"\n     run_dump_test \"disas-jalr\"\n     run_dump_test \"pcrel-lo-addend\"\n     run_dump_test \"pcrel-lo-addend-2\""
    }
  ]
}