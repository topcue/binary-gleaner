{
  "sha": "ce12121b63145322b4961bbb2b94b939cb916ba7",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6Y2UxMjEyMWI2MzE0NTMyMmI0OTYxYmJiMmI5NGI5MzljYjkxNmJhNw==",
  "commit": {
    "author": {
      "name": "Tamar Christina",
      "email": "tamar.christina@arm.com",
      "date": "2019-04-11T10:27:28Z"
    },
    "committer": {
      "name": "Tamar Christina",
      "email": "tamar.christina@arm.com",
      "date": "2019-04-11T10:30:03Z"
    },
    "message": "AArch64: When DF_BIND_NOW don't use TLSDESC GOT value.\n\nWhen using DF_BIND_NOW on AArch64 we don't reserve the GOT slot for a TLSDESC,\nbut we still emitted DT_TLSDESC_GOT and DT_TLSDESC_PLT.  This caused random\nmemory corruption as the \"special\" value of (bfd_vma)-1 would be set for\ndt_tlsdesc_got.\n\nSince we don't have a value of dt_tlsdesc_got I also don't emit DT_TLSDESC_PLT\nnow becuase it would point to an incomplete PLT. To be able to write the PLT\nentry DT_TLSDESC_GOT is needed and since we don't have one we can't write the\nPLT entry either.\n\nIt is my understanding that GLIBC doesn't need these two entries when not lazy\nloading.  Conversely AArch32 does not reserve neither the GOT not the PLT slot\nwhen doing DF_BIND_NOW.\n\nAArch32 does not need these checks because these values are initialized to 0\nand so the if (...) checks don't pass, but on AArch64 these are initialized\nto (bfd_vma)-1 and thus we need some extra checks.\n\nbfd/ChangeLog:\n\n\tPR ld/24302\n\t* elfnn-aarch64.c (elfNN_aarch64_size_dynamic_sections): Don't emit\n\tDT_TLSDESC_GOT and DT_TLSDESC_PLT when DF_BIND_NOW.\n\t(elfNN_aarch64_finish_dynamic_sections): Don't write PLT if DF_BIND_NOW.\n\nld/ChangeLog:\n\n\tPR ld/24302\n\t* testsuite/ld-aarch64/aarch64-elf.exp: Add new test.\n\t* testsuite/ld-aarch64/tls-relax-gdesc-le-now.d: New test.",
    "tree": {
      "sha": "3c30d02e802c3bf01f6f2c2a093d0908fe3b4469",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3c30d02e802c3bf01f6f2c2a093d0908fe3b4469"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ce12121b63145322b4961bbb2b94b939cb916ba7",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ce12121b63145322b4961bbb2b94b939cb916ba7",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ce12121b63145322b4961bbb2b94b939cb916ba7",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ce12121b63145322b4961bbb2b94b939cb916ba7/comments",
  "author": {
    "login": "TamarChristinaArm",
    "id": 48126768,
    "node_id": "MDQ6VXNlcjQ4MTI2NzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/48126768?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TamarChristinaArm",
    "html_url": "https://github.com/TamarChristinaArm",
    "followers_url": "https://api.github.com/users/TamarChristinaArm/followers",
    "following_url": "https://api.github.com/users/TamarChristinaArm/following{/other_user}",
    "gists_url": "https://api.github.com/users/TamarChristinaArm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TamarChristinaArm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TamarChristinaArm/subscriptions",
    "organizations_url": "https://api.github.com/users/TamarChristinaArm/orgs",
    "repos_url": "https://api.github.com/users/TamarChristinaArm/repos",
    "events_url": "https://api.github.com/users/TamarChristinaArm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TamarChristinaArm/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "TamarChristinaArm",
    "id": 48126768,
    "node_id": "MDQ6VXNlcjQ4MTI2NzY4",
    "avatar_url": "https://avatars.githubusercontent.com/u/48126768?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/TamarChristinaArm",
    "html_url": "https://github.com/TamarChristinaArm",
    "followers_url": "https://api.github.com/users/TamarChristinaArm/followers",
    "following_url": "https://api.github.com/users/TamarChristinaArm/following{/other_user}",
    "gists_url": "https://api.github.com/users/TamarChristinaArm/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/TamarChristinaArm/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/TamarChristinaArm/subscriptions",
    "organizations_url": "https://api.github.com/users/TamarChristinaArm/orgs",
    "repos_url": "https://api.github.com/users/TamarChristinaArm/repos",
    "events_url": "https://api.github.com/users/TamarChristinaArm/events{/privacy}",
    "received_events_url": "https://api.github.com/users/TamarChristinaArm/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "bd7ceb8d26e011ff3fd23402ec2587d7c374f090",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bd7ceb8d26e011ff3fd23402ec2587d7c374f090",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/bd7ceb8d26e011ff3fd23402ec2587d7c374f090"
    }
  ],
  "stats": {
    "total": 46,
    "additions": 41,
    "deletions": 5
  },
  "files": [
    {
      "sha": "022e7c3f0834b6af0b62fa0fbf55f765f96c4afa",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ce12121b63145322b4961bbb2b94b939cb916ba7/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ce12121b63145322b4961bbb2b94b939cb916ba7/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=ce12121b63145322b4961bbb2b94b939cb916ba7",
      "patch": "@@ -1,3 +1,10 @@\n+2019-04-11  Tamar Christina  <tamar.christina@arm.com>\n+\n+\tPR ld/24302\n+\t* elfnn-aarch64.c (elfNN_aarch64_size_dynamic_sections): Don't emit\n+\tDT_TLSDESC_GOT and DT_TLSDESC_PLT when DF_BIND_NOW.\n+\t(elfNN_aarch64_finish_dynamic_sections): Don't write PLT if DF_BIND_NOW.\n+\n 2019-04-10  Michael Forney  <mforney@mforney.org>\n \n \tPR 24427"
    },
    {
      "sha": "9d4df11f9d42c39fad5742f92a5edb561e809259",
      "filename": "bfd/elfnn-aarch64.c",
      "status": "modified",
      "additions": 8,
      "deletions": 5,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ce12121b63145322b4961bbb2b94b939cb916ba7/bfd/elfnn-aarch64.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ce12121b63145322b4961bbb2b94b939cb916ba7/bfd/elfnn-aarch64.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfnn-aarch64.c?ref=ce12121b63145322b4961bbb2b94b939cb916ba7",
      "patch": "@@ -9064,13 +9064,13 @@ elfNN_aarch64_size_dynamic_sections (bfd *output_bfd ATTRIBUTE_UNUSED,\n       if (htab->root.splt->size == 0)\n \thtab->root.splt->size += htab->plt_header_size;\n \n-      htab->tlsdesc_plt = htab->root.splt->size;\n-      htab->root.splt->size += htab->tlsdesc_plt_entry_size;\n-\n       /* If we're not using lazy TLS relocations, don't generate the\n-\t GOT entry required.  */\n+\t GOT and PLT entry required.  */\n       if (!(info->flags & DF_BIND_NOW))\n \t{\n+\t  htab->tlsdesc_plt = htab->root.splt->size;\n+\t  htab->root.splt->size += htab->tlsdesc_plt_entry_size;\n+\n \t  htab->dt_tlsdesc_got = htab->root.sgot->size;\n \t  htab->root.sgot->size += GOT_ENTRY_SIZE;\n \t}\n@@ -9174,6 +9174,7 @@ elfNN_aarch64_size_dynamic_sections (bfd *output_bfd ATTRIBUTE_UNUSED,\n \t    return FALSE;\n \n \t  if (htab->tlsdesc_plt\n+\t      && !(info->flags & DF_BIND_NOW)\n \t      && (!add_dynamic_entry (DT_TLSDESC_PLT, 0)\n \t\t  || !add_dynamic_entry (DT_TLSDESC_GOT, 0)))\n \t    return FALSE;\n@@ -9686,6 +9687,7 @@ elfNN_aarch64_finish_dynamic_sections (bfd *output_bfd,\n \n \t    case DT_TLSDESC_GOT:\n \t      s = htab->root.sgot;\n+\t      BFD_ASSERT (htab->dt_tlsdesc_got != (bfd_vma)-1);\n \t      dyn.d_un.d_ptr = s->output_section->vma + s->output_offset\n \t\t+ htab->dt_tlsdesc_got;\n \t      break;\n@@ -9705,8 +9707,9 @@ elfNN_aarch64_finish_dynamic_sections (bfd *output_bfd,\n \tthis_hdr.sh_entsize = htab->plt_entry_size;\n \n \n-      if (htab->tlsdesc_plt)\n+      if (htab->tlsdesc_plt && !(info->flags & DF_BIND_NOW))\n \t{\n+\t  BFD_ASSERT (htab->dt_tlsdesc_got != (bfd_vma)-1);\n \t  bfd_put_NN (output_bfd, (bfd_vma) 0,\n \t\t      htab->root.sgot->contents + htab->dt_tlsdesc_got);\n "
    },
    {
      "sha": "e63f2be17891081833b30e8f6b7de1e5ccf01fd7",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=ce12121b63145322b4961bbb2b94b939cb916ba7",
      "patch": "@@ -1,3 +1,9 @@\n+2019-04-11  Tamar Christina  <tamar.christina@arm.com>\n+\n+\tPR ld/24302\n+\t* testsuite/ld-aarch64/aarch64-elf.exp: Add new test.\n+\t* testsuite/ld-aarch64/tls-relax-gdesc-le-now.d: New test.\n+\n 2019-04-10  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* scripttempl/elf.sc (CREATE_PIC): New.  Set for CREATE_SHLIB or"
    },
    {
      "sha": "e69aedd0d4d1b434b659a9d426cf86c528610608",
      "filename": "ld/testsuite/ld-aarch64/aarch64-elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/testsuite/ld-aarch64/aarch64-elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/testsuite/ld-aarch64/aarch64-elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-aarch64/aarch64-elf.exp?ref=ce12121b63145322b4961bbb2b94b939cb916ba7",
      "patch": "@@ -256,6 +256,7 @@ run_dump_test \"tls-relax-all-ilp32\"\n run_dump_test \"tls-relax-gd-le\"\n run_dump_test \"tls-relax-gd-le-ilp32\"\n run_dump_test \"tls-relax-gdesc-le\"\n+run_dump_test \"tls-relax-gdesc-le-now\"\n run_dump_test \"tls-relax-gdesc-le-ilp32\"\n run_dump_test \"tls-relax-gd-ie\"\n run_dump_test \"tls-relax-gd-ie-ilp32\""
    },
    {
      "sha": "f1565e9c11f0136a5183694ecc22191617bf5cc2",
      "filename": "ld/testsuite/ld-aarch64/tls-relax-gdesc-le-now.d",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/testsuite/ld-aarch64/tls-relax-gdesc-le-now.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ce12121b63145322b4961bbb2b94b939cb916ba7/ld/testsuite/ld-aarch64/tls-relax-gdesc-le-now.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-aarch64/tls-relax-gdesc-le-now.d?ref=ce12121b63145322b4961bbb2b94b939cb916ba7",
      "patch": "@@ -0,0 +1,19 @@\n+#source: tls-relax-gdesc-le.s\n+#ld: -shared -z now\n+#readelf: -dr\n+#...\n+ 0x.+ \\(STRTAB\\)   \\s+0x.+\n+ 0x.+ \\(SYMTAB\\)   \\s+0x.+\n+ 0x.+ \\(STRSZ\\)    \\s+.+ \\(bytes\\)\n+ 0x.+ \\(SYMENT\\)   \\s+.+ \\(bytes\\)\n+ 0x.+ \\(PLTGOT\\)   \\s+0x.+\n+ 0x.+ \\(PLTRELSZ\\) \\s+.+ \\(bytes\\)\n+ 0x.+ \\(PLTREL\\)   \\s+RELA\n+ 0x.+ \\(JMPREL\\)   \\s+0x.+\n+ 0x.+ \\(BIND_NOW\\) \\s+\n+ 0x.+ \\(FLAGS_1\\)  \\s+   Flags: NOW\n+ 0x.+ \\(NULL\\)     \\s+   0x0\n+\n+Relocation section '\\.rela\\.plt' at offset .+ contains 1 entry:\n+  Offset          Info           Type           Sym\\. Value    Sym\\. Name \\+ Addend\n+.+  .+ R_AARCH64_TLSDESC                    0"
    }
  ]
}