{
  "sha": "f2d4ba38f5723a207c40a288036af2f38b70e837",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZjJkNGJhMzhmNTcyM2EyMDdjNDBhMjg4MDM2YWYyZjM4YjcwZTgzNw==",
  "commit": {
    "author": {
      "name": "Jan Beulich",
      "email": "jbeulich@suse.com",
      "date": "2019-07-04T08:35:47Z"
    },
    "committer": {
      "name": "Jan Beulich",
      "email": "jbeulich@suse.com",
      "date": "2019-07-04T08:35:47Z"
    },
    "message": "gas/ELF: don't accumulate .type settings\n\nRecently a patch was submitted for a Xen Project test harness binary to\noverride the compiler specified @object to @func (see [1]). In a reply I\nsuggested we shouldn't make ourselves dependent on currently unspecified\nbehavior of gas here: It accumulates all requests, and then\nbfd/elf.c:swap_out_syms(), in an apparently ad hoc manner, prioritizes\ncertain flags over others.\n\nMake the behavior predictable: Generally the last .type is what counts.\nExceptions are directives which set multiple bits (TLS, IFUNC, and\nUNIQUE): Subsequent directives requesting just the more generic bit\n(i.e. FUNC following IFUNC) won't clear the more specific one.  Warn\nabout incompatible changes, except from/to STT_NOTYPE.\n\nAlso add a new target hook, which hppa wants to use right away afaict.\n\nIn the course of adding the warning I ran into two ld testsuite\nfailures.  I can only assume that it was a copy-and-paste mistake that\nlead to the same symbol having its type set twice.\n\n[1] https://lists.xenproject.org/archives/html/xen-devel/2019-05/msg01980.html",
    "tree": {
      "sha": "4f864465aad8dfadd14c3ee62cc9f0ca7c743045",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/4f864465aad8dfadd14c3ee62cc9f0ca7c743045"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/f2d4ba38f5723a207c40a288036af2f38b70e837",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f2d4ba38f5723a207c40a288036af2f38b70e837",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/f2d4ba38f5723a207c40a288036af2f38b70e837",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f2d4ba38f5723a207c40a288036af2f38b70e837/comments",
  "author": {
    "login": "jbeulich",
    "id": 5610135,
    "node_id": "MDQ6VXNlcjU2MTAxMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5610135?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jbeulich",
    "html_url": "https://github.com/jbeulich",
    "followers_url": "https://api.github.com/users/jbeulich/followers",
    "following_url": "https://api.github.com/users/jbeulich/following{/other_user}",
    "gists_url": "https://api.github.com/users/jbeulich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jbeulich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jbeulich/subscriptions",
    "organizations_url": "https://api.github.com/users/jbeulich/orgs",
    "repos_url": "https://api.github.com/users/jbeulich/repos",
    "events_url": "https://api.github.com/users/jbeulich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jbeulich/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jbeulich",
    "id": 5610135,
    "node_id": "MDQ6VXNlcjU2MTAxMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5610135?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jbeulich",
    "html_url": "https://github.com/jbeulich",
    "followers_url": "https://api.github.com/users/jbeulich/followers",
    "following_url": "https://api.github.com/users/jbeulich/following{/other_user}",
    "gists_url": "https://api.github.com/users/jbeulich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jbeulich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jbeulich/subscriptions",
    "organizations_url": "https://api.github.com/users/jbeulich/orgs",
    "repos_url": "https://api.github.com/users/jbeulich/repos",
    "events_url": "https://api.github.com/users/jbeulich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jbeulich/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "db7fbcbeb749c0d4ea19284438d62b253648c58a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/db7fbcbeb749c0d4ea19284438d62b253648c58a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/db7fbcbeb749c0d4ea19284438d62b253648c58a"
    }
  ],
  "stats": {
    "total": 125,
    "additions": 123,
    "deletions": 2
  },
  "files": [
    {
      "sha": "ab00f146db5723cd3551e6225a153fd7d3daf4b8",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -1,3 +1,14 @@\n+2019-07-04  Jan Beulich  <jbeulich@suse.com>\n+\n+\t* config/obj-elf.c (obj_elf_type): Check for conflicts between\n+\told and new types.\n+\t* config/tc-hppa.h (md_elf_symbol_type_change): New.\n+\t* doc/as.texi: Mention warning behavior for the ELF flavor of\n+\t.type.\n+\t* testsuite/gas/elf/type-2.e, testsuite/gas/elf/type-2.l,\n+\ttestsuite/gas/elf/type-2.s: New.\n+\t* testsuite/gas/elf/elf.exp: Run new test.\n+\n 2019-07-03  Nick Clifton  <nickc@redhat.com>\n \n \t* testsuite/gas/aarch64/codealign.d: Update to work with a"
    },
    {
      "sha": "224d4c29e6cf919c27f9c519a813e5cf485fe4a1",
      "filename": "gas/config/obj-elf.c",
      "status": "modified",
      "additions": 32,
      "deletions": 1,
      "changes": 33,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/config/obj-elf.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/config/obj-elf.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/obj-elf.c?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -2069,7 +2069,38 @@ obj_elf_type (int ignore ATTRIBUTE_UNUSED)\n   if (*input_line_pointer == '\"')\n     ++input_line_pointer;\n \n-  elfsym->symbol.flags |= type;\n+#ifdef md_elf_symbol_type_change\n+  if (!md_elf_symbol_type_change (sym, elfsym, type))\n+#endif\n+    {\n+      flagword mask = BSF_FUNCTION | BSF_OBJECT;\n+\n+      if (type != BSF_FUNCTION)\n+\tmask |= BSF_GNU_INDIRECT_FUNCTION;\n+      if (type != BSF_OBJECT)\n+\t{\n+\t  mask |= BSF_GNU_UNIQUE | BSF_THREAD_LOCAL;\n+\n+\t  if (S_IS_COMMON (sym))\n+\t    {\n+\t      as_bad (_(\"cannot change type of common symbol '%s'\"),\n+\t\t      S_GET_NAME (sym));\n+\t      mask = type = 0;\n+\t    }\n+\t}\n+\n+      /* Don't warn when changing to STT_NOTYPE.  */\n+      if (type)\n+\t{\n+\t  flagword new = (elfsym->symbol.flags & ~mask) | type;\n+\n+\t  if (new != (elfsym->symbol.flags | type))\n+\t    as_warn (_(\"symbol '%s' already has its type set\"), S_GET_NAME (sym));\n+\t  elfsym->symbol.flags = new;\n+\t}\n+      else\n+\telfsym->symbol.flags &= ~mask;\n+    }\n \n   demand_empty_rest_of_line ();\n }"
    },
    {
      "sha": "ab54b4d095197f70441761c8ad5a582c82d29fa6",
      "filename": "gas/config/tc-hppa.h",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/config/tc-hppa.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/config/tc-hppa.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-hppa.h?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -177,6 +177,14 @@ int hppa_fix_adjustable (struct fix *);\n        ), BSF_FUNCTION)\t\t\t\t\t\t\t\\\n    : -1)\n \n+/* Handle type change from .type pseudo: Zap STT_PARISC_MILLI when\n+   switching to a non-function type.  */\n+#define md_elf_symbol_type_change(sym, elf, type)\t\t\t\\\n+  ((type) != BSF_FUNCTION\t\t\t\t\t\t\\\n+   && (((elf)->internal_elf_sym.st_info = \t\t\t\t\\\n+\tELF_ST_INFO (ELF_ST_BIND ((elf)->internal_elf_sym.st_info),\t\\\n+\t\t     STT_NOTYPE)), 0))\n+\n #define tc_frob_symbol(sym,punt) \\\n   { \\\n     if ((S_GET_SEGMENT (sym) == bfd_und_section_ptr \\"
    },
    {
      "sha": "b4598e86dc6e188aa04d46252391c3cdc3354475",
      "filename": "gas/doc/as.texi",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/doc/as.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/doc/as.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/doc/as.texi?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -7215,6 +7215,10 @@ systems).\n \n @end table\n \n+Changing between incompatible types other than from/to STT_NOTYPE will\n+result in a diagnostic.  An intermediate change to STT_NOTYPE will silence\n+this.\n+\n Note: Some targets support extra types in addition to those listed above.\n \n @end ifset"
    },
    {
      "sha": "b27a7ecabb208641c23234cc39b941197ddfc0ed",
      "filename": "gas/testsuite/gas/elf/elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/elf.exp?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -229,6 +229,7 @@ if { [is_elf_format] } then {\n     } else {\n \trun_dump_test ifunc-1\n \trun_elf_list_test \"type\" \"\" \"\" \"-s\" \"| grep \\\"1 *\\\\\\[FIONTCU\\\\\\]\\\"\"\n+\trun_elf_list_test \"type-2\" \"\" \"--warn\" \"-s\" \"| grep \\\"0 *\\\\\\[FIONT\\\\\\]\\\"\"\n     }\n \n     run_dump_test \"section6\""
    },
    {
      "sha": "684727ccf43750846a444b00df7fcab41872189b",
      "filename": "gas/testsuite/gas/elf/type-2.e",
      "status": "added",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.e",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.e",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/type-2.e?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -0,0 +1,10 @@\n+ +.+: 0+0 +0 +NOTYPE +LOCAL +DEFAULT +UND *\n+ +.+: 0+0 +0 +OBJECT +LOCAL +DEFAULT +. test1\n+ +.+: 0+1 +0 +FUNC +LOCAL +DEFAULT +. test2\n+ +.+: 0+2 +0 +NOTYPE +LOCAL +DEFAULT +. test3\n+ +.+: 0+3 +0 +NOTYPE +LOCAL +DEFAULT +. test4\n+ +.+: 0+4 +0 +NOTYPE +LOCAL +DEFAULT +. test5\n+ +.+: 0+5 +0 +NOTYPE +LOCAL +DEFAULT +. test6\n+ +.+: 0+6 +0 +OBJECT +LOCAL +DEFAULT +. test7\n+ +.+: 0+7 +0 +TLS +LOCAL +DEFAULT +. test8\n+ +.+: 0+8 +0 +IFUNC +LOCAL +DEFAULT +. test9"
    },
    {
      "sha": "f4c626e59ee614164b1df2836caeeefd75e768e2",
      "filename": "gas/testsuite/gas/elf/type-2.l",
      "status": "added",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.l",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.l",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/type-2.l?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -0,0 +1,3 @@\n+.*: Assembler messages:\n+.*:4: Warning: .*\n+.*:9: Warning: .*"
    },
    {
      "sha": "c0a28eb225392772dd93b4d4e2af19062407d1bf",
      "filename": "gas/testsuite/gas/elf/type-2.s",
      "status": "added",
      "additions": 49,
      "deletions": 0,
      "changes": 49,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/gas/testsuite/gas/elf/type-2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/type-2.s?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -0,0 +1,49 @@\n+\t.text\n+\n+\t.type\ttest1,%function\n+\t.type\ttest1,%object\n+test1:\n+\t.byte\t0x0\n+\n+\t.type\ttest2,%object\n+\t.type\ttest2,%function\n+test2:\n+\t.byte\t0x0\n+\n+\t.type\ttest3,%object\n+\t.type\ttest3,%notype\n+test3:\n+\t.byte\t0x0\n+\n+\t.type\ttest4,%function\n+\t.type\ttest4,%notype\n+test4:\n+\t.byte\t0x0\n+\n+\t.type\ttest5,%tls_object\n+\t.type\ttest5,%notype\n+test5:\n+\t.byte\t0x0\n+\n+\t.type\ttest6,%gnu_indirect_function\n+\t.type\ttest6,%notype\n+test6:\n+\t.byte\t0x0\n+\n+\t.type\ttest7,%function\n+\t.type\ttest7,%notype\n+\t.type\ttest7,%object\n+test7:\n+\t.byte\t0x0\n+\n+\t.type\ttest8,%object\n+\t.type\ttest8,%tls_object\n+\t.type\ttest8,%object\n+test8:\n+\t.byte\t0x0\n+\n+\t.type\ttest9,%function\n+\t.type\ttest9,%gnu_indirect_function\n+\t.type\ttest9,%function\n+test9:\n+\t.byte\t0x0"
    },
    {
      "sha": "dbf2d2e4b5ce1bf60e91d5b71726e78a638ed0c5",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -1,3 +1,7 @@\n+2019-07-04  Jan Beulich  <jbeulich@suse.com>\n+\n+\t* testsuite/ld-elf/group9.s: Correct argument of .type.\n+\n 2019-07-02  Nick Clifton  <nickc@redhat.com>\n \n \tPR 24753"
    },
    {
      "sha": "9f0bccbdd2f5c3c0b3911dbddc484021ad255411",
      "filename": "ld/testsuite/ld-elf/group9.s",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f2d4ba38f5723a207c40a288036af2f38b70e837/ld/testsuite/ld-elf/group9.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f2d4ba38f5723a207c40a288036af2f38b70e837/ld/testsuite/ld-elf/group9.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/group9.s?ref=f2d4ba38f5723a207c40a288036af2f38b70e837",
      "patch": "@@ -5,7 +5,7 @@ foo:\n \t.byte 0\n \t.section\t.data.foo,\"axG\",%progbits,foo,comdat\n \t.globl foo.data\n-\t.type\tfoo,%object\n+\t.type\tfoo.data,%object\n foo.data:\n \t.byte 0\n \t.section\t.text.bar,\"axG\",%progbits,bar,comdat"
    }
  ]
}