{
  "sha": "b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YjFhOTJjNjM1YzFlYzEwZmQ3MDMzMDJjZTFmYzRhYjNhODUxNWEwNA==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-10-30T04:26:35Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-11-01T23:09:53Z"
    },
    "message": "PR26806, Suspected linker bug with LTO\n\nThis patch reverts most of git commit 1e3b96fd6cf, so IR symbols are\nagain not marked def_regular or ref_regular.  That should be enough to\nstop IR symbols from becoming dynamic.  To mark as-needed shared\nlibraries referenced by IR symbols, use the referencing BFD rather\nthan the ref flags.\n\nbfd/\n\tPR 15146\n\tPR 26314\n\tPR 26530\n\tPR 26806\n\t* elflink.c (elf_link_add_object_symbols): Don't set def/ref flags\n\tfor plugin syms.  Do allow plugin syms to mark as-needed libs.\nld/\n\tPR 26806\n\t* testsuite/ld-plugin/lto-19.h,\n\t* testsuite/ld-plugin/lto-19a.c,\n\t* testsuite/ld-plugin/lto-19b.c,\n\t* testsuite/ld-plugin/lto-19c.c: New test.\n\t* testsuite/ld-plugin/pr26806.c,\n\t* testsuite/ld-plugin/pr26806.d: New test.\n\t* testsuite/ld-plugin/lto.exp: Run them.",
    "tree": {
      "sha": "80c9f60d71a1d360f6a223b8d3ee4c330a5af55d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/80c9f60d71a1d360f6a223b8d3ee4c330a5af55d"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ae7754b256f1f230baec364d90561c3ca34f7e64",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ae7754b256f1f230baec364d90561c3ca34f7e64",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/ae7754b256f1f230baec364d90561c3ca34f7e64"
    }
  ],
  "stats": {
    "total": 130,
    "additions": 113,
    "deletions": 17
  },
  "files": [
    {
      "sha": "e632282a71cf14ba0d87a0890f2286323b7d3420",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -1,3 +1,12 @@\n+2020-11-02  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 15146\n+\tPR 26314\n+\tPR 26530\n+\tPR 26806\n+\t* elflink.c (elf_link_add_object_symbols): Don't set def/ref flags\n+\tfor plugin syms.  Do allow plugin syms to mark as-needed libs.\n+\n 2020-10-30  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR gas/26703"
    },
    {
      "sha": "4b035a2cd56fdbf2dcb793b2dc0ffb807265272f",
      "filename": "bfd/elflink.c",
      "status": "modified",
      "additions": 30,
      "deletions": 17,
      "changes": 47,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/bfd/elflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/bfd/elflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elflink.c?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -4989,7 +4989,10 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t     object and a shared object.  */\n \t  bfd_boolean dynsym = FALSE;\n \n-\t  if (! dynamic)\n+\t  /* Plugin symbols aren't normal.  Don't set def/ref flags.  */\n+\t  if ((abfd->flags & BFD_PLUGIN) != 0)\n+\t    ;\n+\t  else if (!dynamic)\n \t    {\n \t      if (! definition)\n \t\t{\n@@ -5006,14 +5009,6 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t\t      h->ref_dynamic = 1;\n \t\t    }\n \t\t}\n-\n-\t      /* If the indirect symbol has been forced local, don't\n-\t\t make the real symbol dynamic.  */\n-\t      if ((h == hi || !hi->forced_local)\n-\t\t  && (bfd_link_dll (info)\n-\t\t      || h->def_dynamic\n-\t\t      || h->ref_dynamic))\n-\t\tdynsym = TRUE;\n \t    }\n \t  else\n \t    {\n@@ -5027,14 +5022,25 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t\t  h->def_dynamic = 1;\n \t\t  hi->def_dynamic = 1;\n \t\t}\n+\t    }\n \n-\t      /* If the indirect symbol has been forced local, don't\n-\t\t make the real symbol dynamic.  */\n-\t      if ((h == hi || !hi->forced_local)\n-\t\t  && (h->def_regular\n-\t\t      || h->ref_regular\n-\t\t      || (h->is_weakalias\n-\t\t\t  && weakdef (h)->dynindx != -1)))\n+\t  /* If an indirect symbol has been forced local, don't\n+\t     make the real symbol dynamic.  */\n+\t  if (h != hi && hi->forced_local)\n+\t    ;\n+\t  else if (!dynamic)\n+\t    {\n+\t      if (bfd_link_dll (info)\n+\t\t  || h->def_dynamic\n+\t\t  || h->ref_dynamic)\n+\t\tdynsym = TRUE;\n+\t    }\n+\t  else\n+\t    {\n+\t      if (h->def_regular\n+\t\t  || h->ref_regular\n+\t\t  || (h->is_weakalias\n+\t\t      && weakdef (h)->dynindx != -1))\n \t\tdynsym = TRUE;\n \t    }\n \n@@ -5170,6 +5176,10 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t      && !bfd_link_relocatable (info))\n \t    dynsym = FALSE;\n \n+\t  /* Nor should we make plugin symbols dynamic.  */\n+\t  if ((abfd->flags & BFD_PLUGIN) != 0)\n+\t    dynsym = FALSE;\n+\n \t  if (definition)\n \t    {\n \t      h->target_internal = isym->st_target_internal;\n@@ -5196,7 +5206,7 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t\t}\n \t    }\n \n-\t  if (dynsym && (abfd->flags & BFD_PLUGIN) == 0 && h->dynindx == -1)\n+\t  if (dynsym && h->dynindx == -1)\n \t    {\n \t      if (! bfd_elf_link_record_dynamic_symbol (info, h))\n \t\tgoto error_free_vers;\n@@ -5225,6 +5235,9 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t      && definition\n \t      && ((dynsym\n \t\t   && h->ref_regular_nonweak)\n+\t\t  || (old_bfd != NULL\n+\t\t      && (old_bfd->flags & BFD_PLUGIN) != 0\n+\t\t      && bind != STB_WEAK)\n \t\t  || (h->ref_dynamic_nonweak\n \t\t      && (elf_dyn_lib_class (abfd) & DYN_AS_NEEDED) != 0\n \t\t      && !on_needed_list (elf_dt_name (abfd),"
    },
    {
      "sha": "f980e6239440b19aa09c8df13b8ccc0f667ae0df",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -1,3 +1,14 @@\n+2020-11-02  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 26806\n+\t* testsuite/ld-plugin/lto-19.h,\n+\t* testsuite/ld-plugin/lto-19a.c,\n+\t* testsuite/ld-plugin/lto-19b.c,\n+\t* testsuite/ld-plugin/lto-19c.c: New test.\n+\t* testsuite/ld-plugin/pr26806.c,\n+\t* testsuite/ld-plugin/pr26806.d: New test.\n+\t* testsuite/ld-plugin/lto.exp: Run them.\n+\n 2020-10-30  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR gas/26703"
    },
    {
      "sha": "0ca48d1f1aada0b935b2858c78abeee66bfb2c11",
      "filename": "ld/testsuite/ld-plugin/lto-19.h",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto-19.h?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,6 @@\n+struct re_dfa_t {\n+  const int *sb_char;\n+};\n+struct re_dfa_t *xregcomp (void);\n+struct re_dfa_t *rpl_regcomp (void);\n+void rpl_regfree (struct re_dfa_t *);"
    },
    {
      "sha": "6213f79144d632f27f79aa7f1d0ced99351b6151",
      "filename": "ld/testsuite/ld-plugin/lto-19a.c",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19a.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19a.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto-19a.c?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,19 @@\n+#include <stdio.h>\n+#include <stdlib.h>\n+#include \"lto-19.h\"\n+\n+static const int utf8_sb_map[4] = { 0x12, 0x34, 0x56, 0x78 };\n+\n+struct re_dfa_t *\n+rpl_regcomp ()\n+{\n+  struct re_dfa_t *dfa = malloc (sizeof (struct re_dfa_t));\n+  dfa->sb_char = utf8_sb_map;\n+  return dfa;\n+}\n+\n+void\n+rpl_regfree (struct re_dfa_t *dfa)\n+{\n+  puts (dfa->sb_char == utf8_sb_map ? \"PASS\" : \"FAIL\");\n+}"
    },
    {
      "sha": "b784f84ce06a237ab0309d463dcb490d7d9da490",
      "filename": "ld/testsuite/ld-plugin/lto-19b.c",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19b.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19b.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto-19b.c?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,7 @@\n+#include \"lto-19.h\"\n+\n+struct re_dfa_t *\n+xregcomp (void)\n+{\n+  return rpl_regcomp ();\n+}"
    },
    {
      "sha": "0d231ba5725bdb64155246e6247312f438f5e950",
      "filename": "ld/testsuite/ld-plugin/lto-19c.c",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19c.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto-19c.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto-19c.c?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,9 @@\n+#include \"lto-19.h\"\n+\n+int\n+main ()\n+{\n+  struct re_dfa_t *dfa = xregcomp ();\n+  rpl_regfree (dfa);\n+  return 0;\n+}"
    },
    {
      "sha": "23c948cc64324c1ac4e80f8d20c3be7406f0a106",
      "filename": "ld/testsuite/ld-plugin/lto.exp",
      "status": "modified",
      "additions": 16,
      "deletions": 0,
      "changes": 16,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/lto.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto.exp?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -403,6 +403,18 @@ set lto_link_elf_tests [list \\\n   [list {lto-18d.o} \\\n    {} {-flto -O2} \\\n    {lto-18d.c} {} {}] \\\n+  [list {liblto-19.a} \\\n+   \"$plug_opt\" {-flto -O2 -fPIC} \\\n+   {lto-19a.c} {} {liblto-19.a}] \\\n+  [list {compile lto-19b.c} \\\n+   \"$plug_opt\" {-flto -O2 -fPIC} \\\n+   {lto-19b.c} {} {} {c}] \\\n+  [list {liblto-19.so} \\\n+   {-shared tmpdir/lto-19b.o tmpdir/liblto-19.a} {-O2 -fPIC} \\\n+   {dummy.c} {} {liblto-19.so}] \\\n+  [list {pr26806.so} \\\n+   {-shared} {-fpic -O2 -flto} \\\n+   {pr26806.c} {{nm {-D} pr26806.d}} {pr26806.so}] \\\n ]\n \n # PR 14918 checks that libgcc is not spuriously included in a shared link of\n@@ -584,6 +596,10 @@ set lto_run_elf_shared_tests [list \\\n    {-static -flto -fuse-linker-plugin} {} \\\n    {lto-18a.c} {lto-18-4.exe} {lto-18.out} {-flto -O2} {c} {} \\\n    { -Ltmpdir -llto-18b -llto-18c tmpdir/lto-18d.o}] \\\n+  [list {lto-19} \\\n+   {-Wl,--as-needed,-R,tmpdir} {} \\\n+   {lto-19c.c} {lto-19.exe} {pass.out} {-flto -O2} {c} {} \\\n+   {tmpdir/liblto-19.so tmpdir/liblto-19.a}] \\\n ]\n \n # LTO run-time tests for ELF"
    },
    {
      "sha": "8bb29316f58a37e5873c4f5e4201d3b852768b8e",
      "filename": "ld/testsuite/ld-plugin/pr26806.c",
      "status": "added",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/pr26806.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/pr26806.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr26806.c?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,2 @@\n+#include <unistd.h>\n+int foo (int x) { if (__builtin_constant_p (x)) return getpid (); return 0; }"
    },
    {
      "sha": "16fa828e1361d1975ae8c4ca1b222d2f8e469cb0",
      "filename": "ld/testsuite/ld-plugin/pr26806.d",
      "status": "added",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/pr26806.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b1a92c635c1ec10fd703302ce1fc4ab3a8515a04/ld/testsuite/ld-plugin/pr26806.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr26806.d?ref=b1a92c635c1ec10fd703302ce1fc4ab3a8515a04",
      "patch": "@@ -0,0 +1,4 @@\n+#failif\n+#...\n+.* _*getpid[@ ].*\n+#..."
    }
  ]
}