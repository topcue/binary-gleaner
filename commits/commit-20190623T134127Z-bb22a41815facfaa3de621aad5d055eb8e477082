{
  "sha": "bb22a41815facfaa3de621aad5d055eb8e477082",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YmIyMmE0MTgxNWZhY2ZhYTNkZTYyMWFhZDVkMDU1ZWI4ZTQ3NzA4Mg==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-06-23T02:58:39Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2019-06-23T13:41:27Z"
    },
    "message": "PR24704, Internal error building skiboot for powerpc64-linux-gnu\n\nWhile the skiboot linker script bears some culpability in this PR,\nit's also true that the GOT indirect to GOT relative optimisation for\n16-bit offsets isn't safe.  At least, it isn't safe to remove the GOT\nentry based on distance between the GOT pointer and symbol calculated\nfrom the preliminary layout.  So this patch removes that optimisation,\nand reduces the range allowed for 32-bit and 34-bit offsets.\n\n\tPR 24704\nbfd/\n\t* elf64-ppc.c (R_PPC64_GOT16_DS): Don't set has_gotrel.\n\t(ppc64_elf_edit_toc): Don't remove R_PPC64_GOT16_DS got entries.\n\tReduce range of offsets allowed for other GOT relocs.\nld/\n\t* testsuite/ld-powerpc/elfv2exe.d: Update.\n\t* testsuite/ld-powerpc/elfv2so.d: Update.",
    "tree": {
      "sha": "bd54a134f929ced282316e5a215330117f4bb728",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/bd54a134f929ced282316e5a215330117f4bb728"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/bb22a41815facfaa3de621aad5d055eb8e477082",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bb22a41815facfaa3de621aad5d055eb8e477082",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/bb22a41815facfaa3de621aad5d055eb8e477082",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bb22a41815facfaa3de621aad5d055eb8e477082/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "14b2a8e4244a29208ad430167860a0f01b20f215",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/14b2a8e4244a29208ad430167860a0f01b20f215",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/14b2a8e4244a29208ad430167860a0f01b20f215"
    }
  ],
  "stats": {
    "total": 61,
    "additions": 38,
    "deletions": 23
  },
  "files": [
    {
      "sha": "0914e7d633642bc6d102b959755eb8f6ac69592f",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb22a41815facfaa3de621aad5d055eb8e477082/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb22a41815facfaa3de621aad5d055eb8e477082/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=bb22a41815facfaa3de621aad5d055eb8e477082",
      "patch": "@@ -1,3 +1,10 @@\n+2019-06-23  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 24704\n+\t* elf64-ppc.c (R_PPC64_GOT16_DS): Don't set has_gotrel.\n+\t(ppc64_elf_edit_toc): Don't remove R_PPC64_GOT16_DS got entries.\n+\tReduce range of offsets allowed for other GOT relocs.\n+\n 2019-06-23  Alan Modra  <amodra@gmail.com>\n \n \tPR 24689"
    },
    {
      "sha": "c5c18d08233d075f6ceac8fcd0fb2eb9594ad2fc",
      "filename": "bfd/elf64-ppc.c",
      "status": "modified",
      "additions": 18,
      "deletions": 16,
      "changes": 34,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb22a41815facfaa3de621aad5d055eb8e477082/bfd/elf64-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb22a41815facfaa3de621aad5d055eb8e477082/bfd/elf64-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf64-ppc.c?ref=bb22a41815facfaa3de621aad5d055eb8e477082",
      "patch": "@@ -4610,14 +4610,14 @@ ppc64_elf_check_relocs (bfd *abfd, struct bfd_link_info *info,\n \t  sec->has_tls_reloc = 1;\n \t  goto dogot;\n \n-\tcase R_PPC64_GOT16_DS:\n \tcase R_PPC64_GOT16_HA:\n \tcase R_PPC64_GOT16_LO_DS:\n \tcase R_PPC64_GOT_PCREL34:\n \t  ppc64_elf_tdata (abfd)->has_gotrel = 1;\n \t  ppc64_elf_section_data (sec)->has_gotrel = 1;\n \t  /* Fall through.  */\n \n+\tcase R_PPC64_GOT16_DS:\n \tcase R_PPC64_GOT16:\n \tcase R_PPC64_GOT16_HI:\n \tcase R_PPC64_GOT16_LO:\n@@ -9010,10 +9010,15 @@ ppc64_elf_edit_toc (struct bfd_link_info *info)\n \t      r_type = ELF64_R_TYPE (rel->r_info);\n \t      switch (r_type)\n \t\t{\n+\t\t/* Note that we don't delete GOT entries for\n+\t\t   R_PPC64_GOT16_DS since we'd need a lot more\n+\t\t   analysis.  For starters, the preliminary layout is\n+\t\t   before the GOT, PLT, dynamic sections and stubs are\n+\t\t   laid out.  Then we'd need to allow for changes in\n+\t\t   distance between sections caused by alignment.  */\n \t\tdefault:\n \t\t  continue;\n \n-\t\tcase R_PPC64_GOT16_DS:\n \t\tcase R_PPC64_GOT16_HA:\n \t\tcase R_PPC64_GOT16_LO_DS:\n \t\t  sym_addend = rel->r_addend;\n@@ -9039,24 +9044,18 @@ ppc64_elf_edit_toc (struct bfd_link_info *info)\n \t      val += sym_addend;\n \t      val += sym_sec->output_section->vma + sym_sec->output_offset;\n \n+/* Fudge factor to allow for the fact that the preliminary layout\n+   isn't exact.  Reduce limits by this factor.  */\n+#define LIMIT_ADJUST(LIMIT) ((LIMIT) - (LIMIT) / 16)\n+\n \t      switch (r_type)\n \t\t{\n \t\tdefault:\n \t\t  continue;\n \n-\t\tcase R_PPC64_GOT16_DS:\n-\t\t  if (val - got + 0x8000 >= 0x10000)\n-\t\t    continue;\n-\t\t  if (!bfd_get_section_contents (ibfd, sec, buf,\n-\t\t\t\t\t\t rel->r_offset & ~3, 4))\n-\t\t    goto got_error_ret;\n-\t\t  insn = bfd_get_32 (ibfd, buf);\n-\t\t  if ((insn & (0x3f << 26 | 0x3)) != 58u << 26 /* ld */)\n-\t\t    continue;\n-\t\t  break;\n-\n \t\tcase R_PPC64_GOT16_HA:\n-\t\t  if (val - got + 0x80008000ULL >= 0x100000000ULL)\n+\t\t  if (val - got + LIMIT_ADJUST (0x80008000ULL)\n+\t\t      >= LIMIT_ADJUST (0x100000000ULL))\n \t\t    continue;\n \n \t\t  if (!bfd_get_section_contents (ibfd, sec, buf,\n@@ -9069,7 +9068,8 @@ ppc64_elf_edit_toc (struct bfd_link_info *info)\n \t\t  break;\n \n \t\tcase R_PPC64_GOT16_LO_DS:\n-\t\t  if (val - got + 0x80008000ULL >= 0x100000000ULL)\n+\t\t  if (val - got + LIMIT_ADJUST (0x80008000ULL)\n+\t\t      >= LIMIT_ADJUST (0x100000000ULL))\n \t\t    continue;\n \t\t  if (!bfd_get_section_contents (ibfd, sec, buf,\n \t\t\t\t\t\t rel->r_offset & ~3, 4))\n@@ -9082,7 +9082,8 @@ ppc64_elf_edit_toc (struct bfd_link_info *info)\n \t\tcase R_PPC64_GOT_PCREL34:\n \t\t  pc = rel->r_offset;\n \t\t  pc += sec->output_section->vma + sec->output_offset;\n-\t\t  if (val - pc + (1ULL << 33) >= 1ULL << 34)\n+\t\t  if (val - pc + LIMIT_ADJUST (1ULL << 33)\n+\t\t      >= LIMIT_ADJUST (1ULL << 34))\n \t\t    continue;\n \t\t  if (!bfd_get_section_contents (ibfd, sec, buf,\n \t\t\t\t\t\t rel->r_offset & ~3, 8))\n@@ -9095,6 +9096,7 @@ ppc64_elf_edit_toc (struct bfd_link_info *info)\n \t\t    continue;\n \t\t  break;\n \t\t}\n+#undef LIMIT_ADJUST\n \n \t      if (h != NULL)\n \t\tent = h->got.glist;"
    },
    {
      "sha": "6dcfe30696836eba186cb9bd4d01c69972aaa3a2",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb22a41815facfaa3de621aad5d055eb8e477082/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb22a41815facfaa3de621aad5d055eb8e477082/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=bb22a41815facfaa3de621aad5d055eb8e477082",
      "patch": "@@ -1,3 +1,9 @@\n+2019-06-23  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 24704\n+\t* testsuite/ld-powerpc/elfv2exe.d: Update.\n+\t* testsuite/ld-powerpc/elfv2so.d: Update.\n+\n 2019-06-14  Szabolcs Nagy  <szabolcs.nagy@arm.com>\n \n \t* testsuite/ld-aarch64/aarch64-elf.exp: Add emit-relocs-22 and -23."
    },
    {
      "sha": "0ccfcbf345a64caf8efdc627ef9b9d1632aa2f54",
      "filename": "ld/testsuite/ld-powerpc/elfv2exe.d",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb22a41815facfaa3de621aad5d055eb8e477082/ld/testsuite/ld-powerpc/elfv2exe.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb22a41815facfaa3de621aad5d055eb8e477082/ld/testsuite/ld-powerpc/elfv2exe.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/elfv2exe.d?ref=bb22a41815facfaa3de621aad5d055eb8e477082",
      "patch": "@@ -34,7 +34,7 @@ Disassembly of section \\.text:\n .*:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n .*:\t(4b .. .. ..|.. .. .. 4b) \tbl      .*\\.plt_branch\\.f2>\n .*:\t(60 00 00 00|00 00 00 60) \tnop\n-.*:\t(38 62 80 10|10 80 62 38) \taddi    r3,r2,-32752\n+.*:\t(38 62 80 18|18 80 62 38) \taddi    r3,r2,-32744\n .*:\t(48 .. .. ..|.. .. .. 48) \tbl      10008888 <f3>\n .*:\t(60 00 00 00|00 00 00 60) \tnop\n .*:\t(4b .. .. ..|.. .. .. 4b) \tbl      .*\\.plt_branch\\.f4>"
    },
    {
      "sha": "0162bd0880e0c1a57338fefc36c12d584ab1bc15",
      "filename": "ld/testsuite/ld-powerpc/elfv2so.d",
      "status": "modified",
      "additions": 6,
      "deletions": 6,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb22a41815facfaa3de621aad5d055eb8e477082/ld/testsuite/ld-powerpc/elfv2so.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb22a41815facfaa3de621aad5d055eb8e477082/ld/testsuite/ld-powerpc/elfv2so.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/elfv2so.d?ref=bb22a41815facfaa3de621aad5d055eb8e477082",
      "patch": "@@ -9,35 +9,35 @@ Disassembly of section \\.text:\n \n .* <.*\\.plt_call\\.f4>:\n .*:\t(f8 41 00 18|18 00 41 f8) \tstd     r2,24\\(r1\\)\n-.*:\t(e9 82 80 38|38 80 82 e9) \tld      r12,-32712\\(r2\\)\n+.*:\t(e9 82 80 40|40 80 82 e9) \tld      r12,-32704\\(r2\\)\n .*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n .*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n \t\\.\\.\\.\n \n .* <.*\\.plt_call\\.f3>:\n .*:\t(f8 41 00 18|18 00 41 f8) \tstd     r2,24\\(r1\\)\n-.*:\t(e9 82 80 28|28 80 82 e9) \tld      r12,-32728\\(r2\\)\n+.*:\t(e9 82 80 30|30 80 82 e9) \tld      r12,-32720\\(r2\\)\n .*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n .*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n \t\\.\\.\\.\n \n .* <.*\\.plt_call\\.f5>:\n .*:\t(f8 41 00 18|18 00 41 f8) \tstd     r2,24\\(r1\\)\n-.*:\t(e9 82 80 20|20 80 82 e9) \tld      r12,-32736\\(r2\\)\n+.*:\t(e9 82 80 28|28 80 82 e9) \tld      r12,-32728\\(r2\\)\n .*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n .*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n \t\\.\\.\\.\n \n .* <.*\\.plt_call\\.f1>:\n .*:\t(f8 41 00 18|18 00 41 f8) \tstd     r2,24\\(r1\\)\n-.*:\t(e9 82 80 40|40 80 82 e9) \tld      r12,-32704\\(r2\\)\n+.*:\t(e9 82 80 48|48 80 82 e9) \tld      r12,-32696\\(r2\\)\n .*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n .*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n \t\\.\\.\\.\n \n .* <.*\\.plt_call\\.f2>:\n .*:\t(f8 41 00 18|18 00 41 f8) \tstd     r2,24\\(r1\\)\n-.*:\t(e9 82 80 30|30 80 82 e9) \tld      r12,-32720\\(r2\\)\n+.*:\t(e9 82 80 38|38 80 82 e9) \tld      r12,-32712\\(r2\\)\n .*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n .*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n \t\\.\\.\\.\n@@ -52,7 +52,7 @@ Disassembly of section \\.text:\n .*:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n .*:\t(4b .. .. ..|.. .. .. 4b) \tbl      .*\\.plt_call\\.f2>\n .*:\t(e8 41 00 18|18 00 41 e8) \tld      r2,24\\(r1\\)\n-.*:\t(38 62 80 48|48 80 62 38) \taddi    r3,r2,-32696\n+.*:\t(38 62 80 50|50 80 62 38) \taddi    r3,r2,-32688\n .*:\t(4b .. .. ..|.. .. .. 4b) \tbl      .*\\.plt_call\\.f3>\n .*:\t(e8 41 00 18|18 00 41 e8) \tld      r2,24\\(r1\\)\n .*:\t(4b .. .. ..|.. .. .. 4b) \tbl      .*\\.plt_call\\.f4>"
    }
  ]
}