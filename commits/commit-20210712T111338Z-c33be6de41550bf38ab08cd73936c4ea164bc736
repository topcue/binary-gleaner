{
  "sha": "c33be6de41550bf38ab08cd73936c4ea164bc736",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YzMzYmU2ZGU0MTU1MGJmMzhhYjA4Y2Q3MzkzNmM0ZWExNjRiYzczNg==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-07-12T11:13:38Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-07-12T11:13:38Z"
    },
    "message": "[gdb/testsuite] Fix gdb.mi/mi-info-sources.exp for extra debug info\n\nWhen running test-case gdb.mi/mi-info-sources.exp, I run into:\n...\nRunning src/gdb/testsuite/gdb.mi/mi-info-sources.exp ...\nERROR: internal buffer is full.\n...\ndue to extra debug info from the shared libraries.\n\nFix this by using \"nosharedlibrary\".\n\nThen I run into these FAILs:\n...\nFAIL: gdb.mi/mi-info-sources.exp: debug_read=false: \\\n  -file-list-exec-source-files (unexpected output)\nFAIL: gdb.mi/mi-info-sources.exp: debug_read=true: \\\n  -file-list-exec-source-files (unexpected output)\nFAIL: gdb.mi/mi-info-sources.exp: debug_read=true: \\\n  -file-list-exec-source-files --group-by-objfile, look for \\\n  mi-info-sources.c (unexpected output)\nFAIL: gdb.mi/mi-info-sources.exp: debug_read=true: \\\n  -file-list-exec-source-files --group-by-objfile, look for \\\n  mi-info-sources-base.c (unexpected output)\n...\ndue to openSUSE executables which have debug info for objects from sources\nlike sysdeps/x86_64/crtn.S.\n\nFix these by updating the patterns, and adding \"maint expand-symtabs\" to\nreliably get fully-read objfiles.\n\nThen I run into FAILs when using the readnow target board.  Fix these by\nskipping the relevant tests.\n\nThen I run into FAILs when using the cc-with-gnu-debuglink board.  Fix these\nby updating the patterns.\n\nTested on x86_64-linux, with native, check-read1, readnow, cc-with-gdb-index,\ncc-with-debug-names, cc-with-gnu-debuglink, cc-with-dwz, cc-with-dwz-m.\n\ngdb/testsuite/ChangeLog:\n\n2021-07-05  Tom de Vries  <tdevries@suse.de>\n\n\t* lib/mi-support.exp (mi_readnow): New proc.\n\t* gdb.mi/mi-info-sources.exp: Use nosharedlibrary.  Update patterns.\n\tSkip tests for readnow.  Use \"maint expand-symtabs\".",
    "tree": {
      "sha": "5651f90e75a9a9ae699e98a43e7ff922446f1666",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/5651f90e75a9a9ae699e98a43e7ff922446f1666"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/c33be6de41550bf38ab08cd73936c4ea164bc736",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c33be6de41550bf38ab08cd73936c4ea164bc736",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/c33be6de41550bf38ab08cd73936c4ea164bc736",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c33be6de41550bf38ab08cd73936c4ea164bc736/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7790aa804e0ef9f93ca6037f4a19860c4291bd54",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7790aa804e0ef9f93ca6037f4a19860c4291bd54",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/7790aa804e0ef9f93ca6037f4a19860c4291bd54"
    }
  ],
  "stats": {
    "total": 101,
    "additions": 79,
    "deletions": 22
  },
  "files": [
    {
      "sha": "a43e939063aff997a0f40e24221b6c5e42fa6f32",
      "filename": "gdb/testsuite/gdb.mi/mi-info-sources.exp",
      "status": "modified",
      "additions": 51,
      "deletions": 22,
      "changes": 73,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c33be6de41550bf38ab08cd73936c4ea164bc736/gdb/testsuite/gdb.mi/mi-info-sources.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c33be6de41550bf38ab08cd73936c4ea164bc736/gdb/testsuite/gdb.mi/mi-info-sources.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.mi/mi-info-sources.exp?ref=c33be6de41550bf38ab08cd73936c4ea164bc736",
      "patch": "@@ -28,8 +28,14 @@ if {[prepare_for_testing $testfile.exp $testfile \\\n \n mi_clean_restart $binfile\n \n+set readnow_p [mi_readnow]\n+\n mi_runto_main\n \n+# Unload symbols for shared libraries to prevent\n+# 'ERROR: internal buffer is full'.\n+mi_gdb_test \"nosharedlibrary\" \".*\\\\^done\" \"nosharedlibrary\"\n+\n # Helper to build expected MI output pattern for a list.  NAME is the\n # name of the list (which can be the empty string) and args is one\n # or more strings representing the fields of the list, which will be\n@@ -108,27 +114,45 @@ proc check_info_sources { debug_fully_read } {\n     with_test_prefix \"debug_read=${debug_fully_read}\" {\n \n \tif { $debug_fully_read } {\n-\t    set p [mi_list \"files\" \\\n-\t\t       [mi_tuple \"\" \\\n-\t\t\t    [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n-\t\t\t    [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n-\t\t\t    [mi_field \"debug-fully-read\" \"${debug_fully_read}\"]] \\\n-\t\t       [mi_tuple \"\" \\\n-\t\t\t    [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n-\t\t\t    [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n-\t\t\t    [mi_field \"debug-fully-read\" \"true\"]]]\n+\t    set p1 \\\n+\t\t[mi_list \"files\" \\\n+\t\t     \".*\" \\\n+\t\t     [mi_tuple \"\" \\\n+\t\t\t  [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n+\t\t\t  [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n+\t\t\t  [mi_field \"debug-fully-read\" \"${debug_fully_read}\"]] \\\n+\t\t     \".*\"]\n+\t    set p2 \\\n+\t\t[mi_list \"files\" \\\n+\t\t     \".*\" \\\n+\t\t     [mi_tuple \"\" \\\n+\t\t\t  [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n+\t\t\t  [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n+\t\t\t  [mi_field \"debug-fully-read\" \"true\"]] \\\n+\t\t     \".*\"]\n \t} else {\n-\t    set p [mi_list \"files\" \\\n-\t\t       [mi_tuple \"\" \\\n-\t\t\t    [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n-\t\t\t    [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n-\t\t\t    [mi_field \"debug-fully-read\" \"true\"]] \\\n-\t\t       [mi_tuple \"\" \\\n-\t\t\t    [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n-\t\t\t    [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n-\t\t\t    [mi_field \"debug-fully-read\" \"${debug_fully_read}\"]]]\n+\t    set p1 \\\n+\t\t[mi_list \"files\" \\\n+\t\t     \".*\" \\\n+\t\t     [mi_tuple \"\" \\\n+\t\t\t  [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n+\t\t\t  [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources\\\\.c\"] \\\n+\t\t\t  [mi_field \"debug-fully-read\" \"true\"]] \\\n+\t\t     \".*\"]\n+\t    set p2 \\\n+\t\t[mi_list \"files\" \\\n+\t\t     \".*\" \\\n+\t\t     [mi_tuple \"\" \\\n+\t\t\t  [mi_field \"file\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n+\t\t\t  [mi_field \"fullname\" \"\\[^\\\"\\]+/mi-info-sources-base\\\\.c\"] \\\n+\t\t\t  [mi_field \"debug-fully-read\" \"${debug_fully_read}\"]] \\\n+\t\t     \".*\"]\n \t}\n-\tmi_gdb_test \"-file-list-exec-source-files\" \".*\\\\^done,${p}\" \"-file-list-exec-source-files\"\n+\n+\tmi_gdb_test \"-file-list-exec-source-files\" \".*\\\\^done,${p1}\" \\\n+\t    \"-file-list-exec-source-files, src1\"\n+\tmi_gdb_test \"-file-list-exec-source-files\" \".*\\\\^done,${p2}\" \\\n+\t    \"-file-list-exec-source-files, src2\"\n \n \tset p [mi_list \"files\" \\\n \t\t   [mi_tuple \"\" \\\n@@ -147,7 +171,7 @@ proc check_info_sources { debug_fully_read } {\n \n \tset p [mi_list \"files\" \\\n \t\t   [mi_tuple \"\" \\\n-\t\t\t[mi_field \"filename\" \"\\[^\\\"\\]+/mi-info-sources\"] \\\n+\t\t\t[mi_field \"filename\" \"\\[^\\\"\\]+/mi-info-sources(\\.debug)?\"] \\\n \t\t\t[mi_field \"debug-info\" \"${debug_info}\"] \\\n \t\t\t[mi_list \"sources\" \\\n \t\t\t     \".*\" \\\n@@ -162,7 +186,7 @@ proc check_info_sources { debug_fully_read } {\n \n \tset p [mi_list \"files\" \\\n \t\t   [mi_tuple \"\" \\\n-\t\t\t[mi_field \"filename\" \"\\[^\\\"\\]+/mi-info-sources\"] \\\n+\t\t\t[mi_field \"filename\" \"\\[^\\\"\\]+/mi-info-sources(\\.debug)?\"] \\\n \t\t\t[mi_field \"debug-info\" \"${debug_info}\"] \\\n \t\t\t[mi_list \"sources\" \\\n \t\t\t     \".*\" \\\n@@ -177,8 +201,13 @@ proc check_info_sources { debug_fully_read } {\n     }\n }\n \n-check_info_sources \"false\"\n+if { ! $readnow_p } {\n+    check_info_sources \"false\"\n+}\n \n mi_continue_to \"some_other_func\"\n \n+# Force \"fully-read\".\n+mi_gdb_test \"maint expand-symtabs\"\n+\n check_info_sources \"true\""
    },
    {
      "sha": "782900317637f5890fa8581ddd5b99a6ad5d0ee5",
      "filename": "gdb/testsuite/lib/mi-support.exp",
      "status": "modified",
      "additions": 28,
      "deletions": 0,
      "changes": 28,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c33be6de41550bf38ab08cd73936c4ea164bc736/gdb/testsuite/lib/mi-support.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c33be6de41550bf38ab08cd73936c4ea164bc736/gdb/testsuite/lib/mi-support.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/mi-support.exp?ref=c33be6de41550bf38ab08cd73936c4ea164bc736",
      "patch": "@@ -663,6 +663,34 @@ proc mi_gdb_load { arg } {\n     return 0\n }\n \n+# Return 1 if symbols were read in using -readnow.  Otherwise, return 0.\n+# Based on readnow from lib/gdb.exp.\n+\n+proc mi_readnow { args } {\n+    global mi_gdb_prompt\n+\n+    if { [llength $args] == 1 } {\n+\tset re [lindex $args 0]\n+    } else {\n+\tset re \"\"\n+    }\n+\n+    set readnow_p 0\n+    set cmd \"maint print objfiles $re\"\n+    send_gdb \"$cmd\\n\"\n+    gdb_expect {\n+\t-re \".gdb_index: faked for ..readnow..\" {\n+\t    # Record that we've seen the above pattern.\n+\t    set readnow_p 1\n+\t    exp_continue\n+\t}\n+\t-re \"\\\\^done\\r\\n$mi_gdb_prompt$\" {\n+\t}\n+    }\n+\n+    return $readnow_p\n+}\n+\n # mi_gdb_test COMMAND PATTERN MESSAGE [IPATTERN] -- send a command to gdb; \n #   test the result.\n #"
    }
  ]
}