{
  "sha": "a896df97b952d4f3feed8068eaa70147d12e0e28",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YTg5NmRmOTdiOTUyZDRmM2ZlZWQ4MDY4ZWFhNzAxNDdkMTJlMGUyOA==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-07-31T07:07:17Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-07-31T11:01:20Z"
    },
    "message": "PR26314, Linking LTO objects with symbols from static and shared libraries\n\ngcc -O2 -g -o ar -Wl,--as-needed arparse.o arlex.o ar.o not-ranlib.o arsup.o rename.o binemul.o emul_vanilla.o bucomm.o version.o filemode.o libbfd-2.35-3.fc33.so libiberty.a -Wl,-R,.\n\nAll of the above .o files are lto, leading to libbfd-2.35-3.fc33.so\nnot being found needed when loading the IR objects.  That's problem\nnumber one:  We exclude IR references when deciding a shared library\nis needed.  See PR15146.  Thus none of the libbfd.so symbols are\nloaded before libiberty.a is scanned, and libbfd.so contains copies of\nlibiberty.a functions.  We ought to be using the libbfd.so copies\nrather than extracting them from the archive (an object is extracted\neven to satisfy IR symbols).  After lto recompilation, libbfd.so is of\ncourse found to be needed and loaded.  But that causes more problems.\nThe lto recompilation didn't see symbol references from libbfd.so and\nvariables like _xexit_cleanup are made local in the recompiled\nobjects.  Oops, two copies of them.  Finally, those silly undefined\nsymbols in the lto output debug files, combined with definitions in\nboth libbfd.so and IR objects result in IR symbols being made\ndynamic.\n\nThe main fix here is to revert the PR15146 change to\nelf_link_add_object_symbols.\n\n\tPR 26314\n\t* elflink.c (bfd_elf_link_record_dynamic_symbol): Don't allow\n\tIR symbols to become dynamic.\n\t(elf_link_add_object_symbols): Don't exclude IR symbols when\n\tdeciding whether an as-needed shared library is needed.",
    "tree": {
      "sha": "335a44ef4a621355f6b43442ba8afada6b3fc447",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/335a44ef4a621355f6b43442ba8afada6b3fc447"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/a896df97b952d4f3feed8068eaa70147d12e0e28",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a896df97b952d4f3feed8068eaa70147d12e0e28",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/a896df97b952d4f3feed8068eaa70147d12e0e28",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a896df97b952d4f3feed8068eaa70147d12e0e28/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "223d5266dec459e04d99d1140cfb7c28900e1507",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/223d5266dec459e04d99d1140cfb7c28900e1507",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/223d5266dec459e04d99d1140cfb7c28900e1507"
    }
  ],
  "stats": {
    "total": 24,
    "additions": 19,
    "deletions": 5
  },
  "files": [
    {
      "sha": "d0a5916d378c03c72791914517390a52c8a2fae5",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a896df97b952d4f3feed8068eaa70147d12e0e28/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a896df97b952d4f3feed8068eaa70147d12e0e28/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=a896df97b952d4f3feed8068eaa70147d12e0e28",
      "patch": "@@ -1,3 +1,11 @@\n+2020-07-31  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 26314\n+\t* elflink.c (bfd_elf_link_record_dynamic_symbol): Don't allow\n+\tIR symbols to become dynamic.\n+\t(elf_link_add_object_symbols): Don't exclude IR symbols when\n+\tdeciding whether an as-needed shared library is needed.\n+\n 2020-07-30  Szabolcs Nagy  <szabolcs.nagy@arm.com>\n \n \tPR ld/26312"
    },
    {
      "sha": "0a7f5bb1528f7dc1f44e355ef1faa69929cdba5b",
      "filename": "bfd/elflink.c",
      "status": "modified",
      "additions": 11,
      "deletions": 5,
      "changes": 16,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a896df97b952d4f3feed8068eaa70147d12e0e28/bfd/elflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a896df97b952d4f3feed8068eaa70147d12e0e28/bfd/elflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elflink.c?ref=a896df97b952d4f3feed8068eaa70147d12e0e28",
      "patch": "@@ -505,6 +505,16 @@ bfd_elf_link_record_dynamic_symbol (struct bfd_link_info *info,\n       const char *name;\n       size_t indx;\n \n+      if (h->root.type == bfd_link_hash_defined\n+\t  || h->root.type == bfd_link_hash_defweak)\n+\t{\n+\t  /* An IR symbol should not be made dynamic.  */\n+\t  if (h->root.u.def.section != NULL\n+\t      && h->root.u.def.section->owner != NULL\n+\t      && (h->root.u.def.section->owner->flags & BFD_PLUGIN) != 0)\n+\t    return TRUE;\n+\t}\n+\n       /* XXX: The ABI draft says the linker must turn hidden and\n \t internal symbols into STB_LOCAL symbols when producing the\n \t DSO. However, if ld.so honors st_other in the dynamic table,\n@@ -5199,15 +5209,11 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t\tbreak;\n \t      }\n \n-\t  /* Don't add DT_NEEDED for references from the dummy bfd nor\n-\t     for unmatched symbol.  */\n \t  if (!add_needed\n \t      && matched\n \t      && definition\n \t      && ((dynsym\n-\t\t   && h->ref_regular_nonweak\n-\t\t   && (old_bfd == NULL\n-\t\t       || (old_bfd->flags & BFD_PLUGIN) == 0))\n+\t\t   && h->ref_regular_nonweak)\n \t\t  || (h->ref_dynamic_nonweak\n \t\t      && (elf_dyn_lib_class (abfd) & DYN_AS_NEEDED) != 0\n \t\t      && !on_needed_list (elf_dt_name (abfd),"
    }
  ]
}