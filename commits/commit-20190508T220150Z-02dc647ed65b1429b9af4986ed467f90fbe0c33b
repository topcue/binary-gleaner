{
  "sha": "02dc647ed65b1429b9af4986ed467f90fbe0c33b",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MDJkYzY0N2VkNjViMTQyOWI5YWY0OTg2ZWQ0NjdmOTBmYmUwYzMzYg==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-05-01T04:18:10Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-05-08T22:01:50Z"
    },
    "message": "Convert xcoffread.c to type-safe registry API\n\nThis changes xcoffread.c to use the type-safe registry API.  It also\nrenames coff_symfile_info to xcoff_symfile_info, to avoid any possible\nODR violation.\n\ngdb/ChangeLog\n2019-05-08  Tom Tromey  <tom@tromey.com>\n\n\t* xcoffread.c (struct xcoff_symfile_info): Rename from\n\tcoff_symfile_info.  Add initializers.\n\t(xcoff_objfile_data_key): Move lower.  Change type.\n\t(XCOFF_DATA): Rewrite.\n\t(xcoff_free_info): Remove.\n\t(xcoff_symfile_init, _initialize_xcoffread, read_xcoff_symtab)\n\t(read_symbol, read_symbol_lineno, find_linenos, init_stringtab)\n\t(xcoff_initial_scan): Update.",
    "tree": {
      "sha": "16362e209f6d22944f1340de667b67f924011df6",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/16362e209f6d22944f1340de667b67f924011df6"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/02dc647ed65b1429b9af4986ed467f90fbe0c33b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/02dc647ed65b1429b9af4986ed467f90fbe0c33b",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/02dc647ed65b1429b9af4986ed467f90fbe0c33b",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/02dc647ed65b1429b9af4986ed467f90fbe0c33b/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "092324387247f92c66f25a3e1927cf8821bb4943",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/092324387247f92c66f25a3e1927cf8821bb4943",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/092324387247f92c66f25a3e1927cf8821bb4943"
    }
  ],
  "stats": {
    "total": 68,
    "additions": 32,
    "deletions": 36
  },
  "files": [
    {
      "sha": "22b1afecf4ef76405864753b3bfaf61e477158ac",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/02dc647ed65b1429b9af4986ed467f90fbe0c33b/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/02dc647ed65b1429b9af4986ed467f90fbe0c33b/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=02dc647ed65b1429b9af4986ed467f90fbe0c33b",
      "patch": "@@ -1,3 +1,14 @@\n+2019-05-08  Tom Tromey  <tom@tromey.com>\n+\n+\t* xcoffread.c (struct xcoff_symfile_info): Rename from\n+\tcoff_symfile_info.  Add initializers.\n+\t(xcoff_objfile_data_key): Move lower.  Change type.\n+\t(XCOFF_DATA): Rewrite.\n+\t(xcoff_free_info): Remove.\n+\t(xcoff_symfile_init, _initialize_xcoffread, read_xcoff_symtab)\n+\t(read_symbol, read_symbol_lineno, find_linenos, init_stringtab)\n+\t(xcoff_initial_scan): Update.\n+\n 2019-05-08  Tom Tromey  <tom@tromey.com>\n \n \t* solib-svr4.c (struct svr4_info): Add initializers and"
    },
    {
      "sha": "215645d6e1192de80ca81bc690a536d4040a2bea",
      "filename": "gdb/xcoffread.c",
      "status": "modified",
      "additions": 21,
      "deletions": 36,
      "changes": 57,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/02dc647ed65b1429b9af4986ed467f90fbe0c33b/gdb/xcoffread.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/02dc647ed65b1429b9af4986ed467f90fbe0c33b/gdb/xcoffread.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/xcoffread.c?ref=02dc647ed65b1429b9af4986ed467f90fbe0c33b",
      "patch": "@@ -53,10 +53,6 @@\n #include \"aout/stab_gnu.h\"\n \n \f\n-/* Key for XCOFF-associated data.  */\n-\n-static const struct objfile_data *xcoff_objfile_data_key;\n-\n /* We put a pointer to this structure in the read_symtab_private field\n    of the psymtab.  */\n \n@@ -125,32 +121,35 @@ static CORE_ADDR first_object_file_end;\n \n static unsigned local_symesz;\n \n-struct coff_symfile_info\n+struct xcoff_symfile_info\n   {\n-    file_ptr min_lineno_offset;\t/* Where in file lowest line#s are.  */\n-    file_ptr max_lineno_offset;\t/* 1+last byte of line#s in file.  */\n+    file_ptr min_lineno_offset {};\t/* Where in file lowest line#s are.  */\n+    file_ptr max_lineno_offset {};\t/* 1+last byte of line#s in file.  */\n \n     /* Pointer to the string table.  */\n-    char *strtbl;\n+    char *strtbl = nullptr;\n \n     /* Pointer to debug section.  */\n-    char *debugsec;\n+    char *debugsec = nullptr;\n \n     /* Pointer to the a.out symbol table.  */\n-    char *symtbl;\n+    char *symtbl = nullptr;\n \n     /* Number of symbols in symtbl.  */\n-    int symtbl_num_syms;\n+    int symtbl_num_syms = 0;\n \n     /* Offset in data section to TOC anchor.  */\n-    CORE_ADDR toc_offset;\n+    CORE_ADDR toc_offset = 0;\n   };\n \n+/* Key for XCOFF-associated data.  */\n+\n+static const struct objfile_key<xcoff_symfile_info> xcoff_objfile_data_key;\n+\n /* Convenience macro to access the per-objfile XCOFF data.  */\n \n #define XCOFF_DATA(objfile)\t\t\t\t\t\t\\\n-  ((struct coff_symfile_info *) objfile_data ((objfile),\t\t\\\n-\t\t\t\t\t      xcoff_objfile_data_key))\n+  xcoff_objfile_data_key.get (objfile)\n \n /* XCOFF names for dwarf sections.  There is no compressed sections.  */\n \n@@ -1006,7 +1005,7 @@ read_xcoff_symtab (struct objfile *objfile, struct partial_symtab *pst)\n {\n   bfd *abfd = objfile->obfd;\n   char *raw_auxptr;\t\t/* Pointer to first raw aux entry for sym.  */\n-  struct coff_symfile_info *xcoff = XCOFF_DATA (objfile);\n+  struct xcoff_symfile_info *xcoff = XCOFF_DATA (objfile);\n   char *strtbl = xcoff->strtbl;\n   char *debugsec = xcoff->debugsec;\n   const char *debugfmt = bfd_xcoff_is_xcoff64 (abfd) ? \"XCOFF64\" : \"XCOFF\";\n@@ -1710,7 +1709,7 @@ coff_getfilename (union internal_auxent *aux_entry, struct objfile *objfile)\n static void\n read_symbol (struct internal_syment *symbol, int symno)\n {\n-  struct coff_symfile_info *xcoff = XCOFF_DATA (this_symtab_objfile);\n+  struct xcoff_symfile_info *xcoff = XCOFF_DATA (this_symtab_objfile);\n   int nsyms = xcoff->symtbl_num_syms;\n   char *stbl = xcoff->symtbl;\n \n@@ -1747,7 +1746,7 @@ read_symbol_lineno (int symno)\n   struct objfile *objfile = this_symtab_objfile;\n   int xcoff64 = bfd_xcoff_is_xcoff64 (objfile->obfd);\n \n-  struct coff_symfile_info *info = XCOFF_DATA (objfile);\n+  struct xcoff_symfile_info *info = XCOFF_DATA (objfile);\n   int nsyms = info->symtbl_num_syms;\n   char *stbl = info->symtbl;\n   char *strtbl = info->strtbl;\n@@ -1813,7 +1812,7 @@ read_symbol_lineno (int symno)\n static void\n find_linenos (struct bfd *abfd, struct bfd_section *asect, void *vpinfo)\n {\n-  struct coff_symfile_info *info;\n+  struct xcoff_symfile_info *info;\n   int size, count;\n   file_ptr offset, maxoff;\n \n@@ -1823,7 +1822,7 @@ find_linenos (struct bfd *abfd, struct bfd_section *asect, void *vpinfo)\n     return;\n \n   size = count * coff_data (abfd)->local_linesz;\n-  info = (struct coff_symfile_info *) vpinfo;\n+  info = (struct xcoff_symfile_info *) vpinfo;\n   offset = asect->line_filepos;\n   maxoff = offset + size;\n \n@@ -1934,11 +1933,8 @@ xcoff_new_init (struct objfile *objfile)\n static void\n xcoff_symfile_init (struct objfile *objfile)\n {\n-  struct coff_symfile_info *xcoff;\n-\n   /* Allocate struct to keep track of the symfile.  */\n-  xcoff = XNEW (struct coff_symfile_info);\n-  set_objfile_data (objfile, xcoff_objfile_data_key, xcoff);\n+  xcoff_objfile_data_key.emplace (objfile);\n \n   /* XCOFF objects may be reordered, so set OBJF_REORDERED.  If we\n      find this causes a significant slowdown in gdb then we could\n@@ -1971,7 +1967,7 @@ init_stringtab (bfd *abfd, file_ptr offset, struct objfile *objfile)\n   int val;\n   unsigned char lengthbuf[4];\n   char *strtbl;\n-  struct coff_symfile_info *xcoff = XCOFF_DATA (objfile);\n+  struct xcoff_symfile_info *xcoff = XCOFF_DATA (objfile);\n \n   xcoff->strtbl = NULL;\n \n@@ -2925,7 +2921,7 @@ xcoff_initial_scan (struct objfile *objfile, symfile_add_flags symfile_flags)\n   int num_symbols;\t\t/* # of symbols */\n   file_ptr symtab_offset;\t/* symbol table and */\n   file_ptr stringtab_offset;\t/* string table file offsets */\n-  struct coff_symfile_info *info;\n+  struct xcoff_symfile_info *info;\n   const char *name;\n   unsigned int size;\n \n@@ -3143,19 +3139,8 @@ xcoff_get_n_import_files (bfd *abfd)\n   return l_nimpid - 1;\n }\n \n-/* Free the per-objfile xcoff data.  */\n-\n-static void\n-xcoff_free_info (struct objfile *objfile, void *arg)\n-{\n-  xfree (arg);\n-}\n-\n void\n _initialize_xcoffread (void)\n {\n   add_symtab_fns (bfd_target_xcoff_flavour, &xcoff_sym_fns);\n-\n-  xcoff_objfile_data_key = register_objfile_data_with_cleanup (NULL,\n-\t\t\t\t\t\t\t       xcoff_free_info);\n }"
    }
  ]
}