{
  "sha": "cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6Y2QwOWFiN2M3NDYzZDA1ZmUyN2UzZGFiNGY5N2JiOGFhNjU3MDQxMw==",
  "commit": {
    "author": {
      "name": "Mike Frysinger",
      "email": "vapier@gentoo.org",
      "date": "2021-04-27T03:14:11Z"
    },
    "committer": {
      "name": "Mike Frysinger",
      "email": "vapier@gentoo.org",
      "date": "2021-05-05T01:47:10Z"
    },
    "message": "sim: microblaze: hook up libgloss syscalls\n\nWhen in the virtual environment, have brki 8 trigger libgloss syscalls\nlike other ports.  This also matches the ABI that Linux uses for its\nsyscalls (ignoring the syscall table differences).",
    "tree": {
      "sha": "3e957d821a94ec5ddddcacd8e36c6a9479f38e65",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3e957d821a94ec5ddddcacd8e36c6a9479f38e65"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/comments",
  "author": {
    "login": "vapier",
    "id": 176950,
    "node_id": "MDQ6VXNlcjE3Njk1MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vapier",
    "html_url": "https://github.com/vapier",
    "followers_url": "https://api.github.com/users/vapier/followers",
    "following_url": "https://api.github.com/users/vapier/following{/other_user}",
    "gists_url": "https://api.github.com/users/vapier/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vapier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vapier/subscriptions",
    "organizations_url": "https://api.github.com/users/vapier/orgs",
    "repos_url": "https://api.github.com/users/vapier/repos",
    "events_url": "https://api.github.com/users/vapier/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vapier/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vapier",
    "id": 176950,
    "node_id": "MDQ6VXNlcjE3Njk1MA==",
    "avatar_url": "https://avatars.githubusercontent.com/u/176950?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vapier",
    "html_url": "https://github.com/vapier",
    "followers_url": "https://api.github.com/users/vapier/followers",
    "following_url": "https://api.github.com/users/vapier/following{/other_user}",
    "gists_url": "https://api.github.com/users/vapier/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vapier/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vapier/subscriptions",
    "organizations_url": "https://api.github.com/users/vapier/orgs",
    "repos_url": "https://api.github.com/users/vapier/repos",
    "events_url": "https://api.github.com/users/vapier/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vapier/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "13ffdac36f589830863b10c760b79ab7809e1b12",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/13ffdac36f589830863b10c760b79ab7809e1b12",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/13ffdac36f589830863b10c760b79ab7809e1b12"
    }
  ],
  "stats": {
    "total": 58,
    "additions": 54,
    "deletions": 4
  },
  "files": [
    {
      "sha": "8300491731d6100b8a6076333299cd33ecba9a9c",
      "filename": "sim/microblaze/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/microblaze/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/microblaze/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/microblaze/ChangeLog?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -1,3 +1,8 @@\n+2021-05-04  Mike Frysinger  <vapier@gentoo.org>\n+\n+\t* interp.c: Include sim-syscall.h.\n+\t(sim_engine_run): Call sim_syscall for brki instructions.\n+\n 2021-05-04  Mike Frysinger  <vapier@gentoo.org>\n \n \t* configure: Regenerate."
    },
    {
      "sha": "129291895d1cc9ed9089f85cd5cd0e152d84dc13",
      "filename": "sim/microblaze/interp.c",
      "status": "modified",
      "additions": 13,
      "deletions": 2,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/microblaze/interp.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/microblaze/interp.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/microblaze/interp.c?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -28,6 +28,7 @@\n \n #include \"sim-main.h\"\n #include \"sim-options.h\"\n+#include \"sim-syscall.h\"\n \n #include \"microblaze-dis.h\"\n \n@@ -284,8 +285,18 @@ sim_engine_run (SIM_DESC sd,\n \t\t    IMM_ENABLE = 0;\n \t        }\n \t      else\n-\t\t/* no delay slot: increment cycle count */\n-\t\tbonus_cycles++;\n+\t\t{\n+\t\t  if (op == brki && IMM == 8)\n+\t\t    {\n+\t\t      RETREG = sim_syscall (cpu, CPU.regs[12], CPU.regs[5],\n+\t\t\t\t\t    CPU.regs[6], CPU.regs[7],\n+\t\t\t\t\t    CPU.regs[8]);\n+\t\t      PC = RD + INST_SIZE;\n+\t\t    }\n+\n+\t\t  /* no delay slot: increment cycle count */\n+\t\t  bonus_cycles++;\n+\t\t}\n \t    }\n \t}\n "
    },
    {
      "sha": "205646e8a2e001420f7466db9ffe148d01cfa7ef",
      "filename": "sim/testsuite/microblaze/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/testsuite/microblaze/ChangeLog?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -1,3 +1,11 @@\n+2021-05-04  Mike Frysinger  <vapier@gentoo.org>\n+\n+\t* pass.s: Delete output line.\n+\t* testutils.inc (system_call, write): New macros.\n+\t(exit): Mark nr required.\n+\t(pass, fail): Call write\n+\t* fail.s: New test.\n+\n 2021-04-08  Mike Frysinger  <vapier@gentoo.org>\n \n \t* allinsn.exp (arch): Delete."
    },
    {
      "sha": "f9bbe3c311c69bd3f1615c85220be5ac46df2a37",
      "filename": "sim/testsuite/microblaze/fail.s",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/fail.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/fail.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/testsuite/microblaze/fail.s?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -0,0 +1,9 @@\n+# check that the sim doesn't die immediately.\n+# mach: microblaze\n+# status: 1\n+# output: fail\\n\n+\n+.include \"testutils.inc\"\n+\n+\tstart\n+\tfail"
    },
    {
      "sha": "36179745c86acd16c33176e9b9ed7614aeca6db8",
      "filename": "sim/testsuite/microblaze/pass.s",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/pass.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/pass.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/testsuite/microblaze/pass.s?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -1,6 +1,5 @@\n # check that the sim doesn't die immediately.\n # mach: microblaze\n-# output:\n \n .include \"testutils.inc\"\n "
    },
    {
      "sha": "f222be9dccdc3d95b96778325c40c6b008287227",
      "filename": "sim/testsuite/microblaze/testutils.inc",
      "status": "modified",
      "additions": 19,
      "deletions": 1,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/testutils.inc",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd09ab7c7463d05fe27e3dab4f97bb8aa6570413/sim/testsuite/microblaze/testutils.inc",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/sim/testsuite/microblaze/testutils.inc?ref=cd09ab7c7463d05fe27e3dab4f97bb8aa6570413",
      "patch": "@@ -1,12 +1,20 @@\n+# MACRO: system_call\n+# Make a libgloss/Linux system call\n+\t.macro system_call nr:req\n+\taddi r12, r0, \\nr;\n+\tbrki r14, 8;\n+\t.endm\n+\n # MACRO: exit\n-\t.macro exit nr\n+\t.macro exit nr:req\n \taddi r3, r0, \\nr;\n \tbri 0;\n \t.endm\n \n # MACRO: pass\n # Write 'pass' to stdout and quit\n \t.macro pass\n+\twrite 1, 1f, 5\n \texit 0\n \t.data\n \t1: .asciz \"pass\\n\"\n@@ -15,6 +23,7 @@\n # MACRO: fail\n # Write 'fail' to stdout and quit\n \t.macro fail\n+\twrite 1, 1f, 5\n \texit 1\n \t.data\n \t1: .asciz \"fail\\n\"\n@@ -27,3 +36,12 @@\n .global _start\n _start:\n \t.endm\n+\n+# MACRO: write\n+# Just like the write() C function; uses system calls\n+\t.macro write fd:req, buf:req, count:req\n+\taddi r5, r0, \\fd;\n+\taddi r6, r0, \\buf;\n+\taddi r7, r0, \\count;\n+\tsystem_call 5\n+\t.endm"
    }
  ]
}