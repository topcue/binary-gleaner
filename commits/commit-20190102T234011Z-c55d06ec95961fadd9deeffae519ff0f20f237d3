{
  "sha": "c55d06ec95961fadd9deeffae519ff0f20f237d3",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YzU1ZDA2ZWM5NTk2MWZhZGQ5ZGVlZmZhZTUxOWZmMGYyMGYyMzdkMw==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-01-02T15:03:13Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-01-02T23:40:11Z"
    },
    "message": "Remove a cleanup from target-descriptions.c\n\nThis removes a cleanup from target-descriptions.c, by changing it to\nuse a unique_ptr instead.  Note that a deletion adapter is used, even\nthough target_desc is allocated with new, to avoid moving target_desc\nto target-descriptions.h.\n\ngdb/ChangeLog\n2019-01-02  Tom Tromey  <tom@tromey.com>\n\n\t* xml-tdesc.c (xml_cache): Hold a target_desc_up.\n\t(tdesc_parse_xml): Remove cleanups.\n\t* target-descriptions.h (make_cleanup_free_target_description):\n\tDon't declare.\n\t(target_desc_deleter): New struct.\n\t(target_desc_up): New typedef.\n\t* target-descriptions.c (target_desc_deleter::operator()): Rename\n\tfrom free_target_description.\n\t(make_cleanup_free_target_description): Remove.",
    "tree": {
      "sha": "d29af475537221052acb1202b40769ddf1491a9a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/d29af475537221052acb1202b40769ddf1491a9a"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/c55d06ec95961fadd9deeffae519ff0f20f237d3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c55d06ec95961fadd9deeffae519ff0f20f237d3",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/c55d06ec95961fadd9deeffae519ff0f20f237d3",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c55d06ec95961fadd9deeffae519ff0f20f237d3/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "3a6ae42d4e4ecfd2441cf9b978b2a54ad6767cb7",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3a6ae42d4e4ecfd2441cf9b978b2a54ad6767cb7",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/3a6ae42d4e4ecfd2441cf9b978b2a54ad6767cb7"
    }
  ],
  "stats": {
    "total": 50,
    "additions": 31,
    "deletions": 19
  },
  "files": [
    {
      "sha": "92ba43d7af96f1ae56cc3a25ffa89fa279515261",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=c55d06ec95961fadd9deeffae519ff0f20f237d3",
      "patch": "@@ -1,3 +1,15 @@\n+2019-01-02  Tom Tromey  <tom@tromey.com>\n+\n+\t* xml-tdesc.c (xml_cache): Hold a target_desc_up.\n+\t(tdesc_parse_xml): Remove cleanups.\n+\t* target-descriptions.h (make_cleanup_free_target_description):\n+\tDon't declare.\n+\t(target_desc_deleter): New struct.\n+\t(target_desc_up): New typedef.\n+\t* target-descriptions.c (target_desc_deleter::operator()): Rename\n+\tfrom free_target_description.\n+\t(make_cleanup_free_target_description): Remove.\n+\n 2019-01-02  Tom Tromey  <tom@tromey.com>\n \n \t* linespec.c (struct linespec_parser): Rename from ls_parser.  Add"
    },
    {
      "sha": "f04b8fc31698e9f43d4f44d3d78644c234292e06",
      "filename": "gdb/target-descriptions.c",
      "status": "modified",
      "additions": 2,
      "deletions": 10,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/target-descriptions.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/target-descriptions.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/target-descriptions.c?ref=c55d06ec95961fadd9deeffae519ff0f20f237d3",
      "patch": "@@ -1138,20 +1138,12 @@ allocate_target_description (void)\n   return new target_desc ();\n }\n \n-static void\n-free_target_description (void *arg)\n+void\n+target_desc_deleter::operator() (struct target_desc *target_desc) const\n {\n-  struct target_desc *target_desc = (struct target_desc *) arg;\n-\n   delete target_desc;\n }\n \n-struct cleanup *\n-make_cleanup_free_target_description (struct target_desc *target_desc)\n-{\n-  return make_cleanup (free_target_description, target_desc);\n-}\n-\n void\n tdesc_add_compatible (struct target_desc *target_desc,\n \t\t      const struct bfd_arch_info *compatible)"
    },
    {
      "sha": "fe07d425a5f9620ca6f53fa6da251a3af63b5063",
      "filename": "gdb/target-descriptions.h",
      "status": "modified",
      "additions": 12,
      "deletions": 1,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/target-descriptions.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/target-descriptions.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/target-descriptions.h?ref=c55d06ec95961fadd9deeffae519ff0f20f237d3",
      "patch": "@@ -199,9 +199,20 @@ struct type *tdesc_find_type (struct gdbarch *gdbarch, const char *id);\n int tdesc_register_in_reggroup_p (struct gdbarch *gdbarch, int regno,\n \t\t\t\t  struct reggroup *reggroup);\n \n+\n+/* A deleter adapter for a target desc.  */\n+\n+struct target_desc_deleter\n+{\n+  void operator() (struct target_desc *desc) const;\n+};\n+\n+/* A unique pointer specialization that holds a target_desc.  */\n+\n+typedef std::unique_ptr<target_desc, target_desc_deleter> target_desc_up;\n+\n /* Methods for constructing a target description.  */\n \n-struct cleanup *make_cleanup_free_target_description (struct target_desc *);\n void set_tdesc_architecture (struct target_desc *,\n \t\t\t     const struct bfd_arch_info *);\n void set_tdesc_osabi (struct target_desc *, enum gdb_osabi osabi);"
    },
    {
      "sha": "7588cb0f99f45562de1a3a33588b7e1eaad40469",
      "filename": "gdb/xml-tdesc.c",
      "status": "modified",
      "additions": 5,
      "deletions": 8,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/xml-tdesc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c55d06ec95961fadd9deeffae519ff0f20f237d3/gdb/xml-tdesc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/xml-tdesc.c?ref=c55d06ec95961fadd9deeffae519ff0f20f237d3",
      "patch": "@@ -66,7 +66,7 @@ tdesc_parse_xml (const char *document, xml_fetch_another fetcher,\n    then we will create unnecessary duplicate gdbarches.  See\n    gdbarch_list_lookup_by_info.  */\n \n-static std::unordered_map<std::string, target_desc *> xml_cache;\n+static std::unordered_map<std::string, target_desc_up> xml_cache;\n \n /* Callback data for target description parsing.  */\n \n@@ -637,25 +637,22 @@ tdesc_parse_xml (const char *document, xml_fetch_another fetcher,\n      previously parsed.  */\n   const auto it = xml_cache.find (expanded_text);\n   if (it != xml_cache.end ())\n-    return it->second;\n+    return it->second.get ();\n \n   memset (&data, 0, sizeof (struct tdesc_parsing_data));\n-  data.tdesc = allocate_target_description ();\n-  struct cleanup *result_cleanup\n-    = make_cleanup_free_target_description (data.tdesc);\n+  target_desc_up description (allocate_target_description ());\n+  data.tdesc = description.get ();\n \n   if (gdb_xml_parse_quick (_(\"target description\"), \"gdb-target.dtd\",\n \t\t\t   tdesc_elements, expanded_text.c_str (), &data) == 0)\n     {\n       /* Parsed successfully.  */\n-      xml_cache.emplace (std::move (expanded_text), data.tdesc);\n-      discard_cleanups (result_cleanup);\n+      xml_cache.emplace (std::move (expanded_text), std::move (description));\n       return data.tdesc;\n     }\n   else\n     {\n       warning (_(\"Could not load XML target description; ignoring\"));\n-      do_cleanups (result_cleanup);\n       return NULL;\n     }\n }"
    }
  ]
}