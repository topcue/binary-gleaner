{
  "sha": "235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MjM1ZjVlZjRhNmI4ZmJkY2ZhZWE4YjYyOWY3YzZhOTc5MmE3ODlkZQ==",
  "commit": {
    "author": {
      "name": "Michael Matz",
      "email": "matz@suse.de",
      "date": "2021-06-28T15:57:17Z"
    },
    "committer": {
      "name": "Michael Matz",
      "email": "matz@suse.de",
      "date": "2021-07-06T13:49:03Z"
    },
    "message": "elf/riscv: Fix relaxation with aliases [PR28021]\n\nthe fix for PR22756 only changed behaviour for hidden aliases,\nbut the same situation exists for non-hidden aliases: sym_hashes[]\ncan contain multiple entries pointing to the same symbol structure\nleading to relaxation adjustment to be applied twice.\n\nFix this by testing for duplicates for everything that looks like it\nhas a version.\n\nPR ld/28021\n\nbfd/\n\t* elfnn-riscv.c (riscv_relax_delete_bytes): Check for any\n\tversioning.\n\nld/\n\t* testsuite/ld-riscv-elf/relax-twice.ver: New.\n\t* testsuite/ld-riscv-elf/relax-twice-1.s: New.\n\t* testsuite/ld-riscv-elf/relax-twice-2.s: New.\n\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp\n\t(run_relax_twice_test): New, and call it.",
    "tree": {
      "sha": "147f3a5973fd72d560102b3689083714b5b1326c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/147f3a5973fd72d560102b3689083714b5b1326c"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/comments",
  "author": {
    "login": "susematz",
    "id": 4117296,
    "node_id": "MDQ6VXNlcjQxMTcyOTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4117296?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/susematz",
    "html_url": "https://github.com/susematz",
    "followers_url": "https://api.github.com/users/susematz/followers",
    "following_url": "https://api.github.com/users/susematz/following{/other_user}",
    "gists_url": "https://api.github.com/users/susematz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/susematz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/susematz/subscriptions",
    "organizations_url": "https://api.github.com/users/susematz/orgs",
    "repos_url": "https://api.github.com/users/susematz/repos",
    "events_url": "https://api.github.com/users/susematz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/susematz/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "susematz",
    "id": 4117296,
    "node_id": "MDQ6VXNlcjQxMTcyOTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4117296?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/susematz",
    "html_url": "https://github.com/susematz",
    "followers_url": "https://api.github.com/users/susematz/followers",
    "following_url": "https://api.github.com/users/susematz/following{/other_user}",
    "gists_url": "https://api.github.com/users/susematz/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/susematz/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/susematz/subscriptions",
    "organizations_url": "https://api.github.com/users/susematz/orgs",
    "repos_url": "https://api.github.com/users/susematz/repos",
    "events_url": "https://api.github.com/users/susematz/events{/privacy}",
    "received_events_url": "https://api.github.com/users/susematz/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "46f2c22eabb3d2b13ed56f528a4f45dc5e8f3a32",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/46f2c22eabb3d2b13ed56f528a4f45dc5e8f3a32",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/46f2c22eabb3d2b13ed56f528a4f45dc5e8f3a32"
    }
  ],
  "stats": {
    "total": 125,
    "additions": 124,
    "deletions": 1
  },
  "files": [
    {
      "sha": "7591469681035b17ed7a590a097f0b115969ab81",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -1,3 +1,9 @@\n+2021-07-06  Michael Matz  <matz@suse.de>\n+\n+\tPR ld/28021\n+\t* elfnn-riscv.c (riscv_relax_delete_bytes): Check for any\n+\tversioning.\n+\n 2021-07-06  Alan Modra  <amodra@gmail.com>\n \n \tPR 28055"
    },
    {
      "sha": "85a99f3d610523b351a13f4cc10ca36d4512a6c1",
      "filename": "bfd/elfnn-riscv.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/bfd/elfnn-riscv.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/bfd/elfnn-riscv.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfnn-riscv.c?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -3995,7 +3995,7 @@ riscv_relax_delete_bytes (bfd *abfd, asection *sec, bfd_vma addr, size_t count,\n \t foo becomes an alias for foo@BAR, and hence they need the same\n \t treatment.  */\n       if (link_info->wrap_hash != NULL\n-\t  || sym_hash->versioned == versioned_hidden)\n+\t  || sym_hash->versioned != unversioned)\n \t{\n \t  struct elf_link_hash_entry **cur_sym_hashes;\n "
    },
    {
      "sha": "22e751ed855027848ba60faa648edaa038afc06c",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -1,3 +1,12 @@\n+2021-07-06  Michael Matz  <matz@suse.de>\n+\n+\tPR ld/28021\n+\t* testsuite/ld-riscv-elf/relax-twice.ver: New.\n+\t* testsuite/ld-riscv-elf/relax-twice-1.s: New.\n+\t* testsuite/ld-riscv-elf/relax-twice-2.s: New.\n+\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp\n+\t(run_relax_twice_test): New, and call it.\n+\n 2021-07-03  Nick Clifton  <nickc@redhat.com>\n \n \t* configure: Regenerate."
    },
    {
      "sha": "119776117337f0c697b55857fedee16c7b989f7d",
      "filename": "ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "status": "modified",
      "additions": 41,
      "deletions": 0,
      "changes": 41,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -78,6 +78,46 @@ proc run_dump_test_ifunc { name target output} {\n \t      \"$name-$target.$ext\"]]\n }\n \n+proc run_relax_twice_test {} {\n+    global as\n+    global ld\n+    global nm\n+    global nm_output\n+    global srcdir\n+    global subdir\n+    global runtests\n+\n+    set testname \"relax-twice\"\n+    if ![runtest_file_p $runtests $testname] then {\n+\treturn\n+    }\n+\n+    # assemble and link the two input files with a version script, then\n+    # capture output of nm and compare addresses of the two symbols\n+    # 'foobar_new' and 'foobar@@New'.  They must be equal.\n+    # Bitness doesn't matter so we simply force 64bit.\n+    if { ![ld_assemble_flags $as \"-march=rv64i\" $srcdir/$subdir/relax-twice-1.s tmpdir/relax-twice-1.o ]\n+\t|| ![ld_assemble_flags $as \"-march=rv64i\" $srcdir/$subdir/relax-twice-2.s tmpdir/relax-twice-2.o]\n+\t|| ![ld_link $ld tmpdir/relax-twice.so \"-m[riscv_choose_lp64_emul] -shared --relax --version-script $srcdir/$subdir/relax-twice.ver tmpdir/relax-twice-1.o tmpdir/relax-twice-2.o\"] } {\n+\tfail $testname\n+    } elseif { ![ld_nm $nm \"\" tmpdir/relax-twice.so] } {\n+\tfail $testname\n+    } elseif { ![info exists nm_output(foobar_new)]\n+\t       || ![info exists nm_output(foobar@@New)]} {\n+\tsend_log \"bad output from nm\\n\"\n+\tverbose \"bad output from nm\"\n+\tfail $testname\n+    } elseif {$nm_output(foobar_new) != $nm_output(foobar@@New)} {\n+\tsend_log \"foobar_new == $nm_output(foobar_new)\\n\"\n+\tverbose \"foobar_new == $nm_output(foobar_new)\"\n+\tsend_log \"foobar@@New == $nm_output(foobar@@New)\\n\"\n+\tverbose \"foobar@@New == $nm_output(foobar@@New)\"\n+\tfail $testname\n+    } else {\n+\tpass $testname\n+    }\n+}\n+\n if [istarget \"riscv*-*-*\"] {\n     run_dump_test \"call-relax\"\n     run_dump_test \"pcgp-relax\"\n@@ -128,6 +168,7 @@ if [istarget \"riscv*-*-*\"] {\n \n     run_dump_test \"relro-relax-lui\"\n     run_dump_test \"relro-relax-pcrel\"\n+    run_relax_twice_test\n \n     set abis [list rv32gc ilp32 [riscv_choose_ilp32_emul] rv64gc lp64 [riscv_choose_lp64_emul]]\n     foreach { arch abi emul } $abis {"
    },
    {
      "sha": "79f1d942f9884a45c32c4efc8d85c7af51212c0b",
      "filename": "ld/testsuite/ld-riscv-elf/relax-twice-1.s",
      "status": "added",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice-1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice-1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/relax-twice-1.s?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -0,0 +1,12 @@\n+\t.file\t\"<artificial>\"\n+\t.option pic\n+\t.text\n+\t.globl\tfoobar_new\n+\t.weak\tfoobar_new\n+\t.type\tfoobar_new, @function\n+foobar_new:\n+\tjr ra\n+\t.size\tfoobar_new, .-foobar_new\n+\t.symver\tfoobar_new, foobar@@New\n+\n+\t.section\t.note.GNU-stack,\"\",@progbits"
    },
    {
      "sha": "39b82b50d1962dec779500df12135f6fe904faec",
      "filename": "ld/testsuite/ld-riscv-elf/relax-twice-2.s",
      "status": "added",
      "additions": 44,
      "deletions": 0,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice-2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice-2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/relax-twice-2.s?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -0,0 +1,44 @@\n+\t.file\t\"<artificial>\"\n+\t.option pic\n+\t.text\n+\t.section\t.rodata.str1.8,\"aMS\",@progbits,1\n+\t.align\t3\n+.LC0:\n+\t.string\t\"%u\"\n+\t.text\n+\t.align\t1\n+\t.globl\trelaxme\n+\t.type\trelaxme, @function\n+relaxme:\n+\taddi\tsp,sp,-32\n+\taddi\ta2,sp,12\n+\tlla\ta1,.LC0\n+\tli\ta0,0\n+\tsd\tra,24(sp)\n+\tcall\tsscanf@plt\n+\tld\tra,24(sp)\n+\taddi\tsp,sp,32\n+\tjr\tra\n+\t.size\trelaxme, .-relaxme\n+\t.align\t1\n+\t.globl\tfoobar_new\n+\t.type\tfoobar_new, @function\n+foobar_new:\n+\tli\ta0,1\n+\tret\n+\t.size\tfoobar_new, .-foobar_new\n+\t.symver\tfoobar_new, foobar@@New\n+\t.align\t1\n+\t.globl\tfoobar_old\n+\t.type\tfoobar_old, @function\n+foobar_old:\n+\taddi\tsp,sp,-16\n+\tsd\tra,8(sp)\n+\tcall\tfoobar@plt\n+\tld\tra,8(sp)\n+\tsnez\ta0,a0\n+\taddi\tsp,sp,16\n+\tjr\tra\n+\t.size\tfoobar_old, .-foobar_old\n+\t.symver\tfoobar_old, foobar@Old\n+\t.section\t.note.GNU-stack,\"\",@progbits"
    },
    {
      "sha": "a6d80e7b458b2c7e59f181da9150adf5c7930857",
      "filename": "ld/testsuite/ld-riscv-elf/relax-twice.ver",
      "status": "added",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice.ver",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de/ld/testsuite/ld-riscv-elf/relax-twice.ver",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/relax-twice.ver?ref=235f5ef4a6b8fbdcfaea8b629f7c6a9792a789de",
      "patch": "@@ -0,0 +1,11 @@\n+Old {\n+        global:\n+                foobar;\n+                relaxme;\n+        local:\n+                *;\n+};\n+New {\n+        global:\n+                foobar;\n+} Old;"
    }
  ]
}