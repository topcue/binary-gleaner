{
  "sha": "a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YTM1MGVmZDRmYjM2OGEzNWFkYTYwOGY2YmMyNmNjZDNiZWQwYWU2Yg==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2020-06-16T23:55:57Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2020-06-17T00:02:20Z"
    },
    "message": "Fix crash when exiting TUI with gdb -tui\n\nPR tui/25348 points out that, when \"gdb -tui\" is used, then exiting\nthe TUI will cause a crash.\n\nThis happens because tui_setup_io stashes some readline variables --\nbut because this happens before readline is initialized, some of these\nare NULL.  Then, when exiting the TUI, the NULL values are \"restored\",\ncausing a crash in readline.\n\nThis patch fixes the problem by ensuring that readline is initialized\nfirst.  Back in commit 11061048d (\"Give a name to the TUI SingleKey\nkeymap\"), a call to rl_initialize was removed from\ntui_initialize_readline; this patch resurrects the call, but moves it\nto the end of the function, so as not to remove the ability to modify\nthe SingleKey map from .inputrc.\n\ngdb/ChangeLog\n2020-06-16  Tom Tromey  <tom@tromey.com>\n\n\tPR tui/25348:\n\t* tui/tui.c (tui_ensure_readline_initialized): Rename from\n\ttui_initialize_readline.  Only run once.  Call rl_initialize.\n\t* tui/tui.h (tui_ensure_readline_initialized): Rename from\n\ttui_initialize_readline.\n\t* tui/tui-io.c (tui_setup_io): Call\n\ttui_ensure_readline_initialized.\n\t* tui/tui-interp.c (tui_interp::init): Update.",
    "tree": {
      "sha": "a0f33da8020b08e20d56e414ae82a06c9c0ed7e6",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/a0f33da8020b08e20d56e414ae82a06c9c0ed7e6"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "39ec04904ff172dd67fd43ed3720f26d854732bf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/39ec04904ff172dd67fd43ed3720f26d854732bf",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/39ec04904ff172dd67fd43ed3720f26d854732bf"
    }
  ],
  "stats": {
    "total": 34,
    "additions": 29,
    "deletions": 5
  },
  "files": [
    {
      "sha": "dc269261bebac78243abef7c44a1ccbe407c8b1f",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
      "patch": "@@ -1,3 +1,14 @@\n+2020-06-16  Tom Tromey  <tom@tromey.com>\n+\n+\tPR tui/25348:\n+\t* tui/tui.c (tui_ensure_readline_initialized): Rename from\n+\ttui_initialize_readline.  Only run once.  Call rl_initialize.\n+\t* tui/tui.h (tui_ensure_readline_initialized): Rename from\n+\ttui_initialize_readline.\n+\t* tui/tui-io.c (tui_setup_io): Call\n+\ttui_ensure_readline_initialized.\n+\t* tui/tui-interp.c (tui_interp::init): Update.\n+\n 2020-06-16  Tom Tromey  <tom@tromey.com>\n \n \t* tui/tui-layout.c (tui_layout_split::remove_windows): Fix logic."
    },
    {
      "sha": "44a1396432383b4cde11b795880af21f56d165ae",
      "filename": "gdb/tui/tui-interp.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui-interp.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui-interp.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-interp.c?ref=a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
      "patch": "@@ -244,7 +244,7 @@ tui_interp::init (bool top_level)\n   tui_initialize_io ();\n   tui_initialize_win ();\n   if (gdb_stdout->isatty ())\n-    tui_initialize_readline ();\n+    tui_ensure_readline_initialized ();\n }\n \n void"
    },
    {
      "sha": "277b560af4f4cdaa4229a7cd575332b32e004967",
      "filename": "gdb/tui/tui-io.c",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui-io.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui-io.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-io.c?ref=a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
      "patch": "@@ -746,6 +746,10 @@ tui_setup_io (int mode)\n \n   if (mode)\n     {\n+      /* Ensure that readline has been initialized before saving any\n+\t of its variables.  */\n+      tui_ensure_readline_initialized ();\n+\n       /* Redirect readline to TUI.  */\n       tui_old_rl_redisplay_function = rl_redisplay_function;\n       tui_old_rl_deprep_terminal = rl_deprep_term_function;"
    },
    {
      "sha": "828e42bccf7a263da40648699f967f1aabcbec60",
      "filename": "gdb/tui/tui.c",
      "status": "modified",
      "additions": 10,
      "deletions": 1,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui.c?ref=a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
      "patch": "@@ -268,8 +268,14 @@ tui_set_key_mode (enum tui_key_mode mode)\n /* Initialize readline and configure the keymap for the switching\n    key shortcut.  */\n void\n-tui_initialize_readline (void)\n+tui_ensure_readline_initialized ()\n {\n+  static bool initialized;\n+\n+  if (initialized)\n+    return;\n+  initialized = true;\n+\n   int i;\n   Keymap tui_ctlx_keymap;\n \n@@ -325,6 +331,9 @@ tui_initialize_readline (void)\n   rl_bind_key_in_map ('q', tui_rl_next_keymap, tui_keymap);\n   rl_bind_key_in_map ('s', tui_rl_next_keymap, emacs_ctlx_keymap);\n   rl_bind_key_in_map ('s', tui_rl_next_keymap, tui_ctlx_keymap);\n+\n+  /* Initialize readline after the above.  */\n+  rl_initialize ();\n }\n \n /* Return the TERM variable from the environment, or \"<unset>\""
    },
    {
      "sha": "79525babc9ff6eec07b4c34a117ddbed3b9ce3a4",
      "filename": "gdb/tui/tui.h",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a350efd4fb368a35ada608f6bc26ccd3bed0ae6b/gdb/tui/tui.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui.h?ref=a350efd4fb368a35ada608f6bc26ccd3bed0ae6b",
      "patch": "@@ -49,9 +49,9 @@ extern bool tui_is_window_visible (enum tui_win_type type);\n extern bool tui_get_command_dimension (unsigned int *width,\n \t\t\t\t       unsigned int *height);\n \n-/* Initialize readline and configure the keymap for the switching\n-   key shortcut.  */\n-extern void tui_initialize_readline (void);\n+/* Initialize readline and configure the keymap for the switching key\n+   shortcut.  May be called more than once without issue.  */\n+extern void tui_ensure_readline_initialized ();\n \n /* Enter in the tui mode (curses).  */\n extern void tui_enable (void);"
    }
  ]
}