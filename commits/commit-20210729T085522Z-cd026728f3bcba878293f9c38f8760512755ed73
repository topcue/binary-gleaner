{
  "sha": "cd026728f3bcba878293f9c38f8760512755ed73",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6Y2QwMjY3MjhmM2JjYmE4NzgyOTNmOWMzOGY4NzYwNTEyNzU1ZWQ3Mw==",
  "commit": {
    "author": {
      "name": "Cl\u00e9ment Chigot",
      "email": "clement.chigot@atos.net",
      "date": "2021-07-27T12:37:50Z"
    },
    "committer": {
      "name": "Cl\u00e9ment Chigot",
      "email": "clement.chigot@atos.net",
      "date": "2021-07-29T08:55:22Z"
    },
    "message": "gas: improve C_BSTAT and C_STSYM symbols handling on XCOFF\n\nA C_BSTAT debug symbol specifies the beginning of a static block.\nIts n_value is the index of the csect containing static symbols.\nA C_STSYM debug symbol represents the stabstring of a statically\nallocated symbol. Its n_value is the offset in the csect pointed\nby the containing C_BSTAT.\n\nThese two special n_value were not correctly handled both when\ngenerating object files with gas or when reading them with objdump.\nThis patch tries to improve that and, above all, to allow gas-generated\nobject files with such symbols to be accepted by AIX ld.\n\nbfd/\n\t* coff-bfd.c (bfd_coff_get_syment): Adjust n_value of symbols\n\thaving fix_value = 1 in order to be an index and not a memory\n\toffset.\n\t* coffgen.c (coff_get_symbol_info): Likewize.\n\t(coff_print_symbol): Likewize.\n\ngas/\n\t* config/tc-ppc.c (ppc_frob_label): Don't change within if\n\talready set.\n\t(ppc_stabx): Remove workaround changing exp.X_add_symbol's\n\twithin.\n\t* config/tc-ppc.h (struct ppc_tc_sy): Update comments.\n\t* symbols.c (resolve_symbol_value): Remove symbol update\n\twhen final_val is 0 and it's an AIX debug symbol.\n\t* testsuite/gas/ppc/aix.exp: Add new tests.\n\t* testsuite/gas/ppc/xcoff-stsym-32.d: New test.\n\t* testsuite/gas/ppc/xcoff-stsym-64.d: New test.\n\t* testsuite/gas/ppc/xcoff-stsym.s: New test.",
    "tree": {
      "sha": "c4ae58abb4e2179b87a068f35b94b4afccf4f099",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/c4ae58abb4e2179b87a068f35b94b4afccf4f099"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/cd026728f3bcba878293f9c38f8760512755ed73",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/cd026728f3bcba878293f9c38f8760512755ed73",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/cd026728f3bcba878293f9c38f8760512755ed73",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/cd026728f3bcba878293f9c38f8760512755ed73/comments",
  "author": {
    "login": "Helflym",
    "id": 23002587,
    "node_id": "MDQ6VXNlcjIzMDAyNTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/23002587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Helflym",
    "html_url": "https://github.com/Helflym",
    "followers_url": "https://api.github.com/users/Helflym/followers",
    "following_url": "https://api.github.com/users/Helflym/following{/other_user}",
    "gists_url": "https://api.github.com/users/Helflym/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Helflym/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Helflym/subscriptions",
    "organizations_url": "https://api.github.com/users/Helflym/orgs",
    "repos_url": "https://api.github.com/users/Helflym/repos",
    "events_url": "https://api.github.com/users/Helflym/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Helflym/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "Helflym",
    "id": 23002587,
    "node_id": "MDQ6VXNlcjIzMDAyNTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/23002587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Helflym",
    "html_url": "https://github.com/Helflym",
    "followers_url": "https://api.github.com/users/Helflym/followers",
    "following_url": "https://api.github.com/users/Helflym/following{/other_user}",
    "gists_url": "https://api.github.com/users/Helflym/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Helflym/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Helflym/subscriptions",
    "organizations_url": "https://api.github.com/users/Helflym/orgs",
    "repos_url": "https://api.github.com/users/Helflym/repos",
    "events_url": "https://api.github.com/users/Helflym/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Helflym/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ad42014be254b402f7a44e578cc709fe9e30dc1d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ad42014be254b402f7a44e578cc709fe9e30dc1d",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/ad42014be254b402f7a44e578cc709fe9e30dc1d"
    }
  ],
  "stats": {
    "total": 98,
    "additions": 90,
    "deletions": 8
  },
  "files": [
    {
      "sha": "dd61bbaf04f4a601d425b5ac49faec062a160257",
      "filename": "bfd/coff-bfd.c",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/bfd/coff-bfd.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/bfd/coff-bfd.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/coff-bfd.c?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -45,8 +45,9 @@ bfd_coff_get_syment (bfd *abfd,\n   *psyment = csym->native->u.syment;\n \n   if (csym->native->fix_value)\n-    psyment->n_value = psyment->n_value -\n-      (bfd_hostptr_t) obj_raw_syments (abfd);\n+    psyment->n_value =\n+      ((psyment->n_value - (bfd_hostptr_t) obj_raw_syments (abfd))\n+       / sizeof (combined_entry_type));\n \n   /* FIXME: We should handle fix_line here.  */\n "
    },
    {
      "sha": "017d4c31a4e61b50dade6fcc8305c62e62f87fe1",
      "filename": "bfd/coffgen.c",
      "status": "modified",
      "additions": 6,
      "deletions": 3,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/bfd/coffgen.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/bfd/coffgen.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/coffgen.c?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -2043,8 +2043,10 @@ coff_get_symbol_info (bfd *abfd, asymbol *symbol, symbol_info *ret)\n   if (coffsymbol (symbol)->native != NULL\n       && coffsymbol (symbol)->native->fix_value\n       && coffsymbol (symbol)->native->is_sym)\n-    ret->value = coffsymbol (symbol)->native->u.syment.n_value -\n-      (bfd_hostptr_t) obj_raw_syments (abfd);\n+    ret->value =\n+      ((coffsymbol (symbol)->native->u.syment.n_value -\n+\t(bfd_hostptr_t) obj_raw_syments (abfd))\n+       / sizeof (combined_entry_type));\n }\n \n /* Print out information about COFF symbol.  */\n@@ -2092,7 +2094,8 @@ coff_print_symbol (bfd *abfd,\n \t  if (! combined->fix_value)\n \t    val = (bfd_vma) combined->u.syment.n_value;\n \t  else\n-\t    val = combined->u.syment.n_value - (bfd_hostptr_t) root;\n+\t    val = ((combined->u.syment.n_value - (bfd_hostptr_t) root)\n+\t\t   / sizeof (combined_entry_type));\n \n \t  fprintf (file, \"(sec %2d)(fl 0x%02x)(ty %3x)(scl %3d) (nx %d) 0x\",\n \t\t   combined->u.syment.n_scnum,"
    },
    {
      "sha": "8c3b0a8e7ccbc19c4a730876fb720b0d1cd0dead",
      "filename": "gas/config/tc-ppc.c",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/config/tc-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/config/tc-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-ppc.c?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -2901,8 +2901,13 @@ ppc_frob_label (symbolS *sym)\n       symbol_remove (sym, &symbol_rootP, &symbol_lastP);\n       symbol_append (sym, symbol_get_tc (ppc_current_csect)->within,\n \t\t     &symbol_rootP, &symbol_lastP);\n+      /* Update last csect symbol.  */\n       symbol_get_tc (ppc_current_csect)->within = sym;\n-      symbol_get_tc (sym)->within = ppc_current_csect;\n+\n+      /* Some labels like .bs are using within differently.\n+         So avoid changing it, if it's already set.  */\n+      if (symbol_get_tc (sym)->within == NULL)\n+\tsymbol_get_tc (sym)->within = ppc_current_csect;\n     }\n #endif\n \n@@ -5056,7 +5061,6 @@ ppc_stabx (int ignore ATTRIBUTE_UNUSED)\n             as_bad (_(\".stabx of storage class stsym must be within .bs/.es\"));\n \n           symbol_get_tc (sym)->within = ppc_current_block;\n-          symbol_get_tc (exp.X_add_symbol)->within = ppc_current_block;\n         }\n     }\n "
    },
    {
      "sha": "fb18730db3c8110630d19e033c2bf86238beb21b",
      "filename": "gas/config/tc-ppc.h",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/config/tc-ppc.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/config/tc-ppc.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-ppc.h?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -130,6 +130,7 @@ struct ppc_tc_sy\n   /* For a csect symbol, the last symbol which has been defined in\n      this csect, or NULL if none have been defined so far.\n      For a .bs symbol, the referenced csect symbol.\n+     For a C_STSYM symbol, the containing block (.bs symbol).\n      For a label, the enclosing csect.  */\n   symbolS *within;\n   union"
    },
    {
      "sha": "302eb4bd6f7fc86c9436619beb5ba50df37963d0",
      "filename": "gas/symbols.c",
      "status": "modified",
      "additions": 11,
      "deletions": 1,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/symbols.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/symbols.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/symbols.c?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -1380,7 +1380,17 @@ resolve_symbol_value (symbolS *symp)\n \t      && add_symbol->flags.resolving)\n \t    break;\n \n-\t  if (finalize_syms && final_val == 0)\n+\t  if (finalize_syms && final_val == 0\n+#ifdef OBJ_XCOFF\n+\t      /* Avoid changing symp's \"within\" when dealing with\n+\t\t AIX debug symbols. For some storage classes, \"within\"\n+\t         have a special meaning.\n+\t\t C_DWARF should behave like on Linux, thus this check\n+\t\t isn't done to be closer.  */\n+\t      && ((symbol_get_bfdsym (symp)->flags & BSF_DEBUGGING) == 0\n+\t\t  || (S_GET_STORAGE_CLASS (symp) == C_DWARF))\n+#endif\n+\t      )\n \t    {\n \t      if (add_symbol->flags.local_symbol)\n \t\tadd_symbol = local_symbol_convert (add_symbol);"
    },
    {
      "sha": "aef295bc3b9098ad21ca63f72b1513e74e8d0490",
      "filename": "gas/testsuite/gas/ppc/aix.exp",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/aix.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/aix.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/ppc/aix.exp?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -81,4 +81,7 @@ if { [istarget \"powerpc*-*-aix*\"] || [istarget \"rs6000-*-aix*\"] } then {\n \n     run_dump_test \"xcoff-tlsm-32\"\n     run_dump_test \"xcoff-tlsm-64\"\n+\n+    run_dump_test \"xcoff-stsym-32\"\n+    run_dump_test \"xcoff-stsym-64\"\n }"
    },
    {
      "sha": "501a1dc30cf0b39f1fe333c30de3b8ec1115bf16",
      "filename": "gas/testsuite/gas/ppc/xcoff-stsym-32.d",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym-32.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym-32.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/ppc/xcoff-stsym-32.d?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -0,0 +1,22 @@\n+#as: -a32\n+#source: xcoff-stsym.s\n+#objdump: -t\n+#name: XCOFF C_STSYM test (32-bit)\n+\n+.*\n+\n+SYMBOL TABLE:\n+.*\n+.*\n+.*\n+.*\n+\\[  4\\]\\(sec  1\\).*\\(scl 143\\) \\(nx 0\\) 0x0000000a .bs\n+\\[  5\\]\\(sec -2\\).*\\(scl 133\\) \\(nx 0\\) 0x00000000 x:V6\n+\\[  6\\]\\(sec  1\\).*\\(scl 144\\) \\(nx 0\\) 0x00000000 .es\n+\\[  7\\]\\(sec  1\\).*\\(scl 143\\) \\(nx 0\\) 0x0000000a .bs\n+\\[  8\\]\\(sec -2\\).*\\(scl 133\\) \\(nx 0\\) 0x00000004 y:V6\n+\\[  9\\]\\(sec  1\\).*\\(scl 144\\) \\(nx 0\\) 0x00000000 .es\n+\\[ 10\\].* _main\\.rw_\n+.*\n+\n+"
    },
    {
      "sha": "8da109b0ab58ff19a176c99be0e8053894c8a74e",
      "filename": "gas/testsuite/gas/ppc/xcoff-stsym-64.d",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym-64.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym-64.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/ppc/xcoff-stsym-64.d?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -0,0 +1,22 @@\n+#as: -a64\n+#source: xcoff-stsym.s\n+#objdump: -t\n+#name: XCOFF C_STSYM test (64-bit)\n+\n+.*\n+\n+SYMBOL TABLE:\n+.*\n+.*\n+.*\n+.*\n+\\[  4\\]\\(sec  1\\).*\\(scl 143\\) \\(nx 0\\) 0x000000000000000a .bs\n+\\[  5\\]\\(sec -2\\).*\\(scl 133\\) \\(nx 0\\) 0x0000000000000000 x:V6\n+\\[  6\\]\\(sec  1\\).*\\(scl 144\\) \\(nx 0\\) 0x0000000000000000 .es\n+\\[  7\\]\\(sec  1\\).*\\(scl 143\\) \\(nx 0\\) 0x000000000000000a .bs\n+\\[  8\\]\\(sec -2\\).*\\(scl 133\\) \\(nx 0\\) 0x0000000000000004 y:V6\n+\\[  9\\]\\(sec  1\\).*\\(scl 144\\) \\(nx 0\\) 0x0000000000000000 .es\n+\\[ 10\\].* _main\\.rw_\n+.*\n+\n+"
    },
    {
      "sha": "ae98a81ec7bdab455f2b47f6735d3172b5f39ce1",
      "filename": "gas/testsuite/gas/ppc/xcoff-stsym.s",
      "status": "added",
      "additions": 16,
      "deletions": 0,
      "changes": 16,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/cd026728f3bcba878293f9c38f8760512755ed73/gas/testsuite/gas/ppc/xcoff-stsym.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/ppc/xcoff-stsym.s?ref=cd026728f3bcba878293f9c38f8760512755ed73",
      "patch": "@@ -0,0 +1,16 @@\n+\t.file\t\"main.c\"\n+\t.csect _main.rw_[RW],4\n+\n+\t.csect .text[PR]\n+\t.bs\t_main.rw_[RW]\n+\t.stabx\t\"x:V6\",x.2,133,0\n+\t.es\n+\t.bs\t_main.rw_[RW]\n+\t.stabx\t\"y:V6\",y.1,133,0\n+\t.es\n+\n+\t.csect _main.rw_[RW],4\n+x.2:\n+\t.long\t100\n+y.1:\n+\t.long\t110"
    }
  ]
}