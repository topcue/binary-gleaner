{
  "sha": "bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YmI5OTVkMDBiM2VlZjJmNDhkMGJlODk1YzM1MDlhN2RkZDgyODBhMQ==",
  "commit": {
    "author": {
      "name": "Keith Seitz",
      "email": "keiths@redhat.com",
      "date": "2019-02-22T17:39:35Z"
    },
    "committer": {
      "name": "Keith Seitz",
      "email": "keiths@redhat.com",
      "date": "2019-02-22T19:19:27Z"
    },
    "message": "Fix symtab/23853: symlinked default symtab\n\nThis patch attempts to fix a bug dealing with setting breakpoints\nin default symtabs that are symlinks.  For example:\n\n(gdb) list\n11\t   GNU General Public License for more details.\n12\n13\t   You should have received a copy of the GNU General Public License\n14\t   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n15\n16\tstatic int\n17\tfoo (void)\n18\t{\n19\t  return 0; /* break here  */\n20\t}\n(gdb)\n21\n22\tint\n23\tmain (void)\n24\t{\n25\t  return foo ();\n26\t}\n(gdb) b 19\nNo line 19 in the current file.\nMake breakpoint pending on future shared library load? (y or [n])\n\nThe problem here is that when create_sals_line_offset sets the default\nsymtab, it immediately calls symtab_to_fullname, passing that fullname\nto collect_symtabs_from_filename to find all matching symtabs.  This\nfails because we end up looking for a symtab with the name of the\nactual file on disk (which is different in this case because of the\nsymlink) instead of the one stored in the debug info.\n\nSince we already have the lookup name of the default symtab, use it\ninstead of the fullname. [This fullname thing was originally added\nin 2007 in a series dealing with *displaying* absolute file names.\nClearly, this instance has nothing to do with the display of file names.]\n\ngdb/ChangeLog\n\n\tPR symtab/23853\n\t* linespec.c (create_sals_line_offset): Search for the default\n\tsymtab's filename instead of its fullname.\n\ngdb/testsuite/ChangeLog\n\n\tPR symtab/23853\n\t* gdb.base/symlink-sourcefile.c: New file.\n\t* gdb.base/symlink-sourcefile.exp: New file.",
    "tree": {
      "sha": "e332deafbabc16ade03e0bf10c2664a67178b923",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e332deafbabc16ade03e0bf10c2664a67178b923"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "24841daa74f092f7c5639ee8f1fb303c7694dee7",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/24841daa74f092f7c5639ee8f1fb303c7694dee7",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/24841daa74f092f7c5639ee8f1fb303c7694dee7"
    }
  ],
  "stats": {
    "total": 77,
    "additions": 73,
    "deletions": 4
  },
  "files": [
    {
      "sha": "e902b11c8e81bd9c48b639d5a381e112b11fa948",
      "filename": "gdb/linespec.c",
      "status": "modified",
      "additions": 2,
      "deletions": 4,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/linespec.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/linespec.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/linespec.c?ref=bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
      "patch": "@@ -2102,16 +2102,14 @@ create_sals_line_offset (struct linespec_state *self,\n   if (ls->file_symtabs->size () == 1\n       && ls->file_symtabs->front () == nullptr)\n     {\n-      const char *fullname;\n-\n       set_current_program_space (self->program_space);\n \n       /* Make sure we have at least a default source line.  */\n       set_default_source_symtab_and_line ();\n       initialize_defaults (&self->default_symtab, &self->default_line);\n-      fullname = symtab_to_fullname (self->default_symtab);\n       *ls->file_symtabs\n-\t= collect_symtabs_from_filename (fullname, self->search_pspace);\n+\t= collect_symtabs_from_filename (self->default_symtab->filename,\n+\t\t\t\t\t self->search_pspace);\n       use_default = 1;\n     }\n "
    },
    {
      "sha": "12cd96892abe207e46f8498d15ac8624a73c81af",
      "filename": "gdb/testsuite/gdb.base/symlink-sourcefile.c",
      "status": "added",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/testsuite/gdb.base/symlink-sourcefile.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/testsuite/gdb.base/symlink-sourcefile.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/symlink-sourcefile.c?ref=bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
      "patch": "@@ -0,0 +1,26 @@\n+/* Copyright 2019 Free Software Foundation, Inc.\n+\n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 3 of the License, or\n+   (at your option) any later version.\n+\n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+\n+   You should have received a copy of the GNU General Public License\n+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n+\n+static int\n+foo (void)\n+{\n+  return 0; /* break here  */\n+}\n+\n+int\n+main (void)\n+{\n+  return foo ();\n+}"
    },
    {
      "sha": "ae43934ff4d5e1ea66f60bff73795ecfa09d545f",
      "filename": "gdb/testsuite/gdb.base/symlink-sourcefile.exp",
      "status": "added",
      "additions": 45,
      "deletions": 0,
      "changes": 45,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/testsuite/gdb.base/symlink-sourcefile.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bb995d00b3eef2f48d0be895c3509a7ddd8280a1/gdb/testsuite/gdb.base/symlink-sourcefile.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/symlink-sourcefile.exp?ref=bb995d00b3eef2f48d0be895c3509a7ddd8280a1",
      "patch": "@@ -0,0 +1,45 @@\n+# Copyright 2019 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+# Test that GDB can find the default symtab when it is a symbolic link.\n+standard_testfile\n+\n+set test \"file symbolic link name\"\n+set linksrc \"link-${srcfile}\"\n+set srcfilelink [standard_output_file $linksrc]\n+\n+\n+# Remove any existing symlink and build executable using a\n+# symbolic link to the actual source file.\n+remote_file host delete $srcfilelink\n+set status [remote_exec host \\\n+\t\t\"ln -sf $srcdir/$subdir/$srcfile $srcfilelink\"]\n+if {[lindex $status 0] != 0} {\n+    unsupported \"$test (host does not support symbolic links)\"\n+    return 0\n+}\n+\n+if {[prepare_for_testing $testfile $testfile $srcfilelink]} {\n+    return -1\n+}\n+\n+if {![runto_main]} {\n+    untested \"could not run to main\"\n+    return -1\n+}\n+\n+# Using a line number ensures that the default symtab is used.\n+gdb_breakpoint [gdb_get_line_number \"break here\" $srcfile] message\n+gdb_continue_to_breakpoint \"run to breakpoint marker\""
    }
  ]
}