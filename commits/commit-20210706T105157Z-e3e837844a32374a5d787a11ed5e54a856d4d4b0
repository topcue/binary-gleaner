{
  "sha": "e3e837844a32374a5d787a11ed5e54a856d4d4b0",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZTNlODM3ODQ0YTMyMzc0YTVkNzg3YTExZWQ1ZTU0YTg1NmQ0ZDRiMA==",
  "commit": {
    "author": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2021-06-18T12:50:45Z"
    },
    "committer": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2021-07-06T10:51:57Z"
    },
    "message": "gdb.perf/: FAIL on Python errors, avoid \"ERROR: internal buffer is full\"\n\nCurrently, if you run make check-perf on a system with Python 3.8,\ntests seen to PASS, but they actually test a lot less than intended,\ndue to:\n\n PerfTest::assemble, run ...\n python BackTrace(64).run()\n Traceback (most recent call last):\n   File \"<string>\", line 1, in <module>\n   File \"/home/pedro/rocm/gdb/src/gdb/testsuite/gdb.perf/lib/perftest/perftest.py\", line 65, in run\n     self.execute_test()\n   File \"<string>\", line 49, in execute_test\n   File \"/home/pedro/rocm/gdb/src/gdb/testsuite/gdb.perf/lib/perftest/measure.py\", line 45, in measure\n     m.start(id)\n   File \"/home/pedro/rocm/gdb/src/gdb/testsuite/gdb.perf/lib/perftest/measure.py\", line 102, in start\n     self.start_time = time.clock()\n AttributeError: module 'time' has no attribute 'clock'\n Error while executing Python code.\n (gdb) PASS: gdb.perf/backtrace.exp: python BackTrace(64).run()\n\nAnd then, after fixing the above Python compatibility issues (which\nwill be a separate patch), I get 86 instances of overflowing expect's\nbuffer, like:\n\n  ERROR: internal buffer is full.\n  UNRESOLVED: gdb.perf/single-step.exp: python SingleStep(1000).run()\n\nThis patch fixes both problems by adding & using a gdb_test_python_run\nroutine that:\n\n - checks for Python errors\n - consumes output line by line\n\ngdb/testsuite/ChangeLog:\nyyyy-mm-dd  Pedro Alves  <pedro@palves.net>\n\n\t* gdb.perf/backtrace.exp: Use gdb_test_python_run.\n\t* gdb.perf/disassemble.exp: Use gdb_test_python_run.\n\t* gdb.perf/single-step.exp: Use gdb_test_python_run.\n\t* gdb.perf/skip-command.exp: Use gdb_test_python_run.\n\t* gdb.perf/skip-prologue.exp: Use gdb_test_python_run.\n\t* gdb.perf/solib.exp: Use gdb_test_python_run.\n\t* gdb.perf/template-breakpoints.exp: Use gdb_test_python_run.\n\t* lib/perftest.exp (gdb_test_python_run): New.\n\nChange-Id: I007af36f164b3f4cda41033616eaaa4e268dfd2f",
    "tree": {
      "sha": "5eab61600a71baef9460045b0f9793354f9e692f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/5eab61600a71baef9460045b0f9793354f9e692f"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/e3e837844a32374a5d787a11ed5e54a856d4d4b0",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e3e837844a32374a5d787a11ed5e54a856d4d4b0",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/e3e837844a32374a5d787a11ed5e54a856d4d4b0",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e3e837844a32374a5d787a11ed5e54a856d4d4b0/comments",
  "author": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "0d4e283965dae2c05cf0c85dccea6144a2c6293e",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/0d4e283965dae2c05cf0c85dccea6144a2c6293e",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/0d4e283965dae2c05cf0c85dccea6144a2c6293e"
    }
  ],
  "stats": {
    "total": 49,
    "additions": 32,
    "deletions": 17
  },
  "files": [
    {
      "sha": "ced653c4b8499218c0a47f543ad663bd7320884f",
      "filename": "gdb/testsuite/gdb.perf/backtrace.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/backtrace.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/backtrace.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/backtrace.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -63,7 +63,7 @@ PerfTest::assemble {\n } {\n     global BACKTRACE_DEPTH\n \n-    gdb_test \"python BackTrace\\($BACKTRACE_DEPTH\\).run()\"\n+    gdb_test_python_run \"BackTrace\\($BACKTRACE_DEPTH\\)\"\n \n     return 0\n }"
    },
    {
      "sha": "4a79e298e02e1b332ee062e1f6551df8feb3b4ed",
      "filename": "gdb/testsuite/gdb.perf/disassemble.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/disassemble.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/disassemble.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/disassemble.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -55,6 +55,6 @@ PerfTest::assemble {\n \n     return 0\n } {\n-    gdb_test \"python Disassemble\\(\\).run()\"\n+    gdb_test_python_run \"Disassemble\\(\\)\"\n     return 0\n }"
    },
    {
      "sha": "7a5d068f153d8de0fe44d9f8e72aa5a10b02648a",
      "filename": "gdb/testsuite/gdb.perf/single-step.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/single-step.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/single-step.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/single-step.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -51,7 +51,7 @@ PerfTest::assemble {\n } {\n     global SINGLE_STEP_COUNT\n \n-    gdb_test_no_output \"python SingleStep\\(${SINGLE_STEP_COUNT}\\).run()\"\n+    gdb_test_python_run \"SingleStep\\(${SINGLE_STEP_COUNT}\\)\"\n     # Terminate the loop.\n     gdb_test \"set variable flag = 0\"\n     return 0"
    },
    {
      "sha": "e396262af0657826518af0adb07a2d79e4a57e5e",
      "filename": "gdb/testsuite/gdb.perf/skip-command.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/skip-command.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/skip-command.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/skip-command.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -103,7 +103,7 @@ proc run_skip_bench { kind text } {\n     for { set i 0 } { $i < 5 } { incr i } {\n \tset nr_skips [expr $i * $SKIP_DIRECTIVE_COUNT]\n \tinstall_skips $kind $text $nr_skips\n-\tgdb_test_no_output \"python SkipCommand\\(\\\"skip-$kind-$nr_skips\\\", ${SKIP_STEP_COUNT}\\).run()\"\n+\tgdb_test_python_run \"SkipCommand\\(\\\"skip-$kind-$nr_skips\\\", ${SKIP_STEP_COUNT}\\)\"\n     }\n \n     gdb_test \"set variable flag = 0\""
    },
    {
      "sha": "7caff667a0d02dab312099717aef29c174d5c560",
      "filename": "gdb/testsuite/gdb.perf/skip-prologue.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 11,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/skip-prologue.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/skip-prologue.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/skip-prologue.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -63,16 +63,6 @@ PerfTest::assemble {\n } {\n     global SKIP_PROLOGUE_COUNT\n \n-    set test \"run\"\n-    gdb_test_multiple \"python SkipPrologue\\($SKIP_PROLOGUE_COUNT\\).run()\" $test {\n-\t-re \"Breakpoint $decimal at \\[^\\n\\]*\\n\" {\n-\t    # GDB prints some messages on breakpoint creation.\n-\t    # Consume the output to avoid internal buffer full.\n-\t    exp_continue\n-\t}\n-\t-re \".*$gdb_prompt $\" {\n-\t    pass $test\n-\t}\n-    }\n+    gdb_test_python_run \"SkipPrologue\\($SKIP_PROLOGUE_COUNT\\)\" \"run\"\n     return 0\n }"
    },
    {
      "sha": "e0cd341bf31a8caaff0536e0ee094cae3ea93674",
      "filename": "gdb/testsuite/gdb.perf/solib.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/solib.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/solib.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/solib.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -84,6 +84,6 @@ PerfTest::assemble {\n } {\n     global SOLIB_COUNT\n \n-    gdb_test_no_output \"python SolibLoadUnload\\($SOLIB_COUNT\\).run()\"\n+    gdb_test_python_run \"SolibLoadUnload\\($SOLIB_COUNT\\)\"\n     return 0\n }"
    },
    {
      "sha": "96c1209e96c42e4272dd7427e14fbefefbcc202b",
      "filename": "gdb/testsuite/gdb.perf/template-breakpoints.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/template-breakpoints.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/gdb.perf/template-breakpoints.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.perf/template-breakpoints.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -59,7 +59,7 @@ PerfTest::assemble {\n \treturn 0\n } {\n \n-\tgdb_test \"python TemplateBreakpoints().run()\"\n+\tgdb_test_python_run \"TemplateBreakpoints()\"\n \n \treturn 0\n }"
    },
    {
      "sha": "de9951880900153196dcaaf555bcc2b5f63cd8e8",
      "filename": "gdb/testsuite/lib/perftest.exp",
      "status": "modified",
      "additions": 25,
      "deletions": 0,
      "changes": 25,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/lib/perftest.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e3e837844a32374a5d787a11ed5e54a856d4d4b0/gdb/testsuite/lib/perftest.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/perftest.exp?ref=e3e837844a32374a5d787a11ed5e54a856d4d4b0",
      "patch": "@@ -155,3 +155,28 @@ proc tcl_string_list_to_python_list { l } {\n     }\n     return \"([join $quoted_list {, }])\"\n }\n+\n+# Helper routine for PerfTest::assemble \"run\" step implementations.\n+# Issues the \"python ${OBJ}.run()\" command, and consumes GDB output\n+# line by line.  Issues a FAIL if the command fails with a Python\n+# error.  Issues a PASS on success.  MESSAGE is an optional message to\n+# be printed.  If this is omitted, then the pass/fail messages use the\n+# command string as the message.\n+\n+proc gdb_test_python_run {obj {message \"\"}} {\n+    global gdb_prompt\n+\n+    set saw_error 0\n+    gdb_test_multiple \"python ${obj}.run()\" $message {\n+\t-re \"Error while executing Python code\\\\.\" {\n+\t    set saw_error 1\n+\t    exp_continue\n+\t}\n+\t-re \"\\[^\\r\\n\\]*\\r\\n\" {\n+\t    exp_continue\n+\t}\n+\t-re \"$gdb_prompt $\" {\n+\t    gdb_assert {!$saw_error} $gdb_test_name\n+\t}\n+    }\n+}"
    }
  ]
}