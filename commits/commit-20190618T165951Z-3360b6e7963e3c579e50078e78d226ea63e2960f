{
  "sha": "3360b6e7963e3c579e50078e78d226ea63e2960f",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzM2MGI2ZTc5NjNlM2M1NzllNTAwNzhlNzhkMjI2ZWE2M2UyOTYwZg==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-18T16:59:51Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-18T16:59:51Z"
    },
    "message": "[gdb] Fix abstract_to_concrete type\n\nThe test-case varval.exp fails here:\n...\nFAIL: gdb.dwarf2/varval.exp: print varval2\n...\nwith boards readnow/cc-with-gdb-index/cc-with-debug-names, as well as if gdb\nis build with -fsanitize=address -lasan.\n\nThe problem is that the abstract_to_concrete map in which we track the\nassociation of abstract to concrete DIEs (for DW_OP_GNU_variable_value\nsupport) has type std::unordered_map<die_info_ptr, std::vector<die_info_ptr>>,\nand the die_info_ptrs that we register in the map may be invalid by the time\nthat we start to lookup DIEs in the map.\n\nFix this by using the sect_offset instead to identify the DIEs in the map.\n\nBuild and tested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2019-06-18  Tom de Vries  <tdevries@suse.de>\n\n\tPR gdb/24515\n\t* dwarf2read.h (abstract_to_concrete): Change type from\n\tstd::unordered_map<die_info_ptr, std::vector<die_info_ptr>> to\n\tstd::unordered_map<sect_offset, std::vector<sect_offset>>.\n\t* dwarf2read.c (read_variable): Update.\n\t(dwarf2_fetch_die_loc_sect_off): Update.",
    "tree": {
      "sha": "84158a0558a031d1b8396efbaf3730ac0359b694",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/84158a0558a031d1b8396efbaf3730ac0359b694"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/3360b6e7963e3c579e50078e78d226ea63e2960f",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3360b6e7963e3c579e50078e78d226ea63e2960f",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/3360b6e7963e3c579e50078e78d226ea63e2960f",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3360b6e7963e3c579e50078e78d226ea63e2960f/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4ed4690fc21b1d052092299f820f48694f3ef3eb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4ed4690fc21b1d052092299f820f48694f3ef3eb",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4ed4690fc21b1d052092299f820f48694f3ef3eb"
    }
  ],
  "stats": {
    "total": 24,
    "additions": 19,
    "deletions": 5
  },
  "files": [
    {
      "sha": "83f47b257016b552af1e6ab47120b4737c6ddc03",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=3360b6e7963e3c579e50078e78d226ea63e2960f",
      "patch": "@@ -1,3 +1,12 @@\n+2019-06-18  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR gdb/24515\n+\t* dwarf2read.h (abstract_to_concrete): Change type from\n+\tstd::unordered_map<die_info_ptr, std::vector<die_info_ptr>> to\n+\tstd::unordered_map<sect_offset, std::vector<sect_offset>>.\n+\t* dwarf2read.c (read_variable): Update.\n+\t(dwarf2_fetch_die_loc_sect_off): Update.\n+\n 2019-06-17  Tom de Vries  <tdevries@suse.de>\n \n \tPR gdb/24617"
    },
    {
      "sha": "9cf513b582a57da5007df385f357e2876b212926",
      "filename": "gdb/dwarf2read.c",
      "status": "modified",
      "additions": 9,
      "deletions": 4,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/dwarf2read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/dwarf2read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2read.c?ref=3360b6e7963e3c579e50078e78d226ea63e2960f",
      "patch": "@@ -14288,7 +14288,7 @@ read_variable (struct die_info *die, struct dwarf2_cu *cu)\n       struct die_info *origin_die\n \t= follow_die_ref (die, abstract_origin, &origin_cu);\n       dwarf2_per_objfile *dpo = cu->per_cu->dwarf2_per_objfile;\n-      dpo->abstract_to_concrete[origin_die].push_back (die);\n+      dpo->abstract_to_concrete[origin_die->sect_off].push_back (die->sect_off);\n     }\n }\n \n@@ -23256,14 +23256,19 @@ dwarf2_fetch_die_loc_sect_off (sect_offset sect_off,\n \n   attr = dwarf2_attr (die, DW_AT_location, cu);\n   if (!attr && resolve_abstract_p\n-      && (dwarf2_per_objfile->abstract_to_concrete.find (die)\n+      && (dwarf2_per_objfile->abstract_to_concrete.find (die->sect_off)\n \t  != dwarf2_per_objfile->abstract_to_concrete.end ()))\n     {\n       CORE_ADDR pc = (*get_frame_pc) (baton);\n \n-      for (const auto &cand : dwarf2_per_objfile->abstract_to_concrete[die])\n+      for (const auto &cand_off\n+\t     : dwarf2_per_objfile->abstract_to_concrete[die->sect_off])\n \t{\n-\t  if (!cand->parent\n+\t  struct dwarf2_cu *cand_cu = cu;\n+\t  struct die_info *cand\n+\t    = follow_die_offset (cand_off, per_cu->is_dwz, &cand_cu);\n+\t  if (!cand\n+\t      || !cand->parent\n \t      || cand->parent->tag != DW_TAG_subprogram)\n \t    continue;\n "
    },
    {
      "sha": "776860e454dc1ae53fe1870d03576c5a960919e1",
      "filename": "gdb/dwarf2read.h",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/dwarf2read.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3360b6e7963e3c579e50078e78d226ea63e2960f/gdb/dwarf2read.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2read.h?ref=3360b6e7963e3c579e50078e78d226ea63e2960f",
      "patch": "@@ -256,7 +256,7 @@ struct dwarf2_per_objfile\n \n   /* Mapping from abstract origin DIE to concrete DIEs that reference it as\n      DW_AT_abstract_origin.  */\n-  std::unordered_map<die_info_ptr, std::vector<die_info_ptr>>\n+  std::unordered_map<sect_offset, std::vector<sect_offset>>\n     abstract_to_concrete;\n };\n "
    }
  ]
}