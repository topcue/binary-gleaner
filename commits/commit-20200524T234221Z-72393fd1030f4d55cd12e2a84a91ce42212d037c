{
  "sha": "72393fd1030f4d55cd12e2a84a91ce42212d037c",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NzIzOTNmZDEwMzBmNGQ1NWNkMTJlMmE4NGE5MWNlNDIyMTJkMDM3Yw==",
  "commit": {
    "author": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2020-05-24T23:42:21Z"
    },
    "committer": {
      "name": "Jim Wilson",
      "email": "jimw@sifive.com",
      "date": "2020-05-24T23:42:21Z"
    },
    "message": "RISC-V: Gas inserts cfa relocs in wrong section.\n\nThe frag code makes a distinction between inserting frags before the frag\nchains are chained together and afterward.  After chaining, we need to set\nnow_seg before creating the frag.  tc-xtensa.c has a function called\nfix_new_exp_in_seg that handles this right, but switches segments twice each\ntime it is called.  In this case, we can inline it and pull the save and\nrestore out of the loop to get better code.\n\n\tgas/\n\tPR 26025\n\t* config/tc-riscv.c (riscv_pre_output_hook): Change s type from const\n\tasection to segT.  New locals seg and subseg.  Call subseg_set before\n\tfix_new_exp.  Call subseg_set after loop to restore original values.",
    "tree": {
      "sha": "5f2028354959997fc1bcae4eaec43e615f4aeea9",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/5f2028354959997fc1bcae4eaec43e615f4aeea9"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/72393fd1030f4d55cd12e2a84a91ce42212d037c",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/72393fd1030f4d55cd12e2a84a91ce42212d037c",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/72393fd1030f4d55cd12e2a84a91ce42212d037c",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/72393fd1030f4d55cd12e2a84a91ce42212d037c/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "41a77cbaadd63b92362f5ea35b2cd11f90edf170",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/41a77cbaadd63b92362f5ea35b2cd11f90edf170",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/41a77cbaadd63b92362f5ea35b2cd11f90edf170"
    }
  ],
  "stats": {
    "total": 20,
    "additions": 19,
    "deletions": 1
  },
  "files": [
    {
      "sha": "e3da87381eae5dfea641d783ab69b02d5715f9a6",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72393fd1030f4d55cd12e2a84a91ce42212d037c/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72393fd1030f4d55cd12e2a84a91ce42212d037c/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=72393fd1030f4d55cd12e2a84a91ce42212d037c",
      "patch": "@@ -1,3 +1,10 @@\n+2020-05-24  Jim Wilson  <jimw@sifive.com>\n+\n+\tPR 26025\n+\t* config/tc-riscv.c (riscv_pre_output_hook): Change s type from const\n+\tasection to segT.  New locals seg and subseg.  Call subseg_set before\n+\tfix_new_exp.  Call subseg_set after loop to restore original values.\n+\n 2020-05-21  Alan Modra  <amodra@gmail.com>\n \n \t* atof-generic.c: Replace \"if (x) free (x)\" with \"free (x)\""
    },
    {
      "sha": "2a03a440b195db4e1a7dc83ffbae9936ff8f9a3d",
      "filename": "gas/config/tc-riscv.c",
      "status": "modified",
      "additions": 12,
      "deletions": 1,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/72393fd1030f4d55cd12e2a84a91ce42212d037c/gas/config/tc-riscv.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/72393fd1030f4d55cd12e2a84a91ce42212d037c/gas/config/tc-riscv.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-riscv.c?ref=72393fd1030f4d55cd12e2a84a91ce42212d037c",
      "patch": "@@ -3062,7 +3062,11 @@ void\n riscv_pre_output_hook (void)\n {\n   const frchainS *frch;\n-  const asection *s;\n+  segT s;\n+\n+  /* Save the current segment info.  */\n+  segT seg = now_seg;\n+  subsegT subseg = now_subseg;\n \n   for (s = stdoutput->sections; s; s = s->next)\n     for (frch = seg_info (s)->frchainP; frch; frch = frch->frch_next)\n@@ -3082,11 +3086,18 @@ riscv_pre_output_hook (void)\n \t\texp.X_add_number = 0;\n \t\texp.X_op_symbol = symval->X_op_symbol;\n \n+\t\t/* We must set the segment before creating a frag after all\n+\t\t   frag chains have been chained together.  */\n+\t\tsubseg_set (s, frch->frch_subseg);\n+\n \t\tfix_new_exp (frag, (int) frag->fr_offset, 1, &exp, 0,\n \t\t\t     BFD_RELOC_RISCV_CFA);\n \t      }\n \t  }\n       }\n+\n+  /* Restore the original segment info.  */\n+  subseg_set (seg, subseg);\n }\n \n "
    }
  ]
}