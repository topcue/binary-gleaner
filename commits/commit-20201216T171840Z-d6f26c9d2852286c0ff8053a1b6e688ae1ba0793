{
  "sha": "d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZDZmMjZjOWQyODUyMjg2YzBmZjgwNTNhMWI2ZTY4OGFlMWJhMDc5Mw==",
  "commit": {
    "author": {
      "name": "Martin Liska",
      "email": "mliska@suse.cz",
      "date": "2020-12-16T17:18:40Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-12-16T17:18:40Z"
    },
    "message": "[gdb] Print progress for debuginfod\n\nPrints progress like:\n\nDownloading 4.89 MB separate debug info for /usr/lib64/libgcrypt.so.20.\nDownloading 1.10 MB separate debug info for /usr/lib64/liblzma.so.5.\nDownloading 1.31 MB separate debug info for /usr/lib64/liblz4.so.1.\nDownloading 0.96 MB separate debug info for /usr/lib64/libsmime3.so.\n[###                                                                    ]\n\nTested on x86_64-linux.\n\nChangeLog:\n\n2020-12-16  Martin Liska  <mliska@suse.cz>\n\t    Tom de Vries  <tdevries@suse.de>\n\n\t* gdb/debuginfod-support.c (struct user_data): Remove has_printed\n\tfield.  Add meter field.\n\t(progressfn): Print progress using meter.",
    "tree": {
      "sha": "95b3a9eac4e975e7c006dbd78af7bb69bbb30df1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/95b3a9eac4e975e7c006dbd78af7bb69bbb30df1"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/comments",
  "author": {
    "login": "marxin",
    "id": 2658545,
    "node_id": "MDQ6VXNlcjI2NTg1NDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2658545?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/marxin",
    "html_url": "https://github.com/marxin",
    "followers_url": "https://api.github.com/users/marxin/followers",
    "following_url": "https://api.github.com/users/marxin/following{/other_user}",
    "gists_url": "https://api.github.com/users/marxin/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/marxin/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/marxin/subscriptions",
    "organizations_url": "https://api.github.com/users/marxin/orgs",
    "repos_url": "https://api.github.com/users/marxin/repos",
    "events_url": "https://api.github.com/users/marxin/events{/privacy}",
    "received_events_url": "https://api.github.com/users/marxin/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2f2287318b33ddf855a692fcc191f6b25caf4644",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2f2287318b33ddf855a692fcc191f6b25caf4644",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/2f2287318b33ddf855a692fcc191f6b25caf4644"
    }
  ],
  "stats": {
    "total": 38,
    "additions": 28,
    "deletions": 10
  },
  "files": [
    {
      "sha": "4629d15a305c7a3fb5e11c74f946ec75ed14c1c8",
      "filename": "ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ChangeLog?ref=d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
      "patch": "@@ -1,3 +1,10 @@\n+2020-12-16  Martin Liska  <mliska@suse.cz>\n+\t    Tom de Vries  <tdevries@suse.de>\n+\n+\t* gdb/debuginfod-support.c (struct user_data): Remove has_printed\n+\tfield.  Add meter field.\n+\t(progressfn): Print progress using meter.\n+\n 2020-12-02  Enze Li  <lienze2010@hotmail.com>\n \n \t* .gitignore: Add gnu global outputs."
    },
    {
      "sha": "b342be48cfe204e3ecd854739ef7007c3aa420b2",
      "filename": "gdb/cli-out.c",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/gdb/cli-out.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/gdb/cli-out.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/cli-out.c?ref=d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
      "patch": "@@ -272,7 +272,7 @@ cli_ui_out::do_redirect (ui_file *outstream)\n    - printed for tty, SHOULD_PRINT == false:\n      <>\n    - printed for not-a-tty:\n-     <NAME...done.\n+     <NAME...\n      >\n */\n \n@@ -348,7 +348,7 @@ cli_ui_out::do_progress_end ()\n \n   if (!stream->isatty ())\n     {\n-      fprintf_unfiltered (stream, \"done.\\n\");\n+      fprintf_unfiltered (stream, \"\\n\");\n       gdb_flush (stream);\n     }\n   else if (meter.printing == PROGRESS)"
    },
    {
      "sha": "e9b2dcd5bedaf0e38a2e8c4c2b8d1b75f8a1ae71",
      "filename": "gdb/debuginfod-support.c",
      "status": "modified",
      "additions": 19,
      "deletions": 8,
      "changes": 27,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/gdb/debuginfod-support.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d6f26c9d2852286c0ff8053a1b6e688ae1ba0793/gdb/debuginfod-support.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/debuginfod-support.c?ref=d6f26c9d2852286c0ff8053a1b6e688ae1ba0793",
      "patch": "@@ -21,6 +21,7 @@\n #include \"cli/cli-style.h\"\n #include \"gdbsupport/scoped_fd.h\"\n #include \"debuginfod-support.h\"\n+#include \"gdbsupport/gdb_optional.h\"\n \n #ifndef HAVE_LIBDEBUGINFOD\n scoped_fd\n@@ -46,12 +47,12 @@ debuginfod_debuginfo_query (const unsigned char *build_id,\n struct user_data\n {\n   user_data (const char *desc, const char *fname)\n-    : desc (desc), fname (fname), has_printed (false)\n+    : desc (desc), fname (fname)\n   { }\n \n   const char * const desc;\n   const char * const fname;\n-  bool has_printed;\n+  gdb::optional<ui_out::progress_meter> meter;\n };\n \n /* Deleter for a debuginfod_client.  */\n@@ -80,15 +81,25 @@ progressfn (debuginfod_client *c, long cur, long total)\n       return 1;\n     }\n \n-  if (!data->has_printed && total != 0)\n+  if (total == 0)\n+    return 0;\n+\n+  if (!data->meter.has_value ())\n     {\n-      /* Print this message only once.  */\n-      data->has_printed = true;\n-      printf_filtered (\"Downloading %s %ps...\\n\",\n-\t\t       data->desc,\n-\t\t       styled_string (file_name_style.style (), data->fname));\n+      float size_in_mb = 1.0f * total / (1024 * 1024);\n+      string_file styled_filename (current_uiout->can_emit_style_escape ());\n+      fprintf_styled (&styled_filename,\n+\t\t      file_name_style.style (),\n+\t\t      \"%s\",\n+\t\t      data->fname);\n+      std::string message\n+\t= string_printf (\"Downloading %.2f MB %s %s\", size_in_mb, data->desc,\n+\t\t\t styled_filename.c_str());\n+      data->meter.emplace (current_uiout, message, 1);\n     }\n \n+  current_uiout->progress ((double)cur / (double)total);\n+\n   return 0;\n }\n "
    }
  ]
}