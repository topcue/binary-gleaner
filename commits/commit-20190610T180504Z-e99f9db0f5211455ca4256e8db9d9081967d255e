{
  "sha": "e99f9db0f5211455ca4256e8db9d9081967d255e",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZTk5ZjlkYjBmNTIxMTQ1NWNhNDI1NmU4ZGI5ZDkwODE5NjdkMjU1ZQ==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-10T18:05:04Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-10T18:05:04Z"
    },
    "message": "[gdb/symtab] Fix symbol loading performance regression\n\nThe commit \"[gdb/symtab] Fix language of duplicate static minimal symbol\"\nintroduces a performance regression, when loading a cc1 executable build with\n-O0 -g and gcc 7.4.0.  The performance regression, measured in 'real' time is\nabout 175%.\n\nThe slower execution comes from the fact that the fix in symbol_set_names\nmakes the call to symbol_find_demangled_name unconditional.\n\nFix this by reverting the commit, and redoing the fix as follows.\n\nRecapturing the original problem, the first time symbol_set_names is called\nwith gsymbol.language == lang_auto and linkage_name == \"_ZL3foov\", the name is\nnot present in the per_bfd->demangled_names_hash hash table, so\nsymbol_find_demangled_name is called to demangle the name, after which the\nmangled/demangled pair is added to the hashtable.  The call to\nsymbol_find_demangled_name also sets gsymbol.language to lang_cplus.\nThe second time symbol_set_names is called with gsymbol.language == lang_auto\nand linkage_name == \"_ZL3foov\", the name is present in the hash table, so the\ndemangled name from the hash table is used.  However, the language of the\nsymbol remains lang_auto.\n\nFix this by adding a field language in struct demangled_name_entry, and using\nthe field in symbol_set_names to set the language of gsymbol, if necessary.\n\nTested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2019-06-10  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/24545\n\t* symtab.c (struct demangled_name_entry): Add language field.\n\t(symbol_set_names):  Revert \"[gdb/symtab] Fix language of duplicate\n\tstatic minimal symbol\".  Set and use language field.",
    "tree": {
      "sha": "a472db5914b30f1232964c7c3479fe0550ff724d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/a472db5914b30f1232964c7c3479fe0550ff724d"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/e99f9db0f5211455ca4256e8db9d9081967d255e",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e99f9db0f5211455ca4256e8db9d9081967d255e",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/e99f9db0f5211455ca4256e8db9d9081967d255e",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e99f9db0f5211455ca4256e8db9d9081967d255e/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "c6a636ce375d5af4ce0b3aa78b1cc90fd82040bd",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c6a636ce375d5af4ce0b3aa78b1cc90fd82040bd",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/c6a636ce375d5af4ce0b3aa78b1cc90fd82040bd"
    }
  ],
  "stats": {
    "total": 22,
    "additions": 16,
    "deletions": 6
  },
  "files": [
    {
      "sha": "84b3d68051fc8a28d98d9d476c8209b8f8a52849",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e99f9db0f5211455ca4256e8db9d9081967d255e/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e99f9db0f5211455ca4256e8db9d9081967d255e/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=e99f9db0f5211455ca4256e8db9d9081967d255e",
      "patch": "@@ -1,3 +1,10 @@\n+2019-06-10  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/24545\n+\t* symtab.c (struct demangled_name_entry): Add language field.\n+\t(symbol_set_names):  Revert \"[gdb/symtab] Fix language of duplicate\n+\tstatic minimal symbol\".  Set and use language field.\n+\n 2019-06-10  Tom Tromey  <tromey@adacore.com>\n \n \t* ada-lang.c (_initialize_ada_language): Update help text."
    },
    {
      "sha": "4920d94a247a18daf4e34ab7302de307b74911a5",
      "filename": "gdb/symtab.c",
      "status": "modified",
      "additions": 9,
      "deletions": 6,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e99f9db0f5211455ca4256e8db9d9081967d255e/gdb/symtab.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e99f9db0f5211455ca4256e8db9d9081967d255e/gdb/symtab.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/symtab.c?ref=e99f9db0f5211455ca4256e8db9d9081967d255e",
      "patch": "@@ -713,6 +713,7 @@ symbol_set_language (struct general_symbol_info *gsymbol,\n struct demangled_name_entry\n {\n   const char *mangled;\n+  ENUM_BITFIELD(language) language : LANGUAGE_BITS;\n   char demangled[1];\n };\n \n@@ -853,11 +854,6 @@ symbol_set_names (struct general_symbol_info *gsymbol,\n   else\n     linkage_name_copy = linkage_name;\n \n-  /* Set the symbol language.  */\n-  char *demangled_name_ptr\n-    = symbol_find_demangled_name (gsymbol, linkage_name_copy);\n-  gdb::unique_xmalloc_ptr<char> demangled_name (demangled_name_ptr);\n-\n   entry.mangled = linkage_name_copy;\n   slot = ((struct demangled_name_entry **)\n \t  htab_find_slot (per_bfd->demangled_names_hash.get (),\n@@ -870,6 +866,9 @@ symbol_set_names (struct general_symbol_info *gsymbol,\n       || (gsymbol->language == language_go\n \t  && (*slot)->demangled[0] == '\\0'))\n     {\n+      char *demangled_name_ptr\n+\t= symbol_find_demangled_name (gsymbol, linkage_name_copy);\n+      gdb::unique_xmalloc_ptr<char> demangled_name (demangled_name_ptr);\n       int demangled_len = demangled_name ? strlen (demangled_name.get ()) : 0;\n \n       /* Suppose we have demangled_name==NULL, copy_name==0, and\n@@ -906,12 +905,16 @@ symbol_set_names (struct general_symbol_info *gsymbol,\n \t  strcpy (mangled_ptr, linkage_name_copy);\n \t  (*slot)->mangled = mangled_ptr;\n \t}\n+      (*slot)->language = gsymbol->language;\n \n       if (demangled_name != NULL)\n-\tstrcpy ((*slot)->demangled, demangled_name.get());\n+\tstrcpy ((*slot)->demangled, demangled_name.get ());\n       else\n \t(*slot)->demangled[0] = '\\0';\n     }\n+  else if (gsymbol->language == language_unknown\n+\t   || gsymbol->language == language_auto)\n+    gsymbol->language = (*slot)->language;\n \n   gsymbol->name = (*slot)->mangled;\n   if ((*slot)->demangled[0] != '\\0')"
    }
  ]
}