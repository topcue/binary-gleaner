{
  "sha": "003aae076207dbf32f98ba846158fc32669ef85f",
  "node_id": "C_kwDOANOeidoAKDAwM2FhZTA3NjIwN2RiZjMyZjk4YmE4NDYxNThmYzMyNjY5ZWY4NWY",
  "commit": {
    "author": {
      "name": "Lancelot SIX",
      "email": "lancelot.six@amd.com",
      "date": "2021-12-06T10:23:42Z"
    },
    "committer": {
      "name": "Lancelot SIX",
      "email": "lancelot.six@amd.com",
      "date": "2021-12-29T08:27:38Z"
    },
    "message": "gdb: Copy inferior properties in clone-inferior\n\nThis commit ensures that the following settings are cloned from one\ninferior to the new one when processing the clone-inferior command:\n  - inferior-tty\n  - environment variables\n  - cwd\n  - args\n\nSome of those parameters can be passed as command line arguments to GDB\n(-args and -tty), so one could expect the clone-inferior to respect\nthose flags.  The following debugging session illustrates that:\n\n    gdb -nx -quiet -batch \\\n         -ex \"show args\" \\\n         -ex \"show inferior-tty\" \\\n         -ex \"clone-inferior\" \\\n         -ex \"inferior 2\" \\\n         -ex \"show args\" \\\n         -ex \"show inferior-tty\" \\\n         -tty=/some/tty \\\n         -args echo foo bar\n    Argument list to give program being debugged when it is started is \"foo bar\".\n    Terminal for future runs of program being debugged is \"/some/tty\".\n    [New inferior 2]\n    Added inferior 2.\n    [Switching to inferior 2 [<null>] (/bin/echo)]\n    Argument list to give program being debugged when it is started is \"\".\n    Terminal for future runs of program being debugged is \"\".\n\nThe other properties this commit copies on clone (i.e. CWD and the\nenvironment variables) are included since they are related (in the sense\nthat they influence the runtime behavior of the program) even if they\ncannot be directly set using command line switches.\n\nThere is a chance that this patch changes existing user workflow.  I\nthink that this change is mostly harmless.  If users want to start a new\ninferior based on an existing one, they probably already propagate those\nsettings to the new inferior in some way.\n\nTested on x86_64-linux.\n\nChange-Id: I3b1f28b662f246228b37bb24c2ea1481567b363d",
    "tree": {
      "sha": "9d10c1c387f413469d7e8428096bb5e2d5ee8fde",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/9d10c1c387f413469d7e8428096bb5e2d5ee8fde"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/003aae076207dbf32f98ba846158fc32669ef85f",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/003aae076207dbf32f98ba846158fc32669ef85f",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/003aae076207dbf32f98ba846158fc32669ef85f",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/003aae076207dbf32f98ba846158fc32669ef85f/comments",
  "author": {
    "login": "lancesix",
    "id": 98881381,
    "node_id": "U_kgDOBeTPZQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/98881381?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lancesix",
    "html_url": "https://github.com/lancesix",
    "followers_url": "https://api.github.com/users/lancesix/followers",
    "following_url": "https://api.github.com/users/lancesix/following{/other_user}",
    "gists_url": "https://api.github.com/users/lancesix/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lancesix/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lancesix/subscriptions",
    "organizations_url": "https://api.github.com/users/lancesix/orgs",
    "repos_url": "https://api.github.com/users/lancesix/repos",
    "events_url": "https://api.github.com/users/lancesix/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lancesix/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "lancesix",
    "id": 98881381,
    "node_id": "U_kgDOBeTPZQ",
    "avatar_url": "https://avatars.githubusercontent.com/u/98881381?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/lancesix",
    "html_url": "https://github.com/lancesix",
    "followers_url": "https://api.github.com/users/lancesix/followers",
    "following_url": "https://api.github.com/users/lancesix/following{/other_user}",
    "gists_url": "https://api.github.com/users/lancesix/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/lancesix/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/lancesix/subscriptions",
    "organizations_url": "https://api.github.com/users/lancesix/orgs",
    "repos_url": "https://api.github.com/users/lancesix/repos",
    "events_url": "https://api.github.com/users/lancesix/events{/privacy}",
    "received_events_url": "https://api.github.com/users/lancesix/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "39907652260b9adc16958e0cbeefa9bc98e9106a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/39907652260b9adc16958e0cbeefa9bc98e9106a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/39907652260b9adc16958e0cbeefa9bc98e9106a"
    }
  ],
  "stats": {
    "total": 125,
    "additions": 123,
    "deletions": 2
  },
  "files": [
    {
      "sha": "c26e15b530a0c64c436fe8d0b506b1f0da44bfe5",
      "filename": "gdb/NEWS",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/003aae076207dbf32f98ba846158fc32669ef85f/gdb/NEWS",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/003aae076207dbf32f98ba846158fc32669ef85f/gdb/NEWS",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/NEWS?ref=003aae076207dbf32f98ba846158fc32669ef85f",
      "patch": "@@ -72,6 +72,13 @@ maint packet\n   as escaped hex, e.g. \\x?? where '??' is replaces with the value of\n   the non-printable character.\n \n+clone-inferior\n+  The clone-inferior command now ensures that the TTY, CMD and ARGS\n+  settings are copied from the original inferior to the new one.\n+  All modifications to the environment variables done using the 'set\n+  environment' or 'unset environment' commands are also copied to the new\n+  inferior.\n+\n * Python API\n \n   ** New function gdb.add_history(), which takes a gdb.Value object"
    },
    {
      "sha": "77cd184c47bf7ae989d5bc71824f7a8a7b3e8fa8",
      "filename": "gdb/doc/gdb.texinfo",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/003aae076207dbf32f98ba846158fc32669ef85f/gdb/doc/gdb.texinfo",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/003aae076207dbf32f98ba846158fc32669ef85f/gdb/doc/gdb.texinfo",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/doc/gdb.texinfo?ref=003aae076207dbf32f98ba846158fc32669ef85f",
      "patch": "@@ -3331,8 +3331,12 @@ use @code{run} to spawn a local program, etc.\n @item clone-inferior [ -copies @var{n} ] [ @var{infno} ]\n Adds @var{n} inferiors ready to execute the same program as inferior\n @var{infno}; @var{n} defaults to 1, and @var{infno} defaults to the\n-number of the current inferior.  This is a convenient command when you\n-want to run another instance of the inferior you are debugging.\n+number of the current inferior.  This command copies the values of the\n+@var{args}, @w{@var{inferior-tty}} and @var{cwd} properties from the\n+current inferior to the new one.  It also propagates changes the user\n+made to environment variables using the @w{@code{set environment}} and\n+@w{@code{unset environment}} commands.  This is a convenient command\n+when you want to run another instance of the inferior you are debugging.\n \n @smallexample\n (@value{GDBP}) info inferiors"
    },
    {
      "sha": "52aa6fb955c138b3bd27acc98c1dea7fab971e2a",
      "filename": "gdb/inferior.c",
      "status": "modified",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/003aae076207dbf32f98ba846158fc32669ef85f/gdb/inferior.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/003aae076207dbf32f98ba846158fc32669ef85f/gdb/inferior.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/inferior.c?ref=003aae076207dbf32f98ba846158fc32669ef85f",
      "patch": "@@ -934,6 +934,23 @@ clone_inferior_command (const char *args, int from_tty)\n \tcopy_inferior_target_desc_info (inf, orginf);\n \n       clone_program_space (pspace, orginf->pspace);\n+\n+      /* Copy properties from the original inferior to the new one.  */\n+      inf->set_args (orginf->args ());\n+      inf->set_cwd (orginf->cwd ());\n+      inf->set_tty (orginf->tty ());\n+      for (const std::string &set_var : orginf->environment.user_set_env ())\n+\t{\n+\t  /* set_var has the form NAME=value.  Split on the first '='.  */\n+\t  const std::string::size_type pos = set_var.find ('=');\n+\t  gdb_assert (pos != std::string::npos);\n+\t  const std::string varname = set_var.substr (0, pos);\n+\t  inf->environment.set\n+\t    (varname.c_str (), orginf->environment.get (varname.c_str ()));\n+\t}\n+      for (const std::string &unset_var\n+\t   : orginf->environment.user_unset_env ())\n+\tinf->environment.unset (unset_var.c_str ());\n     }\n }\n "
    },
    {
      "sha": "bb43be696723cc77b6da60fb98893946db3dd9ad",
      "filename": "gdb/testsuite/gdb.base/inferior-clone.exp",
      "status": "added",
      "additions": 93,
      "deletions": 0,
      "changes": 93,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/003aae076207dbf32f98ba846158fc32669ef85f/gdb/testsuite/gdb.base/inferior-clone.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/003aae076207dbf32f98ba846158fc32669ef85f/gdb/testsuite/gdb.base/inferior-clone.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/inferior-clone.exp?ref=003aae076207dbf32f98ba846158fc32669ef85f",
      "patch": "@@ -0,0 +1,93 @@\n+# Copyright (C) 2021 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+# This testcase checks that the clone-inferior command copies important\n+# properties from the original to the new inferior such CWD, args and env.\n+\n+# Add an environment variable that can be modified later for each inferior\n+# in GDB.\n+set env(ENVVAR) var\n+\n+# This test does not need a binfile.\n+clean_restart\n+\n+# Set custom properties for Inferior 1\n+with_test_prefix \"setup inferior 1\" {\n+    gdb_test_no_output \"set args foo bar 'b a z'\"\n+    gdb_test_no_output \"set cwd /any/where\"\n+    gdb_test_no_output \"set environment FOO foo\"\n+    gdb_test_no_output \"set environment BAR bar\"\n+    gdb_test_no_output \"set inferior-tty some_tty\"\n+}\n+\n+# Check that properties of inferior 1 have been copied\n+with_test_prefix \"inferior 2\" {\n+    gdb_test \"clone-inferior\" \"Added inferior 2\"\n+    gdb_test \"inferior 2\" \"\\[Switching to inferior 2 \\[<null>\\] (.*)\\]\" \"change inferior\"\n+    gdb_test \"show args\" \\\n+\t\"Argument list to give program being debugged when it is started is \\\"foo bar 'b a z'\\\"\\.\"\n+    gdb_test \"show cwd\" \\\n+\t\"Current working directory that will be used when starting the inferior is \\\"/any/where\\\"\\.\"\n+    gdb_test \"show environment FOO\" \"FOO = foo\"\n+    gdb_test \"show environment BAR\" \"BAR = bar\"\n+    gdb_test \"show environment ENVVAR\" \"ENVVAR = var\"\n+    gdb_test \"show inferior-tty\" \\\n+\t\"Terminal for future runs of program being debugged is \\\"some_tty\\\"\\.\"\n+}\n+\n+# Change this second inferior, to check that the next clone-inferior\n+# clones from the active inferior, and changing the values for inferior 2\n+# does not interfere with values on inferior 1.\n+with_test_prefix \"update inferior 2\" {\n+    gdb_test_no_output \"set args foo\"\n+    gdb_test_no_output \"set cwd /somewhere/else\"\n+    gdb_test_no_output \"set environment FOO oof\"\n+}\n+\n+with_test_prefix \"inferior 1\" {\n+    gdb_test \"inferior 1\" \"\\[Switching to inferior 1 \\[<null>\\] (.*)\\]\" \"change inferior\"\n+    gdb_test \"show args\" \\\n+\t\"Argument list to give program being debugged when it is started is \\\"foo bar 'b a z'\\\"\\.\"\n+    gdb_test \"show cwd\" \\\n+\t\"Current working directory that will be used when starting the inferior is \\\"/any/where\\\"\\.\"\n+    gdb_test \"show environment FOO\" \"FOO = foo\"\n+    gdb_test \"show environment BAR\" \"BAR = bar\"\n+    gdb_test \"show environment ENVVAR\" \"ENVVAR = var\"\n+    gdb_test \"show inferior-tty\" \\\n+\t\"Terminal for future runs of program being debugged is \\\"some_tty\\\"\\.\"\n+}\n+\n+# Tweak inferior 1 a bit more.\n+with_test_prefix \"update inferior 1\" {\n+    gdb_test_no_output \"unset environment FOO\"\n+    gdb_test_no_output \"unset environment ENVVAR\"\n+}\n+\n+\n+# Check that the values observed on inferior 3 are those copied from\n+# inferior 1.\n+with_test_prefix \"inferior 3\" {\n+    gdb_test \"clone-inferior\" \"Added inferior 3\"\n+    gdb_test \"inferior 3\" \"\\[Switching to inferior 3 \\[<null>\\] (.*)\\]\" \"change inferior\"\n+    gdb_test \"show args\" \\\n+\t\"Argument list to give program being debugged when it is started is \\\"foo bar 'b a z'\\\"\\.\"\n+    gdb_test \"show cwd\" \\\n+\t\"Current working directory that will be used when starting the inferior is \\\"/any/where\\\"\\.\"\n+    gdb_test \"show environment FOO\" \"Environment variable \\\"FOO\\\" not defined\\.\"\n+    gdb_test \"show environment BAR\" \"BAR = bar\"\n+    gdb_test \"show environment ENVVAR\" \"Environment variable \\\"ENVVAR\\\" not defined\\.\"\n+    gdb_test \"show inferior-tty\" \\\n+\t\"Terminal for future runs of program being debugged is \\\"some_tty\\\"\\.\"\n+}"
    }
  ]
}