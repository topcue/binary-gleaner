{
  "sha": "eed62915fd5b733632af343fbf3d47c7364f8e36",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZWVkNjI5MTVmZDViNzMzNjMyYWYzNDNmYmYzZDQ3YzczNjRmOGUzNg==",
  "commit": {
    "author": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2019-02-16T00:43:23Z"
    },
    "committer": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2019-02-20T10:51:01Z"
    },
    "message": "bfd: xtensa: fix callx relaxation\n\nBig section alignment requirements between source and destination of a\nlong call can result in making call range bigger than what's reachable\nby the call opcode. Add biggest section alignment of sections between\nthe call site and call destination to the call distance when making\nlong call relaxation decision.\n\n2019-02-20  Eric Tsai  <erictsai@cadence.com>\nbfd/\n\t* elf32-xtensa.c (is_resolvable_asm_expansion): Scan output\n\tsections between the call site and call destination and adjust\n\tcall distance by the largest alignment.\n\nld/\n\t* testsuite/ld-xtensa/call_overflow.d: New test definition.\n\t* testsuite/ld-xtensa/call_overflow1.s: New test source.\n\t* testsuite/ld-xtensa/call_overflow2.s: New test source.\n\t* testsuite/ld-xtensa/call_overflow3.s: New test source.\n\t* testsuite/ld-xtensa/xtensa.exp: Add call_overflow test.",
    "tree": {
      "sha": "eaa3e22f860ab7872196fea0cd0f7740d4b6da80",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/eaa3e22f860ab7872196fea0cd0f7740d4b6da80"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/eed62915fd5b733632af343fbf3d47c7364f8e36",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/eed62915fd5b733632af343fbf3d47c7364f8e36",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/eed62915fd5b733632af343fbf3d47c7364f8e36",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/eed62915fd5b733632af343fbf3d47c7364f8e36/comments",
  "author": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e6c3b5bfb449d1a02d26f3c4bae5b732951479fc",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e6c3b5bfb449d1a02d26f3c4bae5b732951479fc",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/e6c3b5bfb449d1a02d26f3c4bae5b732951479fc"
    }
  ],
  "stats": {
    "total": 105,
    "additions": 105,
    "deletions": 0
  },
  "files": [
    {
      "sha": "ce088c96cdab1e82dc670bd0f24c2c763f2aece8",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -1,3 +1,9 @@\n+2019-02-20  Eric Tsai  <erictsai@cadence.com>\n+\n+\t* elf32-xtensa.c (is_resolvable_asm_expansion): Scan output\n+\tsections between the call site and call destination and adjust\n+\tcall distance by the largest alignment.\n+\n 2019-02-20  Alan Hayward  <alan.hayward@arm.com>\n \n \t* elf-bfd.h (elfcore_write_aarch_pauth): Add declaration."
    },
    {
      "sha": "c3df3d6db756eaeafb49bfb7a1439b73d77162b2",
      "filename": "bfd/elf32-xtensa.c",
      "status": "modified",
      "additions": 55,
      "deletions": 0,
      "changes": 55,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/bfd/elf32-xtensa.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/bfd/elf32-xtensa.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf32-xtensa.c?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -7195,6 +7195,11 @@ is_resolvable_asm_expansion (bfd *abfd,\n \t\t\t     bfd_boolean *is_reachable_p)\n {\n   asection *target_sec;\n+  asection *s;\n+  bfd_vma first_vma;\n+  bfd_vma last_vma;\n+  unsigned int first_align;\n+  unsigned int adjust;\n   bfd_vma target_offset;\n   r_reloc r_rel;\n   xtensa_opcode opcode, direct_call_opcode;\n@@ -7283,6 +7288,56 @@ is_resolvable_asm_expansion (bfd *abfd,\n \t\t      + target_sec->output_offset + target_offset);\n     }\n \n+  /* Adjust addresses with alignments for the worst case to see if call insn\n+     can fit.  Don't relax l32r + callx to call if the target can be out of\n+     range due to alignment.\n+     Caller and target addresses are highest and lowest address.\n+     Search all sections between caller and target, looking for max alignment.\n+     The adjustment is max alignment bytes.  If the alignment at the lowest\n+     address is less than the adjustment, apply the adjustment to highest\n+     address.  */\n+\n+  /* Start from lowest address.\n+     Lowest address aligmnet is from input section.\n+     Initial alignment (adjust) is from input section.  */\n+  if (dest_address > self_address)\n+    {\n+      s = sec->output_section;\n+      last_vma = dest_address;\n+      first_align = sec->alignment_power;\n+      adjust = target_sec->alignment_power;\n+    }\n+  else\n+    {\n+      s = target_sec->output_section;\n+      last_vma = self_address;\n+      first_align = target_sec->alignment_power;\n+      adjust = sec->alignment_power;\n+    }\n+\n+  first_vma = s->vma;\n+\n+  /* Find the largest alignment in output section list.  */\n+  for (; s && s->vma >= first_vma && s->vma <= last_vma ; s = s->next)\n+    {\n+      if (s->alignment_power > adjust)\n+\tadjust = s->alignment_power;\n+    }\n+\n+  if (adjust > first_align)\n+    {\n+      /* Alignment may enlarge the range, adjust highest address.  */\n+      adjust = 1 << adjust;\n+      if (dest_address > self_address)\n+\t{\n+\t  dest_address += adjust;\n+\t}\n+      else\n+\t{\n+\t  self_address += adjust;\n+\t}\n+    }\n+\n   *is_reachable_p = pcrel_reloc_fits (direct_call_opcode, 0,\n \t\t\t\t      self_address, dest_address);\n "
    },
    {
      "sha": "0e00e41b920986a6edbdc60a96165eca35ae4800",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -1,3 +1,11 @@\n+2019-02-20  Eric Tsai  <erictsai@cadence.com>\n+\n+\t* testsuite/ld-xtensa/call_overflow.d: New test definition.\n+\t* testsuite/ld-xtensa/call_overflow1.s: New test source.\n+\t* testsuite/ld-xtensa/call_overflow2.s: New test source.\n+\t* testsuite/ld-xtensa/call_overflow3.s: New test source.\n+\t* testsuite/ld-xtensa/xtensa.exp: Add call_overflow test.\n+\n 2019-02-14  Thomas Schwinge  <thomas@codesourcery.com>\n \n \t* testsuite/ld-elf/elf.exp: Remove Hurd XFAILs."
    },
    {
      "sha": "95728488567f3eca181154dc65c75d792bc2311d",
      "filename": "ld/testsuite/ld-xtensa/call_overflow.d",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/call_overflow.d?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -0,0 +1,7 @@\n+#source: call_overflow1.s\n+#source: call_overflow2.s\n+#source: call_overflow3.s\n+#as: --longcalls\n+#ld:\n+#objdump: -d\n+#..."
    },
    {
      "sha": "8b032892e20f9605335644a67280906a31ecad4a",
      "filename": "ld/testsuite/ld-xtensa/call_overflow1.s",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/call_overflow1.s?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -0,0 +1,9 @@\n+\t.text\n+\t.global _start\n+\t.align 4\n+_start:\n+\tcall8\ta\n+\t.rep\t2051\n+\tnop.n\n+\tnop.n\n+\t.endr"
    },
    {
      "sha": "c3f36fa90f3383f0aecbdd32649f8095d4fdb108",
      "filename": "ld/testsuite/ld-xtensa/call_overflow2.s",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/call_overflow2.s?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -0,0 +1,14 @@\n+\t.text\n+\t.global a\n+\t.align\t4\n+a:\n+\tj\ta\n+\n+\t.align\t4\n+x:\n+\tcall8\tb\n+#29\n+\t.rep\t131070\n+\tnop.n\n+\tnop.n\n+\t.endr"
    },
    {
      "sha": "33f59d8bc0bb9325fdd02dec9229b20d52c4b2cd",
      "filename": "ld/testsuite/ld-xtensa/call_overflow3.s",
      "status": "added",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow3.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/call_overflow3.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/call_overflow3.s?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -0,0 +1,5 @@\n+\t.text\n+\t.align 32\n+\t.global b\n+b:\n+\tj\tb"
    },
    {
      "sha": "91b23142b126dac7244813b16fbc0038a2e4f669",
      "filename": "ld/testsuite/ld-xtensa/xtensa.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/xtensa.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eed62915fd5b733632af343fbf3d47c7364f8e36/ld/testsuite/ld-xtensa/xtensa.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/xtensa.exp?ref=eed62915fd5b733632af343fbf3d47c7364f8e36",
      "patch": "@@ -23,6 +23,7 @@ if { !([istarget \"xtensa*-*-*\"]) } {\n     return\n }\n \n+run_dump_test \"call_overflow\"\n run_dump_test \"coalesce\"\n run_dump_test \"diff_overflow\"\n run_dump_test \"lcall\""
    }
  ]
}