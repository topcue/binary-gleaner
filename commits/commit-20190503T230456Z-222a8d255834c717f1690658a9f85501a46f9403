{
  "sha": "222a8d255834c717f1690658a9f85501a46f9403",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MjIyYThkMjU1ODM0YzcxN2YxNjkwNjU4YTlmODU1MDFhNDZmOTQwMw==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-05-03T18:18:26Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-05-03T23:04:56Z"
    },
    "message": "Fix cast of character to enum type in Ada\n\nAn internal bug report points out that, when a global character enum\ntype is used, casting fails, like:\n\n    (gdb) print global_char_enum'('F')\n    $1 = 70\n\nThe bug here turns out to be that enumerators are qualified, so for\nexample the mangled name might be \"pck__QU48\", rather than \"QU48\".\n\nThis patch fixes the problem by only examining the suffix of the\nenumerator.  This is ok because the type is already known, and because\nthe mangling scheme ensures that there won't be clashes.\n\nTested on x86-64 Fedora 29.\n\ngdb/ChangeLog\n2019-05-03  Tom Tromey  <tromey@adacore.com>\n\n\t* ada-exp.y (convert_char_literal): Check suffix of each\n\tenumerator.\n\ngdb/testsuite/ChangeLog\n2019-05-03  Tom Tromey  <tromey@adacore.com>\n\n\t* gdb.ada/char_enum/pck.ads (Global_Enum_Type): New type.\n\t* gdb.ada/char_enum/foo.adb: Use Global_Enum_Type.\n\t* gdb.ada/char_enum.exp: Add test.",
    "tree": {
      "sha": "181737fca35a8953bc59e915c910d0d18eaf489f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/181737fca35a8953bc59e915c910d0d18eaf489f"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/222a8d255834c717f1690658a9f85501a46f9403",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/222a8d255834c717f1690658a9f85501a46f9403",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/222a8d255834c717f1690658a9f85501a46f9403",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/222a8d255834c717f1690658a9f85501a46f9403/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "fcd60b848ed7619461b0b0e316201e7745cdb61d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/fcd60b848ed7619461b0b0e316201e7745cdb61d",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/fcd60b848ed7619461b0b0e316201e7745cdb61d"
    }
  ],
  "stats": {
    "total": 26,
    "additions": 23,
    "deletions": 3
  },
  "files": [
    {
      "sha": "2172a030c7dedcf1bd3ac3216fc829232c8621eb",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -1,3 +1,8 @@\n+2019-05-03  Tom Tromey  <tromey@adacore.com>\n+\n+\t* ada-exp.y (convert_char_literal): Check suffix of each\n+\tenumerator.\n+\n 2019-05-03  Dilyan Palauzov  <dilyan.palauzov@aegee.org>\n \n \tPR ada/21406:"
    },
    {
      "sha": "92461dbcb694294232b89a399fca716669327303",
      "filename": "gdb/ada-exp.y",
      "status": "modified",
      "additions": 9,
      "deletions": 1,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/ada-exp.y",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/ada-exp.y",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ada-exp.y?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -1407,9 +1407,17 @@ convert_char_literal (struct type *type, LONGEST val)\n     return val;\n \n   xsnprintf (name, sizeof (name), \"QU%02x\", (int) val);\n+  size_t len = strlen (name);\n   for (f = 0; f < TYPE_NFIELDS (type); f += 1)\n     {\n-      if (strcmp (name, TYPE_FIELD_NAME (type, f)) == 0)\n+      /* Check the suffix because an enum constant in a package will\n+\t have a name like \"pkg__QUxx\".  This is safe enough because we\n+\t already have the correct type, and because mangling means\n+\t there can't be clashes.  */\n+      const char *ename = TYPE_FIELD_NAME (type, f);\n+      size_t elen = strlen (ename);\n+\n+      if (elen >= len && strcmp (name, ename + elen - len) == 0)\n \treturn TYPE_FIELD_ENUMVAL (type, f);\n     }\n   return val;"
    },
    {
      "sha": "72fc0d812107e36d49e7974286452abd622138d6",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -1,3 +1,9 @@\n+2019-05-03  Tom Tromey  <tromey@adacore.com>\n+\n+\t* gdb.ada/char_enum/pck.ads (Global_Enum_Type): New type.\n+\t* gdb.ada/char_enum/foo.adb: Use Global_Enum_Type.\n+\t* gdb.ada/char_enum.exp: Add test.\n+\n 2019-05-03  Tom de Vries  <tdevries@suse.de>\n \n \t* boards/cc-with-gdb-index.exp: New file."
    },
    {
      "sha": "c37d696f66d02d957117438b0006b66bf2d72ef7",
      "filename": "gdb/testsuite/gdb.ada/char_enum.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/char_enum.exp?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -27,5 +27,4 @@ set bp_location [gdb_get_line_number \"STOP\" ${testdir}/foo.adb]\n runto \"foo.adb:$bp_location\"\n \n gdb_test \"print Char_Enum_Type'('B')\" \"= 1 'B'\"\n-\n-\n+gdb_test \"print pck.Global_Enum_Type'('Y')\" \"= 1 'Y'\""
    },
    {
      "sha": "cf7fb7d339918d9959037959dda00d9c67d25b10",
      "filename": "gdb/testsuite/gdb.ada/char_enum/foo.adb",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum/foo.adb",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum/foo.adb",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/char_enum/foo.adb?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -18,6 +18,7 @@ with Pck; use Pck;\n procedure Foo is\n    type Char_Enum_Type is ('A', 'B', 'C', 'D', 'E');\n    Char : Char_Enum_Type := 'D';\n+   Gchar : Global_Enum_Type := 'Z';\n begin\n    Do_Nothing (Char'Address);  -- STOP\n end Foo;"
    },
    {
      "sha": "f952e1c31c1eba973c4dbaa43aa44487f40fb213",
      "filename": "gdb/testsuite/gdb.ada/char_enum/pck.ads",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum/pck.ads",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/222a8d255834c717f1690658a9f85501a46f9403/gdb/testsuite/gdb.ada/char_enum/pck.ads",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/char_enum/pck.ads?ref=222a8d255834c717f1690658a9f85501a46f9403",
      "patch": "@@ -16,6 +16,7 @@\n with System;\n \n package Pck is\n+   type Global_Enum_Type is ('X', 'Y', 'Z');\n    procedure Do_Nothing (A : System.Address);\n end Pck;\n "
    }
  ]
}