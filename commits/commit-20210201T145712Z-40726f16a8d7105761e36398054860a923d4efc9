{
  "sha": "40726f16a8d7105761e36398054860a923d4efc9",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NDA3MjZmMTZhOGQ3MTA1NzYxZTM2Mzk4MDU0ODYwYTkyM2Q0ZWZjOQ==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-01-31T22:45:41Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-02-01T14:57:12Z"
    },
    "message": "ld script expression parsing\n\nParsing symbol or file/section names in ld linker scripts is a little\ncomplicated.  Inside SECTIONS, a name might be the start of an\nexpression or an output section.  Is \".foo=x-y\" a fancy section name\nor is it the expression \".foo = x - y\"?  It isn't possible for a\nsingle lookahead parser to decide, so the answer in this case is\nthat it's a section name.  This is the reason why everyone writes\nlinker script assignment expressions with lots of white-space.\n\nHowever, there are many places where the parser knows for sure that an\nexpression is expected.  Those could be written without whitespace\ngiven the first change to ldlex.l below.  Unfortunately, that runs\ninto a lookahead problem.  Optional expressions at the end of an\noutput section statement require the parser to look ahead one token in\nexpression context.  For this example from standard scripts\n  .interp             : { *(.interp) }\n  .note.gnu.build-id  : { *(.note.gnu.build-id) }\nat the end of the .interp closing brace, the parser is looking for\na possible memspec, phdr, fill or even an optional comma.  The next\ntoken is a NAME, but in expression context that NAME now doesn't\ninclude '-' as a valid char.  So the lookahead NAME is\n\".note.gnu.build\" with an unexpected \"-id\" syntax error before the\ncolon.  The rest of the patch involving ldlex_backup arranges to\ndiscard that NAME token so that it will be rescanned in the proper\nscript context.\n\n\t* ldgram.y (section): Call ldlex_backup.  Remove empty action.\n\t* ldlex.h (ldlex_backup): Declare.\n\t* ldlex.l (<EXPRESSION>NAME): Don't use NOCFILENAMECHAR set of\n\tchars, use SYMBOLNAMECHAR.\n\t(ldlex_backup): New function.",
    "tree": {
      "sha": "06d77510d97baeed95b4e7f56c0c20ed5cc8bdad",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/06d77510d97baeed95b4e7f56c0c20ed5cc8bdad"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/40726f16a8d7105761e36398054860a923d4efc9",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/40726f16a8d7105761e36398054860a923d4efc9",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/40726f16a8d7105761e36398054860a923d4efc9",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/40726f16a8d7105761e36398054860a923d4efc9/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "82a1fd3a4935fe665cf08bc6820942c4a091184c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/82a1fd3a4935fe665cf08bc6820942c4a091184c",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/82a1fd3a4935fe665cf08bc6820942c4a091184c"
    }
  ],
  "stats": {
    "total": 32,
    "additions": 30,
    "deletions": 2
  },
  "files": [
    {
      "sha": "c5f73f8646b801c9d0c458970cd916d09b5f4e3b",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/40726f16a8d7105761e36398054860a923d4efc9/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/40726f16a8d7105761e36398054860a923d4efc9/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=40726f16a8d7105761e36398054860a923d4efc9",
      "patch": "@@ -1,3 +1,11 @@\n+2021-02-01  Alan Modra  <amodra@gmail.com>\n+\n+\t* ldgram.y (section): Call ldlex_backup.  Remove empty action.\n+\t* ldlex.h (ldlex_backup): Declare.\n+\t* ldlex.l (<EXPRESSION>NAME): Don't use NOCFILENAMECHAR set of\n+\tchars, use SYMBOLNAMECHAR.\n+\t(ldlex_backup): New function.\n+\n 2021-02-01  Alan Modra  <amodra@gmail.com>\n \n \t* ldgram.y: Whitespace fixes."
    },
    {
      "sha": "08dc110f3da9993c10165e65b183a9e15cd1901b",
      "filename": "ld/ldgram.y",
      "status": "modified",
      "additions": 10,
      "deletions": 1,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/40726f16a8d7105761e36398054860a923d4efc9/ld/ldgram.y",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/40726f16a8d7105761e36398054860a923d4efc9/ld/ldgram.y",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldgram.y?ref=40726f16a8d7105761e36398054860a923d4efc9",
      "patch": "@@ -1071,11 +1071,15 @@ section:\tNAME\t\t{ ldlex_expression(); }\n \t\t'}' { ldlex_popstate (); ldlex_expression (); }\n \t\tmemspec_opt memspec_at_opt phdr_opt fill_opt\n \t\t{\n+\t\t  if (yychar == NAME)\n+\t\t    {\n+\t\t      yyclearin;\n+\t\t      ldlex_backup ();\n+\t\t    }\n \t\t  ldlex_popstate ();\n \t\t  lang_leave_output_section_statement ($18, $15, $17, $16);\n \t\t}\n \t\topt_comma\n-\t\t{}\n \t|\tOVERLAY\n \t\t\t{ ldlex_expression (); }\n \t\topt_exp_without_type opt_nocrossrefs opt_at opt_subalign\n@@ -1089,6 +1093,11 @@ section:\tNAME\t\t{ ldlex_expression(); }\n \t\t\t{ ldlex_popstate (); ldlex_expression (); }\n \t\tmemspec_opt memspec_at_opt phdr_opt fill_opt\n \t\t\t{\n+\t\t\t  if (yychar == NAME)\n+\t\t\t    {\n+\t\t\t      yyclearin;\n+\t\t\t      ldlex_backup ();\n+\t\t\t    }\n \t\t\t  ldlex_popstate ();\n \t\t\t  lang_leave_overlay ($5, (int) $4,\n \t\t\t\t\t      $16, $13, $15, $14);"
    },
    {
      "sha": "d9b36ea270207b4fc46dd45725f175d8cbab4bd3",
      "filename": "ld/ldlex.h",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/40726f16a8d7105761e36398054860a923d4efc9/ld/ldlex.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/40726f16a8d7105761e36398054860a923d4efc9/ld/ldlex.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldlex.h?ref=40726f16a8d7105761e36398054860a923d4efc9",
      "patch": "@@ -191,6 +191,7 @@ extern void ldlex_defsym (void);\n extern void ldlex_expression (void);\n extern void ldlex_both (void);\n extern void ldlex_popstate (void);\n+extern void ldlex_backup (void);\n extern const char* ldlex_filename (void);\n \n /* In lexsup.c.  */"
    },
    {
      "sha": "7652e8d2a29a432faaa4c6ffe2a5872c24a2c28a",
      "filename": "ld/ldlex.l",
      "status": "modified",
      "additions": 11,
      "deletions": 1,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/40726f16a8d7105761e36398054860a923d4efc9/ld/ldlex.l",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/40726f16a8d7105761e36398054860a923d4efc9/ld/ldlex.l",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldlex.l?ref=40726f16a8d7105761e36398054860a923d4efc9",
      "patch": "@@ -385,7 +385,7 @@ V_IDENTIFIER [*?.$_a-zA-Z\\[\\]\\-\\!\\^\\\\]([*?.$_a-zA-Z0-9\\[\\]\\-\\!\\^\\\\]|::)*\n \t\t\t\t  yylval.name = xstrdup (yytext + 2);\n \t\t\t\t  return LNAME;\n \t\t\t\t}\n-<EXPRESSION>{SYMBOLNAMECHAR1}{NOCFILENAMECHAR}* {\n+<EXPRESSION>{SYMBOLNAMECHAR1}{SYMBOLNAMECHAR}* {\n \t\t\t\t  yylval.name = xstrdup (yytext);\n \t\t\t\t  return NAME;\n \t\t\t\t}\n@@ -636,6 +636,16 @@ ldlex_popstate (void)\n   yy_start = *(--state_stack_p);\n }\n \n+/* In cases where the parser needs to look ahead and the context\n+   changes from expression to script or vice-versa, throw away a\n+   NAME.  What constitutes a NAME depends on context.  */\n+\n+void\n+ldlex_backup (void)\n+{\n+  yyless (0);\n+}\n+\n /* Return the current file name, or the previous file if no file is\n    current.  */\n "
    }
  ]
}