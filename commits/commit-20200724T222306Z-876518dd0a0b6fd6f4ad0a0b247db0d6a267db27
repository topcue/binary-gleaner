{
  "sha": "876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ODc2NTE4ZGQwYTBiNmZkNmY0YWQwYTBiMjQ3ZGIwZDZhMjY3ZGIyNw==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-07-24T22:23:06Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-07-24T22:23:06Z"
    },
    "message": "[gdb/symtab] Ignore zero line table entries\n\nThe DWARF standard states for the line register in the line number information\nstate machine the following:\n...\nAn unsigned integer indicating a source line number.  Lines are numbered\nbeginning at 1.  The compiler may emit the value 0 in cases where an\ninstruction cannot be attributed to any source line.\n...\n\nSo, it's possible to have a zero line number in the DWARF line table.\n\nThis is currently not handled by GDB.  The zero value is read in as any other\nline number, but internally the zero value has a special meaning:\nend-of-sequence, so the line table entry ends up having a different\ninterpretation than intended in some situations.\n\nI've created a test-case where various aspects are tested, which has these 4\ninteresting tests.\n\n1. Next-step through a zero-line instruction, is_stmt == 1\ngdb.dwarf2/dw2-line-number-zero.exp: bar1, 2nd next\n\n2. Next-step through a zero-line instruction, is_stmt == 0\ngdb.dwarf2/dw2-line-number-zero.exp: bar2, 2nd next\n\n3. Show source location at zero-line instruction, is_stmt == 1\ngdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar1_label_3\n\n4. Show source location at zero-line instruction, is_stmt == 0\ngdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar2_label_3\n\nAnd we have the following results:\n\n8.3.1, 9.2:\n...\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: bar1, 2nd next\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: bar2, 2nd next\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar1_label_3\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar2_label_3\n...\n\ncommit 8c95582da8 \"gdb: Add support for tracking the DWARF line table is-stmt\nfield\":\n...\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: bar1, 2nd next\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: bar2, 2nd next\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar1_label_3\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar2_label_3\n...\n\ncommit d8cc8af6a1 \"[gdb/symtab] Fix line-table end-of-sequence sorting\",\nmaster:\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: bar1, 2nd next\nFAIL: gdb.dwarf2/dw2-line-number-zero.exp: bar2, 2nd next\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar1_label_3\nPASS: gdb.dwarf2/dw2-line-number-zero.exp: continue to breakpoint: bar2_label_3\n...\n\nThe regression in test 2 at commit d8cc8af6a1 was filed as PR symtab/26243,\nwhere clang emits zero line numbers.\n\nThe way to fix all tests is to make sure line number zero internally doesn't\nclash with special meaning values, and by handling it appropriately\neverywhere.  That however looks too intrusive for the GDB 10 release.\n\nInstead, we decide to ensure defined behaviour for line number zero by\nignoring it.  This gives us back the test results from before commit\nd8cc8af6a1, fixing PR26243.\n\nWe mark the FAILs for tests 3 and 4 as KFAILs.  Test 4 was already failing for\nthe 9.2 release, and we consider the regression of test 3 from gdb 9.2 to gdb\n10 the cost for having defined behaviour.\n\nBuild and reg-tested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2020-07-25  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/26243\n\t* dwarf2/read.c (lnp_state_machine::record_line): Ignore zero line\n\tentries.\n\ngdb/testsuite/ChangeLog:\n\n2020-07-25  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/26243\n\t* gdb.dwarf2/dw2-line-number-zero.c: New test.\n\t* gdb.dwarf2/dw2-line-number-zero.exp: New file.",
    "tree": {
      "sha": "f2232c223a68f149048a9705568e6e16928a2a66",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/f2232c223a68f149048a9705568e6e16928a2a66"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "f6720b1cfe8f70ef5631b390780dfb53166e9ff2",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f6720b1cfe8f70ef5631b390780dfb53166e9ff2",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/f6720b1cfe8f70ef5631b390780dfb53166e9ff2"
    }
  ],
  "stats": {
    "total": 219,
    "additions": 217,
    "deletions": 2
  },
  "files": [
    {
      "sha": "464ae137ccbaaeb7e8e2704289859abee6fb4c33",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
      "patch": "@@ -1,3 +1,9 @@\n+2020-07-25  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/26243\n+\t* dwarf2/read.c (lnp_state_machine::record_line): Ignore zero line\n+\tentries.\n+\n 2020-07-24  Aaron Merey  <amerey@redhat.com>\n \n \t* Makefile.in: Replace LIBDEBUGINFOD with DEBUGINFOD_LIBS."
    },
    {
      "sha": "4e70dccecbc62ce6c454e816dd7d09085da98a70",
      "filename": "gdb/dwarf2/read.c",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/dwarf2/read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/dwarf2/read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/read.c?ref=876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
      "patch": "@@ -20437,8 +20437,9 @@ lnp_state_machine::record_line (bool end_sequence)\n \t  bool file_changed\n \t    = m_last_subfile != m_cu->get_builder ()->get_current_subfile ();\n \t  bool ignore_this_line\n-\t    = (file_changed && !end_sequence && m_last_address == m_address\n-\t       && !m_is_stmt && m_stmt_at_address);\n+           = ((file_changed && !end_sequence && m_last_address == m_address\n+               && !m_is_stmt && m_stmt_at_address)\n+              || (!end_sequence && m_line == 0));\n \n \t  if ((file_changed && !ignore_this_line) || end_sequence)\n \t    {"
    },
    {
      "sha": "e65caaf98d511427efbcc1c993d0267a1c772b3f",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
      "patch": "@@ -1,3 +1,9 @@\n+2020-07-25  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/26243\n+\t* gdb.dwarf2/dw2-line-number-zero.c: New test.\n+\t* gdb.dwarf2/dw2-line-number-zero.exp: New file.\n+\n 2020-07-24  Tom de Vries  <tdevries@suse.de>\n \n \tPR testsuite/26293"
    },
    {
      "sha": "15b37a6676edfa47f1813f74da52a7ab2c24a39e",
      "filename": "gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.c",
      "status": "added",
      "additions": 62,
      "deletions": 0,
      "changes": 62,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.c?ref=876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
      "patch": "@@ -0,0 +1,62 @@\n+/*\n+   Copyright 2020 Free Software Foundation, Inc.\n+\n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 3 of the License, or\n+   (at your option) any later version.\n+\n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+\n+   You should have received a copy of the GNU General Public License\n+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n+\n+void\n+foo (int x)\n+{\n+\n+}\n+\n+void\n+bar1 (void)\n+{\n+  asm (\"bar1_label: .globl bar1_label\");\n+  foo (1);\n+  asm (\"bar1_label_2: .globl bar1_label_2\");\n+  foo (2);\n+  asm (\"bar1_label_3: .globl bar1_label_3\");\n+  foo (3);\n+  asm (\"bar1_label_4: .globl bar1_label_4\");\n+  foo (4);\n+  asm (\"bar1_label_5: .globl bar1_label_5\");\n+}\n+\n+void\n+bar2 (void)\n+{\n+  asm (\"bar2_label: .globl bar2_label\");\n+  foo (1);\n+  asm (\"bar2_label_2: .globl bar2_label_2\");\n+  foo (2);\n+  asm (\"bar2_label_3: .globl bar2_label_3\");\n+  foo (3);\n+  asm (\"bar2_label_4: .globl bar2_label_4\");\n+  foo (4);\n+  asm (\"bar2_label_5: .globl bar2_label_5\");\n+}\n+\n+int\n+main (void)\n+{\n+  asm (\"main_label: .globl main_label\");\n+\n+  bar1 ();\n+\n+  bar2 ();\n+\n+  return 0;\n+}\n+"
    },
    {
      "sha": "a39256c171a30b79ef9167bfcb4313d5b7e3b99a",
      "filename": "gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.exp",
      "status": "added",
      "additions": 140,
      "deletions": 0,
      "changes": 140,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/876518dd0a0b6fd6f4ad0a0b247db0d6a267db27/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/dw2-line-number-zero.exp?ref=876518dd0a0b6fd6f4ad0a0b247db0d6a267db27",
      "patch": "@@ -0,0 +1,140 @@\n+# Copyright 2020 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+load_lib dwarf.exp\n+\n+# This test can only be run on targets which support DWARF-2 and use gas.\n+if {![dwarf2_support]} {\n+    verbose \"Skipping dw2-line-number-zero test.\"\n+    return 0\n+}\n+\n+# The .c files use __attribute__.\n+if [get_compiler_info] {\n+    return -1\n+}\n+if !$gcc_compiled {\n+    verbose \"Skipping dw2-line-number-zero test.\"\n+    return 0\n+}\n+\n+standard_testfile .c dw2-line-number-zero-dw.S\n+\n+set asm_file [standard_output_file $srcfile2]\n+Dwarf::assemble $asm_file {\n+    declare_labels Llines\n+    global srcdir subdir srcfile\n+\n+    cu {} {\n+\tcompile_unit {\n+\t    {language @DW_LANG_C}\n+\t    {name dw2-line-number-zero.c}\n+\t    {stmt_list $Llines DW_FORM_sec_offset}\n+\t} {\n+\t    subprogram {\n+\t\t{external 1 flag}\n+\t\t{MACRO_AT_func {main}}\n+\t    }\n+\t    subprogram {\n+\t\t{external 1 flag}\n+\t\t{MACRO_AT_func {bar1}}\n+\t    }\n+\t    subprogram {\n+\t\t{external 1 flag}\n+\t\t{MACRO_AT_func {bar2}}\n+\t    }\n+\t}\n+    }\n+\n+    lines {version 2} Llines {\n+\tinclude_dir \"${srcdir}/${subdir}\"\n+\tfile_name \"$srcfile\" 1\n+\n+\tprogram {\n+\t    {DW_LNE_set_address bar1_label}\n+\t    {line 27}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar1_label_2}\n+\t    {line 29}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar1_label_3}\n+\t    {line 0}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar1_label_4}\n+\t    {line 33}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar1_label_5}\n+\t    {DW_LNE_end_sequence}\n+\n+\n+\t    {DW_LNE_set_address bar2_label}\n+\t    {line 41}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar2_label_2}\n+\t    {line 43}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar2_label_3}\n+\t    {line 0}\n+\t    {DW_LNS_negate_stmt}\n+\t    {DW_LNS_copy}\n+\t    {DW_LNS_negate_stmt}\n+\n+\t    {DW_LNE_set_address bar2_label_4}\n+\t    {line 47}\n+\t    {DW_LNS_copy}\n+\n+\t    {DW_LNE_set_address bar2_label_5}\n+\t    {DW_LNE_end_sequence}\n+\t}\n+    }\n+}\n+\n+if { [prepare_for_testing \"failed to prepare\" ${testfile} \\\n+\t  [list $srcfile $asm_file] {nodebug}] } {\n+    return -1\n+}\n+\n+if ![runto_main] {\n+    return -1\n+}\n+\n+gdb_breakpoint \"bar1\"\n+gdb_continue_to_breakpoint \"bar1\" \"\\[^\\r\\n\\]*:27\\r\\n.*\"\n+\n+gdb_test \"n\" \"foo \\\\(2\\\\);\" \"bar1, 1st next\"\n+gdb_test \"n\" \"foo \\\\(4\\\\);\" \"bar1, 2nd next\"\n+\n+gdb_breakpoint \"bar2\"\n+gdb_continue_to_breakpoint \"bar2\" \"\\[^\\r\\n\\]*:41\\r\\n.*\"\n+\n+gdb_test \"n\" \"foo \\\\(2\\\\);\" \"bar2, 1st next\"\n+gdb_test \"n\" \"foo \\\\(4\\\\);\" \"bar2, 2nd next\"\n+\n+if ![runto_main] {\n+    return -1\n+}\n+\n+gdb_breakpoint \"bar1_label_3\"\n+setup_kfail \"gdb/nnnnn\" *-*-*\n+gdb_continue_to_breakpoint \"bar1_label_3\" \"bar1 \\\\(\\\\)\"\n+\n+gdb_breakpoint \"bar2_label_3\"\n+setup_kfail \"gdb/nnnnn\" *-*-*\n+gdb_continue_to_breakpoint \"bar2_label_3\" \"bar2 \\\\(\\\\)\""
    }
  ]
}