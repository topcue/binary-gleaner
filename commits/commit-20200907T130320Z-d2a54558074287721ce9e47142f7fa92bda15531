{
  "sha": "d2a54558074287721ce9e47142f7fa92bda15531",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZDJhNTQ1NTgwNzQyODc3MjFjZTllNDcxNDJmN2ZhOTJiZGExNTUzMQ==",
  "commit": {
    "author": {
      "name": "Mark Wielaard",
      "email": "mark@klomp.org",
      "date": "2020-09-07T13:03:20Z"
    },
    "committer": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2020-09-07T13:03:20Z"
    },
    "message": "gas: Output directory and file names in .debug_line_str for DWARF5\n\n\t* dwarf2dbg.c (add_line_strp): New function.\n\t(out_dir_and_file_list): Take line_seg and sizeof_offset as\n\targuments, Use DW_FORM_line_strp for dir and file. Call\n\tadd_line_strp and set symbol offset for DWARF2_LINE_VERSION 5.\n\t(out_debug_line): Call out_dir_and_file_list with line_seg and\n\tsizeof_offset.\n\t* gas/testsuite/gas/elf/dwarf-5-file0.d: Expect indirect line\n\tstrings.",
    "tree": {
      "sha": "c8bb313bdfd20f3105bc554434624ca7e3562433",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/c8bb313bdfd20f3105bc554434624ca7e3562433"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/d2a54558074287721ce9e47142f7fa92bda15531",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d2a54558074287721ce9e47142f7fa92bda15531",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/d2a54558074287721ce9e47142f7fa92bda15531",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d2a54558074287721ce9e47142f7fa92bda15531/comments",
  "author": null,
  "committer": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "bdd3b953e24c3d2bc55e06e30e0ef5e0ff829e3f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bdd3b953e24c3d2bc55e06e30e0ef5e0ff829e3f",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/bdd3b953e24c3d2bc55e06e30e0ef5e0ff829e3f"
    }
  ],
  "stats": {
    "total": 105,
    "additions": 82,
    "deletions": 23
  },
  "files": [
    {
      "sha": "117f7e00a0c3eade450a26dd088df169f2caeca9",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d2a54558074287721ce9e47142f7fa92bda15531/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d2a54558074287721ce9e47142f7fa92bda15531/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=d2a54558074287721ce9e47142f7fa92bda15531",
      "patch": "@@ -1,3 +1,14 @@\n+2020-09-07  Mark Wielaard  <mark@klomp.org>\n+\n+\t* dwarf2dbg.c (add_line_strp): New function.\n+\t(out_dir_and_file_list): Take line_seg and sizeof_offset as\n+\targuments, Use DW_FORM_line_strp for dir and file. Call\n+\tadd_line_strp and set symbol offset for DWARF2_LINE_VERSION 5.\n+\t(out_debug_line): Call out_dir_and_file_list with line_seg and\n+\tsizeof_offset.\n+\t* gas/testsuite/gas/elf/dwarf-5-file0.d: Expect indirect line\n+\tstrings.\n+\n 2020-09-07  Mark Wielaard  <mark@klomp.org>\n \n \t* dwarf2dbg.c (DWARF2_RNGLISTS_VERSION): New constant."
    },
    {
      "sha": "e0ea3991b45117478c41c80596e6fc5abf9487b2",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 65,
      "deletions": 17,
      "changes": 82,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d2a54558074287721ce9e47142f7fa92bda15531/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d2a54558074287721ce9e47142f7fa92bda15531/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=d2a54558074287721ce9e47142f7fa92bda15531",
      "patch": "@@ -1972,10 +1972,32 @@ process_entries (segT seg, struct line_entry *e)\n     }\n }\n \n+/* Switch to LINE_STR_SEG and output the given STR.  Return the\n+   symbol pointing to the new string in the section.  */\n+\n+static symbolS *\n+add_line_strp (segT line_str_seg, const char *str)\n+{\n+  char *cp;\n+  size_t size;\n+  symbolS *sym;\n+\n+  subseg_set (line_str_seg, 0);\n+\n+  sym = symbol_temp_new_now_octets ();\n+\n+  size = strlen (str) + 1;\n+  cp = frag_more (size);\n+  memcpy (cp, str, size);\n+\n+  return sym;\n+}\n+\n+\n /* Emit the directory and file tables for .debug_line.  */\n \n static void\n-out_dir_and_file_list (void)\n+out_dir_and_file_list (segT line_seg, int sizeof_offset)\n {\n   size_t size;\n   const char *dir;\n@@ -1984,6 +2006,8 @@ out_dir_and_file_list (void)\n   bfd_boolean emit_md5 = FALSE;\n   bfd_boolean emit_timestamps = TRUE;\n   bfd_boolean emit_filesize = TRUE;\n+  segT line_str_seg = NULL;\n+  symbolS *line_strp;\n \n   /* Output the Directory Table.  */\n   if (DWARF2_LINE_VERSION >= 5)\n@@ -1993,9 +2017,9 @@ out_dir_and_file_list (void)\n \n       /* Describe the purpose and format of the column.  */\n       out_uleb128 (DW_LNCT_path);\n-      /* FIXME: it would be better to store these strings in\n-\t the .debug_line_str section and reference them here.  */\n-      out_uleb128 (DW_FORM_string);\n+      /* Store these strings in the .debug_line_str section so they\n+\t can be shared.  */\n+      out_uleb128 (DW_FORM_line_strp);\n \n       /* Now state how many rows there are in the table.  We need at\n \t least 1 if there is one or more file names to store the\n@@ -2009,6 +2033,12 @@ out_dir_and_file_list (void)\n   /* Emit directory list.  */\n   if (DWARF2_LINE_VERSION >= 5 && (dirs_in_use > 0 || files_in_use > 0))\n     {\n+      line_str_seg = subseg_new (\".debug_line_str\", 0);\n+      bfd_set_section_flags (line_str_seg,\n+\t\t\t     SEC_READONLY | SEC_DEBUGGING | SEC_OCTETS\n+\t\t\t     | SEC_MERGE | SEC_STRINGS);\n+      line_str_seg->entsize = 1;\n+\n       /* DWARF5 uses slot zero, but that is only set explicitly\n \t using a .file 0 directive.  If that isn't used, but dir\n \t one is used, then use that as main file directory.\n@@ -2020,16 +2050,25 @@ out_dir_and_file_list (void)\n       else\n \tdir = remap_debug_filename (getpwd ());\n \n-      size = strlen (dir) + 1;\n-      cp = frag_more (size);\n-      memcpy (cp, dir, size);\n+      line_strp = add_line_strp (line_str_seg, dir);\n+      subseg_set (line_seg, 0);\n+      TC_DWARF2_EMIT_OFFSET (line_strp, sizeof_offset);\n     }\n   for (i = 1; i < dirs_in_use; ++i)\n     {\n       dir = remap_debug_filename (dirs[i]);\n-      size = strlen (dir) + 1;\n-      cp = frag_more (size);\n-      memcpy (cp, dir, size);\n+      if (DWARF2_LINE_VERSION < 5)\n+\t{\n+\t  size = strlen (dir) + 1;\n+\t  cp = frag_more (size);\n+\t  memcpy (cp, dir, size);\n+\t}\n+      else\n+\t{\n+\t  line_strp = add_line_strp (line_str_seg, dir);\n+\t  subseg_set (line_seg, 0);\n+\t  TC_DWARF2_EMIT_OFFSET (line_strp, sizeof_offset);\n+\t}\n     }\n \n   if (DWARF2_LINE_VERSION < 5)\n@@ -2066,9 +2105,9 @@ out_dir_and_file_list (void)\n       out_byte (columns);\n       /* The format of the file name.  */\n       out_uleb128 (DW_LNCT_path);\n-      /* FIXME: it would be better to store these strings in\n-\t the .debug_line_str section and reference them here.  */\n-      out_uleb128 (DW_FORM_string);\n+      /* Store these strings in the .debug_line_str section so they\n+\t can be shared.  */\n+      out_uleb128 (DW_FORM_line_strp);\n \n       /* The format of the directory index.  */\n       out_uleb128 (DW_LNCT_directory_index);\n@@ -2122,9 +2161,18 @@ out_dir_and_file_list (void)\n \n       fullfilename = DWARF2_FILE_NAME (files[i].filename,\n \t\t\t\t       files[i].dir ? dirs [files [i].dir] : \"\");\n-      size = strlen (fullfilename) + 1;\n-      cp = frag_more (size);\n-      memcpy (cp, fullfilename, size);\n+      if (DWARF2_LINE_VERSION < 5)\n+\t{\n+\t  size = strlen (fullfilename) + 1;\n+\t  cp = frag_more (size);\n+\t  memcpy (cp, fullfilename, size);\n+\t}\n+      else\n+\t{\n+\t  line_strp = add_line_strp (line_str_seg, fullfilename);\n+\t  subseg_set (line_seg, 0);\n+\t  TC_DWARF2_EMIT_OFFSET (line_strp, sizeof_offset);\n+\t}\n \n       /* Directory number.  */\n       out_uleb128 (files[i].dir);\n@@ -2282,7 +2330,7 @@ out_debug_line (segT line_seg)\n      matches up to the opcode base value we have been using.  */\n   gas_assert (DWARF2_LINE_OPCODE_BASE == 13);\n \n-  out_dir_and_file_list ();\n+  out_dir_and_file_list (line_seg, sizeof_offset);\n \n   symbol_set_value_now (prologue_end);\n "
    },
    {
      "sha": "5d76b7bcd14b062bf07a63e1cc31453f9a28b0dc",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0.d",
      "status": "modified",
      "additions": 6,
      "deletions": 6,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d2a54558074287721ce9e47142f7fa92bda15531/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d2a54558074287721ce9e47142f7fa92bda15531/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0.d?ref=d2a54558074287721ce9e47142f7fa92bda15531",
      "patch": "@@ -5,15 +5,15 @@\n #...\n  The Directory Table \\(offset 0x.*, lines 3, columns 1\\):\n   Entry\tName\n-  0\tmaster directory\n-  1\tsecondary directory\n-  2\t/tmp\n+  0\t\\(indirect line string, offset: 0x.*\\): master directory\n+  1\t\\(indirect line string, offset: 0x.*\\): secondary directory\n+  2\t\\(indirect line string, offset: 0x.*\\): /tmp\n \n  The File Name Table \\(offset 0x.*, lines 3, columns 3\\):\n   Entry\tDir\tMD5\t\t\t\tName\n-  0\t0 0x00000000000000000000000000000000\tmaster source file\n-  1\t1 0x00000000000000000000000000000000\tsecondary source file\n-  2\t2 0x95828e8bc4f7404dbf7526fb7bd0f192\tfoo.c\n+  0\t0 0x00000000000000000000000000000000\t\\(indirect line string, offset: 0x.*\\): master source file\n+  1\t1 0x00000000000000000000000000000000\t\\(indirect line string, offset: 0x.*\\): secondary source file\n+  2\t2 0x95828e8bc4f7404dbf7526fb7bd0f192\t\\(indirect line string, offset: 0x.*\\): foo.c\n #pass\n \n "
    }
  ]
}