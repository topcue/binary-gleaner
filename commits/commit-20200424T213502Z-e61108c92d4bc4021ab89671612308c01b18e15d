{
  "sha": "e61108c92d4bc4021ab89671612308c01b18e15d",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZTYxMTA4YzkyZDRiYzQwMjFhYjg5NjcxNjEyMzA4YzAxYjE4ZTE1ZA==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2020-04-24T21:35:01Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-04-24T21:35:02Z"
    },
    "message": "Add attribute::value_as_string method\n\nThe full DIE reader checks that an attribute has a \"string\" form in\nsome spots, but the partial DIE reader does not.  This patch brings\nthe two readers in sync for one specific case, namely when examining\nthe linkage name.  This avoids regressions in an existing DWARF test\ncase.\n\nA full fix for this problem would be preferable.  An accessor like\nDW_STRING should always check the form.  However, I haven't attempted\nthat in this series.\n\nAlso the fact that the partial and full readers can disagree like this\nis a design flaw.\n\ngdb/ChangeLog\n2020-04-24  Tom Tromey  <tom@tromey.com>\n\n\t* dwarf2/read.c (partial_die_info::read) <case\n\tDW_AT_linkage_name>: Use value_as_string.\n\t(dwarf2_string_attr): Use value_as_string.\n\t* dwarf2/attribute.h (struct attribute) <value_as_string>: Declare\n\tmethod.\n\t* dwarf2/attribute.c (attribute::value_as_string): New method.",
    "tree": {
      "sha": "02aaf1bc391c6ae0754631220fa0e68e55720ca3",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/02aaf1bc391c6ae0754631220fa0e68e55720ca3"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/e61108c92d4bc4021ab89671612308c01b18e15d",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e61108c92d4bc4021ab89671612308c01b18e15d",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/e61108c92d4bc4021ab89671612308c01b18e15d",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e61108c92d4bc4021ab89671612308c01b18e15d/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "8c87a4527f5102b124ad0128894b1195d80eef73",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8c87a4527f5102b124ad0128894b1195d80eef73",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/8c87a4527f5102b124ad0128894b1195d80eef73"
    }
  ],
  "stats": {
    "total": 46,
    "additions": 34,
    "deletions": 12
  },
  "files": [
    {
      "sha": "df43ffd296e180db8427849761a580e2d3c31f7a",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=e61108c92d4bc4021ab89671612308c01b18e15d",
      "patch": "@@ -1,3 +1,12 @@\n+2020-04-24  Tom Tromey  <tom@tromey.com>\n+\n+\t* dwarf2/read.c (partial_die_info::read) <case\n+\tDW_AT_linkage_name>: Use value_as_string.\n+\t(dwarf2_string_attr): Use value_as_string.\n+\t* dwarf2/attribute.h (struct attribute) <value_as_string>: Declare\n+\tmethod.\n+\t* dwarf2/attribute.c (attribute::value_as_string): New method.\n+\n 2020-04-24  Tom Tromey  <tom@tromey.com>\n \n \t* symtab.c (general_symbol_info::natural_name)"
    },
    {
      "sha": "9f808aa79043b1c5b93b9448598d7b1cb2229d62",
      "filename": "gdb/dwarf2/attribute.c",
      "status": "modified",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/attribute.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/attribute.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/attribute.c?ref=e61108c92d4bc4021ab89671612308c01b18e15d",
      "patch": "@@ -61,6 +61,24 @@ attribute::value_as_address () const\n \n /* See attribute.h.  */\n \n+const char *\n+attribute::value_as_string () const\n+{\n+  if (form == DW_FORM_strp || form == DW_FORM_line_strp\n+      || form == DW_FORM_string\n+      || form == DW_FORM_strx\n+      || form == DW_FORM_strx1\n+      || form == DW_FORM_strx2\n+      || form == DW_FORM_strx3\n+      || form == DW_FORM_strx4\n+      || form == DW_FORM_GNU_str_index\n+      || form == DW_FORM_GNU_strp_alt)\n+    return DW_STRING (this);\n+  return nullptr;\n+}\n+\n+/* See attribute.h.  */\n+\n bool\n attribute::form_is_block () const\n {"
    },
    {
      "sha": "a9cabd69f9fa2360221a9580a0c36dc742c8c420",
      "filename": "gdb/dwarf2/attribute.h",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/attribute.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/attribute.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/attribute.h?ref=e61108c92d4bc4021ab89671612308c01b18e15d",
      "patch": "@@ -46,6 +46,10 @@ struct attribute\n      attribute's form into account.  */\n   CORE_ADDR value_as_address () const;\n \n+  /* If the attribute has a string form, return the string value;\n+     otherwise return NULL.  */\n+  const char *value_as_string () const;\n+\n   /* Return non-zero if ATTR's value is a section offset --- classes\n      lineptr, loclistptr, macptr or rangelistptr --- or zero, otherwise.\n      You may use DW_UNSND (attr) to retrieve such offsets."
    },
    {
      "sha": "5663d7dfb966e257306191f443a1f780c5af76df",
      "filename": "gdb/dwarf2/read.c",
      "status": "modified",
      "additions": 3,
      "deletions": 12,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e61108c92d4bc4021ab89671612308c01b18e15d/gdb/dwarf2/read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/read.c?ref=e61108c92d4bc4021ab89671612308c01b18e15d",
      "patch": "@@ -18300,7 +18300,7 @@ partial_die_info::read (const struct die_reader_specs *reader,\n \t  /* Note that both forms of linkage name might appear.  We\n \t     assume they will be the same, and we only store the last\n \t     one we see.  */\n-\t  linkage_name = DW_STRING (&attr);\n+\t  linkage_name = attr.value_as_string ();\n \t  /* rustc emits invalid values for DW_AT_linkage_name.  Ignore these.\n \t     See https://github.com/rust-lang/rust/issues/32925.  */\n \t  if (cu->language == language_rust && linkage_name != NULL\n@@ -19485,17 +19485,8 @@ dwarf2_string_attr (struct die_info *die, unsigned int name, struct dwarf2_cu *c\n \n   if (attr != NULL)\n     {\n-      if (attr->form == DW_FORM_strp || attr->form == DW_FORM_line_strp\n-\t  || attr->form == DW_FORM_string\n-\t  || attr->form == DW_FORM_strx\n-\t  || attr->form == DW_FORM_strx1\n-\t  || attr->form == DW_FORM_strx2\n-\t  || attr->form == DW_FORM_strx3\n-\t  || attr->form == DW_FORM_strx4\n-\t  || attr->form == DW_FORM_GNU_str_index\n-\t  || attr->form == DW_FORM_GNU_strp_alt)\n-\tstr = DW_STRING (attr);\n-      else\n+      str = attr->value_as_string ();\n+      if (str == nullptr)\n         complaint (_(\"string type expected for attribute %s for \"\n \t\t     \"DIE at %s in module %s\"),\n \t\t   dwarf_attr_name (name), sect_offset_str (die->sect_off),"
    }
  ]
}