{
  "sha": "74044dc84074abca775c63462ecccc10a7900987",
  "node_id": "C_kwDOANOeidoAKDc0MDQ0ZGM4NDA3NGFiY2E3NzVjNjM0NjJlY2NjYzEwYTc5MDA5ODc",
  "commit": {
    "author": {
      "name": "Cl\u00e9ment Chigot",
      "email": "clement.chigot@atos.net",
      "date": "2021-11-18T15:12:14Z"
    },
    "committer": {
      "name": "Cl\u00e9ment Chigot",
      "email": "clement.chigot@atos.net",
      "date": "2021-12-06T11:45:12Z"
    },
    "message": "ld: improve shared tests for AIX\n\nIt's now possible to refer symbols in the main program from the\nshared library. However, it still impossible to have the same\noverriden features between shared objects and mains than ELF,\nwithout using the runtime linking feature which isn't yet fully\navailable.\n\nld/ChangeLog:\n\n\t* testsuite/ld-shared/shared.exp: Improve XCOFF support\n\t* testsuite/ld-shared/main.c: Likewise.\n\t* testsuite/ld-shared/sh1.c: Likewise.\n\t* testsuite/ld-shared/xcoff.dat: Likewise.",
    "tree": {
      "sha": "4186489405f647bba6d48a56ce85d74faf89b4ba",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/4186489405f647bba6d48a56ce85d74faf89b4ba"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/74044dc84074abca775c63462ecccc10a7900987",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/74044dc84074abca775c63462ecccc10a7900987",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/74044dc84074abca775c63462ecccc10a7900987",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/74044dc84074abca775c63462ecccc10a7900987/comments",
  "author": {
    "login": "Helflym",
    "id": 23002587,
    "node_id": "MDQ6VXNlcjIzMDAyNTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/23002587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Helflym",
    "html_url": "https://github.com/Helflym",
    "followers_url": "https://api.github.com/users/Helflym/followers",
    "following_url": "https://api.github.com/users/Helflym/following{/other_user}",
    "gists_url": "https://api.github.com/users/Helflym/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Helflym/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Helflym/subscriptions",
    "organizations_url": "https://api.github.com/users/Helflym/orgs",
    "repos_url": "https://api.github.com/users/Helflym/repos",
    "events_url": "https://api.github.com/users/Helflym/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Helflym/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "Helflym",
    "id": 23002587,
    "node_id": "MDQ6VXNlcjIzMDAyNTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/23002587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Helflym",
    "html_url": "https://github.com/Helflym",
    "followers_url": "https://api.github.com/users/Helflym/followers",
    "following_url": "https://api.github.com/users/Helflym/following{/other_user}",
    "gists_url": "https://api.github.com/users/Helflym/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Helflym/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Helflym/subscriptions",
    "organizations_url": "https://api.github.com/users/Helflym/orgs",
    "repos_url": "https://api.github.com/users/Helflym/repos",
    "events_url": "https://api.github.com/users/Helflym/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Helflym/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2427f3b09eb23e7949878cdc0b366fb605df568f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2427f3b09eb23e7949878cdc0b366fb605df568f",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/2427f3b09eb23e7949878cdc0b366fb605df568f"
    }
  ],
  "stats": {
    "total": 95,
    "additions": 37,
    "deletions": 58
  },
  "files": [
    {
      "sha": "b5200f2a09402268ebe5e6a03c3383c4c07521b0",
      "filename": "ld/testsuite/ld-shared/main.c",
      "status": "modified",
      "additions": 5,
      "deletions": 5,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/main.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/main.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-shared/main.c?ref=74044dc84074abca775c63462ecccc10a7900987",
      "patch": "@@ -41,25 +41,27 @@ main ()\n   printf (\"mainvar == %d\\n\", mainvar);\n   printf (\"overriddenvar == %d\\n\", overriddenvar);\n   printf (\"shlibvar1 == %d\\n\", shlibvar1);\n-#ifndef XCOFF_TEST\n+#ifndef SYMBOLIC_TEST\n   printf (\"shlib_mainvar () == %d\\n\", shlib_mainvar ());\n+#ifndef XCOFF_TEST\n   printf (\"shlib_overriddenvar () == %d\\n\", shlib_overriddenvar ());\n+#endif\n #endif\n   printf (\"shlib_shlibvar1 () == %d\\n\", shlib_shlibvar1 ());\n   printf (\"shlib_shlibvar2 () == %d\\n\", shlib_shlibvar2 ());\n   printf (\"shlib_shlibcall () == %d\\n\", shlib_shlibcall ());\n+#ifndef SYMBOLIC_TEST\n #ifndef XCOFF_TEST\n   printf (\"shlib_shlibcall2 () == %d\\n\", shlib_shlibcall2 ());\n+#endif\n   printf (\"shlib_maincall () == %d\\n\", shlib_maincall ());\n #endif\n   printf (\"main_called () == %d\\n\", main_called ());\n #ifndef SYMBOLIC_TEST\n   printf (\"shlib_checkfunptr1 (shlib_shlibvar1) == %d\\n\",\n \t  shlib_checkfunptr1 (shlib_shlibvar1));\n-#ifndef XCOFF_TEST\n   printf (\"shlib_checkfunptr2 (main_called) == %d\\n\",\n \t  shlib_checkfunptr2 (main_called));\n-#endif\n   {\n     int (*p) ();\n \n@@ -71,7 +73,6 @@ main ()\n       printf (\"!=\");\n     printf (\" shlib_shlibvar1\\n\");\n   }\n-#ifndef XCOFF_TEST\n   {\n     int (*p) ();\n \n@@ -83,7 +84,6 @@ main ()\n       printf (\"!=\");\n     printf (\" main_called\\n\");\n   }\n-#endif\n #endif\n   printf (\"shlib_check () == %d\\n\", shlib_check ());\n   return 0;"
    },
    {
      "sha": "9acb29e22dcc98cde5e6d03649674e4c7d4962a4",
      "filename": "ld/testsuite/ld-shared/sh1.c",
      "status": "modified",
      "additions": 0,
      "deletions": 10,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/sh1.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/sh1.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-shared/sh1.c?ref=74044dc84074abca775c63462ecccc10a7900987",
      "patch": "@@ -2,9 +2,7 @@\n    of a shared library.  */\n \n /* This variable is supplied by the main program.  */\n-#ifndef XCOFF_TEST\n extern int mainvar;\n-#endif\n \n /* This variable is defined in the shared library, and overridden by\n    the main program.  */\n@@ -21,13 +19,11 @@ extern int shlibvar2;\n /* These functions return the values of the above variables as seen in\n    the shared library.  */\n \n-#ifndef XCOFF_TEST\n int\n shlib_mainvar ()\n {\n   return mainvar;\n }\n-#endif\n \n #ifndef XCOFF_TEST\n int\n@@ -75,15 +71,13 @@ shlib_shlibcall2 ()\n \n /* This function calls a function defined by the main program.  */\n \n-#ifndef XCOFF_TEST\n extern int main_called ();\n \n int\n shlib_maincall ()\n {\n   return main_called ();\n }\n-#endif\n \n /* This function is passed a function pointer to shlib_mainvar.  It\n    confirms that the pointer compares equally.  */\n@@ -98,14 +92,12 @@ shlib_checkfunptr1 (p)\n /* This function is passed a function pointer to main_called.  It\n    confirms that the pointer compares equally.  */\n \n-#ifndef XCOFF_TEST\n int\n shlib_checkfunptr2 (p)\n      int (*p) ();\n {\n   return p == main_called;\n }\n-#endif\n \n /* This function returns a pointer to shlib_mainvar.  */\n \n@@ -117,13 +109,11 @@ int\n \n /* This function returns a pointer to main_called.  */\n \n-#ifndef XCOFF_TEST\n int\n (*shlib_getfunptr2 ()) ()\n {\n   return main_called;\n }\n-#endif\n \n /* This function makes sure that constant data and local functions\n    work.  */"
    },
    {
      "sha": "12879fafed49384a300ee1c204c3c096ba706cb4",
      "filename": "ld/testsuite/ld-shared/shared.exp",
      "status": "modified",
      "additions": 28,
      "deletions": 43,
      "changes": 71,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/shared.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/shared.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-shared/shared.exp?ref=74044dc84074abca775c63462ecccc10a7900987",
      "patch": "@@ -53,8 +53,7 @@ if { ![istarget hppa*64*-*-hpux*] \\\n      && ![istarget sparc*-*-linux*] \\\n      && ![istarget arm*-*-linux*] \\\n      && ![istarget alpha*-*-linux*] \\\n-     && ![istarget rs6000*-*-aix*] \\\n-     && ![istarget powerpc*-*-aix*] \\\n+     && ![is_xcoff_format] \\\n      && ![istarget s390*-*-linux*] \\\n      && ![istarget aarch64*-*-linux*] \\\n      && ![istarget x86_64-*-linux*] } {\n@@ -69,33 +68,22 @@ set shared_needs_pic \"no\"\n set old_CFLAGS \"$CFLAGS_FOR_TARGET\"\n append CFLAGS_FOR_TARGET \" $NOSANITIZE_CFLAGS\"\n \n-if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n-\n-    # AIX shared libraries do not seem to support useful features,\n-    # like overriding the shared library function or letting the\n-    # shared library refer to objects defined in the main program.  We\n-    # avoid testing those features.\n+if { [is_xcoff_format] } {\n+    # Not all the useful features are available with AIX shared\n+    # libraries by default.\n+    # We can manage to simulate some of them with export/import\n+    # files but the overriding of shared library functions or\n+    # variables by the main program doesn't seem possible.\n+    # We avoid testing those features.\n     set SHCFLAG \"-DXCOFF_TEST\"\n \n-    # The AIX 3.2.5 loader appears to randomly fail when loading\n-    # shared libraries from NSF mounted partitions, so we avoid any\n-    # potential problems by using a local directory.\n-    catch {exec /bin/sh -c \"echo $$\"} pid\n-    set tmpdir /usr/tmp/ld.$pid\n-    catch \"exec mkdir $tmpdir\" exec_status\n-\n-    # On AIX, we need to explicitly export the symbols the shared\n-    # library is going to provide, and need.\n-    set file [open $tmpdir/xcoff.exp w]\n-    puts $file shlibvar1\n-    puts $file shlibvar2\n-    puts $file shlib_shlibvar1\n-    puts $file shlib_shlibvar2\n-    puts $file shlib_shlibcall\n-    puts $file shlib_shlibcalled\n-    puts $file shlib_checkfunptr1\n-    puts $file shlib_getfunptr1\n-    puts $file shlib_check\n+    # In order to avoid listing every symbols in an export file,\n+    # the export will be done with -bexpall flag.\n+    # However for imports, we must create the import file.\n+    set file [open $tmpdir/xcoff-shared.imp w]\n+    puts $file \"#! .\"\n+    puts $file mainvar\n+    puts $file main_called\n     close $file\n }\n \n@@ -132,10 +120,10 @@ proc shared_test { progname testname main sh1 sh2 dat args } {\n     if [llength $args] { set shldflags [lindex $args 0] } else { set shldflags \"\" }\n \n     # Build the shared library.\n-    # On AIX, we need to use an export file.\n     set shared -shared\n-    if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n-\tappend shared \" -Wl,-bE:$tmpdir/xcoff.exp\"\n+    if { [is_xcoff_format] } {\n+\t# On AIX, setup imports and exports.\n+\tappend shared \" -Wl,-bexpall -Wl,-bI:$tmpdir/xcoff-shared.imp\"\n     }\n     if { [is_elf_format] && [check_shared_lib_support] } {\n \tappend shared \" -Wl,-z,notext\"\n@@ -150,10 +138,12 @@ proc shared_test { progname testname main sh1 sh2 dat args } {\n     # On AIX, we must include /lib in -rpath, as otherwise the loader\n     # can not find -lc.\n     set rpath $tmpdir\n-    if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n+    set exportflag \"\"\n+    if { [is_xcoff_format] } {\n \tset rpath /lib:$tmpdir\n+\tset exportflag \" -Wl,-bexpall\"\n     }\n-    if ![ld_link $CC_FOR_TARGET $tmpdir/$progname \"-Wl,-rpath,$rpath $tmpdir/$main $tmpdir/$progname.so\"] {\n+    if ![ld_link $CC_FOR_TARGET $tmpdir/$progname \"-Wl,-rpath,$rpath $tmpdir/$main $tmpdir/$progname.so $exportflag\"] {\n     \tfail \"$testname\"\n     \treturn\n     }\n@@ -226,7 +216,7 @@ if ![ld_compile \"$CC_FOR_TARGET $SHCFLAG\" $srcdir/$subdir/main.c $tmpdir/mainnp.\n     if { ![ld_compile \"$CC_FOR_TARGET $PLT_CFLAGS $NOPIE_CFLAGS $SHCFLAG\" $srcdir/$subdir/sh1.c $tmpdir/sh1np.o]\n \t || ![ld_compile \"$CC_FOR_TARGET $PLT_CFLAGS $SHCFLAG\" $srcdir/$subdir/sh2.c $tmpdir/sh2np.o] } {\n \tunsupported \"shared (non PIC)\"\n-    } else { if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n+    } else { if { [is_xcoff_format] } {\n \tshared_test shnp \"shared (nonPIC)\" mainnp.o sh1np.o sh2np.o xcoff\n     } else {\n \t# Solaris defaults to -z text.\n@@ -288,12 +278,12 @@ if ![ld_compile \"$CC_FOR_TARGET $SHCFLAG\" $srcdir/$subdir/main.c $tmpdir/mainnp.\n \t || ![ld_compile \"$CC_FOR_TARGET $SHCFLAG $picflag\" $srcdir/$subdir/sh2.c $tmpdir/sh2p.o] } {\n \tunsupported \"shared\"\n     } else {\n-\tif { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n+\tif { [is_xcoff_format] } {\n \t    shared_test shp \"shared\" mainnp.o sh1p.o sh2p.o xcoff\n \t} else {\n \t    shared_test shp \"shared\" mainnp.o sh1p.o sh2p.o shared\n-\t    ld_compile \"$CC_FOR_TARGET -DSYMBOLIC_TEST -DXCOFF_TEST $SHCFLAG\" $srcdir/$subdir/main.c $tmpdir/mainnp.o\n-\t    ld_compile \"$CC_FOR_TARGET -DSYMBOLIC_TEST -DXCOFF_TEST $SHCFLAG $picflag\" $srcdir/$subdir/sh1.c $tmpdir/sh1p.o\n+\t    ld_compile \"$CC_FOR_TARGET -DSYMBOLIC_TEST $SHCFLAG\" $srcdir/$subdir/main.c $tmpdir/mainnp.o\n+\t    ld_compile \"$CC_FOR_TARGET -DSYMBOLIC_TEST $SHCFLAG $picflag\" $srcdir/$subdir/sh1.c $tmpdir/sh1p.o\n \t    shared_test shp \"shared -Bsymbolic\" mainnp.o sh1p.o sh2p.o symbolic \"-Bsymbolic\"\n \t    ld_compile \"$CC_FOR_TARGET $SHCFLAG\" $srcdir/$subdir/main.c $tmpdir/mainnp.o\n \t    ld_compile \"$CC_FOR_TARGET $SHCFLAG $picflag\" $srcdir/$subdir/sh1.c $tmpdir/sh1p.o\n@@ -307,7 +297,7 @@ if ![ld_compile \"$CC_FOR_TARGET $SHCFLAG $picflag\" $srcdir/$subdir/main.c $tmpdi\n     unsupported \"shared (PIC main)\"\n } else {\n     if { [file exists $tmpdir/sh1np.o ] && [ file exists $tmpdir/sh2np.o ] } {\n-        if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n+        if { [is_xcoff_format] } {\n \t    shared_test shmpnp \"shared (PIC main, non PIC so)\" mainp.o sh1np.o sh2np.o xcoff\n \t} else {\n \t    # Solaris defaults to -z text.\n@@ -337,7 +327,7 @@ if ![ld_compile \"$CC_FOR_TARGET $SHCFLAG $picflag\" $srcdir/$subdir/main.c $tmpdi\n     }\n \n     if { [file exists $tmpdir/sh1p.o ] && [ file exists $tmpdir/sh2p.o ] } {\n-        if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n+        if { [is_xcoff_format] } {\n \t    shared_test shmpp \"shared (PIC main)\" mainp.o sh1p.o sh2p.o xcoff\n \t} else {\n \t    shared_test shmpp \"shared (PIC main)\" mainp.o sh1p.o sh2p.o shared\n@@ -348,8 +338,3 @@ if ![ld_compile \"$CC_FOR_TARGET $SHCFLAG $picflag\" $srcdir/$subdir/main.c $tmpdi\n }\n \n set CFLAGS_FOR_TARGET \"$old_CFLAGS\"\n-\n-if { [istarget rs6000*-*-aix*] || [istarget powerpc*-*-aix*] } {\n-    # Remove the temporary directory.\n-    catch \"exec rm -rf $tmpdir\" exec_status\n-}"
    },
    {
      "sha": "249e5daf47ae8ce8750ad8482704eb25c020858f",
      "filename": "ld/testsuite/ld-shared/xcoff.dat",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/xcoff.dat",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74044dc84074abca775c63462ecccc10a7900987/ld/testsuite/ld-shared/xcoff.dat",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-shared/xcoff.dat?ref=74044dc84074abca775c63462ecccc10a7900987",
      "patch": "@@ -1,10 +1,14 @@\n mainvar == 1\n overriddenvar == 2\n shlibvar1 == 3\n+shlib_mainvar () == 1\n shlib_shlibvar1 () == 3\n shlib_shlibvar2 () == 4\n shlib_shlibcall () == 5\n+shlib_maincall () == 6\n main_called () == 6\n shlib_checkfunptr1 (shlib_shlibvar1) == 1\n+shlib_checkfunptr2 (main_called) == 1\n shlib_getfunptr1 () == shlib_shlibvar1\n+shlib_getfunptr2 () == main_called\n shlib_check () == 1"
    }
  ]
}