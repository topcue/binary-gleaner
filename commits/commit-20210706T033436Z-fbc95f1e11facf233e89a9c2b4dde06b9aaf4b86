{
  "sha": "fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZmJjOTVmMWUxMWZhY2YyMzNlODlhOWMyYjRkZGUwNmI5YWFmNGI4Ng==",
  "commit": {
    "author": {
      "name": "Kito Cheng",
      "email": "kito.cheng@sifive.com",
      "date": "2021-06-29T06:36:35Z"
    },
    "committer": {
      "name": "Nelson Chu",
      "email": "nelson.chu@sifive.com",
      "date": "2021-07-06T03:34:36Z"
    },
    "message": "RISC-V: Add PT_RISCV_ATTRIBUTES and add it to PHDR.\n\nWe added PT_RISCV_ATTRIBUTES to program header to make\n.riscv.attribute easier to find in dynamic loader or kernel.\n\nRef:\nhttps://github.com/riscv/riscv-elf-psabi-doc/pull/71\n\nChangeLog:\n\nbfd/\n\n\t* elfnn-riscv.c(RISCV_ATTRIBUTES_SECTION_NAME): New.\n\t(riscv_elf_additional_program_headers): Ditto.\n\t(riscv_elf_modify_segment_map): Ditto.\n\t(elf_backend_additional_program_headers): Ditto.\n\t(elf_backend_modify_segment_map): Ditto.\n\t(elf_backend_obj_attrs_section): Use RISCV_ATTRIBUTES_SECTION_NAME\n\trather than string literal.\n\nbinutils/\n\n\t* readelf.c(get_riscv_segment_type): New.\n\t(get_segment_type): Handle EM_RISCV.\n\ninclude/\n\n\t* elf/riscv.h (PT_RISCV_ATTRIBUTES): New.\n\t* testsuite/ld-elf/orphan-region.ld: Discard .riscv.attributes\n\tsection for simplify testcase.\n\t* testsuite/ld-riscv-elf/attr-phdr.d: New.\n\t* testsuite/ld-riscv-elf/attr-phdr.s: Ditto.\n\t* testsuite/ld-riscv-elf/ld-riscv-elf.exp: Add attr-phdr to\n\ttestcase.",
    "tree": {
      "sha": "810aa9b4b50933cd6e9e7f844d15886db695fd2a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/810aa9b4b50933cd6e9e7f844d15886db695fd2a"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/comments",
  "author": {
    "login": "kito-cheng",
    "id": 2723185,
    "node_id": "MDQ6VXNlcjI3MjMxODU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/2723185?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/kito-cheng",
    "html_url": "https://github.com/kito-cheng",
    "followers_url": "https://api.github.com/users/kito-cheng/followers",
    "following_url": "https://api.github.com/users/kito-cheng/following{/other_user}",
    "gists_url": "https://api.github.com/users/kito-cheng/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/kito-cheng/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/kito-cheng/subscriptions",
    "organizations_url": "https://api.github.com/users/kito-cheng/orgs",
    "repos_url": "https://api.github.com/users/kito-cheng/repos",
    "events_url": "https://api.github.com/users/kito-cheng/events{/privacy}",
    "received_events_url": "https://api.github.com/users/kito-cheng/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": null,
  "parents": [
    {
      "sha": "07b2745f850232e1c2fdafb0f65ea88e6127218b",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/07b2745f850232e1c2fdafb0f65ea88e6127218b",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/07b2745f850232e1c2fdafb0f65ea88e6127218b"
    }
  ],
  "stats": {
    "total": 114,
    "additions": 112,
    "deletions": 2
  },
  "files": [
    {
      "sha": "4db3ca4e4b9992a80321582e9065edc9087e9ab5",
      "filename": "bfd/elfnn-riscv.c",
      "status": "modified",
      "additions": 64,
      "deletions": 1,
      "changes": 65,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/bfd/elfnn-riscv.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/bfd/elfnn-riscv.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfnn-riscv.c?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -62,6 +62,8 @@\n #define ELF_MAXPAGESIZE\t\t\t0x1000\n #define ELF_COMMONPAGESIZE\t\t0x1000\n \n+#define RISCV_ATTRIBUTES_SECTION_NAME \".riscv.attributes\"\n+\n /* RISC-V ELF linker hash entry.  */\n \n struct riscv_elf_link_hash_entry\n@@ -5158,6 +5160,64 @@ riscv_elf_is_target_special_symbol (bfd *abfd, asymbol *sym)\n \t  || _bfd_elf_is_local_label_name (abfd, sym->name));\n }\n \n+static int\n+riscv_elf_additional_program_headers (bfd *abfd,\n+\t\t\t\t      struct bfd_link_info *info ATTRIBUTE_UNUSED)\n+{\n+  asection *s;\n+  int ret = 0;\n+\n+  /* See if we need a PT_RISCV_ATTRIBUTES segment.  */\n+  if (bfd_get_section_by_name (abfd, RISCV_ATTRIBUTES_SECTION_NAME))\n+    ++ret;\n+\n+  return ret;\n+}\n+\n+static bool\n+riscv_elf_modify_segment_map (bfd *abfd,\n+\t\t\t      struct bfd_link_info *info)\n+{\n+  asection *s;\n+  struct elf_segment_map *m, **pm;\n+  size_t amt;\n+\n+  /* If there is a .riscv.attributes section, we need a PT_RISCV_ATTRIBUTES\n+     segment.  */\n+  s = bfd_get_section_by_name (abfd, RISCV_ATTRIBUTES_SECTION_NAME);\n+  if (s != NULL)\n+    {\n+      for (m = elf_seg_map (abfd); m != NULL; m = m->next)\n+\tif (m->p_type == PT_RISCV_ATTRIBUTES)\n+\t  break;\n+      /* If there is already a PT_RISCV_ATTRIBUTES header, avoid adding\n+\t another.  */\n+      if (m == NULL)\n+\t{\n+\t  amt = sizeof (*m);\n+\t  m = bfd_zalloc (abfd, amt);\n+\t  if (m == NULL)\n+\t    return false;\n+\n+\t  m->p_type = PT_RISCV_ATTRIBUTES;\n+\t  m->count = 1;\n+\t  m->sections[0] = s;\n+\n+\t  /* We want to put it after the PHDR and INTERP segments.  */\n+\t  pm = &elf_seg_map (abfd);\n+\t  while (*pm != NULL\n+\t\t && ((*pm)->p_type == PT_PHDR\n+\t\t     || (*pm)->p_type == PT_INTERP))\n+\t    pm = &(*pm)->next;\n+\n+\t  m->next = *pm;\n+\t  *pm = m;\n+\t}\n+    }\n+\n+  return true;\n+}\n+\n #define TARGET_LITTLE_SYM\t\t\triscv_elfNN_vec\n #define TARGET_LITTLE_NAME\t\t\t\"elfNN-littleriscv\"\n #define TARGET_BIG_SYM\t\t\t\triscv_elfNN_be_vec\n@@ -5190,6 +5250,9 @@ riscv_elf_is_target_special_symbol (bfd *abfd, asymbol *sym)\n #define elf_info_to_howto\t\t\triscv_info_to_howto_rela\n #define bfd_elfNN_bfd_relax_section\t\t_bfd_riscv_relax_section\n #define bfd_elfNN_mkobject\t\t\telfNN_riscv_mkobject\n+#define elf_backend_additional_program_headers \\\n+  riscv_elf_additional_program_headers\n+#define elf_backend_modify_segment_map\t\triscv_elf_modify_segment_map\n \n #define elf_backend_init_index_section\t\t_bfd_elf_init_1_index_section\n \n@@ -5211,6 +5274,6 @@ riscv_elf_is_target_special_symbol (bfd *abfd, asymbol *sym)\n #undef  elf_backend_obj_attrs_section_type\n #define elf_backend_obj_attrs_section_type\tSHT_RISCV_ATTRIBUTES\n #undef  elf_backend_obj_attrs_section\n-#define elf_backend_obj_attrs_section\t\t\".riscv.attributes\"\n+#define elf_backend_obj_attrs_section\t\tRISCV_ATTRIBUTES_SECTION_NAME\n \n #include \"elfNN-target.h\""
    },
    {
      "sha": "22153394800570fb009b12fccb716fdc37d7b26e",
      "filename": "binutils/readelf.c",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/binutils/readelf.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/binutils/readelf.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/readelf.c?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -4094,6 +4094,16 @@ get_tic6x_segment_type (unsigned long type)\n     }\n }\n \n+static const char *\n+get_riscv_segment_type (unsigned long type)\n+{\n+  switch (type)\n+    {\n+    case PT_RISCV_ATTRIBUTES: return \"RISCV_ATTRIBUTES\";\n+    default:                  return NULL;\n+    }\n+}\n+\n static const char *\n get_hpux_segment_type (unsigned long type, unsigned e_machine)\n {\n@@ -4203,6 +4213,9 @@ get_segment_type (Filedata * filedata, unsigned long p_type)\n \t    case EM_S390_OLD:\n \t      result = get_s390_segment_type (p_type);\n \t      break;\n+\t    case EM_RISCV:\n+\t      result = get_riscv_segment_type (p_type);\n+\t      break;\n \t    default:\n \t      result = NULL;\n \t      break;"
    },
    {
      "sha": "80822835cd9ce888c9aa06b18e8643c901d6b1a3",
      "filename": "include/elf/riscv.h",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/include/elf/riscv.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/include/elf/riscv.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/include/elf/riscv.h?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -120,6 +120,11 @@ END_RELOC_NUMBERS (R_RISCV_max)\n /* Additional section types.  */\n #define SHT_RISCV_ATTRIBUTES 0x70000003 /* Section holds attributes.  */\n \n+/* Processor specific program header types.  */\n+\n+/* Location of RISC-V ELF attribute section. */\n+#define PT_RISCV_ATTRIBUTES 0x70000003\n+\n /* Object attributes.  */\n enum\n {"
    },
    {
      "sha": "71834df647a5cf25c76c3c7814d74f4a2d0262bd",
      "filename": "ld/testsuite/ld-elf/orphan-region.ld",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-elf/orphan-region.ld",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-elf/orphan-region.ld",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/orphan-region.ld?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -7,5 +7,5 @@ SECTIONS\n {\n \t.text : ALIGN (4) { *(.text) } > region\n \t.rodata : ALIGN (4) { *(.rodata) } > region\n-\t/DISCARD/ : { *(.reginfo) *(.MIPS.abiflags) *(.trampolines) }\n+\t/DISCARD/ : { *(.reginfo) *(.MIPS.abiflags) *(.trampolines) *(.riscv.attributes) }\n }"
    },
    {
      "sha": "43f2ea5077c08233f5d86dd28285b8c38b71c8ad",
      "filename": "ld/testsuite/ld-riscv-elf/attr-phdr.d",
      "status": "added",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/attr-phdr.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/attr-phdr.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/attr-phdr.d?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -0,0 +1,19 @@\n+#name: PT_RISCV_ATTRIBUTES check\n+#source: attr-phdr.s\n+#as: -march=rv32ic\n+#ld: -m[riscv_choose_ilp32_emul]\n+#readelf: -l\n+\n+Elf file type is EXEC \\(Executable file\\)\n+Entry point .*\n+There are .* program headers, starting at offset .*\n+\n+Program Headers:\n+  Type           Offset   VirtAddr   PhysAddr   FileSiz MemSiz  Flg Align\n+  RISCV_ATTRIBUT .*\n+  LOAD           .*\n+\n+ Section to Segment mapping:\n+  Segment Sections...\n+   00     .riscv.attributes \n+   01     .text "
    },
    {
      "sha": "f075248ccfdf2b5dca5954c81c0b491c9d908285",
      "filename": "ld/testsuite/ld-riscv-elf/attr-phdr.s",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/attr-phdr.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/attr-phdr.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/attr-phdr.s?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -0,0 +1,9 @@\n+\t.attribute arch, \"rv32i2p0_m2p0\"\n+\t.option nopic\n+\t.text\n+\t.align\t1\n+\t.globl\t_start\n+\t.type\t_start, @function\n+_start:\n+\tret\n+\t.size\t_start, .-_start"
    },
    {
      "sha": "1f6eceb3ae84f1b73f82e352272b7aae68eb39e6",
      "filename": "ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-riscv-elf/ld-riscv-elf.exp?ref=fbc95f1e11facf233e89a9c2b4dde06b9aaf4b86",
      "patch": "@@ -112,6 +112,7 @@ if [istarget \"riscv*-*-*\"] {\n     run_dump_test \"attr-merge-priv-spec-failed-04\"\n     run_dump_test \"attr-merge-priv-spec-failed-05\"\n     run_dump_test \"attr-merge-priv-spec-failed-06\"\n+    run_dump_test \"attr-phdr\"\n     run_ld_link_tests [list \\\n \t[list \"Weak reference 32\" \"-T weakref.ld -m[riscv_choose_ilp32_emul]\" \"\" \\\n \t    \"-march=rv32i -mabi=ilp32\" {weakref32.s} \\"
    }
  ]
}