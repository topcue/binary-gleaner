{
  "sha": "b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YjJlZmU3MGNmMzRlMmYzYWRhOGQwZGVmNjllNTNmMjdhNmI3MTU3OA==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2020-01-07T00:41:08Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2020-01-09T23:11:45Z"
    },
    "message": "gdb/tui: Fix 'layout asm' before the inferior has started\n\nCurrently if a user starts the tui with 'layout asm' then they will be\npresented with the 'src' layout.\n\nWhat happens is:\n\n  1. Layout command enables TUI, selecting the SRC layout by default.\n\n  2. As part of tui_enable we call tui_display_main, which calls\n     tui_get_begin_asm_address, which calls\n     set_default_source_symtab_and_line.  This changes core GDBs\n     current symtab and line, which triggers a call to the symtab\n     changed hook tui_symtab_changed, which sets the flag\n     from_source_symtab.\n\n  3. Back in the layout command, the layout is changed from SRC to\n     ASM.  After this the layout command completes and we return to\n     core GDB which prints the prompt, however...\n\n  4. The before prompt hook is called which sees the\n     from_source_symtab flag is set and forces the SRC window to be\n     displayed.  This switches us back to SRC view.\n\nThe solution I propose here is to delay installing the hooks into core\nGDB until after we have finished setting up the tui and selecting the\ndefault frame to view.  In this way we effectively ignore the first\nsymtab changed event triggered when making main the default symtab.\n\ngdb/ChangeLog:\n\n\t* tui/tui.c (tui_enable): Register tui hooks after calling\n\ttui_display_main.\n\ngdb/testsuite/ChangeLog:\n\n\t* gdb.tui/tui-layout-asm.exp: New file.\n\nChange-Id: I858ab81a17ffb4aa72deb3f36c3755228a9c9d9a",
    "tree": {
      "sha": "d678a733515b2c48cb302c3d83d4abd6bb05d65f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/d678a733515b2c48cb302c3d83d4abd6bb05d65f"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "3804da7e07a13c14210d79de55ebfe2318421164",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3804da7e07a13c14210d79de55ebfe2318421164",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/3804da7e07a13c14210d79de55ebfe2318421164"
    }
  ],
  "stats": {
    "total": 53,
    "additions": 49,
    "deletions": 4
  },
  "files": [
    {
      "sha": "0ff44e50016017555f960520822d5991e58604c9",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
      "patch": "@@ -1,3 +1,8 @@\n+2020-01-09  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* tui/tui.c (tui_enable): Register tui hooks after calling\n+\ttui_display_main.\n+\n 2020-01-09  Christian Biesinger  <cbiesinger@google.com>\n \n \t* gdbsupport/common-defs.h: Don't define _FORTIFY_SOURCE on MinGW."
    },
    {
      "sha": "0f2333bc1c4614c01dd96cf200b85eb820d61c48",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
      "patch": "@@ -1,3 +1,7 @@\n+2020-01-09  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* gdb.tui/tui-layout-asm.exp: New file.\n+\n 2020-01-09  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* lib/tuiterm.exp (Term::check_box_contents): New proc."
    },
    {
      "sha": "cec2735764ec1c4a8bdcbcc16d9ff4cf87dbdd27",
      "filename": "gdb/testsuite/gdb.tui/tui-layout-asm.exp",
      "status": "added",
      "additions": 34,
      "deletions": 0,
      "changes": 34,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/testsuite/gdb.tui/tui-layout-asm.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/testsuite/gdb.tui/tui-layout-asm.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.tui/tui-layout-asm.exp?ref=b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
      "patch": "@@ -0,0 +1,34 @@\n+# Copyright 2020 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+# Ensure that 'layout asm' before starting the inferior puts us in the\n+# asm layout and displays the disassembly for main.\n+\n+load_lib \"tuiterm.exp\"\n+\n+standard_testfile tui-layout.c\n+\n+if {[build_executable \"failed to prepare\" ${testfile} ${srcfile}] == -1} {\n+    return -1\n+}\n+\n+Term::clean_restart 24 80 $testfile\n+if {![Term::prepare_for_tui]} {\n+    unsupported \"TUI not supported\"\n+}\n+\n+# This puts us into TUI mode, and should display the ASM window.\n+Term::command \"layout asm\"\n+Term::check_box_contents \"check asm box contents\" 0 0 80 15 \"<main>\""
    },
    {
      "sha": "99d30a55a153338e64399410da7461a11633f3ae",
      "filename": "gdb/tui/tui.c",
      "status": "modified",
      "additions": 6,
      "deletions": 4,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/tui/tui.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b2efe70cf34e2f3ada8d0def69e53f27a6b71578/gdb/tui/tui.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui.c?ref=b2efe70cf34e2f3ada8d0def69e53f27a6b71578",
      "patch": "@@ -489,10 +489,6 @@ tui_enable (void)\n      clearok (stdscr, TRUE);\n    }\n \n-  /* Install the TUI specific hooks.  */\n-  tui_install_hooks ();\n-  rl_startup_hook = tui_rl_startup_hook;\n-\n   if (tui_update_variables ())\n     tui_rehighlight_all ();\n \n@@ -513,6 +509,12 @@ tui_enable (void)\n   else\n     tui_display_main ();\n \n+  /* Install the TUI specific hooks.  This must be done after the call to\n+     tui_display_main so that we don't detect the symtab changed event it\n+     can cause.  */\n+  tui_install_hooks ();\n+  rl_startup_hook = tui_rl_startup_hook;\n+\n   /* Restore TUI keymap.  */\n   tui_set_key_mode (tui_current_key_mode);\n "
    }
  ]
}