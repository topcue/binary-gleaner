{
  "sha": "14f9473ca225290680c8b21240cdca49f8d3b332",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MTRmOTQ3M2NhMjI1MjkwNjgwYzhiMjEyNDBjZGNhNDlmOGQzYjMzMg==",
  "commit": {
    "author": {
      "name": "Victor Collod",
      "email": "vcollod@nvidia.com",
      "date": "2020-09-19T00:53:02Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-09-19T00:53:34Z"
    },
    "message": "gdb: Update i386_analyze_prologue to skip endbr32\n\nWith -m32 -fcf-protection, GCC generates an `endbr32` instruction at the\nfunction entry:\n\n[hjl@gnu-cfl-2 gdb]$ cat /tmp/x.c\nint\nmain(void)\n{\n  return 0;\n}\n[hjl@gnu-cfl-2 gdb]$ gcc -g -fcf-protection /tmp/x.c -m32\n(gdb) b main\nBreakpoint 1 at 0x8049176: file /tmp/x.c, line 3.\n(gdb) r\nBreakpoint 1, main () at /tmp/x.c:3\n3\t{\n(gdb) disass\nDump of assembler code for function main:\n=> 0x08049176 <+0>:\tendbr32\n   0x0804917a <+4>:\tpush   %ebp\n   0x0804917b <+5>:\tmov    %esp,%ebp\n   0x0804917d <+7>:\tmov    $0x0,%eax\n   0x08049182 <+12>:\tpop    %ebp\n   0x08049183 <+13>:\tret\nEnd of assembler dump.\n(gdb)\n\nUpdate i386_analyze_prologue to skip `endbr32`:\n\n(gdb) b main\nBreakpoint 1 at 0x804917d: file /tmp/x.c, line 4.\n(gdb) r\nBreakpoint 1, main () at /tmp/x.c:4\n4\t  return 0;\n(gdb) disass\nDump of assembler code for function main:\n   0x08049176 <+0>:\tendbr32\n   0x0804917a <+4>:\tpush   %ebp\n   0x0804917b <+5>:\tmov    %esp,%ebp\n=> 0x0804917d <+7>:\tmov    $0x0,%eax\n   0x08049182 <+12>:\tpop    %ebp\n   0x08049183 <+13>:\tret\nEnd of assembler dump.\n(gdb)\n\nTested with\n\n$ make check RUNTESTFLAGS=\"--target_board='unix{-m32,}' i386-prologue-skip-cf-protection.exp\"\n\non Fedora 32/x86-64.\n\n2020-0X-YY  Victor Collod  <vcollod@nvidia.com>\n\ngdb/ChangeLog:\n\n\tPR gdb/26635\n\t* i386-tdep.c (i386_skip_endbr): Add a helper function to skip endbr.\n\t(i386_analyze_prologue): Call i386_skip_endbr.\n\ngdb/testsuite/ChangeLog:\n\n\tPR gdb/26635\n\t* gdb.arch/amd64-prologue-skip-cf-protection.exp: Make the test\n\tcompatible with i386, and move it to...\n\t* gdb.arch/i386-prologue-skip-cf-protection.exp: ... here.\n\t* gdb.arch/amd64-prologue-skip-cf-protection.c: Move to...\n\t* gdb.arch/i386-prologue-skip-cf-protection.c: ... here.",
    "tree": {
      "sha": "b3dbcee34e32092afbe435d4d47f83fbb9619651",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b3dbcee34e32092afbe435d4d47f83fbb9619651"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/14f9473ca225290680c8b21240cdca49f8d3b332",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/14f9473ca225290680c8b21240cdca49f8d3b332",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/14f9473ca225290680c8b21240cdca49f8d3b332",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/14f9473ca225290680c8b21240cdca49f8d3b332/comments",
  "author": null,
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "febd44f94d944c9058b387a784124dc8e0de58ee",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/febd44f94d944c9058b387a784124dc8e0de58ee",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/febd44f94d944c9058b387a784124dc8e0de58ee"
    }
  ],
  "stats": {
    "total": 40,
    "additions": 37,
    "deletions": 3
  },
  "files": [
    {
      "sha": "8b010e525f69a5a768b1c01d1256f2ca084ee2c0",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=14f9473ca225290680c8b21240cdca49f8d3b332",
      "patch": "@@ -1,3 +1,9 @@\n+2020-09-18  Victor Collod  <vcollod@nvidia.com>\n+\n+\tPR gdb/26635\n+\t* i386-tdep.c (i386_skip_endbr): Add a helper function to skip endbr.\n+\t(i386_analyze_prologue): Call i386_skip_endbr.\n+\n 2020-09-18  Tom Tromey  <tromey@adacore.com>\n \n \t* windows-nat.c (struct windows_nat_target) <wait>: Update."
    },
    {
      "sha": "b485f0b296a9488a66a5965d6e17686c103944c2",
      "filename": "gdb/i386-tdep.c",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/i386-tdep.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/i386-tdep.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/i386-tdep.c?ref=14f9473ca225290680c8b21240cdca49f8d3b332",
      "patch": "@@ -1538,6 +1538,24 @@ struct i386_insn i386_frame_setup_skip_insns[] =\n   { 0 }\n };\n \n+/* Check whether PC points to an endbr32 instruction.  */\n+static CORE_ADDR\n+i386_skip_endbr (CORE_ADDR pc)\n+{\n+  static const gdb_byte endbr32[] = { 0xf3, 0x0f, 0x1e, 0xfb };\n+\n+  gdb_byte buf[sizeof (endbr32)];\n+\n+  /* Stop there if we can't read the code */\n+  if (target_read_code (pc, buf, sizeof (endbr32)))\n+    return pc;\n+\n+  /* If the instruction isn't an endbr32, stop */\n+  if (memcmp (buf, endbr32, sizeof (endbr32)) != 0)\n+    return pc;\n+\n+  return pc + sizeof (endbr32);\n+}\n \n /* Check whether PC points to a no-op instruction.  */\n static CORE_ADDR\n@@ -1815,6 +1833,7 @@ i386_analyze_prologue (struct gdbarch *gdbarch,\n \t\t       CORE_ADDR pc, CORE_ADDR current_pc,\n \t\t       struct i386_frame_cache *cache)\n {\n+  pc = i386_skip_endbr (pc);\n   pc = i386_skip_noop (pc);\n   pc = i386_follow_jump (gdbarch, pc);\n   pc = i386_analyze_struct_return (pc, current_pc, cache);"
    },
    {
      "sha": "b7c1ce81d58783a88925ccde10e5f214bfec2fb4",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=14f9473ca225290680c8b21240cdca49f8d3b332",
      "patch": "@@ -1,3 +1,12 @@\n+2020-09-18  Victor Collod  <vcollod@nvidia.com>\n+\n+\tPR gdb/26635\n+\t* gdb.arch/amd64-prologue-skip-cf-protection.exp: Make the test\n+\tcompatible with i386, and move it to...\n+\t* gdb.arch/i386-prologue-skip-cf-protection.exp: ... here.\n+\t* gdb.arch/amd64-prologue-skip-cf-protection.c: Move to...\n+\t* gdb.arch/i386-prologue-skip-cf-protection.c: ... here.\n+\n 2020-09-18  Pedro Alves  <pedro@palves.net>\n \n \tPR gdb/26631"
    },
    {
      "sha": "a6505857e17627761edaddd38a043e5653e4caa6",
      "filename": "gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.c",
      "status": "renamed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.c?ref=14f9473ca225290680c8b21240cdca49f8d3b332",
      "previous_filename": "gdb/testsuite/gdb.arch/amd64-prologue-skip-cf-protection.c"
    },
    {
      "sha": "9ba64f9c375dd022f2c75fdaaf42d31628d59dda",
      "filename": "gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.exp",
      "status": "renamed",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/14f9473ca225290680c8b21240cdca49f8d3b332/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.arch/i386-prologue-skip-cf-protection.exp?ref=14f9473ca225290680c8b21240cdca49f8d3b332",
      "patch": "@@ -16,13 +16,13 @@\n # Test skipping a prologue that was generated with gcc's -fcf-protection=full\n # (control flow protection) option.\n #\n-# This option places an `endbr64` instruction at the start of all functions,\n-# which can interfere with prologue analysis.\n+# This option places an `endbr32`/`endbr64` instruction at the start of\n+# all functions, which can interfere with prologue analysis.\n \n standard_testfile .c\n set binfile ${binfile}\n \n-if { ![istarget x86_64-*-* ] || ![is_lp64_target] } {\n+if { ![istarget x86_64-*-*] && ![istarget i?86-*-*] } {\n     verbose \"Skipping ${testfile}.\"\n     return\n }",
      "previous_filename": "gdb/testsuite/gdb.arch/amd64-prologue-skip-cf-protection.exp"
    }
  ]
}