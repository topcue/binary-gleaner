{
  "sha": "661b504df9bfb8d7c5d669091720e1dc0079c05e",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NjYxYjUwNGRmOWJmYjhkN2M1ZDY2OTA5MTcyMGUxZGMwMDc5YzA1ZQ==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2021-07-08T20:49:17Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2021-07-08T20:57:52Z"
    },
    "message": "x86-64: Disallow PC reloc against weak undefined symbols in PIE\n\nDisallow PC relocations against weak undefined symbols in PIE since they\ncan lead to non-zero address at run-time.\n\nbfd/\n\n\tPR ld/21782\n\t* elf64-x86-64.c (elf_x86_64_relocate_section): Disallow PC\n\trelocations against weak undefined symbols in PIE.\n\nld/\n\n\tPR ld/21782\n\t* testsuite/ld-x86-64/pie3.d: Expect linker error.",
    "tree": {
      "sha": "cfa4e84297a9a3156071b6ab3970989f0af2c292",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/cfa4e84297a9a3156071b6ab3970989f0af2c292"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/661b504df9bfb8d7c5d669091720e1dc0079c05e",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/661b504df9bfb8d7c5d669091720e1dc0079c05e",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/661b504df9bfb8d7c5d669091720e1dc0079c05e",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/661b504df9bfb8d7c5d669091720e1dc0079c05e/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a8dde0a2114f87bcdc19946aeab26788f5eae1b7",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a8dde0a2114f87bcdc19946aeab26788f5eae1b7",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/a8dde0a2114f87bcdc19946aeab26788f5eae1b7"
    }
  ],
  "stats": {
    "total": 18,
    "additions": 6,
    "deletions": 12
  },
  "files": [
    {
      "sha": "8deb62dba5c7736fddad146708de042891d5520d",
      "filename": "bfd/elf64-x86-64.c",
      "status": "modified",
      "additions": 5,
      "deletions": 2,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/661b504df9bfb8d7c5d669091720e1dc0079c05e/bfd/elf64-x86-64.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/661b504df9bfb8d7c5d669091720e1dc0079c05e/bfd/elf64-x86-64.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf64-x86-64.c?ref=661b504df9bfb8d7c5d669091720e1dc0079c05e",
      "patch": "@@ -3161,6 +3161,8 @@ elf_x86_64_relocate_section (bfd *output_bfd,\n \t\t       || (no_copyreloc_p\n \t\t\t   && h->def_dynamic\n \t\t\t   && !(h->root.u.def.section->flags & SEC_CODE))))\n+\t\t  || (bfd_link_pie (info)\n+\t\t      && h->root.type == bfd_link_hash_undefweak)\n \t\t  || bfd_link_dll (info)))\n \t    {\n \t      bool fail = false;\n@@ -3174,8 +3176,9 @@ elf_x86_64_relocate_section (bfd *output_bfd,\n \t\t{\n \t\t  /* We can only use PC-relative relocations in PIE\n \t\t     from non-code sections.  */\n-\t\t  if (h->type == STT_FUNC\n-\t\t      && (sec->flags & SEC_CODE) != 0)\n+\t\t  if (h->root.type == bfd_link_hash_undefweak\n+\t\t      || (h->type == STT_FUNC\n+\t\t\t  && (sec->flags & SEC_CODE) != 0))\n \t\t    fail = true;\n \t\t}\n \t      else if (no_copyreloc_p || bfd_link_dll (info))"
    },
    {
      "sha": "a20029c63ba5365c681132d0f113d1fc72c23aac",
      "filename": "ld/testsuite/ld-x86-64/pie3.d",
      "status": "modified",
      "additions": 1,
      "deletions": 10,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/661b504df9bfb8d7c5d669091720e1dc0079c05e/ld/testsuite/ld-x86-64/pie3.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/661b504df9bfb8d7c5d669091720e1dc0079c05e/ld/testsuite/ld-x86-64/pie3.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-x86-64/pie3.d?ref=661b504df9bfb8d7c5d669091720e1dc0079c05e",
      "patch": "@@ -1,12 +1,3 @@\n #as: --64\n #ld: -pie -melf_x86_64 --hash-style=sysv -z max-page-size=0x200000 -z noseparate-code\n-#objdump: -dw\n-\n-.*: +file format .*\n-\n-\n-Disassembly of section .text:\n-\n-0+191 <_start>:\n- +191:\t48 8d 05 68 fe ff ff \tlea    -0x198\\(%rip\\),%rax        # 0 <_start-0x191>\n-#pass\n+#error: .*relocation R_X86_64_PC32 against undefined symbol `foo' can not be used when making a PIE object; recompile with -fPIE"
    }
  ]
}