{
  "sha": "ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YWU5ZDIyMzNlNjFhOThmZjhkYmE1NmJlMTAyMTlhYTUzMDZmZmM5YQ==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-10-26T13:16:08Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-10-26T13:16:21Z"
    },
    "message": "gas: Clear all auto-assigned file slots\n\nSince a file slot is auto-assigned for the #APP marker appeared before\nthe first .file <NUMBER> directive has been seen, clear all auto-assigned\nfile slots when seeing the first .file <NUMBER> directive.\n\n\tPR gas/26778\n\t* * dwarf2dbg.c (num_of_auto_assigned): New.\n\t(allocate_filenum): Increment num_of_auto_assigned.\n\t(dwarf2_directive_filename): Clear the slots auto-assigned\n\tbefore the first .file <NUMBER> directive was seen.\n\t* testsuite/gas/i386/dwarf4-line-1.d: New file.\n\t* testsuite/gas/i386/dwarf4-line-1.s: Likewise.\n\t* testsuite/gas/i386/i386.exp: Run dwarf4-line-1.",
    "tree": {
      "sha": "660106b67bb2843a8828b283acc6e759fc6235ea",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/660106b67bb2843a8828b283acc6e759fc6235ea"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "93cf38c095afbee84ed580c431d001f20442f73e",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/93cf38c095afbee84ed580c431d001f20442f73e",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/93cf38c095afbee84ed580c431d001f20442f73e"
    }
  ],
  "stats": {
    "total": 100,
    "additions": 89,
    "deletions": 11
  },
  "files": [
    {
      "sha": "a52eb2bd0368d5b9bb08115e55e7b60fe268c34a",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
      "patch": "@@ -1,3 +1,14 @@\n+2020-10-26  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR gas/26778\n+\t* * dwarf2dbg.c (num_of_auto_assigned): New.\n+\t(allocate_filenum): Increment num_of_auto_assigned.\n+\t(dwarf2_directive_filename): Clear the slots auto-assigned\n+\tbefore the first .file <NUMBER> directive was seen.\n+\t* testsuite/gas/i386/dwarf4-line-1.d: New file.\n+\t* testsuite/gas/i386/dwarf4-line-1.s: Likewise.\n+\t* testsuite/gas/i386/i386.exp: Run dwarf4-line-1.\n+\n 2020-10-26  Cooper Qu <cooper.qu@linux.alibaba.com>\n \n \t* config/tc-csky.c (dump_literals): Fix the literal dump"
    },
    {
      "sha": "4e03c637d765978ddf1dbea8238b5d949321bcce",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 13,
      "deletions": 11,
      "changes": 24,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
      "patch": "@@ -218,6 +218,7 @@ struct file_entry\n static struct file_entry *files;\n static unsigned int files_in_use;\n static unsigned int files_allocated;\n+static unsigned int num_of_auto_assigned;\n \n /* Table of directories used by .debug_line.  */\n static char **       dirs = NULL;\n@@ -718,6 +719,8 @@ allocate_filenum (const char * pathname)\n   if (!assign_file_to_slot (i, file, dir))\n     return -1;\n \n+  num_of_auto_assigned++;\n+\n   last_used = i;\n   last_used_dir_len = dir_len;\n \n@@ -1013,6 +1016,7 @@ dwarf2_directive_filename (void)\n   char *filename;\n   const char * dirname = NULL;\n   int filename_len;\n+  unsigned int i;\n \n   /* Continue to accept a bare string and pass it off.  */\n   SKIP_WHITESPACE ();\n@@ -1079,18 +1083,16 @@ dwarf2_directive_filename (void)\n       return NULL;\n     }\n \n-  if (files_in_use == 2)\n+  if (num_of_auto_assigned)\n     {\n-      /* Clear the slot 1 if it was assigned to the input file before\n-\t the first .file <NUMBER> directive was seen.  */\n-      unsigned int lineno;\n-      const char *file = as_where (&lineno);\n-      file = get_basename (file);\n-      if (filename_cmp (file, files[1].filename) == 0)\n-\t{\n-\t  files[1].filename = NULL;\n-\t  files_in_use = 0;\n-\t}\n+      /* Clear slots auto-assigned before the first .file <NUMBER>\n+\t directive was seen.  */\n+      if (files_in_use != (num_of_auto_assigned + 1))\n+\tabort ();\n+      for (i = 1; i < files_in_use; i++)\n+\tfiles[i].filename = NULL;\n+      files_in_use = 0;\n+      num_of_auto_assigned = 0;\n     }\n \n   if (! allocate_filename_to_slot (dirname, filename, (unsigned int) num,"
    },
    {
      "sha": "4f8321e9bfd9136fafeb073a1fda5869db48d861",
      "filename": "gas/testsuite/gas/i386/dwarf4-line-1.d",
      "status": "added",
      "additions": 50,
      "deletions": 0,
      "changes": 50,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/dwarf4-line-1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/dwarf4-line-1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf4-line-1.d?ref=ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
      "patch": "@@ -0,0 +1,50 @@\n+#as: -gdwarf-4\n+#readelf: -wl\n+#name: DWARF4 .debug_line 1\n+\n+Raw dump of debug contents of section \\.z?debug_line:\n+\n+  Offset:                      0x0\n+  Length:                      .*\n+  DWARF Version:               4\n+  Prologue Length:             .*\n+  Minimum Instruction Length:  1\n+  Maximum Ops per Instruction: 1\n+  Initial value of 'is_stmt':  1\n+  Line Base:                   -5\n+  Line Range:                  14\n+  Opcode Base:                 13\n+\n+ Opcodes:\n+  Opcode 1 has 0 args\n+  Opcode 2 has 1 arg\n+  Opcode 3 has 1 arg\n+  Opcode 4 has 1 arg\n+  Opcode 5 has 1 arg\n+  Opcode 6 has 0 args\n+  Opcode 7 has 0 args\n+  Opcode 8 has 0 args\n+  Opcode 9 has 1 arg\n+  Opcode 10 has 0 args\n+  Opcode 11 has 0 args\n+  Opcode 12 has 1 arg\n+\n+ The Directory Table \\(offset 0x.*\\):\n+  1\t.*/gas/testsuite/gas/i386\n+\n+ The File Name Table \\(offset 0x.*\\):\n+  Entry\tDir\tTime\tSize\tName\n+  1\t0\t0\t0\tfoo.c\n+  2\t0\t0\t0\tfoo.h\n+\n+ Line Number Statements:\n+  \\[0x.*\\]  Extended opcode 2: set Address to 0x0\n+  \\[0x.*\\]  Advance Line by 81 to 82\n+  \\[0x.*\\]  Copy\n+  \\[0x.*\\]  Set File Name to entry 2 in the File Name Table\n+  \\[0x.*\\]  Advance Line by -73 to 9\n+  \\[0x.*\\]  Special opcode 19: advance Address by 1 to 0x1 and Line by 0 to 9\n+  \\[0x.*\\]  Advance PC by 3 to 0x4\n+  \\[0x.*\\]  Extended opcode 1: End of Sequence\n+\n+"
    },
    {
      "sha": "e558fdc0507f744b012cbabc8d73c21a2a5e1263",
      "filename": "gas/testsuite/gas/i386/dwarf4-line-1.s",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/dwarf4-line-1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/dwarf4-line-1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf4-line-1.s?ref=ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
      "patch": "@@ -0,0 +1,14 @@\n+\t.file\t\"foo.c\"\n+\t.text\n+bar:\n+#APP\n+# 82 \"foo.h\" 1\n+\tnop\n+# 0 \"\" 2\n+#NO_APP\n+\tret\n+foo:\n+\t.file 1 \"foo.c\"\n+\tnop\n+\t.file 2 \"foo.h\"\n+\tret"
    },
    {
      "sha": "c85ced1c918153e51d4f92f23c639a2b310f6273",
      "filename": "gas/testsuite/gas/i386/i386.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/i386.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ae9d2233e61a98ff8dba56be10219aa5306ffc9a/gas/testsuite/gas/i386/i386.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/i386.exp?ref=ae9d2233e61a98ff8dba56be10219aa5306ffc9a",
      "patch": "@@ -619,6 +619,7 @@ if [gas_32_check] then {\n \trun_dump_test \"dwarf2-line-2\"\n \trun_dump_test \"dwarf2-line-3\"\n \trun_dump_test \"dwarf2-line-4\"\n+\trun_dump_test \"dwarf4-line-1\"\n \trun_dump_test \"dwarf5-line-1\"\n \trun_dump_test \"dwarf5-line-2\"\n \trun_dump_test \"dwarf5-line-3\""
    }
  ]
}