{
  "sha": "37ab86550b9da31d6c32c2d3384bd27f0426e935",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzdhYjg2NTUwYjlkYTMxZDZjMzJjMmQzMzg0YmQyN2YwNDI2ZTkzNQ==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-06-19T15:55:52Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-06-19T15:55:52Z"
    },
    "message": "[gdb/testsuite] Limit default_target_compile override\n\nThe file lib/future.exp contains an override of dejagnu's\ndefault_target_compile.\n\nThe override is activated if dejagnu's default_target_compile is missing\nsupport for one or more languages.\n\nHowever, if the override is activated, it's active for all languages.\n\nThis unnecessarily extends the scope of potential problems in the override to\nlanguages that don't need the override.\n\nFix this by limiting the scope of the override.\n\nAlso add a note stating for which languages the override is active, as a\nreminder that support for those languages needs to be ported to dejagnu.  With\nmy system dejagnu 1.6.1, as well as with current dejagnu trunk, that gives us:\n...\nNOTE: Dejagnu's default_target_compile is missing support for Go, using \\\n  local override\nNOTE: Dejagnu's default_target_compile is missing support for Rust, using \\\n  local override\n...\n\nTested on x86_64-linux.\n\ngdb/testsuite/ChangeLog:\n\n2020-06-19  Tom de Vries  <tdevries@suse.de>\n\n\t* lib/gdb.exp (gdb_note): New proc.\n\t* lib/future.exp (gdb_default_target_compile_1): Factor out of ...\n\t(gdb_default_target_compile): ... here.  Only call\n\tgdb_default_target_compile_1 if use_gdb_compile(<lang>) is set.\n\t(use_gdb_compile): Change to array.\n\t(toplevel): Update sets of use_gdb_compile to specify language.\n\tWarn about default_target_compile override.  Store dejagnu's version\n\tof default_target_compile in dejagnu_default_target_compile.",
    "tree": {
      "sha": "3217dad4a90639ed443d399051eb555695fed576",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3217dad4a90639ed443d399051eb555695fed576"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/37ab86550b9da31d6c32c2d3384bd27f0426e935",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/37ab86550b9da31d6c32c2d3384bd27f0426e935",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/37ab86550b9da31d6c32c2d3384bd27f0426e935",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/37ab86550b9da31d6c32c2d3384bd27f0426e935/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "13aa5ceb01cc94a0e617f397c0c5434fc22bb1e5",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/13aa5ceb01cc94a0e617f397c0c5434fc22bb1e5",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/13aa5ceb01cc94a0e617f397c0c5434fc22bb1e5"
    }
  ],
  "stats": {
    "total": 85,
    "additions": 72,
    "deletions": 13
  },
  "files": [
    {
      "sha": "daed3930f51d7b4b0ee0174856d1b66edcca4f58",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=37ab86550b9da31d6c32c2d3384bd27f0426e935",
      "patch": "@@ -1,3 +1,14 @@\n+2020-06-19  Tom de Vries  <tdevries@suse.de>\n+\n+\t* lib/gdb.exp (gdb_note): New proc.\n+\t* lib/future.exp (gdb_default_target_compile_1): Factor out of ...\n+\t(gdb_default_target_compile): ... here.  Only call\n+\tgdb_default_target_compile_1 if use_gdb_compile(<lang>) is set.\n+\t(use_gdb_compile): Change to array.\n+\t(toplevel): Update sets of use_gdb_compile to specify language.\n+\tWarn about default_target_compile override.  Store dejagnu's version\n+\tof default_target_compile in dejagnu_default_target_compile.\n+\n 2020-06-18  Tom de Vries  <tdevries@suse.de>\n \n \t* lib/gdb.exp (gdb_init): Move all but call to default_gdb_init to ..."
    },
    {
      "sha": "ba00a31c1971346acfce8548b4be51ad3b49800f",
      "filename": "gdb/testsuite/lib/future.exp",
      "status": "modified",
      "additions": 55,
      "deletions": 13,
      "changes": 68,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/lib/future.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/lib/future.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/future.exp?ref=37ab86550b9da31d6c32c2d3384bd27f0426e935",
      "patch": "@@ -172,7 +172,9 @@ proc gdb_find_eu-unstrip {} {\n     return $eu_unstrip\n }\n \n-proc gdb_default_target_compile {source destfile type options} {\n+# Local version of default_target_compile, to be used for languages that\n+# dejagnu's default_target_compile doesn't support.\n+proc gdb_default_target_compile_1 {source destfile type options} {\n     global target_triplet\n     global tool_root_dir\n     global CFLAGS_FOR_TARGET\n@@ -627,40 +629,80 @@ proc gdb_default_target_compile {source destfile type options} {\n     return ${comp_output}\n }\n \n-# See if the version of dejaGNU being used to run the testsuite is\n-# recent enough to contain support for building Ada programs or not.\n-# If not, then use the functions above in place of the ones provided\n-# by dejaGNU. This is only temporary (brobecker/2004-03-31).\n+# If dejagnu's default_target_compile supports the language specified in\n+# OPTIONS, use it.  Otherwise, use gdb_default_target_compile_1.\n+proc gdb_default_target_compile {source destfile type options} {\n+    global use_gdb_compile\n+\n+    set need_local 0\n+    foreach i $options {\n+\n+\tif { $i == \"ada\" || $i == \"d\" || $i == \"go\" || $i == \"rust\" } {\n+\t    set need_local [info exists use_gdb_compile($i)]\n+\t    break\n+\t}\n+\n+\tif { $i == \"c++\" } {\n+\t    break\n+\t}\n+\n+\tif { $i == \"f77\" || $i == \"f90\" } {\n+\t    set need_local [info exists use_gdb_compile(fortran)]\n+\t    break\n+\t}\n+    }\n+\n+    if { $need_local } {\n+\treturn [gdb_default_target_compile_1 $source $destfile $type $options]\n+    }\n+\n+    return [dejagnu_default_target_compile $source $destfile $type $options]\n+}\n+\n+# Array of languages for which dejagnu's default_target_compile is missing\n+# support.\n+array set use_gdb_compile [list]\n+\n+# Note missing support in dejagnu's default_target_compile.  This\n+# needs to be fixed by porting the missing support to Dejagnu.\n+set note_prefix \"Dejagnu's default_target_compile is missing support for \"\n+set note_suffix \", using local override\"\n \n-set use_gdb_compile 0\n if {[info procs find_gnatmake] == \"\"} {\n     rename gdb_find_gnatmake find_gnatmake\n-    set use_gdb_compile 1\n+    set use_gdb_compile(ada) 1\n+    gdb_note [join [list $note_prefix \"Ada\" $note_suffix] \"\"]\n }\n \n if {[info procs find_gfortran] == \"\"} {\n     rename gdb_find_gfortran find_gfortran\n-    set use_gdb_compile 1\n+    set use_gdb_compile(fortran) 1\n+    gdb_note [join [list $note_prefix \"Fortran\" $note_suffix] \"\"]\n }\n \n if {[info procs find_go_linker] == \"\"} {\n     rename gdb_find_go find_go\n     rename gdb_find_go_linker find_go_linker\n-    set use_gdb_compile 1\n+    set use_gdb_compile(go) 1\n+    gdb_note [join [list $note_prefix \"Go\" $note_suffix] \"\"]\n }\n \n if {[info procs find_gdc] == \"\"} {\n     rename gdb_find_gdc find_gdc\n-    set use_gdb_compile 1\n+    set use_gdb_compile(d) 1\n+    gdb_note [join [list $note_prefix \"D\" $note_suffix] \"\"]\n }\n \n if {[info procs find_rustc] == \"\"} {\n     rename gdb_find_rustc find_rustc\n-    set use_gdb_compile 1\n+    set use_gdb_compile(rust) 1\n+    gdb_note [join [list $note_prefix \"Rust\" $note_suffix] \"\"]\n }\n \n-if {$use_gdb_compile} {\n-    catch {rename default_target_compile {}}\n+# If dejagnu's default_target_compile is missing support for any language,\n+# override it.\n+if { [array size use_gdb_compile] != 0 } {\n+    catch {rename default_target_compile dejagnu_default_target_compile}\n     rename gdb_default_target_compile default_target_compile\n }\n "
    },
    {
      "sha": "7b243f5fff3c7f1a6a5c72ab6aa7e5c4f6c38f98",
      "filename": "gdb/testsuite/lib/gdb.exp",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/lib/gdb.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/37ab86550b9da31d6c32c2d3384bd27f0426e935/gdb/testsuite/lib/gdb.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/gdb.exp?ref=37ab86550b9da31d6c32c2d3384bd27f0426e935",
      "patch": "@@ -7393,5 +7393,11 @@ proc tuiterm_env { } {\n     lappend gdb_finish_hooks tuiterm_env_finish\n }\n \n+# Dejagnu has a version of note, but usage is not allowed outside of dejagnu.\n+# Define a local version.\n+proc gdb_note { message } {\n+    verbose -- \"NOTE: $message\" 0\n+}\n+\n # Always load compatibility stuff.\n load_lib future.exp"
    }
  ]
}