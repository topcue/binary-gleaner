{
  "sha": "d548f47df4d2e3d117d504a4c9977982c78a0556",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZDU0OGY0N2RmNGQyZTNkMTE3ZDUwNGE0Yzk5Nzc5ODJjNzhhMDU1Ng==",
  "commit": {
    "author": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2020-04-25T07:40:25Z"
    },
    "committer": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2020-04-30T01:34:23Z"
    },
    "message": "xtensa: fix XTENSA_NDIFF handling for PR ld/25861\n\nFields marked with XTENSA_NDIFF relocations are not negated, they only\nhave sign bits removed. Don't negate their values when relaxation is\nperformed. Don't add sign bits when the value is zero. Report overflow\nwhen the result has negative sign but all significant bits are zero.\n\n2020-04-29  Max Filippov  <jcmvbkbc@gmail.com>\nbfd/\n\t* elf32-xtensa.c (relax_section): Don't negate diff_value for\n\tXTENSA_NDIFF relocations. Don't add sign bits whe diff_value\n\tequals 0. Report overflow when the result has negative sign but\n\tall significant bits are zero.\n\nld/\n\t* testsuite/ld-xtensa/relax-diff1.d: New test definition.\n\t* testsuite/ld-xtensa/relax-diff1.s: New test source.\n\t* testsuite/ld-xtensa/relax-ndiff.d: New test definition.\n\t* testsuite/ld-xtensa/relax-ndiff.s: New test source.\n\t* testsuite/ld-xtensa/xtensa.exp: (relax-diff1)\n\t(relax-ndiff): New tests.",
    "tree": {
      "sha": "e1dee17e4e4ef7333271c7b216105d2e146d9351",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e1dee17e4e4ef7333271c7b216105d2e146d9351"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/d548f47df4d2e3d117d504a4c9977982c78a0556",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d548f47df4d2e3d117d504a4c9977982c78a0556",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/d548f47df4d2e3d117d504a4c9977982c78a0556",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d548f47df4d2e3d117d504a4c9977982c78a0556/comments",
  "author": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "935f1f4ba35dc018ec6adbc1ba5f0787c84f273b",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/935f1f4ba35dc018ec6adbc1ba5f0787c84f273b",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/935f1f4ba35dc018ec6adbc1ba5f0787c84f273b"
    }
  ],
  "stats": {
    "total": 94,
    "additions": 83,
    "deletions": 11
  },
  "files": [
    {
      "sha": "25453b384bfe6f5470831c66de2c23afd67f06aa",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -1,3 +1,10 @@\n+2020-04-29  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* elf32-xtensa.c (relax_section): Don't negate diff_value for\n+\tXTENSA_NDIFF relocations. Don't add sign bits whe diff_value\n+\tequals 0. Report overflow when the result has negative sign but\n+\tall significant bits are zero.\n+\n 2020-04-29  Gunther Nikl  <gnikl@justmail.de>\n \n \t* aoutx.h (swap_std_reloc_out): Special case 64 bit relocations."
    },
    {
      "sha": "4327b027911ff251c422db28aeef05d527416426",
      "filename": "bfd/elf32-xtensa.c",
      "status": "modified",
      "additions": 15,
      "deletions": 11,
      "changes": 26,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/bfd/elf32-xtensa.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/bfd/elf32-xtensa.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf32-xtensa.c?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -9670,37 +9670,44 @@ relax_section (bfd *abfd, asection *sec, struct bfd_link_info *link_info)\n \t\t  switch (r_type)\n \t\t    {\n \t\t    case R_XTENSA_DIFF8:\n+\t\t      diff_mask = 0x7f;\n \t\t      diff_value =\n \t\t\tbfd_get_signed_8 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_DIFF16:\n+\t\t      diff_mask = 0x7fff;\n \t\t      diff_value =\n \t\t\tbfd_get_signed_16 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_DIFF32:\n+\t\t      diff_mask = 0x7fffffff;\n \t\t      diff_value =\n \t\t\tbfd_get_signed_32 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF8:\n \t\t    case R_XTENSA_NDIFF8:\n+\t\t      diff_mask = 0xff;\n \t\t      diff_value =\n \t\t\tbfd_get_8 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF16:\n \t\t    case R_XTENSA_NDIFF16:\n+\t\t      diff_mask = 0xffff;\n \t\t      diff_value =\n \t\t\tbfd_get_16 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF32:\n \t\t    case R_XTENSA_NDIFF32:\n+\t\t      diff_mask = 0xffffffff;\n \t\t      diff_value =\n \t\t\tbfd_get_32 (abfd, &contents[old_source_offset]);\n \t\t      break;\n \t\t    }\n \n \t\t  if (r_type >= R_XTENSA_NDIFF8\n-\t\t      && r_type <= R_XTENSA_NDIFF32)\n-\t\t    diff_value = -diff_value;\n+\t\t      && r_type <= R_XTENSA_NDIFF32\n+\t\t      && diff_value)\n+\t\t    diff_value |= ~diff_mask;\n \n \t\t  new_end_offset = offset_with_removed_text_map\n \t\t    (&target_relax_info->action_list,\n@@ -9710,43 +9717,40 @@ relax_section (bfd *abfd, asection *sec, struct bfd_link_info *link_info)\n \t\t  switch (r_type)\n \t\t    {\n \t\t    case R_XTENSA_DIFF8:\n-\t\t      diff_mask = 0x7f;\n \t\t      bfd_put_signed_8 (abfd, diff_value,\n \t\t\t\t &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_DIFF16:\n-\t\t      diff_mask = 0x7fff;\n \t\t      bfd_put_signed_16 (abfd, diff_value,\n \t\t\t\t  &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_DIFF32:\n-\t\t      diff_mask = 0x7fffffff;\n \t\t      bfd_put_signed_32 (abfd, diff_value,\n \t\t\t\t  &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF8:\n \t\t    case R_XTENSA_NDIFF8:\n-\t\t      diff_mask = 0xff;\n \t\t      bfd_put_8 (abfd, diff_value,\n \t\t\t\t &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF16:\n \t\t    case R_XTENSA_NDIFF16:\n-\t\t      diff_mask = 0xffff;\n \t\t      bfd_put_16 (abfd, diff_value,\n \t\t\t\t  &contents[old_source_offset]);\n \t\t      break;\n \t\t    case R_XTENSA_PDIFF32:\n \t\t    case R_XTENSA_NDIFF32:\n-\t\t      diff_mask = 0xffffffff;\n \t\t      bfd_put_32 (abfd, diff_value,\n \t\t\t\t  &contents[old_source_offset]);\n \t\t      break;\n \t\t    }\n \n-\t\t  /* Check for overflow. Sign bits must be all zeroes or all ones */\n-\t\t  if ((diff_value & ~diff_mask) != 0 &&\n-\t\t      (diff_value & ~diff_mask) != (-1 & ~diff_mask))\n+\t\t  /* Check for overflow. Sign bits must be all zeroes or\n+\t\t     all ones.  When sign bits are all ones diff_value\n+\t\t     may not be zero.  */\n+\t\t  if (((diff_value & ~diff_mask) != 0\n+\t\t       && (diff_value & ~diff_mask) != ~diff_mask)\n+\t\t      || (diff_value && (bfd_vma) diff_value == ~diff_mask))\n \t\t    {\n \t\t      (*link_info->callbacks->reloc_dangerous)\n \t\t\t(link_info, _(\"overflow after relaxation\"),"
    },
    {
      "sha": "43825ee4bbcd975bb91d6dc848f99a22eab8252d",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -1,3 +1,12 @@\n+2020-04-29  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* testsuite/ld-xtensa/relax-diff1.d: New test definition.\n+\t* testsuite/ld-xtensa/relax-diff1.s: New test source.\n+\t* testsuite/ld-xtensa/relax-ndiff.d: New test definition.\n+\t* testsuite/ld-xtensa/relax-ndiff.s: New test source.\n+\t* testsuite/ld-xtensa/xtensa.exp: (relax-diff1)\n+\t(relax-ndiff): New tests.\n+\n 2020-04-29  Stephen Casner  <casner@acm.org>\n \n \tPR 25829"
    },
    {
      "sha": "900b55bb9c8e40721092c4a48a720af2cefa8831",
      "filename": "ld/testsuite/ld-xtensa/relax-diff1.d",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-diff1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-diff1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/relax-diff1.d?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -0,0 +1,6 @@\n+#as: --text-section-literals\n+#ld:\n+#objdump: -s\n+#...\n+ 410154 06fa0006 fffa.*\n+#..."
    },
    {
      "sha": "6cc8e2b9cef060306d12647cdae17cc201202217",
      "filename": "ld/testsuite/ld-xtensa/relax-diff1.s",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-diff1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-diff1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/relax-diff1.s?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -0,0 +1,18 @@\n+\t.globl\t_start\n+\t.globl\t_ResetVector\n+\t.text\n+_ResetVector:\n+_start:\n+\t.literal_position\n+\tmovi\ta2, 0x12345678\n+\tmovi\ta2, 0x12345678\n+1:\n+\t.space\t250\n+2:\n+\t.space\t65530\n+3:\n+\t.align\t4\n+\t.byte\t1b - 2b\n+\t.byte\t2b - 1b\n+\t.short\t2b - 3b\n+\t.short\t3b - 2b"
    },
    {
      "sha": "2a1cfd3fff3dbaf7401a905aba22ebe253820668",
      "filename": "ld/testsuite/ld-xtensa/relax-ndiff.d",
      "status": "added",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-ndiff.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-ndiff.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/relax-ndiff.d?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -0,0 +1,6 @@\n+#as: --text-section-literals\n+#ld:\n+#objdump: -s\n+#...\n+ 400074 fffffff6 0000000a fff6000a f60a.*\n+#..."
    },
    {
      "sha": "4e4176b129c2d7bede38d0724ebbcbb751c45f6f",
      "filename": "ld/testsuite/ld-xtensa/relax-ndiff.s",
      "status": "added",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-ndiff.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/relax-ndiff.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/relax-ndiff.s?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -0,0 +1,20 @@\n+\t.globl\t_start\n+\t.globl\t_ResetVector\n+\t.text\n+_ResetVector:\n+_start:\n+\t.literal_position\n+\tmovi\ta2, 0x12345678\n+\tmovi\ta2, 0x12345678\n+1:\n+\t.space\t10\n+2:\n+\t.space\t10\n+3:\n+\t.align\t4\n+\t.word\t1b - 2b\n+\t.word\t3b - 2b\n+\t.short\t1b - 2b\n+\t.short\t3b - 2b\n+\t.byte\t1b - 2b\n+\t.byte\t3b - 2b"
    },
    {
      "sha": "5334bc60df344b26dcfc204d750b9fc76f4010fb",
      "filename": "ld/testsuite/ld-xtensa/xtensa.exp",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/xtensa.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d548f47df4d2e3d117d504a4c9977982c78a0556/ld/testsuite/ld-xtensa/xtensa.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-xtensa/xtensa.exp?ref=d548f47df4d2e3d117d504a4c9977982c78a0556",
      "patch": "@@ -27,7 +27,9 @@ run_dump_test \"call_overflow\"\n run_dump_test \"coalesce\"\n run_dump_test \"diff_overflow\"\n run_dump_test \"lcall\"\n+run_dump_test \"relax-diff1\"\n run_dump_test \"relax-loc\"\n+run_dump_test \"relax-ndiff\"\n \n run_dump_test \"relax-static-pie\"\n run_dump_test \"relax-static-local-pie\""
    }
  ]
}