{
  "sha": "a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YTBjMWZmZWRjZjE5ODhiYzEzZmM1YjZkNTdkM2I3NGExN2I2MDI5OQ==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-05-30T16:59:03Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-06-14T14:34:24Z"
    },
    "message": "Only compute realpath when basenames_may_differ is set\n\nA user noted that, when sources are symlinked, gdb annotations will\nprint the real path, rather than the name of the symlink.\n\nIt seems to me that it is better to print the name of the file that\nwas actually used in the build, unless there is some reason not to.\n\nThis patch implements this, with the caveat that it will not work when\nbasenames-may-differ is enabled.  The way this mode is currently\nimplemented, returning the symbolic (not real) path is not possible.\n\nWhile I think it would be good to redo the source file name cache and\nperhaps integrate it with class source_cache, I haven't done so here.\n\nRegression tested on x86-64 Fedora 29.\n\ngdb/ChangeLog\n2019-06-14  Tom Tromey  <tromey@adacore.com>\n\n\t* source.c (find_and_open_source): Respect basenames_may_differ.\n\ngdb/testsuite/ChangeLog\n2019-06-14  Tom Tromey  <tromey@adacore.com>\n\n\t* gdb.base/annotate-symlink.exp: New file.",
    "tree": {
      "sha": "b015514266cd1c0d63e1140d72d146a2d19ab55f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b015514266cd1c0d63e1140d72d146a2d19ab55f"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7c39e397aafaea64812f2611b061bdd50f30dce4",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7c39e397aafaea64812f2611b061bdd50f30dce4",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/7c39e397aafaea64812f2611b061bdd50f30dce4"
    }
  ],
  "stats": {
    "total": 73,
    "additions": 68,
    "deletions": 5
  },
  "files": [
    {
      "sha": "87575c806109d74a30b4e830ef801615c50c60a7",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
      "patch": "@@ -1,3 +1,7 @@\n+2019-06-14  Tom Tromey  <tromey@adacore.com>\n+\n+\t* source.c (find_and_open_source): Respect basenames_may_differ.\n+\n 2019-06-14  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* annotate.c (annotate_breakpoints_invalid): Make use of"
    },
    {
      "sha": "02df15a1ae6c5dd704ec16bc97a8240435b3e1e3",
      "filename": "gdb/source.c",
      "status": "modified",
      "additions": 9,
      "deletions": 5,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/source.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/source.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/source.c?ref=a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
      "patch": "@@ -987,7 +987,10 @@ find_and_open_source (const char *filename,\n       result = gdb_open_cloexec (fullname->get (), OPEN_MODE, 0);\n       if (result >= 0)\n \t{\n-\t  *fullname = gdb_realpath (fullname->get ());\n+\t  if (basenames_may_differ)\n+\t    *fullname = gdb_realpath (fullname->get ());\n+\t  else\n+\t    *fullname = gdb_abspath (fullname->get ());\n \t  return scoped_fd (result);\n \t}\n \n@@ -1031,15 +1034,16 @@ find_and_open_source (const char *filename,\n   if (rewritten_filename != NULL)\n     filename = rewritten_filename.get ();\n \n-  result = openp (path, OPF_SEARCH_IN_PATH | OPF_RETURN_REALPATH, filename,\n-\t\t  OPEN_MODE, fullname);\n+  openp_flags flags = OPF_SEARCH_IN_PATH;\n+  if (basenames_may_differ)\n+    flags |= OPF_RETURN_REALPATH;\n+  result = openp (path, flags, filename, OPEN_MODE, fullname);\n   if (result < 0)\n     {\n       /* Didn't work.  Try using just the basename.  */\n       p = lbasename (filename);\n       if (p != filename)\n-\tresult = openp (path, OPF_SEARCH_IN_PATH | OPF_RETURN_REALPATH, p,\n-\t\t\tOPEN_MODE, fullname);\n+\tresult = openp (path, flags, p, OPEN_MODE, fullname);\n     }\n \n   return scoped_fd (result);"
    },
    {
      "sha": "4d896692648c188656f0cee649e7b68b88148d4a",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
      "patch": "@@ -1,3 +1,7 @@\n+2019-06-14  Tom Tromey  <tromey@adacore.com>\n+\n+\t* gdb.base/annotate-symlink.exp: New file.\n+\n 2019-06-14  Tom Tromey  <tromey@adacore.com>\n \n \t* gdb.ada/set_wstr.exp: Add reassignment test."
    },
    {
      "sha": "6dba2fe823c29d5d5d5c21274ebe410ef8c42293",
      "filename": "gdb/testsuite/gdb.base/annotate-symlink.exp",
      "status": "added",
      "additions": 51,
      "deletions": 0,
      "changes": 51,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/testsuite/gdb.base/annotate-symlink.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299/gdb/testsuite/gdb.base/annotate-symlink.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/annotate-symlink.exp?ref=a0c1ffedcf1988bc13fc5b6d57d3b74a17b60299",
      "patch": "@@ -0,0 +1,51 @@\n+# Copyright (C) 2019 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+standard_testfile realname-expand.c realname-expand-real.c\n+\n+if [is_remote host] {\n+    unsupported \"compiling on a remote host does not support a filename with directory.\"\n+    return 0\n+}\n+\n+set srcdirabs [file join [pwd] $srcdir]\n+set srcfilelink [standard_output_file realname-expand-link.c]\n+\n+remote_exec build \"ln -sf ${srcdirabs}/${subdir}/${srcfile2} $srcfilelink\"\n+\n+if { [file type $srcfilelink] != \"link\" } {\n+    unsupported \"target directory cannot have symbolic links\"\n+    return -1\n+}\n+\n+if { [gdb_compile \"${srcdir}/${subdir}/${srcfile} ${srcfilelink}\" \"${binfile}\" \\\n+\t\t  executable {debug}] != \"\" } {\n+    untested \"failed to compile\"\n+    return -1\n+}\n+\n+clean_restart ${testfile}\n+\n+if {![runto_main]} {\n+    unsupported \"failed to run to main\"\n+    return -1\n+}\n+\n+gdb_breakpoint func message\n+\n+gdb_test_no_output \"set annotate 1\"\n+\n+gdb_test \"continue\" \\\n+    \"Breakpoint .* func .*realname-expand-link.c:$decimal\\r\\n\\032\\032.*realname-expand-link.c:.*\""
    }
  ]
}