{
  "sha": "1e61189d0ab0905178002120eb0a380858ed6dc0",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MWU2MTE4OWQwYWIwOTA1MTc4MDAyMTIwZWIwYTM4MDg1OGVkNmRjMA==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-12-16T17:18:40Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-12-16T17:18:40Z"
    },
    "message": "[gdb/testsuite] Fix shlib compilation with target board unix/-pie/-fPIE\n\nWhen running test-case gdb.base/info-shared.exp with target board\nunix/-pie/-fPIE, we run into:\n...\nspawn -ignore SIGHUP gcc -fno-stack-protector \\\n  outputs/gdb.base/info-shared/info-shared-solib1.c.o \\\n  -fdiagnostics-color=never -fPIC -shared -Wl,-soname,info-shared-solib1.so \\\n  -lm -fPIE -pie -o outputs/gdb.base/info-shared/info-shared-solib1.so^M\nld: Scrt1.o: in function `_start':^M\nstart.S:104: undefined reference to `main'^M\ncollect2: error: ld returned 1 exit status^M\ncompiler exited with status 1\n...\n\nThe intention of the -pie/-fPIE flags is to build and test PIE executables on\nplatforms where that is not the default.  However, the flags clash with the\nflags required to build shared libraries.\n\nFix this by filtering out PIE-related flags out of the multilib_flags settings\nin compile_shared_lib.\n\nTested on x86_64-linux.\n\ngdb/testsuite/ChangeLog:\n\n2020-12-16  Tom de Vries  <tdevries@suse.de>\n\n\t* lib/gdb.exp (gdb_compile_shlib_1): Factor out of ...\n\t(gdb_compile_shlib): ... here.  Filter out PIE-related flags.",
    "tree": {
      "sha": "1e8cd234d0a30f2da93257d1e8d5d932d1cb599f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/1e8cd234d0a30f2da93257d1e8d5d932d1cb599f"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/1e61189d0ab0905178002120eb0a380858ed6dc0",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1e61189d0ab0905178002120eb0a380858ed6dc0",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/1e61189d0ab0905178002120eb0a380858ed6dc0",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1e61189d0ab0905178002120eb0a380858ed6dc0/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "bfbe4b84606cb9b8ac6f51b473b1d351924080aa",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bfbe4b84606cb9b8ac6f51b473b1d351924080aa",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/bfbe4b84606cb9b8ac6f51b473b1d351924080aa"
    }
  ],
  "stats": {
    "total": 44,
    "additions": 43,
    "deletions": 1
  },
  "files": [
    {
      "sha": "51d768c036595208c64f0cf59062a121e505279a",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e61189d0ab0905178002120eb0a380858ed6dc0/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e61189d0ab0905178002120eb0a380858ed6dc0/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=1e61189d0ab0905178002120eb0a380858ed6dc0",
      "patch": "@@ -1,3 +1,8 @@\n+2020-12-16  Tom de Vries  <tdevries@suse.de>\n+\n+\t* lib/gdb.exp (gdb_compile_shlib_1): Factor out of ...\n+\t(gdb_compile_shlib): ... here.  Filter out PIE-related flags.\n+\n 2020-12-16  Luis Machado  <luis.machado@linaro.org>\n \n \t* gdb.arch/aarch64-tagged-pointer.c (main): Add a few more"
    },
    {
      "sha": "e812237d67ae1d5c58a864a42df1c1c6f5fa53d9",
      "filename": "gdb/testsuite/lib/gdb.exp",
      "status": "modified",
      "additions": 38,
      "deletions": 1,
      "changes": 39,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e61189d0ab0905178002120eb0a380858ed6dc0/gdb/testsuite/lib/gdb.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e61189d0ab0905178002120eb0a380858ed6dc0/gdb/testsuite/lib/gdb.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/gdb.exp?ref=1e61189d0ab0905178002120eb0a380858ed6dc0",
      "patch": "@@ -4283,7 +4283,7 @@ proc gdb_compile_pthreads {source dest type options} {\n \n # Build a shared library from SOURCES.\n \n-proc gdb_compile_shlib {sources dest options} {\n+proc gdb_compile_shlib_1 {sources dest options} {\n     set obj_options $options\n \n     set ada 0\n@@ -4416,6 +4416,43 @@ proc gdb_compile_shlib {sources dest options} {\n     return \"\"\n }\n \n+# Build a shared library from SOURCES.  Ignore target boards PIE-related\n+# multilib_flags.\n+\n+proc gdb_compile_shlib {sources dest options} {\n+    global board\n+\n+    # Save multilib_flags.\n+    set board [target_info name]\n+    set save_multilib_flag [board_info $board multilib_flags]\n+\n+    # Ignore PIE-related setting in multilib_flags.\n+    set multilib_flag \"\"\n+    foreach op $save_multilib_flag {\n+\tif { $op == \"-pie\" || $op == \"-no-pie\" \\\n+\t\t || $op == \"-fPIE\" || $op == \"-fno-PIE\"} {\n+\t} else {\n+\t    append multilib_flag \" $op\"\n+\t}\n+    }\n+    unset_board_info \"multilib_flags\"\n+    set_board_info multilib_flags \"$multilib_flag\"\n+    set code [catch {gdb_compile_shlib_1 $sources $dest $options} result]\n+\n+    # Restore multilib_flags.\n+    unset_board_info \"multilib_flags\"\n+    set_board_info multilib_flags $save_multilib_flag\n+\n+    if {$code == 1} {\n+\tglobal errorInfo errorCode\n+\treturn -code error -errorinfo $errorInfo -errorcode $errorCode $result\n+    } elseif {$code > 1} {\n+\treturn -code $code $result\n+    }\n+\n+    return $result\n+}\n+\n # This is just like gdb_compile_shlib, above, except that it tries compiling\n # against several different thread libraries, to see which one this\n # system has."
    }
  ]
}