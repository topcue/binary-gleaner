{
  "sha": "46cbf38dc3a7c6d0e339f95d56590711b06427a1",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NDZjYmYzOGRjM2E3YzZkMGUzMzlmOTVkNTY1OTA3MTFiMDY0MjdhMQ==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-01-24T14:27:27Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-02-08T11:07:24Z"
    },
    "message": "binutils: Add new GNU format mode to `size` utility\n\nThe size tool currently defaults to berkeley format output.  However,\nthis output format has a weird quirk, read-only data is counted\nagainst the text sections, not the data sections.\n\nThe code offers no real explanation for why this is, but I'm reluctant\nto change it for two reasons, first, I'm assuming it probably makes\nsense in some case that I'm not thinking of (maybe a target where\nsections are not marked executable, and so there's no distinction\nbetween read-only data and code), and second, the code has been this\nway for at least 20 years, I worry that changing things now might\ncause more confusion than it solves.\n\nThis commit then introduces a new output format for the size tool,\nthis new format displays the results in a similar manor to the\nberkeley format, but counts read-only data in the data column, and\nonly executable sections are counted in the text column.\n\nGiven that this is a brand new output format I've gone ahead and\nsimplified things a little, while the berkeley format displays the\ntotal twice, once in decimal and once in hex, the new display format\njust displays the total in decimal.  Of course, there's still the\n'--radix' option which can be used to display all the results in\nhexadecimal or octal.\n\nI've called the new format 'gnu', so '--format=gnu' or '-G' are used\nto access it.\n\nbinutils/ChangeLog:\n\n\t* size.c (berkeley_format): Delete.\n\t(enum output_format): New enum.\n\t(selected_output_format): New variable.\n\t(usage): Update to mention GNU format.\n\t(main): Update to extract options, and select format as needed.\n\tHandle GNU format where needed.\n\t(berkeley_sum): Renamed to...\n\t(berkeley_or_gnu_sum): ...this, and updated to handle both formats.\n\t(berkeley_format): Renamed to...\n\t(berkeley_or_gnu_format): ...this, and updated to handle both\n\tformats.\n\t(print_sizes): Handle GNU format.\n\t* doc/binutils.texi (size): Document new GNU format.\n\t* testsuite/binutils-all/size.exp: Add test of extended\n\tfunctionality.\n\t* NEWS: Mention new functionality.",
    "tree": {
      "sha": "361adf72cc40b99e01f6c73e6ce906ec9d52a38e",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/361adf72cc40b99e01f6c73e6ce906ec9d52a38e"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/46cbf38dc3a7c6d0e339f95d56590711b06427a1",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/46cbf38dc3a7c6d0e339f95d56590711b06427a1",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/46cbf38dc3a7c6d0e339f95d56590711b06427a1",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/46cbf38dc3a7c6d0e339f95d56590711b06427a1/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "482f3505d1b62cbcf46ffed54807fad0d91c8f09",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/482f3505d1b62cbcf46ffed54807fad0d91c8f09",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/482f3505d1b62cbcf46ffed54807fad0d91c8f09"
    }
  ],
  "stats": {
    "total": 183,
    "additions": 145,
    "deletions": 38
  },
  "files": [
    {
      "sha": "1ec886bb18a5310f10b0a68a5ed72ae53511df55",
      "filename": "binutils/ChangeLog",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/ChangeLog?ref=46cbf38dc3a7c6d0e339f95d56590711b06427a1",
      "patch": "@@ -1,3 +1,22 @@\n+2019-02-08  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* size.c (berkeley_format): Delete.\n+\t(enum output_format): New enum.\n+\t(selected_output_format): New variable.\n+\t(usage): Update to mention GNU format.\n+\t(main): Update to extract options, and select format as needed.\n+\tHandle GNU format where needed.\n+\t(berkeley_sum): Renamed to...\n+\t(berkeley_or_gnu_sum): ...this, and updated to handle both formats.\n+\t(berkeley_format): Renamed to...\n+\t(berkeley_or_gnu_format): ...this, and updated to handle both\n+\tformats.\n+\t(print_sizes): Handle GNU format.\n+\t* doc/binutils.texi (size): Document new GNU format.\n+\t* testsuite/binutils-all/size.exp: Add test of extended\n+\tfunctionality.\n+\t* NEWS: Mention new functionality.\n+\n 2019-02-08  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* doc/binutils.texi (size): Update example output for Berkeley"
    },
    {
      "sha": "34fd9ec04a4e131c7f89125f5b29c2586d9242b3",
      "filename": "binutils/NEWS",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/NEWS",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/NEWS",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/NEWS?ref=46cbf38dc3a7c6d0e339f95d56590711b06427a1",
      "patch": "@@ -33,6 +33,11 @@ Changes in 2.32:\n   3A1000 processor, The -march=loongson3a is an alias of -march=gs464 for\n   compatibility.\n \n+* The size tool now has a new output format '--format=GNU' or '-G'.  The\n+  results are displayed in a similar manor to the default berkeley layout,\n+  except read-only data is counted in the data column, not the text column.\n+  Additionally the total is only included once.\n+\n Changes in 2.31:\n \n * Add support for disassembling netronome Flow Processor (NFP) firmware files."
    },
    {
      "sha": "01f1e5f56db99e98f6863623e37ab97c93a0244a",
      "filename": "binutils/doc/binutils.texi",
      "status": "modified",
      "additions": 25,
      "deletions": 4,
      "changes": 29,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/doc/binutils.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/doc/binutils.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/doc/binutils.texi?ref=46cbf38dc3a7c6d0e339f95d56590711b06427a1",
      "patch": "@@ -2877,7 +2877,7 @@ ar(1), nm(1), and the Info entries for @file{binutils}.\n \n @smallexample\n @c man begin SYNOPSIS size\n-size [@option{-A}|@option{-B}|@option{--format=}@var{compatibility}]\n+size [@option{-A}|@option{-B}|@option{-G}|@option{--format=}@var{compatibility}]\n      [@option{--help}]\n      [@option{-d}|@option{-o}|@option{-x}|@option{--radix=}@var{number}]\n      [@option{--common}]\n@@ -2906,13 +2906,16 @@ The command-line options have the following meanings:\n @table @env\n @item -A\n @itemx -B\n+@itemx -G\n @itemx --format=@var{compatibility}\n @cindex @command{size} display format\n Using one of these options, you can choose whether the output from @sc{gnu}\n @command{size} resembles output from System V @command{size} (using @option{-A},\n or @option{--format=sysv}), or Berkeley @command{size} (using @option{-B}, or\n @option{--format=berkeley}).  The default is the one-line format similar to\n-Berkeley's.\n+Berkeley's.  Alternatively, you can choose the GNU format output\n+(using @option{-G}, or @option{--format=gnu}), this is similar to\n+Berkeley's output format, but sizes are counted differently.\n @c Bonus for doc-source readers: you can also say --format=strange (or\n @c anything else that starts with 's') for sysv, and --format=boring (or\n @c anything else that starts with 'b') for Berkeley.\n@@ -2926,6 +2929,24 @@ $ size --format=Berkeley ranlib size\n  294880   81920   11888  388688   5ee50 size\n @end smallexample\n \n+The Berkeley style output counts read only data in the @code{text}\n+column, not in the @code{data} column, the @code{dec} and @code{hex}\n+columns both display the sum of the @code{text}, @code{data}, and\n+@code{bss} columns in decimal and hexadecimal respectively.\n+\n+The GNU format counts read only data in the @code{data} column, not\n+the @code{text} column, and only displays the sum of the @code{text},\n+@code{data}, and @code{bss} columns once, in the @code{total} column.\n+The @option{--radix} option can be used to change the number base for\n+all columns.  Here is the same data displayed with GNU conventions:\n+\n+@smallexample\n+$ size --format=GNU ranlib size\n+      text       data        bss      total filename\n+    279880      96920      11592     388392 ranlib\n+    279880      96920      11888     388688 size\n+@end smallexample\n+\n @noindent\n This is the same data, but displayed closer to System V conventions:\n \n@@ -2966,11 +2987,11 @@ octal and hexadecimal if you're using @option{-o}.\n \n @item --common\n Print total size of common symbols in each file.  When using Berkeley\n-format these are included in the bss size.\n+or GNU format these are included in the bss size.\n \n @item -t\n @itemx --totals\n-Show totals of all objects listed (Berkeley format listing mode only).\n+Show totals of all objects listed (Berkeley or GNU format mode only).\n \n @item --target=@var{bfdname}\n @cindex object code format"
    },
    {
      "sha": "479a4648877d9b6c14e36cc719a0bcda83ac26d3",
      "filename": "binutils/size.c",
      "status": "modified",
      "additions": 76,
      "deletions": 34,
      "changes": 110,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/size.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/size.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/size.c?ref=46cbf38dc3a7c6d0e339f95d56590711b06427a1",
      "patch": "@@ -46,8 +46,20 @@ static enum\n   }\n radix = decimal;\n \n-/* 0 means use AT&T-style output.  */\n-static int berkeley_format = BSD_DEFAULT;\n+/* Select the desired output format.  */\n+enum output_format\n+  {\n+   FORMAT_BERKLEY,\n+   FORMAT_SYSV,\n+   FORMAT_GNU\n+  };\n+static enum output_format selected_output_format =\n+#if BSD_DEFAULT\n+  FORMAT_BERKLEY\n+#else\n+  FORMAT_SYSV\n+#endif\n+  ;\n \n static int show_version = 0;\n static int show_help = 0;\n@@ -77,7 +89,7 @@ usage (FILE *stream, int status)\n   fprintf (stream, _(\" Displays the sizes of sections inside binary files\\n\"));\n   fprintf (stream, _(\" If no input file(s) are specified, a.out is assumed\\n\"));\n   fprintf (stream, _(\" The options are:\\n\\\n-  -A|-B     --format={sysv|berkeley}  Select output style (default is %s)\\n\\\n+  -A|-B|-G  --format={sysv|berkeley|gnu}  Select output style (default is %s)\\n\\\n   -o|-d|-x  --radix={8|10|16}         Display numbers in octal, decimal or hex\\n\\\n   -t        --totals                  Display the total sizes (Berkeley only)\\n\\\n             --common                  Display total size for *COM* syms\\n\\\n@@ -141,7 +153,7 @@ main (int argc, char **argv)\n     fatal (_(\"fatal error: libbfd ABI mismatch\"));\n   set_default_bfd_target ();\n \n-  while ((c = getopt_long (argc, argv, \"ABHhVvdfotx\", long_options,\n+  while ((c = getopt_long (argc, argv, \"ABGHhVvdfotx\", long_options,\n \t\t\t   (int *) 0)) != EOF)\n     switch (c)\n       {\n@@ -150,11 +162,15 @@ main (int argc, char **argv)\n \t  {\n \t  case 'B':\n \t  case 'b':\n-\t    berkeley_format = 1;\n+\t    selected_output_format = FORMAT_BERKLEY;\n \t    break;\n \t  case 'S':\n \t  case 's':\n-\t    berkeley_format = 0;\n+\t    selected_output_format = FORMAT_SYSV;\n+\t    break;\n+\t  case 'G':\n+\t  case 'g':\n+\t    selected_output_format = FORMAT_GNU;\n \t    break;\n \t  default:\n \t    non_fatal (_(\"invalid argument to --format: %s\"), optarg);\n@@ -190,10 +206,13 @@ main (int argc, char **argv)\n \tbreak;\n \n       case 'A':\n-\tberkeley_format = 0;\n+\tselected_output_format = FORMAT_SYSV;\n \tbreak;\n       case 'B':\n-\tberkeley_format = 1;\n+\tselected_output_format = FORMAT_BERKLEY;\n+\tbreak;\n+      case 'G':\n+\tselected_output_format = FORMAT_GNU;\n \tbreak;\n       case 'v':\n       case 'V':\n@@ -240,17 +259,25 @@ main (int argc, char **argv)\n     for (; optind < argc;)\n       display_file (argv[optind++]);\n \n-  if (show_totals && berkeley_format)\n+  if (show_totals && (selected_output_format == FORMAT_BERKLEY\n+\t\t      || selected_output_format == FORMAT_GNU))\n     {\n       bfd_size_type total = total_textsize + total_datasize + total_bsssize;\n-\n-      rprint_number (7, total_textsize);\n-      putchar('\\t');\n-      rprint_number (7, total_datasize);\n-      putchar('\\t');\n-      rprint_number (7, total_bsssize);\n-      printf (((radix == octal) ? \"\\t%7lo\\t%7lx\\t\" : \"\\t%7lu\\t%7lx\\t\"),\n-\t      (unsigned long) total, (unsigned long) total);\n+      int col_width = (selected_output_format == FORMAT_BERKLEY) ? 7 : 10;\n+      char sep_char = (selected_output_format == FORMAT_BERKLEY) ? '\\t' : ' ';\n+\n+      rprint_number (col_width, total_textsize);\n+      putchar(sep_char);\n+      rprint_number (col_width, total_datasize);\n+      putchar(sep_char);\n+      rprint_number (col_width, total_bsssize);\n+      putchar(sep_char);\n+      if (selected_output_format == FORMAT_BERKLEY)\n+\tprintf (((radix == octal) ? \"%7lo\\t%7lx\" : \"%7lu\\t%7lx\"),\n+\t\t(unsigned long) total, (unsigned long) total);\n+      else\n+\trprint_number (col_width, total);\n+      putchar(sep_char);\n       fputs (\"(TOTALS)\\n\", stdout);\n     }\n \n@@ -445,8 +472,8 @@ static bfd_size_type datasize;\n static bfd_size_type textsize;\n \n static void\n-berkeley_sum (bfd *abfd ATTRIBUTE_UNUSED, sec_ptr sec,\n-\t      void *ignore ATTRIBUTE_UNUSED)\n+berkeley_or_gnu_sum (bfd *abfd ATTRIBUTE_UNUSED, sec_ptr sec,\n+\t\t     void *ignore ATTRIBUTE_UNUSED)\n {\n   flagword flags;\n   bfd_size_type size;\n@@ -456,7 +483,9 @@ berkeley_sum (bfd *abfd ATTRIBUTE_UNUSED, sec_ptr sec,\n     return;\n \n   size = bfd_get_section_size (sec);\n-  if ((flags & SEC_CODE) != 0 || (flags & SEC_READONLY) != 0)\n+  if ((flags & SEC_CODE) != 0\n+      || (selected_output_format == FORMAT_BERKLEY\n+\t  && (flags & SEC_READONLY) != 0))\n     textsize += size;\n   else if ((flags & SEC_HAS_CONTENTS) != 0)\n     datasize += size;\n@@ -465,21 +494,28 @@ berkeley_sum (bfd *abfd ATTRIBUTE_UNUSED, sec_ptr sec,\n }\n \n static void\n-print_berkeley_format (bfd *abfd)\n+print_berkeley_or_gnu_format (bfd *abfd)\n {\n   static int files_seen = 0;\n   bfd_size_type total;\n+  int col_width = (selected_output_format == FORMAT_BERKLEY) ? 7 : 10;\n+  char sep_char = (selected_output_format == FORMAT_BERKLEY) ? '\\t' : ' ';\n \n   bsssize = 0;\n   datasize = 0;\n   textsize = 0;\n \n-  bfd_map_over_sections (abfd, berkeley_sum, NULL);\n+  bfd_map_over_sections (abfd, berkeley_or_gnu_sum, NULL);\n \n   bsssize += common_size;\n   if (files_seen++ == 0)\n-    puts ((radix == octal) ? \"   text\\t   data\\t    bss\\t    oct\\t    hex\\tfilename\" :\n-\t  \"   text\\t   data\\t    bss\\t    dec\\t    hex\\tfilename\");\n+    {\n+      if (selected_output_format == FORMAT_BERKLEY)\n+\tputs ((radix == octal) ? \"   text\\t   data\\t    bss\\t    oct\\t    hex\\tfilename\" :\n+\t      \"   text\\t   data\\t    bss\\t    dec\\t    hex\\tfilename\");\n+      else\n+\tputs (\"      text       data        bss      total filename\");\n+    }\n \n   total = textsize + datasize + bsssize;\n \n@@ -490,14 +526,20 @@ print_berkeley_format (bfd *abfd)\n       total_bsssize  += bsssize;\n     }\n \n-  rprint_number (7, textsize);\n-  putchar ('\\t');\n-  rprint_number (7, datasize);\n-  putchar ('\\t');\n-  rprint_number (7, bsssize);\n-  printf (((radix == octal) ? \"\\t%7lo\\t%7lx\\t\" : \"\\t%7lu\\t%7lx\\t\"),\n-\t  (unsigned long) total, (unsigned long) total);\n+  rprint_number (col_width, textsize);\n+  putchar (sep_char);\n+  rprint_number (col_width, datasize);\n+  putchar (sep_char);\n+  rprint_number (col_width, bsssize);\n+  putchar (sep_char);\n \n+  if (selected_output_format == FORMAT_BERKLEY)\n+    printf (((radix == octal) ? \"%7lo\\t%7lx\" : \"%7lu\\t%7lx\"),\n+\t    (unsigned long) total, (unsigned long) total);\n+  else\n+    rprint_number (col_width, total);\n+\n+  putchar (sep_char);\n   fputs (bfd_get_filename (abfd), stdout);\n \n   if (abfd->my_archive)\n@@ -611,8 +653,8 @@ print_sizes (bfd *file)\n {\n   if (show_common)\n     calculate_common_size (file);\n-  if (berkeley_format)\n-    print_berkeley_format (file);\n-  else\n+  if (selected_output_format == FORMAT_SYSV)\n     print_sysv_format (file);\n+  else\n+    print_berkeley_or_gnu_format (file);\n }"
    },
    {
      "sha": "a102e15c0dec8cc11aec6f2c170d032ed414a211",
      "filename": "binutils/testsuite/binutils-all/size.exp",
      "status": "modified",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/testsuite/binutils-all/size.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/46cbf38dc3a7c6d0e339f95d56590711b06427a1/binutils/testsuite/binutils-all/size.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/binutils/testsuite/binutils-all/size.exp?ref=46cbf38dc3a7c6d0e339f95d56590711b06427a1",
      "patch": "@@ -79,4 +79,24 @@ if {![binutils_assemble $srcdir/$subdir/bintest.s tmpdir/bintest.o]} then {\n \t    pass \"size -A\"\n \t}\n     }\n+\n+    # Test size -G\n+\n+    set got [binutils_run $SIZE \"$SIZEFLAGS -G $testfile\"]\n+\n+    set want \"($dec)\\[ \t\\]+($dec)\\[ \t\\]+($dec)\\[ \t\\]+($dec)\\[ \t\\]+${testfile}\"\n+\n+    if ![regexp $want $got all text data bss dtot hextot] then {\n+\tfail \"size -G\"\n+    } else {\n+\tif {$text < 8 || $data < 4} then {\n+\t    # The z80-coff port defaults to a \"binary\" like output\n+\t    # file format which does not include a data section.\n+\t    setup_xfail \"z80-*-coff\"\n+\t    fail \"size -G\"\n+\t} else {\n+\t    pass \"size -G\"\n+\t}\n+    }\n+\n }"
    }
  ]
}