{
  "sha": "98a032873232f9685dc7a5d632481c1488b9f1c5",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6OThhMDMyODczMjMyZjk2ODVkYzdhNWQ2MzI0ODFjMTQ4OGI5ZjFjNQ==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-04-08T20:33:35Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-04-08T20:47:58Z"
    },
    "message": "Share Windows thread-suspend and -resume code\n\nThis adds \"suspend\" and \"resume\" methods to windows_thread_info, and\nchanges gdb and gdbserver to share this code.\n\ngdb/ChangeLog\n2020-04-08  Tom Tromey  <tromey@adacore.com>\n\n\t* windows-nat.c (thread_rec): Use windows_thread_info::suspend.\n\t(windows_continue): Use windows_continue::resume.\n\t* nat/windows-nat.h (struct windows_thread_info) <suspend,\n\tresume>: Declare new methods.\n\t* nat/windows-nat.c: New file.\n\t* configure.nat (NATDEPFILES): Add nat/windows-nat.o when needed.\n\ngdbserver/ChangeLog\n2020-04-08  Tom Tromey  <tromey@adacore.com>\n\n\t* win32-low.c (win32_require_context, suspend_one_thread): Use\n\twindows_thread_info::suspend.\n\t(continue_one_thread): Use windows_thread_info::resume.\n\t* configure.srv (srv_tgtobj): Add windows-nat.o when needed.",
    "tree": {
      "sha": "70351fce16a4d7860fa2cc9bb92032363babd7ed",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/70351fce16a4d7860fa2cc9bb92032363babd7ed"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/98a032873232f9685dc7a5d632481c1488b9f1c5",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/98a032873232f9685dc7a5d632481c1488b9f1c5",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/98a032873232f9685dc7a5d632481c1488b9f1c5",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/98a032873232f9685dc7a5d632481c1488b9f1c5/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "7c7411bcabdbe88c6a2f1b9a6090eea0dc50686f",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7c7411bcabdbe88c6a2f1b9a6090eea0dc50686f",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/7c7411bcabdbe88c6a2f1b9a6090eea0dc50686f"
    }
  ],
  "stats": {
    "total": 152,
    "additions": 95,
    "deletions": 57
  },
  "files": [
    {
      "sha": "bf1ef5b9d8c940149e9c14c45188c4fe5f1a5408",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -1,3 +1,12 @@\n+2020-04-08  Tom Tromey  <tromey@adacore.com>\n+\n+\t* windows-nat.c (thread_rec): Use windows_thread_info::suspend.\n+\t(windows_continue): Use windows_continue::resume.\n+\t* nat/windows-nat.h (struct windows_thread_info) <suspend,\n+\tresume>: Declare new methods.\n+\t* nat/windows-nat.c: New file.\n+\t* configure.nat (NATDEPFILES): Add nat/windows-nat.o when needed.\n+\n 2020-04-08  Tom Tromey  <tromey@adacore.com>\n \n \t* windows-nat.c (windows_add_thread, windows_delete_thread)"
    },
    {
      "sha": "6ea25834954c53dd24e063f0f1589eab48069ddb",
      "filename": "gdb/configure.nat",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/configure.nat",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/configure.nat",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/configure.nat?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -75,10 +75,10 @@ case ${gdb_host} in\n \tNATDEPFILES='fork-child.o nat/fork-inferior.o inf-ptrace.o'\n \t;;\n     cygwin*)\n-\tNATDEPFILES='x86-nat.o nat/x86-dregs.o windows-nat.o'\n+\tNATDEPFILES='x86-nat.o nat/x86-dregs.o windows-nat.o nat/windows-nat.o'\n \t;;\n     mingw*)\n-\tNATDEPFILES='x86-nat.o nat/x86-dregs.o windows-nat.o'\n+\tNATDEPFILES='x86-nat.o nat/x86-dregs.o windows-nat.o nat/windows-nat.o'\n \t;;\n     aix)\n \tNATDEPFILES='nat/fork-inferior.o fork-child.o inf-ptrace.o'"
    },
    {
      "sha": "a98ff421e6f36250b68bbcbb6316362b46c1935c",
      "filename": "gdb/nat/windows-nat.c",
      "status": "added",
      "additions": 60,
      "deletions": 0,
      "changes": 60,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/nat/windows-nat.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/nat/windows-nat.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/nat/windows-nat.c?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -0,0 +1,60 @@\n+/* Internal interfaces for the Windows code\n+   Copyright (C) 1995-2019 Free Software Foundation, Inc.\n+\n+   This file is part of GDB.\n+\n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 3 of the License, or\n+   (at your option) any later version.\n+\n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+\n+   You should have received a copy of the GNU General Public License\n+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n+\n+#include \"gdbsupport/common-defs.h\"\n+#include \"nat/windows-nat.h\"\n+\n+void\n+windows_thread_info::suspend ()\n+{\n+  if (suspended != 0)\n+    return;\n+\n+  if (SuspendThread (h) == (DWORD) -1)\n+    {\n+      DWORD err = GetLastError ();\n+\n+      /* We get Access Denied (5) when trying to suspend\n+\t threads that Windows started on behalf of the\n+\t debuggee, usually when those threads are just\n+\t about to exit.\n+\t We can get Invalid Handle (6) if the main thread\n+\t has exited.  */\n+      if (err != ERROR_INVALID_HANDLE && err != ERROR_ACCESS_DENIED)\n+\twarning (_(\"SuspendThread (tid=0x%x) failed. (winerr %u)\"),\n+\t\t (unsigned) tid, (unsigned) err);\n+      suspended = -1;\n+    }\n+  else\n+    suspended = 1;\n+}\n+\n+void\n+windows_thread_info::resume ()\n+{\n+  if (suspended > 0)\n+    {\n+      if (ResumeThread (h) == (DWORD) -1)\n+\t{\n+\t  DWORD err = GetLastError ();\n+\t  warning (_(\"warning: ResumeThread (tid=0x%x) failed. (winerr %u)\"),\n+\t\t   (unsigned) tid, (unsigned) err);\n+\t}\n+    }\n+  suspended = 0;\n+}"
    },
    {
      "sha": "695f801c58fbb7d74521277be2294bc512d1c43d",
      "filename": "gdb/nat/windows-nat.h",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/nat/windows-nat.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/nat/windows-nat.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/nat/windows-nat.h?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -34,6 +34,12 @@ struct windows_thread_info\n \n   DISABLE_COPY_AND_ASSIGN (windows_thread_info);\n \n+  /* Ensure that this thread has been suspended.  */\n+  void suspend ();\n+\n+  /* Resume the thread if it has been suspended.  */\n+  void resume ();\n+\n   /* The Win32 thread identifier.  */\n   DWORD tid;\n "
    },
    {
      "sha": "da3579942f1e17d1aba4b06494577f726a4d5921",
      "filename": "gdb/windows-nat.c",
      "status": "modified",
      "additions": 2,
      "deletions": 24,
      "changes": 26,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/windows-nat.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdb/windows-nat.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/windows-nat.c?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -416,27 +416,7 @@ thread_rec (DWORD id, int get_context)\n \tif (!th->suspended && get_context)\n \t  {\n \t    if (get_context > 0 && id != current_event.dwThreadId)\n-\t      {\n-\t\tif (SuspendThread (th->h) == (DWORD) -1)\n-\t\t  {\n-\t\t    DWORD err = GetLastError ();\n-\n-\t\t    /* We get Access Denied (5) when trying to suspend\n-\t\t       threads that Windows started on behalf of the\n-\t\t       debuggee, usually when those threads are just\n-\t\t       about to exit.\n-\t\t       We can get Invalid Handle (6) if the main thread\n-\t\t       has exited.  */\n-\t\t    if (err != ERROR_INVALID_HANDLE\n-\t\t\t&& err != ERROR_ACCESS_DENIED)\n-\t\t      warning (_(\"SuspendThread (tid=0x%x) failed.\"\n-\t\t\t\t \" (winerr %u)\"),\n-\t\t\t       (unsigned) id, (unsigned) err);\n-\t\t    th->suspended = -1;\n-\t\t  }\n-\t\telse\n-\t\t  th->suspended = 1;\n-\t      }\n+\t      th->suspend ();\n \t    else if (get_context < 0)\n \t      th->suspended = -1;\n \t    th->reload_context = true;\n@@ -1515,9 +1495,7 @@ windows_continue (DWORD continue_status, int id, int killed)\n \t\tth->context.ContextFlags = 0;\n \t      }\n \t  }\n-\tif (th->suspended > 0)\n-\t  (void) ResumeThread (th->h);\n-\tth->suspended = 0;\n+\tth->resume ();\n       }\n \n   res = ContinueDebugEvent (current_event.dwProcessId,"
    },
    {
      "sha": "29d176071ca25283ff316dc0db121d62fbcc40f1",
      "filename": "gdbserver/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdbserver/ChangeLog?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -1,3 +1,10 @@\n+2020-04-08  Tom Tromey  <tromey@adacore.com>\n+\n+\t* win32-low.c (win32_require_context, suspend_one_thread): Use\n+\twindows_thread_info::suspend.\n+\t(continue_one_thread): Use windows_thread_info::resume.\n+\t* configure.srv (srv_tgtobj): Add windows-nat.o when needed.\n+\n 2020-04-08  Tom Tromey  <tromey@adacore.com>\n \n \t* win32-i386-low.c (update_debug_registers)"
    },
    {
      "sha": "7acf229fbefaf0fc779127d41806bb806a51c872",
      "filename": "gdbserver/configure.srv",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/configure.srv",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/configure.srv",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdbserver/configure.srv?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -74,7 +74,7 @@ case \"${gdbserver_host}\" in\n \t\t\tsrv_linux_thread_db=yes\n \t\t\t;;\n   arm*-*-mingw32ce*)\tsrv_regobj=reg-arm.o\n-\t\t\tsrv_tgtobj=\"win32-low.o win32-arm-low.o\"\n+\t\t\tsrv_tgtobj=\"win32-low.o windows-nat.o win32-arm-low.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} wincecompat.o\"\n \t\t\t# hostio_last_error implementation is in win32-low.c\n \t\t\tsrv_hostio_err_objs=\"\"\n@@ -99,6 +99,7 @@ case \"${gdbserver_host}\" in\n   i[34567]86-*-cygwin*)\tsrv_regobj=\"\"\n \t\t\tsrv_tgtobj=\"x86-low.o nat/x86-dregs.o win32-low.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} win32-i386-low.o\"\n+\t\t\tsrv_tgtobj=\"${srv_tgtobj} nat/windows-nat.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} arch/i386.o\"\n \t\t\t;;\n   i[34567]86-*-linux*)\tsrv_tgtobj=\"${srv_tgtobj} arch/i386.o\"\n@@ -126,6 +127,7 @@ case \"${gdbserver_host}\" in\n \t\t\tsrv_regobj=\"\"\n \t\t\tsrv_tgtobj=\"x86-low.o nat/x86-dregs.o win32-low.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} win32-i386-low.o\"\n+\t\t\tsrv_tgtobj=\"${srv_tgtobj} nat/windows-nat.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} arch/i386.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} wincecompat.o\"\n \t\t\t# hostio_last_error implementation is in win32-low.c\n@@ -136,6 +138,7 @@ case \"${gdbserver_host}\" in\n   i[34567]86-*-mingw*)\tsrv_regobj=\"\"\n \t\t\tsrv_tgtobj=\"x86-low.o nat/x86-dregs.o win32-low.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} win32-i386-low.o\"\n+\t\t\tsrv_tgtobj=\"${srv_tgtobj} nat/windows-nat.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} arch/i386.o\"\n \t\t\tsrv_mingw=yes\n \t\t\t;;\n@@ -393,12 +396,14 @@ case \"${gdbserver_host}\" in\n   x86_64-*-mingw*)\tsrv_regobj=\"\"\n \t\t\tsrv_tgtobj=\"x86-low.o nat/x86-dregs.o i387-fp.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} win32-low.o win32-i386-low.o\"\n+\t\t\tsrv_tgtobj=\"${srv_tgtobj} nat/windows-nat.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} arch/amd64.o\"\n \t\t\tsrv_mingw=yes\n \t\t\t;;\n   x86_64-*-cygwin*)\tsrv_regobj=\"\"\n \t\t\tsrv_tgtobj=\"x86-low.o nat/x86-dregs.o i387-fp.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} win32-low.o win32-i386-low.o\"\n+\t\t\tsrv_tgtobj=\"${srv_tgtobj} nat/windows-nat.o\"\n \t\t\tsrv_tgtobj=\"${srv_tgtobj} arch/amd64.o\"\n \t\t\t;;\n "
    },
    {
      "sha": "7cad640878f89dca1b0392c781b514f1e7ba4129",
      "filename": "gdbserver/win32-low.cc",
      "status": "modified",
      "additions": 3,
      "deletions": 30,
      "changes": 33,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/win32-low.cc",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/98a032873232f9685dc7a5d632481c1488b9f1c5/gdbserver/win32-low.cc",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdbserver/win32-low.cc?ref=98a032873232f9685dc7a5d632481c1488b9f1c5",
      "patch": "@@ -171,18 +171,7 @@ win32_require_context (windows_thread_info *th)\n {\n   if (th->context.ContextFlags == 0)\n     {\n-      if (!th->suspended)\n-\t{\n-\t  if (SuspendThread (th->h) == (DWORD) -1)\n-\t    {\n-\t      DWORD err = GetLastError ();\n-\t      OUTMSG ((\"warning: SuspendThread failed in thread_rec, \"\n-\t\t       \"(error %d): %s\\n\", (int) err, strwinerror (err)));\n-\t    }\n-\t  else\n-\t    th->suspended = 1;\n-\t}\n-\n+      th->suspend ();\n       win32_get_thread_context (th);\n     }\n }\n@@ -435,13 +424,7 @@ continue_one_thread (thread_info *thread, int thread_id)\n \t      th->context.ContextFlags = 0;\n \t    }\n \n-\t  if (ResumeThread (th->h) == (DWORD) -1)\n-\t    {\n-\t      DWORD err = GetLastError ();\n-\t      OUTMSG ((\"warning: ResumeThread failed in continue_one_thread, \"\n-\t\t       \"(error %d): %s\\n\", (int) err, strwinerror (err)));\n-\t    }\n-\t  th->suspended = 0;\n+\t  th->resume ();\n \t}\n     }\n }\n@@ -1348,17 +1331,7 @@ suspend_one_thread (thread_info *thread)\n {\n   windows_thread_info *th = (windows_thread_info *) thread_target_data (thread);\n \n-  if (!th->suspended)\n-    {\n-      if (SuspendThread (th->h) == (DWORD) -1)\n-\t{\n-\t  DWORD err = GetLastError ();\n-\t  OUTMSG ((\"warning: SuspendThread failed in suspend_one_thread, \"\n-\t\t   \"(error %d): %s\\n\", (int) err, strwinerror (err)));\n-\t}\n-      else\n-\tth->suspended = 1;\n-    }\n+  th->suspend ();\n }\n \n static void"
    }
  ]
}