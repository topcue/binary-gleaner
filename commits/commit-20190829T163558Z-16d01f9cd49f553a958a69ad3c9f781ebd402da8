{
  "sha": "16d01f9cd49f553a958a69ad3c9f781ebd402da8",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MTZkMDFmOWNkNDlmNTUzYTk1OGE2OWFkM2M5Zjc4MWViZDQwMmRhOA==",
  "commit": {
    "author": {
      "name": "Bernhard Wodok",
      "email": "barto@gmx.net",
      "date": "2019-08-27T15:40:31Z"
    },
    "committer": {
      "name": "Sergio Durigan Junior",
      "email": "sergiodj@redhat.com",
      "date": "2019-08-29T16:35:58Z"
    },
    "message": "Fix PR win32/24284: tcp_auto_retry doesn't work in MinGW\n\nThis was reported by Bernhard Wodok, along with a patch to fix the\nissue.  I adjusted the patch a bit, and I'm submitting the patch on\nhis behalf.\n\nAccording to Bernhard, the issue can be reproduced by doing:\n\n  1. start gdb\n  2. enter 'target remote :2345'\n  3. observe that it throws a \"connection refused\" error immediately\n  instead of waiting and throwing a timeout error\n\nI.e., I believe it can be reproduced by our current tests, which is\nwhy I'm not proposing any extra tests here (well, I don't use nor have\nany Windows system to test this, so...).\n\nThe problem happens because, on ser-tcp:wait_for_connect, we call\n'gdb_select' passing 0 as its first argument, which, when using MinGW,\nends up using the 'gdb_select' version from mingw-hdep.c, and when the\nfirst argument is 0 this means that WaitForMultipleObjects will be\ncalled with 0 as its first argument as well.  According to the MS API\ndocs, this is forbidden:\n\n  https://docs.microsoft.com/en-us/windows/win32/api/synchapi/nf-synchapi-waitformultipleobjects\n\nThe proposed fix is simple: we just call Sleep when N == 0 (and when\nTIMEOUT is non-NULL), and return 0.  It makes sense to me.\n\nBoth Bernhard and Paul Carroll confirmed that the fix works.  I'm\nCc'ing Bernhard in case you have any questions about the patch.\n\nOK?\n\ngdb/ChangeLog:\n2019-08-29  Bernhard Wodok  <barto@gmx.net>\n\t    Sergio Durigan Junior  <sergiodj@redhat.com>\n\n\tPR win32/24284\n\t* mingw-hdep.c (gdb_select): Handle case when 'n' is zero.",
    "tree": {
      "sha": "de1e94b30058734063385c130ae2f143996d7270",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/de1e94b30058734063385c130ae2f143996d7270"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/16d01f9cd49f553a958a69ad3c9f781ebd402da8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/16d01f9cd49f553a958a69ad3c9f781ebd402da8",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/16d01f9cd49f553a958a69ad3c9f781ebd402da8",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/16d01f9cd49f553a958a69ad3c9f781ebd402da8/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "8077c50dbb74ee63c038dbd3527c372dbe180fbb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8077c50dbb74ee63c038dbd3527c372dbe180fbb",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/8077c50dbb74ee63c038dbd3527c372dbe180fbb"
    }
  ],
  "stats": {
    "total": 17,
    "additions": 17,
    "deletions": 0
  },
  "files": [
    {
      "sha": "fba2f4a995ec12171b5f5855a6287e91f8f683b7",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/16d01f9cd49f553a958a69ad3c9f781ebd402da8/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/16d01f9cd49f553a958a69ad3c9f781ebd402da8/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=16d01f9cd49f553a958a69ad3c9f781ebd402da8",
      "patch": "@@ -1,3 +1,9 @@\n+2019-08-29  Bernhard Wodok  <barto@gmx.net>\n+\t    Sergio Durigan Junior  <sergiodj@redhat.com>\n+\n+\tPR win32/24284\n+\t* mingw-hdep.c (gdb_select): Handle case when 'n' is zero.\n+\n 2019-08-28  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* symtab.c (search_symbols): Don't include MODULE_DOMAIN symbols"
    },
    {
      "sha": "0af1b39acdcc9987a73669f9116d05474d843fc9",
      "filename": "gdb/mingw-hdep.c",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/16d01f9cd49f553a958a69ad3c9f781ebd402da8/gdb/mingw-hdep.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/16d01f9cd49f553a958a69ad3c9f781ebd402da8/gdb/mingw-hdep.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/mingw-hdep.c?ref=16d01f9cd49f553a958a69ad3c9f781ebd402da8",
      "patch": "@@ -64,6 +64,17 @@ gdb_select (int n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds,\n   int num_ready;\n   size_t indx;\n \n+  if (n == 0)\n+    {\n+      /* The MS API says that the first argument to\n+\t WaitForMultipleObjects cannot be zero.  That's why we just\n+\t use a regular Sleep here.  */\n+      if (timeout != NULL)\n+\tSleep (timeout->tv_sec * 1000 + timeout->tv_usec / 1000);\n+\n+      return 0;\n+    }\n+\n   num_ready = 0;\n   num_handles = 0;\n   num_scbs = 0;"
    }
  ]
}