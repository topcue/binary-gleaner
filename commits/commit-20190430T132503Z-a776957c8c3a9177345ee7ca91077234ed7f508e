{
  "sha": "a776957c8c3a9177345ee7ca91077234ed7f508e",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YTc3Njk1N2M4YzNhOTE3NzM0NWVlN2NhOTEwNzcyMzRlZDdmNTA4ZQ==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-04-22T17:46:47Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-04-30T13:25:03Z"
    },
    "message": "Fix crash in dwarf2read.c with template parameters\n\nPR c++/24470 concerns a crash in dwarf2read.c that occurs with a\nparticular test case.\n\nThe issue turns out to be that process_structure_scope will pass NULL\nto symbol_symtab.  This happens because new_symbol decided not to\ncreate a symbol for the particular DIE.\n\nThis patch fixes the problem by finding another reasonably-appropriate\nsymtab to use instead; issuing a complaint if one cannot be found for\nsome reason.\n\nAs mentioned in the bug, I think there are other bugs here.  For\nexample, when using \"ptype\" on the \"l\" object in the test case, I\nthink I would expect to see the template parameter.  I didn't research\nthis too closely, since it seemed more important to fix the crash.\n\nTested on x86-64 Fedora 29.\n\nI'd like to check this in to the 8.3 branch as well.\n\n2019-04-30  Tom Tromey  <tromey@adacore.com>\n\n\tPR c++/24470:\n\t* dwarf2read.c (process_structure_scope): Handle case where type\n\thas template parameters but no symbol was created.\n\ngdb/testsuite/ChangeLog\n2019-04-30  Tom Tromey  <tromey@adacore.com>\n\n\tPR c++/24470:\n\t* gdb.cp/temargs.cc: Add test code from PR.",
    "tree": {
      "sha": "2673729d55c956fc2059b1c71470104b6fbc98e0",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/2673729d55c956fc2059b1c71470104b6fbc98e0"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/a776957c8c3a9177345ee7ca91077234ed7f508e",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a776957c8c3a9177345ee7ca91077234ed7f508e",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/a776957c8c3a9177345ee7ca91077234ed7f508e",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a776957c8c3a9177345ee7ca91077234ed7f508e/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "066f4018ae7822d81cb6747fd9494e5dd63bfecf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/066f4018ae7822d81cb6747fd9494e5dd63bfecf",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/066f4018ae7822d81cb6747fd9494e5dd63bfecf"
    }
  ],
  "stats": {
    "total": 69,
    "additions": 62,
    "deletions": 7
  },
  "files": [
    {
      "sha": "1e2f0eb4669581d385980c896118adde535cc726",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=a776957c8c3a9177345ee7ca91077234ed7f508e",
      "patch": "@@ -1,3 +1,9 @@\n+2019-04-30  Tom Tromey  <tromey@adacore.com>\n+\n+\tPR c++/24470:\n+\t* dwarf2read.c (process_structure_scope): Handle case where type\n+\thas template parameters but no symbol was created.\n+\n 2019-04-30  Andrew Burgess  <andrew.burgess@embecosm.com>\n \t    Chris January  <chris.january@arm.com>\n "
    },
    {
      "sha": "751c59c33c062881f780896b26041070479d2f52",
      "filename": "gdb/dwarf2read.c",
      "status": "modified",
      "additions": 28,
      "deletions": 7,
      "changes": 35,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/dwarf2read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/dwarf2read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2read.c?ref=a776957c8c3a9177345ee7ca91077234ed7f508e",
      "patch": "@@ -16212,13 +16212,34 @@ process_structure_scope (struct die_info *die, struct dwarf2_cu *cu)\n \n       if (has_template_parameters)\n \t{\n-\t  /* Make sure that the symtab is set on the new symbols.\n-\t     Even though they don't appear in this symtab directly,\n-\t     other parts of gdb assume that symbols do, and this is\n-\t     reasonably true.  */\n-\t  for (int i = 0; i < TYPE_N_TEMPLATE_ARGUMENTS (type); ++i)\n-\t    symbol_set_symtab (TYPE_TEMPLATE_ARGUMENT (type, i),\n-\t\t\t       symbol_symtab (sym));\n+\t  struct symtab *symtab;\n+\t  if (sym != nullptr)\n+\t    symtab = symbol_symtab (sym);\n+\t  else if (cu->line_header != nullptr)\n+\t    {\n+\t      /* Any related symtab will do.  */\n+\t      symtab\n+\t\t= cu->line_header->file_name_at (file_name_index (1))->symtab;\n+\t    }\n+\t  else\n+\t    {\n+\t      symtab = nullptr;\n+\t      complaint (_(\"could not find suitable \"\n+\t\t\t   \"symtab for template parameter\"\n+\t\t\t   \" - DIE at %s [in module %s]\"),\n+\t\t\t sect_offset_str (die->sect_off),\n+\t\t\t objfile_name (objfile));\n+\t    }\n+\n+\t  if (symtab != nullptr)\n+\t    {\n+\t      /* Make sure that the symtab is set on the new symbols.\n+\t\t Even though they don't appear in this symtab directly,\n+\t\t other parts of gdb assume that symbols do, and this is\n+\t\t reasonably true.  */\n+\t      for (int i = 0; i < TYPE_N_TEMPLATE_ARGUMENTS (type); ++i)\n+\t\tsymbol_set_symtab (TYPE_TEMPLATE_ARGUMENT (type, i), symtab);\n+\t    }\n \t}\n     }\n }"
    },
    {
      "sha": "41aae07919fff4ec61ff0bed4e20e2c8b9c072ed",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=a776957c8c3a9177345ee7ca91077234ed7f508e",
      "patch": "@@ -1,3 +1,8 @@\n+2019-04-30  Tom Tromey  <tromey@adacore.com>\n+\n+\tPR c++/24470:\n+\t* gdb.cp/temargs.cc: Add test code from PR.\n+\n 2019-04-30  Andrew Burgess  <andrew.burgess@embecosm.com>\n \n \t* gdb.fortran/vla-datatypes.exp: Update expected results."
    },
    {
      "sha": "d2a85f95340b56d8620616dc55144bdf6d40f15f",
      "filename": "gdb/testsuite/gdb.cp/temargs.cc",
      "status": "modified",
      "additions": 23,
      "deletions": 0,
      "changes": 23,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/testsuite/gdb.cp/temargs.cc",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a776957c8c3a9177345ee7ca91077234ed7f508e/gdb/testsuite/gdb.cp/temargs.cc",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.cp/temargs.cc?ref=a776957c8c3a9177345ee7ca91077234ed7f508e",
      "patch": "@@ -80,6 +80,29 @@ struct K3\n   }\n };\n \n+namespace pr24470\n+{\n+// From PR c++/24470\n+// This caused a gdb crash during startup.\n+\n+template <int a> struct b {};\n+template <typename, typename> struct c {\n+  template <long d> using e = b<d>;\n+  void k(e<0>);\n+};\n+template <typename, template <typename, typename> class, unsigned long...>\n+struct m;\n+template <typename g, template <typename, typename> class h, unsigned long i>\n+struct m<g, h, i> {\n+  using j = b<i>;\n+};\n+struct n {\n+  template <typename g> using f = typename m<g, c, 0>::j;\n+};\n+\n+n::f<int> l;\n+}\n+\n int main ()\n {\n   Base<double, 23, &a_global, &S::f> base;"
    }
  ]
}