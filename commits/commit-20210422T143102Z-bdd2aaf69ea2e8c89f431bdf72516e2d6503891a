{
  "sha": "bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YmRkMmFhZjY5ZWEyZThjODlmNDMxYmRmNzI1MTZlMmQ2NTAzODkxYQ==",
  "commit": {
    "author": {
      "name": "Cl?ment Chigot",
      "email": "clement.chigot@atos.net",
      "date": "2021-04-22T14:31:02Z"
    },
    "committer": {
      "name": "Nick Clifton",
      "email": "nickc@redhat.com",
      "date": "2021-04-22T14:31:02Z"
    },
    "message": "fix string table generation for XCOFF64 .debug section\n\nbfd\t* hash.c (struct bfd_strtab_hash): Remove xcoff field.\n\tAdd length_field_size field.\n\t(_bfd_stringtab_init): Change prototype.\n\tAdapt to new length_field_size.\n\t(_bfd_xcoff_stringtab_init): Likewise.\n\t(_bfd_stringtab_add): Likewise.\n\t(_bfd_stringtab_emit): Likewise.\n\t* libbfd-in.h (_bfd_xcoff_stringtab_init):\n\tChange prototype.\n\t* libbfd.h: Regenerate.\n\t* xcofflink.c (_bfd_xcoff_bfd_link_hash_table_create):\n\tCall _bfd_xcoff_stringtab_init with isxcoff64 value.",
    "tree": {
      "sha": "e375a94197aab402fcd6aa091a7b0aff7cf304a5",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e375a94197aab402fcd6aa091a7b0aff7cf304a5"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/comments",
  "author": {
    "login": "Helflym",
    "id": 23002587,
    "node_id": "MDQ6VXNlcjIzMDAyNTg3",
    "avatar_url": "https://avatars.githubusercontent.com/u/23002587?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Helflym",
    "html_url": "https://github.com/Helflym",
    "followers_url": "https://api.github.com/users/Helflym/followers",
    "following_url": "https://api.github.com/users/Helflym/following{/other_user}",
    "gists_url": "https://api.github.com/users/Helflym/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Helflym/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Helflym/subscriptions",
    "organizations_url": "https://api.github.com/users/Helflym/orgs",
    "repos_url": "https://api.github.com/users/Helflym/repos",
    "events_url": "https://api.github.com/users/Helflym/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Helflym/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nickclifton",
    "id": 31441682,
    "node_id": "MDQ6VXNlcjMxNDQxNjgy",
    "avatar_url": "https://avatars.githubusercontent.com/u/31441682?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickclifton",
    "html_url": "https://github.com/nickclifton",
    "followers_url": "https://api.github.com/users/nickclifton/followers",
    "following_url": "https://api.github.com/users/nickclifton/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickclifton/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickclifton/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickclifton/subscriptions",
    "organizations_url": "https://api.github.com/users/nickclifton/orgs",
    "repos_url": "https://api.github.com/users/nickclifton/repos",
    "events_url": "https://api.github.com/users/nickclifton/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickclifton/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "22f80c0f77be6304b9632827d8161e28cb4a195a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/22f80c0f77be6304b9632827d8161e28cb4a195a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/22f80c0f77be6304b9632827d8161e28cb4a195a"
    }
  ],
  "stats": {
    "total": 58,
    "additions": 40,
    "deletions": 18
  },
  "files": [
    {
      "sha": "6361656fac167daa6d7d649c327e83e53ce2b4f8",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
      "patch": "@@ -1,3 +1,18 @@\n+2021-04-22  Cl\u00e9ment Chigot  <clement.chigot@atos.net>\n+\n+\t* hash.c (struct bfd_strtab_hash): Remove xcoff field.\n+\tAdd length_field_size field.\n+\t(_bfd_stringtab_init): Change prototype.\n+\tAdapt to new length_field_size.\n+\t(_bfd_xcoff_stringtab_init): Likewise.\n+\t(_bfd_stringtab_add): Likewise.\n+\t(_bfd_stringtab_emit): Likewise.\n+\t* libbfd-in.h (_bfd_xcoff_stringtab_init):\n+\tChange prototype.\n+\t* libbfd.h: Regenerate.\n+\t* xcofflink.c (_bfd_xcoff_bfd_link_hash_table_create):\n+\tCall _bfd_xcoff_stringtab_init with isxcoff64 value.\n+\n 2021-04-22  Cl\u00e9ment Chigot  <clement.chigot@atos.net>\n \n \t* coff-rs6000.c (_bfd_xcoff_swap_aux_in): Add errors for"
    },
    {
      "sha": "06969fecd21bc5008f42c905827eed44e9e5f60a",
      "filename": "bfd/hash.c",
      "status": "modified",
      "additions": 19,
      "deletions": 15,
      "changes": 34,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/hash.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/hash.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/hash.c?ref=bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
      "patch": "@@ -713,11 +713,12 @@ struct bfd_strtab_hash\n   struct strtab_hash_entry *first;\n   /* Last string in strtab.  */\n   struct strtab_hash_entry *last;\n-  /* Whether to precede strings with a two byte length, as in the\n-     XCOFF .debug section.  */\n-  bool xcoff;\n+  /* Whether to precede strings with a two or four byte length,\n+     as in the XCOFF .debug section.  */\n+  char length_field_size;\n };\n \n+\n /* Routine to create an entry in a strtab.  */\n \n static struct bfd_hash_entry *\n@@ -777,7 +778,7 @@ _bfd_stringtab_init (void)\n   table->size = 0;\n   table->first = NULL;\n   table->last = NULL;\n-  table->xcoff = false;\n+  table->length_field_size = 0;\n \n   return table;\n }\n@@ -787,13 +788,13 @@ _bfd_stringtab_init (void)\n    string.  */\n \n struct bfd_strtab_hash *\n-_bfd_xcoff_stringtab_init (void)\n+_bfd_xcoff_stringtab_init (bool isxcoff64)\n {\n   struct bfd_strtab_hash *ret;\n \n   ret = _bfd_stringtab_init ();\n   if (ret != NULL)\n-    ret->xcoff = true;\n+    ret->length_field_size = isxcoff64 ? 4 : 2;\n   return ret;\n }\n \n@@ -852,11 +853,8 @@ _bfd_stringtab_add (struct bfd_strtab_hash *tab,\n     {\n       entry->index = tab->size;\n       tab->size += strlen (str) + 1;\n-      if (tab->xcoff)\n-\t{\n-\t  entry->index += 2;\n-\t  tab->size += 2;\n-\t}\n+      entry->index += tab->length_field_size;\n+      tab->size += tab->length_field_size;\n       if (tab->first == NULL)\n \ttab->first = entry;\n       else\n@@ -881,11 +879,8 @@ _bfd_stringtab_size (struct bfd_strtab_hash *tab)\n bool\n _bfd_stringtab_emit (bfd *abfd, struct bfd_strtab_hash *tab)\n {\n-  bool xcoff;\n   struct strtab_hash_entry *entry;\n \n-  xcoff = tab->xcoff;\n-\n   for (entry = tab->first; entry != NULL; entry = entry->next)\n     {\n       const char *str;\n@@ -894,7 +889,16 @@ _bfd_stringtab_emit (bfd *abfd, struct bfd_strtab_hash *tab)\n       str = entry->root.string;\n       len = strlen (str) + 1;\n \n-      if (xcoff)\n+      if (tab->length_field_size == 4)\n+\t{\n+\t  bfd_byte buf[4];\n+\n+\t  /* The output length includes the null byte.  */\n+\t  bfd_put_32 (abfd, (bfd_vma) len, buf);\n+\t  if (bfd_bwrite ((void *) buf, (bfd_size_type) 4, abfd) != 4)\n+\t    return false;\n+\t}\n+      else if (tab->length_field_size == 2)\n \t{\n \t  bfd_byte buf[2];\n "
    },
    {
      "sha": "1ad1af8c002e4e239cb3008461c6eacf3073bbb8",
      "filename": "bfd/libbfd-in.h",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/libbfd-in.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/libbfd-in.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/libbfd-in.h?ref=bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
      "patch": "@@ -761,7 +761,7 @@ extern struct bfd_strtab_hash *_bfd_stringtab_init\n \n /* Create an XCOFF .debug section style string table.  */\n extern struct bfd_strtab_hash *_bfd_xcoff_stringtab_init\n-  (void) ATTRIBUTE_HIDDEN;\n+  (bool isxcoff64) ATTRIBUTE_HIDDEN;\n \n /* Free a string table.  */\n extern void _bfd_stringtab_free"
    },
    {
      "sha": "fba29998900214b9b787d9d67871d80c5f8ed3f7",
      "filename": "bfd/libbfd.h",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/libbfd.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/libbfd.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/libbfd.h?ref=bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
      "patch": "@@ -766,7 +766,7 @@ extern struct bfd_strtab_hash *_bfd_stringtab_init\n \n /* Create an XCOFF .debug section style string table.  */\n extern struct bfd_strtab_hash *_bfd_xcoff_stringtab_init\n-  (void) ATTRIBUTE_HIDDEN;\n+  (bool isxcoff64) ATTRIBUTE_HIDDEN;\n \n /* Free a string table.  */\n extern void _bfd_stringtab_free"
    },
    {
      "sha": "e18efd4381a8d15e03a0d9b7f6de9b6434c0f6f2",
      "filename": "bfd/xcofflink.c",
      "status": "modified",
      "additions": 4,
      "deletions": 1,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/xcofflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/bdd2aaf69ea2e8c89f431bdf72516e2d6503891a/bfd/xcofflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/xcofflink.c?ref=bdd2aaf69ea2e8c89f431bdf72516e2d6503891a",
      "patch": "@@ -592,6 +592,7 @@ struct bfd_link_hash_table *\n _bfd_xcoff_bfd_link_hash_table_create (bfd *abfd)\n {\n   struct xcoff_link_hash_table *ret;\n+  bool isxcoff64 = false;\n   size_t amt = sizeof (* ret);\n \n   ret = bfd_zmalloc (amt);\n@@ -604,7 +605,9 @@ _bfd_xcoff_bfd_link_hash_table_create (bfd *abfd)\n       return NULL;\n     }\n \n-  ret->debug_strtab = _bfd_xcoff_stringtab_init ();\n+  isxcoff64 = bfd_coff_debug_string_prefix_length (abfd) == 4;\n+\n+  ret->debug_strtab = _bfd_xcoff_stringtab_init (isxcoff64);\n   ret->archive_info = htab_create (37, xcoff_archive_info_hash,\n \t\t\t\t   xcoff_archive_info_eq, NULL);\n   if (!ret->debug_strtab || !ret->archive_info)"
    }
  ]
}