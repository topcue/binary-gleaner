{
  "sha": "8be5def63b0f2036312483dac8dd5a4fa2e91009",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6OGJlNWRlZjYzYjBmMjAzNjMxMjQ4M2RhYzhkZDVhNGZhMmU5MTAwOQ==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-04-02T14:03:08Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-04-02T14:12:45Z"
    },
    "message": "ld: Add NOCF_PROTECTION_CFLAGS to turn off -fcf-protection\n\nGCC in Ubuntu 20.04 enables -fcf-protection by default, which leads to\n\nFAIL: S-records\nFAIL: S-records with constructors\nFAIL: Build plt-main with -z bndplt\nFAIL: Build plt-main with PIE and -z bndplt\nFAIL: Build plt-main with -z bndplt -z now\nFAIL: Build plt-main with PIE and -z bndplt -z now\n\non x86-64.  Add NOCF_PROTECTION_CFLAGS to pass -fcf-protection=none on\nthese tests.\n\n\t* testsuite/config/default.exp (NOCF_PROTECTION_CFLAGS): New.\n\tSet to \"-fcf-protection=none\" if target compiler supports it.\n\t* testsuite/ld-srec/srec.exp: Add $NOCF_PROTECTION_CFLAGS to\n\tCC and CXX.\n\t* testsuite/ld-x86-64/x86-64.exp: Add $NOCF_PROTECTION_CFLAGS\n\tto PLT BND tests.",
    "tree": {
      "sha": "e9944941e51e9b0c3f781b0bdd91ffb12d16706a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e9944941e51e9b0c3f781b0bdd91ffb12d16706a"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/8be5def63b0f2036312483dac8dd5a4fa2e91009",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8be5def63b0f2036312483dac8dd5a4fa2e91009",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/8be5def63b0f2036312483dac8dd5a4fa2e91009",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8be5def63b0f2036312483dac8dd5a4fa2e91009/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4d095f5b5e57584133f85df42da2123e20834aec",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4d095f5b5e57584133f85df42da2123e20834aec",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4d095f5b5e57584133f85df42da2123e20834aec"
    }
  ],
  "stats": {
    "total": 65,
    "additions": 57,
    "deletions": 8
  },
  "files": [
    {
      "sha": "2720a54c57d750cee7735933b15a6ce2b9ea0970",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=8be5def63b0f2036312483dac8dd5a4fa2e91009",
      "patch": "@@ -1,3 +1,12 @@\n+2020-04-02  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\t* testsuite/config/default.exp (NOCF_PROTECTION_CFLAGS): New.\n+\tSet to \"-fcf-protection=none\" if target compiler supports it.\n+\t* testsuite/ld-srec/srec.exp: Add $NOCF_PROTECTION_CFLAGS to\n+\tCC and CXX.\n+\t* testsuite/ld-x86-64/x86-64.exp: Add $NOCF_PROTECTION_CFLAGS\n+\tto PLT BND tests.\n+\n 2020-04-02  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* testsuite/ld-elf/linux-x86.exp (check_pr25749a): Compile with"
    },
    {
      "sha": "7998f4efb851e51d065cd6a52f8f395751fb6777",
      "filename": "ld/testsuite/config/default.exp",
      "status": "modified",
      "additions": 38,
      "deletions": 0,
      "changes": 38,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/config/default.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/config/default.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/config/default.exp?ref=8be5def63b0f2036312483dac8dd5a4fa2e91009",
      "patch": "@@ -344,6 +344,44 @@ if { ![info exists NOPIE_CFLAGS] || ![info exists NOPIE_LDFLAGS] } then {\n     }\n }\n \n+# Set NOCF_PROTECTION_CFLAGS to \"-fcf-protection=none\" if target compiler\n+# supports it.\n+\n+if { ![info exists NOCF_PROTECTION_CFLAGS] } then {\n+    if { [check_compiler_available] } {\n+\t# Check if gcc supports -fcf-protection=none.\n+\tset flags \"\"\n+\tif [board_info [target_info name] exists cflags] {\n+\t    append flags \" [board_info [target_info name] cflags]\"\n+\t}\n+\tif [board_info [target_info name] exists ldflags] {\n+\t    append flags \" [board_info [target_info name] ldflags]\"\n+\t}\n+\n+\tset basename \"tmpdir/nopie[pid]\"\n+\tset src ${basename}.c\n+\tset output ${basename}\n+\tset f [open $src \"w\"]\n+\tputs $f \"int main (void) { return 0; }\"\n+\tclose $f\n+\tif [is_remote host] {\n+\t    set src [remote_download host $src]\n+\t}\n+\tset nopie_available [run_host_cmd_yesno \"$CC\" \"$flags -fcf-protection=none $src -o $output\"]\n+\tremote_file host delete $src\n+\tremote_file host delete $output\n+\tfile delete $src\n+\n+\tif { $nopie_available == 1 } then {\n+\t    set NOCF_PROTECTION_CFLAGS \"-fcf-protection=none\"\n+\t} else {\n+\t    set NOCF_PROTECTION_CFLAGS \"\"\n+\t}\n+    } else {\n+\tset NOCF_PROTECTION_CFLAGS \"\"\n+    }\n+}\n+\n # Set GNU2_CFLAGS to \"-mtls-dialect=gnu2\" if target compiler supports it.\n \n if { ![info exists GNU2_CFLAGS] } then {"
    },
    {
      "sha": "da230fbca1705e3b7d5ceb3c37077324810cc8fd",
      "filename": "ld/testsuite/ld-srec/srec.exp",
      "status": "modified",
      "additions": 4,
      "deletions": 4,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/ld-srec/srec.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/ld-srec/srec.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-srec/srec.exp?ref=8be5def63b0f2036312483dac8dd5a4fa2e91009",
      "patch": "@@ -350,12 +350,12 @@ if { ![check_compiler_available] } {\n \n # Pass -fplt to CC and CXX since -fno-plt doesn't work with S-records\n # tests. Also add $NOPIE_CFLAGS and $NOPIE_LDFLAGS if PIE doesn't work\n-# with S-records.\n-global PLT_CFLAGS NOPIE_CFLAGS NOPIE_LDFLAGS\n+# with S-records.  Also add $NOCF_PROTECTION_CFLAGS for S-records.\n+global PLT_CFLAGS NOPIE_CFLAGS NOPIE_LDFLAGS NOCF_PROTECTION_CFLAGS\n set old_CC \"$CC\"\n-set CC \"$CC $PLT_CFLAGS $NOPIE_CFLAGS $NOPIE_LDFLAGS\"\n+set CC \"$CC $PLT_CFLAGS $NOPIE_CFLAGS $NOPIE_LDFLAGS $NOCF_PROTECTION_CFLAGS\"\n set old_CXX \"$CXX\"\n-set CXX \"$CXX $PLT_CFLAGS $NOPIE_CFLAGS $NOPIE_LDFLAGS\"\n+set CXX \"$CXX $PLT_CFLAGS $NOPIE_CFLAGS $NOPIE_LDFLAGS $NOCF_PROTECTION_CFLAGS\"\n \n # S-records can't handle .note.gnu.property sections.\n if { [is_elf_format] \\"
    },
    {
      "sha": "d2e5ac720594e2b7883170c0a67af5f94d4b1098",
      "filename": "ld/testsuite/ld-x86-64/x86-64.exp",
      "status": "modified",
      "additions": 6,
      "deletions": 4,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/ld-x86-64/x86-64.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8be5def63b0f2036312483dac8dd5a4fa2e91009/ld/testsuite/ld-x86-64/x86-64.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-x86-64/x86-64.exp?ref=8be5def63b0f2036312483dac8dd5a4fa2e91009",
      "patch": "@@ -740,6 +740,8 @@ proc undefined_weak {cflags ldflags} {\n global PLT_CFLAGS\n # Add $NOPIE_CFLAGS and $NOPIE_LDFLAGS if non-PIE is required.\n global NOPIE_CFLAGS NOPIE_LDFLAGS\n+# Add $NOCF_PROTECTION_CFLAGS if -fcf-protection=none is required.\n+global NOCF_PROTECTION_CFLAGS\n \n # Must be native with the C compiler\n if { [isnative] && [check_compiler_available] } {\n@@ -1819,7 +1821,7 @@ if { [isnative] && [check_compiler_available] } {\n \t\t\"tmpdir/plt-main1.o tmpdir/plt-main2.o tmpdir/plt-main3.o \\\n \t\t tmpdir/plt-main4.o tmpdir/libplt-lib.so -z bndplt \\\n \t\t -z noseparate-code -z max-page-size=0x200000\" \\\n-\t\t\"-Wa,-mx86-used-note=yes\" \\\n+\t\t\"-Wa,-mx86-used-note=yes $NOCF_PROTECTION_CFLAGS\" \\\n \t\t{ plt-main5.c } \\\n \t\t{{objdump {-drw} plt-main-bnd.dd}} \\\n \t\t\"plt-main-bnd\" \\\n@@ -1829,7 +1831,7 @@ if { [isnative] && [check_compiler_available] } {\n \t\t\"tmpdir/plt-main1.o tmpdir/plt-main2.o tmpdir/plt-main3.o \\\n \t\t tmpdir/plt-main4.o tmpdir/libplt-lib.so -z bndplt -pie \\\n \t\t -z noseparate-code -z max-page-size=0x200000\" \\\n-\t\t\"-fPIC -Wa,-mx86-used-note=yes\" \\\n+\t\t\"-fPIC -Wa,-mx86-used-note=yes $NOCF_PROTECTION_CFLAGS\" \\\n \t\t{ plt-main5.c } \\\n \t\t{{objdump {-drw} plt-main-bnd.dd}} \\\n \t\t\"plt-main-pie-bnd\" \\\n@@ -1839,7 +1841,7 @@ if { [isnative] && [check_compiler_available] } {\n \t\t\"tmpdir/plt-main1.o tmpdir/plt-main2.o tmpdir/plt-main3.o \\\n \t\t tmpdir/plt-main4.o tmpdir/libplt-lib.so -z bndplt -z now \\\n \t\t -z noseparate-code -z max-page-size=0x200000\" \\\n-\t\t\"-Wa,-mx86-used-note=yes\" \\\n+\t\t\"-Wa,-mx86-used-note=yes $NOCF_PROTECTION_CFLAGS\" \\\n \t\t{ plt-main5.c } \\\n \t\t{{readelf {-SW} plt-main-bnd-now.rd} {objdump {-drw} plt-main-bnd.dd}} \\\n \t\t\"plt-main-bnd-now\" \\\n@@ -1849,7 +1851,7 @@ if { [isnative] && [check_compiler_available] } {\n \t\t\"tmpdir/plt-main1.o tmpdir/plt-main2.o tmpdir/plt-main3.o \\\n \t\t tmpdir/plt-main4.o tmpdir/libplt-lib.so -z bndplt -z now -pie \\\n \t\t -z noseparate-code -z max-page-size=0x200000\" \\\n-\t\t\"-fPIC -Wa,-mx86-used-note=yes\" \\\n+\t\t\"-fPIC -Wa,-mx86-used-note=yes $NOCF_PROTECTION_CFLAGS\" \\\n \t\t{ plt-main5.c } \\\n \t\t{{readelf {-SW} plt-main-bnd-now.rd} {objdump {-drw} plt-main-bnd.dd}} \\\n \t\t\"plt-main-pie-bnd-now\" \\"
    }
  ]
}