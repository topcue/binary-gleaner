{
  "sha": "5b151607e1faf27238e9dce6d3124741779dcc3a",
  "node_id": "C_kwDOANOeidoAKDViMTUxNjA3ZTFmYWYyNzIzOGU5ZGNlNmQzMTI0NzQxNzc5ZGNjM2E",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-10-28T08:43:34Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2021-10-28T08:43:34Z"
    },
    "message": "[gdb/symtab] Handle DW_AT_string_length with location list\n\nConsider a fortran routine where a string variable s is modified:\n...\nsubroutine f(s)\n  character*(*) s\n  print *, s\n  s(1:3) = 'oof'\n  print *, s\nend subroutine f\n...\n\nWhen compiling with optimization level -O1 and printing the type of\nvariable s we get:\n...\n$ gdb -q -batch outputs/gdb.opt/fortran-string/fortran-string \\\n  -ex \"b f\" \\\n  -ex run \\\n  -ex \"ptype s\"\nBreakpoint 1 at 0x4006f7: file fortran-string.f90, line 21.\n\nBreakpoint 1, f (s=..., _s=_s@entry=3) at fortran-string.f90:21\n21      subroutine f(s)\ntype = character*1\n...\nwhile with -O0 we have instead:\n...\ntype = character (3)\n...\n\nThe problem is that the type of s is:\n...\n <1><2d6>: Abbrev Number: 21 (DW_TAG_string_type)\n    <2d7>   DW_AT_string_length: 0xbf (location list)\n    <2db>   DW_AT_byte_size   : 4\n...\nwhere the DW_AT_string_length is a location list, a case that is not handled\nby attr_to_dynamic_prop.\n\nFix this by handling attr->form_is_section_offset () in attr_to_dynamic_prop.\n\nTested on x86_64-linux.\n\nThe test-case is based on gdb.opt/fortran-string.exp from\nhttps://src.fedoraproject.org/rpms/gdb/raw/f32/f/gdb-archer-vla-tests.patch .\nI've updated the copyrights to stretch to 2021.\n\n[ I've tried to create a dwarf assembly test-case for this, but didn't\nmanage. ]\n\nCo-Authored-By: Jan Kratochvil <jan.kratochvil@redhat.com>\n\nBug: https://sourceware.org/bugzilla/show_bug.cgi?id=26910",
    "tree": {
      "sha": "87dbff26ef42ec5668ceb7930bc134ba9c00c484",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/87dbff26ef42ec5668ceb7930bc134ba9c00c484"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/5b151607e1faf27238e9dce6d3124741779dcc3a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5b151607e1faf27238e9dce6d3124741779dcc3a",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/5b151607e1faf27238e9dce6d3124741779dcc3a",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/5b151607e1faf27238e9dce6d3124741779dcc3a/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "fed5a5acc523097a03d9e543cb3f968c5a542606",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/fed5a5acc523097a03d9e543cb3f968c5a542606",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/fed5a5acc523097a03d9e543cb3f968c5a542606"
    }
  ],
  "stats": {
    "total": 89,
    "additions": 85,
    "deletions": 4
  },
  "files": [
    {
      "sha": "af184d4d1fd481188ef78496857fafd5cd5ef109",
      "filename": "gdb/dwarf2/read.c",
      "status": "modified",
      "additions": 20,
      "deletions": 4,
      "changes": 24,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/dwarf2/read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/dwarf2/read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/read.c?ref=5b151607e1faf27238e9dce6d3124741779dcc3a",
      "patch": "@@ -18468,14 +18468,30 @@ attr_to_dynamic_prop (const struct attribute *attr, struct die_info *die,\n     }\n   else if (attr->form_is_constant ())\n     prop->set_const_val (attr->constant_value (0));\n-  else\n+  else if (attr->form_is_section_offset ())\n     {\n-      dwarf2_invalid_attrib_class_complaint (dwarf_form_name (attr->form),\n-\t\t\t\t\t     dwarf2_name (die, cu));\n-      return 0;\n+      switch (attr->name)\n+\t{\n+\tcase DW_AT_string_length:\n+\t  baton = XOBNEW (obstack, struct dwarf2_property_baton);\n+\t  baton->property_type = default_type;\n+\t  fill_in_loclist_baton (cu, &baton->loclist, attr);\n+\t  prop->set_loclist (baton);\n+\t  gdb_assert (prop->baton () != NULL);\n+\t  break;\n+\tdefault:\n+\t  goto invalid;\n+\t}\n     }\n+  else\n+    goto invalid;\n \n   return 1;\n+\n+ invalid:\n+  dwarf2_invalid_attrib_class_complaint (dwarf_form_name (attr->form),\n+\t\t\t\t\t dwarf2_name (die, cu));\n+  return 0;\n }\n \n /* See read.h.  */"
    },
    {
      "sha": "9bf6269f840b6e3ceda59672a9081073289ad5f9",
      "filename": "gdb/testsuite/gdb.opt/fortran-string.exp",
      "status": "added",
      "additions": 38,
      "deletions": 0,
      "changes": 38,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/testsuite/gdb.opt/fortran-string.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/testsuite/gdb.opt/fortran-string.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.opt/fortran-string.exp?ref=5b151607e1faf27238e9dce6d3124741779dcc3a",
      "patch": "@@ -0,0 +1,38 @@\n+# Copyright 2009-2021 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/> .\n+\n+# Test GDB can cope with Fortran strings having their length present in a CPU\n+# register.  With -O0 the string length is passed on the stack.  To make this\n+# test meaningful the follow assertion should pass.  It is not being checked\n+# here as the \"_s\" symbol is compiler dependent:\n+#   (gdb) info address _s\n+#   Symbol \"_s\" is a variable in register XX.\n+\n+standard_testfile .f90\n+\n+if { [prepare_for_testing \"prepare for testing\" ${testfile} ${srcfile} \\\n+\t  {debug f90 additional_flags=-O1}] } {\n+    return -1\n+}\n+\n+if ![runto f] then {\n+    perror \"couldn't run to f\"\n+    continue\n+}\n+\n+gdb_test_no_output \"set print frame-arguments all\"\n+gdb_test \"frame\" \".*s='foo'.*\"\n+gdb_test \"ptype s\" \"type = character \\\\(3\\\\)\"\n+gdb_test \"p s\" \"\\\\$\\[0-9\\]* = 'foo'\""
    },
    {
      "sha": "71b6baea05a4957bd855eea3c8692f7bfe64b8c7",
      "filename": "gdb/testsuite/gdb.opt/fortran-string.f90",
      "status": "added",
      "additions": 27,
      "deletions": 0,
      "changes": 27,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/testsuite/gdb.opt/fortran-string.f90",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/5b151607e1faf27238e9dce6d3124741779dcc3a/gdb/testsuite/gdb.opt/fortran-string.f90",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.opt/fortran-string.f90?ref=5b151607e1faf27238e9dce6d3124741779dcc3a",
      "patch": "@@ -0,0 +1,27 @@\n+! Copyright 2009-2021 Free Software Foundation, Inc.\n+!\n+! This program is free software; you can redistribute it and/or modify\n+! it under the terms of the GNU General Public License as published by\n+! the Free Software Foundation; either version 3 of the License, or\n+! (at your option) any later version.\n+!\n+! This program is distributed in the hope that it will be useful,\n+! but WITHOUT ANY WARRANTY; without even the implied warranty of\n+! MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+! GNU General Public License for more details.\n+!\n+! You should have received a copy of the GNU General Public License\n+! along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+subroutine f(s)\n+  character*(*) s\n+  print *, s\n+  s(1:3) = 'oof'\n+  print *, s\n+end subroutine f\n+\n+program main\n+  character*3 s;\n+  s = 'foo'\n+  call f (s)\n+end program main"
    }
  ]
}