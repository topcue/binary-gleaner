{
  "sha": "a3b3e8586d80204660e203d05edfe88418c394a2",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YTNiM2U4NTg2ZDgwMjA0NjYwZTIwM2QwNWVkZmU4ODQxOGMzOTRhMg==",
  "commit": {
    "author": {
      "name": "Mark Wielaard",
      "email": "mark@klomp.org",
      "date": "2020-08-03T00:04:17Z"
    },
    "committer": {
      "name": "Mark Wielaard",
      "email": "mark@klomp.org",
      "date": "2020-08-04T09:28:39Z"
    },
    "message": "gas: Fix .debug_info CU header for --gdwarf-5\n\nDWARF5 CU headers have a new unit type field and move the abbrev offset\nto the end of the header.\n\ngas/ChangeLog:\n\n\t* dwarf2dbg.c (out_debug_info): Emit unit type and abbrev offset\n\tfor DWARF5.\n\t* gas/testsuite/gas/elf/dwarf-4-cu.d: New file.\n\t* gas/testsuite/gas/elf/dwarf-4-cu.s: Likewise.\n\t* gas/testsuite/gas/elf/dwarf-5-cu.d: Likewise.\n\t* gas/testsuite/gas/elf/dwarf-5-cu.s: Likewise.\n\t* testsuite/gas/elf/elf.exp: Run dwarf-4-cu and dwarf-5-cu.",
    "tree": {
      "sha": "2315042dfb3ee4f7a37a24aee4821712c31466cc",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/2315042dfb3ee4f7a37a24aee4821712c31466cc"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/a3b3e8586d80204660e203d05edfe88418c394a2",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a3b3e8586d80204660e203d05edfe88418c394a2",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/a3b3e8586d80204660e203d05edfe88418c394a2",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a3b3e8586d80204660e203d05edfe88418c394a2/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "25b1f10d9b55de5dee002500a51e8fc1cd543d30",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/25b1f10d9b55de5dee002500a51e8fc1cd543d30",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/25b1f10d9b55de5dee002500a51e8fc1cd543d30"
    }
  ],
  "stats": {
    "total": 80,
    "additions": 78,
    "deletions": 2
  },
  "files": [
    {
      "sha": "14be27927ac448d6263055a90354fc5509897451",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -1,3 +1,13 @@\n+2020-08-02  Mark Wielaard  <mark@klomp.org>\n+\n+\t* dwarf2dbg.c (out_debug_info): Emit unit type and abbrev offset\n+\tfor DWARF5.\n+\t* gas/testsuite/gas/elf/dwarf-4-cu.d: New file.\n+\t* gas/testsuite/gas/elf/dwarf-4-cu.s: Likewise.\n+\t* gas/testsuite/gas/elf/dwarf-5-cu.d: Likewise.\n+\t* gas/testsuite/gas/elf/dwarf-5-cu.s: Likewise.\n+\t* testsuite/gas/elf/elf.exp: Run dwarf-4-cu and dwarf-5-cu.\n+\n 2020-08-02  Mark Wielaard  <mark@klomp.org>\n \n \t* doc/as.texi (--gdwarf-[345]): Fix typo."
    },
    {
      "sha": "b19e057c7620c62335ecc56880db70954360fcd3",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 16,
      "deletions": 2,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -2464,12 +2464,26 @@ out_debug_info (segT info_seg, segT abbrev_seg, segT line_seg, segT ranges_seg,\n   /* DWARF version.  */\n   out_two (DWARF2_VERSION);\n \n-  /* .debug_abbrev offset */\n-  TC_DWARF2_EMIT_OFFSET (section_symbol (abbrev_seg), sizeof_offset);\n+  if (DWARF2_VERSION < 5)\n+    {\n+      /* .debug_abbrev offset */\n+      TC_DWARF2_EMIT_OFFSET (section_symbol (abbrev_seg), sizeof_offset);\n+    }\n+  else\n+    {\n+      /* unit (header) type */\n+      out_byte (DW_UT_compile);\n+    }\n \n   /* Target address size.  */\n   out_byte (sizeof_address);\n \n+  if (DWARF2_VERSION >= 5)\n+    {\n+      /* .debug_abbrev offset */\n+      TC_DWARF2_EMIT_OFFSET (section_symbol (abbrev_seg), sizeof_offset);\n+    }\n+\n   /* DW_TAG_compile_unit DIE abbrev */\n   out_uleb128 (1);\n "
    },
    {
      "sha": "85a07390d389e1358726722477c96b95d9d9d9e5",
      "filename": "gas/testsuite/gas/elf/dwarf-4-cu.d",
      "status": "added",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-4-cu.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-4-cu.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-4-cu.d?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -0,0 +1,11 @@\n+#as: --gdwarf-4\n+#name: DWARF4 CU\n+#readelf: -wi\n+\n+#...\n+  Compilation Unit @ offset 0x0:\n+   Length:        0x.*\n+   Version:       4\n+   Abbrev Offset: 0x0\n+   Pointer Size:  .\n+#pass"
    },
    {
      "sha": "828f4102a3b083f11ecc0c79181f6a006dde3407",
      "filename": "gas/testsuite/gas/elf/dwarf-4-cu.s",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-4-cu.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-4-cu.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-4-cu.s?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -0,0 +1,14 @@\n+\t.text\n+\t.file 1 \"foo/bar.s\"\n+\t.loc_mark_labels 1\n+\t.globl foobar\n+\t.type   foobar, %function\n+foobar:\n+\t.quad   0x1\n+\t.size foobar, .-foobar\n+\n+\t.globl baz\n+\t.type  baz, %function\n+baz:\n+\t.quad 0x1\n+\t.size baz, .-baz"
    },
    {
      "sha": "839b4b7c77b46705bea0b9dde8c9a09f836f4166",
      "filename": "gas/testsuite/gas/elf/dwarf-5-cu.d",
      "status": "added",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-5-cu.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-5-cu.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-cu.d?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -0,0 +1,11 @@\n+#as: --gdwarf-5\n+#name: DWARF5 CU\n+#readelf: -wi\n+\n+#...\n+  Compilation Unit @ offset 0x0:\n+   Length:        0x.*\n+   Version:       5\n+   Abbrev Offset: 0x0\n+   Pointer Size:  .\n+#pass"
    },
    {
      "sha": "828f4102a3b083f11ecc0c79181f6a006dde3407",
      "filename": "gas/testsuite/gas/elf/dwarf-5-cu.s",
      "status": "added",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-5-cu.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/dwarf-5-cu.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-cu.s?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -0,0 +1,14 @@\n+\t.text\n+\t.file 1 \"foo/bar.s\"\n+\t.loc_mark_labels 1\n+\t.globl foobar\n+\t.type   foobar, %function\n+foobar:\n+\t.quad   0x1\n+\t.size foobar, .-foobar\n+\n+\t.globl baz\n+\t.type  baz, %function\n+baz:\n+\t.quad 0x1\n+\t.size baz, .-baz"
    },
    {
      "sha": "155f78efa7f8bed282d753d2f21aa72b69b51315",
      "filename": "gas/testsuite/gas/elf/elf.exp",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/a3b3e8586d80204660e203d05edfe88418c394a2/gas/testsuite/gas/elf/elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/elf.exp?ref=a3b3e8586d80204660e203d05edfe88418c394a2",
      "patch": "@@ -274,6 +274,8 @@ if { [is_elf_format] } then {\n     run_dump_test \"dwarf2-18\" $dump_opts\n     run_dump_test \"dwarf2-19\" $dump_opts\n     run_dump_test \"dwarf-5-file0\" $dump_opts\n+    run_dump_test \"dwarf-4-cu\" $dump_opts\n+    run_dump_test \"dwarf-5-cu\" $dump_opts\n     run_dump_test \"pr25917\"\n     run_dump_test \"bss\"\n     run_dump_test \"bad-bss\""
    }
  ]
}