{
  "sha": "f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZjViOWMyODhhMzA1N2YwZjA0ZTc0ZjAwZmRiMGU3OWQxNzFkNTRhOA==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-03-02T10:52:31Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-03-02T11:17:42Z"
    },
    "message": "PowerPC64 undefined weak visibility vs GOT optimisation\n\nUndefined weak symbols with non-default visibility are seen as local\nby SYMBOL_REFERENCES_LOCAL.  This stops a got indirect to relative\noptimisation for them, so that pies and dlls don't get non-zero values\nwhen loading somewhere other than the address they are linked at\n(which always happens).  The optimisation could be allowed for pdes,\nbut I thought it best not to allow it there too.\n\nbfd/\n\t* elf64-ppc.c (ppc64_elf_relocate_section): Don't optimise got\n\tindirect to pc-relative or toc-relative for undefined symbols.\nld/\n\t* testsuite/ld-powerpc/weak1.d,\n\t* testsuite/ld-powerpc/weak1.r,\n\t* testsuite/ld-powerpc/weak1.s,\n\t* testsuite/ld-powerpc/weak1so.d,\n\t* testsuite/ld-powerpc/weak1so.r: New tests.\n\t* testsuite/ld-powerpc/powerpc.exp: Run them.",
    "tree": {
      "sha": "8286125cbea609ffb437fcd0155dbc6b913336a2",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/8286125cbea609ffb437fcd0155dbc6b913336a2"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ec11fcffc00ed02eed7b18b312a1af857f5a8caa",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ec11fcffc00ed02eed7b18b312a1af857f5a8caa",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/ec11fcffc00ed02eed7b18b312a1af857f5a8caa"
    }
  ],
  "stats": {
    "total": 115,
    "additions": 115,
    "deletions": 0
  },
  "files": [
    {
      "sha": "44286c2195d15d84cc8e95246d749c7d3614ce11",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -1,3 +1,8 @@\n+2021-03-02  Alan Modra  <amodra@gmail.com>\n+\n+\t* elf64-ppc.c (ppc64_elf_relocate_section): Don't optimise got\n+\tindirect to pc-relative or toc-relative for undefined symbols.\n+\n 2021-03-01  Alan Modra  <amodra@gmail.com>\n \t    Fangrui Song <maskray@google.com>\n "
    },
    {
      "sha": "769fff9bb5c1a1d908aa443c2ba167e785dad86f",
      "filename": "bfd/elf64-ppc.c",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/bfd/elf64-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/bfd/elf64-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf64-ppc.c?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -16081,6 +16081,9 @@ ppc64_elf_relocate_section (bfd *output_bfd,\n \t    break;\n \t  from = TOCstart + htab->sec_info[input_section->id].toc_off;\n \t  if (relocation + addend - from + 0x8000 < 0x10000\n+\t      && sec != NULL\n+\t      && sec->output_section != NULL\n+\t      && !discarded_section (sec)\n \t      && (h == NULL || SYMBOL_REFERENCES_LOCAL (info, &h->elf)))\n \t    {\n \t      insn = bfd_get_32 (input_bfd, contents + (rel->r_offset & ~3));\n@@ -16101,6 +16104,9 @@ ppc64_elf_relocate_section (bfd *output_bfd,\n \t    break;\n \t  from = TOCstart + htab->sec_info[input_section->id].toc_off;\n \t  if (relocation + addend - from + 0x80008000ULL < 0x100000000ULL\n+\t      && sec != NULL\n+\t      && sec->output_section != NULL\n+\t      && !discarded_section (sec)\n \t      && (h == NULL || SYMBOL_REFERENCES_LOCAL (info, &h->elf)))\n \t    {\n \t      insn = bfd_get_32 (input_bfd, contents + (rel->r_offset & ~3));\n@@ -16129,6 +16135,9 @@ ppc64_elf_relocate_section (bfd *output_bfd,\n \t\t  + input_section->output_section->vma\n \t\t  + input_section->output_offset);\n \t  if (!(relocation - from + (1ULL << 33) < 1ULL << 34\n+\t\t&& sec != NULL\n+\t\t&& sec->output_section != NULL\n+\t\t&& !discarded_section (sec)\n \t\t&& (h == NULL || SYMBOL_REFERENCES_LOCAL (info, &h->elf))))\n \t    break;\n "
    },
    {
      "sha": "2bb97bd28097bcf01160a381d677893b6d368002",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -1,3 +1,12 @@\n+2021-03-02  Alan Modra  <amodra@gmail.com>\n+\n+\t* testsuite/ld-powerpc/weak1.d,\n+\t* testsuite/ld-powerpc/weak1.r,\n+\t* testsuite/ld-powerpc/weak1.s,\n+\t* testsuite/ld-powerpc/weak1so.d,\n+\t* testsuite/ld-powerpc/weak1so.r: New tests.\n+\t* testsuite/ld-powerpc/powerpc.exp: Run them.\n+\n 2021-03-01  Hannes Domani  <ssbssa@sourceware.org>\n \t    Nick Clifton  <nickc@redhat.com>\n "
    },
    {
      "sha": "8aa0eccfa0e71fd0d74379ea7a773b7f8c398b0c",
      "filename": "ld/testsuite/ld-powerpc/powerpc.exp",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/powerpc.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/powerpc.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/powerpc.exp?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -344,6 +344,12 @@ set ppc64elftests {\n     {\"group3\" \"-melf64ppc -e foo\" \"\" \"-a64\" {group3.s group2.s group1.s}\n \t{{objdump {-d} group2.d}\n \t {readelf {-s} group3.sym}} \"group3\"}\n+    {\"weak1\" \"-melf64ppc --hash-style=both\" \"\"\n+\t\"-a64 -mpower10\" {weak1.s}\n+\t{{objdump -d weak1.d} {readelf {-srW} weak1.r}} \"weak1\"}\n+    {\"weak1.so\" \"-shared -melf64ppc --hash-style=both\" \"\"\n+\t\"-a64 -mpower10\" {weak1.s}\n+\t{{objdump -d weak1so.d} {readelf {-srW} weak1so.r}} \"weak1.so\"}\n }\n \n set ppceabitests {"
    },
    {
      "sha": "c0127539ddd76a7e1f6b187bf09026f99e01c315",
      "filename": "ld/testsuite/ld-powerpc/weak1.d",
      "status": "added",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/weak1.d?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -0,0 +1,26 @@\n+\n+.*:     file format .*\n+\n+Disassembly of section \\.text:\n+\n+.*0c0 <_start>:\n+.*0c0:\t(04 10 00 01|01 00 10 04) \tpld     r3,65888\n+.*0c4:\t(e4 60 01 60|60 01 60 e4) \n+.*0c8:\t(04 10 00 01|01 00 10 04) \tpld     r3,65856\n+.*0cc:\t(e4 60 01 40|40 01 60 e4) \n+.*0d0:\t(04 10 00 01|01 00 10 04) \tpld     r3,65864\n+.*0d4:\t(e4 60 01 48|48 01 60 e4) \n+.*0d8:\t(04 10 00 01|01 00 10 04) \tpld     r3,65848\n+.*0dc:\t(e4 60 01 38|38 01 60 e4) \n+.*0e0:\t(e8 62 80 20|20 80 62 e8) \tld      r3,-32736\\(r2\\)\n+.*0e4:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n+.*0e8:\t(e8 62 80 18|18 80 62 e8) \tld      r3,-32744\\(r2\\)\n+.*0ec:\t(e8 62 80 10|10 80 62 e8) \tld      r3,-32752\\(r2\\)\n+.*0f0:\t(60 00 00 00|00 00 00 60) \tnop\n+.*0f4:\t(e8 62 80 20|20 80 62 e8) \tld      r3,-32736\\(r2\\)\n+.*0f8:\t(60 00 00 00|00 00 00 60) \tnop\n+.*0fc:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n+.*100:\t(60 00 00 00|00 00 00 60) \tnop\n+.*104:\t(e8 62 80 18|18 80 62 e8) \tld      r3,-32744\\(r2\\)\n+.*108:\t(60 00 00 00|00 00 00 60) \tnop\n+.*10c:\t(e8 62 80 10|10 80 62 e8) \tld      r3,-32752\\(r2\\)"
    },
    {
      "sha": "7d73f38cbb3e78b45fac02dfde31b1941a246c30",
      "filename": "ld/testsuite/ld-powerpc/weak1.r",
      "status": "added",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.r",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.r",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/weak1.r?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -0,0 +1,5 @@\n+\n+There are no relocations in this file.\n+\n+Symbol table '\\.symtab' .*\n+#pass"
    },
    {
      "sha": "0f370d974ba75828f8dc4c35a9bd2000f306aa7a",
      "filename": "ld/testsuite/ld-powerpc/weak1.s",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/weak1.s?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -0,0 +1,22 @@\n+ .weak x1, x2, x3, x4\n+ .protected x2\n+ .hidden x3\n+ .internal x4\n+ .global _start\n+_start:\n+ pld 3,x1@got@pcrel\n+ pld 3,x2@got@pcrel\n+ pld 3,x3@got@pcrel\n+ pld 3,x4@got@pcrel\n+ ld 3,x1@got(2)\n+ ld 3,x2@got(2)\n+ ld 3,x3@got(2)\n+ ld 3,x4@got(2)\n+ addis 9,2,x1@got@ha\n+ ld 3,x1@got@l(9)\n+ addis 9,2,x2@got@ha\n+ ld 3,x2@got@l(9)\n+ addis 9,2,x3@got@ha\n+ ld 3,x3@got@l(9)\n+ addis 9,2,x4@got@ha\n+ ld 3,x4@got@l(9)"
    },
    {
      "sha": "0d34b3b4840f987f69c9252e44987ca9d235ecce",
      "filename": "ld/testsuite/ld-powerpc/weak1so.d",
      "status": "added",
      "additions": 26,
      "deletions": 0,
      "changes": 26,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1so.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1so.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/weak1so.d?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -0,0 +1,26 @@\n+\n+.*:     file format .*\n+\n+Disassembly of section \\.text:\n+\n+0+1c0 <_start>:\n+ 1c0:\t(04 10 00 01|01 00 10 04) \tpld     r3,66144\n+ 1c4:\t(e4 60 02 60|60 02 60 e4) \n+ 1c8:\t(04 10 00 01|01 00 10 04) \tpld     r3,66112\n+ 1cc:\t(e4 60 02 40|40 02 60 e4) \n+ 1d0:\t(04 10 00 01|01 00 10 04) \tpld     r3,66120\n+ 1d4:\t(e4 60 02 48|48 02 60 e4) \n+ 1d8:\t(04 10 00 01|01 00 10 04) \tpld     r3,66104\n+ 1dc:\t(e4 60 02 38|38 02 60 e4) \n+ 1e0:\t(e8 62 80 20|20 80 62 e8) \tld      r3,-32736\\(r2\\)\n+ 1e4:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n+ 1e8:\t(e8 62 80 18|18 80 62 e8) \tld      r3,-32744\\(r2\\)\n+ 1ec:\t(e8 62 80 10|10 80 62 e8) \tld      r3,-32752\\(r2\\)\n+ 1f0:\t(60 00 00 00|00 00 00 60) \tnop\n+ 1f4:\t(e8 62 80 20|20 80 62 e8) \tld      r3,-32736\\(r2\\)\n+ 1f8:\t(60 00 00 00|00 00 00 60) \tnop\n+ 1fc:\t(e8 62 80 08|08 80 62 e8) \tld      r3,-32760\\(r2\\)\n+ 200:\t(60 00 00 00|00 00 00 60) \tnop\n+ 204:\t(e8 62 80 18|18 80 62 e8) \tld      r3,-32744\\(r2\\)\n+ 208:\t(60 00 00 00|00 00 00 60) \tnop\n+ 20c:\t(e8 62 80 10|10 80 62 e8) \tld      r3,-32752\\(r2\\)"
    },
    {
      "sha": "dcc91f1879a1de836d699f3a026a2ae37d58bfba",
      "filename": "ld/testsuite/ld-powerpc/weak1so.r",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1so.r",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f5b9c288a3057f0f04e74f00fdb0e79d171d54a8/ld/testsuite/ld-powerpc/weak1so.r",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/weak1so.r?ref=f5b9c288a3057f0f04e74f00fdb0e79d171d54a8",
      "patch": "@@ -0,0 +1,7 @@\n+#...\n+.* R_PPC64_GLOB_DAT +0+ x1 \\+ 0\n+#...\n+.* 0+ +0 NOTYPE +WEAK +DEFAULT +UND x1\n+#...\n+.* 0+ +0 NOTYPE +WEAK +DEFAULT +UND x1\n+#pass"
    }
  ]
}