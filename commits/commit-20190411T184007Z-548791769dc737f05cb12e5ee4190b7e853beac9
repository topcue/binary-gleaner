{
  "sha": "548791769dc737f05cb12e5ee4190b7e853beac9",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NTQ4NzkxNzY5ZGM3MzdmMDVjYjEyZTVlZTQxOTBiN2U4NTNiZWFjOQ==",
  "commit": {
    "author": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2019-04-08T20:47:18Z"
    },
    "committer": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2019-04-11T18:40:07Z"
    },
    "message": "xtensa: gas: put .literal_position at section start\n\nProvide literal position at the beginning of each section for literal\nspace reserved by relaxations when text-section-literals or\nauto-litpools options are used. Remove code that adds fill frag to the\nliteral section for every .literal_position directive to avoid creation\nof empty literal sections.\n\nFix auto-litpools tests that got literal pool address changes.\n\ngas/\n2019-04-11  Max Filippov  <jcmvbkbc@gmail.com>\n\n\t* config/tc-xtensa.c (xtensa_is_init_fini): Add declaration.\n\t(xtensa_mark_literal_pool_location): Don't add fill frag to literal\n\tsection that records literal pool location.\n\t(md_begin): Call xtensa_mark_literal_pool_location when text\n\tsection literals or auto litpools are used.\n\t(xtensa_elf_section_change_hook): Call\n\txtensa_mark_literal_pool_location when text section literals or\n\tauto litpools are used, there's no literal pool location defined\n\tfor the current section and it's not .init or .fini.\n\t* testsuite/gas/xtensa/auto-litpools-first1.d: Fix up addresses.\n\t* testsuite/gas/xtensa/auto-litpools-first2.d: Likewise.\n\t* testsuite/gas/xtensa/auto-litpools.d: Likewise.",
    "tree": {
      "sha": "53abccdc17323c66508457110bc7e3a639a77ddf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/53abccdc17323c66508457110bc7e3a639a77ddf"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/548791769dc737f05cb12e5ee4190b7e853beac9",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/548791769dc737f05cb12e5ee4190b7e853beac9",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/548791769dc737f05cb12e5ee4190b7e853beac9",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/548791769dc737f05cb12e5ee4190b7e853beac9/comments",
  "author": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "035801cebe9ffbdddb465b81ae514a465ce9c64c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/035801cebe9ffbdddb465b81ae514a465ce9c64c",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/035801cebe9ffbdddb465b81ae514a465ce9c64c"
    }
  ],
  "stats": {
    "total": 59,
    "additions": 34,
    "deletions": 25
  },
  "files": [
    {
      "sha": "f0d2a97226f0d76e01bc861456e0de331042c397",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/548791769dc737f05cb12e5ee4190b7e853beac9/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/548791769dc737f05cb12e5ee4190b7e853beac9/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=548791769dc737f05cb12e5ee4190b7e853beac9",
      "patch": "@@ -1,3 +1,18 @@\n+2019-04-11  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* config/tc-xtensa.c (xtensa_is_init_fini): Add declaration.\n+\t(xtensa_mark_literal_pool_location): Don't add fill frag to literal\n+\tsection that records literal pool location.\n+\t(md_begin): Call xtensa_mark_literal_pool_location when text\n+\tsection literals or auto litpools are used.\n+\t(xtensa_elf_section_change_hook): Call\n+\txtensa_mark_literal_pool_location when text section literals or\n+\tauto litpools are used, there's no literal pool location defined\n+\tfor the current section and it's not .init or .fini.\n+\t* testsuite/gas/xtensa/auto-litpools-first1.d: Fix up addresses.\n+\t* testsuite/gas/xtensa/auto-litpools-first2.d: Likewise.\n+\t* testsuite/gas/xtensa/auto-litpools.d: Likewise.\n+\n 2019-04-11  Sudakshina Das  <sudi.das@arm.com>\n \n \t* config/tc-aarch64.c (process_omitted_operand): Add case for"
    },
    {
      "sha": "6a80e76fed8cfe41af7d536ddf50c20e4198f6ac",
      "filename": "gas/config/tc-xtensa.c",
      "status": "modified",
      "additions": 9,
      "deletions": 13,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/548791769dc737f05cb12e5ee4190b7e853beac9/gas/config/tc-xtensa.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/548791769dc737f05cb12e5ee4190b7e853beac9/gas/config/tc-xtensa.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-xtensa.c?ref=548791769dc737f05cb12e5ee4190b7e853beac9",
      "patch": "@@ -497,6 +497,7 @@ static fixS *xg_append_jump (fragS *fragP, symbolS *sym, offsetT offset);\n static void xtensa_maybe_create_literal_pool_frag (bfd_boolean, bfd_boolean);\n static bfd_boolean auto_litpools = FALSE;\n static int auto_litpool_limit = 0;\n+static bfd_boolean xtensa_is_init_fini (segT seg);\n \n /* Alignment Functions.  */\n \n@@ -4797,7 +4798,6 @@ xtensa_mark_literal_pool_location (void)\n {\n   /* Any labels pointing to the current location need\n      to be adjusted to after the literal pool.  */\n-  emit_state s;\n   fragS *pool_location;\n \n   if (use_literal_section)\n@@ -4818,19 +4818,7 @@ xtensa_mark_literal_pool_location (void)\n \t\tRELAX_LITERAL_POOL_END, NULL, 0, NULL);\n   xtensa_set_frag_assembly_state (frag_now);\n \n-  /* Now put a frag into the literal pool that points to this location.  */\n   set_literal_pool_location (now_seg, pool_location);\n-  xtensa_switch_to_non_abs_literal_fragment (&s);\n-  frag_align (2, 0, 0);\n-  record_alignment (now_seg, 2);\n-\n-  /* Close whatever frag is there.  */\n-  frag_variant (rs_fill, 0, 0, 0, NULL, 0, NULL);\n-  xtensa_set_frag_assembly_state (frag_now);\n-  frag_now->tc_frag_data.literal_frag = pool_location;\n-  frag_variant (rs_fill, 0, 0, 0, NULL, 0, NULL);\n-  xtensa_restore_emit_state (&s);\n-  xtensa_set_frag_assembly_state (frag_now);\n }\n \n \n@@ -5334,6 +5322,9 @@ md_begin (void)\n   /* Set up the assembly state.  */\n   if (!frag_now->tc_frag_data.is_assembly_state_set)\n     xtensa_set_frag_assembly_state (frag_now);\n+\n+  if (!use_literal_section)\n+    xtensa_mark_literal_pool_location ();\n }\n \n \n@@ -5933,6 +5924,11 @@ xtensa_elf_section_change_hook (void)\n   /* Set up the assembly state.  */\n   if (!frag_now->tc_frag_data.is_assembly_state_set)\n     xtensa_set_frag_assembly_state (frag_now);\n+\n+  if (!use_literal_section\n+      && seg_info (now_seg)->tc_segment_info_data.literal_pool_loc == NULL\n+      && !xtensa_is_init_fini (now_seg))\n+    xtensa_mark_literal_pool_location ();\n }\n \n "
    },
    {
      "sha": "9dfb0b03db6db0071cbf7c3142455c2baa7ad1f8",
      "filename": "gas/testsuite/gas/xtensa/auto-litpools-first1.d",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools-first1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools-first1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/auto-litpools-first1.d?ref=548791769dc737f05cb12e5ee4190b7e853beac9",
      "patch": "@@ -5,8 +5,8 @@\n .*: +file format .*xtensa.*\n #...\n Contents of section .text:\n- 0000 ........ 20170331 .*\n+ 0000 20170331 .*\n #...\n-00000000 <f>:\n-.*0:.*j.8 .*\n+00000004 <f>:\n+.*4:.*l32r.*a2, 0.*\n #..."
    },
    {
      "sha": "44dbddd75128da2fab9f680dddda4ab0ad74a41f",
      "filename": "gas/testsuite/gas/xtensa/auto-litpools-first2.d",
      "status": "modified",
      "additions": 4,
      "deletions": 6,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools-first2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools-first2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/auto-litpools-first2.d?ref=548791769dc737f05cb12e5ee4190b7e853beac9",
      "patch": "@@ -5,11 +5,9 @@\n .*: +file format .*xtensa.*\n #...\n Contents of section .text:\n- 0000 ........ ........ 20170331 .*\n+ 0000 20170331 .*\n #...\n-00000000 <f>:\n-   0:.*addi.*a1.*\n-   3:.*j.*c.*\n-#...\n-   c:.*l32r.*a2, 8.*\n+00000004 <f>:\n+   4:.*addi.*a1.*\n+   7:.*l32r.*a2, 0.*\n #..."
    },
    {
      "sha": "8b6d13e371b15d01e92ef19dc4535b114939d0a0",
      "filename": "gas/testsuite/gas/xtensa/auto-litpools.d",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/548791769dc737f05cb12e5ee4190b7e853beac9/gas/testsuite/gas/xtensa/auto-litpools.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/auto-litpools.d?ref=548791769dc737f05cb12e5ee4190b7e853beac9",
      "patch": "@@ -4,9 +4,9 @@\n \n .*: +file format .*xtensa.*\n #...\n-.*8:.*l32r.a2, 4 .*\n+.*4:.*l32r.a2, 0 .*\n #...\n-.*3f029:.*j.3f030 .*\n+.*3f025:.*j.3f02c .*\n #...\n-.*40752:.*l32r.a2, 3f02c .*\n+.*4074e:.*l32r.a2, 3f028 .*\n #..."
    }
  ]
}