{
  "sha": "7c711119166fc1c60c756059f39c6703d57eedbf",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6N2M3MTExMTkxNjZmYzFjNjBjNzU2MDU5ZjM5YzY3MDNkNTdlZWRiZg==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2018-12-27T19:16:06Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-01-03T21:49:19Z"
    },
    "message": "Avoid questionable casts in py-symtab.c\n\npy-symtab.c has some questionable casts of Py_None to symtab_object*.\nThis patch avoids these casts by instead using downcasts at the\nappropriate places.\n\ngdb/ChangeLog\n2019-01-03  Tom Tromey  <tom@tromey.com>\n\n\t* python/py-symtab.c (salpy_str): Update.\n\t(struct salpy_sal_object) <symtab>: Now a PyObject.\n\t(salpy_dealloc): Update.\n\t(del_objfile_sal): Use gdbpy_ref.",
    "tree": {
      "sha": "457116b24660a941d567a9cc8372d84bc483b6ec",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/457116b24660a941d567a9cc8372d84bc483b6ec"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/7c711119166fc1c60c756059f39c6703d57eedbf",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7c711119166fc1c60c756059f39c6703d57eedbf",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/7c711119166fc1c60c756059f39c6703d57eedbf",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7c711119166fc1c60c756059f39c6703d57eedbf/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "1b20edf043c62759a4c78e40b03846e9bafd584c",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1b20edf043c62759a4c78e40b03846e9bafd584c",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/1b20edf043c62759a4c78e40b03846e9bafd584c"
    }
  ],
  "stats": {
    "total": 46,
    "additions": 30,
    "deletions": 16
  },
  "files": [
    {
      "sha": "2292eaaac86bf8c1201e1c2a98214ac91971e08a",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7c711119166fc1c60c756059f39c6703d57eedbf/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7c711119166fc1c60c756059f39c6703d57eedbf/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=7c711119166fc1c60c756059f39c6703d57eedbf",
      "patch": "@@ -1,3 +1,10 @@\n+2019-01-03  Tom Tromey  <tom@tromey.com>\n+\n+\t* python/py-symtab.c (salpy_str): Update.\n+\t(struct salpy_sal_object) <symtab>: Now a PyObject.\n+\t(salpy_dealloc): Update.\n+\t(del_objfile_sal): Use gdbpy_ref.\n+\n 2019-01-03  Tom Tromey  <tom@tromey.com>\n \n \t* python/py-type.c (convert_field): Use new_reference.  Return"
    },
    {
      "sha": "a5f376ae9e271c00e82e1525ef3944d38f3c1c06",
      "filename": "gdb/python/py-symtab.c",
      "status": "modified",
      "additions": 23,
      "deletions": 16,
      "changes": 39,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7c711119166fc1c60c756059f39c6703d57eedbf/gdb/python/py-symtab.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7c711119166fc1c60c756059f39c6703d57eedbf/gdb/python/py-symtab.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-symtab.c?ref=7c711119166fc1c60c756059f39c6703d57eedbf",
      "patch": "@@ -58,7 +58,7 @@ static const struct objfile_data *stpy_objfile_data_key;\n typedef struct salpy_sal_object {\n   PyObject_HEAD\n   /* The GDB Symbol table structure.  */\n-  symtab_object *symtab;\n+  PyObject *symtab;\n   /* The GDB Symbol table and line structure.  */\n   struct symtab_and_line *sal;\n   /* A Symtab and line object is associated with an objfile, so keep\n@@ -227,8 +227,13 @@ salpy_str (PyObject *self)\n   SALPY_REQUIRE_VALID (self, sal);\n \n   sal_obj = (sal_object *) self;\n-  filename = (sal_obj->symtab == (symtab_object *) Py_None)\n-    ? \"<unknown>\" : symtab_to_filename_for_display (sal_obj->symtab->symtab);\n+  if (sal_obj->symtab == Py_None)\n+    filename = \"<unknown>\";\n+  else\n+    {\n+      symtab *symtab = symtab_object_to_symtab (sal_obj->symtab);\n+      filename = symtab_to_filename_for_display (symtab);\n+    }\n \n   return PyString_FromFormat (\"symbol and line for %s, line %d\", filename,\n \t\t\t      sal->line);\n@@ -323,9 +328,10 @@ salpy_dealloc (PyObject *self)\n \n   if (self_sal->prev)\n     self_sal->prev->next = self_sal->next;\n-  else if (self_sal->symtab != (symtab_object * ) Py_None)\n-    set_objfile_data (SYMTAB_OBJFILE (self_sal->symtab->symtab),\n-\t\t      salpy_objfile_data_key, self_sal->next);\n+  else if (self_sal->symtab != Py_None)\n+    set_objfile_data\n+      (SYMTAB_OBJFILE (symtab_object_to_symtab (self_sal->symtab)),\n+       salpy_objfile_data_key, self_sal->next);\n \n   if (self_sal->next)\n     self_sal->next->prev = self_sal->prev;\n@@ -343,19 +349,19 @@ salpy_dealloc (PyObject *self)\n static int CPYCHECKER_NEGATIVE_RESULT_SETS_EXCEPTION\n set_sal (sal_object *sal_obj, struct symtab_and_line sal)\n {\n-  symtab_object *symtab_obj;\n+  PyObject *symtab_obj;\n \n   if (sal.symtab)\n     {\n-      symtab_obj = (symtab_object *) symtab_to_symtab_object  (sal.symtab);\n+      symtab_obj = symtab_to_symtab_object  (sal.symtab);\n       /* If a symtab existed in the sal, but it cannot be duplicated,\n \t we exit.  */\n       if (symtab_obj == NULL)\n \treturn -1;\n     }\n   else\n     {\n-      symtab_obj = (symtab_object *) Py_None;\n+      symtab_obj = Py_None;\n       Py_INCREF (Py_None);\n     }\n \n@@ -367,16 +373,17 @@ set_sal (sal_object *sal_obj, struct symtab_and_line sal)\n \n   /* If the SAL does not have a symtab, we do not add it to the\n      objfile cleanup observer linked list.  */\n-  if (sal_obj->symtab != (symtab_object *)Py_None)\n+  if (sal_obj->symtab != Py_None)\n     {\n+      symtab *symtab = symtab_object_to_symtab (sal_obj->symtab);\n+\n       sal_obj->next\n-\t= ((struct salpy_sal_object *)\n-\t   objfile_data (SYMTAB_OBJFILE (sal_obj->symtab->symtab),\n-\t\t\t salpy_objfile_data_key));\n+\t= ((struct salpy_sal_object *) objfile_data (SYMTAB_OBJFILE (symtab),\n+\t\t\t\t\t\t     salpy_objfile_data_key));\n       if (sal_obj->next)\n \tsal_obj->next->prev = sal_obj;\n \n-      set_objfile_data (SYMTAB_OBJFILE (sal_obj->symtab->symtab),\n+      set_objfile_data (SYMTAB_OBJFILE (symtab),\n \t\t\tsalpy_objfile_data_key, sal_obj);\n     }\n   else\n@@ -491,8 +498,8 @@ del_objfile_sal (struct objfile *objfile, void *datum)\n     {\n       sal_object *next = obj->next;\n \n-      Py_DECREF (obj->symtab);\n-      obj->symtab = (symtab_object *) Py_None;\n+      gdbpy_ref<> tmp (obj->symtab);\n+      obj->symtab = Py_None;\n       Py_INCREF (Py_None);\n \n       obj->next = NULL;"
    }
  ]
}