{
  "sha": "7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6N2E3N2YxYWMyYzZmODk5ZmFhMzllOGMwYjQyZDQyODRkNTg2YzQ0ZQ==",
  "commit": {
    "author": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2020-05-10T15:03:08Z"
    },
    "committer": {
      "name": "Max Filippov",
      "email": "jcmvbkbc@gmail.com",
      "date": "2020-06-15T20:01:30Z"
    },
    "message": "xtensa: allow runtime ABI selection\n\n2020-06-15  Max Filippov  <jcmvbkbc@gmail.com>\nbfd/\n\t* elf32-xtensa.c (XSHAL_ABI, XTHAL_ABI_UNDEFINED)\n\t(XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New macros.\n\t(elf32xtensa_abi): New global variable.\n\t(xtensa_abi_choice): New function.\n\t(elf_xtensa_create_plt_entry): Use xtensa_abi_choice instead of\n\tXSHAL_ABI to select PLT code.\n\ngas/\n\t* config/tc-xtensa.c (XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New\n\tmacros.\n\t(elf32xtensa_abi): New declaration.\n\t(option_abi_windowed, option_abi_call0): New enum constants.\n\t(md_longopts): Add entries for --abi-windowed and --abi-call0.\n\t(md_parse_option): Add handlers for --abi-windowed and\n\t--abi-call0.\n\t(xtensa_add_config_info): Use xtensa_abi_choice instead of\n\tXSHAL_ABI to format ABI tag.\n\t* doc/as.texi (Target Xtensa options): Add --abi-windowed and\n\t--abi-call0 to the list of options.\n\t* doc/c-xtensa.texi: Add description for options --abi-windowed\n\tand --abi-call0.\n\t* testsuite/gas/xtensa/abi-call0.d: New test definition.\n\t* testsuite/gas/xtensa/abi-windowed.d: New test definition.\n\t* testsuite/gas/xtensa/abi.s: New test source.\n\ninclude/\n\t* elf/xtensa.h (xtensa_abi_choice): New declaration.\n\nld/\n\t* emultempl/xtensaelf.em (XSHAL_ABI): Remove macro definition.\n\t(XTHAL_ABI_UNDEFINED, XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New\n\tmacros.\n\t(elf32xtensa_abi): New declaration.\n\t(xt_config_info_unpack_and_check): Set elf32xtensa_abi if it is\n\tundefined.  Use xtensa_abi_choice instead of XSHAL_ABI to test\n\tABI tag consistency.\n\t(xtensa_add_config_info): Use xtensa_abi_choice instead of\n\tXSHAL_ABI to format ABI tag.\n\t(PARSE_AND_LIST_PROLOGUE): Define OPTION_ABI_WINDOWED,\n\tOPTION_ABI_CALL0 and declare elf32xtensa_abi.\n\t(PARSE_AND_LIST_LONGOPTS): Add entries for --abi-windowed and\n\t--abi-call0.\n\t(PARSE_AND_LIST_OPTIONS): Add help text for --abi-windowed and\n\t--abi-call0.\n\t(PARSE_AND_LIST_ARGS_CASES): Add handlers for --abi-windowed and\n\t--abi-call0.\n\t* ld.texi: Add description for options --abi-windowed and\n\t--abi-call0.",
    "tree": {
      "sha": "a62d6ddd84a685332322b873f7b2cd4facdc3601",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/a62d6ddd84a685332322b873f7b2cd4facdc3601"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/comments",
  "author": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jcmvbkbc",
    "id": 166731,
    "node_id": "MDQ6VXNlcjE2NjczMQ==",
    "avatar_url": "https://avatars.githubusercontent.com/u/166731?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jcmvbkbc",
    "html_url": "https://github.com/jcmvbkbc",
    "followers_url": "https://api.github.com/users/jcmvbkbc/followers",
    "following_url": "https://api.github.com/users/jcmvbkbc/following{/other_user}",
    "gists_url": "https://api.github.com/users/jcmvbkbc/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jcmvbkbc/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jcmvbkbc/subscriptions",
    "organizations_url": "https://api.github.com/users/jcmvbkbc/orgs",
    "repos_url": "https://api.github.com/users/jcmvbkbc/repos",
    "events_url": "https://api.github.com/users/jcmvbkbc/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jcmvbkbc/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "cae64165f47b64898c4f1982d294862cfae89a47",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/cae64165f47b64898c4f1982d294862cfae89a47",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/cae64165f47b64898c4f1982d294862cfae89a47"
    }
  ],
  "stats": {
    "total": 196,
    "additions": 184,
    "deletions": 12
  },
  "files": [
    {
      "sha": "ecd7f8d53ef5bd499e69f65ac506bc012580d863",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -1,3 +1,12 @@\n+2020-06-15  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* elf32-xtensa.c (XSHAL_ABI, XTHAL_ABI_UNDEFINED)\n+\t(XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New macros.\n+\t(elf32xtensa_abi): New global variable.\n+\t(xtensa_abi_choice): New function.\n+\t(elf_xtensa_create_plt_entry): Use xtensa_abi_choice instead of\n+\tXSHAL_ABI to select PLT code.\n+\n 2020-06-15  Roland McGrath  <mcgrathr@google.com>\n \n \t* elflink.c (bfd_elf_define_start_stop): Use start_stop_visibility"
    },
    {
      "sha": "b223424cce4e0c36b787aab144e7a28486fa3e65",
      "filename": "bfd/elf32-xtensa.c",
      "status": "modified",
      "additions": 31,
      "deletions": 3,
      "changes": 34,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/bfd/elf32-xtensa.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/bfd/elf32-xtensa.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf32-xtensa.c?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -37,6 +37,22 @@\n \n #define XTENSA_NO_NOP_REMOVAL 0\n \n+#ifndef XSHAL_ABI\n+#define XSHAL_ABI 0\n+#endif\n+\n+#ifndef XTHAL_ABI_UNDEFINED\n+#define XTHAL_ABI_UNDEFINED -1\n+#endif\n+\n+#ifndef XTHAL_ABI_WINDOWED\n+#define XTHAL_ABI_WINDOWED 0\n+#endif\n+\n+#ifndef XTHAL_ABI_CALL0\n+#define XTHAL_ABI_CALL0 1\n+#endif\n+\n /* Local helper functions.  */\n \n static bfd_boolean add_extra_plt_sections (struct bfd_link_info *, int);\n@@ -164,6 +180,10 @@ int elf32xtensa_no_literal_movement = 1;\n \n bfd_boolean elf32xtensa_separate_props = FALSE;\n \n+/* Xtensa ABI.  It affects PLT entry code.  */\n+\n+int elf32xtensa_abi = XTHAL_ABI_UNDEFINED;\n+\n /* Rename one of the generic section flags to better document how it\n    is used here.  */\n /* Whether relocations have been processed.  */\n@@ -2247,6 +2267,13 @@ bfd_elf_xtensa_reloc (bfd *abfd,\n   return flag;\n }\n \n+int xtensa_abi_choice (void)\n+{\n+  if (elf32xtensa_abi == XTHAL_ABI_UNDEFINED)\n+    return XSHAL_ABI;\n+  else\n+    return elf32xtensa_abi;\n+}\n \n /* Set up an entry in the procedure linkage table.  */\n \n@@ -2259,6 +2286,7 @@ elf_xtensa_create_plt_entry (struct bfd_link_info *info,\n   bfd_vma plt_base, got_base;\n   bfd_vma code_offset, lit_offset, abi_offset;\n   int chunk;\n+  int abi = xtensa_abi_choice ();\n \n   chunk = reloc_index / PLT_ENTRIES_PER_CHUNK;\n   splt = elf_xtensa_get_plt_section (info, chunk);\n@@ -2279,10 +2307,10 @@ elf_xtensa_create_plt_entry (struct bfd_link_info *info,\n   /* Fill in the entry in the procedure linkage table.  */\n   memcpy (splt->contents + code_offset,\n \t  (bfd_big_endian (output_bfd)\n-\t   ? elf_xtensa_be_plt_entry[XSHAL_ABI != XTHAL_ABI_WINDOWED]\n-\t   : elf_xtensa_le_plt_entry[XSHAL_ABI != XTHAL_ABI_WINDOWED]),\n+\t   ? elf_xtensa_be_plt_entry[abi != XTHAL_ABI_WINDOWED]\n+\t   : elf_xtensa_le_plt_entry[abi != XTHAL_ABI_WINDOWED]),\n \t  PLT_ENTRY_SIZE);\n-  abi_offset = XSHAL_ABI == XTHAL_ABI_WINDOWED ? 3 : 0;\n+  abi_offset = abi == XTHAL_ABI_WINDOWED ? 3 : 0;\n   bfd_put_16 (output_bfd, l32r_offset (got_base + 0,\n \t\t\t\t       plt_base + code_offset + abi_offset),\n \t      splt->contents + code_offset + abi_offset + 1);"
    },
    {
      "sha": "b19576d027a17fce6d387629fff27cfab2be867d",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -1,3 +1,22 @@\n+2020-06-15  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* config/tc-xtensa.c (XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New\n+\tmacros.\n+\t(elf32xtensa_abi): New declaration.\n+\t(option_abi_windowed, option_abi_call0): New enum constants.\n+\t(md_longopts): Add entries for --abi-windowed and --abi-call0.\n+\t(md_parse_option): Add handlers for --abi-windowed and\n+\t--abi-call0.\n+\t(xtensa_add_config_info): Use xtensa_abi_choice instead of\n+\tXSHAL_ABI to format ABI tag.\n+\t* doc/as.texi (Target Xtensa options): Add --abi-windowed and\n+\t--abi-call0 to the list of options.\n+\t* doc/c-xtensa.texi: Add description for options --abi-windowed\n+\tand --abi-call0.\n+\t* testsuite/gas/xtensa/abi-call0.d: New test definition.\n+\t* testsuite/gas/xtensa/abi-windowed.d: New test definition.\n+\t* testsuite/gas/xtensa/abi.s: New test source.\n+\n 2020-06-14  H.J. Lu  <hongjiu.lu@intel.com>\n \n \tPR gas/26115"
    },
    {
      "sha": "b512f7a36bace6b48773f959469371dffbcf306f",
      "filename": "gas/config/tc-xtensa.c",
      "status": "modified",
      "additions": 25,
      "deletions": 4,
      "changes": 29,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/config/tc-xtensa.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/config/tc-xtensa.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-xtensa.c?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -31,8 +31,12 @@\n #include \"elf/xtensa.h\"\n \n /* Provide default values for new configuration settings.  */\n-#ifndef XSHAL_ABI\n-#define XSHAL_ABI 0\n+#ifndef XTHAL_ABI_WINDOWED\n+#define XTHAL_ABI_WINDOWED 0\n+#endif\n+\n+#ifndef XTHAL_ABI_CALL0\n+#define XTHAL_ABI_CALL0 1\n #endif\n \n #ifndef XTENSA_MARCH_EARLIEST\n@@ -648,6 +652,10 @@ static bfd_boolean workaround_all_short_loops = FALSE;\n    This option is defined in BDF library.  */\n extern bfd_boolean elf32xtensa_separate_props;\n \n+/* Xtensa ABI.\n+   This option is defined in BDF library.  */\n+extern int elf32xtensa_abi;\n+\n static void\n xtensa_setup_hw_workarounds (int earliest, int latest)\n {\n@@ -735,6 +743,9 @@ enum\n \n   option_separate_props,\n   option_no_separate_props,\n+\n+  option_abi_windowed,\n+  option_abi_call0,\n };\n \n const char *md_shortopts = \"\";\n@@ -816,6 +827,9 @@ struct option md_longopts[] =\n \n   { \"separate-prop-tables\", no_argument, NULL, option_separate_props },\n \n+  { \"abi-windowed\", no_argument, NULL, option_abi_windowed },\n+  { \"abi-call0\", no_argument, NULL, option_abi_call0 },\n+\n   { NULL, no_argument, NULL, 0 }\n };\n \n@@ -1044,6 +1058,14 @@ md_parse_option (int c, const char *arg)\n       elf32xtensa_separate_props = FALSE;\n       return 1;\n \n+    case option_abi_windowed:\n+      elf32xtensa_abi = XTHAL_ABI_WINDOWED;\n+      return 1;\n+\n+    case option_abi_call0:\n+      elf32xtensa_abi = XTHAL_ABI_CALL0;\n+      return 1;\n+\n     default:\n       return 0;\n     }\n@@ -8958,7 +8980,6 @@ is_local_forward_loop (const TInsn *insn, fragS *fragP)\n   return FALSE;\n }\n \n-\n #define XTINFO_NAME \"Xtensa_Info\"\n #define XTINFO_NAMESZ 12\n #define XTINFO_TYPE 1\n@@ -8975,7 +8996,7 @@ xtensa_add_config_info (void)\n \n   data = XNEWVEC (char, 100);\n   sprintf (data, \"USE_ABSOLUTE_LITERALS=%d\\nABI=%d\\n\",\n-\t   XSHAL_USE_ABSOLUTE_LITERALS, XSHAL_ABI);\n+\t   XSHAL_USE_ABSOLUTE_LITERALS, xtensa_abi_choice ());\n   sz = strlen (data) + 1;\n \n   /* Add enough null terminators to pad to a word boundary.  */"
    },
    {
      "sha": "f8d892eaa5c1771237189a6963285fb60e6a3197",
      "filename": "gas/doc/as.texi",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/doc/as.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/doc/as.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/doc/as.texi?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -626,6 +626,7 @@ gcc(1), ld(1), and the Info entries for @file{binutils} and @file{ld}.\n  [@b{--[no-]transform}]\n  [@b{--rename-section} @var{oldname}=@var{newname}]\n  [@b{--[no-]trampolines}]\n+ [@b{--abi-windowed}|@b{--abi-call0}]\n @end ifset\n @ifset Z80\n "
    },
    {
      "sha": "b17ee83dbf4f1fa4372a60e9a96ec62b7aa088a8",
      "filename": "gas/doc/c-xtensa.texi",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/doc/c-xtensa.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/doc/c-xtensa.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/doc/c-xtensa.texi?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -122,6 +122,14 @@ across a greater range of addresses.  @xref{Xtensa Jump Relaxation,\n potentially be out of range.  In the absence of such jumps this option\n does not affect code size or performance.  The default is\n @samp{--trampolines}.\n+\n+@item --abi-windowed | --abi-call0\n+@kindex --abi-windowed\n+@kindex --abi-call0\n+Choose ABI tag written to the @code{.xtensa.info} section.  ABI tag\n+indicates ABI of the assembly code.  A warning is issued by the linker\n+on an attempt to link object files with inconsistent ABI tags.\n+Default ABI is chosen by the Xtensa core configuration.\n @end table\n \n @c man end"
    },
    {
      "sha": "83ff10d708deab98d29e0f245ab5481f699bb6c5",
      "filename": "gas/testsuite/gas/xtensa/abi-call0.d",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi-call0.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi-call0.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/abi-call0.d?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -0,0 +1,7 @@\n+#as: --abi-call0\n+#objdump: -j .xtensa.info -s\n+#source: abi.s\n+\n+#...\n+.*ABI=1.*\n+#..."
    },
    {
      "sha": "9f10fd03697132f5ef224d0d09ee93d1be08968d",
      "filename": "gas/testsuite/gas/xtensa/abi-windowed.d",
      "status": "added",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi-windowed.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi-windowed.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/abi-windowed.d?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -0,0 +1,7 @@\n+#as: --abi-windowed\n+#objdump: -j .xtensa.info -s\n+#source: abi.s\n+\n+#...\n+.*ABI=0.*\n+#..."
    },
    {
      "sha": "09cc1e1f7cd89deaf06704cee3949850eacc6d9b",
      "filename": "gas/testsuite/gas/xtensa/abi.s",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/gas/testsuite/gas/xtensa/abi.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/xtensa/abi.s?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -0,0 +1 @@\n+\t.text"
    },
    {
      "sha": "7201be9f4d1ea64c882d6dfc0270cff0162d2734",
      "filename": "include/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/include/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/include/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/include/ChangeLog?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -1,3 +1,7 @@\n+2020-06-15  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* elf/xtensa.h (xtensa_abi_choice): New declaration.\n+\n 2020-06-12  Roland McGrath  <mcgrathr@google.com>\n \n \t* bfdlink.h (struct bfd_link_info): New field start_stop_visibility."
    },
    {
      "sha": "eac1a15dc33695b164ef2fa8098212a8e9721a3b",
      "filename": "include/elf/xtensa.h",
      "status": "modified",
      "additions": 3,
      "deletions": 0,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/include/elf/xtensa.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/include/elf/xtensa.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/include/elf/xtensa.h?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -225,6 +225,9 @@ xtensa_read_table_entries (bfd *abfd,\n extern int\n xtensa_compute_fill_extra_space (property_table_entry *entry);\n \n+extern int\n+xtensa_abi_choice (void);\n+\n #ifdef __cplusplus\n }\n #endif"
    },
    {
      "sha": "73a99a061e72d87c5155216ac722fd5362e5e577",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -1,3 +1,25 @@\n+2020-06-15  Max Filippov  <jcmvbkbc@gmail.com>\n+\n+\t* emultempl/xtensaelf.em (XSHAL_ABI): Remove macro definition.\n+\t(XTHAL_ABI_UNDEFINED, XTHAL_ABI_WINDOWED, XTHAL_ABI_CALL0): New\n+\tmacros.\n+\t(elf32xtensa_abi): New declaration.\n+\t(xt_config_info_unpack_and_check): Set elf32xtensa_abi if it is\n+\tundefined.  Use xtensa_abi_choice instead of XSHAL_ABI to test\n+\tABI tag consistency.\n+\t(xtensa_add_config_info): Use xtensa_abi_choice instead of\n+\tXSHAL_ABI to format ABI tag.\n+\t(PARSE_AND_LIST_PROLOGUE): Define OPTION_ABI_WINDOWED,\n+\tOPTION_ABI_CALL0 and declare elf32xtensa_abi.\n+\t(PARSE_AND_LIST_LONGOPTS): Add entries for --abi-windowed and\n+\t--abi-call0.\n+\t(PARSE_AND_LIST_OPTIONS): Add help text for --abi-windowed and\n+\t--abi-call0.\n+\t(PARSE_AND_LIST_ARGS_CASES): Add handlers for --abi-windowed and\n+\t--abi-call0.\n+\t* ld.texi: Add description for options --abi-windowed and\n+\t--abi-call0.\n+\n 2020-06-15  Roland McGrath  <mcgrathr@google.com>\n \n \t* NEWS: Mention -z start-stop-visibility=... option for ELF."
    },
    {
      "sha": "53f40c22830354eb44f9c3bddcc2de967b41a4c9",
      "filename": "ld/emultempl/xtensaelf.em",
      "status": "modified",
      "additions": 36,
      "deletions": 5,
      "changes": 41,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/emultempl/xtensaelf.em",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/emultempl/xtensaelf.em",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emultempl/xtensaelf.em?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -30,8 +30,16 @@ fragment <<EOF\n #include \"bfd.h\"\n \n /* Provide default values for new configuration settings.  */\n-#ifndef XSHAL_ABI\n-#define XSHAL_ABI 0\n+#ifndef XTHAL_ABI_UNDEFINED\n+#define XTHAL_ABI_UNDEFINED -1\n+#endif\n+\n+#ifndef XTHAL_ABI_WINDOWED\n+#define XTHAL_ABI_WINDOWED 0\n+#endif\n+\n+#ifndef XTHAL_ABI_CALL0\n+#define XTHAL_ABI_CALL0 1\n #endif\n \n static void xtensa_wild_group_interleave (lang_statement_union_type *);\n@@ -49,6 +57,10 @@ static bfd_boolean xtensa_use_literal_pages = FALSE;\n \n #define EXTRA_VALIDATION 0\n \n+/* Xtensa ABI.\n+   This option is defined in BDF library.  */\n+extern int elf32xtensa_abi;\n+\n \n static char *\n elf_xtensa_choose_target (int argc ATTRIBUTE_UNUSED,\n@@ -306,7 +318,7 @@ xt_config_info_unpack_and_check (char *data,\n \t\t\t\t char **pmsg)\n {\n   char *d, *key;\n-  unsigned num;\n+  int num;\n \n   *pmismatch = FALSE;\n \n@@ -341,7 +353,11 @@ xt_config_info_unpack_and_check (char *data,\n \n \t  if (! strcmp (key, \"ABI\"))\n \t    {\n-\t      if (num != XSHAL_ABI)\n+\t      if (elf32xtensa_abi == XTHAL_ABI_UNDEFINED)\n+\t\t{\n+\t\t  elf32xtensa_abi = num;\n+\t\t}\n+\t      else if (num != elf32xtensa_abi)\n \t\t{\n \t\t  *pmismatch = TRUE;\n \t\t  *pmsg = \"ABI does not match\";\n@@ -489,7 +505,7 @@ elf_xtensa_before_allocation (void)\n \n       data = xmalloc (100);\n       sprintf (data, \"USE_ABSOLUTE_LITERALS=%d\\nABI=%d\\n\",\n-\t       XSHAL_USE_ABSOLUTE_LITERALS, XSHAL_ABI);\n+\t       XSHAL_USE_ABSOLUTE_LITERALS, xtensa_abi_choice ());\n       xtensa_info_size = strlen (data) + 1;\n \n       /* Add enough null terminators to pad to a word boundary.  */\n@@ -1920,20 +1936,29 @@ PARSE_AND_LIST_PROLOGUE='\n #define OPTION_OPT_SIZEOPT              (300)\n #define OPTION_LITERAL_MOVEMENT\t\t(OPTION_OPT_SIZEOPT + 1)\n #define OPTION_NO_LITERAL_MOVEMENT\t(OPTION_LITERAL_MOVEMENT + 1)\n+#define OPTION_ABI_WINDOWED\t\t(OPTION_NO_LITERAL_MOVEMENT + 1)\n+#define OPTION_ABI_CALL0\t\t(OPTION_ABI_WINDOWED + 1)\n extern int elf32xtensa_size_opt;\n extern int elf32xtensa_no_literal_movement;\n+extern int elf32xtensa_abi;\n '\n \n PARSE_AND_LIST_LONGOPTS='\n   { \"size-opt\", no_argument, NULL, OPTION_OPT_SIZEOPT},\n   { \"literal-movement\", no_argument, NULL, OPTION_LITERAL_MOVEMENT},\n   { \"no-literal-movement\", no_argument, NULL, OPTION_NO_LITERAL_MOVEMENT},\n+  { \"abi-windowed\", no_argument, NULL, OPTION_ABI_WINDOWED},\n+  { \"abi-call0\", no_argument, NULL, OPTION_ABI_CALL0},\n '\n \n PARSE_AND_LIST_OPTIONS='\n   fprintf (file, _(\"\\\n   --size-opt                  When relaxing longcalls, prefer size\\n\\\n                                 optimization over branch target alignment\\n\"));\n+  fprintf (file, _(\"\\\n+  --abi-windowed              Choose windowed ABI for the output object\\n\"));\n+  fprintf (file, _(\"\\\n+  --abi-call0                 Choose call0 ABI for the output object\\n\"));\n '\n \n PARSE_AND_LIST_ARGS_CASES='\n@@ -1946,6 +1971,12 @@ PARSE_AND_LIST_ARGS_CASES='\n     case OPTION_NO_LITERAL_MOVEMENT:\n       elf32xtensa_no_literal_movement = 1;\n       break;\n+    case OPTION_ABI_WINDOWED:\n+      elf32xtensa_abi = XTHAL_ABI_WINDOWED;\n+      break;\n+    case OPTION_ABI_CALL0:\n+      elf32xtensa_abi = XTHAL_ABI_CALL0;\n+      break;\n '\n \n # Replace some of the standard ELF functions with our own versions."
    },
    {
      "sha": "ecdbf775eb3e9669e18b20634c99326beb7d4d0c",
      "filename": "ld/ld.texi",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/ld.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a77f1ac2c6f899faa39e8c0b42d4284d586c44e/ld/ld.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ld.texi?ref=7a77f1ac2c6f899faa39e8c0b42d4284d586c44e",
      "patch": "@@ -8565,6 +8565,17 @@ more than performance.  With this option, the linker will not insert\n no-ops or widen density instructions to preserve branch target\n alignment.  There may still be some cases where no-ops are required to\n preserve the correctness of the code.\n+\n+@item --abi-windowed\n+@itemx --abi-call0\n+Choose ABI for the output object and for the generated PLT code.\n+PLT code inserted by the linker must match ABI of the output object\n+because windowed and call0 ABI use incompatible function call\n+conventions.\n+Default ABI is chosen by the ABI tag in the @code{.xtensa.info} section\n+of the first input object.\n+A warning is issued if ABI tags of input objects do not match each other\n+or the chosen output object ABI.\n @end table\n \n @ifclear GENERIC"
    }
  ]
}