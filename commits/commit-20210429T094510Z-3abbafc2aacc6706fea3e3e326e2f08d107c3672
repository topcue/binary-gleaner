{
  "sha": "3abbafc2aacc6706fea3e3e326e2f08d107c3672",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6M2FiYmFmYzJhYWNjNjcwNmZlYTNlM2UzMjZlMmYwOGQxMDdjMzY3Mg==",
  "commit": {
    "author": {
      "name": "Jan Beulich",
      "email": "jbeulich@suse.com",
      "date": "2021-04-29T09:45:10Z"
    },
    "committer": {
      "name": "Jan Beulich",
      "email": "jbeulich@suse.com",
      "date": "2021-04-29T09:45:10Z"
    },
    "message": "x86: relax when/how @size can be used\n\nAllow a few more expression forms when the entire expression can be\nresolved at assembly time. For this, i386_validate_fix() needs to\narrange for all processing of the relocation to be deferred to\ntc_gen_reloc().",
    "tree": {
      "sha": "8762f858f41c93ef736b2fef06a8b5afc07d83de",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/8762f858f41c93ef736b2fef06a8b5afc07d83de"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/3abbafc2aacc6706fea3e3e326e2f08d107c3672",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3abbafc2aacc6706fea3e3e326e2f08d107c3672",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/3abbafc2aacc6706fea3e3e326e2f08d107c3672",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3abbafc2aacc6706fea3e3e326e2f08d107c3672/comments",
  "author": {
    "login": "jbeulich",
    "id": 5610135,
    "node_id": "MDQ6VXNlcjU2MTAxMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5610135?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jbeulich",
    "html_url": "https://github.com/jbeulich",
    "followers_url": "https://api.github.com/users/jbeulich/followers",
    "following_url": "https://api.github.com/users/jbeulich/following{/other_user}",
    "gists_url": "https://api.github.com/users/jbeulich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jbeulich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jbeulich/subscriptions",
    "organizations_url": "https://api.github.com/users/jbeulich/orgs",
    "repos_url": "https://api.github.com/users/jbeulich/repos",
    "events_url": "https://api.github.com/users/jbeulich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jbeulich/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "jbeulich",
    "id": 5610135,
    "node_id": "MDQ6VXNlcjU2MTAxMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5610135?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jbeulich",
    "html_url": "https://github.com/jbeulich",
    "followers_url": "https://api.github.com/users/jbeulich/followers",
    "following_url": "https://api.github.com/users/jbeulich/following{/other_user}",
    "gists_url": "https://api.github.com/users/jbeulich/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jbeulich/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jbeulich/subscriptions",
    "organizations_url": "https://api.github.com/users/jbeulich/orgs",
    "repos_url": "https://api.github.com/users/jbeulich/repos",
    "events_url": "https://api.github.com/users/jbeulich/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jbeulich/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "44f871628ccfcfd931f4619c60554f3bd6b57b8d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/44f871628ccfcfd931f4619c60554f3bd6b57b8d",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/44f871628ccfcfd931f4619c60554f3bd6b57b8d"
    }
  ],
  "stats": {
    "total": 147,
    "additions": 138,
    "deletions": 9
  },
  "files": [
    {
      "sha": "a44b880423965bd6a4f95b504d533415ab2ba1aa",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -1,3 +1,17 @@\n+2021-04-29  Jan Beulich  <jbeulich@suse.com>\n+\n+\t* config/tc-i386.c (i386_validate_fix): Change return type to\n+\tint. Short-circuit BFD_RELOC_SIZE* handling.\n+\t(tc_gen_reloc): New local variable sym. Extend logic when\n+\tprocessing BFD_RELOC_SIZE*.\n+\t* config/tc-i386.f (i386_validate_fix): Change return type to\n+\tint.\n+\t(TC_VALIDATE_FIX): Proceed to SKIP when i386_validate_fix()\n+\treturns zero.\n+\t* testsuite/gas/i386/size-5.s, testsuite/gas/i386/size-5a.d,\n+\ttestsuite/gas/i386/size-5b.d: New.\n+\t* testsuite/gas/i386/i386.exp: Run new tests.\n+\n 2021-04-29  Jan Beulich  <jbeulich@suse.com>\n \n \t* config/tc-i386.c (tc_gen_reloc): Use section size for section"
    },
    {
      "sha": "8bd725ab5883bfde56db2416d818691e63da4bae",
      "filename": "gas/config/tc-i386.c",
      "status": "modified",
      "additions": 43,
      "deletions": 7,
      "changes": 50,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/config/tc-i386.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/config/tc-i386.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-i386.c?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -14173,9 +14173,17 @@ i386_cons_align (int ignore ATTRIBUTE_UNUSED)\n     }\n }\n \n-void\n+int\n i386_validate_fix (fixS *fixp)\n {\n+#if defined (OBJ_ELF) || defined (OBJ_MAYBE_ELF)\n+  if (fixp->fx_r_type == BFD_RELOC_SIZE32\n+      || fixp->fx_r_type == BFD_RELOC_SIZE64)\n+    return IS_ELF && fixp->fx_addsy\n+\t   && (!S_IS_DEFINED (fixp->fx_addsy)\n+\t       || S_IS_EXTERNAL (fixp->fx_addsy));\n+#endif\n+\n   if (fixp->fx_subsy)\n     {\n       if (fixp->fx_subsy == GOT_symbol)\n@@ -14222,6 +14230,8 @@ i386_validate_fix (fixS *fixp)\n \t}\n     }\n #endif\n+\n+  return 1;\n }\n \n arelent *\n@@ -14233,18 +14243,38 @@ tc_gen_reloc (asection *section ATTRIBUTE_UNUSED, fixS *fixp)\n   switch (fixp->fx_r_type)\n     {\n #if defined (OBJ_ELF) || defined (OBJ_MAYBE_ELF)\n+      symbolS *sym;\n+\n     case BFD_RELOC_SIZE32:\n     case BFD_RELOC_SIZE64:\n-      if (IS_ELF\n-\t  && S_IS_DEFINED (fixp->fx_addsy)\n-\t  && !S_IS_EXTERNAL (fixp->fx_addsy))\n+      if (fixp->fx_addsy\n+\t  && !bfd_is_abs_section (S_GET_SEGMENT (fixp->fx_addsy))\n+\t  && (!fixp->fx_subsy\n+\t      || bfd_is_abs_section (S_GET_SEGMENT (fixp->fx_subsy))))\n+\tsym = fixp->fx_addsy;\n+      else if (fixp->fx_subsy\n+\t       && !bfd_is_abs_section (S_GET_SEGMENT (fixp->fx_subsy))\n+\t       && (!fixp->fx_addsy\n+\t\t   || bfd_is_abs_section (S_GET_SEGMENT (fixp->fx_addsy))))\n+\tsym = fixp->fx_subsy;\n+      else\n+\tsym = NULL;\n+      if (IS_ELF && sym && S_IS_DEFINED (sym) && !S_IS_EXTERNAL (sym))\n \t{\n \t  /* Resolve size relocation against local symbol to size of\n \t     the symbol plus addend.  */\n-\t  valueT value = S_GET_SIZE (fixp->fx_addsy);\n+\t  valueT value = S_GET_SIZE (sym);\n \n-\t  if (symbol_get_bfdsym (fixp->fx_addsy)->flags & BSF_SECTION_SYM)\n-\t    value = bfd_section_size (S_GET_SEGMENT (fixp->fx_addsy));\n+\t  if (symbol_get_bfdsym (sym)->flags & BSF_SECTION_SYM)\n+\t    value = bfd_section_size (S_GET_SEGMENT (sym));\n+\t  if (sym == fixp->fx_subsy)\n+\t    {\n+\t      value = -value;\n+\t      if (fixp->fx_addsy)\n+\t        value += S_GET_VALUE (fixp->fx_addsy);\n+\t    }\n+\t  else if (fixp->fx_subsy)\n+\t    value -= S_GET_VALUE (fixp->fx_subsy);\n \t  value += fixp->fx_offset;\n \t  if (fixp->fx_r_type == BFD_RELOC_SIZE32\n \t      && object_64bit\n@@ -14256,6 +14286,12 @@ tc_gen_reloc (asection *section ATTRIBUTE_UNUSED, fixS *fixp)\n \t  md_apply_fix (fixp, (valueT *) &value, NULL);\n \t  return NULL;\n \t}\n+      if (!fixp->fx_addsy || fixp->fx_subsy)\n+\t{\n+\t  as_bad_where (fixp->fx_file, fixp->fx_line,\n+\t\t\t\"unsupported expression involving @size\");\n+\t  return NULL;\n+\t}\n #endif\n       /* Fall through.  */\n "
    },
    {
      "sha": "5516a164aa58d10d868adcb33dba8857d2606227",
      "filename": "gas/config/tc-i386.h",
      "status": "modified",
      "additions": 4,
      "deletions": 2,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/config/tc-i386.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/config/tc-i386.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/config/tc-i386.h?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -143,8 +143,10 @@ extern int x86_address_bytes (void);\n \n #define NO_RELOC BFD_RELOC_NONE\n \n-void i386_validate_fix (struct fix *);\n-#define TC_VALIDATE_FIX(FIX,SEGTYPE,SKIP) i386_validate_fix(FIX)\n+int i386_validate_fix (struct fix *);\n+#define TC_VALIDATE_FIX(FIX,SEGTYPE,SKIP) do { \\\n+    if (!i386_validate_fix(FIX)) goto SKIP;      \\\n+  } while (0)\n \n #define tc_fix_adjustable(X)  tc_i386_fix_adjustable(X)\n extern int tc_i386_fix_adjustable (struct fix *);"
    },
    {
      "sha": "ae01c8996d8e41990003ed35a8f22cceed5c56c0",
      "filename": "gas/testsuite/gas/i386/i386.exp",
      "status": "modified",
      "additions": 2,
      "deletions": 0,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/i386.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/i386.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/i386.exp?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -637,6 +637,8 @@ if [gas_32_check] then {\n \trun_dump_test \"size-2\"\n \trun_dump_test \"size-3\"\n \trun_dump_test \"size-4\"\n+\trun_dump_test \"size-5a\"\n+\trun_dump_test \"size-5b\"\n \n \trun_dump_test \"note\"\n "
    },
    {
      "sha": "a870c286b85a05795b26c4c47d4487697560d1d4",
      "filename": "gas/testsuite/gas/i386/size-5.s",
      "status": "added",
      "additions": 32,
      "deletions": 0,
      "changes": 32,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/size-5.s?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -0,0 +1,32 @@\n+\t.text\n+size:\n+\tmov\t$size@size, %eax\n+\tmov\t$size@size + val, %eax\n+\tmov\t$-size@size, %ecx\n+\tmov\t$0 - size@size, %ecx\n+\tmov\t$0x100 - size@size, %edx\n+\tmov\t$val - size@size, %edx\n+\n+\tlea\tsize@size, %eax\n+\tlea\tsize@size + val, %eax\n+\tlea\t-size@size, %ecx\n+\tlea\t0 - size@size, %ecx\n+\tlea\t0x100 - size@size, %edx\n+\tlea\tval - size@size, %edx\n+\n+\tret\n+\t.size size, . - size\n+\n+\t.data\n+\t.p2align 2\n+\t.long\tsize@size\n+\t.long\tsize@size + val\n+\t.long\t-size@size\n+\t.long\t0 - size@size\n+\t.long\t0x100 - size@size\n+\t.long\tval - size@size\n+\n+\t.long\text@size\n+\t.long\text@size + val\n+\n+\t.equ val, 0x1000"
    },
    {
      "sha": "56d034225c25ed54d294a0399b722a3277a6f941",
      "filename": "gas/testsuite/gas/i386/size-5a.d",
      "status": "added",
      "additions": 28,
      "deletions": 0,
      "changes": 28,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5a.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5a.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/size-5a.d?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -0,0 +1,28 @@\n+#name: i386 size 5 (text)\n+#source: size-5.s\n+#objdump: -dtwr\n+\n+.*: +file format .*\n+\n+SYMBOL TABLE:\n+0*0 l +\\.text\t0*43 size\n+0*1000 l +\\*ABS\\*\t0*0 val\n+0*0 +\\*UND\\*\t0*0 ext\n+\n+Disassembly of section .text:\n+\n+0+ <size>:\n+[ \t]*[a-f0-9]+:\tb8 43 00 00 00       \tmov    \\$0x43,%eax\n+[ \t]*[a-f0-9]+:\tb8 43 10 00 00       \tmov    \\$0x1043,%eax\n+[ \t]*[a-f0-9]+:\tb9 bd ff ff ff       \tmov    \\$0xffffffbd,%ecx\n+[ \t]*[a-f0-9]+:\tb9 bd ff ff ff       \tmov    \\$0xffffffbd,%ecx\n+[ \t]*[a-f0-9]+:\tba bd 00 00 00       \tmov    \\$0xbd,%edx\n+[ \t]*[a-f0-9]+:\tba bd 0f 00 00       \tmov    \\$0xfbd,%edx\n+[ \t]*[a-f0-9]+:\t8d 05 43 00 00 00    \tlea    0x43,%eax\n+[ \t]*[a-f0-9]+:\t8d 05 43 10 00 00    \tlea    0x1043,%eax\n+[ \t]*[a-f0-9]+:\t8d 0d bd ff ff ff    \tlea    0xffffffbd,%ecx\n+[ \t]*[a-f0-9]+:\t8d 0d bd ff ff ff    \tlea    0xffffffbd,%ecx\n+[ \t]*[a-f0-9]+:\t8d 15 bd 00 00 00    \tlea    0xbd,%edx\n+[ \t]*[a-f0-9]+:\t8d 15 bd 0f 00 00    \tlea    0xfbd,%edx\n+[ \t]*[a-f0-9]+:\tc3                   \tret *\n+#pass"
    },
    {
      "sha": "8439801daaa677eee23a1fd71dad450a92c1b0b7",
      "filename": "gas/testsuite/gas/i386/size-5b.d",
      "status": "added",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5b.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/3abbafc2aacc6706fea3e3e326e2f08d107c3672/gas/testsuite/gas/i386/size-5b.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/size-5b.d?ref=3abbafc2aacc6706fea3e3e326e2f08d107c3672",
      "patch": "@@ -0,0 +1,15 @@\n+#name: i386 size 5 (data)\n+#source: size-5.s\n+#objdump: -rsj .data\n+\n+.*: +file format .*\n+\n+RELOCATION RECORDS FOR \\[\\.data\\]:\n+\n+OFFSET +TYPE +VALUE *\n+0*18 R_386_SIZE32 *ext\n+0*1c R_386_SIZE32 *ext\n+\n+Contents of section .data:\n+ 0+00 43 ?00 ?00 ?00 43 ?10 ?00 ?00 bd ?ff ?ff ?ff bd ?ff ?ff ?ff .*\n+ 0+10 bd ?00 ?00 ?00 bd ?0f ?00 ?00 00 ?00 ?00 ?00 00 ?10 ?00 ?00 .*"
    }
  ]
}