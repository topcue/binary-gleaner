{
  "sha": "32a1adcccf05f98e95a2a451066af810e121bdd9",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzJhMWFkY2NjZjA1Zjk4ZTk1YTJhNDUxMDY2YWY4MTBlMTIxYmRkOQ==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-09-18T19:13:25Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-09-23T21:35:05Z"
    },
    "message": "gdb/readline: fix use of an undefined variable\n\nThis commit in binutils-gdb:\n\n  commit 830b67068cebe7db0eb0db3fa19244e03859fae0\n  Date:   Fri Jul 12 09:53:02 2019 +0200\n\n      [readline] Fix heap-buffer-overflow in update_line\n\nWhich corresponds to this commit in upstream readline:\n\n  commit 31547b4ea4a1a904e1b08e2bc4b4ebd5042aedaa\n  Date:   Mon Aug 5 10:24:27 2019 -0400\n\n      commit readline-20190805 snapshot\n\nIntroduced a use of an undefined variable, which can be seen using\nvalgrind:\n\n  $ valgrind --tool=memcheck gdb\n  GNU gdb (GDB) 8.3.50.20190918-git\n  Copyright (C) 2019 Free Software Foundation, Inc.\n  License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\n  This is free software: you are free to change and redistribute it.\n  There is NO WARRANTY, to the extent permitted by law.\n  Type \"show copying\" and \"show warranty\" for details.\n  This GDB was configured as \"x86_64-pc-linux-gnu\".\n  Type \"show configuration\" for configuration details.\n  For bug reporting instructions, please see:\n  <http://www.gnu.org/software/gdb/bugs/>.\n  Find the GDB manual and other documentation resources online at:\n      <http://www.gnu.org/software/gdb/documentation/>.\n\n  For help, type \"help\".\n  Type \"apropos word\" to search for commands related to \"word\".\n  ==24924== Conditional jump or move depends on uninitialised value(s)\n  ==24924==    at 0x9986C3: rl_redisplay (display.c:710)\n  ==24924==    by 0x9839CE: readline_internal_setup (readline.c:447)\n  ==24924==    by 0x9A1C2B: _rl_callback_newline (callback.c:100)\n  ==24924==    by 0x9A1C85: rl_callback_handler_install (callback.c:111)\n  ==24924==    by 0x6195EB: gdb_rl_callback_handler_install(char const*) (event-top.c:319)\n  ==24924==    by 0x61975E: display_gdb_prompt(char const*) (event-top.c:409)\n  ==24924==    by 0x4FBFE3: cli_interp_base::pre_command_loop() (cli-interp.c:286)\n  ==24924==    by 0x6E53DA: interp_pre_command_loop(interp*) (interps.c:321)\n  ==24924==    by 0x731F30: captured_command_loop() (main.c:334)\n  ==24924==    by 0x733568: captured_main(void*) (main.c:1182)\n  ==24924==    by 0x7335CE: gdb_main(captured_main_args*) (main.c:1197)\n  ==24924==    by 0x41325D: main (gdb.c:32)\n  ==24924==\n  (gdb)\n\nThe problem can be traced back to init_line_structures.  The very\nfirst time this function is ever called its MINSIZE parameter is\nalways 0 and the global LINE_SIZE is 1024.  Prior to the above\nmentioned commits we spot that the line_state variables have not yet\nbeen initialised, and allocate them some new buffer, then we enter\nthis loop:\n\n  for (n = minsize; n < line_size; n++)\n    {\n      visible_line[n] = 0;\n      invisible_line[n] = 1;\n    }\n\nwhich would initialise everything from the incoming minimum up to the\npotentially extended upper line size.\n\nThe problem is that the above patches added a new condition that would\nbump up the minsize like this:\n\n  if (minsize <= _rl_screenwidth)\t/* XXX - for gdb */\n    minsize = _rl_screenwidth + 1;\n\nSo, the first time this function is called the incoming MINSIZE is 0,\nthe LINE_SIZE global is 1024, and if the _rl_screenwidth is 80, we see\nthat MINSIZE will be pushed up to 80.  We still notice that the line\nstate is uninitialised and allocate some buffers, then we enter the\ninitialisation loop:\n\n  for (n = minsize; n < line_size; n++)\n    {\n      visible_line[n] = 0;\n      invisible_line[n] = 1;\n    }\n\nAnd initialise from 80 to 1023 i the newly allocated buffers, leaving\n0 to 79 uninitialised.\n\nTo confirm this is an issue, if we then look at rl_redisplay we see\nthat a call to init_line_structures is followed first by a call to\nrl_on_new_line, which does initialise visible_line[0], but not\ninvisible_line[0].  Later in rl_redisplay we have this logic:\n\n  if (visible_line[0] != invisible_line[0])\n    rl_display_fixed = 0;\n\nThe use of invisible_line[0] here will be undefined.\n\nConsidering how this variable was originally initialised before the\nabove patches, this patch modifies the initialisation loop in\ninit_line_structures, to use the original value of MINSIZE.  With this\nchange the valgrind warning goes away.\n\nreadline/ChangeLog:\n\n\tPR cli/24980\n\t* display.c (init_line_structures): Initialise line_state using\n\toriginal minsize value.",
    "tree": {
      "sha": "00b7f851f02fe7dcde14757c9a35343d704104ff",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/00b7f851f02fe7dcde14757c9a35343d704104ff"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/32a1adcccf05f98e95a2a451066af810e121bdd9",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/32a1adcccf05f98e95a2a451066af810e121bdd9",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/32a1adcccf05f98e95a2a451066af810e121bdd9",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/32a1adcccf05f98e95a2a451066af810e121bdd9/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e2e9097bd21406f09fdf57fee0d99e6b45de61b6",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e2e9097bd21406f09fdf57fee0d99e6b45de61b6",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/e2e9097bd21406f09fdf57fee0d99e6b45de61b6"
    }
  ],
  "stats": {
    "total": 9,
    "additions": 8,
    "deletions": 1
  },
  "files": [
    {
      "sha": "49e9fba5ad21cc4eb1a31c772d43bc75ba9dad7d",
      "filename": "readline/ChangeLog.gdb",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/32a1adcccf05f98e95a2a451066af810e121bdd9/readline/ChangeLog.gdb",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/32a1adcccf05f98e95a2a451066af810e121bdd9/readline/ChangeLog.gdb",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/readline/ChangeLog.gdb?ref=32a1adcccf05f98e95a2a451066af810e121bdd9",
      "patch": "@@ -1,3 +1,9 @@\n+2019-09-18  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\tPR cli/24980\n+\t* display.c (init_line_structures): Initialise line_state using\n+\toriginal minsize value.\n+\n 2019-08-13  Christian Biesinger  <cbiesinger@google.com>\n \n \t* colors.c (_rl_print_color_indicator): Remove unnecessary"
    },
    {
      "sha": "89193b572bc2f3681252f6c4fec978633e557678",
      "filename": "readline/display.c",
      "status": "modified",
      "additions": 2,
      "deletions": 1,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/32a1adcccf05f98e95a2a451066af810e121bdd9/readline/display.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/32a1adcccf05f98e95a2a451066af810e121bdd9/readline/display.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/readline/display.c?ref=32a1adcccf05f98e95a2a451066af810e121bdd9",
      "patch": "@@ -602,6 +602,7 @@ static void\n init_line_structures (int minsize)\n {\n   register int n;\n+  int original_minsize = minsize;\n \n   if (minsize <= _rl_screenwidth)\t/* XXX - for gdb */\n     minsize = _rl_screenwidth + 1;\n@@ -622,7 +623,7 @@ init_line_structures (int minsize)\n       invisible_line = (char *)xrealloc (invisible_line, line_size);\n     }\n \n-  for (n = minsize; n < line_size; n++)\n+  for (n = original_minsize; n < line_size; n++)\n     {\n       visible_line[n] = 0;\n       invisible_line[n] = 1;"
    }
  ]
}