{
  "sha": "ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZWJlODRmMjNkMmYzYzBjYjE0NWNjN2IzYWNmYjAxMWE0YzdkZjFjOQ==",
  "commit": {
    "author": {
      "name": "Pedro Alves",
      "email": "palves@redhat.com",
      "date": "2020-06-18T20:28:26Z"
    },
    "committer": {
      "name": "Pedro Alves",
      "email": "palves@redhat.com",
      "date": "2020-06-18T22:10:09Z"
    },
    "message": "Don't write to inferior_ptid in nto-procfs.c\n\nA best effort patch, which fixes some bit rot and removes some\ninferior_ptid references -- this port clearly hasn't been built in a\nlong while.\n\ngdb/ChangeLog:\n2020-06-18  Pedro Alves  <palves@redhat.com>\n\n\t* nto-procfs.c (nto_procfs_target::update_thread_list): Avoid\n\tinferior_ptid.\n\t(nto_procfs_target::attach): Avoid inferior_ptid.  Switch to\n\tthread.\n\t(nto_procfs_target::detach): Avoid referencing\n\tinferior_ptid.  Use switch_to_no_thread instead of writing to\n\tinferior_ptid directly.\n\t(nto_procfs_target::mourn_inferior): Use switch_to_no_thread\n\tinstead of writing to inferior_ptid directly.\n\t(nto_procfs_target::create_inferior): Avoid inferior_ptid.  Switch\n\tto thread.",
    "tree": {
      "sha": "6c1a6b60d0c6a684340f8af203b6cc07d4f2cdc1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/6c1a6b60d0c6a684340f8af203b6cc07d4f2cdc1"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9/comments",
  "author": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "191f02e59316d8ff15684d24e1c8f4d07b2dd582",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/191f02e59316d8ff15684d24e1c8f4d07b2dd582",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/191f02e59316d8ff15684d24e1c8f4d07b2dd582"
    }
  ],
  "stats": {
    "total": 38,
    "additions": 26,
    "deletions": 12
  },
  "files": [
    {
      "sha": "dc0202d33741abc7d08e37cb46d4e7aa9749089b",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 14,
      "deletions": 0,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
      "patch": "@@ -1,3 +1,17 @@\n+2020-06-18  Pedro Alves  <palves@redhat.com>\n+\n+\t* nto-procfs.c (nto_procfs_target::update_thread_list): Avoid\n+\tinferior_ptid.\n+\t(nto_procfs_target::attach): Avoid inferior_ptid.  Switch to\n+\tthread.\n+\t(nto_procfs_target::detach): Avoid referencing\n+\tinferior_ptid.  Use switch_to_no_thread instead of writing to\n+\tinferior_ptid directly.\n+\t(nto_procfs_target::mourn_inferior): Use switch_to_no_thread\n+\tinstead of writing to inferior_ptid directly.\n+\t(nto_procfs_target::create_inferior): Avoid inferior_ptid.  Switch\n+\tto thread.\n+\n 2020-06-18  Pedro Alves  <palves@redhat.com>\n \n \t* remote-sim.c (gdbsim_target::create_inferior): Switch to thread"
    },
    {
      "sha": "f649b6cf58bd9add321fc502f2d1c2f32a957698",
      "filename": "gdb/nto-procfs.c",
      "status": "modified",
      "additions": 12,
      "deletions": 12,
      "changes": 24,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9/gdb/nto-procfs.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9/gdb/nto-procfs.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/nto-procfs.c?ref=ebe84f23d2f3c0cb145cc7b3acfb011a4c7df1c9",
      "patch": "@@ -393,7 +393,7 @@ nto_procfs_target::update_thread_list ()\n \n   prune_threads ();\n \n-  pid = inferior_ptid.pid ();\n+  pid = current_inferior ()->pid;\n \n   status.tid = 1;\n \n@@ -712,15 +712,17 @@ nto_procfs_target::attach (const char *args, int from_tty)\n \tprintf_unfiltered (\"Attaching to %s\\n\",\n \t\t\t   target_pid_to_str (ptid_t (pid)).c_str ());\n     }\n-  inferior_ptid = do_attach (ptid_t (pid));\n+  ptid_t ptid = do_attach (ptid_t (pid));\n   inf = current_inferior ();\n   inferior_appeared (inf, pid);\n   inf->attach_flag = 1;\n \n   if (!target_is_pushed (ops))\n     push_target (ops);\n \n-  procfs_update_thread_list (ops);\n+  update_thread_list ();\n+\n+  switch_to_thread (find_thread_ptid (this, ptid));\n }\n \n void\n@@ -1000,19 +1002,16 @@ nto_procfs_target::xfer_partial (enum target_object object,\n void\n nto_procfs_target::detach (inferior *inf, int from_tty)\n {\n-  int pid;\n-\n   target_announce_detach ();\n \n   if (siggnal)\n-    SignalKill (nto_node (), inferior_ptid.pid (), 0, 0, 0, 0);\n+    SignalKill (nto_node (), inf->pid, 0, 0, 0, 0);\n \n   close (ctl_fd);\n   ctl_fd = -1;\n \n-  pid = inferior_ptid.pid ();\n-  inferior_ptid = null_ptid;\n-  detach_inferior (pid);\n+  switch_to_no_thread ();\n+  detach_inferior (inf->pid);\n   init_thread_list ();\n   inf_child_maybe_unpush_target (ops);\n }\n@@ -1132,7 +1131,7 @@ nto_procfs_target::mourn_inferior ()\n       SignalKill (nto_node (), inferior_ptid.pid (), 0, SIGKILL, 0, 0);\n       close (ctl_fd);\n     }\n-  inferior_ptid = null_ptid;\n+  switch_to_no_thread ();\n   init_thread_list ();\n   inf_child_mourn_inferior (ops);\n }\n@@ -1303,8 +1302,9 @@ nto_procfs_target::create_inferior (const char *exec_file,\n   if (fds[2] != STDERR_FILENO)\n     close (fds[2]);\n \n-  inferior_ptid = do_attach (ptid_t (pid));\n-  procfs_update_thread_list (ops);\n+  ptid_t ptid = do_attach (ptid_t (pid));\n+  update_thread_list ();\n+  switch_to_thread (find_thread_ptid (this, ptid));\n \n   inf = current_inferior ();\n   inferior_appeared (inf, pid);"
    }
  ]
}