{
  "sha": "b02db37812bef6e12772bfbddd004e50534eaed1",
  "node_id": "C_kwDOANOeidoAKGIwMmRiMzc4MTJiZWY2ZTEyNzcyYmZiZGRkMDA0ZTUwNTM0ZWFlZDE",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2022-01-12T02:07:27Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2022-01-12T02:25:17Z"
    },
    "message": "Set SEC_ELF_REVERSE_COPY earlier\n\nFor the sake of DT_RELR.\n\nbfd/\n\t* elflink.c (elf_link_input_bfd): Don't set SEC_ELF_REVERSE_COPY\n\there.  Move sanity checks to reverse copying code.\nld/\n\t* ldlang.c (lang_add_section): Set SEC_ELF_REVERSE_COPY for\n\t.ctors/.dtors in .init_array/.fini_array.",
    "tree": {
      "sha": "775ed5bbacbb532774161bd54e4e34b89f7c2f71",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/775ed5bbacbb532774161bd54e4e34b89f7c2f71"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b02db37812bef6e12772bfbddd004e50534eaed1",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b02db37812bef6e12772bfbddd004e50534eaed1",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b02db37812bef6e12772bfbddd004e50534eaed1",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b02db37812bef6e12772bfbddd004e50534eaed1/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "295114a64ff50cc79e4510b8be935ebccda2900a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/295114a64ff50cc79e4510b8be935ebccda2900a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/295114a64ff50cc79e4510b8be935ebccda2900a"
    }
  ],
  "stats": {
    "total": 52,
    "additions": 26,
    "deletions": 26
  },
  "files": [
    {
      "sha": "f5e3fd53c5d3147920bf9bc19d718e5e6f92f319",
      "filename": "bfd/elflink.c",
      "status": "modified",
      "additions": 16,
      "deletions": 26,
      "changes": 42,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b02db37812bef6e12772bfbddd004e50534eaed1/bfd/elflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b02db37812bef6e12772bfbddd004e50534eaed1/bfd/elflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elflink.c?ref=b02db37812bef6e12772bfbddd004e50534eaed1",
      "patch": "@@ -11247,31 +11247,6 @@ elf_link_input_bfd (struct elf_final_link_info *flinfo, bfd *input_bfd)\n \t      && o->reloc_count > 0)\n \t    return false;\n \n-\t  /* We need to reverse-copy input .ctors/.dtors sections if\n-\t     they are placed in .init_array/.finit_array for output.  */\n-\t  if (o->size > address_size\n-\t      && ((startswith (o->name, \".ctors\")\n-\t\t   && strcmp (o->output_section->name,\n-\t\t\t      \".init_array\") == 0)\n-\t\t  || (startswith (o->name, \".dtors\")\n-\t\t      && strcmp (o->output_section->name,\n-\t\t\t\t \".fini_array\") == 0))\n-\t      && (o->name[6] == 0 || o->name[6] == '.'))\n-\t    {\n-\t      if (o->size * bed->s->int_rels_per_ext_rel\n-\t\t  != o->reloc_count * address_size)\n-\t\t{\n-\t\t  _bfd_error_handler\n-\t\t    /* xgettext:c-format */\n-\t\t    (_(\"error: %pB: size of section %pA is not \"\n-\t\t       \"multiple of address size\"),\n-\t\t     input_bfd, o);\n-\t\t  bfd_set_error (bfd_error_bad_value);\n-\t\t  return false;\n-\t\t}\n-\t      o->flags |= SEC_ELF_REVERSE_COPY;\n-\t    }\n-\n \t  action_discarded = -1;\n \t  if (!elf_section_ignore_discarded_relocs (o))\n \t    action_discarded = (*bed->action_discarded) (o);\n@@ -11756,9 +11731,24 @@ elf_link_input_bfd (struct elf_final_link_info *flinfo, bfd *input_bfd)\n \n \t\toffset *= bfd_octets_per_byte (output_bfd, o);\n \n-\t\tif ((o->flags & SEC_ELF_REVERSE_COPY))\n+\t\tif ((o->flags & SEC_ELF_REVERSE_COPY)\n+\t\t    && o->size > address_size)\n \t\t  {\n \t\t    /* Reverse-copy input section to output.  */\n+\n+\t\t    if (o->reloc_count != 0\n+\t\t\t&& (o->size * bed->s->int_rels_per_ext_rel\n+\t\t\t    != o->reloc_count * address_size))\n+\t\t      {\n+\t\t\t_bfd_error_handler\n+\t\t\t  /* xgettext:c-format */\n+\t\t\t  (_(\"error: %pB: size of section %pA is not \"\n+\t\t\t     \"multiple of address size\"),\n+\t\t\t   input_bfd, o);\n+\t\t\tbfd_set_error (bfd_error_bad_value);\n+\t\t\treturn false;\n+\t\t      }\n+\n \t\t    do\n \t\t      {\n \t\t\ttodo -= address_size;"
    },
    {
      "sha": "0af6c60bce51033095dc0cf13380f0bea055ca0a",
      "filename": "ld/ldlang.c",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b02db37812bef6e12772bfbddd004e50534eaed1/ld/ldlang.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b02db37812bef6e12772bfbddd004e50534eaed1/ld/ldlang.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldlang.c?ref=b02db37812bef6e12772bfbddd004e50534eaed1",
      "patch": "@@ -2701,6 +2701,16 @@ lang_add_section (lang_statement_list_type *ptr,\n       output->block_value = 128;\n     }\n \n+  /* When a .ctors section is placed in .init_array it must be copied\n+     in reverse order.  Similarly for .dtors.  Set that up.  */\n+  if (bfd_get_flavour (link_info.output_bfd) == bfd_target_elf_flavour\n+      && ((startswith (section->name, \".ctors\")\n+\t   && strcmp (output->bfd_section->name, \".init_array\") == 0)\n+\t  || (startswith (section->name, \".dtors\")\n+\t      && strcmp (output->bfd_section->name, \".fini_array\") == 0))\n+      && (section->name[6] == 0 || section->name[6] == '.'))\n+    section->flags |= SEC_ELF_REVERSE_COPY;\n+\n   if (section->alignment_power > output->bfd_section->alignment_power)\n     output->bfd_section->alignment_power = section->alignment_power;\n "
    }
  ]
}