{
  "sha": "74e10d1742f1b8312359c59a2af06c9e661252b3",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NzRlMTBkMTc0MmYxYjgzMTIzNTljNTlhMmFmMDZjOWU2NjEyNTJiMw==",
  "commit": {
    "author": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-03-13T14:34:56Z"
    },
    "committer": {
      "name": "H.J. Lu",
      "email": "hjl.tools@gmail.com",
      "date": "2020-03-13T14:39:06Z"
    },
    "message": "x86: Check static link of dynamic objects\n\nOn Linux/x86, when -static is passed to gcc, gcc passes it to linker\nbefore all input files suitable for creating static executable.  X86\nlinker will report error for dynamic input objects if -static is passed\nat command-line before all input files without --dynamic-linker unless\n--no-dynamic-linker is used.\n\nbfd/\n\n\tPR ld/24920\n\t* elf-linker-x86.h (elf_linker_x86_params): Add\n\tstatic_before_all_inputs and has_dynamic_linker.\n\t* elfxx-x86.c (_bfd_x86_elf_link_setup_gnu_properties): Report\n\tdynamic input objects if -static is passed at command-line\n\tbefore all input files without --dynamic-linker unless\n\t--no-dynamic-linker is used.\n\nld/\n\n\tPR ld/24920\n\t* emulparams/elf32_x86_64.sh: Use static.sh.\n\t* emulparams/elf_i386.sh: Likewise.\n\t* emulparams/elf_x86_64.sh: Likewise.\n\t* emulparams/static.sh: New file.\n\t* emultempl/elf-x86.em: Include \"ldlex.h\".\n\t* testsuite/ld-elf/pr24920.err: New file.\n\t* testsuite/ld-elf/linux-x86.exp: Run ld/24920 tests.",
    "tree": {
      "sha": "7627e27f43e85e6906a483b754ff43a93047f5c8",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/7627e27f43e85e6906a483b754ff43a93047f5c8"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/74e10d1742f1b8312359c59a2af06c9e661252b3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/74e10d1742f1b8312359c59a2af06c9e661252b3",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/74e10d1742f1b8312359c59a2af06c9e661252b3",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/74e10d1742f1b8312359c59a2af06c9e661252b3/comments",
  "author": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "hjl-tools",
    "id": 1072356,
    "node_id": "MDQ6VXNlcjEwNzIzNTY=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072356?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/hjl-tools",
    "html_url": "https://github.com/hjl-tools",
    "followers_url": "https://api.github.com/users/hjl-tools/followers",
    "following_url": "https://api.github.com/users/hjl-tools/following{/other_user}",
    "gists_url": "https://api.github.com/users/hjl-tools/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/hjl-tools/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/hjl-tools/subscriptions",
    "organizations_url": "https://api.github.com/users/hjl-tools/orgs",
    "repos_url": "https://api.github.com/users/hjl-tools/repos",
    "events_url": "https://api.github.com/users/hjl-tools/events{/privacy}",
    "received_events_url": "https://api.github.com/users/hjl-tools/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2d61316c32a9fa3e14786c3312d9ca87c9298db5",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2d61316c32a9fa3e14786c3312d9ca87c9298db5",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/2d61316c32a9fa3e14786c3312d9ca87c9298db5"
    }
  ],
  "stats": {
    "total": 94,
    "additions": 90,
    "deletions": 4
  },
  "files": [
    {
      "sha": "8b0909386242887218c2b5706dec7ed7a478afea",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -1,3 +1,13 @@\n+2020-03-13  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR ld/24920\n+\t* elf-linker-x86.h (elf_linker_x86_params): Add\n+\tstatic_before_all_inputs and has_dynamic_linker.\n+\t* elfxx-x86.c (_bfd_x86_elf_link_setup_gnu_properties): Report\n+\tdynamic input objects if -static is passed at command-line\n+\tbefore all input files without --dynamic-linker unless\n+\t--no-dynamic-linker is used.\n+\n 2020-03-13  Kamil Rytarowski  <n54@gmx.com>\n \n \t* elf.c (elfcore_grok_netbsd_note): Add support for aarch64."
    },
    {
      "sha": "d0cb20dde527944e1268e16828e5e66b31d18181",
      "filename": "bfd/elf-linker-x86.h",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/elf-linker-x86.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/elf-linker-x86.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf-linker-x86.h?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -49,6 +49,12 @@ struct elf_linker_x86_params\n   /* TRUE if generate a 1-byte NOP as suffix for x86 call instruction.  */\n   unsigned int call_nop_as_suffix : 1;\n \n+  /* TRUE if -static is passed at command-line before all input files.  */\n+  unsigned int static_before_all_inputs : 1;\n+\n+  /* TRUE if --dynamic-linker is passed at command-line.  */\n+  unsigned int has_dynamic_linker : 1;\n+\n   /* Report missing IBT and SHSTK properties.  */\n   enum elf_x86_cet_report cet_report;\n "
    },
    {
      "sha": "108e04a1588e0f48ed9c5a186b21afbc2756d9d6",
      "filename": "bfd/elfxx-x86.c",
      "status": "modified",
      "additions": 17,
      "deletions": 0,
      "changes": 17,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/elfxx-x86.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/bfd/elfxx-x86.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elfxx-x86.c?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -2998,6 +2998,23 @@ _bfd_x86_elf_link_setup_gnu_properties\n \t\t\t\t  : bed->plt_alignment);\n     }\n \n+  if (bfd_link_executable (info)\n+      && !info->nointerp\n+      && !htab->params->has_dynamic_linker\n+      && htab->params->static_before_all_inputs)\n+    {\n+      /* Report error for dynamic input objects if -static is passed at\n+\t command-line before all input files without --dynamic-linker\n+\t unless --no-dynamic-linker is used.  */\n+      bfd *abfd;\n+\n+      for (abfd = info->input_bfds; abfd != NULL; abfd = abfd->link.next)\n+\tif ((abfd->flags & DYNAMIC))\n+\t  info->callbacks->einfo\n+\t    (_(\"%X%P: attempted static link of dynamic object `%pB'\\n\"),\n+\t     abfd);\n+    }\n+\n   return pbfd;\n }\n "
    },
    {
      "sha": "74d2f1b41fe60b2e7861d65a8e830d6f894e6ee8",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 11,
      "deletions": 0,
      "changes": 11,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -1,3 +1,14 @@\n+2020-03-13  H.J. Lu  <hongjiu.lu@intel.com>\n+\n+\tPR ld/24920\n+\t* emulparams/elf32_x86_64.sh: Use static.sh.\n+\t* emulparams/elf_i386.sh: Likewise.\n+\t* emulparams/elf_x86_64.sh: Likewise.\n+\t* emulparams/static.sh: New file.\n+\t* emultempl/elf-x86.em: Include \"ldlex.h\".\n+\t* testsuite/ld-elf/pr24920.err: New file.\n+\t* testsuite/ld-elf/linux-x86.exp: Run ld/24920 tests.\n+\n 2020-03-13  Christian Eggers  <ceggers@gmx.de>\n \n \t* ldexp.c (fold_name): Return SIZEOF_HEADERS in bytes."
    },
    {
      "sha": "1f672c6e42644373ec70030ad1623648cc12d8af",
      "filename": "ld/emulparams/elf32_x86_64.sh",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf32_x86_64.sh",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf32_x86_64.sh",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emulparams/elf32_x86_64.sh?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -4,6 +4,7 @@ source_sh ${srcdir}/emulparams/dynamic_undefined_weak.sh\n source_sh ${srcdir}/emulparams/reloc_overflow.sh\n source_sh ${srcdir}/emulparams/call_nop.sh\n source_sh ${srcdir}/emulparams/cet.sh\n+source_sh ${srcdir}/emulparams/static.sh\n SCRIPT_NAME=elf\n ELFSIZE=32\n OUTPUT_FORMAT=\"elf32-x86-64\""
    },
    {
      "sha": "c98d5e6600e678e62ce08530132e20e98e69c757",
      "filename": "ld/emulparams/elf_i386.sh",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf_i386.sh",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf_i386.sh",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emulparams/elf_i386.sh?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -3,6 +3,7 @@ source_sh ${srcdir}/emulparams/extern_protected_data.sh\n source_sh ${srcdir}/emulparams/dynamic_undefined_weak.sh\n source_sh ${srcdir}/emulparams/call_nop.sh\n source_sh ${srcdir}/emulparams/cet.sh\n+source_sh ${srcdir}/emulparams/static.sh\n SCRIPT_NAME=elf\n OUTPUT_FORMAT=\"elf32-i386\"\n NO_RELA_RELOCS=yes"
    },
    {
      "sha": "be98082982f58076d98d4cef31390e3b310d7231",
      "filename": "ld/emulparams/elf_x86_64.sh",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf_x86_64.sh",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/elf_x86_64.sh",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emulparams/elf_x86_64.sh?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -4,6 +4,7 @@ source_sh ${srcdir}/emulparams/dynamic_undefined_weak.sh\n source_sh ${srcdir}/emulparams/reloc_overflow.sh\n source_sh ${srcdir}/emulparams/call_nop.sh\n source_sh ${srcdir}/emulparams/cet.sh\n+source_sh ${srcdir}/emulparams/static.sh\n SCRIPT_NAME=elf\n ELFSIZE=64\n OUTPUT_FORMAT=\"elf64-x86-64\""
    },
    {
      "sha": "410839b8a56e1b6970f41aec78fce306fcab2ae8",
      "filename": "ld/emulparams/static.sh",
      "status": "added",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/static.sh",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emulparams/static.sh",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emulparams/static.sh?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -0,0 +1,12 @@\n+PARSE_AND_LIST_ARGS_CASES=\"$PARSE_AND_LIST_ARGS_CASES\n+    case OPTION_DYNAMIC_LINKER:\n+      params.has_dynamic_linker = TRUE;\n+      return FALSE;\n+\n+    case OPTION_NON_SHARED:\n+      /* Check if -static is passed at command-line before all input\n+\t files.  */\n+      if (!lang_has_input_file)\n+\tparams.static_before_all_inputs = TRUE;\n+      return FALSE;\n+\""
    },
    {
      "sha": "e18caffbb26dadad26104712f714f7b64f171de2",
      "filename": "ld/emultempl/elf-x86.em",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emultempl/elf-x86.em",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/emultempl/elf-x86.em",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/emultempl/elf-x86.em?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -22,6 +22,7 @@\n #\n fragment <<EOF\n \n+#include \"ldlex.h\"\n #include \"elf-linker-x86.h\"\n \n static struct elf_linker_x86_params params;"
    },
    {
      "sha": "63a321b9668469b9dff7e997641c13b338b6299a",
      "filename": "ld/testsuite/ld-elf/linux-x86.exp",
      "status": "modified",
      "additions": 29,
      "deletions": 4,
      "changes": 33,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/testsuite/ld-elf/linux-x86.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/testsuite/ld-elf/linux-x86.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/linux-x86.exp?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -19,11 +19,36 @@\n # MA 02110-1301, USA.\n #\n \n+# Linux/x86 tests.\n+if { ![istarget \"i?86-*-linux*\"] \\\n+       && ![istarget \"x86_64-*-linux*\"] \\\n+       && ![istarget \"amd64-*-linux*\"] } {\n+    return\n+}\n+\n+run_ld_link_tests [list \\\n+    [list \\\n+\t\"Build pr24920.so\" \\\n+\t\"-shared\" \\\n+\t\"\" \\\n+\t\"\" \\\n+\t{dummy.s} \\\n+\t{} \\\n+\t\"pr24920.so\" \\\n+    ] \\\n+    [list \\\n+\t\"Build pr24920\" \\\n+\t\"-static \" \\\n+\t\"-Bdynamic tmpdir/pr24920.so\" \\\n+\t\"\" \\\n+\t{start.s} \\\n+\t{{ld pr24920.err}} \\\n+\t\"pr24920\" \\\n+    ] \\\n+]\n+\n # Test very simple native Linux/x86 programs with linux-x86.S.\n-if { ![isnative] || ![check_compiler_available] \\\n-     || (![istarget \"i?86-*-linux*\"] \\\n-         && ![istarget \"x86_64-*-linux*\"] \\\n-         && ![istarget \"amd64-*-linux*\"]) } {\n+if { ![isnative] || ![check_compiler_available] } {\n     return\n }\n "
    },
    {
      "sha": "8f5cab916796c5ea9f6eee0fbf6327a291de02bb",
      "filename": "ld/testsuite/ld-elf/pr24920.err",
      "status": "added",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/testsuite/ld-elf/pr24920.err",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/74e10d1742f1b8312359c59a2af06c9e661252b3/ld/testsuite/ld-elf/pr24920.err",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-elf/pr24920.err?ref=74e10d1742f1b8312359c59a2af06c9e661252b3",
      "patch": "@@ -0,0 +1 @@\n+.*: attempted static link of dynamic object `tmpdir/pr24920.so'"
    }
  ]
}