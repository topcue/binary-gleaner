{
  "sha": "310b3441a07cb07713a8065a39032504e098047b",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MzEwYjM0NDFhMDdjYjA3NzEzYTgwNjVhMzkwMzI1MDRlMDk4MDQ3Yg==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-17T20:25:06Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-17T20:25:06Z"
    },
    "message": "[gdb] Fix heap-buffer-overflow in child_path\n\nWhen compiling gdb with '-lasan -fsanitizer=address' and running tests with:\n- export ASAN_OPTIONS=\"detect_leaks=0:alloc_dealloc_mismatch=0\", and\n- a target board using local-board.exp, which sets sysroot to \"\"\nwe run into a heap-buffer-overflow in child_path for f.i. gdb.arch/amd64-byte:\n...\n==3997==ERROR: AddressSanitizer: heap-buffer-overflow on address \\\n  0x60200002abcf at pc 0x5602acdf6872 bp 0x7ffe5237a090 sp 0x7ffe5237a080\nREAD of size 1 at 0x60200002abcf thread T0\n    #0 0x5602acdf6871 in child_path(char const*, char const*) \\\n                      gdb/common/pathstuff.c:161\n    #1 0x5602adb06587 in find_separate_debug_file gdb/symfile.c:1483\n    #2 0x5602adb06f2f in find_separate_debug_file_by_debuglink[abi:cxx11](...) \\\n                      gdb/symfile.c:1563\n    #3 0x5602ad13b743 in elf_symfile_read gdb/elfread.c:1293\n    #4 0x5602adb01cfa in read_symbols gdb/symfile.c:798\n    #5 0x5602adb03769 in syms_from_objfile_1 gdb/symfile.c:1000\n    #6 0x5602adb039d0 in syms_from_objfile gdb/symfile.c:1017\n    #7 0x5602adb04551 in symbol_file_add_with_addrs gdb/symfile.c:1124\n    #8 0x5602adb04ebf in symbol_file_add_from_bfd(...) gdb/symfile.c:1204\n    #9 0x5602ada5a78d in solib_read_symbols(...) gdb/solib.c:695\n    #10 0x5602ada5bdae in solib_add(char const*, int, int) gdb/solib.c:1004\n    #11 0x5602ada49bcd in enable_break gdb/solib-svr4.c:2394\n    #12 0x5602ada4dae9 in svr4_solib_create_inferior_hook gdb/solib-svr4.c:3028\n    #13 0x5602ada5d4f1 in solib_create_inferior_hook(int) gdb/solib.c:1215\n    #14 0x5602ad347f66 in post_create_inferior(target_ops*, int) \\\n                          gdb/infcmd.c:467\n    #15 0x5602ad348b3c in run_command_1 gdb/infcmd.c:663\n    #16 0x5602ad348e55 in run_command gdb/infcmd.c:686\n    #17 0x5602acd7d32b in do_const_cfunc gdb/cli/cli-decode.c:106\n    #18 0x5602acd84bfe in cmd_func(cmd_list_element*, char const*, int) \\\n                          gdb/cli/cli-decode.c:1892\n    #19 0x5602adc62a90 in execute_command(char const*, int) gdb/top.c:630\n    #20 0x5602ad5053e6 in catch_command_errors gdb/main.c:372\n    #21 0x5602ad507eb1 in captured_main_1 gdb/main.c:1138\n    #22 0x5602ad5081ec in captured_main gdb/main.c:1163\n    #23 0x5602ad508281 in gdb_main(captured_main_args*) gdb/main.c:1188\n    #24 0x5602ac9ddc3a in main gdb/gdb.c:32\n    #25 0x7f582b56eb96 in __libc_start_main \\\n                       (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\n    #26 0x5602ac9dda09 in _start \\\n                       (/home/smarchi/build/binutils-gdb/gdb/gdb+0x19a2a09)\n\n0x60200002abcf is located 1 bytes to the left of 1-byte region \\\n  [0x60200002abd0,0x60200002abd1)\nallocated by thread T0 here:\n    #0 0x7f582e0e4b50 in __interceptor_malloc \\\n                      (/usr/lib/x86_64-linux-gnu/libasan.so.4+0xdeb50)\n    #1 0x5602acdd3656 in xmalloc gdb/common/common-utils.c:44\n    #2 0x5602aefe17d1 in xstrdup libiberty/xstrdup.c:34\n    #3 0x5602acdf61f6 in gdb_realpath(char const*) gdb/common/pathstuff.c:80\n    #4 0x5602adb06278 in find_separate_debug_file gdb/symfile.c:1444\n    #5 0x5602adb06f2f in find_separate_debug_file_by_debuglink[abi:cxx11](...) \\\n                      gdb/symfile.c:1563\n    #6 0x5602ad13b743 in elf_symfile_read gdb/elfread.c:1293\n    #7 0x5602adb01cfa in read_symbols gdb/symfile.c:798\n    #8 0x5602adb03769 in syms_from_objfile_1 gdb/symfile.c:1000\n    #9 0x5602adb039d0 in syms_from_objfile gdb/symfile.c:1017\n    #10 0x5602adb04551 in symbol_file_add_with_addrs gdb/symfile.c:1124\n    #11 0x5602adb04ebf in symbol_file_add_from_bfd(...) gdb/solib.c:695\n    #13 0x5602ada5bdae in solib_add(char const*, int, int) gdb/solib.c:1004\n    #14 0x5602ada49bcd in enable_break gdb/solib-svr4.c:2394\n    #15 0x5602ada4dae9 in svr4_solib_create_inferior_hook gdb/solib-svr4.c:3028\n    #16 0x5602ada5d4f1 in solib_create_inferior_hook(int) gdb/solib.c:1215\n    #17 0x5602ad347f66 in post_create_inferior(target_ops*, int) \\\n                       gdb/infcmd.c:467\n    #18 0x5602ad348b3c in run_command_1 gdb/infcmd.c:663\n    #19 0x5602ad348e55 in run_command gdb/infcmd.c:686\n    #20 0x5602acd7d32b in do_const_cfunc gdb/cli/cli-decode.c:106\n    #21 0x5602acd84bfe in cmd_func(cmd_list_element*, char const*, int) \\\n                       gdb/cli/cli-decode.c:1892\n    #22 0x5602adc62a90 in execute_command(char const*, int) gdb/top.c:630\n    #23 0x5602ad5053e6 in catch_command_errors gdb/main.c:372\n    #24 0x5602ad507eb1 in captured_main_1 gdb/main.c:1138\n    #25 0x5602ad5081ec in captured_main gdb/main.c:1163\n    #26 0x5602ad508281 in gdb_main(captured_main_args*) gdb/main.c:1188\n    #27 0x5602ac9ddc3a in main gdb/gdb.c:32\n    #28 0x7f582b56eb96 in __libc_start_main \\\n                       (/lib/x86_64-linux-gnu/libc.so.6+0x21b96)\n\nSUMMARY: AddressSanitizer: heap-buffer-overflow gdb/common/pathstuff.c:161 \\\n  in child_path(char const*, char const*)\nShadow bytes around the buggy address:\n  0x0c047fffd520: fa fa fd fd fa fa fd fd fa fa fd fa fa fa fd fa\n  0x0c047fffd530: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa\n  0x0c047fffd540: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa\n  0x0c047fffd550: fa fa fd fd fa fa fd fd fa fa fd fd fa fa fd fa\n  0x0c047fffd560: fa fa fd fa fa fa fd fa fa fa fd fa fa fa 00 00\n=>0x0c047fffd570: fa fa 07 fa fa fa 00 fa fa[fa]01 fa fa fa fa fa\n  0x0c047fffd580: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fffd590: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fffd5a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fffd5b0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\n  0x0c047fffd5c0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07\n  Heap left redzone:       fa\n  Freed heap region:       fd\n  Stack left redzone:      f1\n  Stack mid redzone:       f2\n  Stack right redzone:     f3\n  Stack after return:      f5\n  Stack use after scope:   f8\n  Global redzone:          f9\n  Global init order:       f6\n  Poisoned by user:        f7\n  Container overflow:      fc\n  Array cookie:            ac\n  Intra object redzone:    bb\n  ASan internal:           fe\n  Left alloca redzone:     ca\n  Right alloca redzone:    cb\n==3997==ABORTING\n...\n\nThe direct cause is that child_path gets called with parent == \"\", so this\ntest:\n...\n  if (IS_DIR_SEPARATOR (parent[parent_len - 1]))\n...\naccesses parent[-1].\n\n[ There is an open discussion (1) about whether an empty sysroot should indeed\nbe represented internally as \"\".  But this patch focuses on fixing the\nheap-buffer-overflow without any redesign. ]\n\nFix this by guarding the test with 'parent_len > 0'.\n\nNote that the fix makes child_path behave the same for:\n- parent == \"/\" && child == \"/foo\" (returns \"foo\")\n- parent == \"\" and child == \"/foo\" (returns \"foo\").\n\nBuild and reg-tested on x86_64-linux.\n\n(1) https://sourceware.org/ml/gdb-patches/2019-05/msg00193.html\n\ngdb/ChangeLog:\n\n2019-06-17  Tom de Vries  <tdevries@suse.de>\n\n\tPR gdb/24617\n\t* common/pathstuff.c (child_path): Make sure parent_len > 0 before\n\taccessing parent[parent_len - 1].",
    "tree": {
      "sha": "a465171c7fec040183ceeab272a0c3ce27df3f95",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/a465171c7fec040183ceeab272a0c3ce27df3f95"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/310b3441a07cb07713a8065a39032504e098047b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/310b3441a07cb07713a8065a39032504e098047b",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/310b3441a07cb07713a8065a39032504e098047b",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/310b3441a07cb07713a8065a39032504e098047b/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ba9777bef059df0926ad5dd6813d5785cb652ccf",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ba9777bef059df0926ad5dd6813d5785cb652ccf",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/ba9777bef059df0926ad5dd6813d5785cb652ccf"
    }
  ],
  "stats": {
    "total": 8,
    "additions": 7,
    "deletions": 1
  },
  "files": [
    {
      "sha": "22a473a4037f698c22a76d8a40f98a43641bc7a7",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/310b3441a07cb07713a8065a39032504e098047b/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/310b3441a07cb07713a8065a39032504e098047b/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=310b3441a07cb07713a8065a39032504e098047b",
      "patch": "@@ -1,3 +1,9 @@\n+2019-06-17  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR gdb/24617\n+\t* common/pathstuff.c (child_path): Make sure parent_len > 0 before\n+\taccessing parent[parent_len - 1].\n+\n 2019-06-17  Paul Pluzhnikov  <ppluzhnikov@google.com>\n \n \tPR gdb/24364"
    },
    {
      "sha": "b295e73237b82de3819c69afa5b44457af18e4a8",
      "filename": "gdb/common/pathstuff.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/310b3441a07cb07713a8065a39032504e098047b/gdb/common/pathstuff.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/310b3441a07cb07713a8065a39032504e098047b/gdb/common/pathstuff.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/common/pathstuff.c?ref=310b3441a07cb07713a8065a39032504e098047b",
      "patch": "@@ -158,7 +158,7 @@ child_path (const char *parent, const char *child)\n   /* The parent path must be a directory and the child must contain at\n      least one component underneath the parent.  */\n   const char *child_component;\n-  if (IS_DIR_SEPARATOR (parent[parent_len - 1]))\n+  if (parent_len > 0 && IS_DIR_SEPARATOR (parent[parent_len - 1]))\n     {\n       /* The parent path ends in a directory separator, so it is a\n \t directory.  The first child component starts after the common"
    }
  ]
}