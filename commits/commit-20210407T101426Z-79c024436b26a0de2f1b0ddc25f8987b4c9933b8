{
  "sha": "79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NzljMDI0NDM2YjI2YTBkZTJmMWIwZGRjMjVmODk4N2I0Yzk5MzNiOA==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2021-03-26T17:14:26Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2021-04-07T10:14:26Z"
    },
    "message": "gdb/py: fix gdb.parameter('data-directory')\n\nIt was reported on IRC that using gdb.parameter('data-directory')\ndoesn't work correctly.\n\nThe problem is that the data directory is stored in 'gdb_datadir',\nhowever the set/show command is associated with a temporary\n'staged_gdb_datadir'.\n\nWhen the user does 'set data-directory VALUE', the VALUE is stored in\n'staged_gdb_datadir' by GDB, then set_gdb_datadir is called.  This in\nturn calls set_gdb_data_directory to copy the value from\nstaged_gdb_datadir into gdb_datadir.\n\nHowever, set_gdb_data_directory will resolve relative paths, so the\nvalue stored in gdb_datadir might not match the value in\nstaged_gdb_datadir.\n\nThe Python gdb.parameter API fetches the parameter values by accessing\nthe variable associated with the show command, so in this case\nstaged_gdb_datadir.  This causes two problems:\n\n1. Initially staged_gdb_datadir is NULL, and remains as such until the\nuser does 'set data-directory VALUE' (which might never happen), but\ngdb_datadir starts with GDB's default data-directory value.  So\ninitially from Python gdb.parameter('data-directory') will return the\nempty string, even though at GDB's CLI 'show data-directory' prints a\nreal path.\n\n2. If the user does 'set data-directory ./some/relative/path', GDB\nwill resolve the relative path, thus, 'show data-directory' at the CLI\nwill print an absolute path.  However, the value is staged_gdb_datadir\nwill still be the relative path, and gdb.parameter('data-directory')\nfrom Python will return the relative path.\n\nIn this commit I fix both of these issues by:\n\n1. Initialising the value in staged_gdb_datadir based on the initial\nvalue in gdb_datadir, and\n\n2. In set_gdb_datadir, after calling set_gdb_data_directory, I copy\nthe value in gdb_datadir back into staged_gdb_datadir.\n\nWith these two changes in place the value in staged_gdb_datadir should\nalways match the value in gdb_datadir, and accessing data-directory\nfrom Python should now work correctly.\n\ngdb/ChangeLog:\n\n\t* top.c (staged_gdb_datadir): Update comment.\n\t(set_gdb_datadir): Copy the value of gdb_datadir back into\n\tstaged_datadir.\n\t(init_main): Initialise staged_gdb_datadir.\n\ngdb/testsuite/ChangeLog:\n\n\t* gdb.python/py-parameter.exp: Add test for reading data-directory\n\tusing gdb.parameter API.",
    "tree": {
      "sha": "9e9f4445d57ce2e152e5da519b341ae68fde0572",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/9e9f4445d57ce2e152e5da519b341ae68fde0572"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "b12389f219facfb4aa29b97fdcbc2664a5b0732a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b12389f219facfb4aa29b97fdcbc2664a5b0732a",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/b12389f219facfb4aa29b97fdcbc2664a5b0732a"
    }
  ],
  "stats": {
    "total": 80,
    "additions": 78,
    "deletions": 2
  },
  "files": [
    {
      "sha": "39a2d3271833bd1ebdebb56298e4f8ab819729df",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
      "patch": "@@ -1,3 +1,10 @@\n+2021-04-07  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* top.c (staged_gdb_datadir): Update comment.\n+\t(set_gdb_datadir): Copy the value of gdb_datadir back into\n+\tstaged_datadir.\n+\t(init_main): Initialise staged_gdb_datadir.\n+\n 2021-04-06  Tom de Vries  <tdevries@suse.de>\n \n \tPR breakpoints/25884"
    },
    {
      "sha": "04ed4ad96e3ce05ce209a2c16c3b446da448ee1e",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
      "patch": "@@ -1,3 +1,8 @@\n+2021-04-07  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* gdb.python/py-parameter.exp: Add test for reading data-directory\n+\tusing gdb.parameter API.\n+\n 2021-04-06  Tom de Vries  <tdevries@suse.de>\n \n \tPR breakpoints/25884"
    },
    {
      "sha": "5543b21f3ac78e5bd560d206f7b88a5474519fa5",
      "filename": "gdb/testsuite/gdb.python/py-parameter.exp",
      "status": "modified",
      "additions": 51,
      "deletions": 0,
      "changes": 51,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/testsuite/gdb.python/py-parameter.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/testsuite/gdb.python/py-parameter.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.python/py-parameter.exp?ref=79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
      "patch": "@@ -37,6 +37,57 @@ if { [is_remote host] } {\n }\n gdb_test \"python print (gdb.parameter ('directories'))\" $directories\n \n+# Check we can correctly read the data-directory parameter.  First,\n+# grab the value as read directly from the GDB CLI.\n+set dd \"\"\n+gdb_test_multiple \"show data-directory\" \\\n+    \"find the initial data-directory value\" {\n+\t-re -wrap \"GDB's data directory is \\\"(\\[^\\r\\n\\]+)\\\"\\\\.\" {\n+\t    set dd $expect_out(1,string)\n+\t    pass $gdb_test_name\n+\t}\n+    }\n+\n+# Now print the data-directory from Python.\n+gdb_test \"python print (gdb.parameter ('data-directory'))\" $dd\n+\n+# Next change the data-directory to a relative path.  Internally GDB\n+# will resolve this to an absolute path, which Python should then see.\n+#\n+# GDB is currently running in '...../build/gdb/testsuite/' and the\n+# test output is being written to:\n+#   ...../build/gdb/testsuite/outputs/gdb.python/py-parameter/\n+#\n+# So create the relative path './outputs/gdb.python/py-parameter/' and\n+# set the data-directory to that, we should then see the absolute path.\n+\n+set abs_path_to_output_dir [standard_output_file \"\"]\n+set abs_path_to_cwd $objdir\n+set rel_path_to_output_dir \\\n+    [file join \".\" [string replace ${abs_path_to_output_dir} 0 \\\n+\t\t\t[string length ${abs_path_to_cwd}] \"\"]]\n+gdb_test_no_output \"set data-directory ${rel_path_to_output_dir}\"\n+\n+gdb_test \"python print (gdb.parameter ('data-directory'))\" \\\n+    ${abs_path_to_output_dir} \\\n+    \"python sees absolute version of data-directory path\"\n+\n+# While we're here, check we see the correct path at GDB's CLI.\n+gdb_test \"show data-directory\" \\\n+    \"GDB's data directory is \\\"${abs_path_to_output_dir}\\\"\\\\.\" \\\n+    \"check modified data-directory at the CLI\"\n+\n+# Now lets set the data-directory back to what it was initially.\n+gdb_test_no_output \"set data-directory ${dd}\"\n+\n+# And check we see the restored value at CLI and from Python.\n+gdb_test \"show data-directory\" \\\n+    \"GDB's data directory is \\\"${dd}\\\"\\\\.\" \\\n+    \"check original data-directory was restored at the CLI\"\n+\n+gdb_test \"python print (gdb.parameter ('data-directory'))\" ${dd} \\\n+    \"python sees restored data-directory value\"\n+\n # Test a simple boolean parameter.\n with_test_prefix \"boolean parameter\" {\n     gdb_test_multiline \"Simple gdb booleanparameter\" \\"
    },
    {
      "sha": "c374a8d02d383db4db891ca1822a7ff38f77a4c5",
      "filename": "gdb/top.c",
      "status": "modified",
      "additions": 15,
      "deletions": 2,
      "changes": 17,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/top.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/79c024436b26a0de2f1b0ddc25f8987b4c9933b8/gdb/top.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/top.c?ref=79c024436b26a0de2f1b0ddc25f8987b4c9933b8",
      "patch": "@@ -2111,7 +2111,10 @@ show_exec_done_display_p (struct ui_file *file, int from_tty,\n \t\t    value);\n }\n \n-/* New values of the \"data-directory\" parameter are staged here.  */\n+/* New values of the \"data-directory\" parameter are staged here.\n+   Extension languages, for example Python's gdb.parameter API, will read\n+   the value directory from this variable, so we must ensure that this\n+   always contains the correct value.  */\n static char *staged_gdb_datadir;\n \n /* \"set\" command for the gdb_datadir configuration variable.  */\n@@ -2120,6 +2123,14 @@ static void\n set_gdb_datadir (const char *args, int from_tty, struct cmd_list_element *c)\n {\n   set_gdb_data_directory (staged_gdb_datadir);\n+\n+  /* SET_GDB_DATA_DIRECTORY will resolve relative paths in\n+     STAGED_GDB_DATADIR, so we now copy the value from GDB_DATADIR\n+     back into STAGED_GDB_DATADIR so the extension languages can read the\n+     correct value.  */\n+  free (staged_gdb_datadir);\n+  staged_gdb_datadir = strdup (gdb_datadir.c_str ());\n+\n   gdb::observers::gdb_datadir_changed.notify ();\n }\n \n@@ -2290,7 +2301,9 @@ Use \\\"on\\\" to enable the notification, and \\\"off\\\" to disable it.\"),\n When set, GDB uses the specified path to search for data files.\"),\n \t\t\t   set_gdb_datadir, show_gdb_datadir,\n \t\t\t   &setlist,\n-\t\t\t   &showlist);\n+\t\t\t    &showlist);\n+  /* Prime the initial value for data-directory.  */\n+  staged_gdb_datadir = strdup (gdb_datadir.c_str ());\n \n   add_setshow_auto_boolean_cmd (\"interactive-mode\", class_support,\n \t\t\t\t&interactive_mode, _(\"\\"
    }
  ]
}