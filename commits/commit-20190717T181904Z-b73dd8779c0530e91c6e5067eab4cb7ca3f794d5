{
  "sha": "b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6YjczZGQ4Nzc5YzA1MzBlOTFjNmU1MDY3ZWFiNGNiN2NhM2Y3OTRkNQ==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-06-28T20:48:45Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2019-07-17T18:19:04Z"
    },
    "message": "Make source windows be self-updating\n\nThis changes the TUI source window to register itself on the\nsource_styling_changed observable, and removes a bit of code from\ntui-hooks.c.  This reduces the number of uses of the TUI_SRC_WIN\nglobal.\n\ngdb/ChangeLog\n2019-07-17  Tom Tromey  <tom@tromey.com>\n\n\t* tui/tui-source.c (tui_source_window): New constructor.  Add\n\tobserver.\n\t(~tui_source_window): New destructor.\n\t(tui_source_window::style_changed): New method.\n\t* tui/tui-hooks.c (tui_redisplay_source): Remove.\n\t(tui_attach_detach_observers): Update.\n\t* tui/tui-data.h (struct tui_source_window): Make constructor not\n\tinline.  Add destructor.\n\t(struct tui_source_window) <style_changed>: New method.\n\t<m_observable>: New member.",
    "tree": {
      "sha": "e717d03900daf50b3c3644b10d40b2927bdce635",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e717d03900daf50b3c3644b10d40b2927bdce635"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "ae2b53806d3ce384e349c722b21a7ad246102d5b",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ae2b53806d3ce384e349c722b21a7ad246102d5b",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/ae2b53806d3ce384e349c722b21a7ad246102d5b"
    }
  ],
  "stats": {
    "total": 61,
    "additions": 43,
    "deletions": 18
  },
  "files": [
    {
      "sha": "1235b1a382d62c3cf987bdf39aa92aa8e86da485",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
      "patch": "@@ -1,3 +1,16 @@\n+2019-07-17  Tom Tromey  <tom@tromey.com>\n+\n+\t* tui/tui-source.c (tui_source_window): New constructor.  Add\n+\tobserver.\n+\t(~tui_source_window): New destructor.\n+\t(tui_source_window::style_changed): New method.\n+\t* tui/tui-hooks.c (tui_redisplay_source): Remove.\n+\t(tui_attach_detach_observers): Update.\n+\t* tui/tui-data.h (struct tui_source_window): Make constructor not\n+\tinline.  Add destructor.\n+\t(struct tui_source_window) <style_changed>: New method.\n+\t<m_observable>: New member.\n+\n 2019-07-17  Tom Tromey  <tom@tromey.com>\n \n \t* tui/tui-data.c (tui_clear_source_windows_detail): Fix typo."
    },
    {
      "sha": "be951b4c840b0216fc532120bafb438af37d438c",
      "filename": "gdb/tui/tui-data.h",
      "status": "modified",
      "additions": 10,
      "deletions": 4,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-data.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-data.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-data.h?ref=b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
      "patch": "@@ -24,6 +24,7 @@\n \n #include \"tui/tui.h\"\t/* For enum tui_win_type.  */\n #include \"gdb_curses.h\"\t/* For WINDOW.  */\n+#include \"observable.h\"\n \n /* This is a point definition.  */\n struct tui_point\n@@ -424,10 +425,8 @@ struct tui_source_window_base : public tui_win_info\n \n struct tui_source_window : public tui_source_window_base\n {\n-  tui_source_window ()\n-    : tui_source_window_base (SRC_WIN)\n-  {\n-  }\n+  tui_source_window ();\n+  ~tui_source_window ();\n \n   DISABLE_COPY_AND_ASSIGN (tui_source_window);\n \n@@ -439,6 +438,13 @@ struct tui_source_window : public tui_source_window_base\n protected:\n \n   void do_scroll_vertical (int num_to_scroll) override;\n+\n+private:\n+\n+  void style_changed ();\n+\n+  /* A token used to register and unregister an observer.  */\n+  gdb::observers::token m_observable;\n };\n \n /* A TUI disassembly window.  */"
    },
    {
      "sha": "84acd3ac2e6bf6a582159ef33935727455995009",
      "filename": "gdb/tui/tui-hooks.c",
      "status": "modified",
      "additions": 0,
      "deletions": 14,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-hooks.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-hooks.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-hooks.c?ref=b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
      "patch": "@@ -204,18 +204,6 @@ tui_normal_stop (struct bpstats *bs, int print_frame)\n   tui_refresh_frame_and_register_information (/*registers_too_p=*/1);\n }\n \n-/* Observer for source_cache_cleared.  */\n-\n-static void\n-tui_redisplay_source ()\n-{\n-  if (tui_is_window_visible (SRC_WIN))\n-    {\n-      /* Force redisplay.  */\n-      TUI_SRC_WIN->refill ();\n-    }\n-}\n-\n /* Token associated with observers registered while TUI hooks are\n    installed.  */\n static const gdb::observers::token tui_observers_token {};\n@@ -251,8 +239,6 @@ tui_attach_detach_observers (bool attach)\n \t\t    tui_normal_stop, attach);\n   attach_or_detach (gdb::observers::register_changed,\n \t\t    tui_register_changed, attach);\n-  attach_or_detach (gdb::observers::source_styling_changed,\n-\t\t    tui_redisplay_source, attach);\n }\n \n /* Install the TUI specific hooks.  */"
    },
    {
      "sha": "34cb38b31afc25f1398dae89e4e3aa70d6e89982",
      "filename": "gdb/tui/tui-source.c",
      "status": "modified",
      "additions": 20,
      "deletions": 0,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-source.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/b73dd8779c0530e91c6e5067eab4cb7ca3f794d5/gdb/tui/tui-source.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/tui/tui-source.c?ref=b73dd8779c0530e91c6e5067eab4cb7ca3f794d5",
      "patch": "@@ -325,3 +325,23 @@ tui_source_window::do_scroll_vertical (int num_to_scroll)\n       print_source_lines (s, l.u.line_no, l.u.line_no + 1, 0);\n     }\n }\n+\n+tui_source_window::tui_source_window ()\n+  : tui_source_window_base (SRC_WIN)\n+{\n+  gdb::observers::source_styling_changed.attach\n+    (std::bind (&tui_source_window::style_changed, this),\n+     m_observable);\n+}\n+\n+tui_source_window::~tui_source_window ()\n+{\n+  gdb::observers::source_styling_changed.detach (m_observable);\n+}\n+\n+void\n+tui_source_window::style_changed ()\n+{\n+  if (tui_active && is_visible)\n+    refill ();\n+}"
    }
  ]
}