{
  "sha": "621cc310717334b330e6301759dad62e641486f6",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NjIxY2MzMTA3MTczMzRiMzMwZTYzMDE3NTlkYWQ2MmU2NDE0ODZmNg==",
  "commit": {
    "author": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2020-12-24T12:26:20Z"
    },
    "committer": {
      "name": "Pedro Alves",
      "email": "pedro@palves.net",
      "date": "2021-02-03T01:04:28Z"
    },
    "message": "Fix \"target extended-remote\" + \"maint set target-non-stop\" + \"attach\"\n\nWith \"target extended-remote\" + \"maint set target-non-stop\", attaching\nhangs like so:\n\n (gdb) attach 1244450\n Attaching to process 1244450\n [New Thread 1244450.1244450]\n [New Thread 1244450.1244453]\n [New Thread 1244450.1244454]\n [New Thread 1244450.1244455]\n [New Thread 1244450.1244456]\n [New Thread 1244450.1244457]\n [New Thread 1244450.1244458]\n [New Thread 1244450.1244459]\n [New Thread 1244450.1244461]\n [New Thread 1244450.1244462]\n [New Thread 1244450.1244463]\n * hang *\n\nAttaching to the hung GDB shows that GDB is busy in an infinite loop\nin stop_all_threads:\n\n (top-gdb) bt\n #0  stop_all_threads () at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:4755\n #1  0x000055555597b424 in stop_waiting (ecs=0x7fffffffd930) at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:7738\n #2  0x0000555555976fba in handle_signal_stop (ecs=0x7fffffffd930) at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:5868\n #3  0x0000555555975f6a in handle_inferior_event (ecs=0x7fffffffd930) at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:5527\n #4  0x0000555555971da4 in fetch_inferior_event () at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:3910\n #5  0x00005555559540b2 in inferior_event_handler (event_type=INF_REG_EVENT) at /home/pedro/gdb/binutils-gdb/src/gdb/inf-loop.c:42\n #6  0x000055555597e825 in infrun_async_inferior_event_handler (data=0x0) at /home/pedro/gdb/binutils-gdb/src/gdb/infrun.c:9162\n #7  0x0000555555687d1d in check_async_event_handlers () at /home/pedro/gdb/binutils-gdb/src/gdb/async-event.c:328\n #8  0x0000555555e48284 in gdb_do_one_event () at /home/pedro/gdb/binutils-gdb/src/gdbsupport/event-loop.cc:216\n #9  0x00005555559e7512 in start_event_loop () at /home/pedro/gdb/binutils-gdb/src/gdb/main.c:347\n #10 0x00005555559e765d in captured_command_loop () at /home/pedro/gdb/binutils-gdb/src/gdb/main.c:407\n #11 0x00005555559e8f80 in captured_main (data=0x7fffffffdb70) at /home/pedro/gdb/binutils-gdb/src/gdb/main.c:1239\n #12 0x00005555559e8ff2 in gdb_main (args=0x7fffffffdb70) at /home/pedro/gdb/binutils-gdb/src/gdb/main.c:1254\n #13 0x0000555555627c86 in main (argc=12, argv=0x7fffffffdc88) at /home/pedro/gdb/binutils-gdb/src/gdb/gdb.c:32\n\nThe problem is that the remote sends stops for all the threads:\n\n Packet received: l/home/pedro/gdb/binutils-gdb/build/gdb/testsuite/outputs/gdb.threads/attach-non-stop/attach-non-stop\n Sending packet: $vStopped#55...Packet received: T0006:f06e25edec7f0000;07:f06e25edec7f0000;10:f14190ccf4550000;thread:p12fd22.12fd2f;core:15;\n Sending packet: $vStopped#55...Packet received: T0006:f0dea5f0ec7f0000;07:f0dea5f0ec7f0000;10:e84190ccf4550000;thread:p12fd22.12fd27;core:4;\n Sending packet: $vStopped#55...Packet received: T0006:f0ee25f1ec7f0000;07:f0ee25f1ec7f0000;10:f14190ccf4550000;thread:p12fd22.12fd26;core:5;\n Sending packet: $vStopped#55...Packet received: T0006:f0bea5efec7f0000;07:f0bea5efec7f0000;10:f14190ccf4550000;thread:p12fd22.12fd29;core:1;\n Sending packet: $vStopped#55...Packet received: T0006:f0ce25f0ec7f0000;07:f0ce25f0ec7f0000;10:e84190ccf4550000;thread:p12fd22.12fd28;core:a;\n Sending packet: $vStopped#55...Packet received: T0006:f07ea5edec7f0000;07:f07ea5edec7f0000;10:e84190ccf4550000;thread:p12fd22.12fd2e;core:f;\n Sending packet: $vStopped#55...Packet received: T0006:f0ae25efec7f0000;07:f0ae25efec7f0000;10:df4190ccf4550000;thread:p12fd22.12fd2a;core:6;\n Sending packet: $vStopped#55...Packet received: T0006:0000000000000000;07:c0e8a381fe7f0000;10:bf43b4f1ec7f0000;thread:p12fd22.12fd22;core:2;\n Sending packet: $vStopped#55...Packet received: T0006:f0fea5f1ec7f0000;07:f0fea5f1ec7f0000;10:df4190ccf4550000;thread:p12fd22.12fd25;core:8;\n Sending packet: $vStopped#55...Packet received: T0006:f09ea5eeec7f0000;07:f09ea5eeec7f0000;10:e84190ccf4550000;thread:p12fd22.12fd2b;core:b;\n Sending packet: $vStopped#55...Packet received: OK\n\nBut then wait_one never consumes them, always hitting this path:\n\n 4473          if (nfds == 0)\n 4474            {\n 4475              /* No waitable targets left.  All must be stopped.  */\n 4476              return {NULL, minus_one_ptid, {TARGET_WAITKIND_NO_RESUMED}};\n 4477            }\n\nResulting in GDB constanly calling target_stop to stop threads, but\nthe remote target never reporting back the stops to infrun.\n\nThat TARGET_WAITKIND_NO_RESUMED path shown above is always taken\nbecause here, in wait_one too, just above:\n\n 4428          for (inferior *inf : all_inferiors ())\n 4429            {\n 4430              process_stratum_target *target = inf->process_target ();\n 4431              if (target == NULL\n 4432                  || !target->is_async_p ()\n                           ^^^^^^^^^^^^^^^^^^^^^\n 4433                  || !target->threads_executing)\n 4434                continue;\n\n... the remote target is not async.\n\nAnd in turn that happened because extended_remote_target::attach\nmisses enabling async in the target-non-stop path.\n\nA testcase exercising this will be added in a following patch.\n\ngdb/ChangeLog:\n\n\t* remote.c (extended_remote_target::attach): Set target async in\n\tthe target-non-stop path too.",
    "tree": {
      "sha": "54d67bcd0e37ece57db432b61ec361d3453f4316",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/54d67bcd0e37ece57db432b61ec361d3453f4316"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/621cc310717334b330e6301759dad62e641486f6",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/621cc310717334b330e6301759dad62e641486f6",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/621cc310717334b330e6301759dad62e641486f6",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/621cc310717334b330e6301759dad62e641486f6/comments",
  "author": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "palves",
    "id": 1202913,
    "node_id": "MDQ6VXNlcjEyMDI5MTM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1202913?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/palves",
    "html_url": "https://github.com/palves",
    "followers_url": "https://api.github.com/users/palves/followers",
    "following_url": "https://api.github.com/users/palves/following{/other_user}",
    "gists_url": "https://api.github.com/users/palves/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/palves/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/palves/subscriptions",
    "organizations_url": "https://api.github.com/users/palves/orgs",
    "repos_url": "https://api.github.com/users/palves/repos",
    "events_url": "https://api.github.com/users/palves/events{/privacy}",
    "received_events_url": "https://api.github.com/users/palves/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2ab76a181f3db93f051aaae66d65ff2733884d96",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2ab76a181f3db93f051aaae66d65ff2733884d96",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/2ab76a181f3db93f051aaae66d65ff2733884d96"
    }
  ],
  "stats": {
    "total": 12,
    "additions": 11,
    "deletions": 1
  },
  "files": [
    {
      "sha": "b53cd2b68be0021a6e7e2ea5e780db042429af54",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/621cc310717334b330e6301759dad62e641486f6/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/621cc310717334b330e6301759dad62e641486f6/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=621cc310717334b330e6301759dad62e641486f6",
      "patch": "@@ -1,3 +1,8 @@\n+2021-02-03  Pedro Alves  <pedro@palves.net>\n+\n+\t* remote.c (extended_remote_target::attach): Set target async in\n+\tthe target-non-stop path too.\n+\n 2021-02-03  Pedro Alves  <pedro@palves.net>\n \n \tPR gdb/27055"
    },
    {
      "sha": "f183b4f3b0e4a7fbbfe2bf3cc8fab9abde71b9ef",
      "filename": "gdb/remote.c",
      "status": "modified",
      "additions": 6,
      "deletions": 1,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/621cc310717334b330e6301759dad62e641486f6/gdb/remote.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/621cc310717334b330e6301759dad62e641486f6/gdb/remote.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/remote.c?ref=621cc310717334b330e6301759dad62e641486f6",
      "patch": "@@ -6033,7 +6033,12 @@ extended_remote_target::attach (const char *args, int from_tty)\n \t}\n     }\n   else\n-    gdb_assert (wait_status == NULL);\n+    {\n+      gdb_assert (wait_status == NULL);\n+\n+      gdb_assert (target_can_async_p ());\n+      target_async (1);\n+    }\n }\n \n /* Implementation of the to_post_attach method.  */"
    }
  ]
}