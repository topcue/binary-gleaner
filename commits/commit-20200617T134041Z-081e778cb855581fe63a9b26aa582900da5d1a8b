{
  "sha": "081e778cb855581fe63a9b26aa582900da5d1a8b",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MDgxZTc3OGNiODU1NTgxZmU2M2E5YjI2YWE1ODI5MDBkYTVkMWE4Yg==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-06-17T13:40:41Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-06-17T13:40:41Z"
    },
    "message": "[gdb/testsuite] Remove dependence on tcl_unknown\n\nIn gdb_init we install a local version of ::unknown, which relies on\n::tcl_unknown, which is defined by dejagnu.\n\nThis proc may be moved into a namespace, or disappear altogether, as\nindicated by dejagnu maintainers, so we can't rely on it.\n\nFix this by recreating tcl's version of unknown, and using that instead.\n\nTested on x86_64-linux.\n\ngdb/testsuite/ChangeLog:\n\n2020-06-17  Tom de Vries  <tdevries@suse.de>\n\n\t* lib/gdb.exp (gdb_tcl_unknown): New proc.\n\t(gdb_init): Use gdb_tcl_unknown for ::unknown override.  Make override\n\tconditional on presence of gdb_tcl_unknown.\n\t(gdb_finish): Make override undo conditional on presence of\n\tgdb_tcl_unknown.",
    "tree": {
      "sha": "f0a1adee5c862eb79340abab1cb20cb9d0843e77",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/f0a1adee5c862eb79340abab1cb20cb9d0843e77"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/081e778cb855581fe63a9b26aa582900da5d1a8b",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/081e778cb855581fe63a9b26aa582900da5d1a8b",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/081e778cb855581fe63a9b26aa582900da5d1a8b",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/081e778cb855581fe63a9b26aa582900da5d1a8b/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "b25e22fd1698b600310fc56f01b6005b5a3f6227",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/b25e22fd1698b600310fc56f01b6005b5a3f6227",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/b25e22fd1698b600310fc56f01b6005b5a3f6227"
    }
  ],
  "stats": {
    "total": 45,
    "additions": 34,
    "deletions": 11
  },
  "files": [
    {
      "sha": "d0101258b2ed34614ee5352c7e87c9ca4d8d928d",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 8,
      "deletions": 0,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/081e778cb855581fe63a9b26aa582900da5d1a8b/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/081e778cb855581fe63a9b26aa582900da5d1a8b/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=081e778cb855581fe63a9b26aa582900da5d1a8b",
      "patch": "@@ -1,3 +1,11 @@\n+2020-06-17  Tom de Vries  <tdevries@suse.de>\n+\n+\t* lib/gdb.exp (gdb_tcl_unknown): New proc.\n+\t(gdb_init): Use gdb_tcl_unknown for ::unknown override.  Make override\n+\tconditional on presence of gdb_tcl_unknown.\n+\t(gdb_finish): Make override undo conditional on presence of\n+\tgdb_tcl_unknown.\n+\n 2020-06-16  Tom Tromey  <tom@tromey.com>\n \n \t* gdb.python/tui-window.py (failwin): New function.  Register it"
    },
    {
      "sha": "02867fb5bd2e51590efca114943c28c7c84127bb",
      "filename": "gdb/testsuite/lib/gdb.exp",
      "status": "modified",
      "additions": 26,
      "deletions": 11,
      "changes": 37,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/081e778cb855581fe63a9b26aa582900da5d1a8b/gdb/testsuite/lib/gdb.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/081e778cb855581fe63a9b26aa582900da5d1a8b/gdb/testsuite/lib/gdb.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/lib/gdb.exp?ref=081e778cb855581fe63a9b26aa582900da5d1a8b",
      "patch": "@@ -5177,6 +5177,17 @@ proc gdb_cleanup_globals {} {\n     }\n }\n \n+# Create gdb_tcl_unknown, a copy tcl's ::unknown, provided it's present as a\n+# proc.\n+set temp [interp create]\n+if { [interp eval $temp \"info procs ::unknown\"] != \"\" } {\n+    set old_args [interp eval $temp \"info args ::unknown\"]\n+    set old_body [interp eval $temp \"info body ::unknown\"]\n+    eval proc gdb_tcl_unknown {$old_args} {$old_body}\n+}\n+interp delete $temp\n+unset temp\n+\n proc gdb_init { test_file_name } {\n     # Reset the timeout value to the default.  This way, any testcase\n     # that changes the timeout value without resetting it cannot affect\n@@ -5283,14 +5294,16 @@ proc gdb_init { test_file_name } {\n \n     gdb_setup_known_globals\n \n-    # Dejagnu overrides proc unknown.  The dejagnu version may trigger in a\n-    # test-case but abort the entire test run.  To fix this, we install a\n-    # local version here, which reverts dejagnu's override, and restore\n-    # dejagnu's version in gdb_finish.\n-    rename ::unknown ::dejagnu_unknown\n-    proc unknown { args } {\n-\t# Dejagnu saves the original version in ::tcl_unknown, use it.\n-\treturn [uplevel 1 ::tcl_unknown $args]\n+    if { [info procs ::gdb_tcl_unknown] != \"\" } {\n+\t# Dejagnu overrides proc unknown.  The dejagnu version may trigger in a\n+\t# test-case but abort the entire test run.  To fix this, we install a\n+\t# local version here, which reverts dejagnu's override, and restore\n+\t# dejagnu's version in gdb_finish.\n+\trename ::unknown ::dejagnu_unknown\n+\tproc unknown { args } {\n+\t    # Use tcl's unknown.\n+\t    return [uplevel 1 ::gdb_tcl_unknown $args]\n+\t}\n     }\n \n     return $res\n@@ -5302,9 +5315,11 @@ proc gdb_finish { } {\n     global cleanfiles\n     global known_globals\n \n-    # Restore dejagnu's version of proc unknown.\n-    rename ::unknown \"\"\n-    rename ::dejagnu_unknown ::unknown\n+    if { [info procs ::gdb_tcl_unknown] != \"\" } {\n+\t# Restore dejagnu's version of proc unknown.\n+\trename ::unknown \"\"\n+\trename ::dejagnu_unknown ::unknown\n+    }\n \n     # Exit first, so that the files are no longer in use.\n     gdb_exit"
    }
  ]
}