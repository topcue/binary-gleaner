{
  "sha": "4efeb0d3e8ee210cd61b15355cca39b16b66004d",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NGVmZWIwZDNlOGVlMjEwY2Q2MWIxNTM1NWNjYTM5YjE2YjY2MDA0ZA==",
  "commit": {
    "author": {
      "name": "Tankut Baris Aktemur",
      "email": "tankut.baris.aktemur@intel.com",
      "date": "2021-04-22T15:22:39Z"
    },
    "committer": {
      "name": "Tankut Baris Aktemur",
      "email": "tankut.baris.aktemur@intel.com",
      "date": "2021-04-22T15:22:39Z"
    },
    "message": "gdb/continuations: turn continuation functions into inferior methods\n\nTurn continuations-related functions into methods of the inferior\nclass.  This is a refactoring.\n\ngdb/ChangeLog:\n2021-04-22  Tankut Baris Aktemur  <tankut.baris.aktemur@intel.com>\n\n\t* Makefile.in (COMMON_SFILES): Remove continuations.c.\n\t* inferior.c (inferior::add_continuation): New method, adapted\n\tfrom 'add_inferior_continuation'.\n\t(inferior::do_all_continuations): New method, adapted from\n\t'do_all_inferior_continuations'.\n\t(inferior::~inferior): Clear the list of continuations directly.\n\t* inferior.h (class inferior) <continuations>: Rename into...\n\t<m_continuations>: ...this and make private.\n\t* continuations.c: Remove.\n\t* continuations.h: Remove.\n\t* event-top.c: Don't include \"continuations.h\".\n\n\tUpdate the users below.\n\t* inf-loop.c (inferior_event_handler)\n\t* infcmd.c (attach_command)\n\t(notice_new_inferior): Update.",
    "tree": {
      "sha": "4c74b54f1e733a7a222d618091b06c6fca18237d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/4c74b54f1e733a7a222d618091b06c6fca18237d"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/4efeb0d3e8ee210cd61b15355cca39b16b66004d",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4efeb0d3e8ee210cd61b15355cca39b16b66004d",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/4efeb0d3e8ee210cd61b15355cca39b16b66004d",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4efeb0d3e8ee210cd61b15355cca39b16b66004d/comments",
  "author": {
    "login": "barisaktemur",
    "id": 55686642,
    "node_id": "MDQ6VXNlcjU1Njg2NjQy",
    "avatar_url": "https://avatars.githubusercontent.com/u/55686642?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/barisaktemur",
    "html_url": "https://github.com/barisaktemur",
    "followers_url": "https://api.github.com/users/barisaktemur/followers",
    "following_url": "https://api.github.com/users/barisaktemur/following{/other_user}",
    "gists_url": "https://api.github.com/users/barisaktemur/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/barisaktemur/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/barisaktemur/subscriptions",
    "organizations_url": "https://api.github.com/users/barisaktemur/orgs",
    "repos_url": "https://api.github.com/users/barisaktemur/repos",
    "events_url": "https://api.github.com/users/barisaktemur/events{/privacy}",
    "received_events_url": "https://api.github.com/users/barisaktemur/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "barisaktemur",
    "id": 55686642,
    "node_id": "MDQ6VXNlcjU1Njg2NjQy",
    "avatar_url": "https://avatars.githubusercontent.com/u/55686642?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/barisaktemur",
    "html_url": "https://github.com/barisaktemur",
    "followers_url": "https://api.github.com/users/barisaktemur/followers",
    "following_url": "https://api.github.com/users/barisaktemur/following{/other_user}",
    "gists_url": "https://api.github.com/users/barisaktemur/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/barisaktemur/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/barisaktemur/subscriptions",
    "organizations_url": "https://api.github.com/users/barisaktemur/orgs",
    "repos_url": "https://api.github.com/users/barisaktemur/repos",
    "events_url": "https://api.github.com/users/barisaktemur/events{/privacy}",
    "received_events_url": "https://api.github.com/users/barisaktemur/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2"
    }
  ],
  "stats": {
    "total": 159,
    "additions": 51,
    "deletions": 108
  },
  "files": [
    {
      "sha": "d9d0f85135f9327edd2425b5a3e608a3b56dcad8",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 19,
      "deletions": 0,
      "changes": 19,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -1,3 +1,22 @@\n+2021-04-22  Tankut Baris Aktemur  <tankut.baris.aktemur@intel.com>\n+\n+\t* Makefile.in (COMMON_SFILES): Remove continuations.c.\n+\t* inferior.c (inferior::add_continuation): New method, adapted\n+\tfrom 'add_inferior_continuation'.\n+\t(inferior::do_all_continuations): New method, adapted from\n+\t'do_all_inferior_continuations'.\n+\t(inferior::~inferior): Clear the list of continuations directly.\n+\t* inferior.h (class inferior) <continuations>: Rename into...\n+\t<m_continuations>: ...this and make private.\n+\t* continuations.c: Remove.\n+\t* continuations.h: Remove.\n+\t* event-top.c: Don't include \"continuations.h\".\n+\n+\tUpdate the users below.\n+\t* inf-loop.c (inferior_event_handler)\n+\t* infcmd.c (attach_command)\n+\t(notice_new_inferior): Update.\n+\n 2021-04-22  Tankut Baris Aktemur  <tankut.baris.aktemur@intel.com>\n \n \t* inferior.h (class inferior) <continuations>: Change the type"
    },
    {
      "sha": "ba0cabb0216ab5f3faa6c6b4e0e9241c9da11e26",
      "filename": "gdb/Makefile.in",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/Makefile.in",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/Makefile.in",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/Makefile.in?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -1004,7 +1004,6 @@ COMMON_SFILES = \\\n \tcoffread.c \\\n \tcomplaints.c \\\n \tcompleter.c \\\n-\tcontinuations.c \\\n \tcopying.c \\\n \tcorefile.c \\\n \tcorelow.c \\"
    },
    {
      "sha": "2edfd98a9c84e05215b13a88fcabc75d7d244eb8",
      "filename": "gdb/continuations.c",
      "status": "removed",
      "additions": 0,
      "deletions": 56,
      "changes": 56,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2/gdb/continuations.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2/gdb/continuations.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/continuations.c?ref=c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2",
      "patch": "@@ -1,56 +0,0 @@\n-/* Continuations for GDB, the GNU debugger.\n-\n-   Copyright (C) 1986-2021 Free Software Foundation, Inc.\n-\n-   This file is part of GDB.\n-\n-   This program is free software; you can redistribute it and/or modify\n-   it under the terms of the GNU General Public License as published by\n-   the Free Software Foundation; either version 3 of the License, or\n-   (at your option) any later version.\n-\n-   This program is distributed in the hope that it will be useful,\n-   but WITHOUT ANY WARRANTY; without even the implied warranty of\n-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-   GNU General Public License for more details.\n-\n-   You should have received a copy of the GNU General Public License\n-   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n-\n-#include \"defs.h\"\n-#include \"gdbthread.h\"\n-#include \"inferior.h\"\n-#include \"continuations.h\"\n-\n-/* Add a continuation to the continuation list of INFERIOR.  The new\n-   continuation will be added at the front.  */\n-\n-void\n-add_inferior_continuation (std::function<void ()> &&cont)\n-{\n-  struct inferior *inf = current_inferior ();\n-\n-  inf->continuations.emplace_front (std::move (cont));\n-}\n-\n-/* Do all continuations of the current inferior.  */\n-\n-void\n-do_all_inferior_continuations ()\n-{\n-  struct inferior *inf = current_inferior ();\n-  while (!inf->continuations.empty ())\n-    {\n-      auto iter = inf->continuations.begin ();\n-      (*iter) ();\n-      inf->continuations.erase (iter);\n-    }\n-}\n-\n-/* Get rid of all the inferior-wide continuations of INF.  */\n-\n-void\n-discard_all_inferior_continuations (struct inferior *inf)\n-{\n-  inf->continuations.clear ();\n-}"
    },
    {
      "sha": "0ad5fc6e96c9b907b3ae1c264f4b10a25eb6dcbb",
      "filename": "gdb/continuations.h",
      "status": "removed",
      "additions": 0,
      "deletions": 39,
      "changes": 39,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2/gdb/continuations.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2/gdb/continuations.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/continuations.h?ref=c4c493de2bbfc7414d0ec51f40f17cd7b1ff74f2",
      "patch": "@@ -1,39 +0,0 @@\n-/* Continuations for GDB, the GNU debugger.\n-\n-   Copyright (C) 1999-2021 Free Software Foundation, Inc.\n-\n-   This file is part of GDB.\n-\n-   This program is free software; you can redistribute it and/or modify\n-   it under the terms of the GNU General Public License as published by\n-   the Free Software Foundation; either version 3 of the License, or\n-   (at your option) any later version.\n-\n-   This program is distributed in the hope that it will be useful,\n-   but WITHOUT ANY WARRANTY; without even the implied warranty of\n-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-   GNU General Public License for more details.\n-\n-   You should have received a copy of the GNU General Public License\n-   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n-\n-#ifndef CONTINUATIONS_H\n-#define CONTINUATIONS_H\n-\n-#include <functional>\n-\n-struct inferior;\n-\n-/* To continue the execution commands when running gdb asynchronously.\n-   A continuation is an std::function to be called to finish the\n-   command, once the target has stopped.  Such mechanism is used by\n-   the attach command and the remote target when a new inferior is\n-   detected.  */\n-\n-/* Inferior specific (any thread) continuations.  */\n-\n-extern void add_inferior_continuation (std::function<void ()> &&cont);\n-extern void do_all_inferior_continuations ();\n-extern void discard_all_inferior_continuations (struct inferior *inf);\n-\n-#endif"
    },
    {
      "sha": "002a7dc95e065c7425134b15507e76b45d193d85",
      "filename": "gdb/event-top.c",
      "status": "modified",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/event-top.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/event-top.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/event-top.c?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -33,7 +33,6 @@\n #include \"main.h\"\n #include \"gdbthread.h\"\n #include \"observable.h\"\n-#include \"continuations.h\"\n #include \"gdbcmd.h\"\t\t/* for dont_repeat() */\n #include \"annotate.h\"\n #include \"maint.h\""
    },
    {
      "sha": "dc3ffbb27f3b115e1e3ad80412b8c04949cdc07a",
      "filename": "gdb/inf-loop.c",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inf-loop.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inf-loop.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/inf-loop.c?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -26,7 +26,6 @@\n #include \"remote.h\"\n #include \"language.h\"\n #include \"gdbthread.h\"\n-#include \"continuations.h\"\n #include \"interps.h\"\n #include \"top.h\"\n #include \"observable.h\"\n@@ -55,7 +54,7 @@ inferior_event_handler (enum inferior_event_type event_type)\n       /* Do all continuations associated with the whole inferior (not\n \t a particular thread).  */\n       if (inferior_ptid != null_ptid)\n-\tdo_all_inferior_continuations ();\n+\tcurrent_inferior ()->do_all_continuations ();\n \n       /* When running a command list (from a user command, say), these\n \t are only run when the command list is all done.  */"
    },
    {
      "sha": "5aa6b00f20f3da8681a0c736d2b7df85996d6c26",
      "filename": "gdb/infcmd.c",
      "status": "modified",
      "additions": 2,
      "deletions": 3,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/infcmd.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/infcmd.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/infcmd.c?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -47,7 +47,6 @@\n #include \"inline-frame.h\"\n #include \"tracepoint.h\"\n #include \"inf-loop.h\"\n-#include \"continuations.h\"\n #include \"linespec.h\"\n #include \"thread-fsm.h\"\n #include \"top.h\"\n@@ -2645,7 +2644,7 @@ attach_command (const char *args, int from_tty)\n       inferior->control.stop_soon = STOP_QUIETLY_NO_SIGSTOP;\n \n       /* Wait for stop.  */\n-      add_inferior_continuation ([=] ()\n+      inferior->add_continuation ([=] ()\n \t{\n \t  attach_post_wait (from_tty, mode);\n \t});\n@@ -2702,7 +2701,7 @@ notice_new_inferior (thread_info *thr, int leave_running, int from_tty)\n       inferior->control.stop_soon = STOP_QUIETLY_REMOTE;\n \n       /* Wait for stop before proceeding.  */\n-      add_inferior_continuation ([=] ()\n+      inferior->add_continuation ([=] ()\n \t{\n \t  attach_post_wait (from_tty, mode);\n \t});"
    },
    {
      "sha": "df3b7bf81f02d65a57f5853942bf57501bda6d28",
      "filename": "gdb/inferior.c",
      "status": "modified",
      "additions": 18,
      "deletions": 2,
      "changes": 20,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inferior.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inferior.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/inferior.c?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -31,7 +31,6 @@\n #include \"symfile.h\"\n #include \"gdbsupport/environ.h\"\n #include \"cli/cli-utils.h\"\n-#include \"continuations.h\"\n #include \"arch-utils.h\"\n #include \"target-descriptions.h\"\n #include \"readline/tilde.h\"\n@@ -74,7 +73,7 @@ inferior::~inferior ()\n {\n   inferior *inf = this;\n \n-  discard_all_inferior_continuations (inf);\n+  m_continuations.clear ();\n   inferior_free_data (inf);\n   xfree (inf->args);\n   target_desc_info_free (inf->tdesc_info);\n@@ -106,6 +105,23 @@ inferior::tty ()\n   return m_terminal.get ();\n }\n \n+void\n+inferior::add_continuation (std::function<void ()> &&cont)\n+{\n+  m_continuations.emplace_front (std::move (cont));\n+}\n+\n+void\n+inferior::do_all_continuations ()\n+{\n+  while (!m_continuations.empty ())\n+    {\n+      auto iter = m_continuations.begin ();\n+      (*iter) ();\n+      m_continuations.erase (iter);\n+    }\n+}\n+\n struct inferior *\n add_inferior_silent (int pid)\n {"
    },
    {
      "sha": "e0a7d622ccbb2d9323905bfa1612aeffc916e44a",
      "filename": "gdb/inferior.h",
      "status": "modified",
      "additions": 11,
      "deletions": 4,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inferior.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/4efeb0d3e8ee210cd61b15355cca39b16b66004d/gdb/inferior.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/inferior.h?ref=4efeb0d3e8ee210cd61b15355cca39b16b66004d",
      "patch": "@@ -422,6 +422,14 @@ class inferior : public refcounted_object\n   inline safe_inf_threads_range threads_safe ()\n   { return safe_inf_threads_range (this->thread_list); }\n \n+  /* Continuations-related methods.  A continuation is an std::function\n+     to be called to finish the execution of a command when running\n+     GDB asynchronously.  A continuation is executed after any thread\n+     of this inferior stops.  Continuations are used by the attach\n+     command and the remote target when a new inferior is detected.  */\n+  void add_continuation (std::function<void ()> &&cont);\n+  void do_all_continuations ();\n+\n   /* Set/get file name for default use for standard in/out in the\n      inferior.  On Unix systems, we try to make TERMINAL_NAME the\n      inferior's controlling terminal.  If TERMINAL_NAME is nullptr or\n@@ -508,10 +516,6 @@ class inferior : public refcounted_object\n   /* True if we're in the process of detaching from this inferior.  */\n   bool detaching = false;\n \n-  /* What is left to do for an execution command after any thread of\n-     this inferior stops.  */\n-  std::list<std::function<void ()>> continuations;\n-\n   /* True if setup_inferior wasn't called for this inferior yet.\n      Until that is done, we must not access inferior memory or\n      registers, as we haven't determined the target\n@@ -559,6 +563,9 @@ class inferior : public refcounted_object\n \n   /* The name of terminal device to use for I/O.  */\n   gdb::unique_xmalloc_ptr<char> m_terminal;\n+\n+  /* The list of continuations.  */\n+  std::list<std::function<void ()>> m_continuations;\n };\n \n /* Keep a registry of per-inferior data-pointers required by other GDB"
    }
  ]
}