{
  "sha": "89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ODk3NTNiYmY4MTAyZWRjMmFhNDI2MmE0ZDQzZjFhNzFhMTBlMzRmMw==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-02-20T05:15:44Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-02-21T03:58:16Z"
    },
    "message": "Warn when a script redefines a symbol\n\nNote that we don't even warn if scripts adjust a symbol as in\nld-elf/var1 and ld-scripts/pr14962.\n\ninclude/\n\t* bfdlink.h (struct bfd_link_info): Add warn_multiple_definition.\nld/\n\t* ldexp.c (exp_fold_tree_1): Warn on script defining a symbol\n\tdefined in an object file.\n\t* ldmain.c (multiple_definition): Heed info->warn_multiple_definition.\n\t* testsuite/ld-scripts/defined5.d: Expect a warning.",
    "tree": {
      "sha": "3afa35082bf7898409aa8e8ff507e8431b32c99d",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/3afa35082bf7898409aa8e8ff507e8431b32c99d"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "93993f67849234cff651542c3d4d9f0f3d2fa651",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/93993f67849234cff651542c3d4d9f0f3d2fa651",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/93993f67849234cff651542c3d4d9f0f3d2fa651"
    }
  ],
  "stats": {
    "total": 43,
    "additions": 32,
    "deletions": 11
  },
  "files": [
    {
      "sha": "616b923b53b15efd45ec8aa397e01d8bf0dfef1d",
      "filename": "include/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/include/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/include/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/include/ChangeLog?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -1,3 +1,7 @@\n+2021-02-21  Alan Modra  <amodra@gmail.com>\n+\n+\t* bfdlink.h (struct bfd_link_info): Add warn_multiple_definition.\n+\n 2021-02-17  Nick Alcock  <nick.alcock@oracle.com>\n \n \t* ctf-api.h (ctf_arc_lookup_symbol_name): New."
    },
    {
      "sha": "95728b6f031ca5b6eb6306fdd497859cc5dad360",
      "filename": "include/bfdlink.h",
      "status": "modified",
      "additions": 6,
      "deletions": 2,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/include/bfdlink.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/include/bfdlink.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/include/bfdlink.h?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -465,12 +465,16 @@ struct bfd_link_info\n      statics.  */\n   unsigned int task_link: 1;\n \n-  /* TRUE if ok to have multiple definition.  */\n+  /* TRUE if ok to have multiple definitions, without warning.  */\n   unsigned int allow_multiple_definition: 1;\n \n-  /* TRUE if ok to have prohibit multiple definition of absolute symbols.  */\n+  /* TRUE if multiple definition of absolute symbols (eg. from -R) should\n+     be reported.  */\n   unsigned int prohibit_multiple_definition_absolute: 1;\n \n+  /* TRUE if multiple definitions should only warn.  */\n+  unsigned int warn_multiple_definition: 1;\n+\n   /* TRUE if ok to have version with no definition.  */\n   unsigned int allow_undefined_version: 1;\n "
    },
    {
      "sha": "2339a4014cdfe932c177f3e1553ac923701e6466",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -1,3 +1,10 @@\n+2021-02-21  Alan Modra  <amodra@gmail.com>\n+\n+\t* ldexp.c (exp_fold_tree_1): Warn on script defining a symbol\n+\tdefined in an object file.\n+\t* ldmain.c (multiple_definition): Heed info->warn_multiple_definition.\n+\t* testsuite/ld-scripts/defined5.d: Expect a warning.\n+\n 2021-02-19  Alan Modra  <amodra@gmail.com>\n \n \t* testsuite/lib/ld-lib.exp: Whitespace."
    },
    {
      "sha": "016784505b2b0fad4dc511729f1e52537a39417b",
      "filename": "ld/ldexp.c",
      "status": "modified",
      "additions": 9,
      "deletions": 6,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ldexp.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ldexp.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldexp.c?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -1186,16 +1186,19 @@ exp_fold_tree_1 (etree_type *tree)\n \t\t{\n \t\t  if (expld.result.section == NULL)\n \t\t    expld.result.section = expld.section;\n-\t\t  if (!update_definedness (tree->assign.dst, h) && 0)\n+\t\t  if (!update_definedness (tree->assign.dst, h)\n+\t\t      && expld.assign_name != NULL)\n \t\t    {\n-\t\t      /* Symbol was already defined.  For now this error\n-\t\t\t is disabled because it causes failures in the ld\n-\t\t\t testsuite: ld-elf/var1, ld-scripts/defined5, and\n-\t\t\t ld-scripts/pr14962.  Some of these no doubt\n-\t\t\t reflect scripts used in the wild.  */\n+\t\t      /* Symbol was already defined, and the script isn't\n+\t\t\t modifying the symbol value for some reason as in\n+\t\t\t ld-elf/var1 and ld-scripts/pr14962.\n+\t\t\t For now this is only a warning.  */\n+\t\t      unsigned int warn = link_info.warn_multiple_definition;\n+\t\t      link_info.warn_multiple_definition = 1;\n \t\t      (*link_info.callbacks->multiple_definition)\n \t\t\t(&link_info, h, link_info.output_bfd,\n \t\t\t expld.result.section, expld.result.value);\n+\t\t      link_info.warn_multiple_definition = warn;\n \t\t    }\n \t\t  if (expld.phase == lang_fixed_phase_enum)\n \t\t    {"
    },
    {
      "sha": "5c88ee744f81ccd61c20246efd5675f6a2052beb",
      "filename": "ld/ldmain.c",
      "status": "modified",
      "additions": 3,
      "deletions": 1,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ldmain.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/ldmain.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ldmain.c?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -1074,7 +1074,9 @@ multiple_definition (struct bfd_link_info *info,\n       nval = oval;\n       obfd = NULL;\n     }\n-  einfo (_(\"%X%P: %C: multiple definition of `%pT'\"),\n+  if (!info->warn_multiple_definition)\n+    einfo (\"%X\");\n+  einfo (_(\"%P: %C: multiple definition of `%pT'\"),\n \t nbfd, nsec, nval, name);\n   if (obfd != NULL)\n     einfo (_(\"; %D: first defined here\"), obfd, osec, oval);"
    },
    {
      "sha": "7aa680b85ab2488808afd792d345cb384e4b4a3d",
      "filename": "ld/testsuite/ld-scripts/defined5.d",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/testsuite/ld-scripts/defined5.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/89753bbf8102edc2aa4262a4d43f1a71a10e34f3/ld/testsuite/ld-scripts/defined5.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-scripts/defined5.d?ref=89753bbf8102edc2aa4262a4d43f1a71a10e34f3",
      "patch": "@@ -1,10 +1,11 @@\n #ld: -Tdefined5.t\n+#warning: .*multiple definition of `defined'.*\n #nm: -B\n-#source: defined5.s\n #xfail: [is_xcoff_format]\n # xcoff outputs value of \"defined\" from the object file\n \n-# Check that arithmetic on DEFINED works.\n+# Check that a script can override an object file symbol, if multiple\n+# definitions are allowed.  See pr12356.\n #...\n 0+1000 D defined\n #pass"
    }
  ]
}