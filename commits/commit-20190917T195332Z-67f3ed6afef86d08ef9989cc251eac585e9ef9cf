{
  "sha": "67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NjdmM2VkNmFmZWY4NmQwOGVmOTk4OWNjMjUxZWFjNTg1ZTllZjljZg==",
  "commit": {
    "author": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-09-07T23:05:22Z"
    },
    "committer": {
      "name": "Andrew Burgess",
      "email": "andrew.burgess@embecosm.com",
      "date": "2019-09-17T19:53:32Z"
    },
    "message": "gdb: Catch exceptions when accessing source cache\n\nThe source_cache::get_line_charpos function can currently throw an\nexception if the source file is missing, which doesn't match the\nexpected behaviour documented in the functions header file.  The\ndocumented behaviour is to return false on failure, and this is how\nthe function appears to be used throughout GDB.\n\nI spotted this in the 'info source' command, currently for a missing\nsource file you'll see something like this:\n\n  (gdb) info source\n  Current source file is /path/to/src/file.c\n  Compilation directory is /path/to/build/\n  /path/to/src/file.c: No such file or directory.\n  (gdb)\n\nAfter this patch we see this:\n\n  (gdb) info source\n  Current source file is /path/to/src/file.c\n  Compilation directory is /path/to/build/\n  Source language is c.\n  Producer is COMPILER VERSION AND FLAGS.\n  Compiled with DWARF 2 debugging format.\n  Does not include preprocessor macro info.\n\nWe don't currently indicate that the source file can't be found, and\nmaybe that would be something worth adding in the future.\n\ngdb/ChangeLog:\n\n\t* source-cache.c (source_cache::get_line_charpos): Catch\n\texceptions and return false, this matches the behaviour documented\n\tin the header file.\n\ngdb/testsuite/ChangeLog:\n\n\t* gdb.base/list-missing-source.exp: New file.",
    "tree": {
      "sha": "b4a93b3ab7485c8f1dbf8b426463f9056502cbf6",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b4a93b3ab7485c8f1dbf8b426463f9056502cbf6"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/comments",
  "author": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "T-J-Teru",
    "id": 475372,
    "node_id": "MDQ6VXNlcjQ3NTM3Mg==",
    "avatar_url": "https://avatars.githubusercontent.com/u/475372?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/T-J-Teru",
    "html_url": "https://github.com/T-J-Teru",
    "followers_url": "https://api.github.com/users/T-J-Teru/followers",
    "following_url": "https://api.github.com/users/T-J-Teru/following{/other_user}",
    "gists_url": "https://api.github.com/users/T-J-Teru/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/T-J-Teru/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/T-J-Teru/subscriptions",
    "organizations_url": "https://api.github.com/users/T-J-Teru/orgs",
    "repos_url": "https://api.github.com/users/T-J-Teru/repos",
    "events_url": "https://api.github.com/users/T-J-Teru/events{/privacy}",
    "received_events_url": "https://api.github.com/users/T-J-Teru/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "743321899674e03cf572fcfeb6c7705aded7c9a5",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/743321899674e03cf572fcfeb6c7705aded7c9a5",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/743321899674e03cf572fcfeb6c7705aded7c9a5"
    }
  ],
  "stats": {
    "total": 100,
    "additions": 90,
    "deletions": 10
  },
  "files": [
    {
      "sha": "c9be686c2612f2cc8b811e00e938692ee78cfb80",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
      "patch": "@@ -1,3 +1,9 @@\n+2019-09-17  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* source-cache.c (source_cache::get_line_charpos): Catch\n+\texceptions and return false, this matches the behaviour documented\n+\tin the header file.\n+\n 2019-09-17  Joel Brobecker  <brobecker@adacore.com>\n \n \t* ada-tasks.c (info_task): Remove quoting of the task's name."
    },
    {
      "sha": "7a52ce9458e538153412e89d576a2af4b43afa41",
      "filename": "gdb/source-cache.c",
      "status": "modified",
      "additions": 17,
      "deletions": 10,
      "changes": 27,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/source-cache.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/source-cache.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/source-cache.c?ref=67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
      "patch": "@@ -231,19 +231,26 @@ bool\n source_cache::get_line_charpos (struct symtab *s,\n \t\t\t\tconst std::vector<off_t> **offsets)\n {\n-  std::string fullname = symtab_to_fullname (s);\n+  try\n+    {\n+      std::string fullname = symtab_to_fullname (s);\n+\n+      auto iter = m_offset_cache.find (fullname);\n+      if (iter == m_offset_cache.end ())\n+\t{\n+\t  ensure (s);\n+\t  iter = m_offset_cache.find (fullname);\n+\t  /* cache_source_text ensured this was entered.  */\n+\t  gdb_assert (iter != m_offset_cache.end ());\n+\t}\n \n-  auto iter = m_offset_cache.find (fullname);\n-  if (iter == m_offset_cache.end ())\n+      *offsets = &iter->second;\n+      return true;\n+    }\n+  catch (const gdb_exception_error &e)\n     {\n-      ensure (s);\n-      iter = m_offset_cache.find (fullname);\n-      /* cache_source_text ensured this was entered.  */\n-      gdb_assert (iter != m_offset_cache.end ());\n+      return false;\n     }\n-\n-  *offsets = &iter->second;\n-  return true;\n }\n \n /* A helper function that extracts the desired source lines from TEXT,"
    },
    {
      "sha": "b9060ef5d0545466b19778c14cabd022b9bae5d0",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 4,
      "deletions": 0,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
      "patch": "@@ -1,3 +1,7 @@\n+2019-09-17  Andrew Burgess  <andrew.burgess@embecosm.com>\n+\n+\t* gdb.base/list-missing-source.exp: New file.\n+\n 2019-09-14  Tom de Vries  <tdevries@suse.de>\n \n \tPR teststuite/24599"
    },
    {
      "sha": "703603e7cb24fbb1061360c164686743f35b3b40",
      "filename": "gdb/testsuite/gdb.base/list-missing-source.exp",
      "status": "added",
      "additions": 63,
      "deletions": 0,
      "changes": 63,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/testsuite/gdb.base/list-missing-source.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/67f3ed6afef86d08ef9989cc251eac585e9ef9cf/gdb/testsuite/gdb.base/list-missing-source.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.base/list-missing-source.exp?ref=67f3ed6afef86d08ef9989cc251eac585e9ef9cf",
      "patch": "@@ -0,0 +1,63 @@\n+# Copyright 2019 Free Software Foundation, Inc.\n+\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+# This test checks how GDB handles missing source files around the\n+# 'list' and 'info source' commands.\n+\n+standard_testfile\n+\n+# Create a source file in the output directory.\n+set srcfile [standard_output_file main.c]\n+set fd [open \"$srcfile\" w]\n+puts $fd {\n+int\n+main ()\n+{\n+  return 0;\n+}\n+}\n+close $fd\n+\n+# Compile the source file.\n+set options \"debug\"\n+if  { [gdb_compile \"${srcfile}\" \"${binfile}\" \\\n+\t   executable $options] != \"\" } {\n+    untested \"failed to compile\"\n+    return -1\n+}\n+\n+# Now delete the source file.\n+file delete $srcfile\n+\n+# Now start GDB, run to main and try to list the source.\n+clean_restart ${binfile}\n+\n+if ![runto_main] then {\n+    fail \"can't run to main\"\n+    return 0\n+}\n+\n+gdb_test \"list\" \"1\\[ \\t\\]+in\\[ \\t\\]+$srcfile\"\n+\n+gdb_test \"info source\" \\\n+    [multi_line \\\n+\t \"info source\" \\\n+\t \"Current source file is $srcfile\" \\\n+\t \"Compilation directory is \\[^\\n\\r\\]+\" \\\n+\t \"Source language is c.\" \\\n+\t \"Producer is \\[^\\n\\r\\]+\" \\\n+\t \"Compiled with DWARF $decimal debugging format.\" \\\n+\t \"Does not include preprocessor macro info.\" ]\n+"
    }
  ]
}