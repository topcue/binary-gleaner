{
  "sha": "7811fa5995fcb68d30edc0f53d8823c011a12854",
  "node_id": "C_kwDOANOeidoAKDc4MTFmYTU5OTVmY2I2OGQzMGVkYzBmNTNkODgyM2MwMTFhMTI4NTQ",
  "commit": {
    "author": {
      "name": "Aaron Merey",
      "email": "amerey@redhat.com",
      "date": "2021-10-29T23:55:57Z"
    },
    "committer": {
      "name": "Aaron Merey",
      "email": "amerey@redhat.com",
      "date": "2021-10-30T00:58:21Z"
    },
    "message": "gdb: add set/show commands for managing debuginfod\n\nAdd 'set debuginfod' command.  Accepts 'on', 'off' or 'ask' as an\nargument.  'on' enables debuginfod for the current session.  'off'\ndisables debuginfod for the current session.  'ask' will prompt\nthe user to either enable or disable debuginfod when the next query\nis about to be performed:\n\n    This GDB supports auto-downloading debuginfo from the following URLs:\n    <URL1> <URL2> ...\n    Enable debuginfod for this session? (y or [n]) y\n    Debuginfod has been enabled.\n    To make this setting permanent, add 'set debuginfod on' to .gdbinit.\n\nFor interactive sessions, 'ask' is the default.  For non-interactive\nsessions, 'off' is the default.\n\nAdd 'show debuginfod status' command.  Displays whether debuginfod\nis set to 'on', 'off' or 'ask'.\n\nAdd 'set/show debuginfod urls' commands. Accepts a string of\nspace-separated debuginfod server URLs to be queried.  The default\nvalue is copied from the DEBUGINFOD_URLS environment variable.\n\nFinally add 'set/show debuginfod verbose' commands to control whether\ndebuginfod-related output is displayed.  Verbose output is enabled\nby default.\n\n    (gdb) run\n    Starting program: /bin/sleep 5\n    Download failed: No route to host.  Continuing without debug info for /lib64/libc.so.6.\n\nIf GDB is not built with debuginfod then these commands will just display\n\n    Support for debuginfod is not compiled into GDB.",
    "tree": {
      "sha": "ba6410c7de6620c1e624bc2d0c80e10cfab746bb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/ba6410c7de6620c1e624bc2d0c80e10cfab746bb"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/7811fa5995fcb68d30edc0f53d8823c011a12854",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7811fa5995fcb68d30edc0f53d8823c011a12854",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/7811fa5995fcb68d30edc0f53d8823c011a12854",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7811fa5995fcb68d30edc0f53d8823c011a12854/comments",
  "author": {
    "login": "aaronmerey",
    "id": 28735867,
    "node_id": "MDQ6VXNlcjI4NzM1ODY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/28735867?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aaronmerey",
    "html_url": "https://github.com/aaronmerey",
    "followers_url": "https://api.github.com/users/aaronmerey/followers",
    "following_url": "https://api.github.com/users/aaronmerey/following{/other_user}",
    "gists_url": "https://api.github.com/users/aaronmerey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aaronmerey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aaronmerey/subscriptions",
    "organizations_url": "https://api.github.com/users/aaronmerey/orgs",
    "repos_url": "https://api.github.com/users/aaronmerey/repos",
    "events_url": "https://api.github.com/users/aaronmerey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aaronmerey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "aaronmerey",
    "id": 28735867,
    "node_id": "MDQ6VXNlcjI4NzM1ODY3",
    "avatar_url": "https://avatars.githubusercontent.com/u/28735867?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/aaronmerey",
    "html_url": "https://github.com/aaronmerey",
    "followers_url": "https://api.github.com/users/aaronmerey/followers",
    "following_url": "https://api.github.com/users/aaronmerey/following{/other_user}",
    "gists_url": "https://api.github.com/users/aaronmerey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/aaronmerey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/aaronmerey/subscriptions",
    "organizations_url": "https://api.github.com/users/aaronmerey/orgs",
    "repos_url": "https://api.github.com/users/aaronmerey/repos",
    "events_url": "https://api.github.com/users/aaronmerey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/aaronmerey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4a3a56c5f38f4772659a3efcb6ffd53d431a8fff",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4a3a56c5f38f4772659a3efcb6ffd53d431a8fff",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4a3a56c5f38f4772659a3efcb6ffd53d431a8fff"
    }
  ],
  "stats": {
    "total": 301,
    "additions": 290,
    "deletions": 11
  },
  "files": [
    {
      "sha": "097977cd45cddaea6c3d9fc3acde585b8f64bb43",
      "filename": "gdb/debuginfod-support.c",
      "status": "modified",
      "additions": 268,
      "deletions": 8,
      "changes": 276,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7811fa5995fcb68d30edc0f53d8823c011a12854/gdb/debuginfod-support.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7811fa5995fcb68d30edc0f53d8823c011a12854/gdb/debuginfod-support.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/debuginfod-support.c?ref=7811fa5995fcb68d30edc0f53d8823c011a12854",
      "patch": "@@ -18,10 +18,22 @@\n \n #include \"defs.h\"\n #include <errno.h>\n-#include \"cli/cli-style.h\"\n #include \"gdbsupport/scoped_fd.h\"\n #include \"debuginfod-support.h\"\n #include \"gdbsupport/gdb_optional.h\"\n+#include \"cli/cli-cmds.h\"\n+#include \"cli/cli-style.h\"\n+\n+/* Set/show debuginfod commands.  */\n+static cmd_list_element *set_debuginfod_prefix_list;\n+static cmd_list_element *show_debuginfod_prefix_list;\n+\n+static const char debuginfod_on[] = \"on\";\n+static const char debuginfod_off[] = \"off\";\n+static const char debuginfod_ask[] = \"ask\";\n+\n+static const char *debuginfod_enable = debuginfod_ask;\n+static unsigned debuginfod_verbose = 1;\n \n #ifndef HAVE_LIBDEBUGINFOD\n scoped_fd\n@@ -41,6 +53,73 @@ debuginfod_debuginfo_query (const unsigned char *build_id,\n {\n   return scoped_fd (-ENOSYS);\n }\n+\n+#define NO_IMPL _(\"Support for debuginfod is not compiled into GDB.\")\n+\n+/* Stub set/show commands that indicate debuginfod is not supported.  */\n+\n+static void\n+set_debuginfod_on_command (const char *args, int from_tty)\n+{\n+  error (NO_IMPL);\n+  debuginfod_enable = debuginfod_off;\n+}\n+\n+static void\n+set_debuginfod_off_command (const char *args, int from_tty)\n+{\n+  error (NO_IMPL);\n+  debuginfod_enable = debuginfod_off;\n+}\n+\n+static void\n+set_debuginfod_ask_command (const char *args, int from_tty)\n+{\n+  error (NO_IMPL);\n+  debuginfod_enable = debuginfod_off;\n+}\n+\n+static void\n+show_debuginfod_status_command (const char *args, int from_tty)\n+{\n+  error (NO_IMPL);\n+}\n+\n+static void\n+set_debuginfod_urls_command (const std::string& urls)\n+{\n+  error (NO_IMPL);\n+}\n+\n+static const std::string&\n+get_debuginfod_urls_command ()\n+{\n+  static std::string empty;\n+  return empty;\n+}\n+\n+static void\n+show_debuginfod_urls_command (struct ui_file *file, int from_tty,\n+\t\t\t      struct cmd_list_element *cmd, const char *value)\n+{\n+  error (NO_IMPL);\n+}\n+\n+static void\n+set_debuginfod_verbose_command (const char *args, int from_tty,\n+\t\t\t\tstruct cmd_list_element *c)\n+{\n+  error (NO_IMPL);\n+  debuginfod_verbose = 0;\n+}\n+\n+static void\n+show_debuginfod_verbose_command (struct ui_file *file, int from_tty,\n+\t\t\t\t struct cmd_list_element *cmd,\n+\t\t\t\t const char *value)\n+{\n+  error (NO_IMPL);\n+}\n #else\n #include <elfutils/debuginfod.h>\n \n@@ -68,6 +147,96 @@ struct debuginfod_client_deleter\n using debuginfod_client_up\n   = std::unique_ptr<debuginfod_client, debuginfod_client_deleter>;\n \n+/* Enable debuginfod.  */\n+\n+static void\n+set_debuginfod_on_command (const char *args, int from_tty)\n+{\n+  debuginfod_enable = debuginfod_on;\n+}\n+\n+/* Disable debuginfod.  */\n+\n+static void\n+set_debuginfod_off_command (const char *args, int from_tty)\n+{\n+  debuginfod_enable = debuginfod_off;\n+}\n+\n+/* Before next query, ask user whether to enable debuginfod.  */\n+\n+static void\n+set_debuginfod_ask_command (const char *args, int from_tty)\n+{\n+  debuginfod_enable = debuginfod_ask;\n+}\n+\n+/* Show whether debuginfod is enabled.  */\n+\n+static void\n+show_debuginfod_status_command (const char *args, int from_tty)\n+{\n+  printf_unfiltered (_(\"Debuginfod functionality is currently set to \" \\\n+\t\t     \"\\\"%s\\\".\\n\"), debuginfod_enable);\n+}\n+\n+/* Set the URLs that debuginfod will query.  */\n+\n+static void\n+set_debuginfod_urls_command (const std::string& urls)\n+{\n+  if (setenv (\"DEBUGINFOD_URLS\", urls.c_str (), 1) != 0)\n+    warning (_(\"Unable to set debuginfod URLs: %s\"), safe_strerror (errno));\n+}\n+\n+/* Get current debuginfod URLs.  */\n+\n+static const std::string&\n+get_debuginfod_urls_command ()\n+{\n+  static std::string urls;\n+  const char *envvar = getenv (DEBUGINFOD_URLS_ENV_VAR);\n+\n+  if (envvar != nullptr)\n+    urls = envvar;\n+  else\n+    urls.clear ();\n+\n+  return urls;\n+}\n+\n+/* Show the URLs that debuginfod will query.  */\n+\n+static void\n+show_debuginfod_urls_command (struct ui_file *file, int from_tty,\n+\t\t\t      struct cmd_list_element *cmd, const char *value)\n+{\n+  if (value == nullptr || value[0] == '\\0')\n+    fprintf_unfiltered (file, _(\"Debuginfod URLs have not been set.\\n\"));\n+  else\n+    fprintf_filtered (file, _(\"Debuginfod URLs are currently set to:\\n%s\\n\"),\n+\t\t      value);\n+}\n+\n+/* No-op setter used for compatibility when gdb is built without debuginfod.  */\n+\n+static void\n+set_debuginfod_verbose_command (const char *args, int from_tty,\n+\t\t\t\tstruct cmd_list_element *c)\n+{\n+  return;\n+}\n+\n+/* Show verbosity.  */\n+\n+static void\n+show_debuginfod_verbose_command (struct ui_file *file, int from_tty,\n+\t\t\t\t struct cmd_list_element *cmd, const char *value)\n+{\n+  fprintf_filtered (file, _(\"Debuginfod verbose output is set to %s.\\n\"),\n+\t\t    value);\n+}\n+\n static int\n progressfn (debuginfod_client *c, long cur, long total)\n {\n@@ -120,6 +289,42 @@ get_debuginfod_client ()\n   return global_client.get ();\n }\n \n+/* Check if debuginfod is enabled.  If configured to do so, ask the user\n+   whether to enable debuginfod.  */\n+\n+static bool\n+debuginfod_enabled ()\n+{\n+  const char *urls = getenv (DEBUGINFOD_URLS_ENV_VAR);\n+\n+  if (urls == nullptr || urls[0] == '\\0'\n+      || debuginfod_enable == debuginfod_off)\n+    return false;\n+\n+  if (debuginfod_enable == debuginfod_ask)\n+    {\n+      int resp = nquery (_(\"\\nThis GDB supports auto-downloading debuginfo \" \\\n+\t\t\t   \"from the following URLs:\\n%s\\nEnable debuginfod \" \\\n+\t\t\t   \"for this session? \"),\n+\t\t\t urls);\n+      if (!resp)\n+\t{\n+\t  printf_filtered (_(\"Debuginfod has been disabled.\\nTo make this \" \\\n+\t\t\t     \"setting permanent, add \\'set debuginfod off\\' \" \\\n+\t\t\t     \"to .gdbinit.\\n\"));\n+\t  debuginfod_enable = debuginfod_off;\n+\t  return false;\n+\t}\n+\n+      printf_filtered (_(\"Debuginfod has been enabled.\\nTo make this \" \\\n+\t\t\t \"setting permanent, add \\'set debuginfod on\\' \" \\\n+\t\t\t \"to .gdbinit.\\n\"));\n+      debuginfod_enable = debuginfod_on;\n+    }\n+\n+  return true;\n+}\n+\n /* See debuginfod-support.h  */\n \n scoped_fd\n@@ -128,8 +333,7 @@ debuginfod_source_query (const unsigned char *build_id,\n \t\t\t const char *srcpath,\n \t\t\t gdb::unique_xmalloc_ptr<char> *destname)\n {\n-  const char *urls_env_var = getenv (DEBUGINFOD_URLS_ENV_VAR);\n-  if (urls_env_var == NULL || urls_env_var[0] == '\\0')\n+  if (!debuginfod_enabled ())\n     return scoped_fd (-ENOSYS);\n \n   debuginfod_client *c = get_debuginfod_client ();\n@@ -147,8 +351,7 @@ debuginfod_source_query (const unsigned char *build_id,\n \t\t\t\t\tnullptr));\n   debuginfod_set_user_data (c, nullptr);\n \n-  /* TODO: Add 'set debug debuginfod' command to control when error messages are shown.  */\n-  if (fd.get () < 0 && fd.get () != -ENOENT)\n+  if (debuginfod_verbose > 0 && fd.get () < 0 && fd.get () != -ENOENT)\n     printf_filtered (_(\"Download failed: %s.  Continuing without source file %ps.\\n\"),\n \t\t     safe_strerror (-fd.get ()),\n \t\t     styled_string (file_name_style.style (),  srcpath));\n@@ -167,8 +370,7 @@ debuginfod_debuginfo_query (const unsigned char *build_id,\n \t\t\t    const char *filename,\n \t\t\t    gdb::unique_xmalloc_ptr<char> *destname)\n {\n-  const char *urls_env_var = getenv (DEBUGINFOD_URLS_ENV_VAR);\n-  if (urls_env_var == NULL || urls_env_var[0] == '\\0')\n+  if (!debuginfod_enabled ())\n     return scoped_fd (-ENOSYS);\n \n   debuginfod_client *c = get_debuginfod_client ();\n@@ -184,7 +386,7 @@ debuginfod_debuginfo_query (const unsigned char *build_id,\n \t\t\t\t\t   &dname));\n   debuginfod_set_user_data (c, nullptr);\n \n-  if (fd.get () < 0 && fd.get () != -ENOENT)\n+  if (debuginfod_verbose > 0 && fd.get () < 0 && fd.get () != -ENOENT)\n     printf_filtered (_(\"Download failed: %s.  Continuing without debug info for %ps.\\n\"),\n \t\t     safe_strerror (-fd.get ()),\n \t\t     styled_string (file_name_style.style (),  filename));\n@@ -195,3 +397,61 @@ debuginfod_debuginfo_query (const unsigned char *build_id,\n   return fd;\n }\n #endif\n+\n+/* Register debuginfod commands.  */\n+\n+void _initialize_debuginfod ();\n+void\n+_initialize_debuginfod ()\n+{\n+  /* set/show debuginfod */\n+  add_setshow_prefix_cmd (\"debuginfod\", class_run,\n+\t\t\t  _(\"Set debuginfod options\"),\n+\t\t\t  _(\"Show debuginfod options\"),\n+\t\t\t  &set_debuginfod_prefix_list,\n+\t\t\t  &show_debuginfod_prefix_list,\n+\t\t\t  &setlist, &showlist);\n+\n+  /* set debuginfod on */\n+  add_cmd (\"on\", class_run, set_debuginfod_on_command,\n+\t   _(\"Enable debuginfod.\"), &set_debuginfod_prefix_list);\n+\n+  /* set debuginfod off */\n+  add_cmd (\"off\", class_run, set_debuginfod_off_command,\n+\t   _(\"Disable debuginfod.\"), &set_debuginfod_prefix_list);\n+\n+  /* set debuginfod ask */\n+  add_cmd (\"ask\", class_run, set_debuginfod_ask_command, _(\"\\\n+Ask the user whether to enable debuginfod before performing the next query.\"),\n+\t   &set_debuginfod_prefix_list);\n+\n+  /* show debuginfod status */\n+  add_cmd (\"status\", class_run, show_debuginfod_status_command,\n+\t   _(\"Show whether debuginfod is set to \\\"on\\\", \\\"off\\\" or \\\"ask\\\".\"),\n+\t   &show_debuginfod_prefix_list);\n+\n+  /* set/show debuginfod urls */\n+  add_setshow_string_noescape_cmd (\"urls\", class_run, _(\"\\\n+Set the list of debuginfod server URLs.\"), _(\"\\\n+Show the list of debuginfod server URLs.\"), _(\"\\\n+Manage the space-separated list of debuginfod server URLs that GDB will query \\\n+when missing debuginfo, executables or source files.\\nThe default value is \\\n+copied from the DEBUGINFOD_URLS environment variable.\"),\n+\t\t\t\t   set_debuginfod_urls_command,\n+\t\t\t\t   get_debuginfod_urls_command,\n+\t\t\t\t   show_debuginfod_urls_command,\n+\t\t\t\t   &set_debuginfod_prefix_list,\n+\t\t\t\t   &show_debuginfod_prefix_list);\n+\n+  /* set/show debuginfod verbose */\n+  add_setshow_zuinteger_cmd (\"verbose\", class_support,\n+\t\t\t     &debuginfod_verbose, _(\"\\\n+Set verbosity of debuginfod output.\"), _(\"\\\n+Show debuginfod debugging.\"), _(\"\\\n+When set to a non-zero value, display verbose output for each debuginfod \\\n+query.\\nTo disable, set to zero.  Verbose output is displayed by default.\"),\n+\t\t\t     set_debuginfod_verbose_command,\n+\t\t\t     show_debuginfod_verbose_command,\n+\t\t\t     &set_debuginfod_prefix_list,\n+\t\t\t     &show_debuginfod_prefix_list);\n+}"
    },
    {
      "sha": "92f3cd8b01dd6f7a0aca9de4d46c09c040a5ff8f",
      "filename": "gdb/testsuite/gdb.debuginfod/fetch_src_and_symbols.exp",
      "status": "modified",
      "additions": 22,
      "deletions": 3,
      "changes": 25,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7811fa5995fcb68d30edc0f53d8823c011a12854/gdb/testsuite/gdb.debuginfod/fetch_src_and_symbols.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7811fa5995fcb68d30edc0f53d8823c011a12854/gdb/testsuite/gdb.debuginfod/fetch_src_and_symbols.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.debuginfod/fetch_src_and_symbols.exp?ref=7811fa5995fcb68d30edc0f53d8823c011a12854",
      "patch": "@@ -222,7 +222,8 @@ proc local_url { } {\n     setenv DEBUGINFOD_URLS http://127.0.0.1:$port\n \n     # gdb should now find the symbol and source files\n-    clean_restart $binfile\n+    clean_restart\n+    gdb_test \"file $binfile\" \"\" \"file [file tail $binfile]\" \"Enable debuginfod?.*\" \"y\"\n     gdb_test_no_output \"set substitute-path $outputdir /dev/null\" \\\n \t\"set substitute-path\"\n     gdb_test \"br main\" \"Breakpoint 1 at.*file.*\"\n@@ -231,8 +232,26 @@ proc local_url { } {\n     # gdb should now find the debugaltlink file\n     clean_restart\n     gdb_test \"file ${binfile}_alt.o\" \\\n-\t\".*Reading symbols from ${binfile}_alt.o\\.\\.\\.*\" \\\n-\t\"file [file tail ${binfile}_alt.o]\"\n+\t\".*Downloading.*separate debug info.*\" \\\n+\t\"file [file tail ${binfile}_alt.o]\" \\\n+\t\".*Enable debuginfod?.*\" \"y\"\n+\n+    # Configure debuginfod with commands\n+    unsetenv DEBUGINFOD_URLS\n+    clean_restart\n+    gdb_test \"file $binfile\" \".*No debugging symbols.*\" \\\n+\t\"file [file tail $binfile] cmd\"\n+    gdb_test_no_output \"set debuginfod off\"\n+    gdb_test_no_output \"set debuginfod urls http://127.0.0.1:$port\"\n+\n+    # gdb shouldn't find the debuginfo since debuginfod has been disabled\n+    gdb_test \"file $binfile\" \".*No debugging symbols.*\" \\\n+\t\"file [file tail $binfile] cmd off\"\n+\n+    # Enable debuginfod and fetch the debuginfo\n+    gdb_test_no_output \"set debuginfod on\"\n+    gdb_test \"file $binfile\" \".*Reading symbols from.*debuginfo.*\" \\\n+\t\"file [file tail $binfile] cmd on\"\n }\n \n set envlist \\"
    }
  ]
}