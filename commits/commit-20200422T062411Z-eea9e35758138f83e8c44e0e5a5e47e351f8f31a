{
  "sha": "eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZWVhOWUzNTc1ODEzOGY4M2U4YzQ0ZTBlNWE1ZTQ3ZTM1MWY4ZjMxYQ==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-04-22T06:24:11Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2020-04-22T06:24:11Z"
    },
    "message": "[gdb/symtab] Find filename in shared psymtab\n\nWhen running test-case gdb.ada/dgopt.exp with target board\nunix/-flto/-O0/-flto-partition=none/-ffat-lto-objects and gcc-8, gcc-9 or\ngcc-10, and the fix for PR25700, we run into this regression:\n...\n(gdb) list x.adb:16, 16^M\nNo source file named x.adb.^M\n(gdb) FAIL: gdb.ada/dgopt.exp: list x.adb:16, 16\n...\n\nThe reason for the failure is that without the fix for PR25700, we\nhave an unshared psymtab:\n...\n  { psymtab gdb.ada/dgopt/x.adb ((struct partial_symtab *) $hex)^M\n    readin no^M\n    fullname (null)^M\n    text addresses 0x0 -- 0x0^M\n    psymtabs_addrmap_supported yes^M\n    globals (none)^M\n    statics (none)^M\n    dependencies (none)^M\n  }^M\n...\nand a shared psymtab (with user field set):\n...\n  { psymtab gdb.ada/dgopt/x.adb ((struct partial_symtab *) $hex)^M\n    readin no^M\n    fullname (null)^M\n    text addresses 0x0 -- 0x0^M\n    psymtabs_addrmap_supported yes^M\n    globals (none)^M\n    statics (none)^M\n    user <artificial>@0x159a ((struct partial_symtab *) 0x37b57c0)^M\n    dependencies (none)^M\n  }^M\n...\n\nThe fix for PR25700 removes the unshared psymtab.\n\nThen when trying to find a psymtab matching x.adb in\npsym_map_symtabs_matching_filename, we run into this continue for the shared\npsymtab:\n...\n  for (partial_symtab *pst : require_partial_symbols (objfile, true))\n    {\n      /* We can skip shared psymtabs here, because any file name will be\n        attached to the unshared psymtab.  */\n      if (pst->user != NULL)\n       continue;\n...\nand consequently cannot find the file.\n\nFix this by not skipping the shared symtab in\npsym_map_symtabs_matching_filename.\n\nBuild and reg-tested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2020-04-22  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/25801\n\t* psymtab.c (psym_map_symtabs_matching_filename): Don't skip shared\n\tsymtabs.\n\ngdb/testsuite/ChangeLog:\n\n2020-04-22  Tom de Vries  <tdevries@suse.de>\n\n\tPR symtab/25801\n\t* gdb.dwarf2/imported-unit.exp: Test that we can get imported_unit.c\n\tin \"info source\" output.",
    "tree": {
      "sha": "4fbf30003271537af2dce86fcc8d45ece18bb945",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/4fbf30003271537af2dce86fcc8d45ece18bb945"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "3d5afab3393064e563305bc27264fde5a7598635",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/3d5afab3393064e563305bc27264fde5a7598635",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/3d5afab3393064e563305bc27264fde5a7598635"
    }
  ],
  "stats": {
    "total": 26,
    "additions": 21,
    "deletions": 5
  },
  "files": [
    {
      "sha": "fdafdb99db4d748b97dd378115016b6ff20e6cbb",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
      "patch": "@@ -1,3 +1,9 @@\n+2020-04-22  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/25801\n+\t* psymtab.c (psym_map_symtabs_matching_filename): Don't skip shared\n+\tsymtabs.\n+\n 2020-04-22  Tom de Vries  <tdevries@suse.de>\n \n \tPR symtab/25700"
    },
    {
      "sha": "376cbeedcdf392d17270a57ee3a26c6d69080e2f",
      "filename": "gdb/psymtab.c",
      "status": "modified",
      "additions": 3,
      "deletions": 5,
      "changes": 8,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/psymtab.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/psymtab.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/psymtab.c?ref=eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
      "patch": "@@ -157,17 +157,15 @@ psym_map_symtabs_matching_filename\n \n   for (partial_symtab *pst : require_partial_symbols (objfile, true))\n     {\n-      /* We can skip shared psymtabs here, because any file name will be\n-\t attached to the unshared psymtab.  */\n-      if (pst->user != NULL)\n-\tcontinue;\n-\n       /* Anonymous psymtabs don't have a file name.  */\n       if (pst->anonymous)\n \tcontinue;\n \n       if (compare_filenames_for_search (pst->filename, name))\n \t{\n+\t  while (pst->user)\n+\t    pst = pst->user;\n+\n \t  if (partial_map_expand_apply (objfile, name, real_path,\n \t\t\t\t\tpst, callback))\n \t    return true;"
    },
    {
      "sha": "1331fe5248b29621ca9656996aeea0c05e6d6ede",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
      "patch": "@@ -1,3 +1,9 @@\n+2020-04-22  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR symtab/25801\n+\t* gdb.dwarf2/imported-unit.exp: Test that we can get imported_unit.c\n+\tin \"info source\" output.\n+\n 2020-04-22  Tom de Vries  <tdevries@suse.de>\n \n \tPR symtab/25700"
    },
    {
      "sha": "32a9abf6204d518111c55c7f6de51aa62169567c",
      "filename": "gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "status": "modified",
      "additions": 6,
      "deletions": 0,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/eea9e35758138f83e8c44e0e5a5e47e351f8f31a/gdb/testsuite/gdb.dwarf2/imported-unit.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/imported-unit.exp?ref=eea9e35758138f83e8c44e0e5a5e47e351f8f31a",
      "patch": "@@ -186,6 +186,12 @@ if { $psymtabs_p } {\n     unsupported $test\n }\n \n+gdb_test \"l imported_unit.c:1\" \\\n+    \"1\\timported_unit.c: No such file or directory\\.\"\n+\n+gdb_test \"info source\" \"\\r\\nCurrent source file is imported_unit.c\\r\\n.*\" \\\n+    \"info source for imported_unit.c\"\n+\n # Sanity check\n gdb_test \"ptype main\" \"= int \\\\(void\\\\)\"\n "
    }
  ]
}