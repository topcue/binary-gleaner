{
  "sha": "2b9f6e89d67b342593734d14f328625848fa5156",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MmI5ZjZlODlkNjdiMzQyNTkzNzM0ZDE0ZjMyODYyNTg0OGZhNTE1Ng==",
  "commit": {
    "author": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-16T21:57:17Z"
    },
    "committer": {
      "name": "Tom de Vries",
      "email": "tdevries@suse.de",
      "date": "2019-06-16T21:57:17Z"
    },
    "message": "[gdb/contrib] Fix gdb/contrib/gdb-add-index.sh for dwz-m-ed execs\n\nAtm gdb-add-index.exp fails with target board cc-with-dwz-m.\n\nFix this by updating gdb/contrib/gdb-add-index.sh to handle a dwz-m-ed\nexecutable.\n\nTested on x86_64-linux.\n\ngdb/ChangeLog:\n\n2019-06-16  Tom de Vries  <tdevries@suse.de>\n\n\tPR gdb/24445\n\t* contrib/gdb-add-index.sh: Update to handle dwz-m-ed executable.",
    "tree": {
      "sha": "01298102e30da46d1308d55c31f40aa2c25bd962",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/01298102e30da46d1308d55c31f40aa2c25bd962"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/2b9f6e89d67b342593734d14f328625848fa5156",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2b9f6e89d67b342593734d14f328625848fa5156",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/2b9f6e89d67b342593734d14f328625848fa5156",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2b9f6e89d67b342593734d14f328625848fa5156/comments",
  "author": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "vries",
    "id": 4057235,
    "node_id": "MDQ6VXNlcjQwNTcyMzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/4057235?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/vries",
    "html_url": "https://github.com/vries",
    "followers_url": "https://api.github.com/users/vries/followers",
    "following_url": "https://api.github.com/users/vries/following{/other_user}",
    "gists_url": "https://api.github.com/users/vries/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/vries/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/vries/subscriptions",
    "organizations_url": "https://api.github.com/users/vries/orgs",
    "repos_url": "https://api.github.com/users/vries/repos",
    "events_url": "https://api.github.com/users/vries/events{/privacy}",
    "received_events_url": "https://api.github.com/users/vries/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "431b3eadc4f842231d404e7e995ae5c1dbd28414",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/431b3eadc4f842231d404e7e995ae5c1dbd28414",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/431b3eadc4f842231d404e7e995ae5c1dbd28414"
    }
  ],
  "stats": {
    "total": 143,
    "additions": 96,
    "deletions": 47
  },
  "files": [
    {
      "sha": "51748a80e46a4258cbdc0366a145e37162a428b8",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2b9f6e89d67b342593734d14f328625848fa5156/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2b9f6e89d67b342593734d14f328625848fa5156/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=2b9f6e89d67b342593734d14f328625848fa5156",
      "patch": "@@ -1,3 +1,8 @@\n+2019-06-16  Tom de Vries  <tdevries@suse.de>\n+\n+\tPR gdb/24445\n+\t* contrib/gdb-add-index.sh: Update to handle dwz-m-ed executable.\n+\n 2019-06-16  Tom Tromey  <tom@tromey.com>\n \n \t* tui/tui-wingeneral.c (tui_unhighlight_win, tui_highlight_win)"
    },
    {
      "sha": "5a37020656f399247c50c8fadbbe17d6e82bb53e",
      "filename": "gdb/contrib/gdb-add-index.sh",
      "status": "modified",
      "additions": 91,
      "deletions": 47,
      "changes": 138,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/2b9f6e89d67b342593734d14f328625848fa5156/gdb/contrib/gdb-add-index.sh",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/2b9f6e89d67b342593734d14f328625848fa5156/gdb/contrib/gdb-add-index.sh",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/contrib/gdb-add-index.sh?ref=2b9f6e89d67b342593734d14f328625848fa5156",
      "patch": "@@ -20,6 +20,7 @@\n # If not, or you want others, pass the following in the environment\n GDB=${GDB:=gdb}\n OBJCOPY=${OBJCOPY:=objcopy}\n+READELF=${READELF:=readelf}\n \n myname=\"${0##*/}\"\n \n@@ -43,15 +44,44 @@ fi\n \n dir=\"${file%/*}\"\n test \"$dir\" = \"$file\" && dir=\".\"\n-index4=\"${file}.gdb-index\"\n-index5=\"${file}.debug_names\"\n-debugstr=\"${file}.debug_str\"\n-debugstrmerge=\"${file}.debug_str.merge\"\n-debugstrerr=\"${file}.debug_str.err\"\n \n-rm -f $index4 $index5 $debugstr $debugstrmerge $debugstrerr\n+dwz_file=\"\"\n+if $READELF -S \"$file\" | grep -q \" \\.gnu_debugaltlink \"; then\n+    dwz_file=$($READELF --string-dump=.gnu_debugaltlink \"$file\" \\\n+\t\t   | grep -A1  \"'\\.gnu_debugaltlink':\" \\\n+\t\t   | tail -n +2 \\\n+\t\t   | sed 's/.*]//')\n+    dwz_file=$(echo $dwz_file)\n+    if $READELF -S \"$dwz_file\" | grep -E -q \" \\.(gdb_index|debug_names) \"; then\n+\t# Already has an index, skip it.\n+\tdwz_file=\"\"\n+    fi\n+fi\n+\n+set_files ()\n+{\n+    local file=\"$1\"\n+\n+    index4=\"${file}.gdb-index\"\n+    index5=\"${file}.debug_names\"\n+    debugstr=\"${file}.debug_str\"\n+    debugstrmerge=\"${file}.debug_str.merge\"\n+    debugstrerr=\"${file}.debug_str.err\"\n+}\n+\n+tmp_files=\n+for f in \"$file\" \"$dwz_file\"; do\n+    if [ \"$f\" = \"\" ]; then\n+\tcontinue\n+    fi\n+    set_files \"$f\"\n+    tmp_files=\"$tmp_files $index4 $index5 $debugstr $debugstrmerge $debugstrerr\"\n+done\n+\n+rm -f $tmp_files\n+\n # Ensure intermediate index file is removed when we exit.\n-trap \"rm -f $index4 $index5 $debugstr $debugstrmerge $debugstrerr\" 0\n+trap \"rm -f $tmp_files\" 0\n \n $GDB --batch -nx -iex 'set auto-load no' \\\n     -ex \"file $file\" -ex \"save gdb-index $dwarf5 $dir\" || {\n@@ -67,50 +97,64 @@ $GDB --batch -nx -iex 'set auto-load no' \\\n # already stripped binary, it's a no-op.\n status=0\n \n-if test -f \"$index4\" -a -f \"$index5\"; then\n-    echo \"$myname: Both index types were created for $file\" 1>&2\n-    status=1\n-elif test -f \"$index4\" -o -f \"$index5\"; then\n-    if test -f \"$index4\"; then\n-\tindex=\"$index4\"\n-\tsection=\".gdb_index\"\n-    else\n-\tindex=\"$index5\"\n-\tsection=\".debug_names\"\n-    fi\n-    debugstradd=false\n-    debugstrupdate=false\n-    if test -s \"$debugstr\"; then\n-\tif ! $OBJCOPY --dump-section .debug_str=\"$debugstrmerge\" \"$file\" /dev/null \\\n-\t\t 2>$debugstrerr; then\n-\t    cat >&2 $debugstrerr\n-\t    exit 1\n-\tfi\n-\tif grep -q \"can't dump section '.debug_str' - it does not exist\" \\\n-\t\t  $debugstrerr; then\n-\t    debugstradd=true\n+handle_file ()\n+{\n+    local file\n+    file=\"$1\"\n+\n+    set_files \"$file\"\n+\n+    if test -f \"$index4\" -a -f \"$index5\"; then\n+\techo \"$myname: Both index types were created for $file\" 1>&2\n+\tstatus=1\n+    elif test -f \"$index4\" -o -f \"$index5\"; then\n+\tif test -f \"$index4\"; then\n+\t    index=\"$index4\"\n+\t    section=\".gdb_index\"\n \telse\n-\t    debugstrupdate=true\n-\t    cat >&2 $debugstrerr\n+\t    index=\"$index5\"\n+\t    section=\".debug_names\"\n+\tfi\n+\tdebugstradd=false\n+\tdebugstrupdate=false\n+\tif test -s \"$debugstr\"; then\n+\t    if ! $OBJCOPY --dump-section .debug_str=\"$debugstrmerge\" \"$file\" \\\n+\t\t /dev/null 2>$debugstrerr; then\n+\t\tcat >&2 $debugstrerr\n+\t\texit 1\n+\t    fi\n+\t    if grep -q \"can't dump section '.debug_str' - it does not exist\" \\\n+\t\t    $debugstrerr; then\n+\t\tdebugstradd=true\n+\t    else\n+\t\tdebugstrupdate=true\n+\t\tcat >&2 $debugstrerr\n+\t    fi\n+\t    cat \"$debugstr\" >>\"$debugstrmerge\"\n \tfi\n-\tcat \"$debugstr\" >>\"$debugstrmerge\"\n-    fi\n \n-    $OBJCOPY --add-section $section=\"$index\" \\\n-\t--set-section-flags $section=readonly \\\n-\t$(if $debugstradd; then \\\n-\t      echo --add-section .debug_str=\"$debugstrmerge\"; \\\n-\t      echo --set-section-flags .debug_str=readonly; \\\n-\t  fi; \\\n-\t  if $debugstrupdate; then \\\n-\t      echo --update-section .debug_str=\"$debugstrmerge\"; \\\n-\t  fi) \\\n-\t\"$file\" \"$file\"\n+\t$OBJCOPY --add-section $section=\"$index\" \\\n+\t\t --set-section-flags $section=readonly \\\n+\t\t $(if $debugstradd; then \\\n+\t\t       echo --add-section .debug_str=\"$debugstrmerge\"; \\\n+\t\t       echo --set-section-flags .debug_str=readonly; \\\n+\t\t   fi; \\\n+\t\t   if $debugstrupdate; then \\\n+\t\t       echo --update-section .debug_str=\"$debugstrmerge\"; \\\n+\t\t   fi) \\\n+\t\t \"$file\" \"$file\"\n+\n+\tstatus=$?\n+    else\n+\techo \"$myname: No index was created for $file\" 1>&2\n+\techo \"$myname: [Was there no debuginfo? Was there already an index?]\" \\\n+\t     1>&2\n+    fi\n+}\n \n-    status=$?\n-else\n-    echo \"$myname: No index was created for $file\" 1>&2\n-    echo \"$myname: [Was there no debuginfo? Was there already an index?]\" 1>&2\n+handle_file \"$file\"\n+if [ \"$dwz_file\" != \"\" ]; then\n+    handle_file \"$dwz_file\"\n fi\n \n exit $status"
    }
  ]
}