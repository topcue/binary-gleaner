{
  "sha": "8ed5b76ea2de370265382dab1d538a919e2603ab",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6OGVkNWI3NmVhMmRlMzcwMjY1MzgyZGFiMWQ1MzhhOTE5ZTI2MDNhYg==",
  "commit": {
    "author": {
      "name": "Joel Brobecker",
      "email": "brobecker@adacore.com",
      "date": "2019-04-30T20:59:17Z"
    },
    "committer": {
      "name": "Joel Brobecker",
      "email": "brobecker@adacore.com",
      "date": "2019-04-30T20:59:17Z"
    },
    "message": "(Windows) fix thr != nullptr assert failure in delete_thread_1\n\nWe have observed that GDB would randomly trip the following\nassertion failure when debugging on Windows. When allowing\nthe program to run until the inferior exits, we occasionally see:\n\n     (gdb) cont\n     Continuing.\n     [Thread 48192.0xd100 exited with code 1]\n     [Thread 48192.0x10ad8 exited with code 1]\n     [Thread 48192.0x36e28 exited with code 0]\n     [Thread 48192.0x52be4 exited with code 0]\n     [Thread 48192.0x5aa40 exited with code 0]\n     ../../src/gdb/thread.c:453: internal-error: void delete_thread_1(thread_inf\no*, bool): Assertion `thr != nullptr' failed.\n\nRunning the same scenario with some additional traces enabled...\n\n    (gdb) set verbose\n    (gdb) set debugevents\n\n... allows us to understand what the issue is. To understand, we need\nto first look at the events received when starting the program, and\nin particular which threads got created how. First, we get a\nCREATE_PROCESS_DEBUG_EVENT for tid=0x442a8:\n\n    gdb: kernel event for pid=317536 tid=0x442a8 code=CREATE_PROCESS_DEBUG_EVENT)\n\nShortly after, we get some CREATE_THREAD_DEBUG_EVENT events,\none of them being for tid=0x4010c:\n\n    gdb: kernel event for pid=317536 tid=0x4010c code=CREATE_THREAD_DEBUG_EVENT)\nFast forward a bit of debugging, and we do a \"cont\" as above,\nat which point the programs reaches the end, and the system reports\n\"exit\" events. The first interesting one is the following:\n\n    gdb: kernel event for pid=317536 tid=0x442a8 code=EXIT_THREAD_DEBUG_EVENT)\n\nThis is reporting a thread-exit event for a thread whose tid\nis the TID of what we call the \"main thread\". That's the thread\nthat was created when we received the CREATE_PROCESS_DEBUG_EVENT\nnotification, and whose TID is actually stored in a global variable\nnamed main_thread_id. This is not something we expected, as\nthe assumption we made was that the main thread would exit last,\nand we would be notified of it via an EXIT_PROCESS_DEBUG_EVENT.\nBut apparently, this is not always true, at least on Windows Server\n2012 and 2016 where this issue has been observed happening randomly.\n\nThe consequence of the above notification is that we call\nwindows_delete_thread for that thread, which removes it from\nour list of known threads.\n\nAnd a little bit later, then we then get the EXIT_PROCESS_DEBUG_EVENT,\nand we can see that the associated tid is not the main_thread_id,\nbut rather the tid of one of the threads that was created during\nthe lifetime of the program, in this case tid=0x4010c:\n\n    gdb: kernel event for pid=317536 tid=0x4010c code=EXIT_PROCESS_DEBUG_EVENT)\n\nAnd the debug trace printed right after shows why we're crashing:\n\n    [Deleting Thread 317536.0x442a8]\n\nWe are trying to delete the thread whose tid=0x442a8, which is\nthe main_thread_id! As we have already deleted that thread before,\nthe search for it returns a nullptr, which then trips the assertion\ncheck in delete_thread_1.\n\nThis commit fixes this issue. It ignores the open question of\nwhat to do with the main_thread_id global, particularly after\nthat thread has been removed from our list of threads. This will\nbe dealt with as a separate patch, to allow cherry-picking\nthis patch into a release branch.\n\nFor now, we fix the code so as to avoid this crash.\n\ngdb/ChangeLog:\n\n\t* windows-nat.c (get_windows_debug_event) <EXIT_PROCESS_DEBUG_EVENT>:\n\tUse current_event.dwThreadId instead of main_thread_id.",
    "tree": {
      "sha": "b0f17a97b433b47872578db1072b98bb86440e37",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b0f17a97b433b47872578db1072b98bb86440e37"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/8ed5b76ea2de370265382dab1d538a919e2603ab",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8ed5b76ea2de370265382dab1d538a919e2603ab",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/8ed5b76ea2de370265382dab1d538a919e2603ab",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/8ed5b76ea2de370265382dab1d538a919e2603ab/comments",
  "author": {
    "login": "brobecke",
    "id": 11981700,
    "node_id": "MDQ6VXNlcjExOTgxNzAw",
    "avatar_url": "https://avatars.githubusercontent.com/u/11981700?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brobecke",
    "html_url": "https://github.com/brobecke",
    "followers_url": "https://api.github.com/users/brobecke/followers",
    "following_url": "https://api.github.com/users/brobecke/following{/other_user}",
    "gists_url": "https://api.github.com/users/brobecke/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brobecke/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brobecke/subscriptions",
    "organizations_url": "https://api.github.com/users/brobecke/orgs",
    "repos_url": "https://api.github.com/users/brobecke/repos",
    "events_url": "https://api.github.com/users/brobecke/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brobecke/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "brobecke",
    "id": 11981700,
    "node_id": "MDQ6VXNlcjExOTgxNzAw",
    "avatar_url": "https://avatars.githubusercontent.com/u/11981700?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/brobecke",
    "html_url": "https://github.com/brobecke",
    "followers_url": "https://api.github.com/users/brobecke/followers",
    "following_url": "https://api.github.com/users/brobecke/following{/other_user}",
    "gists_url": "https://api.github.com/users/brobecke/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/brobecke/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/brobecke/subscriptions",
    "organizations_url": "https://api.github.com/users/brobecke/orgs",
    "repos_url": "https://api.github.com/users/brobecke/repos",
    "events_url": "https://api.github.com/users/brobecke/events{/privacy}",
    "received_events_url": "https://api.github.com/users/brobecke/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "2ff0a947394eebf5ff9cd26088dce60ec8c10b48",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/2ff0a947394eebf5ff9cd26088dce60ec8c10b48",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/2ff0a947394eebf5ff9cd26088dce60ec8c10b48"
    }
  ],
  "stats": {
    "total": 9,
    "additions": 7,
    "deletions": 2
  },
  "files": [
    {
      "sha": "1b4b83d13afbb0d840fdaeb8f87e08bc5c63120b",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8ed5b76ea2de370265382dab1d538a919e2603ab/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8ed5b76ea2de370265382dab1d538a919e2603ab/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=8ed5b76ea2de370265382dab1d538a919e2603ab",
      "patch": "@@ -1,3 +1,8 @@\n+2019-04-30  Joel Brobecker  <brobecker@adacore.com>\n+\n+\t* windows-nat.c (get_windows_debug_event) <EXIT_PROCESS_DEBUG_EVENT>:\n+\tUse current_event.dwThreadId instead of main_thread_id.\n+\n 2019-04-30  Tom Tromey  <tromey@adacore.com>\n \n \t* ada-lang.c (ada_lookup_simple_minsyms): New function."
    },
    {
      "sha": "9f3242cc4055c8505094b1f2a389b0b8ab3bc1c0",
      "filename": "gdb/windows-nat.c",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/8ed5b76ea2de370265382dab1d538a919e2603ab/gdb/windows-nat.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/8ed5b76ea2de370265382dab1d538a919e2603ab/gdb/windows-nat.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/windows-nat.c?ref=8ed5b76ea2de370265382dab1d538a919e2603ab",
      "patch": "@@ -1637,11 +1637,11 @@ get_windows_debug_event (struct target_ops *ops,\n       else if (saw_create == 1)\n \t{\n \t  windows_delete_thread (ptid_t (current_event.dwProcessId, 0,\n-\t\t\t\t\t main_thread_id),\n+\t\t\t\t\t current_event.dwThreadId),\n \t\t\t\t 0, true /* main_thread_p */);\n \t  ourstatus->kind = TARGET_WAITKIND_EXITED;\n \t  ourstatus->value.integer = current_event.u.ExitProcess.dwExitCode;\n-\t  thread_id = main_thread_id;\n+\t  thread_id = current_event.dwThreadId;\n \t}\n       break;\n "
    }
  ]
}