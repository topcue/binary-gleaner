{
  "sha": "1e3b96fd6cf0c7d018083994ad951ccf92aba582",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6MWUzYjk2ZmQ2Y2YwYzdkMDE4MDgzOTk0YWQ5NTFjY2Y5MmFiYTU4Mg==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-09-04T04:24:21Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2020-09-04T04:36:44Z"
    },
    "message": "Allow plugin syms to mark as-needed shared libs needed\n\nWe must tell LTO about symbols in all shared libraries loaded.  That\nmeans we can't load extra shared libraries after LTO recompilation, at\nleast, not those that affect the set of symbols that LTO cares about,\nthe IR symbols.\n\nThis change will likely result in complaints about --as-needed\nlibraries being loaded unnecessarily, but being correct is more\nimportant than being optimal.  One of the PR15146 tests regresses, and\nwhile that could be hidden by disabling the missing dso message by\nmaking it conditional on h->root.non_ir_ref_regular, that would just\nbe sweeping a problem under the rug.\n\nbfd/\n\tPR 15146\n\tPR 26314\n\tPR 26530\n\t* elflink.c (elf_link_add_object_symbols): Do set def_regular\n\tand ref_regular for IR symbols.  Don't clear dynsym, allowing\n\tIR symbols to load --as-needed shared libraries, but prevent\n\tIR symbols from becoming dynamic.\nld/\n\t* testsuite/ld-plugin/lto.exp: Don't run pr15146 tests.\n\t* testsuite/ld-plugin/pr15146.d: Delete.\n\t* testsuite/ld-plugin/pr15146a.c: Delete.\n\t* testsuite/ld-plugin/pr15146b.c: Delete.\n\t* testsuite/ld-plugin/pr15146c.c: Delete.\n\t* testsuite/ld-plugin/pr15146d.c: Delete.",
    "tree": {
      "sha": "0e091c1d3f126e5dbed7661c30bb0d5dfe35bb6a",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/0e091c1d3f126e5dbed7661c30bb0d5dfe35bb6a"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/1e3b96fd6cf0c7d018083994ad951ccf92aba582",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1e3b96fd6cf0c7d018083994ad951ccf92aba582",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/1e3b96fd6cf0c7d018083994ad951ccf92aba582",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/1e3b96fd6cf0c7d018083994ad951ccf92aba582/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc"
    }
  ],
  "stats": {
    "total": 78,
    "additions": 21,
    "deletions": 57
  },
  "files": [
    {
      "sha": "a431f8f14dbef0492ee18f5e07b6415d3dc982d2",
      "filename": "bfd/ChangeLog",
      "status": "modified",
      "additions": 10,
      "deletions": 0,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e3b96fd6cf0c7d018083994ad951ccf92aba582/bfd/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e3b96fd6cf0c7d018083994ad951ccf92aba582/bfd/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/ChangeLog?ref=1e3b96fd6cf0c7d018083994ad951ccf92aba582",
      "patch": "@@ -1,3 +1,13 @@\n+2020-09-04  Alan Modra  <amodra@gmail.com>\n+\n+\tPR 15146\n+\tPR 26314\n+\tPR 26530\n+\t* elflink.c (elf_link_add_object_symbols): Do set def_regular\n+\tand ref_regular for IR symbols.  Don't clear dynsym, allowing\n+\tIR symbols to load --as-needed shared libraries, but prevent\n+\tIR symbols from becoming dynamic.\n+\n 2020-09-03  Nick Clifton  <nickc@redhat.com>\n \n \tPR 26521"
    },
    {
      "sha": "1384c1a46b83b55876b6a73dbcba0386a458063b",
      "filename": "bfd/elflink.c",
      "status": "modified",
      "additions": 2,
      "deletions": 10,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e3b96fd6cf0c7d018083994ad951ccf92aba582/bfd/elflink.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e3b96fd6cf0c7d018083994ad951ccf92aba582/bfd/elflink.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elflink.c?ref=1e3b96fd6cf0c7d018083994ad951ccf92aba582",
      "patch": "@@ -4977,11 +4977,7 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t     object and a shared object.  */\n \t  bfd_boolean dynsym = FALSE;\n \n-\t  /* Plugin symbols aren't normal.  Don't set def_regular or\n-\t     ref_regular for them, or make them dynamic.  */\n-\t  if ((abfd->flags & BFD_PLUGIN) != 0)\n-\t    ;\n-\t  else if (! dynamic)\n+\t  if (! dynamic)\n \t    {\n \t      if (! definition)\n \t\t{\n@@ -5162,10 +5158,6 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t      && !bfd_link_relocatable (info))\n \t    dynsym = FALSE;\n \n-\t  /* Nor should we make plugin symbols dynamic.  */\n-\t  if ((abfd->flags & BFD_PLUGIN) != 0)\n-\t    dynsym = FALSE;\n-\n \t  if (definition)\n \t    {\n \t      h->target_internal = isym->st_target_internal;\n@@ -5192,7 +5184,7 @@ elf_link_add_object_symbols (bfd *abfd, struct bfd_link_info *info)\n \t\t}\n \t    }\n \n-\t  if (dynsym && h->dynindx == -1)\n+\t  if (dynsym && (abfd->flags & BFD_PLUGIN) == 0 && h->dynindx == -1)\n \t    {\n \t      if (! bfd_elf_link_record_dynamic_symbol (info, h))\n \t\tgoto error_free_vers;"
    },
    {
      "sha": "0a11b79c67443fa8831f65a251b7533b2c773eda",
      "filename": "ld/ChangeLog",
      "status": "modified",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e3b96fd6cf0c7d018083994ad951ccf92aba582/ld/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e3b96fd6cf0c7d018083994ad951ccf92aba582/ld/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/ChangeLog?ref=1e3b96fd6cf0c7d018083994ad951ccf92aba582",
      "patch": "@@ -1,3 +1,12 @@\n+2020-09-04  Alan Modra  <amodra@gmail.com>\n+\n+\t* testsuite/ld-plugin/lto.exp: Don't run pr15146 tests.\n+\t* testsuite/ld-plugin/pr15146.d: Delete.\n+\t* testsuite/ld-plugin/pr15146a.c: Delete.\n+\t* testsuite/ld-plugin/pr15146b.c: Delete.\n+\t* testsuite/ld-plugin/pr15146c.c: Delete.\n+\t* testsuite/ld-plugin/pr15146d.c: Delete.\n+\n 2020-09-03  H.J. Lu  <hongjiu.lu@intel.com>\n \n \t* testsuite/config/default.exp: Change NOSANTIZE_CFLAGS to"
    },
    {
      "sha": "684d1db314ad8bfe8e4256e5c3cff9221a7c716c",
      "filename": "ld/testsuite/ld-plugin/lto.exp",
      "status": "modified",
      "additions": 0,
      "deletions": 22,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/1e3b96fd6cf0c7d018083994ad951ccf92aba582/ld/testsuite/ld-plugin/lto.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/1e3b96fd6cf0c7d018083994ad951ccf92aba582/ld/testsuite/ld-plugin/lto.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/lto.exp?ref=1e3b96fd6cf0c7d018083994ad951ccf92aba582",
      "patch": "@@ -320,21 +320,6 @@ set lto_link_elf_tests [list \\\n   [list \"PR ld/13244\" \\\n    \"-shared -O2 -fPIC -flto -fuse-linker-plugin -nostdlib\" \"-O2 -fno-early-inlining -flto\" \\\n    {pr13244.c} {{\"readelf\" {-s --wide} \"pr13244.d\"}} \"pr13244.so\" \"c\"] \\\n-  [list \"Build libpr15146a.a\" \\\n-   \"$plug_opt\" \"-flto -O2\" \\\n-   {pr15146a.c} {} \"lib15146a.a\"] \\\n-  [list \"Build pr15146b.so\" \\\n-   \"-shared\" \"-O2 -fpic\" \\\n-   {pr15146b.c} {} \"pr15146b.so\" \"c\"] \\\n-  [list \"Build pr15146c.so\" \\\n-   \"-shared -Wl,--no-as-needed tmpdir/pr15146b.so\" \"-O2 -fpic $no_lto\" \\\n-   {pr15146c.c} {} \"pr15146c.so\" \"c\"] \\\n-  [list \"PR ld/15146 (1)\" \\\n-   \"-O2 -flto -fuse-linker-plugin -Wl,-rpath-link,. -Wl,--no-copy-dt-needed-entries -Wl,--no-as-needed tmpdir/pr15146a.o tmpdir/pr15146c.so\" \"\" \\\n-   {dummy.c} {{\"readelf\" {-d} \"pr15146.d\"}} \"pr15146a.exe\"] \\\n-  [list \"Build libpr15146d.a\" \\\n-   \"$plug_opt\" \"-flto -O2\" \\\n-   {pr15146d.c} {} \"lib15146d.a\"] \\\n   [list \"Build libpr16746a.a\" \\\n    \"\" \"\" \\\n    {pr16746a.c pr16746b.c} {} \"lib15146a.a\"] \\\n@@ -605,13 +590,6 @@ run_cc_link_tests $lto_compile_elf_tests\n # Restrict these to ELF targets that support shared libs and PIC.\n if { [is_elf_format] && [check_lto_shared_available] } {\n     run_cc_link_tests $lto_link_elf_tests\n-    set testname \"PR ld/15146 (2)\"\n-    set exec_output [run_host_cmd \"$CC\" \"-O2 -flto -fuse-linker-plugin -Wl,-rpath-link,. -Wl,--no-copy-dt-needed-entries -Wl,--no-as-needed tmpdir/pr15146d.o tmpdir/pr15146c.so\"]\n-    if { [ regexp \"undefined reference to symbol '\\\\.?xxx'\" $exec_output ] } {\n-\tpass $testname\n-    } {\n-\tfail $testname\n-    }\n     set testname \"PR ld/16746 (3)\"\n     set exec_output [run_host_cmd \"$CC\" \"-O2 -flto -fuse-linker-plugin tmpdir/pr16746b.o tmpdir/pr16746d.o\"]\n     if { [ regexp \"warning: \\\\.?foobar\" $exec_output ] && ![ regexp \"symbol from plugin\" $exec_output ] } {"
    },
    {
      "sha": "48d4b8544668267d0ccef2366cce6d96cbc50a3a",
      "filename": "ld/testsuite/ld-plugin/pr15146.d",
      "status": "removed",
      "additions": 0,
      "deletions": 4,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr15146.d?ref=e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "patch": "@@ -1,4 +0,0 @@\n-#failif\n-#...\n- +0x[0-9a-f]+ +\\(NEEDED\\) +Shared library: +\\[.*pr15146b.so\\]\n-#..."
    },
    {
      "sha": "a22860af5b81e53e05f716f33d83bfe85d756da8",
      "filename": "ld/testsuite/ld-plugin/pr15146a.c",
      "status": "removed",
      "additions": 0,
      "deletions": 13,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146a.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146a.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr15146a.c?ref=e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "patch": "@@ -1,13 +0,0 @@\n-extern int xxx;\n-\n-int\n-bar (void)\n-{\n-  return xxx;\n-}\n-\n-int\n-main ()\n-{ \n-  return 0;\n-}"
    },
    {
      "sha": "90eb21ea556715a26b39b7223efe1b8728c10dec",
      "filename": "ld/testsuite/ld-plugin/pr15146b.c",
      "status": "removed",
      "additions": 0,
      "deletions": 1,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146b.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146b.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr15146b.c?ref=e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "patch": "@@ -1 +0,0 @@\n-int xxx = 3;"
    },
    {
      "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
      "filename": "ld/testsuite/ld-plugin/pr15146c.c",
      "status": "removed",
      "additions": 0,
      "deletions": 0,
      "changes": 0,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146c.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146c.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr15146c.c?ref=e062fcc8c2bf4c36386dce68ba7f1d408f22dedc"
    },
    {
      "sha": "ba1e0abfa6ef9a832d718ca9908e2ab4d2d8a16f",
      "filename": "ld/testsuite/ld-plugin/pr15146d.c",
      "status": "removed",
      "additions": 0,
      "deletions": 7,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146d.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/e062fcc8c2bf4c36386dce68ba7f1d408f22dedc/ld/testsuite/ld-plugin/pr15146d.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-plugin/pr15146d.c?ref=e062fcc8c2bf4c36386dce68ba7f1d408f22dedc",
      "patch": "@@ -1,7 +0,0 @@\n-extern int xxx;\n-\n-int\n-main ()\n-{ \n-  return xxx;\n-}"
    }
  ]
}