{
  "sha": "f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
  "node_id": "C_kwDOANOeidoAKGY5NDAyY2NhYTlmYWM3ODU4NzEzYTc2NzJmYWU1NzYwYWUzZDVjZTc",
  "commit": {
    "author": {
      "name": "Eric Botcazou",
      "email": "ebotcazou@gcc.gnu.org",
      "date": "2021-11-15T11:50:51Z"
    },
    "committer": {
      "name": "Eric Botcazou",
      "email": "ebotcazou@gcc.gnu.org",
      "date": "2021-11-15T11:56:10Z"
    },
    "message": "Deal with full path in .file 0 directive\n\nGas uses the directory part, if present, of the .file 0 directive to set\nentry 0 of the directory table in DWARF 5, which represents the \"current\ndirectory\".\n\nNow Gas also uses the file part of the same directive to set entry 0 of the\nfile table, which represents the \"current compilation file\".  But the latter\nneed not be located in the former so GCC will use a full path in the file\npart when it is passed a full path:\n\ngcc -c /full/path/test.c -save-temps\n\nyields:\n\n .file 0 \"/current/directory\" \"/full/path/test.c\"\n\nin the assembly file and:\n\n The Directory Table (offset 0x22, lines 2, columns 1):\n  Entry Name\n  0     (indirect line string, offset: 0x25): /current/directory\n  1     (indirect line string, offset: 0x38): /full/path\n\n The File Name Table (offset 0x30, lines 2, columns 2):\n  Entry Dir     Name\n  0     0       (indirect line string, offset: 0x43): /full/path/test.c\n\nin the object file.  Note the full path and the questionable Dir value in\nthe 0 entry of the file table.",
    "tree": {
      "sha": "120dc7c0bafe4ff49b5b8e6022db155264abd330",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/120dc7c0bafe4ff49b5b8e6022db155264abd330"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/comments",
  "author": null,
  "committer": null,
  "parents": [
    {
      "sha": "e6c46d077240565fac4d70066719a8bbe2c212d1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/e6c46d077240565fac4d70066719a8bbe2c212d1",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/e6c46d077240565fac4d70066719a8bbe2c212d1"
    }
  ],
  "stats": {
    "total": 208,
    "additions": 184,
    "deletions": 24
  },
  "files": [
    {
      "sha": "e9761e9a9011da63ff8e165b1b262cf6fc51f18b",
      "filename": "gas/ChangeLog",
      "status": "modified",
      "additions": 13,
      "deletions": 0,
      "changes": 13,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/ChangeLog?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -1,3 +1,16 @@\n+2021-11-15  Eric Botcazou  <ebotcazou@adacore.com>\n+\n+\t* doc/as.texi (File): Update description of .file 0 directive.\n+\t* dwarf2dbg.c (get_directory_table_entry): Remove obsolete comment\n+\tand pass file0_dirname in recursive call.\n+\t(allocate_filename_to_slot): Deal with a full path in the file name\n+\tif the index number is 0.\n+\t* testsuite/gas/elf/dwarf-5-file0.d: Fix pasto.\n+\t* testsuite/gas/elf/dwarf-5-file0-2.d: Likewise.\n+\t* testsuite/gas/elf/dwarf-5-file0-3.d: New file.\n+\t* testsuite/gas/elf/dwarf-5-file0-3.s: Likewise.\n+\t* testsuite/gas/elf/elf.exp: Run dwarf-5-file0-3.\n+\n 2021-10-28  Markus Klein  <markus.klein@sma.de>\n \n \tPR 28436"
    },
    {
      "sha": "9c1924d4bbd2d4a0257c7a92b9fb8cc3b54a4fe0",
      "filename": "gas/doc/as.texi",
      "status": "modified",
      "additions": 10,
      "deletions": 7,
      "changes": 17,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/doc/as.texi",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/doc/as.texi",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/doc/as.texi?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -5416,19 +5416,22 @@ table is shared with the @code{.debug_info} section of the DWARF2 debugging\n information, and thus the user must know the exact indices that table\n entries will have.\n \n-If DWARF-5 support has been enabled via the @option{-gdwarf-5} option then\n-an extended version of the @code{file} is also allowed:\n+If DWARF5 support has been enabled via the @option{-gdwarf-5} option then\n+an extended version of @code{.file} is also allowed:\n \n @smallexample\n .file @var{fileno} [@var{dirname}] @var{filename} [md5 @var{value}]\n @end smallexample\n \n With this version a separate directory name is allowed, although if this is\n-used then @var{filename} should not contain any directory components.  In\n-addtion an md5 hash value of the contents of @var{filename} can be provided.\n-This will be stored in the the file table as well, and can be used by tools\n-reading the debug information to verify that the contents of the source file\n-match the contents of the compiled file.\n+used then @var{filename} should not contain any directory component, except\n+for @var{fileno} equal to 0: in this case, @var{dirname} is expected to be\n+the current directory and @var{filename} the currently processed file, and\n+the latter need not be located in the former. In addtion an MD5 hash value\n+of the contents of @var{filename} can be provided. This will be stored in\n+the the file table as well, and can be used by tools reading the debug\n+information to verify that the contents of the source file match the\n+contents of the compiled file.\n \n @node Fill\n @section @code{.fill @var{repeat} , @var{size} , @var{value}}"
    },
    {
      "sha": "256412f9c79197a91918ec99ba4b9fbb7658b647",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 31,
      "deletions": 13,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -641,11 +641,9 @@ get_directory_table_entry (const char *dirname,\n \t\t expected to be the same as the DW_AT_comp_dir (which\n \t\t is set to the current build directory).  Since we are\n \t\t about to create a directory entry that is not the\n-\t\t same, allocate the current directory first.\n-\t\t FIXME: Alternatively we could generate an error\n-\t\t message here.  */\n-\t      (void) get_directory_table_entry (pwd, NULL, strlen (pwd),\n-\t\t\t\t\t\ttrue);\n+\t\t same, allocate the current directory first.  */\n+\t      (void) get_directory_table_entry (pwd, file0_dirname,\n+\t\t\t\t\t\tstrlen (pwd), true);\n \t      d = 1;\n \t    }\n \t  else\n@@ -827,7 +825,7 @@ allocate_filename_to_slot (const char *dirname,\n   const char *file;\n   size_t dirlen;\n   unsigned int i, d;\n-  const char *file0_dirname = dirname;\n+  const char *file0_dirname;\n \n   /* Short circuit the common case of adding the same pathname\n      as last time.  */\n@@ -906,20 +904,40 @@ allocate_filename_to_slot (const char *dirname,\n       return false;\n     }\n \n-  if (dirname == NULL)\n+  /* For file .0, the directory name is the current directory and the file\n+     may be in another directory contained in the file name.  */\n+  if (num == 0)\n     {\n-      dirname = filename;\n+      file0_dirname = dirname;\n+\n       file = get_basename (filename);\n-      dirlen = file - filename;\n+\n+      if (dirname && file == filename)\n+\tdirlen = strlen (dirname);\n+      else\n+\t{\n+\t  dirname = filename;\n+\t  dirlen = file - filename;\n+\t}\n     }\n   else\n     {\n-      dirlen = strlen (dirname);\n-      file = filename;\n+      file0_dirname = NULL;\n+\n+      if (dirname == NULL)\n+\t{\n+\t  dirname = filename;\n+\t  file = get_basename (filename);\n+\t  dirlen = file - filename;\n+\t}\n+      else\n+\t{\n+\t  dirlen = strlen (dirname);\n+\t  file = filename;\n+\t}\n     }\n \n-  d = get_directory_table_entry (dirname, file0_dirname, dirlen,\n-\t\t\t\t num == 0);\n+  d = get_directory_table_entry (dirname, file0_dirname, dirlen, num == 0);\n   i = num;\n \n   if (! assign_file_to_slot (i, file, d))"
    },
    {
      "sha": "dfd8431a5053fb4d921f25f7e21af9090fcfda1e",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0-2.d",
      "status": "modified",
      "additions": 1,
      "deletions": 2,
      "changes": 3,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0-2.d?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -1,11 +1,10 @@\n #as: --gdwarf-5\n-#name: DWARF5 .file 0 dir file\n+#name: DWARF5 .file 0 (directory and relative file)\n #readelf: -wl\n \n #...\n  The Directory Table \\(offset 0x.*, lines 1, columns 1\\):\n   Entry\tName\n-#...\n   0\t\\(indirect line string, offset: 0x.*\\): /example\n \n  The File Name Table \\(offset 0x.*, lines 2, columns 2\\):"
    },
    {
      "sha": "6c55d3266aa42cf9c470697733c616156ee944d1",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0-3.d",
      "status": "added",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-3.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-3.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0-3.d?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -0,0 +1,15 @@\n+#as: --gdwarf-5\n+#name: DWARF5 .file 0 (directory and absolute file)\n+#readelf: -wl\n+\n+#...\n+ The Directory Table \\(offset 0x.*, lines 2, columns 1\\):\n+  Entry\tName\n+  0\t\\(indirect line string, offset: 0x.*\\): /current/directory\n+  1\t\\(indirect line string, offset: 0x.*\\): /full/path\n+\n+ The File Name Table \\(offset 0x.*, lines 2, columns 2\\):\n+  Entry\tDir\tName\n+  0\t1\t\\(indirect line string, offset: 0x.*\\): test.c\n+  1\t1\t\\(indirect line string, offset: 0x.*\\): test.c\n+#pass"
    },
    {
      "sha": "b33c364508855fa4741602a00a7912ede6d1537b",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0-3.s",
      "status": "added",
      "additions": 111,
      "deletions": 0,
      "changes": 111,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-3.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0-3.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0-3.s?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -0,0 +1,111 @@\n+\t.file\t\"test.c\"\n+\t.text\n+.Ltext0:\n+\t.file 0 \"/current/directory\" \"/full/path/test.c\"\n+\t.globl\tx\n+\t.section\t.bss\n+\t.balign 4\n+\t.type\tx, %object\n+\t.size\tx, 4\n+x:\n+\t.zero\t4\n+\t.text\n+.Letext0:\n+\t.file 1 \"/full/path/test.c\"\n+\t.section\t.debug_info,\"\",%progbits\n+.Ldebug_info0:\n+\t.4byte\t0x32\n+\t.2byte\t0x5\n+\t.byte\t0x1\n+\t.byte\t0x4\n+\t.4byte\t.Ldebug_abbrev0\n+\t.uleb128 0x1\n+\t.4byte\t.LASF2\n+\t.byte\t0x1d\n+\t.4byte\t.LASF0\n+\t.4byte\t.LASF1\n+\t.4byte\t.Ldebug_line0\n+\t.uleb128 0x2\n+\t.asciz\t\"x\"\n+\t.byte\t0x1\n+\t.byte\t0x1\n+\t.byte\t0x5\n+\t.4byte\t0x2e\n+\t.uleb128 0x5\n+\t.byte\t0x3\n+\t.4byte\tx\n+\t.uleb128 0x3\n+\t.byte\t0x4\n+\t.byte\t0x5\n+\t.asciz\t\"int\"\n+\t.byte\t0\n+\t.section\t.debug_abbrev,\"\",%progbits\n+.Ldebug_abbrev0:\n+\t.uleb128 0x1\n+\t.uleb128 0x11\n+\t.byte\t0x1\n+\t.uleb128 0x25\n+\t.uleb128 0xe\n+\t.uleb128 0x13\n+\t.uleb128 0xb\n+\t.uleb128 0x3\n+\t.uleb128 0x1f\n+\t.uleb128 0x1b\n+\t.uleb128 0x1f\n+\t.uleb128 0x10\n+\t.uleb128 0x17\n+\t.byte\t0\n+\t.byte\t0\n+\t.uleb128 0x2\n+\t.uleb128 0x34\n+\t.byte\t0\n+\t.uleb128 0x3\n+\t.uleb128 0x8\n+\t.uleb128 0x3a\n+\t.uleb128 0xb\n+\t.uleb128 0x3b\n+\t.uleb128 0xb\n+\t.uleb128 0x39\n+\t.uleb128 0xb\n+\t.uleb128 0x49\n+\t.uleb128 0x13\n+\t.uleb128 0x3f\n+\t.uleb128 0x19\n+\t.uleb128 0x2\n+\t.uleb128 0x18\n+\t.byte\t0\n+\t.byte\t0\n+\t.uleb128 0x3\n+\t.uleb128 0x24\n+\t.byte\t0\n+\t.uleb128 0xb\n+\t.uleb128 0xb\n+\t.uleb128 0x3e\n+\t.uleb128 0xb\n+\t.uleb128 0x3\n+\t.uleb128 0x8\n+\t.byte\t0\n+\t.byte\t0\n+\t.byte\t0\n+\t.section\t.debug_aranges,\"\",%progbits\n+\t.4byte\t0x14\n+\t.2byte\t0x2\n+\t.4byte\t.Ldebug_info0\n+\t.byte\t0x4\n+\t.byte\t0\n+\t.2byte\t0\n+\t.2byte\t0\n+\t.4byte\t0\n+\t.4byte\t0\n+\t.section\t.debug_line,\"\",%progbits\n+.Ldebug_line0:\n+\t.section\t.debug_str,\"MS\",%progbits,1\n+.LASF2:\n+\t.asciz\t\"GNU C17 11.2.1 -g\"\n+\t.section\t.debug_line_str,\"MS\",%progbits,1\n+.LASF1:\n+\t.asciz\t\"/working/directory\"\n+.LASF0:\n+\t.asciz\t\"/full/path/test.c\"\n+\t.ident\t\"GCC: (GNU) 11.2.1\"\n+\t.section\t.note.GNU-stack,\"\",%progbits"
    },
    {
      "sha": "2502b80d1f96eab257e8016ceaa1f2a221180f2f",
      "filename": "gas/testsuite/gas/elf/dwarf-5-file0.d",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/dwarf-5-file0.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/dwarf-5-file0.d?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -1,5 +1,5 @@\n-#as: --gdwarf-3\n-#name: DWARF5 .line 0\n+#as: --gdwarf-5\n+#name: DWARF5 .file 0 (no directory)\n #readelf: -wl\n \n #..."
    },
    {
      "sha": "08105f88419c5d3ac76a192f652646ced85c1215",
      "filename": "gas/testsuite/gas/elf/elf.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/elf.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f9402ccaa9fac7858713a7672fae5760ae3d5ce7/gas/testsuite/gas/elf/elf.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/elf/elf.exp?ref=f9402ccaa9fac7858713a7672fae5760ae3d5ce7",
      "patch": "@@ -300,6 +300,7 @@ if { [is_elf_format] } then {\n     run_dump_test \"dwarf2-21\" $dump_opts\n     run_dump_test \"dwarf-5-file0\" $dump_opts\n     run_dump_test \"dwarf-5-file0-2\" $dump_opts\n+    run_dump_test \"dwarf-5-file0-3\" $dump_opts\n     run_dump_test \"dwarf-5-dir0\" $dump_opts\n     run_dump_test \"dwarf-5-loc0\" $dump_opts\n     run_dump_test \"dwarf-4-cu\" $dump_opts"
    }
  ]
}