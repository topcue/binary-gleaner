{
  "sha": "ef9768e37e34bec50aa8cbb0ce25708b06f09255",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZWY5NzY4ZTM3ZTM0YmVjNTBhYThjYmIwY2UyNTcwOGIwNmYwOTI1NQ==",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-09-16T23:51:21Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2021-09-17T22:50:11Z"
    },
    "message": "PR28149 part 2, purge generated line info\n\nMixing compiler generated line info with gas generated line info is\ngenerally just confusing.  Also .loc directives with non-zero view\nfields might reference a previous .loc.  It becomes a little more\ntricky to locate that previous .loc if there might be gas generated\nline info present too.  Mind you, we turn off gas generation of line\ninfo on seeing compiler generated line info, so any reference back\nwon't hit gas generated line info.  At least, if the view info is\nsane.  Unfortunately, gas needs to handle mangled source.\n\n\tPR 28149\n\t* dwarf2dbg.c (purge_generated_debug): New function.\n\t(dwarf2_directive_filename): Call the above.\n\t(out_debug_line): Don't segfault after purging.\n\t* testsuite/gas/i386/dwarf2-line-4.d: Update expected output.\n\t* testsuite/gas/i386/dwarf4-line-1.d: Likewise.\n\t* testsuite/gas/i386/dwarf5-line-1.d: Likewise.\n\t* testsuite/gas/i386/dwarf5-line-2.d: Likewise.",
    "tree": {
      "sha": "d614a1afd069ab15693dddfebcda02524b326290",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/d614a1afd069ab15693dddfebcda02524b326290"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ef9768e37e34bec50aa8cbb0ce25708b06f09255",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ef9768e37e34bec50aa8cbb0ce25708b06f09255",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ef9768e37e34bec50aa8cbb0ce25708b06f09255",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ef9768e37e34bec50aa8cbb0ce25708b06f09255/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "51298b330327a568358da069d9808f51c6cb1672",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/51298b330327a568358da069d9808f51c6cb1672",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/51298b330327a568358da069d9808f51c6cb1672"
    }
  ],
  "stats": {
    "total": 88,
    "additions": 40,
    "deletions": 48
  },
  "files": [
    {
      "sha": "1250fcef54f8c26f01698b695c258fa656021644",
      "filename": "gas/dwarf2dbg.c",
      "status": "modified",
      "additions": 29,
      "deletions": 1,
      "changes": 30,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/dwarf2dbg.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/dwarf2dbg.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/dwarf2dbg.c?ref=ef9768e37e34bec50aa8cbb0ce25708b06f09255",
      "patch": "@@ -782,6 +782,32 @@ do_allocate_filenum (struct line_entry *e)\n   while (e);\n }\n \n+/* Remove any generated line entries.  These don't live comfortably\n+   with compiler generated line info.  */\n+\n+static void\n+purge_generated_debug (void)\n+{\n+  struct line_seg *s;\n+\n+  for (s = all_segs; s; s = s->next)\n+    {\n+      struct line_subseg *lss = s->head;\n+      struct line_entry *e, *next;\n+\n+      for (e = lss->head; e; e = next)\n+\t{\n+\t  know (e->loc.filenum == -1u);\n+\t  next = e->next;\n+\t  free (e);\n+\t}\n+\n+      lss->head = NULL;\n+      lss->ptail = &lss->head;\n+      lss->pmove_tail = &lss->head;\n+    }\n+}\n+\n /* Allocate slot NUM in the .debug_line file table to FILENAME.\n    If DIRNAME is not NULL or there is a directory component to FILENAME\n    then this will be stored in the directory table, if not already present.\n@@ -1146,6 +1172,8 @@ dwarf2_directive_filename (void)\n \n   /* A .file directive implies compiler generated debug information is\n      being supplied.  Turn off gas generated debug info.  */\n+  if (debug_type == DEBUG_DWARF2)\n+    purge_generated_debug ();\n   debug_type = DEBUG_NONE;\n \n   if (num != (unsigned int) num\n@@ -2414,7 +2442,7 @@ out_debug_line (segT line_seg)\n   for (s = all_segs; s; s = s->next)\n     /* Paranoia - this check should have already have\n        been handled in dwarf2_gen_line_info_1().  */\n-    if (SEG_NORMAL (s->seg))\n+    if (s->head->head && SEG_NORMAL (s->seg))\n       process_entries (s->seg, s->head->head);\n \n   if (flag_dwarf_sections)"
    },
    {
      "sha": "0403c3e2faf736e45d8f7ac770a6d7d7864671c0",
      "filename": "gas/testsuite/gas/i386/dwarf2-line-4.d",
      "status": "modified",
      "additions": 3,
      "deletions": 9,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf2-line-4.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf2-line-4.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf2-line-4.d?ref=ef9768e37e34bec50aa8cbb0ce25708b06f09255",
      "patch": "@@ -28,21 +28,15 @@ Raw dump of debug contents of section \\.z?debug_line:\n   Opcode 11 has 0 args\n   Opcode 12 has 1 arg\n \n- The Directory Table \\(offset 0x.*\\):\n-  .*\n+ The Directory Table is empty\\.\n \n  The File Name Table \\(offset 0x.*\\):\n   Entry\tDir\tTime\tSize\tName\n   1\t0\t0\t0\tdwarf2-test.c\n-  2\t1\t0\t0\tdwarf2-line-4.s\n \n  Line Number Statements:\n-  \\[0x.*\\]  Set File Name to entry 2 in the File Name Table\n-  \\[0x.*\\]  Extended opcode 2: set Address to 0x0\n-  \\[0x.*\\]  Special opcode 13: advance Address by 0 to 0x0 and Line by 8 to 9\n-  \\[0x.*\\]  Set File Name to entry 1 in the File Name Table\n-  \\[0x.*\\]  Advance Line by -8 to 1\n-  \\[0x.*\\]  Special opcode 19: advance Address by 1 to 0x1 and Line by 0 to 1\n+  \\[0x.*\\]  Extended opcode 2: set Address to 0x1\n+  \\[0x.*\\]  Copy\n   \\[0x.*\\]  Advance PC by 1 to 0x2\n   \\[0x.*\\]  Extended opcode 1: End of Sequence\n "
    },
    {
      "sha": "762bdce9934d63d9db85e73bd58794851c66d1d5",
      "filename": "gas/testsuite/gas/i386/dwarf4-line-1.d",
      "status": "modified",
      "additions": 2,
      "deletions": 15,
      "changes": 17,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf4-line-1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf4-line-1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf4-line-1.d?ref=ef9768e37e34bec50aa8cbb0ce25708b06f09255",
      "patch": "@@ -29,24 +29,11 @@ Raw dump of debug contents of section \\.z?debug_line:\n   Opcode 11 has 0 args\n   Opcode 12 has 1 arg\n \n- The Directory Table \\(offset 0x.*\\):\n-  1\t.*/gas/testsuite/gas/i386\n+ The Directory Table is empty\\.\n \n  The File Name Table \\(offset 0x.*\\):\n   Entry\tDir\tTime\tSize\tName\n   1\t0\t0\t0\tfoo.c\n   2\t0\t0\t0\tfoo.h\n-  3\t1\t0\t0\tdwarf4-line-1.s\n-\n- Line Number Statements:\n-  \\[0x.*\\]  Set File Name to entry 2 in the File Name Table\n-  \\[0x.*\\]  Extended opcode 2: set Address to 0x0\n-  \\[0x.*\\]  Advance Line by 81 to 82\n-  \\[0x.*\\]  Copy\n-  \\[0x.*\\]  Set File Name to entry 3 in the File Name Table\n-  \\[0x.*\\]  Advance Line by -73 to 9\n-  \\[0x.*\\]  Special opcode 19: advance Address by 1 to 0x1 and Line by 0 to 9\n-  \\[0x.*\\]  Advance PC by 3 to 0x4\n-  \\[0x.*\\]  Extended opcode 1: End of Sequence\n-\n \n+ No Line Number Statements\\."
    },
    {
      "sha": "6ec51912dd11a786afe85dc3833b297b72060c18",
      "filename": "gas/testsuite/gas/i386/dwarf5-line-1.d",
      "status": "modified",
      "additions": 3,
      "deletions": 12,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf5-line-1.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf5-line-1.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf5-line-1.d?ref=ef9768e37e34bec50aa8cbb0ce25708b06f09255",
      "patch": "@@ -31,22 +31,13 @@ Raw dump of debug contents of section \\.z?debug_line:\n   Opcode 11 has 0 args\n   Opcode 12 has 1 arg\n \n- The Directory Table \\(offset 0x.*, lines 2, columns 1\\):\n+ The Directory Table \\(offset 0x.*, lines 1, columns 1\\):\n   Entry\tName\n   0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite\n-  1\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n \n- The File Name Table \\(offset 0x.*, lines 3, columns 3\\):\n+ The File Name Table \\(offset 0x.*, lines 2, columns 3\\):\n   Entry\tDir\tMD5\t\t\t\tName\n   0\t0 0xbbd69fc03ce253b2dbaab2522dd519ae\t\\(indirect line string, offset: 0x.*\\): core.c\n   1\t0 0x0\t\\(indirect line string, offset: 0x.*\\): types.h\n-  2\t1 0x0\t\\(indirect line string, offset: 0x.*\\): dwarf5-line-1.s\n-\n- Line Number Statements:\n-  \\[0x.*\\]  Set File Name to entry 2 in the File Name Table\n-  \\[0x.*\\]  Extended opcode 2: set Address to 0x0\n-  \\[0x.*\\]  Special opcode 8: advance Address by 0 to 0x0 and Line by 3 to 4\n-  \\[0x.*\\]  Advance PC by 1 to 0x1\n-  \\[0x.*\\]  Extended opcode 1: End of Sequence\n-\n \n+ No Line Number Statements\\."
    },
    {
      "sha": "4bb849bba345c49413f3593f84377909a785fe37",
      "filename": "gas/testsuite/gas/i386/dwarf5-line-2.d",
      "status": "modified",
      "additions": 3,
      "deletions": 11,
      "changes": 14,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf5-line-2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ef9768e37e34bec50aa8cbb0ce25708b06f09255/gas/testsuite/gas/i386/dwarf5-line-2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gas/testsuite/gas/i386/dwarf5-line-2.d?ref=ef9768e37e34bec50aa8cbb0ce25708b06f09255",
      "patch": "@@ -31,20 +31,12 @@ Raw dump of debug contents of section \\.z?debug_line:\n   Opcode 11 has 0 args\n   Opcode 12 has 1 arg\n \n- The Directory Table \\(offset 0x.*, lines 2, columns 1\\):\n+ The Directory Table \\(offset 0x.*, lines 1, columns 1\\):\n   Entry\tName\n   0\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite\n-  1\t\\(indirect line string, offset: 0x.*\\): .*/gas/testsuite/gas/i386\n \n- The File Name Table \\(offset 0x.*, lines 2, columns 3\\):\n+ The File Name Table \\(offset 0x.*, lines 1, columns 3\\):\n   Entry\tDir\tMD5\t\t\t\tName\n   0\t0 0xbbd69fc03ce253b2dbaab2522dd519ae\t\\(indirect line string, offset: 0x.*\\): core.c\n-  1\t1 0x0\t\\(indirect line string, offset: .*\\): dwarf5-line-2.s\n-\n- Line Number Statements:\n-  \\[0x.*\\]  Extended opcode 2: set Address to 0x0\n-  \\[0x.*\\]  Special opcode 8: advance Address by 0 to 0x0 and Line by 3 to 4\n-  \\[0x.*\\]  Advance PC by 1 to 0x1\n-  \\[0x.*\\]  Extended opcode 1: End of Sequence\n-\n \n+ No Line Number Statements\\."
    }
  ]
}