{
  "sha": "f049a313fcad4d51a55b6e635612c98e1a72b8a8",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZjA0OWEzMTNmY2FkNGQ1MWE1NWI2ZTYzNTYxMmM5OGUxYTcyYjhhOA==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tom@tromey.com",
      "date": "2020-04-24T21:35:01Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-04-24T21:35:03Z"
    },
    "message": "Don't call compute_and_set_names for partial symbols\n\nAs mentioned in another thread, there's currently no need to call\ncompute_and_set_names for partial symbols.  Because the DWARF partial\nsymbol reader constructs demangled names, this call can only demangle\na name by mistake.\n\nSo, this patch changes the DWARF reader to simply set the linkage name\non the new symbol.  This is equivalent to what was done before.  There\nshould be no user-visible change from this patch, aside from gdb\nspeeding up a bit.\n\n... there *should* be, but this regressed\ndw2-namespaceless-anonymous.exp.  However, upon examination, I think\nthat test is incorrect.  It puts a mangled name into DW_AT_name, and\nit puts the variable at the top level, not in a namespace.  This isn't\nwhat C++ compilers ought to do.  So, this patch also updates the test\ncase.\n\ngdb/ChangeLog\n2020-04-24  Tom Tromey  <tom@tromey.com>\n\n\t* dwarf2/read.c (add_partial_symbol): Do not call\n\tcompute_and_set_names.\n\ngdb/testsuite/ChangeLog\n2020-04-24  Tom Tromey  <tom@tromey.com>\n\n\t* gdb.dwarf2/dw2-namespaceless-anonymous.S: Remove.\n\t* gdb.dwarf2/dw2-namespaceless-anonymous.c: New file.\n\t* gdb.dwarf2/dw2-namespaceless-anonymous.exp: Use DWARF\n\tassembler.",
    "tree": {
      "sha": "557fb5f1a27dd76c83796fb92da4b2b78fefe186",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/557fb5f1a27dd76c83796fb92da4b2b78fefe186"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/f049a313fcad4d51a55b6e635612c98e1a72b8a8",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f049a313fcad4d51a55b6e635612c98e1a72b8a8",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/f049a313fcad4d51a55b6e635612c98e1a72b8a8",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/f049a313fcad4d51a55b6e635612c98e1a72b8a8/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa"
    }
  ],
  "stats": {
    "total": 177,
    "additions": 75,
    "deletions": 102
  },
  "files": [
    {
      "sha": "5544993af803ead775b502f4797d82825600fbb0",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=f049a313fcad4d51a55b6e635612c98e1a72b8a8",
      "patch": "@@ -1,3 +1,8 @@\n+2020-04-24  Tom Tromey  <tom@tromey.com>\n+\n+\t* dwarf2/read.c (add_partial_symbol): Do not call\n+\tcompute_and_set_names.\n+\n 2020-04-24  Tom Tromey  <tom@tromey.com>\n \n \t* dwarf2/read.c (add_partial_symbol): Use new add_psymbol_to_list"
    },
    {
      "sha": "d71bf9173838b245b25a856dc3e78422af685a6b",
      "filename": "gdb/dwarf2/read.c",
      "status": "modified",
      "additions": 3,
      "deletions": 3,
      "changes": 6,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/dwarf2/read.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/dwarf2/read.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/dwarf2/read.c?ref=f049a313fcad4d51a55b6e635612c98e1a72b8a8",
      "patch": "@@ -8376,9 +8376,9 @@ add_partial_symbol (struct partial_die_info *pdi, struct dwarf2_cu *cu)\n \n   if (where.has_value ())\n     {\n-      psymbol.ginfo.compute_and_set_names (actual_name,\n-\t\t\t\t\t   built_actual_name != nullptr,\n-\t\t\t\t\t   objfile->per_bfd);\n+      if (built_actual_name != nullptr)\n+\tactual_name = objfile->intern (actual_name);\n+      psymbol.ginfo.set_linkage_name (actual_name);\n       add_psymbol_to_list (psymbol, *where, objfile);\n     }\n }"
    },
    {
      "sha": "5c4dc6efa39cf7cf123312985bafe2525772c854",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=f049a313fcad4d51a55b6e635612c98e1a72b8a8",
      "patch": "@@ -1,3 +1,10 @@\n+2020-04-24  Tom Tromey  <tom@tromey.com>\n+\n+\t* gdb.dwarf2/dw2-namespaceless-anonymous.S: Remove.\n+\t* gdb.dwarf2/dw2-namespaceless-anonymous.c: New file.\n+\t* gdb.dwarf2/dw2-namespaceless-anonymous.exp: Use DWARF\n+\tassembler.\n+\n 2020-04-24  Tom de Vries  <tdevries@suse.de>\n \n \t* gdb.dwarf2/dw2-bad-mips-linkage-name.exp: Set language of CU to"
    },
    {
      "sha": "e5b1d66bb3a4dbca5ea2984abe11ae661e0961af",
      "filename": "gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.S",
      "status": "removed",
      "additions": 0,
      "deletions": 93,
      "changes": 93,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.S",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.S",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.S?ref=76e288d1d2f1a6b1a19fb9856dc3256a3a5443fa",
      "patch": "@@ -1,93 +0,0 @@\n-/* This testcase is part of GDB, the GNU debugger.\n-\n-   Copyright 2012-2020 Free Software Foundation, Inc.\n-\n-   This program is free software; you can redistribute it and/or modify\n-   it under the terms of the GNU General Public License as published by\n-   the Free Software Foundation; either version 3 of the License, or\n-   (at your option) any later version.\n-\n-   This program is distributed in the hope that it will be useful,\n-   but WITHOUT ANY WARRANTY; without even the implied warranty of\n-   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n-   GNU General Public License for more details.\n-\n-   You should have received a copy of the GNU General Public License\n-   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n-\n-\t.data\n-var:\t.4byte\t1\n-\n-\t.section .debug_info\n-.Lcu1_begin:\n-\t/* CU header */\n-\t.4byte\t.Lcu1_end - .Lcu1_start\t\t/* Length of Compilation Unit */\n-.Lcu1_start:\n-\t.2byte\t2\t\t\t\t/* DWARF Version */\n-\t.4byte\t.Labbrev1_begin\t\t\t/* Offset into abbrev section */\n-\t.byte\t4\t\t\t\t/* Pointer size */\n-\n-\t/* CU die */\n-\t.uleb128 1\t\t\t\t/* Abbrev: DW_TAG_compile_unit */\n-\t.ascii\t\"file1.txt\\0\"\t\t\t/* DW_AT_name */\n-\t.ascii\t\"GNU C 3.3.3\\0\"\t\t\t/* DW_AT_producer */\n-\t.byte\t4\t\t\t\t/* DW_LANG_C_plus_plus (C++) */\n-\n-.Ltype_myint:\n-\t.uleb128\t2\t\t\t/* Abbrev: DW_TAG_base_type */\n-\t.ascii\t\t\"myint\\0\"\t\t\t/* DW_AT_name */\n-\t.byte\t\t4\t\t\t/* DW_AT_byte_size */\n-\t.byte\t\t5\t\t\t/* DW_AT_encoding */\n-\n-\t.uleb128\t7\t\t\t/* Abbrev: DW_TAG_variable (location) */\n-\t.ascii\t\t\"_ZN12_GLOBAL__N_11vE\\0\" /* DW_AT_name = \"(anonymous namespace)::v\" */\n-\t.byte\t\t2f - 1f\t\t\t/* DW_AT_location */\n-1:\t.byte\t\t3\t\t\t/*   DW_OP_addr */\n-\t.4byte\t\tvar\t\t\t/*   <addr> */\n-2:\t.4byte\t\t.Ltype_myint-.Lcu1_begin /* DW_AT_type */\n-\n-\t.byte\t\t0\t\t\t/* End of children of CU */\n-\n-.Lcu1_end:\n-\n-/* Abbrev table */\n-\t.section .debug_abbrev\n-.Labbrev1_begin:\n-\t.uleb128\t1\t\t\t/* Abbrev code */\n-\t.uleb128\t0x11\t\t\t/* DW_TAG_compile_unit */\n-\t.byte\t\t1\t\t\t/* has_children */\n-\t.uleb128\t0x3\t\t\t/* DW_AT_name */\n-\t.uleb128\t0x8\t\t\t/* DW_FORM_string */\n-\t.uleb128\t0x25\t\t\t/* DW_AT_producer */\n-\t.uleb128\t0x8\t\t\t/* DW_FORM_string */\n-\t.uleb128\t0x13\t\t\t/* DW_AT_language */\n-\t.uleb128\t0xb\t\t\t/* DW_FORM_data1 */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\n-\t.uleb128\t2\t\t\t/* Abbrev code */\n-\t.uleb128\t0x24\t\t\t/* DW_TAG_base_type */\n-\t.byte\t\t0\t\t\t/* has_children */\n-\t.uleb128\t0x3\t\t\t/* DW_AT_name */\n-\t.uleb128\t0x8\t\t\t/* DW_FORM_string */\n-\t.uleb128\t0xb\t\t\t/* DW_AT_byte_size */\n-\t.uleb128\t0xb\t\t\t/* DW_FORM_data1 */\n-\t.uleb128\t0x3e\t\t\t/* DW_AT_encoding */\n-\t.uleb128\t0xb\t\t\t/* DW_FORM_data1 */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\n-\t.uleb128\t7\t\t\t/* Abbrev code (location) */\n-\t.uleb128\t0x34\t\t\t/* DW_TAG_variable */\n-\t.byte\t\t0\t\t\t/* has_children */\n-\t.uleb128\t0x3\t\t\t/* DW_AT_name */\n-\t.uleb128\t0x8\t\t\t/* DW_FORM_string */\n-\t.uleb128\t0x2\t\t\t/* DW_AT_location */\n-\t.uleb128\t0xa\t\t\t/* DW_FORM_block1 */\n-\t.uleb128\t0x49\t\t\t/* DW_AT_type */\n-\t.uleb128\t0x13\t\t\t/* DW_FORM_ref4 */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\n-\t.byte\t\t0x0\t\t\t/* Terminator */\n-\t.byte\t\t0x0\t\t\t/* Terminator */"
    },
    {
      "sha": "3c5e258090c47888b08e3b52845d3cfe3cbd5006",
      "filename": "gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.c",
      "status": "added",
      "additions": 22,
      "deletions": 0,
      "changes": 22,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.c?ref=f049a313fcad4d51a55b6e635612c98e1a72b8a8",
      "patch": "@@ -0,0 +1,22 @@\n+/* This testcase is part of GDB, the GNU debugger.\n+\n+   Copyright 2020 Free Software Foundation, Inc.\n+\n+   This program is free software; you can redistribute it and/or modify\n+   it under the terms of the GNU General Public License as published by\n+   the Free Software Foundation; either version 3 of the License, or\n+   (at your option) any later version.\n+\n+   This program is distributed in the hope that it will be useful,\n+   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+   GNU General Public License for more details.\n+\n+   You should have received a copy of the GNU General Public License\n+   along with this program.  If not, see <http://www.gnu.org/licenses/>.  */\n+\n+char _ZN12_GLOBAL__N_11vE = 1;\n+\n+int main ()\n+{\n+}"
    },
    {
      "sha": "5b61a6ba92889cb3b2c9c9918a803968c0a813e6",
      "filename": "gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.exp",
      "status": "modified",
      "additions": 38,
      "deletions": 6,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/f049a313fcad4d51a55b6e635612c98e1a72b8a8/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.dwarf2/dw2-namespaceless-anonymous.exp?ref=f049a313fcad4d51a55b6e635612c98e1a72b8a8",
      "patch": "@@ -14,19 +14,51 @@\n # along with this program.  If not, see <http://www.gnu.org/licenses/>.\n load_lib dwarf.exp\n \n+load_lib dwarf.exp\n+\n # This test can only be run on targets which support DWARF-2 and use gas.\n if {![dwarf2_support]} {\n     return 0  \n }\n \n-standard_testfile .S\n+standard_testfile dw2-namespaceless-anonymous.c dw2-namespaceless-anonymous.S\n \n-if  { [gdb_compile \"${srcdir}/${subdir}/${srcfile}\" $binfile \\\n-\t   object {nodebug}] != \"\" } {\n-    return -1\n+set asm_file [standard_output_file $srcfile2]\n+Dwarf::assemble $asm_file {\n+    global srcdir subdir srcfile\n+\n+    cu {} {\n+\tDW_TAG_compile_unit {\n+\t    {DW_AT_language @DW_LANG_C_plus_plus}\n+\t    {DW_AT_name     dw2-namespaceless-anonymous.c}\n+\t    {DW_AT_comp_dir /tmp}\n+\t} {\n+\t    declare_labels myint\n+\n+\t    myint: DW_TAG_base_type {\n+\t\t{DW_AT_byte_size 1 DW_FORM_sdata}\n+\t\t{DW_AT_encoding  @DW_ATE_signed}\n+\t\t{DW_AT_name      myint}\n+\t    }\n+\n+\t    DW_TAG_namespace {} {\n+\t\tDW_TAG_variable {\n+\t\t    {DW_AT_name v}\n+\t\t    {DW_AT_linkage_name _ZN12_GLOBAL__N_11vE}\n+\t\t    {DW_AT_location {\n+\t\t\tDW_OP_addr [gdb_target_symbol _ZN12_GLOBAL__N_11vE]\n+\t\t    } SPECIAL_expr}\n+\t\t    {DW_AT_type :$myint}\n+\t\t}\n+\t    }\n+\t}\n+    }\n }\n \n-clean_restart $testfile\n+if {[prepare_for_testing ${testfile}.exp ${testfile} \\\n+\t [list $srcfile $asm_file] {nodebug}] } {\n+    return -1\n+}\n \n gdb_test \"ptype '(anonymous namespace)::v'\" \"type = myint\"\n-gdb_test \"p '(anonymous namespace)::v'\" \" = 1\"\n+gdb_test \"p/d '(anonymous namespace)::v'\" \" = 1\""
    }
  ]
}