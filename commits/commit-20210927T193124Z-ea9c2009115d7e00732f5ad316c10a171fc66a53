{
  "sha": "ea9c2009115d7e00732f5ad316c10a171fc66a53",
  "node_id": "C_kwDOANOeidoAKGVhOWMyMDA5MTE1ZDdlMDA3MzJmNWFkMzE2YzEwYTE3MWZjNjZhNTM",
  "commit": {
    "author": {
      "name": "Nick Alcock",
      "email": "nick.alcock@oracle.com",
      "date": "2021-09-27T19:31:21Z"
    },
    "committer": {
      "name": "Nick Alcock",
      "email": "nick.alcock@oracle.com",
      "date": "2021-09-27T19:31:24Z"
    },
    "message": "libctf: try several possibilities for linker versioning flags\n\nChecking for linker versioning by just grepping ld --help output for\nmentions of --version-script is inadequate now that Solaris 11.4\nimplements a --version-script with different semantics.  Try linking a\ntest program with a small wildcard-using version script with each\nsupported set of flags in turn, to make sure that linker versioning is\nnot only advertised but actually works.\n\nThe Solaris \"GNU-compatible\" linker versioning is not quite\nGNU-compatible enough, but we can work around the differences by\ngenerating a new version script that removes the comments from the\noriginal (Solaris ld requires #-style comments), and making another\nversion script for libctf-nonbfd in particular which doesn't mention any\nof the symbols that appear in libctf.la, to avoid Solaris ld introducing\ncorresponding new NOTYPE symbols to match the version script.\n\nlibctf/ChangeLog\n2021-09-27  Nick Alcock  <nick.alcock@oracle.com>\n\n\tPR libctf/27967\n\t* configure.ac (VERSION_FLAGS): Replace with...\n\t(ac_cv_libctf_version_script): ... this multiple test.\n\t(VERSION_FLAGS_NOBFD): Substitute this too.\n\t* Makefile.am (libctf_nobfd_la_LDFLAGS): Use it.  Split out...\n\t(libctf_ldflags_nover): ... non-versioning flags here.\n\t(libctf_la_LDFLAGS): Use it.\n\t* libctf.ver: Give every symbol not in libctf-nobfd a comment on\n\tthe same line noting as much.",
    "tree": {
      "sha": "964e06b495b0f2eea0b157a8765093ed265dac6e",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/964e06b495b0f2eea0b157a8765093ed265dac6e"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/ea9c2009115d7e00732f5ad316c10a171fc66a53",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ea9c2009115d7e00732f5ad316c10a171fc66a53",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/ea9c2009115d7e00732f5ad316c10a171fc66a53",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/ea9c2009115d7e00732f5ad316c10a171fc66a53/comments",
  "author": {
    "login": "nickalcock",
    "id": 6503005,
    "node_id": "MDQ6VXNlcjY1MDMwMDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6503005?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickalcock",
    "html_url": "https://github.com/nickalcock",
    "followers_url": "https://api.github.com/users/nickalcock/followers",
    "following_url": "https://api.github.com/users/nickalcock/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickalcock/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickalcock/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickalcock/subscriptions",
    "organizations_url": "https://api.github.com/users/nickalcock/orgs",
    "repos_url": "https://api.github.com/users/nickalcock/repos",
    "events_url": "https://api.github.com/users/nickalcock/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickalcock/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "nickalcock",
    "id": 6503005,
    "node_id": "MDQ6VXNlcjY1MDMwMDU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6503005?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/nickalcock",
    "html_url": "https://github.com/nickalcock",
    "followers_url": "https://api.github.com/users/nickalcock/followers",
    "following_url": "https://api.github.com/users/nickalcock/following{/other_user}",
    "gists_url": "https://api.github.com/users/nickalcock/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/nickalcock/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/nickalcock/subscriptions",
    "organizations_url": "https://api.github.com/users/nickalcock/orgs",
    "repos_url": "https://api.github.com/users/nickalcock/repos",
    "events_url": "https://api.github.com/users/nickalcock/events{/privacy}",
    "received_events_url": "https://api.github.com/users/nickalcock/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "bef9ef8ca0f941d743c77cc55b5fe7985990b2a7",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/bef9ef8ca0f941d743c77cc55b5fe7985990b2a7",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/bef9ef8ca0f941d743c77cc55b5fe7985990b2a7"
    }
  ],
  "stats": {
    "total": 73,
    "additions": 62,
    "deletions": 11
  },
  "files": [
    {
      "sha": "03d8506f92ba0d198c2a42d3d38c7048b99d0e40",
      "filename": "libctf/ChangeLog",
      "status": "modified",
      "additions": 12,
      "deletions": 0,
      "changes": 12,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/libctf/ChangeLog?ref=ea9c2009115d7e00732f5ad316c10a171fc66a53",
      "patch": "@@ -1,3 +1,15 @@\n+2021-09-27  Nick Alcock  <nick.alcock@oracle.com>\n+\n+\tPR libctf/27967\n+\t* configure.ac (VERSION_FLAGS): Replace with...\n+\t(ac_cv_libctf_version_script): ... this multiple test.\n+\t(VERSION_FLAGS_NOBFD): Substitute this too.\n+\t* Makefile.am (libctf_nobfd_la_LDFLAGS): Use it.  Split out...\n+\t(libctf_ldflags_nover): ... non-versioning flags here.\n+\t(libctf_la_LDFLAGS): Use it.\n+\t* libctf.ver: Give every symbol not in libctf-nobfd a comment on\n+\tthe same line noting as much.\n+\n 2021-09-27  Nick Alcock  <nick.alcock@oracle.com>\n \n \tPR libctf/27360"
    },
    {
      "sha": "31fcb5d320acd830c20f6f0c250140405ab85627",
      "filename": "libctf/Makefile.am",
      "status": "modified",
      "additions": 3,
      "deletions": 2,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/Makefile.am",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/Makefile.am",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/libctf/Makefile.am?ref=ea9c2009115d7e00732f5ad316c10a171fc66a53",
      "patch": "@@ -42,7 +42,8 @@ noinst_LTLIBRARIES = libctf.la libctf-nobfd.la\n endif\n \n libctf_nobfd_la_LIBADD = @CTF_LIBADD@ $(ZLIB)\n-libctf_nobfd_la_LDFLAGS = -version-info 0:0:0 @SHARED_LDFLAGS@ @VERSION_FLAGS@\n+libctf_ldflags_nover = -version-info 0:0:0 @SHARED_LDFLAGS@\n+libctf_nobfd_la_LDFLAGS = $(libctf_ldflags_nover) @VERSION_FLAGS_NOBFD@\n libctf_nobfd_la_CPPFLAGS = $(AM_CPPFLAGS) -DNOBFD=1\n libctf_nobfd_la_SOURCES = ctf-archive.c ctf-dump.c ctf-create.c ctf-decl.c ctf-error.c \\\n \t\t\t  ctf-hash.c ctf-labels.c ctf-dedup.c ctf-link.c ctf-lookup.c \\\n@@ -58,7 +59,7 @@ endif\n # references in there get picked up.\n libctf_la_LIBADD =  @CTF_LIBADD@ ../bfd/libbfd.la $(libctf_nobfd_la_LIBADD)\n libctf_la_CPPFLAGS = $(AM_CPPFLAGS) -DNOBFD=0\n-libctf_la_LDFLAGS = $(libctf_nobfd_la_LDFLAGS)\n+libctf_la_LDFLAGS = $(libctf_ldflags_nover) @VERSION_FLAGS@\n libctf_la_SOURCES = $(libctf_nobfd_la_SOURCES) ctf-open-bfd.c\n \n # Setup the testing framework, if you have one"
    },
    {
      "sha": "4e12a4fa8f6b0d6defedb96adbec5044c70be2e8",
      "filename": "libctf/configure.ac",
      "status": "modified",
      "additions": 43,
      "deletions": 3,
      "changes": 46,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/configure.ac",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/configure.ac",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/libctf/configure.ac?ref=ea9c2009115d7e00732f5ad316c10a171fc66a53",
      "patch": "@@ -219,11 +219,51 @@ fi`\n AM_CONDITIONAL(TCL_TRY, test \"${ac_cv_libctf_tcl_try}\" = yes)\n \n # Use a version script, if possible, or an -export-symbols-regex otherwise.\n-VERSION_FLAGS='-export-symbols-regex ctf_.*'\n-if $LD --help 2>&1 | grep -- --version-script >/dev/null; then\n-    VERSION_FLAGS=\"-Wl,--version-script='$srcdir/libctf.ver'\"\n+decommented_version_script=\n+AC_CACHE_CHECK([for linker versioning flags], [ac_cv_libctf_version_script],\n+  [echo 'FOO { global: mai*; local: ctf_fo*; };' > conftest.ver\n+   old_LDFLAGS=\"$LDFLAGS\"\n+   old_CFLAGS=\"$CFLAGS\"\n+   LDFLAGS=\"$LDFLAGS -shared -Wl,--version-script=conftest.ver\"\n+   CFLAGS=\"$CFLAGS -fPIC\"\n+   AC_LINK_IFELSE([AC_LANG_SOURCE([[int ctf_foo (void) { return 0; }\n+\t\t\t\t    int main (void) { return ctf_foo(); }]])],\n+\t\t  [ac_cv_libctf_version_script=\"-Wl,--version-script='$srcdir/libctf.ver'\"],\n+\t\t  [])\n+   LDFLAGS=\"$old_LDFLAGS\"\n+\n+   if test -z \"$ac_cv_libctf_version_script\"; then\n+     LDFLAGS=\"$LDFLAGS -shared -Wl,-B,local -Wl,-z,gnu-version-script=conftest.ver\"\n+     AC_LINK_IFELSE([AC_LANG_SOURCE([[int ctf_foo (void) { return 0; }\n+\t\t\t\t      int main (void) { return ctf_foo(); }]])],\n+\t\t    [ac_cv_libctf_version_script=\"-Wl,-B,local -Wl,-z,gnu-version-script\"\n+\t\t     decommented_version_script=t],\n+\t\t    [])\n+     LDFLAGS=\"$old_LDFLAGS\"\n+   fi\n+   CFLAGS=\"$old_CFLAGS\"\n+\n+   if test -z \"$ac_cv_libctf_version_script\"; then\n+     ac_cv_libctf_version_script='-export-symbols-regex ctf_.*'\n+   fi\n+   rm -f conftest.ver])\n+if test -n \"$decommented_version_script\"; then\n+   # Solaris's version scripts use shell-style comments rather than the C-style\n+   # used by GNU ld.  Use cpp to strip the comments out.  (cpp exists under this\n+   # name on all platforms that support ld -z gnu-version-script.)\n+   # Also ensure that no symbols exist in the version script for libctf-nobfd.so\n+   # that do not exist in the shared library itself, since some linkers add such\n+   # symbols with type NOTYPE.\n+   /lib/cpp < $srcdir/libctf.ver > libctf-decommented.ver\n+   grep -v 'libctf only' $srcdir/libctf.ver | /lib/cpp > libctf-nobfd-decommented.ver\n+   VERSION_FLAGS=\"$ac_cv_libctf_version_script='libctf-decommented.ver'\"\n+   VERSION_FLAGS_NOBFD=\"$ac_cv_libctf_version_script='libctf-nobfd-decommented.ver'\"\n+else\n+   VERSION_FLAGS=\"$ac_cv_libctf_version_script\"\n+   VERSION_FLAGS_NOBFD=\"$ac_cv_libctf_version_script\"\n fi\n AC_SUBST(VERSION_FLAGS)\n+AC_SUBST(VERSION_FLAGS_NOBFD)\n \n AC_CONFIG_FILES(Makefile)\n AC_CONFIG_HEADERS(config.h)"
    },
    {
      "sha": "602c13fba175bb43dfc2302aaf532c02b74800a5",
      "filename": "libctf/libctf.ver",
      "status": "modified",
      "additions": 4,
      "deletions": 6,
      "changes": 10,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/libctf.ver",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/ea9c2009115d7e00732f5ad316c10a171fc66a53/libctf/libctf.ver",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/libctf/libctf.ver?ref=ea9c2009115d7e00732f5ad316c10a171fc66a53",
      "patch": "@@ -165,12 +165,10 @@ LIBCTF_1.0 {\n \tctf_link_shuffle_syms;\n \tctf_link_write;\n \n-\t/* In libctf alone.  */\n-\n-\tctf_fdopen;\n-\tctf_open;\n-\tctf_bfdopen;\n-\tctf_bfdopen_ctfsect;\n+\tctf_fdopen;                             /* libctf only.  */\n+\tctf_open;                               /* libctf only.  */\n+\tctf_bfdopen;                            /* libctf only.  */\n+\tctf_bfdopen_ctfsect;                    /* libctf only.  */\n     local:\n \t*;\n };"
    }
  ]
}