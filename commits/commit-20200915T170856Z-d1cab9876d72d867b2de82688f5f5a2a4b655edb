{
  "sha": "d1cab9876d72d867b2de82688f5f5a2a4b655edb",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6ZDFjYWI5ODc2ZDcyZDg2N2IyZGU4MjY4OGY1ZjVhMmE0YjY1NWVkYg==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-09-15T17:08:56Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2020-09-15T17:08:56Z"
    },
    "message": "Don't use gdb_py_long_from_ulongest\n\nRemove the gdb_py_long_from_ulongest defines and change the Python\nlayer to prefer gdb_py_object_from_ulongest.  While writing this I\nnoticed that the error handling in archpy_disassemble was incorrect --\nit could call PyDict_SetItemString with a NULL value.  This patch also\nfixes this bug.\n\ngdb/ChangeLog\n2020-09-15  Tom Tromey  <tromey@adacore.com>\n\n\t* python/python-internal.h (gdb_py_long_from_ulongest): Remove\n\tdefines.\n\t* python/py-value.c (valpy_long): Use\n\tgdb_py_object_from_ulongest.\n\t* python/py-symtab.c (salpy_get_pc): Use\n\tgdb_py_object_from_ulongest.\n\t(salpy_get_last): Likewise.\n\t* python/py-record-btrace.c (recpy_bt_insn_pc): Use\n\tgdb_py_object_from_ulongest.\n\t* python/py-lazy-string.c (stpy_get_address): Use\n\tgdb_py_object_from_ulongest.\n\t* python/py-frame.c (frapy_pc): Use gdb_py_object_from_ulongest.\n\t* python/py-arch.c (archpy_disassemble): Use\n\tgdb_py_object_from_ulongest and gdb_py_object_from_longest.  Fix\n\terror handling.",
    "tree": {
      "sha": "e427c640bc2fe1ebd2e57fd16408901df0161516",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/e427c640bc2fe1ebd2e57fd16408901df0161516"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/d1cab9876d72d867b2de82688f5f5a2a4b655edb",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d1cab9876d72d867b2de82688f5f5a2a4b655edb",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/d1cab9876d72d867b2de82688f5f5a2a4b655edb",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/d1cab9876d72d867b2de82688f5f5a2a4b655edb/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "4bde49dc81c5c16189af70b9a144dbb5651994f1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/4bde49dc81c5c16189af70b9a144dbb5651994f1",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/4bde49dc81c5c16189af70b9a144dbb5651994f1"
    }
  ],
  "stats": {
    "total": 57,
    "additions": 41,
    "deletions": 16
  },
  "files": [
    {
      "sha": "504a916314f6adbf060c905dca8f298379bc61cd",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -1,3 +1,21 @@\n+2020-09-15  Tom Tromey  <tromey@adacore.com>\n+\n+\t* python/python-internal.h (gdb_py_long_from_ulongest): Remove\n+\tdefines.\n+\t* python/py-value.c (valpy_long): Use\n+\tgdb_py_object_from_ulongest.\n+\t* python/py-symtab.c (salpy_get_pc): Use\n+\tgdb_py_object_from_ulongest.\n+\t(salpy_get_last): Likewise.\n+\t* python/py-record-btrace.c (recpy_bt_insn_pc): Use\n+\tgdb_py_object_from_ulongest.\n+\t* python/py-lazy-string.c (stpy_get_address): Use\n+\tgdb_py_object_from_ulongest.\n+\t* python/py-frame.c (frapy_pc): Use gdb_py_object_from_ulongest.\n+\t* python/py-arch.c (archpy_disassemble): Use\n+\tgdb_py_object_from_ulongest and gdb_py_object_from_longest.  Fix\n+\terror handling.\n+\n 2020-09-15  Tom Tromey  <tromey@adacore.com>\n \n \t* python/python-internal.h (gdb_py_long_from_longest): Remove"
    },
    {
      "sha": "3f8e769ff59ee8e61bf19d4d06b40d3b2aa5cbb8",
      "filename": "gdb/python/py-arch.c",
      "status": "modified",
      "additions": 17,
      "deletions": 8,
      "changes": 25,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-arch.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-arch.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-arch.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -209,14 +209,23 @@ archpy_disassemble (PyObject *self, PyObject *args, PyObject *kw)\n \t  return NULL;\n         }\n \n-      if (PyDict_SetItemString (insn_dict.get (), \"addr\",\n-                                gdb_py_long_from_ulongest (pc))\n-          || PyDict_SetItemString (insn_dict.get (), \"asm\",\n-                                   PyString_FromString (!stb.empty ()\n-\t\t\t\t\t\t\t? stb.c_str ()\n-\t\t\t\t\t\t\t: \"<unknown>\"))\n-          || PyDict_SetItemString (insn_dict.get (), \"length\",\n-                                   PyInt_FromLong (insn_len)))\n+      gdbpy_ref<> pc_obj = gdb_py_object_from_ulongest (pc);\n+      if (pc_obj == nullptr)\n+\treturn nullptr;\n+\n+      gdbpy_ref<> asm_obj (PyString_FromString (!stb.empty ()\n+\t\t\t\t\t\t? stb.c_str ()\n+\t\t\t\t\t\t: \"<unknown>\"));\n+      if (asm_obj == nullptr)\n+\treturn nullptr;\n+\n+      gdbpy_ref<> len_obj = gdb_py_object_from_longest (insn_len);\n+      if (len_obj == nullptr)\n+\treturn nullptr;\n+\n+      if (PyDict_SetItemString (insn_dict.get (), \"addr\", pc_obj.get ())\n+          || PyDict_SetItemString (insn_dict.get (), \"asm\", asm_obj.get ())\n+          || PyDict_SetItemString (insn_dict.get (), \"length\", len_obj.get ()))\n \treturn NULL;\n \n       pc += insn_len;"
    },
    {
      "sha": "090705507e6560187d227a990bf6ab175cd468c4",
      "filename": "gdb/python/py-frame.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-frame.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-frame.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-frame.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -232,7 +232,7 @@ frapy_pc (PyObject *self, PyObject *args)\n       GDB_PY_HANDLE_EXCEPTION (except);\n     }\n \n-  return gdb_py_long_from_ulongest (pc);\n+  return gdb_py_object_from_ulongest (pc).release ();\n }\n \n /* Implementation of gdb.Frame.read_register (self, register) -> gdb.Value."
    },
    {
      "sha": "401c0a6fdf5fe495c5296c932fed717fbcb477ae",
      "filename": "gdb/python/py-lazy-string.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-lazy-string.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-lazy-string.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-lazy-string.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -61,7 +61,7 @@ stpy_get_address (PyObject *self, void *closure)\n {\n   lazy_string_object *self_string = (lazy_string_object *) self;\n \n-  return gdb_py_long_from_ulongest (self_string->address);\n+  return gdb_py_object_from_ulongest (self_string->address).release ();\n }\n \n static PyObject *"
    },
    {
      "sha": "762c0bcbcc00dfaac51c44a7beec3a3b60b2344f",
      "filename": "gdb/python/py-record-btrace.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-record-btrace.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-record-btrace.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-record-btrace.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -232,7 +232,7 @@ recpy_bt_insn_pc (PyObject *self, void *closure)\n   if (insn == NULL)\n     return NULL;\n \n-  return gdb_py_long_from_ulongest (insn->pc);\n+  return gdb_py_object_from_ulongest (insn->pc).release ();\n }\n \n /* Implementation of RecordInstruction.size [int] for btrace."
    },
    {
      "sha": "b0e7618af7ed58e67766d9ec05c4aacf9406e2fb",
      "filename": "gdb/python/py-symtab.c",
      "status": "modified",
      "additions": 2,
      "deletions": 2,
      "changes": 4,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-symtab.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-symtab.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-symtab.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -264,7 +264,7 @@ salpy_get_pc (PyObject *self, void *closure)\n \n   SALPY_REQUIRE_VALID (self, sal);\n \n-  return gdb_py_long_from_ulongest (sal->pc);\n+  return gdb_py_object_from_ulongest (sal->pc).release ();\n }\n \n /* Implementation of the get method for the 'last' attribute of\n@@ -278,7 +278,7 @@ salpy_get_last (PyObject *self, void *closure)\n   SALPY_REQUIRE_VALID (self, sal);\n \n   if (sal->end > 0)\n-    return gdb_py_long_from_ulongest (sal->end - 1);\n+    return gdb_py_object_from_ulongest (sal->end - 1).release ();\n   else\n     Py_RETURN_NONE;\n }"
    },
    {
      "sha": "bb88bf358908d1636f2d46b3c112574ebb61078c",
      "filename": "gdb/python/py-value.c",
      "status": "modified",
      "additions": 1,
      "deletions": 1,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-value.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/py-value.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/py-value.c?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -1731,7 +1731,7 @@ valpy_long (PyObject *self)\n     }\n \n   if (type->is_unsigned ())\n-    return gdb_py_long_from_ulongest (l);\n+    return gdb_py_object_from_ulongest (l).release ();\n   else\n     return gdb_py_object_from_longest (l).release ();\n }"
    },
    {
      "sha": "2c4195f3d03e7f9fe31177977e281b95466690d2",
      "filename": "gdb/python/python-internal.h",
      "status": "modified",
      "additions": 0,
      "deletions": 2,
      "changes": 2,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/python-internal.h",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/d1cab9876d72d867b2de82688f5f5a2a4b655edb/gdb/python/python-internal.h",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/python/python-internal.h?ref=d1cab9876d72d867b2de82688f5f5a2a4b655edb",
      "patch": "@@ -126,7 +126,6 @@\n #define GDB_PY_LLU_ARG \"K\"\n typedef PY_LONG_LONG gdb_py_longest;\n typedef unsigned PY_LONG_LONG gdb_py_ulongest;\n-#define gdb_py_long_from_ulongest PyLong_FromUnsignedLongLong\n #define gdb_py_long_as_ulongest PyLong_AsUnsignedLongLong\n \n #else /* HAVE_LONG_LONG */\n@@ -135,7 +134,6 @@ typedef unsigned PY_LONG_LONG gdb_py_ulongest;\n #define GDB_PY_LLU_ARG \"K\"\n typedef long gdb_py_longest;\n typedef unsigned long gdb_py_ulongest;\n-#define gdb_py_long_from_ulongest PyLong_FromUnsignedLong\n #define gdb_py_long_as_ulongest PyLong_AsUnsignedLong\n \n #endif /* HAVE_LONG_LONG */"
    }
  ]
}