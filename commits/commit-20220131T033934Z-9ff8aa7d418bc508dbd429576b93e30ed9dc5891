{
  "sha": "9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
  "node_id": "C_kwDOANOeidoAKDlmZjhhYTdkNDE4YmM1MDhkYmQ0Mjk1NzZiOTNlMzBlZDlkYzU4OTE",
  "commit": {
    "author": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2022-01-30T23:08:17Z"
    },
    "committer": {
      "name": "Alan Modra",
      "email": "amodra@gmail.com",
      "date": "2022-01-31T03:39:34Z"
    },
    "message": "Re: PR28827, assertion building LLVM 9 on powerpc64le-linux-gnu\n\nIn trying to find a testcase for PR28827, I managed to hit a linker\nerror in bfd_set_section_contents with a .branch_lt input section\nbeing too large for the output .branch_lt.\n\nbfd/\n\tPR 28827\n\t* elf64-ppc.c (ppc64_elf_size_stubs): Set section size to\n\tmaxsize past STUB_SHRINK_ITER before laying out.  Remove now\n\tunnecessary conditional setting of maxsize at start of loop.\nld/\n\t* testsuite/ld-powerpc/pr28827-2.d,\n\t* testsuite/ld-powerpc/pr28827-2.lnk,\n\t* testsuite/ld-powerpc/pr28827-2.s: New test.\n\t* testsuite/ld-powerpc/powerpc.exp: Run it.",
    "tree": {
      "sha": "b3824081c322e03acf00fe47eac23da0e07bf6bb",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/b3824081c322e03acf00fe47eac23da0e07bf6bb"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/comments",
  "author": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "amodra",
    "id": 6006325,
    "node_id": "MDQ6VXNlcjYwMDYzMjU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6006325?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/amodra",
    "html_url": "https://github.com/amodra",
    "followers_url": "https://api.github.com/users/amodra/followers",
    "following_url": "https://api.github.com/users/amodra/following{/other_user}",
    "gists_url": "https://api.github.com/users/amodra/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/amodra/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/amodra/subscriptions",
    "organizations_url": "https://api.github.com/users/amodra/orgs",
    "repos_url": "https://api.github.com/users/amodra/repos",
    "events_url": "https://api.github.com/users/amodra/events{/privacy}",
    "received_events_url": "https://api.github.com/users/amodra/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "a634f5af2f57db8028d75ccebc478146d42e3151",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/a634f5af2f57db8028d75ccebc478146d42e3151",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/a634f5af2f57db8028d75ccebc478146d42e3151"
    }
  ],
  "stats": {
    "total": 101,
    "additions": 91,
    "deletions": 10
  },
  "files": [
    {
      "sha": "b4fa4aed7b60882d2f1c95a3860cb30e9bcae664",
      "filename": "bfd/elf64-ppc.c",
      "status": "modified",
      "additions": 18,
      "deletions": 10,
      "changes": 28,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/bfd/elf64-ppc.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/bfd/elf64-ppc.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/bfd/elf64-ppc.c?ref=9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
      "patch": "@@ -14093,10 +14093,7 @@ ppc64_elf_size_stubs (struct bfd_link_info *info)\n \t    {\n \t      asection *stub_sec = group->stub_sec;\n \n-\t      if (htab->stub_iteration <= STUB_SHRINK_ITER\n-\t\t  || stub_sec->rawsize < stub_sec->size)\n-\t\t/* Past STUB_SHRINK_ITER, rawsize is the max size seen.  */\n-\t\tstub_sec->rawsize = stub_sec->size;\n+\t      stub_sec->rawsize = stub_sec->size;\n \t      stub_sec->size = 0;\n \t      stub_sec->reloc_count = 0;\n \t      stub_sec->flags &= ~SEC_RELOC;\n@@ -14111,9 +14108,7 @@ ppc64_elf_size_stubs (struct bfd_link_info *info)\n \t  htab->tga_group->stub_sec->size = 24 * 4;\n \t}\n \n-      if (htab->stub_iteration <= STUB_SHRINK_ITER\n-\t  || htab->brlt->rawsize < htab->brlt->size)\n-\thtab->brlt->rawsize = htab->brlt->size;\n+      htab->brlt->rawsize = htab->brlt->size;\n       htab->brlt->size = 0;\n       htab->brlt->reloc_count = 0;\n       htab->brlt->flags &= ~SEC_RELOC;\n@@ -14122,9 +14117,7 @@ ppc64_elf_size_stubs (struct bfd_link_info *info)\n \n       if (htab->elf.srelrdyn != NULL)\n \t{\n-\t  if (htab->stub_iteration <= STUB_SHRINK_ITER\n-\t      || htab->elf.srelrdyn->rawsize < htab->elf.srelrdyn->size)\n-\t    htab->elf.srelrdyn->rawsize = htab->elf.srelrdyn->size;\n+\t  htab->elf.srelrdyn->rawsize = htab->elf.srelrdyn->size;\n \t  htab->elf.srelrdyn->size = 0;\n \t}\n \n@@ -14240,6 +14233,21 @@ ppc64_elf_size_stubs (struct bfd_link_info *info)\n \t      || htab->stub_iteration > 1))\n \tbreak;\n \n+      if (htab->stub_iteration > STUB_SHRINK_ITER)\n+\t{\n+\t  for (group = htab->group; group != NULL; group = group->next)\n+\t    if (group->stub_sec != NULL\n+\t\t&& group->stub_sec->size < group->stub_sec->rawsize)\n+\t      group->stub_sec->size = group->stub_sec->rawsize;\n+\n+\t  if (htab->brlt->size < htab->brlt->rawsize)\n+\t    htab->brlt->size = htab->brlt->rawsize;\n+\n+\t  if (htab->elf.srelrdyn != NULL\n+\t      && htab->elf.srelrdyn->size < htab->elf.srelrdyn->rawsize)\n+\t    htab->elf.srelrdyn->size = htab->elf.srelrdyn->rawsize;\n+\t}\n+\n       /* Ask the linker to do its stuff.  */\n       (*htab->params->layout_sections_again) ();\n     }"
    },
    {
      "sha": "3d738f5f93c8d7e62711231f26b75684e4756541",
      "filename": "ld/testsuite/ld-powerpc/powerpc.exp",
      "status": "modified",
      "additions": 1,
      "deletions": 0,
      "changes": 1,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/powerpc.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/powerpc.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/powerpc.exp?ref=9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
      "patch": "@@ -445,6 +445,7 @@ if [ supports_ppc64 ] then {\n     run_dump_test \"tlsie\"\n     run_dump_test \"non-contiguous-powerpc64\"\n     run_dump_test \"tprel\"\n+    run_dump_test \"pr28827-2\"\n }\n \n run_dump_test \"localgot\""
    },
    {
      "sha": "8da819d822aae8f7a0271fde5137b77f5dd8d267",
      "filename": "ld/testsuite/ld-powerpc/pr28827-2.d",
      "status": "added",
      "additions": 48,
      "deletions": 0,
      "changes": 48,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.d",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.d",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/pr28827-2.d?ref=9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
      "patch": "@@ -0,0 +1,48 @@\n+#as: -a64\n+#ld: -melf64ppc --plt-align=0 -T pr28827-2.lnk\n+#objdump: -dr\n+\n+.*:     file format .*\n+\n+Disassembly of section \\.text:\n+\n+.*:\n+.*:\t(49 ff ff f0|f0 ff ff 49) \tb       .* <far1>\n+\t\\.\\.\\.\n+\n+.* <.*\\.plt_branch\\..*>:\n+.*:\t(e9 82 80 28|28 80 82 e9) \tld      r12,-32728\\(r2\\)\n+.*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n+.*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n+\n+.* <_start>:\n+.*:\t(49 ff ff d8|d8 ff ff 49) \tb       .* <far1>\n+.*:\t(4b ff ff f0|f0 ff ff 4b) \tb       .*\n+\n+Disassembly of section \\.far1:\n+\n+.*:\n+.*:\t(4a 00 00 38|38 00 00 4a) \tb       .* <_start>\n+\n+.* <.*\\.long_branch\\..*>:\n+.*:\t(49 ff ff f4|f4 ff ff 49) \tb       .* <far2>\n+\t\\.\\.\\.\n+\n+.* <far1>:\n+.*:\t(41 82 ff f4|f4 ff 82 41) \tbeq     .*\n+.*:\t(4a 00 00 24|24 00 00 4a) \tb       .* <_start>\n+\n+Disassembly of section \\.far2:\n+\n+.*:\n+.*:\t(e9 82 80 20|20 80 82 e9) \tld      r12,-32736\\(r2\\)\n+.*:\t(7d 89 03 a6|a6 03 89 7d) \tmtctr   r12\n+.*:\t(4e 80 04 20|20 04 80 4e) \tbctr\n+\n+.*:\n+.*:\t(4a 00 00 24|24 00 00 4a) \tb       .* <far1>\n+\t\\.\\.\\.\n+\n+.* <far2>:\n+.*:\t(40 82 ff f4|f4 ff 82 40) \tbne     .*\n+.*:\t(4b ff ff e4|e4 ff ff 4b) \tb       .*"
    },
    {
      "sha": "61a8ca269f3b11944e552ab7e255037976a0ccfe",
      "filename": "ld/testsuite/ld-powerpc/pr28827-2.lnk",
      "status": "added",
      "additions": 9,
      "deletions": 0,
      "changes": 9,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.lnk",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.lnk",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/pr28827-2.lnk?ref=9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
      "patch": "@@ -0,0 +1,9 @@\n+SECTIONS\n+{\n+  . = SIZEOF_HEADERS;\n+  .text : { *(.text) }\n+  . = . + 0x2000000 + 32 - 4 * SIZEOF (.text);\n+  .far1 : { *(.far1) }\n+  . = . + 0x2000000 + 32 - 4 * SIZEOF (.far1);\n+  .far2 : { *(.far2) }\n+}"
    },
    {
      "sha": "a628d6d09f94be5322c77160a8c97d8ba11d5958",
      "filename": "ld/testsuite/ld-powerpc/pr28827-2.s",
      "status": "added",
      "additions": 15,
      "deletions": 0,
      "changes": 15,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.s",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/9ff8aa7d418bc508dbd429576b93e30ed9dc5891/ld/testsuite/ld-powerpc/pr28827-2.s",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/ld/testsuite/ld-powerpc/pr28827-2.s?ref=9ff8aa7d418bc508dbd429576b93e30ed9dc5891",
      "patch": "@@ -0,0 +1,15 @@\n+ .globl _start\n+ .text\n+_start:\n+ b far1\n+ b far2\n+\n+ .section .far1,\"ax\",@progbits\n+far1:\n+ beq far2\n+ b _start\n+\n+ .section .far2,\"ax\",@progbits\n+far2:\n+ bne far1\n+ b _start"
    }
  ]
}