{
  "sha": "7a28970742a8a1509917d409af14c84e1f666baa",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6N2EyODk3MDc0MmE4YTE1MDk5MTdkNDA5YWYxNGM4NGUxZjY2NmJhYQ==",
  "commit": {
    "author": {
      "name": "Rainer Orth",
      "email": "ro@CeBiTec.Uni-Bielefeld.DE",
      "date": "2019-09-12T08:40:59Z"
    },
    "committer": {
      "name": "Rainer Orth",
      "email": "ro@CeBiTec.Uni-Bielefeld.DE",
      "date": "2019-09-12T08:40:59Z"
    },
    "message": "Fix signals reported for faults on Solaris\n\nIt's been a long-standing nuisance that gdb reported unaligned accesses\non Solaris/SPARC as SIGSEGV, contrary to the shells and truss which\ncorrectly report SIGBUS instead.\n\nI could trace this down to the fault handling code in procfs.c\n(procfs_target::wait): when pr_why is set to PR_FAULTED, the current\ncode sets the signal based on the fault number.  For one, the code gets\nthis wrong for FLTACCESS (the unaligned access case) where it uses\nSIGSEGV.  What's worse, it's completely unnecessary to make up the\nsignal number inside gdb.  Instead, it should just take what procfs\nreports to avoid mismatches, which is what this patch does.  I've\ncompletely removed the explicit handling of the various fault codes: for\none, the list has already been incomplete, lacking FLTCPCOVF which\nexisted since at least Solaris 8.  Besides, there's no reason to error\nout on unknown fault codes: either the fault causes a signal which can\nthen be reported from procfs, or it doesn't (as for FLTPAGE) and no\nreporting is necessary.\n\nTested on sparcv9-sun-solaris2.11 and x86_64-pc-solaris2.11.  Also\nspot-checked manually for a couple of cases (unaligned access, division\nby 0, NULL pointer dereference).\n\n\t* procfs.c (procfs_target::wait) <PR_FAULTED>: Get signal from\n\tprstatus.pr_lwp.pr_info instead of making it up.",
    "tree": {
      "sha": "bcec44a834d20269ff8239fad3175df7f2c00c54",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/bcec44a834d20269ff8239fad3175df7f2c00c54"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/7a28970742a8a1509917d409af14c84e1f666baa",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7a28970742a8a1509917d409af14c84e1f666baa",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/7a28970742a8a1509917d409af14c84e1f666baa",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/7a28970742a8a1509917d409af14c84e1f666baa/comments",
  "author": {
    "login": "rorth",
    "id": 3930951,
    "node_id": "MDQ6VXNlcjM5MzA5NTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3930951?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rorth",
    "html_url": "https://github.com/rorth",
    "followers_url": "https://api.github.com/users/rorth/followers",
    "following_url": "https://api.github.com/users/rorth/following{/other_user}",
    "gists_url": "https://api.github.com/users/rorth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rorth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rorth/subscriptions",
    "organizations_url": "https://api.github.com/users/rorth/orgs",
    "repos_url": "https://api.github.com/users/rorth/repos",
    "events_url": "https://api.github.com/users/rorth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rorth/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "rorth",
    "id": 3930951,
    "node_id": "MDQ6VXNlcjM5MzA5NTE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/3930951?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/rorth",
    "html_url": "https://github.com/rorth",
    "followers_url": "https://api.github.com/users/rorth/followers",
    "following_url": "https://api.github.com/users/rorth/following{/other_user}",
    "gists_url": "https://api.github.com/users/rorth/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/rorth/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/rorth/subscriptions",
    "organizations_url": "https://api.github.com/users/rorth/orgs",
    "repos_url": "https://api.github.com/users/rorth/repos",
    "events_url": "https://api.github.com/users/rorth/events{/privacy}",
    "received_events_url": "https://api.github.com/users/rorth/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "19d16d8789cd1846c33c49f2fdab219b2c1fb4e1",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/19d16d8789cd1846c33c49f2fdab219b2c1fb4e1",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/19d16d8789cd1846c33c49f2fdab219b2c1fb4e1"
    }
  ],
  "stats": {
    "total": 43,
    "additions": 10,
    "deletions": 33
  },
  "files": [
    {
      "sha": "6d5f19d04bbf9046c9df418c0824864da03f9d76",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a28970742a8a1509917d409af14c84e1f666baa/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a28970742a8a1509917d409af14c84e1f666baa/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=7a28970742a8a1509917d409af14c84e1f666baa",
      "patch": "@@ -1,3 +1,8 @@\n+2019-09-12  Rainer Orth  <ro@CeBiTec.Uni-Bielefeld.DE>\n+\n+\t* procfs.c (procfs_target::wait) <PR_FAULTED>: Get signal from\n+\tprstatus.pr_lwp.pr_info instead of making it up.\n+\n 2019-09-11  Christian Biesinger  <cbiesinger@google.com>\n \n \t* auto-load.c (auto_load_expand_dir_vars): Update."
    },
    {
      "sha": "848ac7d6e751281c7df12d8e73eca3c3567c16d8",
      "filename": "gdb/procfs.c",
      "status": "modified",
      "additions": 5,
      "deletions": 33,
      "changes": 38,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/7a28970742a8a1509917d409af14c84e1f666baa/gdb/procfs.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/7a28970742a8a1509917d409af14c84e1f666baa/gdb/procfs.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/procfs.c?ref=7a28970742a8a1509917d409af14c84e1f666baa",
      "patch": "@@ -2476,40 +2476,12 @@ procfs_target::wait (ptid_t ptid, struct target_waitstatus *status,\n \t\twstat = (what << 8) | 0177;\n \t\tbreak;\n \t      case PR_FAULTED:\n-\t\tswitch (what) {\n-\t\tcase FLTWATCH:\n-\t\t  wstat = (SIGTRAP << 8) | 0177;\n-\t\t  break;\n-\t\t  /* FIXME: use si_signo where possible.  */\n-\t\tcase FLTPRIV:\n-\t\tcase FLTILL:\n-\t\t  wstat = (SIGILL << 8) | 0177;\n-\t\t  break;\n-\t\tcase FLTBPT:\n-\t\tcase FLTTRACE:\n-\t\t  wstat = (SIGTRAP << 8) | 0177;\n-\t\t  break;\n-\t\tcase FLTSTACK:\n-\t\tcase FLTACCESS:\n-\t\tcase FLTBOUNDS:\n-\t\t  wstat = (SIGSEGV << 8) | 0177;\n-\t\t  break;\n-\t\tcase FLTIOVF:\n-\t\tcase FLTIZDIV:\n-\t\tcase FLTFPE:\n-\t\t  wstat = (SIGFPE << 8) | 0177;\n-\t\t  break;\n-\t\tcase FLTPAGE:\t/* Recoverable page fault */\n-\t\tdefault:\t/* FIXME: use si_signo if possible for\n-\t\t\t\t   fault.  */\n-\t\t  retval = ptid_t (-1);\n-\t\t  printf_filtered (\"procfs:%d -- \", __LINE__);\n-\t\t  printf_filtered (_(\"child stopped for unknown reason:\\n\"));\n-\t\t  proc_prettyprint_why (why, what, 1);\n-\t\t  error (_(\"... giving up...\"));\n-\t\t  break;\n+\t\t{\n+\t\t  int signo = pi->prstatus.pr_lwp.pr_info.si_signo;\n+\t\t  if (signo != 0)\n+\t\t    wstat = (signo << 8) | 0177;\n \t\t}\n-\t\tbreak;\t/* case PR_FAULTED: */\n+\t\tbreak;\n \t      default:\t/* switch (why) unmatched */\n \t\tprintf_filtered (\"procfs:%d -- \", __LINE__);\n \t\tprintf_filtered (_(\"child stopped for unknown reason:\\n\"));"
    }
  ]
}