{
  "sha": "680e1beed31da40080f61a35f6ccd626de818056",
  "node_id": "MDY6Q29tbWl0MTM4Njg2ODE6NjgwZTFiZWVkMzFkYTQwMDgwZjYxYTM1ZjZjY2Q2MjZkZTgxODA1Ng==",
  "commit": {
    "author": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-05-30T20:13:10Z"
    },
    "committer": {
      "name": "Tom Tromey",
      "email": "tromey@adacore.com",
      "date": "2019-06-19T12:06:02Z"
    },
    "message": "Fix crash when setting breakpoint condition\n\ngdb could crash when setting a breakpoint condition on a breakpoint\nwhen using the Ada language.  The problem occurred because the\nada_evaluate_subexp would try to evaluate the array to compute its\nattributes, but evaluating can't really be done at this time.\n\nThis patch fixes the problem by arranging not to try to evaluate in\nEVAL_AVOID_SIDE_EFFECTS mode when computing an attribute.\n\nTested on x86-64 Fedora 29.  Because this is Ada-specific, and because\nJoel approved it internally, I am checking it in.\n\ngdb/ChangeLog\n2019-06-19  Tom Tromey  <tromey@adacore.com>\n\n\t* ada-lang.c (ada_evaluate_subexp) <case OP_ATR_FIRST>: Handle\n\tEVAL_AVOID_SIDE_EFFECTS specially.\n\ngdb/testsuite/ChangeLog\n2019-06-19  Tom Tromey  <tromey@adacore.com>\n\n\t* gdb.ada/length_cond.exp: New file.\n\t* gdb.ada/length_cond/length_cond.adb: New file.\n\t* gdb.ada/length_cond/pck.adb: New file.\n\t* gdb.ada/length_cond/pck.ads: New file.",
    "tree": {
      "sha": "75454b722be92a1feb6afc3bda485b7e835d3bde",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/git/trees/75454b722be92a1feb6afc3bda485b7e835d3bde"
    },
    "url": "https://api.github.com/repos/bminor/binutils-gdb/git/commits/680e1beed31da40080f61a35f6ccd626de818056",
    "comment_count": 0,
    "verification": {
      "verified": false,
      "reason": "unsigned",
      "signature": null,
      "payload": null
    }
  },
  "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/680e1beed31da40080f61a35f6ccd626de818056",
  "html_url": "https://github.com/bminor/binutils-gdb/commit/680e1beed31da40080f61a35f6ccd626de818056",
  "comments_url": "https://api.github.com/repos/bminor/binutils-gdb/commits/680e1beed31da40080f61a35f6ccd626de818056/comments",
  "author": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "committer": {
    "login": "tromey",
    "id": 1557670,
    "node_id": "MDQ6VXNlcjE1NTc2NzA=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/tromey",
    "html_url": "https://github.com/tromey",
    "followers_url": "https://api.github.com/users/tromey/followers",
    "following_url": "https://api.github.com/users/tromey/following{/other_user}",
    "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/tromey/subscriptions",
    "organizations_url": "https://api.github.com/users/tromey/orgs",
    "repos_url": "https://api.github.com/users/tromey/repos",
    "events_url": "https://api.github.com/users/tromey/events{/privacy}",
    "received_events_url": "https://api.github.com/users/tromey/received_events",
    "type": "User",
    "site_admin": false
  },
  "parents": [
    {
      "sha": "dcf3792354ddcd6e10e59e32060e34b27246e7da",
      "url": "https://api.github.com/repos/bminor/binutils-gdb/commits/dcf3792354ddcd6e10e59e32060e34b27246e7da",
      "html_url": "https://github.com/bminor/binutils-gdb/commit/dcf3792354ddcd6e10e59e32060e34b27246e7da"
    }
  ],
  "stats": {
    "total": 166,
    "additions": 159,
    "deletions": 7
  },
  "files": [
    {
      "sha": "c40b7d4574efa8593e76eb3353e13366a012a1aa",
      "filename": "gdb/ChangeLog",
      "status": "modified",
      "additions": 5,
      "deletions": 0,
      "changes": 5,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ChangeLog?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -1,3 +1,8 @@\n+2019-06-19  Tom Tromey  <tromey@adacore.com>\n+\n+\t* ada-lang.c (ada_evaluate_subexp) <case OP_ATR_FIRST>: Handle\n+\tEVAL_AVOID_SIDE_EFFECTS specially.\n+\n 2019-06-19  Tom Tromey  <tromey@adacore.com>\n \n \t* source-cache.c (highlighter): New global."
    },
    {
      "sha": "1e996557b6eee3526eede56547c2ae1cc7368d80",
      "filename": "gdb/ada-lang.c",
      "status": "modified",
      "additions": 27,
      "deletions": 7,
      "changes": 34,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/ada-lang.c",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/ada-lang.c",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/ada-lang.c?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -11055,8 +11055,34 @@ ada_evaluate_subexp (struct type *expect_type, struct expression *exp,\n \n         if (noside == EVAL_SKIP)\n           goto nosideret;\n+\telse if (noside == EVAL_AVOID_SIDE_EFFECTS)\n+\t  {\n+\t    if (type_arg == NULL)\n+\t      type_arg = value_type (arg1);\n+\n+            if (ada_is_constrained_packed_array_type (type_arg))\n+\t      type_arg = decode_constrained_packed_array_type (type_arg);\n \n-        if (type_arg == NULL)\n+\t    if (!discrete_type_p (type_arg))\n+\t      {\n+\t\tswitch (op)\n+\t\t  {\n+\t\t  default:          /* Should never happen.  */\n+\t\t    error (_(\"unexpected attribute encountered\"));\n+\t\t  case OP_ATR_FIRST:\n+\t\t  case OP_ATR_LAST:\n+\t\t    type_arg = ada_index_type (type_arg, tem,\n+\t\t\t\t\t       ada_attribute_name (op));\n+\t\t    break;\n+\t\t  case OP_ATR_LENGTH:\n+\t\t    type_arg = builtin_type (exp->gdbarch)->builtin_int;\n+\t\t    break;\n+\t\t  }\n+\t      }\n+\n+\t    return value_zero (type_arg, not_lval);\n+\t  }\n+        else if (type_arg == NULL)\n           {\n             arg1 = ada_coerce_ref (arg1);\n \n@@ -11073,9 +11099,6 @@ ada_evaluate_subexp (struct type *expect_type, struct expression *exp,\n \t\t  type = builtin_type (exp->gdbarch)->builtin_int;\n \t      }\n \n-            if (noside == EVAL_AVOID_SIDE_EFFECTS)\n-              return allocate_value (type);\n-\n             switch (op)\n               {\n               default:          /* Should never happen.  */\n@@ -11133,9 +11156,6 @@ ada_evaluate_subexp (struct type *expect_type, struct expression *exp,\n \t\t  type = builtin_type (exp->gdbarch)->builtin_int;\n \t      }\n \n-            if (noside == EVAL_AVOID_SIDE_EFFECTS)\n-              return allocate_value (type);\n-\n             switch (op)\n               {\n               default:"
    },
    {
      "sha": "8454b00755c0b00fe181db087b774a44b4055c85",
      "filename": "gdb/testsuite/ChangeLog",
      "status": "modified",
      "additions": 7,
      "deletions": 0,
      "changes": 7,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/ChangeLog",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/ChangeLog",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/ChangeLog?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -1,3 +1,10 @@\n+2019-06-19  Tom Tromey  <tromey@adacore.com>\n+\n+\t* gdb.ada/length_cond.exp: New file.\n+\t* gdb.ada/length_cond/length_cond.adb: New file.\n+\t* gdb.ada/length_cond/pck.adb: New file.\n+\t* gdb.ada/length_cond/pck.ads: New file.\n+\n 2019-06-18  Tom de Vries  <tdevries@suse.de>\n \n \t* boards/fission.exp (debug_flags): Add \"-fuse-ld=gold\"."
    },
    {
      "sha": "53e9187dc4d972be9646d6c046bb56189562e712",
      "filename": "gdb/testsuite/gdb.ada/length_cond.exp",
      "status": "added",
      "additions": 44,
      "deletions": 0,
      "changes": 44,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond.exp",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond.exp",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/length_cond.exp?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -0,0 +1,44 @@\n+# Copyright 2019 Free Software Foundation, Inc.\n+#\n+# This program is free software; you can redistribute it and/or modify\n+# it under the terms of the GNU General Public License as published by\n+# the Free Software Foundation; either version 3 of the License, or\n+# (at your option) any later version.\n+#\n+# This program is distributed in the hope that it will be useful,\n+# but WITHOUT ANY WARRANTY; without even the implied warranty of\n+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+# GNU General Public License for more details.\n+#\n+# You should have received a copy of the GNU General Public License\n+# along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+load_lib \"ada.exp\"\n+\n+standard_ada_testfile length_cond\n+\n+if {[gdb_compile_ada \"${srcfile}\" \"${binfile}\" executable debug] != \"\" } {\n+  return -1\n+}\n+\n+clean_restart ${testfile}\n+\n+set bp_location [gdb_get_line_number \"BREAKPOINT\" ${testdir}/length_cond.adb]\n+gdb_breakpoint length_cond.adb:$bp_location message\n+\n+# Resolving the conditional expression would cause a crash, so it's\n+# enough to just set the conditions.\n+\n+foreach var {loc enum_val int_val} {\n+    foreach attr {first last} {\n+\tgdb_test_no_output \"cond 1 $var'$attr > 15\"\n+    }\n+}\n+\n+gdb_test_no_output \"cond 1 loc'length > 15\"\n+\n+foreach attr {first last length} {\n+    foreach val {1 2} {\n+\tgdb_test_no_output \"cond 1 my_array'${attr}($val) > 15\"\n+    }\n+}"
    },
    {
      "sha": "7b563c363edba6449114b47d65a3e4e907dda339",
      "filename": "gdb/testsuite/gdb.ada/length_cond/length_cond.adb",
      "status": "added",
      "additions": 37,
      "deletions": 0,
      "changes": 37,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/length_cond.adb",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/length_cond.adb",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/length_cond/length_cond.adb?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -0,0 +1,37 @@\n+--  Copyright 2019 Free Software Foundation, Inc.\n+--\n+--  This program is free software; you can redistribute it and/or modify\n+--  it under the terms of the GNU General Public License as published by\n+--  the Free Software Foundation; either version 3 of the License, or\n+--  (at your option) any later version.\n+--\n+--  This program is distributed in the hope that it will be useful,\n+--  but WITHOUT ANY WARRANTY; without even the implied warranty of\n+--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+--  GNU General Public License for more details.\n+--\n+--  You should have received a copy of the GNU General Public License\n+--  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+with Pck;\n+\n+procedure Length_Cond is\n+   type Enum is (One, Two, Three);\n+   Enum_Val : Enum := Three;\n+\n+   type My_Int is range -23 .. 23;\n+   Int_Val : My_Int := 0;\n+\n+   type My_Array is array (0..1, 0..1) of Boolean;\n+   Array_Val : My_Array := ((True, False), (False, True));\n+\n+   procedure p (s : String) is\n+      loc : String := s & \".\";\n+   begin\n+      Pck.Do_Nothing (loc);\t\t--  BREAKPOINT\n+   end p;\n+begin\n+   for I in 1 .. 25 loop\n+      p ((1 .. I => 'X'));\n+   end loop;\n+end Length_Cond;"
    },
    {
      "sha": "79bbe599b682932c96b5b7f01db7ba1caecbdc4a",
      "filename": "gdb/testsuite/gdb.ada/length_cond/pck.adb",
      "status": "added",
      "additions": 21,
      "deletions": 0,
      "changes": 21,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/pck.adb",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/pck.adb",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/length_cond/pck.adb?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -0,0 +1,21 @@\n+--  Copyright 2019 Free Software Foundation, Inc.\n+--\n+--  This program is free software; you can redistribute it and/or modify\n+--  it under the terms of the GNU General Public License as published by\n+--  the Free Software Foundation; either version 3 of the License, or\n+--  (at your option) any later version.\n+--\n+--  This program is distributed in the hope that it will be useful,\n+--  but WITHOUT ANY WARRANTY; without even the implied warranty of\n+--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+--  GNU General Public License for more details.\n+--\n+--  You should have received a copy of the GNU General Public License\n+--  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+package body Pck is\n+   procedure Do_Nothing (A : String) is\n+   begin\n+      null;\n+   end Do_Nothing;\n+end Pck;"
    },
    {
      "sha": "433b389dfcbbaaaf5fca10eb1cbc8d25083bb218",
      "filename": "gdb/testsuite/gdb.ada/length_cond/pck.ads",
      "status": "added",
      "additions": 18,
      "deletions": 0,
      "changes": 18,
      "blob_url": "https://github.com/bminor/binutils-gdb/blob/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/pck.ads",
      "raw_url": "https://github.com/bminor/binutils-gdb/raw/680e1beed31da40080f61a35f6ccd626de818056/gdb/testsuite/gdb.ada/length_cond/pck.ads",
      "contents_url": "https://api.github.com/repos/bminor/binutils-gdb/contents/gdb/testsuite/gdb.ada/length_cond/pck.ads?ref=680e1beed31da40080f61a35f6ccd626de818056",
      "patch": "@@ -0,0 +1,18 @@\n+--  Copyright 2019 Free Software Foundation, Inc.\n+--\n+--  This program is free software; you can redistribute it and/or modify\n+--  it under the terms of the GNU General Public License as published by\n+--  the Free Software Foundation; either version 3 of the License, or\n+--  (at your option) any later version.\n+--\n+--  This program is distributed in the hope that it will be useful,\n+--  but WITHOUT ANY WARRANTY; without even the implied warranty of\n+--  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+--  GNU General Public License for more details.\n+--\n+--  You should have received a copy of the GNU General Public License\n+--  along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+\n+package Pck is\n+   procedure Do_Nothing (A : String);\n+end Pck;"
    }
  ]
}